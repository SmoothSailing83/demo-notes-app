"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocketApi = exports.WebSocketApiAuthorizationType = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const iam = __importStar(require("@aws-cdk/aws-iam"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2"));
const apigIntegrations = __importStar(require("@aws-cdk/aws-apigatewayv2-integrations"));
const Stack_1 = require("./Stack");
const Function_1 = require("./Function");
const apigV2Domain = __importStar(require("./util/apiGatewayV2Domain"));
const apigV2AccessLog = __importStar(require("./util/apiGatewayV2AccessLog"));
var WebSocketApiAuthorizationType;
(function (WebSocketApiAuthorizationType) {
    WebSocketApiAuthorizationType["NONE"] = "NONE";
    WebSocketApiAuthorizationType["IAM"] = "AWS_IAM";
    WebSocketApiAuthorizationType["CUSTOM"] = "CUSTOM";
})(WebSocketApiAuthorizationType = exports.WebSocketApiAuthorizationType || (exports.WebSocketApiAuthorizationType = {}));
/////////////////////
// Construct
/////////////////////
class WebSocketApi extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        props = props || {};
        const { webSocketApi, webSocketStage, routes, accessLog, customDomain, authorizationType, authorizer, defaultFunctionProps, } = props;
        this.functions = {};
        this.routesInfo = {};
        this.permissionsAttachedForAllRoutes = [];
        this.authorizationType = authorizationType;
        this.authorizer = authorizer;
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create Api
        ////////////////////
        if (cdk.Construct.isConstruct(webSocketApi)) {
            this.webSocketApi = webSocketApi;
        }
        else {
            // Validate input
            if (cdk.Construct.isConstruct(webSocketStage)) {
                throw new Error(`Cannot import the "webSocketStage" when the "webSocketApi" is not imported.`);
            }
            const webSocketApiProps = (webSocketApi || {});
            // Create WebSocket API
            this.webSocketApi = new apig.WebSocketApi(this, "Api", Object.assign({ apiName: root.logicalPrefixedName(id) }, webSocketApiProps));
        }
        ////////////////////
        // Create Stage
        ////////////////////
        if (cdk.Construct.isConstruct(webSocketStage)) {
            if (accessLog !== undefined) {
                throw new Error(`Cannot configure the "accessLog" when "webSocketStage" is a construct`);
            }
            if (customDomain !== undefined) {
                throw new Error(`Cannot configure the "customDomain" when "webSocketStage" is a construct`);
            }
            this.webSocketStage = webSocketStage;
        }
        else {
            const webSocketStageProps = (webSocketStage ||
                {});
            // Validate input
            if (webSocketStageProps.domainMapping !== undefined) {
                throw new Error(`Do not configure the "webSocketStage.domainMapping". Use the "customDomain" to configure the Api domain.`);
            }
            // Configure Custom Domain
            const customDomainData = apigV2Domain.buildCustomDomainData(this, customDomain);
            let domainMapping;
            if (customDomainData) {
                if (customDomainData.isApigDomainCreated) {
                    this.apiGatewayDomain =
                        customDomainData.apigDomain;
                }
                if (customDomainData.isCertificatedCreated) {
                    this.acmCertificate = customDomainData.certificate;
                }
                domainMapping = {
                    domainName: customDomainData.apigDomain,
                    mappingKey: customDomainData.mappingKey,
                };
                this._customDomainUrl = `wss://${customDomainData.url}`;
            }
            // Create stage
            this.webSocketStage = new apig.WebSocketStage(this, "Stage", Object.assign({ webSocketApi: this.webSocketApi, stageName: this.node.root.stage, autoDeploy: true, domainMapping }, webSocketStageProps));
            // Configure Access Log
            this.accessLogGroup = apigV2AccessLog.buildAccessLogData(this, accessLog, this.webSocketStage, true);
        }
        ///////////////////////////
        // Configure default permissions
        ///////////////////////////
        // note: this allows functions to make ApiGatewayManagementApi.postToConnection
        //       calls.
        this.attachPermissions([
            new iam.PolicyStatement({
                effect: iam.Effect.ALLOW,
                actions: ["execute-api:ManageConnections"],
                resources: [this._connectionsArn],
            }),
        ]);
        ///////////////////////////
        // Configure routes
        ///////////////////////////
        if (routes) {
            this.addRoutes(this, routes);
        }
        ///////////////////
        // Register Construct
        ///////////////////
        root.registerConstruct(this);
    }
    get url() {
        return this.webSocketStage.url;
    }
    get customDomainUrl() {
        return this._customDomainUrl;
    }
    get routes() {
        return Object.keys(this.functions);
    }
    get _connectionsArn() {
        return Stack_1.Stack.of(this).formatArn({
            service: "execute-api",
            resourceName: `${this.webSocketStage.stageName}/POST/*`,
            resource: this.webSocketApi.apiId,
        });
    }
    addRoutes(scope, routes) {
        Object.keys(routes).forEach((routeKey) => {
            // add route
            const fn = this.addRoute(scope, routeKey, routes[routeKey]);
            // attached existing permissions
            this.permissionsAttachedForAllRoutes.forEach((permissions) => fn.attachPermissions(permissions));
        });
    }
    getFunction(routeKey) {
        return this.functions[this.normalizeRouteKey(routeKey)];
    }
    attachPermissions(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllRoutes.push(permissions);
    }
    attachPermissionsToRoute(routeKey, permissions) {
        const fn = this.getFunction(routeKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Route "${routeKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
    getConstructInfo() {
        // imported
        if (!cdk.Token.isUnresolved(this.webSocketApi.apiId)) {
            return {
                httpApiId: this.webSocketApi.apiId,
                routes: Object.keys(this.routesInfo),
            };
        }
        // created
        const cfn = this.webSocketApi.node.defaultChild;
        return {
            httpApiLogicalId: Stack_1.Stack.of(this).getLogicalId(cfn),
            customDomainUrl: this._customDomainUrl,
            routes: Object.keys(this.routesInfo),
        };
    }
    addRoute(scope, routeKey, routeValue) {
        // Normalize routeKey
        routeKey = this.normalizeRouteKey(routeKey);
        if (this.functions[routeKey]) {
            throw new Error(`A route already exists for "${routeKey}"`);
        }
        ///////////////////
        // Create Function
        ///////////////////
        const lambda = Function_1.Function.fromDefinition(scope, routeKey, routeValue, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the routes using FunctionProps, so the Api construct can apply the "defaultFunctionProps" to them.`);
        ///////////////////
        // Create route
        ///////////////////
        const route = new apig.WebSocketRoute(scope, `Route_${routeKey}`, {
            webSocketApi: this.webSocketApi,
            routeKey,
            integration: new apigIntegrations.LambdaWebSocketIntegration({
                handler: lambda,
            }),
        });
        ///////////////////
        // Configure authorization
        ///////////////////
        const authorizationType = this.authorizationType || WebSocketApiAuthorizationType.NONE;
        if (!Object.values(WebSocketApiAuthorizationType).includes(authorizationType)) {
            throw new Error(`sst.WebSocketApi does not currently support ${authorizationType}. Only "IAM" is currently supported.`);
        }
        if (routeKey === "$connect") {
            if (authorizationType === WebSocketApiAuthorizationType.CUSTOM) {
                if (!this.authorizer) {
                    throw new Error(`Missing custom Lambda authorizer for "${routeKey}"`);
                }
                // Note: as of CDK v1.125.0, aws-apigatewayv2.WebSocketRoute does not
                //       support authorizer. For now, we are going to pretend
                //       WebSocketRoute to be HttpRoute, and call the "bind" method
                //       to let CDK configure the authorizer for us.
                const _route = route;
                _route.httpApi = _route.webSocketApi;
                const authBindResult = this.authorizer.bind({
                    route: _route,
                    scope: _route.httpApi,
                });
                // unset un-supported properties for WebSocketRoute
                // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                // @ts-ignore: access private property "authorizer"
                const cfnAuth = this.authorizer.authorizer.node
                    .defaultChild;
                cfnAuth.authorizerResultTtlInSeconds = undefined;
                cfnAuth.authorizerPayloadFormatVersion = undefined;
                // update default "identitySource" b/c HttpRoute's default is
                // "$request.querystring.Authorizer" which is invalid for WebSocketRoute.
                // Set default to "route.request.querystring.Authorizer"
                // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                // @ts-ignore: access private property "props"
                if (!this.authorizer.props.identitySource) {
                    cfnAuth.identitySource = ["route.request.header.Authorization"];
                }
                // set the authorizer information on WebSocketRoute
                const cfnRoute = route.node.defaultChild;
                cfnRoute.authorizerId = authBindResult.authorizerId;
                cfnRoute.authorizationType = authBindResult.authorizationType;
            }
            // Configure route authorization type
            // Note: we need to explicitly set `cfnRoute.authorizationType` to `NONE`
            //       because if it were set to `AWS_IAM`, and then it is removed from
            //       the CloudFormation template (ie. set to undefined), CloudFormation
            //       doesn't updates the route. The route's authorizationType would
            //       still be `AWS_IAM`.
            if (authorizationType === WebSocketApiAuthorizationType.CUSTOM ||
                authorizationType === WebSocketApiAuthorizationType.IAM ||
                authorizationType === WebSocketApiAuthorizationType.NONE) {
                if (!route.node.defaultChild) {
                    throw new Error(`Failed to define the default route for "${routeKey}"`);
                }
                const cfnRoute = route.node.defaultChild;
                cfnRoute.authorizationType = authorizationType;
            }
        }
        ///////////////////
        // Store function
        ///////////////////
        this.functions[routeKey] = lambda;
        this.routesInfo[routeKey] = true;
        return lambda;
    }
    normalizeRouteKey(routeKey) {
        return routeKey.trim();
    }
}
exports.WebSocketApi = WebSocketApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2ViU29ja2V0QXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1dlYlNvY2tldEFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbURBQXFDO0FBQ3JDLHNEQUF3QztBQUd4QyxnRUFBa0Q7QUFFbEQseUZBQTJFO0FBRzNFLG1DQUFnQztBQUVoQyx5Q0FBK0U7QUFFL0Usd0VBQTBEO0FBQzFELDhFQUFnRTtBQUdoRSxJQUFZLDZCQUlYO0FBSkQsV0FBWSw2QkFBNkI7SUFDdkMsOENBQWEsQ0FBQTtJQUNiLGdEQUFlLENBQUE7SUFDZixrREFBaUIsQ0FBQTtBQUNuQixDQUFDLEVBSlcsNkJBQTZCLEdBQTdCLHFDQUE2QixLQUE3QixxQ0FBNkIsUUFJeEM7QUF5QkQscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckIsTUFBYSxZQUFhLFNBQVEsR0FBRyxDQUFDLFNBQVM7SUFjN0MsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUF5QjtRQUNyRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLEtBQUssR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ3BCLE1BQU0sRUFDSixZQUFZLEVBQ1osY0FBYyxFQUNkLE1BQU0sRUFDTixTQUFTLEVBQ1QsWUFBWSxFQUNaLGlCQUFpQixFQUNqQixVQUFVLEVBQ1Ysb0JBQW9CLEdBQ3JCLEdBQUcsS0FBSyxDQUFDO1FBQ1YsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLCtCQUErQixHQUFHLEVBQUUsQ0FBQztRQUMxQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUM7UUFDM0MsSUFBSSxDQUFDLFVB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QixHQUFHLGlCQUFpQixDQUFDO2FBQ2hEO1NBQ0Y7UUFFRCxtQkFBbUI7UUFDbkIsaUJBQWlCO1FBQ2pCLG1CQUFtQjtRQUNuQixJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUNsQyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUVqQyxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRU8saUJBQWlCLENBQUMsUUFBZ0I7UUFDeEMsT0FBTyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDekIsQ0FBQztDQUNGO0FBL1ZELG9DQStWQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJAYXdzLWNkay9hd3MtaWFtXCI7XG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gXCJAYXdzLWNkay9hd3MtbG9nc1wiO1xuaW1wb3J0ICogYXMgYWNtIGZyb20gXCJAYXdzLWNkay9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyXCI7XG5pbXBvcnQgKiBhcyBhcGlnIGZyb20gXCJAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheXYyXCI7XG5pbXBvcnQgKiBhcyBhcGlnQXV0aG9yaXplcnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItYXV0aG9yaXplcnNcIjtcbmltcG9ydCAqIGFzIGFwaWdJbnRlZ3JhdGlvbnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItaW50ZWdyYXRpb25zXCI7XG5cbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgU3RhY2sgfSBmcm9tIFwiLi9TdGFja1wiO1xuaW1wb3J0IHsgSVNzdENvbnN0cnVjdCwgSVNzdENvbnN0cnVjdEluZm8gfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcbmltcG9ydCAqIGFzIGFwaWdWMkRvbWFpbiBmcm9tIFwiLi91dGlsL2FwaUdhdGV3YXlWMkRvbWFpblwiO1xuaW1wb3J0ICogYXMgYXBpZ1YyQWNjZXNzTG9nIGZyb20gXCIuL3V0aWwvYXBpR2F0ZXdheVYyQWNjZXNzTG9nXCI7XG5pbXBvcnQgeyBJSHR0cEFwaSwgSUh0dHBSb3V0ZSB9IGZyb20gXCJAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheXYyXCI7XG5cbmV4cG9ydCBlbnVtIFdlYlNvY2tldEFwaUF1dGhvcml6YXRpb25UeXBlIHtcbiAgTk9ORSA9IFwiTk9ORVwiLFxuICBJQU0gPSBcIkFXU19JQU1cIixcbiAgQ1VTVE9NID0gXCJDVVNUT01cIixcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBXZWJTb2NrZXRBcGlQcm9wcyB7XG4gIHJlYWRvbmx5IHdlYlNvY2tldEFwaT86IGFwaWcuSVdlYlNvY2tldEFwaSB8IGFwaWcuV2ViU29ja2V0QXBpUHJvcHM7XG4gIHJlYWRvbmx5IHdlYlNvY2tldFN0YWdlPzogYXBpZy5JV2ViU29ja2V0U3RhZ2UgfCBXZWJTb2NrZXRBcGlDZGtTdGFnZVByb3BzO1xuICByZWFkb25seSByb3V0ZXM/OiB7IFtrZXk6IHN0cmluZ106IEZ1bmN0aW9uRGVmaW5pdGlvbiB9O1xuICByZWFkb25seSBhY2Nlc3NMb2c/OiBib29sZWFuIHwgc3RyaW5nIHwgV2ViU29ja2V0QXBpQWNjY2Vzc0xvZ1Byb3BzO1xuICByZWFkb25seSBjdXN0b21Eb21haW4/OiBzdHJpbmcgfCBXZWJTb2NrZXRBcGlDdXN0b21Eb21haW5Qcm9wcztcbiAgcmVhZG9ubHkgYXV0aG9yaXphdGlvblR5cGU/OiBXZWJTb2NrZXRBcGlBdXRob3JpemF0aW9uVHlwZTtcbiAgcmVhZG9ubHkgYXV0aG9yaXplcj86IGFwaWdBdXRob3JpemVycy5IdHRwTGFtYmRhQXV0aG9yaXplcjtcbiAgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xufVxuXG5leHBvcnQgdHlwZSBXZWJTb2NrZXRBcGlDdXN0b21Eb21haW5Qcm9wcyA9IGFwaWdWMkRvbWFpbi5DdXN0b21Eb21haW5Qcm9wcztcbmV4cG9ydCB0eXBlIFdlYlNvY2tldEFwaUFjY2Nlc3NMb2dQcm9wcyA9IGFwaWdWMkFjY2Vzc0xvZy5BY2Nlc3NMb2dQcm9wcztcblxuZXhwb3J0IGludGVyZmFjZSBXZWJTb2NrZXRBcGlDZGtTdGFnZVByb3BzXG4gIGV4dGVuZHMgT21pdDxhcGlnLldlYlNvY2tldFN0YWdlUHJvcHMsIFwid2ViU29ja2V0QXBpXCIgfCBcInN0YWdlTmFtZVwiPiB7XG4gIHJlYWRvbmx5IHN0YWdlTmFtZT86IHN0cmluZztcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb25zdHJ1Y3Rcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgY2xhc3MgV2ViU29ja2V0QXBpIGV4dGVuZHMgY2RrLkNvbnN0cnVjdCBpbXBsZW1lbnRzIElTc3RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgd2ViU29ja2V0QXBpOiBhcGlnLldlYlNvY2tldEFwaTtcbiAgcHVibGljIHJlYWRvbmx5IHdlYlNvY2tldFN0YWdlOiBhcGlnLldlYlNvY2tldFN0YWdlO1xuICBwdWJsaWMgcmVhZG9ubHkgX2N1c3RvbURvbWFpblVybD86IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IGFjY2Vzc0xvZ0dyb3VwPzogbG9ncy5Mb2dHcm91cDtcbiAgcHVibGljIHJlYWRvbmx5IGFwaUdhdGV3YXlEb21haW4/OiBhcGlnLkRvbWFpbk5hbWU7XG4gIHB1YmxpYyByZWFkb25seSBhY21DZXJ0aWZpY2F0ZT86IGFjbS5DZXJ0aWZpY2F0ZTtcbiAgcHJpdmF0ZSByZWFkb25seSBmdW5jdGlvbnM6IHsgW2tleTogc3RyaW5nXTogRm4gfTtcbiAgcHJpdmF0ZSByZWFkb25seSByb3V0ZXNJbmZvOiB7IFtrZXk6IHN0cmluZ106IGJvb2xlYW4gfTtcbiAgcHJpdmF0ZSByZWFkb25seSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzOiBQZXJtaXNzaW9uc1tdO1xuICBwcml2YXRlIHJlYWRvbmx5IGF1dGhvcml6YXRpb25UeXBlPzogV2ViU29ja2V0QXBpQXV0aG9yaXphdGlvblR5cGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgYXV0aG9yaXplcj86IGFwaWdBdXRob3JpemVycy5IdHRwTGFtYmRhQXV0aG9yaXplcjtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogV2ViU29ja2V0QXBpUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgcHJvcHMgPSBwcm9wcyB8fCB7fTtcbiAgICBjb25zdCB7XG4gICAgICB3ZWJTb2NrZXRBcGksXG4gICAgICB3ZWJTb2NrZXRTdGFnZSxcbiAgICAgIHJvdXRlcyxcbiAgICAgIGFjY2Vzc0xvZyxcbiAgICAgIGN1c3RvbURvbWFpbixcbiAgICAgIGF1dGhvcml6YXRpb25UeXBlLFxuICAgICAgYXV0aG9yaXplcixcbiAgICAgIGRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgIH0gPSBwcm9wcztcbiAgICB0aGlzLmZ1bmN0aW9ucyA9IHt9O1xuICAgIHRoaXMucm91dGVzSW5mbyA9IHt9O1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFJvdXRlcyA9IFtdO1xuICAgIHRoaXMuYXV0aG9yaXphdGlvblR5cGUgPSBhdXRob3JpemF0aW9uVHlwZTtcbiAgICB0aGlzLmF1dGhvcml6ZXIgPSBhdXRob3JpemVyO1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMgPSBkZWZhdWx0RnVuY3Rpb25Qcm9wcztcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIEFwaVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoY2RrLkNvbnN0cnVjdC5pc0NvbnN0cnVjdCh3ZWJTb2NrZXRBcGkpKSB7XG4gICAgICB0aGlzLndlYlNvY2tldEFwaSA9IHdlYlNvY2tldEFwaSBhcyBhcGlnLldlYlNvY2tldEFwaTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVmFsaWRhdGUgaW5wdXRcbiAgICAgIGlmIChjZGsuQ29uc3RydWN0LmlzQ29uc3RydWN0KHdlYlNvY2tldFN0YWdlKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBpbXBvcnQgdGhlIFwid2ViU29ja2V0U3RhZ2VcIiB3aGVuIHRoZSBcIndlYlNvY2tldEFwaVwiIGlzIG5vdCBpbXBvcnRlZC5gXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHdlYlNvY2tldEFwaVByb3BzID0gKHdlYlNvY2tldEFwaSB8fCB7fSkgYXMgYXBpZy5XZWJTb2NrZXRBcGlQcm9wcztcblxuICAgICAgLy8gQ3JlYXRlIFdlYlNvY2tldCBBUElcbiAgICAgIHRoaXMud2ViU29ja2V0QXBpID0gbmV3IGFwaWcuV2ViU29ja2V0QXBpKHRoaXMsIFwiQXBpXCIsIHtcbiAgICAgICAgYXBpTmFtZTogcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgLi4ud2ViU29ja2V0QXBpUHJvcHMsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBTdGFnZVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoY2RrLkNvbnN0cnVjdC5pc0NvbnN0cnVjdCh3ZWJTb2NrZXRTdGFnZSkpIHtcbiAgICAgIGlmIChhY2Nlc3NMb2cgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiYWNjZXNzTG9nXCIgd2hlbiBcIndlYlNvY2tldFN0YWdlXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoY3VzdG9tRG9tYWluICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImN1c3RvbURvbWFpblwiIHdoZW4gXCJ3ZWJTb2NrZXRTdGFnZVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhpcy53ZWJTb2NrZXRTdGFnZSA9IHdlYlNvY2tldFN0YWdlIGFzIGFwaWcuV2ViU29ja2V0U3RhZ2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHdlYlNvY2tldFN0YWdlUHJvcHMgPSAod2ViU29ja2V0U3RhZ2UgfHxcbiAgICAgICAge30pIGFzIFdlYlNvY2tldEFwaUNka1N0YWdlUHJvcHM7XG5cbiAgICAgIC8vIFZhbGlkYXRlIGlucHV0XG4gICAgICBpZiAod2ViU29ja2V0U3RhZ2VQcm9wcy5kb21haW5NYXBwaW5nICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBEbyBub3QgY29uZmlndXJlIHRoZSBcIndlYlNvY2tldFN0YWdlLmRvbWFpbk1hcHBpbmdcIi4gVXNlIHRoZSBcImN1c3RvbURvbWFpblwiIHRvIGNvbmZpZ3VyZSB0aGUgQXBpIGRvbWFpbi5gXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIENvbmZpZ3VyZSBDdXN0b20gRG9tYWluXG4gICAgICBjb25zdCBjdXN0b21Eb21haW5EYXRhID0gYXBpZ1YyRG9tYWluLmJ1aWxkQ3VzdG9tRG9tYWluRGF0YShcbiAgICAgICAgdGhpcyxcbiAgICAgICAgY3VzdG9tRG9tYWluXG4gICAgICApO1xuICAgICAgbGV0IGRvbWFpbk1hcHBpbmc7XG4gICAgICBpZiAoY3VzdG9tRG9tYWluRGF0YSkge1xuICAgICAgICBpZiAoY3VzdG9tRG9tYWluRGF0YS5pc0FwaWdEb21haW5DcmVhdGVkKSB7XG4gICAgICAgICAgdGhpcy5hcGlHYXRld2F5RG9tYWluID1cbiAgICAgICAgICAgIGN1c3RvbURvbWFpbkRhdGEuYXBpZ0RvbWFpbiBhcyBhcGlnLkRvbWFpbk5hbWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGN1c3RvbURvbWFpbkRhdGEuaXNDZXJ0aWZpY2F0ZWRDcmVhdGVkKSB7XG4gICAgICAgICAgdGhpcy5hY21DZXJ0aWZpY2F0ZSA9IGN1c3RvbURvbWFpbkRhdGEuY2VydGlmaWNhdGUgYXMgYWNtLkNlcnRpZmljYXRlO1xuICAgICAgICB9XG4gICAgICAgIGRvbWFpbk1hcHBpbmcgPSB7XG4gICAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluRGF0YS5hcGlnRG9tYWluLFxuICAgICAgICAgIG1hcHBpbmdLZXk6IGN1c3RvbURvbWFpbkRhdGEubWFwcGluZ0tleSxcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5fY3VzdG9tRG9tYWluVXJsID0gYHdzczovLyR7Y3VzdG9tRG9tYWluRGF0YS51cmx9YDtcbiAgICAgIH1cblxuICAgICAgLy8gQ3JlYXRlIHN0YWdlXG4gICAgICB0aGlzLndlYlNvY2tldFN0YWdlID0gbmV3IGFwaWcuV2ViU29ja2V0U3RhZ2UodGhpcywgXCJTdGFnZVwiLCB7XG4gICAgICAgIHdlYlNvY2tldEFwaTogdGhpcy53ZWJTb2NrZXRBcGksXG4gICAgICAgIHN0YWdlTmFtZTogKHRoaXMubm9kZS5yb290IGFzIEFwcCkuc3RhZ2UsXG4gICAgICAgIGF1dG9EZXBsb3k6IHRydWUsXG4gICAgICAgIGRvbWFpbk1hcHBpbmcsXG4gICAgICAgIC4uLndlYlNvY2tldFN0YWdlUHJvcHMsXG4gICAgICB9KTtcblxuICAgICAgLy8gQ29uZmlndXJlIEFjY2VzcyBMb2dcbiAgICAgIHRoaXMuYWNjZXNzTG9nR3JvdXAgPSBhcGlnVjJBY2Nlc3NMb2cuYnVpbGRBY2Nlc3NMb2dEYXRhKFxuICAgICAgICB0aGlzLFxuICAgICAgICBhY2Nlc3NMb2csXG4gICAgICAgIHRoaXMud2ViU29ja2V0U3RhZ2UsXG4gICAgICAgIHRydWVcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ29uZmlndXJlIGRlZmF1bHQgcGVybWlzc2lvbnNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBub3RlOiB0aGlzIGFsbG93cyBmdW5jdGlvbnMgdG8gbWFrZSBBcGlHYXRld2F5TWFuYWdlbWVudEFwaS5wb3N0VG9Db25uZWN0aW9uXG4gICAgLy8gICAgICAgY2FsbHMuXG4gICAgdGhpcy5hdHRhY2hQZXJtaXNzaW9ucyhbXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1wiZXhlY3V0ZS1hcGk6TWFuYWdlQ29ubmVjdGlvbnNcIl0sXG4gICAgICAgIHJlc291cmNlczogW3RoaXMuX2Nvbm5lY3Rpb25zQXJuXSxcbiAgICAgIH0pLFxuICAgIF0pO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ29uZmlndXJlIHJvdXRlc1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKHJvdXRlcykge1xuICAgICAgdGhpcy5hZGRSb3V0ZXModGhpcywgcm91dGVzKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gUmVnaXN0ZXIgQ29uc3RydWN0XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIHJvb3QucmVnaXN0ZXJDb25zdHJ1Y3QodGhpcyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHVybCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLndlYlNvY2tldFN0YWdlLnVybDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY3VzdG9tRG9tYWluVXJsKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuX2N1c3RvbURvbWFpblVybDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcm91dGVzKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5mdW5jdGlvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldCBfY29ubmVjdGlvbnNBcm4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gU3RhY2sub2YodGhpcykuZm9ybWF0QXJuKHtcbiAgICAgIHNlcnZpY2U6IFwiZXhlY3V0ZS1hcGlcIixcbiAgICAgIHJlc291cmNlTmFtZTogYCR7dGhpcy53ZWJTb2NrZXRTdGFnZS5zdGFnZU5hbWV9L1BPU1QvKmAsXG4gICAgICByZXNvdXJjZTogdGhpcy53ZWJTb2NrZXRBcGkuYXBpSWQsXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYWRkUm91dGVzKFxuICAgIHNjb3BlOiBjZGsuQ29uc3RydWN0LFxuICAgIHJvdXRlczoge1xuICAgICAgW2tleTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uO1xuICAgIH1cbiAgKTogdm9pZCB7XG4gICAgT2JqZWN0LmtleXMocm91dGVzKS5mb3JFYWNoKChyb3V0ZUtleTogc3RyaW5nKSA9PiB7XG4gICAgICAvLyBhZGQgcm91dGVcbiAgICAgIGNvbnN0IGZuID0gdGhpcy5hZGRSb3V0ZShzY29wZSwgcm91dGVLZXksIHJvdXRlc1tyb3V0ZUtleV0pO1xuXG4gICAgICAvLyBhdHRhY2hlZCBleGlzdGluZyBwZXJtaXNzaW9uc1xuICAgICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzLmZvckVhY2goKHBlcm1pc3Npb25zKSA9PlxuICAgICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0RnVuY3Rpb24ocm91dGVLZXk6IHN0cmluZyk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5mdW5jdGlvbnNbdGhpcy5ub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleSldO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIE9iamVjdC52YWx1ZXModGhpcy5mdW5jdGlvbnMpLmZvckVhY2goKGZuKSA9PlxuICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgKTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNUb1JvdXRlKFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25zXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGZuID0gdGhpcy5nZXRGdW5jdGlvbihyb3V0ZUtleSk7XG4gICAgaWYgKCFmbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGF0dGFjaCBwZXJtaXNzaW9ucy4gUm91dGUgXCIke3JvdXRlS2V5fVwiIGRvZXMgbm90IGV4aXN0LmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdEluZm8oKTogSVNzdENvbnN0cnVjdEluZm8ge1xuICAgIC8vIGltcG9ydGVkXG4gICAgaWYgKCFjZGsuVG9rZW4uaXNVbnJlc29sdmVkKHRoaXMud2ViU29ja2V0QXBpLmFwaUlkKSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaHR0cEFwaUlkOiB0aGlzLndlYlNvY2tldEFwaS5hcGlJZCxcbiAgICAgICAgcm91dGVzOiBPYmplY3Qua2V5cyh0aGlzLnJvdXRlc0luZm8pLFxuICAgICAgfTtcbiAgICB9XG4gICAgLy8gY3JlYXRlZFxuICAgIGNvbnN0IGNmbiA9IHRoaXMud2ViU29ja2V0QXBpLm5vZGUuZGVmYXVsdENoaWxkIGFzIGFwaWcuQ2ZuQXBpO1xuICAgIHJldHVybiB7XG4gICAgICBodHRwQXBpTG9naWNhbElkOiBTdGFjay5vZih0aGlzKS5nZXRMb2dpY2FsSWQoY2ZuKSxcbiAgICAgIGN1c3RvbURvbWFpblVybDogdGhpcy5fY3VzdG9tRG9tYWluVXJsLFxuICAgICAgcm91dGVzOiBPYmplY3Qua2V5cyh0aGlzLnJvdXRlc0luZm8pLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGFkZFJvdXRlKFxuICAgIHNjb3BlOiBjZGsuQ29uc3RydWN0LFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcm91dGVWYWx1ZTogRnVuY3Rpb25EZWZpbml0aW9uXG4gICk6IEZuIHtcbiAgICAvLyBOb3JtYWxpemUgcm91dGVLZXlcbiAgICByb3V0ZUtleSA9IHRoaXMubm9ybWFsaXplUm91dGVLZXkocm91dGVLZXkpO1xuICAgIGlmICh0aGlzLmZ1bmN0aW9uc1tyb3V0ZUtleV0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQSByb3V0ZSBhbHJlYWR5IGV4aXN0cyBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBGdW5jdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBsYW1iZGEgPSBGbi5mcm9tRGVmaW5pdGlvbihcbiAgICAgIHNjb3BlLFxuICAgICAgcm91dGVLZXksXG4gICAgICByb3V0ZVZhbHVlLFxuICAgICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgIGBUaGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIGNhbm5vdCBiZSBhcHBsaWVkIGlmIGFuIGluc3RhbmNlIG9mIGEgRnVuY3Rpb24gY29uc3RydWN0IGlzIHBhc3NlZCBpbi4gTWFrZSBzdXJlIHRvIGRlZmluZSBhbGwgdGhlIHJvdXRlcyB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgQXBpIGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiB0byB0aGVtLmBcbiAgICApO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSByb3V0ZVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCByb3V0ZSA9IG5ldyBhcGlnLldlYlNvY2tldFJvdXRlKHNjb3BlLCBgUm91dGVfJHtyb3V0ZUtleX1gLCB7XG4gICAgICB3ZWJTb2NrZXRBcGk6IHRoaXMud2ViU29ja2V0QXBpLFxuICAgICAgcm91dGVLZXksXG4gICAgICBpbnRlZ3JhdGlvbjogbmV3IGFwaWdJbnRlZ3JhdGlvbnMuTGFtYmRhV2ViU29ja2V0SW50ZWdyYXRpb24oe1xuICAgICAgICBoYW5kbGVyOiBsYW1iZGEsXG4gICAgICB9KSxcbiAgICB9KTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDb25maWd1cmUgYXV0aG9yaXphdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGNvbnN0IGF1dGhvcml6YXRpb25UeXBlID1cbiAgICAgIHRoaXMuYXV0aG9yaXphdGlvblR5cGUgfHwgV2ViU29ja2V0QXBpQXV0aG9yaXphdGlvblR5cGUuTk9ORTtcbiAgICBpZiAoXG4gICAgICAhT2JqZWN0LnZhbHVlcyhXZWJTb2NrZXRBcGlBdXRob3JpemF0aW9uVHlwZSkuaW5jbHVkZXMoYXV0aG9yaXphdGlvblR5cGUpXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBzc3QuV2ViU29ja2V0QXBpIGRvZXMgbm90IGN1cnJlbnRseSBzdXBwb3J0ICR7YXV0aG9yaXphdGlvblR5cGV9LiBPbmx5IFwiSUFNXCIgaXMgY3VycmVudGx5IHN1cHBvcnRlZC5gXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChyb3V0ZUtleSA9PT0gXCIkY29ubmVjdFwiKSB7XG4gICAgICBpZiAoYXV0aG9yaXphdGlvblR5cGUgPT09IFdlYlNvY2tldEFwaUF1dGhvcml6YXRpb25UeXBlLkNVU1RPTSkge1xuICAgICAgICBpZiAoIXRoaXMuYXV0aG9yaXplcikge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBjdXN0b20gTGFtYmRhIGF1dGhvcml6ZXIgZm9yIFwiJHtyb3V0ZUtleX1cImApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gTm90ZTogYXMgb2YgQ0RLIHYxLjEyNS4wLCBhd3MtYXBpZ2F0ZXdheXYyLldlYlNvY2tldFJvdXRlIGRvZXMgbm90XG4gICAgICAgIC8vICAgICAgIHN1cHBvcnQgYXV0aG9yaXplci4gRm9yIG5vdywgd2UgYXJlIGdvaW5nIHRvIHByZXRlbmRcbiAgICAgICAgLy8gICAgICAgV2ViU29ja2V0Um91dGUgdG8gYmUgSHR0cFJvdXRlLCBhbmQgY2FsbCB0aGUgXCJiaW5kXCIgbWV0aG9kXG4gICAgICAgIC8vICAgICAgIHRvIGxldCBDREsgY29uZmlndXJlIHRoZSBhdXRob3JpemVyIGZvciB1cy5cbiAgICAgICAgY29uc3QgX3JvdXRlID0gcm91dGUgYXMgdW5rbm93biBhcyBhbnk7XG4gICAgICAgIF9yb3V0ZS5odHRwQXBpID0gX3JvdXRlLndlYlNvY2tldEFwaSBhcyB1bmtub3duIGFzIElIdHRwQXBpO1xuICAgICAgICBjb25zdCBhdXRoQmluZFJlc3VsdCA9IHRoaXMuYXV0aG9yaXplci5iaW5kKHtcbiAgICAgICAgICByb3V0ZTogX3JvdXRlIGFzIElIdHRwUm91dGUsXG4gICAgICAgICAgc2NvcGU6IF9yb3V0ZS5odHRwQXBpLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyB1bnNldCB1bi1zdXBwb3J0ZWQgcHJvcGVydGllcyBmb3IgV2ViU29ja2V0Um91dGVcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHMtY29tbWVudFxuICAgICAgICAvLyBAdHMtaWdub3JlOiBhY2Nlc3MgcHJpdmF0ZSBwcm9wZXJ0eSBcImF1dGhvcml6ZXJcIlxuICAgICAgICBjb25zdCBjZm5BdXRoID0gdGhpcy5hdXRob3JpemVyLmF1dGhvcml6ZXIubm9kZVxuICAgICAgICAgIC5kZWZhdWx0Q2hpbGQgYXMgYXBpZy5DZm5BdXRob3JpemVyO1xuICAgICAgICBjZm5BdXRoLmF1dGhvcml6ZXJSZXN1bHRUdGxJblNlY29uZHMgPSB1bmRlZmluZWQ7XG4gICAgICAgIGNmbkF1dGguYXV0aG9yaXplclBheWxvYWRGb3JtYXRWZXJzaW9uID0gdW5kZWZpbmVkO1xuXG4gICAgICAgIC8vIHVwZGF0ZSBkZWZhdWx0IFwiaWRlbnRpdHlTb3VyY2VcIiBiL2MgSHR0cFJvdXRlJ3MgZGVmYXVsdCBpc1xuICAgICAgICAvLyBcIiRyZXF1ZXN0LnF1ZXJ5c3RyaW5nLkF1dGhvcml6ZXJcIiB3aGljaCBpcyBpbnZhbGlkIGZvciBXZWJTb2NrZXRSb3V0ZS5cbiAgICAgICAgLy8gU2V0IGRlZmF1bHQgdG8gXCJyb3V0ZS5yZXF1ZXN0LnF1ZXJ5c3RyaW5nLkF1dGhvcml6ZXJcIlxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50XG4gICAgICAgIC8vIEB0cy1pZ25vcmU6IGFjY2VzcyBwcml2YXRlIHByb3BlcnR5IFwicHJvcHNcIlxuICAgICAgICBpZiAoIXRoaXMuYXV0aG9yaXplci5wcm9wcy5pZGVudGl0eVNvdXJjZSkge1xuICAgICAgICAgIGNmbkF1dGguaWRlbnRpdHlTb3VyY2UgPSBbXCJyb3V0ZS5yZXF1ZXN0LmhlYWRlci5BdXRob3JpemF0aW9uXCJdO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gc2V0IHRoZSBhdXRob3JpemVyIGluZm9ybWF0aW9uIG9uIFdlYlNvY2tldFJvdXRlXG4gICAgICAgIGNvbnN0IGNmblJvdXRlID0gcm91dGUubm9kZS5kZWZhdWx0Q2hpbGQgYXMgYXBpZy5DZm5Sb3V0ZTtcbiAgICAgICAgY2ZuUm91dGUuYXV0aG9yaXplcklkID0gYXV0aEJpbmRSZXN1bHQuYXV0aG9yaXplcklkO1xuICAgICAgICBjZm5Sb3V0ZS5hdXRob3JpemF0aW9uVHlwZSA9IGF1dGhCaW5kUmVzdWx0LmF1dGhvcml6YXRpb25UeXBlO1xuICAgICAgfVxuXG4gICAgICAvLyBDb25maWd1cmUgcm91dGUgYXV0aG9yaXphdGlvbiB0eXBlXG4gICAgICAvLyBOb3RlOiB3ZSBuZWVkIHRvIGV4cGxpY2l0bHkgc2V0IGBjZm5Sb3V0ZS5hdXRob3JpemF0aW9uVHlwZWAgdG8gYE5PTkVgXG4gICAgICAvLyAgICAgICBiZWNhdXNlIGlmIGl0IHdlcmUgc2V0IHRvIGBBV1NfSUFNYCwgYW5kIHRoZW4gaXQgaXMgcmVtb3ZlZCBmcm9tXG4gICAgICAvLyAgICAgICB0aGUgQ2xvdWRGb3JtYXRpb24gdGVtcGxhdGUgKGllLiBzZXQgdG8gdW5kZWZpbmVkKSwgQ2xvdWRGb3JtYXRpb25cbiAgICAgIC8vICAgICAgIGRvZXNuJ3QgdXBkYXRlcyB0aGUgcm91dGUuIFRoZSByb3V0ZSdzIGF1dGhvcml6YXRpb25UeXBlIHdvdWxkXG4gICAgICAvLyAgICAgICBzdGlsbCBiZSBgQVdTX0lBTWAuXG4gICAgICBpZiAoXG4gICAgICAgIGF1dGhvcml6YXRpb25UeXBlID09PSBXZWJTb2NrZXRBcGlBdXRob3JpemF0aW9uVHlwZS5DVVNUT00gfHxcbiAgICAgICAgYXV0aG9yaXphdGlvblR5cGUgPT09IFdlYlNvY2tldEFwaUF1dGhvcml6YXRpb25UeXBlLklBTSB8fFxuICAgICAgICBhdXRob3JpemF0aW9uVHlwZSA9PT0gV2ViU29ja2V0QXBpQXV0aG9yaXphdGlvblR5cGUuTk9ORVxuICAgICAgKSB7XG4gICAgICAgIGlmICghcm91dGUubm9kZS5kZWZhdWx0Q2hpbGQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgRmFpbGVkIHRvIGRlZmluZSB0aGUgZGVmYXVsdCByb3V0ZSBmb3IgXCIke3JvdXRlS2V5fVwiYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2ZuUm91dGUgPSByb3V0ZS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBhcGlnLkNmblJvdXRlO1xuICAgICAgICBjZm5Sb3V0ZS5hdXRob3JpemF0aW9uVHlwZSA9IGF1dGhvcml6YXRpb25UeXBlO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBTdG9yZSBmdW5jdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICB0aGlzLmZ1bmN0aW9uc1tyb3V0ZUtleV0gPSBsYW1iZGE7XG4gICAgdGhpcy5yb3V0ZXNJbmZvW3JvdXRlS2V5XSA9IHRydWU7XG5cbiAgICByZXR1cm4gbGFtYmRhO1xuICB9XG5cbiAgcHJpdmF0ZSBub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gcm91dGVLZXkudHJpbSgpO1xuICB9XG59XG4iXX0=