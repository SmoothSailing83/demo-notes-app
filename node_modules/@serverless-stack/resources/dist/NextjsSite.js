"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NextjsSite = void 0;
const chalk_1 = __importDefault(require("chalk"));
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const child_process_1 = require("child_process");
const cdk = __importStar(require("@aws-cdk/core"));
const s3 = __importStar(require("@aws-cdk/aws-s3"));
const iam = __importStar(require("@aws-cdk/aws-iam"));
const sqs = __importStar(require("@aws-cdk/aws-sqs"));
const logs = __importStar(require("@aws-cdk/aws-logs"));
const lambda = __importStar(require("@aws-cdk/aws-lambda"));
const route53 = __importStar(require("@aws-cdk/aws-route53"));
const s3Assets = __importStar(require("@aws-cdk/aws-s3-assets"));
const cloudfront = __importStar(require("@aws-cdk/aws-cloudfront"));
const acm = __importStar(require("@aws-cdk/aws-certificatemanager"));
const lambda_layer_awscli_1 = require("@aws-cdk/lambda-layer-awscli");
const origins = __importStar(require("@aws-cdk/aws-cloudfront-origins"));
const route53Targets = __importStar(require("@aws-cdk/aws-route53-targets"));
const route53Patterns = __importStar(require("@aws-cdk/aws-route53-patterns"));
const lambdaEventSources = __importStar(require("@aws-cdk/aws-lambda-event-sources"));
const Stack_1 = require("./Stack");
const Construct_1 = require("./Construct");
const BaseSite_1 = require("./BaseSite");
const permission_1 = require("./util/permission");
const builder_1 = require("./util/builder");
const crossRegionHelper = __importStar(require("./nextjs-site/cross-region-helper"));
class NextjsSite extends Construct_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        // Local development or skip build => stub asset
        this.isPlaceholder =
            (root.local || root.skipBuild) && !props.disablePlaceholder;
        const buildDir = root.buildDir;
        const fileSizeLimit = root.isJestTest()
            ? // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                // @ts-ignore: "jestFileSizeLimitOverride" not exposed in props
                props.jestFileSizeLimitOverride || 200
            : 200;
        this.props = props;
        this.awsCliLayer = new lambda_layer_awscli_1.AwsCliLayer(this, "AwsCliLayer");
        this.registerSiteEnvironment();
        // Build app
        if (this.isPlaceholder) {
            this.buildOutDir = null;
            this.assets = this.zipAppStubAssets();
            this.deployId = `deploy-live`;
            this.routesManifest = null;
        }
        else {
            this.buildOutDir = root.isJestTest()
                ? // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                    // @ts-ignore: "jestBuildOutputPath" not exposed in props
                    props.jestBuildOutputPath || this.buildApp()
                : this.buildApp();
            const buildIdFile = path.resolve(this.buildOutDir, "assets", "BUILD_ID");
            const buildId = fs.readFileSync(buildIdFile).toString();
            this.assets = this.zipAppAssets(fileSizeLimit, buildDir);
            this.deployId = `deploy-${buildId}`;
            this.routesManifest = this.readRoutesManifest();
        }
        // Create Bucket
        this.s3Bucket = this.createS3Bucket();
        // Handle Incremental Static Regeneration
        this.regenerationQueue = this.createRegenerationQueue();
        this.regenerationFunction = this.createRegenerationFunction();
        // Create Lambda@Edge functions (always created in us-east-1)
        this.edgeLambdaRole = this.createEdgeFunctionRole();
        this.mainFunctionVersion = this.createEdgeFunction("Main", "default-lambda");
        this.apiFunctionVersion = this.createEdgeFunction("Api", "api-lambda");
        this.imageFunctionVersion = this.createEdgeFunction("Image", "image-lambda");
        // Create Custom Domain
        this.validateCustomDomainSettings();
        this.hostedZone = this.lookupHostedZone();
        this.acmCertificate = this.createCertificate();
        // Create S3 Deployment
        const s3deployCR = this.createS3Deployment();
        // Create CloudFront
        this.cfDistribution = this.createCloudFrontDistribution();
        this.cfDistribution.node.addDependency(s3deployCR);
        // Invalidate CloudFront
        const invalidationCR = this.createCloudFrontInvalidation();
        invalidationCR.node.addDependency(this.cfDistribution);
        // Connect Custom Domain to CloudFront Distribution
        this.createRoute53Records();
    }
    get url() {
        return `https://${this.cfDistribution.distributionDomainName}`;
    }
    get customDomainUrl() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === "string") {
            return `https://${customDomain}`;
        }
        else {
            return `https://${customDomain.domainName}`;
        }
    }
    get bucketArn() {
        return this.s3Bucket.bucketArn;
    }
    get bucketName() {
        return this.s3Bucket.bucketName;
    }
    get distributionId() {
        return this.cfDistribution.distributionId;
    }
    get distributionDomain() {
        return this.cfDistribution.distributionDomainName;
    }
    attachPermissions(permissions) {
        (0, permission_1.attachPermissionsToRole)(this.edgeLambdaRole, permissions);
    }
    getConstructInfo() {
        const cfn = this.cfDistribution.node
            .defaultChild;
        return {
            distributionLogicalId: Stack_1.Stack.of(this).getLogicalId(cfn),
            customDomainUrl: this.customDomainUrl,
        };
    }
    zipAppAssets(fileSizeLimit, buildDir) {
        // validate buildOutput exists
        const siteOutputPath = path.resolve(path.join(this.buildOutDir, "assets"));
        if (!fs.existsSync(siteOutputPath)) {
            throw new Error(`No build output found at "${siteOutputPath}" for the "${this.node.id}" NextjsSite.`);
        }
        // create zip files
        const script = path.join(__dirname, "../assets/BaseSite/archiver.js");
        const zipPath = path.resolve(path.join(buildDir, `NextjsSite-${this.node.id}-${this.node.addr}`));
        // clear zip path to ensure no partX.zip remain from previous build
        fs.removeSync(zipPath);
        const cmd = ["node", script, siteOutputPath, zipPath, fileSizeLimit].join(" ");
        try {
            (0, child_process_1.execSync)(cmd, {
                stdio: "inherit",
            });
        }
        catch (e) {
            throw new Error(`There was a problem generating the "${this.node.id}" NextjsSite package.`);
        }
        // create assets
        const assets = [];
        for (let partId = 0;; partId++) {
            const zipFilePath = path.join(zipPath, `part${partId}.zip`);
            if (!fs.existsSync(zipFilePath)) {
                break;
            }
            assets.push(new s3Assets.Asset(this, `Asset${partId}`, {
                path: zipFilePath,
            }));
        }
        return assets;
    }
    zipAppStubAssets() {
        return [
            new s3Assets.Asset(this, "Asset", {
                path: path.resolve(__dirname, "../assets/NextjsSite/site-stub"),
            }),
        ];
    }
    createEdgeFunction(name, handlerPath) {
        // Use real code if:
        // - Next.js app was build; AND
        // - the Lambda code directory is not empty
        const hasRealCode = typeof this.buildOutDir === "string" &&
            fs.pathExistsSync(path.join(this.buildOutDir, handlerPath, "index.js"));
        // Create function asset
        const assetPath = hasRealCode && this.buildOutDir
            ? path.join(this.buildOutDir, handlerPath)
            : path.join(__dirname, "../assets/NextjsSite/edge-lambda-stub");
        const asset = new s3Assets.Asset(this, `${name}FunctionAsset`, {
            path: assetPath,
        });
        // Create function based on region
        const root = this.node.root;
        return root.region === "us-east-1"
            ? this.createEdgeFunctionInUE1(name, assetPath, asset, hasRealCode)
            : this.createEdgeFunctionInNonUE1(name, assetPath, asset, hasRealCode);
    }
    createEdgeFunctionInUE1(name, assetPath, asset, hasRealCode) {
        const { defaultFunctionProps: fnProps } = this.props;
        // Create function
        const fn = new lambda.Function(this, `${name}Function`, {
            description: `${name} handler for Next.js`,
            handler: "index.handler",
            currentVersionOptions: {
                removalPolicy: cdk.RemovalPolicy.DESTROY,
            },
            logRetention: logs.RetentionDays.THREE_DAYS,
            code: lambda.Code.fromAsset(assetPath),
            runtime: lambda.Runtime.NODEJS_12_X,
            memorySize: (fnProps === null || fnProps === void 0 ? void 0 : fnProps.memorySize) || 512,
            timeout: cdk.Duration.seconds((fnProps === null || fnProps === void 0 ? void 0 : fnProps.timeout) || 10),
            role: this.edgeLambdaRole,
        });
        // Create alias
        fn.currentVersion.addAlias("live");
        // Deploy after the code is updated
        if (hasRealCode) {
            const updaterCR = this.createLambdaCodeReplacer(name, asset);
            fn.node.addDependency(updaterCR);
        }
        return fn.currentVersion;
    }
    createEdgeFunctionInNonUE1(name, assetPath, asset, hasRealCode) {
        const { defaultFunctionProps: fnProps } = this.props;
        // If app region is NOT us-east-1, create a Function in us-east-1
        // using a Custom Resource
        // Create a S3 bucket in us-east-1 to store Lambda code. Create
        // 1 bucket for all Edge functions.
        const bucketCR = crossRegionHelper.getOrCreateBucket(this);
        const bucketName = bucketCR.getAttString("BucketName");
        // Create a Lambda function in us-east-1
        const functionCR = crossRegionHelper.createFunction(this, name, this.edgeLambdaRole, bucketName, {
            Description: `handler for Next.js`,
            Handler: "index.handler",
            Code: {
                S3Bucket: asset.s3BucketName,
                S3Key: asset.s3ObjectKey,
            },
            Runtime: lambda.Runtime.NODEJS_12_X.name,
            MemorySize: (fnProps === null || fnProps === void 0 ? void 0 : fnProps.memorySize) || 512,
            Timeout: cdk.Duration.seconds((fnProps === null || fnProps === void 0 ? void 0 : fnProps.timeout) || 10).toSeconds(),
            Role: this.edgeLambdaRole.roleArn,
        });
        const functionArn = functionCR.getAttString("FunctionArn");
        // Create a Lambda function version in us-east-1
        const versionCR = crossRegionHelper.createVersion(this, name, functionArn);
        const versionId = versionCR.getAttString("Version");
        crossRegionHelper.updateVersionLogicalId(functionCR, versionCR);
        // Deploy after the code is updated
        if (hasRealCode) {
            const updaterCR = this.createLambdaCodeReplacer(name, asset);
            functionCR.node.addDependency(updaterCR);
        }
        return lambda.Version.fromVersionArn(this, `${name}FunctionVersion`, `${functionArn}:${versionId}`);
    }
    createEdgeFunctionRole() {
        const { defaultFunctionProps: fnProps } = this.props;
        // Create function role
        const role = new iam.Role(this, `EdgeLambdaRole`, {
            assumedBy: new iam.CompositePrincipal(new iam.ServicePrincipal("lambda.amazonaws.com"), new iam.ServicePrincipal("edgelambda.amazonaws.com")),
            managedPolicies: [
                iam.ManagedPolicy.fromManagedPolicyArn(this, "EdgeLambdaPolicy", "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"),
            ],
        });
        // Attach permission
        this.s3Bucket.grantReadWrite(role);
        this.regenerationQueue.grantSendMessages(role);
        this.regenerationFunction.grantInvoke(role);
        if (fnProps === null || fnProps === void 0 ? void 0 : fnProps.permissions) {
            (0, permission_1.attachPermissionsToRole)(role, fnProps.permissions);
        }
        return role;
    }
    createRegenerationQueue() {
        return new sqs.Queue(this, "RegenerationQueue", {
            // We call the queue the same name as the bucket so that we can easily
            // reference it from within the lambda@edge, given we can't use env vars
            // in a lambda@edge
            queueName: `${this.s3Bucket.bucketName}.fifo`,
            fifo: true,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
    }
    createRegenerationFunction() {
        // Use real code if:
        // - Next.js app was build; AND
        // - the Lambda code directory is not empty
        let code;
        let updaterCR;
        if (this.buildOutDir &&
            fs.pathExistsSync(path.join(this.buildOutDir, "regeneration-lambda", "index.js"))) {
            const asset = new s3Assets.Asset(this, `RegenerationFunctionAsset`, {
                path: path.join(this.buildOutDir, "regeneration-lambda"),
            });
            code = lambda.Code.fromAsset(path.join(this.buildOutDir, "regeneration-lambda"));
            updaterCR = this.createLambdaCodeReplacer("Regeneration", asset);
        }
        else {
            code = lambda.Code.fromInline(" ");
        }
        const fn = new lambda.Function(this, "RegenerationFunction", {
            handler: "index.handler",
            runtime: lambda.Runtime.NODEJS_12_X,
            timeout: cdk.Duration.seconds(30),
            code,
        });
        fn.addEventSource(new lambdaEventSources.SqsEventSource(this.regenerationQueue));
        // Grant permissions
        this.s3Bucket.grantReadWrite(fn);
        // Deploy after the code is updated
        if (updaterCR) {
            fn.node.addDependency(updaterCR);
        }
        return fn;
    }
    createLambdaCodeReplacer(name, asset) {
        // Note: Source code for the Lambda functions have "{{ ENV_KEY }}" in them.
        //       They need to be replaced with real values before the Lambda
        //       functions get deployed.
        var _a;
        const providerId = "LambdaCodeReplacerProvider";
        const resId = `${name}LambdaCodeReplacer`;
        const stack = cdk.Stack.of(this);
        let provider = stack.node.tryFindChild(providerId);
        // Create provider if not already created
        if (!provider) {
            provider = new lambda.Function(stack, providerId, {
                code: lambda.Code.fromAsset(path.join(__dirname, "../assets/NextjsSite/custom-resource")),
                layers: [this.awsCliLayer],
                runtime: lambda.Runtime.PYTHON_3_7,
                handler: "lambda-code-updater.handler",
                timeout: cdk.Duration.minutes(15),
                memorySize: 1024,
            });
        }
        // Allow provider to perform search/replace on the asset
        (_a = provider.role) === null || _a === void 0 ? void 0 : _a.addToPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["s3:*"],
            resources: [`arn:aws:s3:::${asset.s3BucketName}/${asset.s3ObjectKey}`],
        }));
        // Create custom resource
        const resource = new cdk.CustomResource(this, resId, {
            serviceToken: provider.functionArn,
            resourceType: "Custom::SSTLambdaCodeUpdater",
            properties: {
                Source: {
                    BucketName: asset.s3BucketName,
                    ObjectKey: asset.s3ObjectKey,
                },
                ReplaceValues: this.getLambdaContentReplaceValues(),
            },
        });
        return resource;
    }
    buildApp() {
        const { path: sitePath } = this.props;
        // validate site path exists
        if (!fs.existsSync(sitePath)) {
            throw new Error(`No path found at "${path.resolve(sitePath)}" for the "${this.node.id}" NextjsSite.`);
        }
        // Build command
        // Note: probably could pass JSON string also, but this felt safer.
        const root = this.node.root;
        const pathHash = (0, builder_1.getHandlerHash)(sitePath);
        const buildOutput = path.join(root.buildDir, pathHash);
        const configBuffer = Buffer.from(JSON.stringify({
            cwd: path.resolve(sitePath),
            args: ["build"],
        }));
        const cmd = [
            "node",
            path.join(__dirname, "../assets/NextjsSite/build.js"),
            "--path",
            path.resolve(sitePath),
            "--output",
            path.resolve(buildOutput),
            "--config",
            configBuffer.toString("base64"),
        ].join(" ");
        // Run build
        try {
            console.log(chalk_1.default.grey(`Building Next.js site ${sitePath}`));
            (0, child_process_1.execSync)(cmd, {
                cwd: sitePath,
                stdio: "inherit",
                env: Object.assign(Object.assign({}, process.env), (0, BaseSite_1.getBuildCmdEnvironment)(this.props.environment)),
            });
        }
        catch (e) {
            throw new Error(`There was a problem building the "${this.node.id}" NextjsSite.`);
        }
        return buildOutput;
    }
    createS3Bucket() {
        let { s3Bucket } = this.props;
        s3Bucket = s3Bucket || {};
        return new s3.Bucket(this, "Bucket", Object.assign({ publicReadAccess: true, autoDeleteObjects: true, removalPolicy: cdk.RemovalPolicy.DESTROY }, s3Bucket));
    }
    createS3Deployment() {
        // Create a Lambda function that will be doing the uploading
        const uploader = new lambda.Function(this, "S3Uploader", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "s3-upload.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        this.s3Bucket.grantReadWrite(uploader);
        this.assets.forEach((asset) => asset.grantRead(uploader));
        // Create the custom resource function
        const handler = new lambda.Function(this, "S3Handler", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "s3-handler.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
            environment: {
                UPLOADER_FUNCTION_NAME: uploader.functionName,
            },
        });
        this.s3Bucket.grantReadWrite(handler);
        uploader.grantInvoke(handler);
        // Create custom resource
        const fileOptions = [
            {
                exclude: "*",
                include: "public/*",
                cacheControl: "public,max-age=31536000,must-revalidate",
            },
            {
                exclude: "*",
                include: "static/*",
                cacheControl: "public,max-age=31536000,must-revalidate",
            },
            {
                exclude: "*",
                include: "static-pages/*",
                cacheControl: "public,max-age=0,s-maxage=2678400,must-revalidate",
            },
            {
                exclude: "*",
                include: "_next/data/*",
                cacheControl: "public,max-age=0,s-maxage=2678400,must-revalidate",
            },
            {
                exclude: "*",
                include: "_next/static/*",
                cacheControl: "public,max-age=31536000,immutable",
            },
        ];
        return new cdk.CustomResource(this, "S3Deployment", {
            serviceToken: handler.functionArn,
            resourceType: "Custom::SSTBucketDeployment",
            properties: {
                Sources: this.assets.map((asset) => ({
                    BucketName: asset.s3BucketName,
                    ObjectKey: asset.s3ObjectKey,
                })),
                DestinationBucketName: this.s3Bucket.bucketName,
                DestinationBucketKeyPrefix: this.deployId,
                FileOptions: (fileOptions || []).map(({ exclude, include, cacheControl }) => {
                    return [
                        "--exclude",
                        exclude,
                        "--include",
                        include,
                        "--cache-control",
                        cacheControl,
                    ];
                }),
                ReplaceValues: this.getS3ContentReplaceValues(),
            },
        });
    }
    /////////////////////
    // CloudFront Distribution
    /////////////////////
    createCloudFrontDistribution() {
        var _a, _b, _c, _d;
        const { cfCachePolicies, cfDistribution, customDomain } = this.props;
        const cfDistributionProps = cfDistribution || {};
        // Validate input
        if (cfDistributionProps.certificate) {
            throw new Error(`Do not configure the "cfDistribution.certificate". Use the "customDomain" to configure the NextjsSite domain certificate.`);
        }
        if (cfDistributionProps.domainNames) {
            throw new Error(`Do not configure the "cfDistribution.domainNames". Use the "customDomain" to configure the NextjsSite domain.`);
        }
        // Build domainNames
        const domainNames = [];
        if (!customDomain) {
            // no domain
        }
        else if (typeof customDomain === "string") {
            domainNames.push(customDomain);
        }
        else {
            domainNames.push(customDomain.domainName);
        }
        // Build behavior
        const origin = new origins.S3Origin(this.s3Bucket, {
            originPath: this.deployId,
        });
        const viewerProtocolPolicy = cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS;
        if (this.isPlaceholder) {
            return new cloudfront.Distribution(this, "Distribution", {
                defaultRootObject: "index.html",
                errorResponses: (0, BaseSite_1.buildErrorResponsesForRedirectToIndex)("index.html"),
                domainNames,
                certificate: this.acmCertificate,
                defaultBehavior: {
                    origin,
                    viewerProtocolPolicy,
                },
            });
        }
        // Build Edge functions
        const edgeLambdas = [
            {
                includeBody: true,
                eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                functionVersion: this.mainFunctionVersion,
            },
            {
                eventType: cloudfront.LambdaEdgeEventType.ORIGIN_RESPONSE,
                functionVersion: this.mainFunctionVersion,
            },
        ];
        // Build cache policy
        const staticCachePolicy = (_a = cfCachePolicies === null || cfCachePolicies === void 0 ? void 0 : cfCachePolicies.staticCachePolicy) !== null && _a !== void 0 ? _a : this.createCloudFrontStaticCachePolicy();
        const imageCachePolicy = (_b = cfCachePolicies === null || cfCachePolicies === void 0 ? void 0 : cfCachePolicies.imageCachePolicy) !== null && _b !== void 0 ? _b : this.createCloudFrontImageCachePolicy();
        const lambdaCachePolicy = (_c = cfCachePolicies === null || cfCachePolicies === void 0 ? void 0 : cfCachePolicies.lambdaCachePolicy) !== null && _c !== void 0 ? _c : this.createCloudFrontLambdaCachePolicy();
        // Create Distribution
        return new cloudfront.Distribution(this, "Distribution", Object.assign(Object.assign({ 
            // these values can be overwritten by cfDistributionProps
            defaultRootObject: "" }, cfDistributionProps), { 
            // these values can NOT be overwritten by cfDistributionProps
            domainNames, certificate: this.acmCertificate, defaultBehavior: Object.assign(Object.assign({ viewerProtocolPolicy,
                origin, allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS, cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS, compress: true, cachePolicy: lambdaCachePolicy }, (cfDistributionProps.defaultBehavior || {})), { 
                // concatenate edgeLambdas
                edgeLambdas: [
                    ...edgeLambdas,
                    ...(((_d = cfDistributionProps.defaultBehavior) === null || _d === void 0 ? void 0 : _d.edgeLambdas) || []),
                ] }), additionalBehaviors: Object.assign({ [this.pathPattern("_next/image*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_ALL,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: imageCachePolicy,
                    originRequestPolicy: new cloudfront.OriginRequestPolicy(this, "ImageOriginRequest", {
                        queryStringBehavior: cloudfront.OriginRequestQueryStringBehavior.all(),
                    }),
                    edgeLambdas: [
                        {
                            eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                            functionVersion: this.imageFunctionVersion,
                        },
                    ],
                }, [this.pathPattern("_next/data/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: lambdaCachePolicy,
                    edgeLambdas,
                }, [this.pathPattern("_next/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: staticCachePolicy,
                }, [this.pathPattern("static/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_GET_HEAD_OPTIONS,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: staticCachePolicy,
                }, [this.pathPattern("api/*")]: {
                    viewerProtocolPolicy,
                    origin,
                    allowedMethods: cloudfront.AllowedMethods.ALLOW_ALL,
                    cachedMethods: cloudfront.CachedMethods.CACHE_GET_HEAD_OPTIONS,
                    compress: true,
                    cachePolicy: lambdaCachePolicy,
                    edgeLambdas: [
                        {
                            includeBody: true,
                            eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                            functionVersion: this.apiFunctionVersion,
                        },
                    ],
                } }, (cfDistributionProps.additionalBehaviors || {})) }));
    }
    createCloudFrontStaticCachePolicy() {
        return new cloudfront.CachePolicy(this, "StaticsCache", NextjsSite.staticCachePolicyProps);
    }
    createCloudFrontImageCachePolicy() {
        return new cloudfront.CachePolicy(this, "ImageCache", NextjsSite.imageCachePolicyProps);
    }
    createCloudFrontLambdaCachePolicy() {
        return new cloudfront.CachePolicy(this, "LambdaCache", NextjsSite.lambdaCachePolicyProps);
    }
    createCloudFrontInvalidation() {
        // Create a Lambda function that will be doing the invalidation
        const invalidator = new lambda.Function(this, "CloudFrontInvalidator", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "cf-invalidate.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        // Grant permissions to invalidate CF Distribution
        invalidator.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "cloudfront:GetInvalidation",
                "cloudfront:CreateInvalidation",
            ],
            resources: ["*"],
        }));
        // Create custom resource
        return new cdk.CustomResource(this, "CloudFrontInvalidation", {
            serviceToken: invalidator.functionArn,
            resourceType: "Custom::SSTCloudFrontInvalidation",
            properties: {
                // need the DeployId field so this CR gets updated on each deploy
                DeployId: this.deployId,
                DistributionId: this.cfDistribution.distributionId,
                DistributionPaths: ["/*"],
            },
        });
    }
    /////////////////////
    // Custom Domain
    /////////////////////
    validateCustomDomainSettings() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === "string") {
            return;
        }
        if (customDomain.isExternalDomain === true) {
            if (!customDomain.certificate) {
                throw new Error(`A valid certificate is required when "isExternalDomain" is set to "true".`);
            }
            if (customDomain.domainAlias) {
                throw new Error(`Domain alias is only supported for domains hosted on Amazon Route 53. Do not set the "customDomain.domainAlias" when "isExternalDomain" is enabled.`);
            }
            if (customDomain.hostedZone) {
                throw new Error(`Hosted zones can only be configured for domains hosted on Amazon Route 53. Do not set the "customDomain.hostedZone" when "isExternalDomain" is enabled.`);
            }
        }
    }
    lookupHostedZone() {
        const { customDomain } = this.props;
        // Skip if customDomain is not configured
        if (!customDomain) {
            return;
        }
        let hostedZone;
        if (typeof customDomain === "string") {
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain,
            });
        }
        else if (cdk.Construct.isConstruct(customDomain.hostedZone)) {
            hostedZone = customDomain.hostedZone;
        }
        else if (typeof customDomain.hostedZone === "string") {
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain.hostedZone,
            });
        }
        else if (typeof customDomain.domainName === "string") {
            // Skip if domain is not a Route53 domain
            if (customDomain.isExternalDomain === true) {
                return;
            }
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain.domainName,
            });
        }
        else {
            hostedZone = customDomain.hostedZone;
        }
        return hostedZone;
    }
    createCertificate() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        let acmCertificate;
        // HostedZone is set for Route 53 domains
        if (this.hostedZone) {
            if (typeof customDomain === "string") {
                acmCertificate = new acm.DnsValidatedCertificate(this, "Certificate", {
                    domainName: customDomain,
                    hostedZone: this.hostedZone,
                    region: "us-east-1",
                });
            }
            else if (customDomain.certificate) {
                acmCertificate = customDomain.certificate;
            }
            else {
                acmCertificate = new acm.DnsValidatedCertificate(this, "Certificate", {
                    domainName: customDomain.domainName,
                    hostedZone: this.hostedZone,
                    region: "us-east-1",
                });
            }
        }
        // HostedZone is NOT set for non-Route 53 domains
        else {
            if (typeof customDomain !== "string") {
                acmCertificate = customDomain.certificate;
            }
        }
        return acmCertificate;
    }
    createRoute53Records() {
        const { customDomain } = this.props;
        if (!customDomain || !this.hostedZone) {
            return;
        }
        let recordName;
        let domainAlias;
        if (typeof customDomain === "string") {
            recordName = customDomain;
        }
        else {
            recordName = customDomain.domainName;
            domainAlias = customDomain.domainAlias;
        }
        // Create DNS record
        new route53.ARecord(this, "AliasRecord", {
            recordName,
            zone: this.hostedZone,
            target: route53.RecordTarget.fromAlias(new route53Targets.CloudFrontTarget(this.cfDistribution)),
        });
        // Create Alias redirect record
        if (domainAlias) {
            new route53Patterns.HttpsRedirect(this, "Redirect", {
                zone: this.hostedZone,
                recordNames: [domainAlias],
                targetDomain: recordName,
            });
        }
    }
    /////////////////////
    // Helper Functions
    /////////////////////
    pathPattern(pattern) {
        const { basePath } = this.routesManifest || {};
        return basePath && basePath.length > 0
            ? `${basePath.slice(1)}/${pattern}`
            : pattern;
    }
    readRoutesManifest() {
        return fs.readJSONSync(path.join(this.buildOutDir, "default-lambda/routes-manifest.json"));
    }
    getS3ContentReplaceValues() {
        const replaceValues = [];
        Object.entries(this.props.environment || {})
            .filter(([, value]) => cdk.Token.isUnresolved(value))
            .forEach(([key, value]) => {
            const token = `{{ ${key} }}`;
            replaceValues.push({
                files: "**/*.html",
                search: token,
                replace: value,
            }, {
                files: "**/*.js",
                search: token,
                replace: value,
            }, {
                files: "**/*.json",
                search: token,
                replace: value,
            });
        });
        return replaceValues;
    }
    getLambdaContentReplaceValues() {
        const replaceValues = [];
        // The Next.js app can have environment variables like
        // `process.env.API_URL` in the JS code. `process.env.API_URL` might or
        // might not get resolved on `next build` if it is used in
        // server-side functions, ie. getServerSideProps().
        // Because Lambda@Edge does not support environment variables, we will
        // use the trick of replacing "{{ _SST_NEXTJS_SITE_ENVIRONMENT_ }}" with
        // a JSON encoded string of all environment key-value pairs. This string
        // will then get decoded at run time.
        const lambdaEnvs = {};
        Object.entries(this.props.environment || {}).forEach(([key, value]) => {
            const token = `{{ ${key} }}`;
            replaceValues.push({
                files: "**/*.html",
                search: token,
                replace: value,
            }, {
                files: "**/*.js",
                search: token,
                replace: value,
            }, {
                files: "**/*.json",
                search: token,
                replace: value,
            });
            lambdaEnvs[key] = value;
        });
        replaceValues.push({
            files: "**/*.js",
            search: '"{{ _SST_NEXTJS_SITE_ENVIRONMENT_ }}"',
            replace: JSON.stringify(lambdaEnvs),
        });
        return replaceValues;
    }
    registerSiteEnvironment() {
        const environmentOutputs = {};
        for (const [key, value] of Object.entries(this.props.environment || {})) {
            const outputId = `SstSiteEnv_${key}`;
            const output = new cdk.CfnOutput(this, outputId, { value });
            environmentOutputs[key] = cdk.Stack.of(this).getLogicalId(output);
        }
        const root = this.node.root;
        root.registerSiteEnvironment({
            id: this.node.id,
            path: this.props.path,
            stack: cdk.Stack.of(this).node.id,
            environmentOutputs,
        });
    }
}
exports.NextjsSite = NextjsSite;
NextjsSite.staticCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.none(),
    headerBehavior: cloudfront.CacheHeaderBehavior.none(),
    cookieBehavior: cloudfront.CacheCookieBehavior.none(),
    defaultTtl: cdk.Duration.days(30),
    maxTtl: cdk.Duration.days(30),
    minTtl: cdk.Duration.days(30),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: "SST NextjsSite Static Default Cache Policy",
};
NextjsSite.imageCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.all(),
    headerBehavior: cloudfront.CacheHeaderBehavior.allowList("Accept"),
    cookieBehavior: cloudfront.CacheCookieBehavior.none(),
    defaultTtl: cdk.Duration.days(1),
    maxTtl: cdk.Duration.days(365),
    minTtl: cdk.Duration.days(0),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: "SST NextjsSite Image Default Cache Policy",
};
NextjsSite.lambdaCachePolicyProps = {
    queryStringBehavior: cloudfront.CacheQueryStringBehavior.all(),
    headerBehavior: cloudfront.CacheHeaderBehavior.none(),
    cookieBehavior: cloudfront.CacheCookieBehavior.all(),
    defaultTtl: cdk.Duration.seconds(0),
    maxTtl: cdk.Duration.days(365),
    minTtl: cdk.Duration.seconds(0),
    enableAcceptEncodingBrotli: true,
    enableAcceptEncodingGzip: true,
    comment: "SST NextjsSite Lambda Default Cache Policy",
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV4dGpzU2l0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9OZXh0anNTaXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxrREFBMEI7QUFDMUIsMkNBQTZCO0FBQzdCLDZDQUErQjtBQUMvQixpREFBeUM7QUFFekMsbURBQXFDO0FBQ3JDLG9EQUFzQztBQUN0QyxzREFBd0M7QUFDeEMsc0RBQXdDO0FBQ3hDLHdEQUEwQztBQUMxQyw0REFBOEM7QUFDOUMsOERBQWdEO0FBQ2hELGlFQUFtRDtBQUNuRCxvRUFBc0Q7QUFDdEQscUVBQXVEO0FBQ3ZELHNFQUEyRDtBQUMzRCx5RUFBMkQ7QUFDM0QsNkVBQStEO0FBQy9ELCtFQUFpRTtBQUNqRSxzRkFBd0U7QUFJeEUsbUNBQWdDO0FBQ2hDLDJDQUEyRDtBQUMzRCx5Q0FPb0I7QUFDcEIsa0RBQXlFO0FBQ3pFLDRDQUFnRDtBQUNoRCxxRkFBdUU7QUE0QnZFLE1BQWEsVUFBVyxTQUFRLHFCQUFTO0lBdUR2QyxZQUFZLEtBQW9CLEVBQUUsRUFBVSxFQUFFLEtBQXNCO1FBQ2xFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFXLENBQUM7UUFDcEMsZ0RBQWdEO1FBQ2hELElBQUksQ0FBQyxhQUFhO1lBQ2hCLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUM7UUFDOUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUMvQixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ3JDLENBQUMsQ0FBQyw2REFBNkQ7Z0JBQzdELCtEQUErRDtnQkFDL0QsS0FBSyxDQUFDLHlCQUF5QixJQUFJLEdBQUc7WUFDeEMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztRQUVSLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxpQ0FBVyxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUUvQixZQUFZO1FBQ1osSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3RCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDdEMsSUFBSSxDQUFDLFFBQVEsR0FBRyxhQUFhLENBQUM7WUFDOUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7U0FDNUI7YUFBTTtZQUNMLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDbEMsQ0FBQyxDQUFDLDZEQUE2RDtvQkFDN0QseURBQXlEO29CQUN6RCxLQUFLLENBQUMsbUJBQW1CLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDOUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNwQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFZLEVBQUUsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQzFFLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDeEQsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUN6RCxJQUFJLENBQUMsUUFBUSxHQUFHLFVBQVUsT0FBTyxFQUFFLENBQUM7WUFDcEMsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztTQUNqRDtRQUVELGdCQUFnQjtRQUNoQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUV0Qyx5Q0FBeUM7UUFDekMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBQ3hELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztRQUU5RCw2REFBNkQ7UUFDN0QsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztRQUNwRCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUNoRCxNQUFNLEVBQ04sZ0JBQWdCLENBQ2pCLENBQUM7UUFDRixJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQztRQUN2RSxJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUNqRCxPQUFPLEVBQ1AsY0FBYyxDQUNmLENBQUM7UUFFRix1QkFBdUI7UUFDdkIsSUFBSSxDQUFDLDRCQUE0QixFQUFFLENBQUM7UUFDcEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUMxQyxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBRS9DLHVCQUF1QjtRQUN2QixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUU3QyxvQkFBb0I7UUFDcEIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsQ0FBQztRQUMxRCxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFbkQsd0JBQXdCO1FBQ3hCLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxDQUFDO1FBQzNELGNBQWMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUV2RCxtREFBbUQ7UUFDbkQsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVELElBQVcsR0FBRztRQUNaLE9BQU8sV0FBVyxJQUFJLENBQUMsY0FBYyxDQUFDLHNCQUFzQixFQUFFLENBQUM7SUFDakUsQ0FBQztJQUVELElBQVcsZUFBZTtRQUN4QixNQUFNLEVBQUUsWUFBWSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNwQyxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE9BQU87U0FDUjtRQUVELElBQUksT0FBTyxZQUFZLEtBQUssUUFBUSxFQUFFO1lBQ3BDLE9BQU8sV0FBVyxZQUFZLEVBQUUsQ0FBQztTQUNsQzthQUFNO1lBQ0wsT0FBTyxXQUFXLFlBQVksQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUM3QztJQUNILENBQUM7SUFFRCxJQUFXLFNBQVM7UUFDbEIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQztJQUNqQyxDQUFDO0lBRUQsSUFBVyxVQUFVO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUM7SUFDbEMsQ0FBQztJQUVELElBQVcsY0FBYztRQUN2QixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsY0FBYyxDQUFDO0lBQzVDLENBQUM7SUFFRCxJQUFXLGtCQUFrQjtRQUMzQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsc0JBQXNCLENBQUM7SUFDcEQsQ0FBQztJQUVNLGlCQUFpQixDQUFDLFdBQXdCO1FBQy9DLElBQUEsb0NBQXVCLEVBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRU0sZ0JBQWdCO1FBQ3JCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSTthQUNqQyxZQUEwQyxDQUFDO1FBQzlDLE9BQU87WUFDTCxxQkFBcUIsRUFBRSxhQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUM7WUFDdkQsZUFBZSxFQUFFLElBQUksQ0FBQyxlQUFlO1NBQ3RDLENBQUM7SUFDSixDQUFDO0lBRU8sWUFBWSxDQUNsQixhQUFxQixFQUNyQixRQUFnQjtRQUVoQiw4QkFBOEI7UUFDOUIsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFZLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUM1RSxJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsRUFBRTtZQUNsQyxNQUFNLElBQUksS0FBSyxDQUNiLDZCQUE2QixjQUFjLGNBQWMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLGVBQWUsQ0FDckYsQ0FBQztTQUNIO1FBRUQsbUJBQW1CO1FBQ25CLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGdDQUFnQyxDQUFDLENBQUM7UUFDdEUsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FDMUIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsY0FBYyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQ3BFLENBQUM7UUFDRixtRUFBbUU7UUFDbkUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN2QixNQUFNLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQ3ZFLEdBQUcsQ0FDSixDQUFDO1FBRUYsSUFBSTtZQUNGLElBQUEsd0JBQVEsRUFBQyxHQUFHLEVBQUU7Z0JBQ1osS0FBSyxFQUFFLFNBQVM7YUFDakIsQ0FBQyxDQUFDO1NBQ0o7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLE1BQU0sSUFBSSxLQUFLLENBQ2IsdUNBQXVDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSx1QkFBdUIsQ0FDM0UsQ0FBQztTQUNIO1FBRUQsZ0JBQWdCO1FBQ2hCLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNsQixLQUFLLElBQUksTUFBTSxHQUFHLENBQUMsR0FBSSxNQUFNLEVBQUUsRUFBRTtZQUMvQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxPQUFPLE1BQU0sTUFBTSxDQUFDLENBQUM7WUFDNUQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLEVBQUU7Z0JBQy9CLE1BQU07YUFDUDtZQUVELE1BQU0sQ0FBQyxJQUFJLENBQ1QsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxRQUFRLE1BQU0sRUFBRSxFQUFFO2dCQUN6QyxJQUFJLEVBQUUsV0FBVzthQUNsQixDQUFDLENBQ0gsQ0FBQztTQUNIO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVPLGdCQUFnQjtRQUN0QixPQUFPO1lBQ0wsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUU7Z0JBQ2hDLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxnQ0FBZ0MsQ0FBQzthQUNoRSxDQUFDO1NBQ0gsQ0FBQztJQUNKLENBQUM7SUFFTyxrQkFBa0IsQ0FDeEIsSUFBWSxFQUNaLFdBQW1CO1FBRW5CLG9CQUFvQjtRQUNwQiwrQkFBK0I7UUFDL0IsMkNBQTJDO1FBQzNDLE1BQU0sV0FBVyxHQUNmLE9BQU8sSUFBSSxDQUFDLFdBQVcsS0FBSyxRQUFRO1lBQ3BDLEVBQUUsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBRTFFLHdCQUF3QjtRQUN4QixNQUFNLFNBQVMsR0FDYixXQUFXLElBQUksSUFBSSxDQUFDLFdBQVc7WUFDN0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUM7WUFDMUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLHVDQUF1QyxDQUFDLENBQUM7UUFDcEUsTUFBTSxLQUFLLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxHQUFHLElBQUksZUFBZSxFQUFFO1lBQzdELElBQUksRUFBRSxTQUFTO1NBQ2hCLENBQUMsQ0FBQztRQUVILGtDQUFrQztRQUNsQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNuQyxPQUFPLElBQUksQ0FBQyxNQUFNLEtBQUssV0FBVztZQUNoQyxDQUFDLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFdBQVcsQ0FBQztZQUNuRSxDQUFDLENBQUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQzNFLENBQUM7SUFFTyx1QkFBdUIsQ0FDN0IsSUFBWSxFQUNaLFNBQWlCLEVBQ2pCLEtBQXFCLEVBQ3JCLFdBQW9CO1FBRXBCLE1BQU0sRUFBRSxvQkFBb0IsRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXJELGtCQUFrQjtRQUNsQixNQUFNLEVBQUUsR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxVQUFVLEVBQUU7WUFDdEQsV0FBVyxFQUFFLEdBQUcsSUFBSSxzQkFBc0I7WUFDMUMsT0FBTyxFQUFFLGVBQWU7WUFDeEIscUJBQXFCLEVBQUU7Z0JBQ3JCLGFBQWEsRUFBRSxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU87YUFDekM7WUFDRCxZQUFZLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVO1lBQzNDLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUM7WUFDdEMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztZQUNuQyxVQUFVLEVBQUUsQ0FBQSxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsVUFBVSxLQUFJLEdBQUc7WUFDdEMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUEsT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFFLE9BQU8sS0FBSSxFQUFFLENBQUM7WUFDckQsSUFBSSxFQUFFLElBQUksQ0FBQyxjQUFjO1NBQzFCLENBQUMsQ0FBQztRQUVILGVBQWU7UUFDZixFQUFFLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVuQyxtQ0FBbUM7UUFDbkMsSUFBSSxXQUFXLEVBQUU7WUFDZixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzdELEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ2xDO1FBRUQsT0FBTyxFQUFFLENBQUMsY0FBYyxDQUFDO0lBQzNCLENBQUM7SUFFTywwQkFBMEIsQ0FDaEMsSUFBWSxFQUNaLFNBQWlCLEVBQ2pCLEtBQXFCLEVBQ3JCLFdBQW9CO1FBRXBCLE1BQU0sRUFBRSxvQkFBb0IsRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXJELGlFQUFpRTtRQUNqRSwwQkFBMEI7UUFFMUIsK0RBQStEO1FBQy9ELG1DQUFtQztRQUNuQyxNQUFNLFFBQVEsR0FBRyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzRCxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRXZELHdDQUF3QztRQUN4QyxNQUFNLFVBQVUsR0FBRyxpQkFBaUIsQ0FBQyxjQUFjLENBQ2pELElBQUksRUFDSixJQUFJLEVBQ0osSUFBSSxDQUFDLGNBQWMsRUFDbkIsVUFBVSxFQUNWO1lBQ0UsV0FBVyxFQUFFLHFCQUFxQjtZQUNsQyxPQUFPLEVBQUUsZUFBZTtZQUN4QixJQUFJLEVBQUU7Z0JBQ0osUUFBUSxFQUFFLEtBQUssQ0FBQyxZQUFZO2dCQUM1QixLQUFLLEVBQUUsS0FBSyxDQUFDLFdBQVc7YUFDekI7WUFDRCxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSTtZQUN4QyxVQUFVLEVBQUUsQ0FBQSxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsVUFBVSxLQUFJLEdBQUc7WUFDdEMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUEsT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFFLE9BQU8sS0FBSSxFQUFFLENBQUMsQ0FBQyxTQUFTLEVBQUU7WUFDakUsSUFBSSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTztTQUNsQyxDQUNGLENBQUM7UUFDRixNQUFNLFdBQVcsR0FBRyxVQUFVLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTNELGdEQUFnRDtRQUNoRCxNQUFNLFNBQVMsR0FBRyxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQztRQUMzRSxNQUFNLFNBQVMsR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3BELGlCQUFpQixDQUFDLHNCQUFzQixDQUFDLFVBQVUsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUVoRSxtQ0FBbUM7UUFDbkMsSUFBSSxXQUFXLEVBQUU7WUFDZixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzdELFVBQVUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQzFDO1FBRUQsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FDbEMsSUFBSSxFQUNKLEdBQUcsSUFBSSxpQkFBaUIsRUFDeEIsR0FBRyxXQUFXLElBQUksU0FBUyxFQUFFLENBQzlCLENBQUM7SUFDSixDQUFDO0lBRU8sc0JBQXNCO1FBQzVCLE1BQU0sRUFBRSxvQkFBb0IsRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXJELHVCQUF1QjtRQUN2QixNQUFNLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFO1lBQ2hELFNBQVMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxrQkFBa0IsQ0FDbkMsSUFBSSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsc0JBQXNCLENBQUMsRUFDaEQsSUFBSSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsMEJBQTBCLENBQUMsQ0FDckQ7WUFDRCxlQUFlLEVBQUU7Z0JBQ2YsR0FBRyxDQUFDLGFBQWEsQ0FBQyxvQkFBb0IsQ0FDcEMsSUFBSSxFQUNKLGtCQUFrQixFQUNsQixrRUFBa0UsQ0FDbkU7YUFDRjtTQUNGLENBQUMsQ0FBQztRQUVILG9CQUFvQjtRQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QyxJQUFJLE9BQU8sYUFBUCxPQUFPLHVCQUFQLE9BQU8sQ0FBRSxXQUFXLEVBQUU7WUFDeEIsSUFBQSxvQ0FBdUIsRUFBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQ3BEO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU8sdUJBQXVCO1FBQzdCLE9BQU8sSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxtQkFBbUIsRUFBRTtZQUM5QyxzRUFBc0U7WUFDdEUsd0VBQXdFO1lBQ3hFLG1CQUFtQjtZQUNuQixTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsT0FBTztZQUM3QyxJQUFJLEVBQUUsSUFBSTtZQUNWLGFBQWEsRUFBRSxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU87U0FDekMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLDBCQUEwQjtRQUNoQyxvQkFBb0I7UUFDcEIsK0JBQStCO1FBQy9CLDJDQUEyQztRQUMzQyxJQUFJLElBQUksQ0FBQztRQUNULElBQUksU0FBUyxDQUFDO1FBQ2QsSUFDRSxJQUFJLENBQUMsV0FBVztZQUNoQixFQUFFLENBQUMsY0FBYyxDQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxxQkFBcUIsRUFBRSxVQUFVLENBQUMsQ0FDL0QsRUFDRDtZQUNBLE1BQU0sS0FBSyxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsMkJBQTJCLEVBQUU7Z0JBQ2xFLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUscUJBQXFCLENBQUM7YUFDekQsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUMxQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUscUJBQXFCLENBQUMsQ0FDbkQsQ0FBQztZQUNGLFNBQVMsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ2xFO2FBQU07WUFDTCxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDcEM7UUFFRCxNQUFNLEVBQUUsR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLHNCQUFzQixFQUFFO1lBQzNELE9BQU8sRUFBRSxlQUFlO1lBQ3hCLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDbkMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNqQyxJQUFJO1NBQ0wsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLGNBQWMsQ0FDZixJQUFJLGtCQUFrQixDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FDOUQsQ0FBQztRQUVGLG9CQUFvQjtRQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVqQyxtQ0FBbUM7UUFDbkMsSUFBSSxTQUFTLEVBQUU7WUFDYixFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNsQztRQUVELE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVPLHdCQUF3QixDQUM5QixJQUFZLEVBQ1osS0FBcUI7UUFFckIsMkVBQTJFO1FBQzNFLG9FQUFvRTtRQUNwRSxnQ0FBZ0M7O1FBRWhDLE1BQU0sVUFBVSxHQUFHLDRCQUE0QixDQUFDO1FBQ2hELE1BQU0sS0FBSyxHQUFHLEdBQUcsSUFBSSxvQkFBb0IsQ0FBQztRQUMxQyxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqQyxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQW9CLENBQUM7UUFFdEUseUNBQXlDO1FBQ3pDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDYixRQUFRLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxVQUFVLEVBQUU7Z0JBQ2hELElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FDekIsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsc0NBQXNDLENBQUMsQ0FDN0Q7Z0JBQ0QsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQztnQkFDMUIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVTtnQkFDbEMsT0FBTyxFQUFFLDZCQUE2QjtnQkFDdEMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztnQkFDakMsVUFBVSxFQUFFLElBQUk7YUFDakIsQ0FBQyxDQUFDO1NBQ0o7UUFFRCx3REFBd0Q7UUFDeEQsTUFBQSxRQUFRLENBQUMsSUFBSSwwQ0FBRSxXQUFXLENBQ3hCLElBQUksR0FBRyxDQUFDLGVBQWUsQ0FBQztZQUN0QixNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO1lBQ3hCLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQztZQUNqQixTQUFTLEVBQUUsQ0FBQyxnQkFBZ0IsS0FBSyxDQUFDLFlBQVksSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDdkUsQ0FBQyxDQUNILENBQUM7UUFFRix5QkFBeUI7UUFDekIsTUFBTSxRQUFRLEdBQUcsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUU7WUFDbkQsWUFBWSxFQUFFLFFBQVEsQ0FBQyxXQUFXO1lBQ2xDLFlBQVksRUFBRSw4QkFBOEI7WUFDNUMsVUFBVSxFQUFFO2dCQUNWLE1BQU0sRUFBRTtvQkFDTixVQUFVLEVBQUUsS0FBSyxDQUFDLFlBQVk7b0JBQzlCLFNBQVMsRUFBRSxLQUFLLENBQUMsV0FBVztpQkFDN0I7Z0JBQ0QsYUFBYSxFQUFFLElBQUksQ0FBQyw2QkFBNkIsRUFBRTthQUNwRDtTQUNGLENBQUMsQ0FBQztRQUVILE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFTyxRQUFRO1FBQ2QsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXRDLDRCQUE0QjtRQUM1QixJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUM1QixNQUFNLElBQUksS0FBSyxDQUNiLHFCQUFxQixJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxjQUN6QyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQ1osZUFBZSxDQUNoQixDQUFDO1NBQ0g7UUFFRCxnQkFBZ0I7UUFDaEIsbUVBQW1FO1FBQ25FLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ25DLE1BQU0sUUFBUSxHQUFHLElBQUEsd0JBQWMsRUFBQyxRQUFRLENBQUMsQ0FBQztRQUMxQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDdkQsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FDOUIsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNiLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUMzQixJQUFJLEVBQUUsQ0FBQyxPQUFPLENBQUM7U0FDaEIsQ0FBQyxDQUNILENBQUM7UUFDRixNQUFNLEdBQUcsR0FBRztZQUNWLE1BQU07WUFDTixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSwrQkFBK0IsQ0FBQztZQUNyRCxRQUFRO1lBQ1IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUM7WUFDdEIsVUFBVTtZQUNWLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDO1lBQ3pCLFVBQVU7WUFDVixZQUFZLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztTQUNoQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVaLFlBQVk7UUFDWixJQUFJO1lBQ0YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFLLENBQUMsSUFBSSxDQUFDLHlCQUF5QixRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDN0QsSUFBQSx3QkFBUSxFQUFDLEdBQUcsRUFBRTtnQkFDWixHQUFHLEVBQUUsUUFBUTtnQkFDYixLQUFLLEVBQUUsU0FBUztnQkFDaEIsR0FBRyxrQ0FDRSxPQUFPLENBQUMsR0FBRyxHQUNYLElBQUEsaUNBQXNCLEVBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FDbEQ7YUFDRixDQUFDLENBQUM7U0FDSjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsTUFBTSxJQUFJLEtBQUssQ0FDYixxQ0FBcUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLGVBQWUsQ0FDakUsQ0FBQztTQUNIO1FBRUQsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUVPLGNBQWM7UUFDcEIsSUFBSSxFQUFFLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDOUIsUUFBUSxHQUFHLFFBQVEsSUFBSSxFQUFFLENBQUM7UUFFMUIsT0FBTyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFFBQVEsa0JBQ2pDLGdCQUFnQixFQUFFLElBQUksRUFDdEIsaUJBQWlCLEVBQUUsSUFBSSxFQUN2QixhQUFhLEVBQUUsR0FBRyxDQUFDLGFBQWEsQ0FBQyxPQUFPLElBQ3JDLFFBQVEsRUFDWCxDQUFDO0lBQ0wsQ0FBQztJQUVPLGtCQUFrQjtRQUN4Qiw0REFBNEQ7UUFDNUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxZQUFZLEVBQUU7WUFDdkQsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxvQ0FBb0MsQ0FBQyxDQUMzRDtZQUNELE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDMUIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVTtZQUNsQyxPQUFPLEVBQUUsbUJBQW1CO1lBQzVCLE9BQU8sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDakMsVUFBVSxFQUFFLElBQUk7U0FDakIsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUUxRCxzQ0FBc0M7UUFDdEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxXQUFXLEVBQUU7WUFDckQsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxvQ0FBb0MsQ0FBQyxDQUMzRDtZQUNELE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDMUIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVTtZQUNsQyxPQUFPLEVBQUUsb0JBQW9CO1lBQzdCLE9BQU8sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDakMsVUFBVSxFQUFFLElBQUk7WUFDaEIsV0FBVyxFQUFFO2dCQUNYLHNCQUFzQixFQUFFLFFBQVEsQ0FBQyxZQUFZO2FBQzlDO1NBQ0YsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdEMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU5Qix5QkFBeUI7UUFDekIsTUFBTSxXQUFXLEdBQUc7WUFDbEI7Z0JBQ0UsT0FBTyxFQUFFLEdBQUc7Z0JBQ1osT0FBTyxFQUFFLFVBQVU7Z0JBQ25CLFlBQVksRUFBRSx5Q0FBeUM7YUFDeEQ7WUFDRDtnQkFDRSxPQUFPLEVBQUUsR0FBRztnQkFDWixPQUFPLEVBQUUsVUFBVTtnQkFDbkIsWUFBWSxFQUFFLHlDQUF5QzthQUN4RDtZQUNEO2dCQUNFLE9BQU8sRUFBRSxHQUFHO2dCQUNaLE9BQU8sRUFBRSxnQkFBZ0I7Z0JBQ3pCLFlBQVksRUFBRSxtREFBbUQ7YUFDbEU7WUFDRDtnQkFDRSxPQUFPLEVBQUUsR0FBRztnQkFDWixPQUFPLEVBQUUsY0FBYztnQkFDdkIsWUFBWSxFQUFFLG1EQUFtRDthQUNsRTtZQUNEO2dCQUNFLE9BQU8sRUFBRSxHQUFHO2dCQUNaLE9BQU8sRUFBRSxnQkFBZ0I7Z0JBQ3pCLFlBQVksRUFBRSxtQ0FBbUM7YUFDbEQ7U0FDRixDQUFDO1FBQ0YsT0FBTyxJQUFJLEdBQUcsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLGNBQWMsRUFBRTtZQUNsRCxZQUFZLEVBQUUsT0FBTyxDQUFDLFdBQVc7WUFDakMsWUFBWSxFQUFFLDZCQUE2QjtZQUMzQyxVQUFVLEVBQUU7Z0JBQ1YsT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO29CQUNuQyxVQUFVLEVBQUUsS0FBSyxDQUFDLFlBQVk7b0JBQzlCLFNBQVMsRUFBRSxLQUFLLENBQUMsV0FBVztpQkFDN0IsQ0FBQyxDQUFDO2dCQUNILHFCQUFxQixFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVTtnQkFDL0MsMEJBQTBCLEVBQUUsSUFBSSxDQUFDLFFBQVE7Z0JBQ3pDLFdBQVcsRUFBRSxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQ2xDLENBQUMsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxFQUFFLEVBQUU7b0JBQ3JDLE9BQU87d0JBQ0wsV0FBVzt3QkFDWCxPQUFPO3dCQUNQLFdBQVc7d0JBQ1gsT0FBTzt3QkFDUCxpQkFBaUI7d0JBQ2pCLFlBQVk7cUJBQ2IsQ0FBQztnQkFDSixDQUFDLENBQ0Y7Z0JBQ0QsYUFBYSxFQUFFLElBQUksQ0FBQyx5QkFBeUIsRUFBRTthQUNoRDtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxxQkFBcUI7SUFDckIsMEJBQTBCO0lBQzFCLHFCQUFxQjtJQUViLDRCQUE0Qjs7UUFDbEMsTUFBTSxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsWUFBWSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNyRSxNQUFNLG1CQUFtQixHQUFHLGNBQWMsSUFBSSxFQUFFLENBQUM7UUFFakQsaUJBQWlCO1FBQ2pCLElBQUksbUJBQW1CLENBQUMsV0FBVyxFQUFFO1lBQ25DLE1BQU0sSUFBSSxLQUFLLENBQ2IsMkhBQTJILENBQzVILENBQUM7U0FDSDtRQUNELElBQUksbUJBQW1CLENBQUMsV0FBVyxFQUFFO1lBQ25DLE1BQU0sSUFBSSxLQUFLLENBQ2IsK0dBQStHLENBQ2hILENBQUM7U0FDSDtRQUVELG9CQUFvQjtRQUNwQixNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNqQixZQUFZO1NBQ2I7YUFBTSxJQUFJLE9BQU8sWUFBWSxLQUFLLFFBQVEsRUFBRTtZQUMzQyxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQ2hDO2FBQU07WUFDTCxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUMzQztRQUVELGlCQUFpQjtRQUNqQixNQUFNLE1BQU0sR0FBRyxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNqRCxVQUFVLEVBQUUsSUFBSSxDQUFDLFFBQVE7U0FDMUIsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxvQkFBb0IsR0FDeEIsVUFBVSxDQUFDLG9CQUFvQixDQUFDLGlCQUFpQixDQUFDO1FBRXBELElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUN0QixPQUFPLElBQUksVUFBVSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFO2dCQUN2RCxpQkFBaUIsRUFBRSxZQUFZO2dCQUMvQixjQUFjLEVBQUUsSUFBQSxnREFBcUMsRUFBQyxZQUFZLENBQUM7Z0JBQ25FLFdBQVc7Z0JBQ1gsV0FBVyxFQUFFLElBQUksQ0FBQyxjQUFjO2dCQUNoQyxlQUFlLEVBQUU7b0JBQ2YsTUFBTTtvQkFDTixvQkFBb0I7aUJBQ3JCO2FBQ0YsQ0FBQyxDQUFDO1NBQ0o7UUFFRCx1QkFBdUI7UUFDdkIsTUFBTSxXQUFXLEdBQTRCO1lBQzNDO2dCQUNFLFdBQVcsRUFBRSxJQUFJO2dCQUNqQixTQUFTLEVBQUUsVUFBVSxDQUFDLG1CQUFtQixDQUFDLGNBQWM7Z0JBQ3hELGVBQWUsRUFBRSxJQUFJLENBQUMsbUJBQW1CO2FBQzFDO1lBQ0Q7Z0JBQ0UsU0FBUyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxlQUFlO2dCQUN6RCxlQUFlLEVBQUUsSUFBSSxDQUFDLG1CQUFtQjthQUMxQztTQUNGLENBQUM7UUFFRixxQkFBcUI7UUFDckIsTUFBTSxpQkFBaUIsR0FDckIsTUFBQSxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsaUJBQWlCLG1DQUNsQyxJQUFJLENBQUMsaUNBQWlDLEVBQUUsQ0FBQztRQUMzQyxNQUFNLGdCQUFnQixHQUNwQixNQUFBLGVBQWUsYUFBZixlQUFlLHVCQUFmLGVBQWUsQ0FBRSxnQkFBZ0IsbUNBQ2pDLElBQUksQ0FBQyxnQ0FBZ0MsRUFBRSxDQUFDO1FBQzFDLE1BQU0saUJBQWlCLEdBQ3JCLE1BQUEsZUFBZSxhQUFmLGVBQWUsdUJBQWYsZUFBZSxDQUFFLGlCQUFpQixtQ0FDbEMsSUFBSSxDQUFDLGlDQUFpQyxFQUFFLENBQUM7UUFFM0Msc0JBQXNCO1FBQ3RCLE9BQU8sSUFBSSxVQUFVLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxjQUFjO1lBQ3JELHlEQUF5RDtZQUN6RCxpQkFBaUIsRUFBRSxFQUFFLElBRWxCLG1CQUFtQjtZQUN0Qiw2REFBNkQ7WUFDN0QsV0FBVyxFQUNYLFdBQVcsRUFBRSxJQUFJLENBQUMsY0FBYyxFQUNoQyxlQUFlLGdDQUNiLG9CQUFvQjtnQkFDcEIsTUFBTSxFQUNOLGNBQWMsRUFBRSxVQUFVLENBQUMsY0FBYyxDQUFDLHNCQUFzQixFQUNoRSxhQUFhLEVBQUUsVUFBVSxDQUFDLGFBQWEsQ0FBQyxzQkFBc0IsRUFDOUQsUUFBUSxFQUFFLElBQUksRUFDZCxXQUFXLEVBQUUsaUJBQWlCLElBQzNCLENBQUMsbUJBQW1CLENBQUMsZUFBZSxJQUFJLEVBQUUsQ0FBQztnQkFDOUMsMEJBQTBCO2dCQUMxQixXQUFXLEVBQUU7b0JBQ1gsR0FBRyxXQUFXO29CQUNkLEdBQUcsQ0FBQyxDQUFBLE1BQUEsbUJBQW1CLENBQUMsZUFBZSwwQ0FBRSxXQUFXLEtBQUksRUFBRSxDQUFDO2lCQUM1RCxLQUVILG1CQUFtQixrQkFDakIsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUU7b0JBQ2xDLG9CQUFvQjtvQkFDcEIsTUFBTTtvQkFDTixjQUFjLEVBQUUsVUFBVSxDQUFDLGNBQWMsQ0FBQyxTQUFTO29CQUNuRCxhQUFhLEVBQUUsVUFBVSxDQUFDLGFBQWEsQ0FBQyxzQkFBc0I7b0JBQzlELFFBQVEsRUFBRSxJQUFJO29CQUNkLFdBQVcsRUFBRSxnQkFBZ0I7b0JBQzdCLG1CQUFtQixFQUFFLElBQUksVUFBVSxDQUFDLG1CQUFtQixDQUNyRCxJQUFJLEVBQ0osb0JBQW9CLEVBQ3BCO3dCQUNFLG1CQUFtQixFQUNqQixVQUFVLENBQUMsZ0NBQWdDLENBQUMsR0FBRyxFQUFFO3FCQUNwRCxDQUNGO29CQUNELFdBQVcsRUFBRTt3QkFDWDs0QkFDRSxTQUFTLEVBQUUsVUFBVSxDQUFDLG1CQUFtQixDQUFDLGNBQWM7NEJBQ3hELGVBQWUsRUFBRSxJQUFJLENBQUMsb0JBQW9CO3lCQUMzQztxQkFDRjtpQkFDRixFQUNELENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxFQUFFO29CQUNsQyxvQkFBb0I7b0JBQ3BCLE1BQU07b0JBQ04sY0FBYyxFQUFFLFVBQVUsQ0FBQyxjQUFjLENBQUMsc0JBQXNCO29CQUNoRSxhQUFhLEVBQUUsVUFBVSxDQUFDLGFBQWEsQ0FBQyxzQkFBc0I7b0JBQzlELFFBQVEsRUFBRSxJQUFJO29CQUNkLFdBQVcsRUFBRSxpQkFBaUI7b0JBQzlCLFdBQVc7aUJBQ1osRUFDRCxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRTtvQkFDN0Isb0JBQW9CO29CQUNwQixNQUFNO29CQUNOLGNBQWMsRUFBRSxVQUFVLENBQUMsY0FBYyxDQUFDLHNCQUFzQjtvQkFDaEUsYUFBYSxFQUFFLFVBQVUsQ0FBQyxhQUFhLENBQUMsc0JBQXNCO29CQUM5RCxRQUFRLEVBQUUsSUFBSTtvQkFDZCxXQUFXLEVBQUUsaUJBQWlCO2lCQUMvQixFQUNELENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFO29CQUM5QixvQkFBb0I7b0JBQ3BCLE1BQU07b0JBQ04sY0FBYyxFQUFFLFVBQVUsQ0FBQyxjQUFjLENBQUMsc0JBQXNCO29CQUNoRSxhQUFhLEVBQUUsVUFBVSxDQUFDLGFBQWEsQ0FBQyxzQkFBc0I7b0JBQzlELFFBQVEsRUFBRSxJQUFJO29CQUNkLFdBQVcsRUFBRSxpQkFBaUI7aUJBQy9CLEVBQ0QsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUU7b0JBQzNCLG9CQUFvQjtvQkFDcEIsTUFBTTtvQkFDTixjQUFjLEVBQUUsVUFBVSxDQUFDLGNBQWMsQ0FBQyxTQUFTO29CQUNuRCxhQUFhLEVBQUUsVUFBVSxDQUFDLGFBQWEsQ0FBQyxzQkFBc0I7b0JBQzlELFFBQVEsRUFBRSxJQUFJO29CQUNkLFdBQVcsRUFBRSxpQkFBaUI7b0JBQzlCLFdBQVcsRUFBRTt3QkFDWDs0QkFDRSxXQUFXLEVBQUUsSUFBSTs0QkFDakIsU0FBUyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxjQUFjOzRCQUN4RCxlQUFlLEVBQUUsSUFBSSxDQUFDLGtCQUFrQjt5QkFDekM7cUJBQ0Y7aUJBQ0YsSUFDRSxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixJQUFJLEVBQUUsQ0FBQyxLQUVwRCxDQUFDO0lBQ0wsQ0FBQztJQUVPLGlDQUFpQztRQUN2QyxPQUFPLElBQUksVUFBVSxDQUFDLFdBQVcsQ0FDL0IsSUFBSSxFQUNKLGNBQWMsRUFDZCxVQUFVLENBQUMsc0JBQXNCLENBQ2xDLENBQUM7SUFDSixDQUFDO0lBRU8sZ0NBQWdDO1FBQ3RDLE9BQU8sSUFBSSxVQUFVLENBQUMsV0FBVyxDQUMvQixJQUFJLEVBQ0osWUFBWSxFQUNaLFVBQVUsQ0FBQyxxQkFBcUIsQ0FDakMsQ0FBQztJQUNKLENBQUM7SUFFTyxpQ0FBaUM7UUFDdkMsT0FBTyxJQUFJLFVBQVUsQ0FBQyxXQUFXLENBQy9CLElBQUksRUFDSixhQUFhLEVBQ2IsVUFBVSxDQUFDLHNCQUFzQixDQUNsQyxDQUFDO0lBQ0osQ0FBQztJQUVPLDRCQUE0QjtRQUNsQywrREFBK0Q7UUFDL0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSx1QkFBdUIsRUFBRTtZQUNyRSxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQ3pCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLG9DQUFvQyxDQUFDLENBQzNEO1lBQ0QsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQztZQUMxQixPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVO1lBQ2xDLE9BQU8sRUFBRSx1QkFBdUI7WUFDaEMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNqQyxVQUFVLEVBQUUsSUFBSTtTQUNqQixDQUFDLENBQUM7UUFFSCxrREFBa0Q7UUFDbEQsV0FBVyxDQUFDLGVBQWUsQ0FDekIsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO1lBQ3RCLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUs7WUFDeEIsT0FBTyxFQUFFO2dCQUNQLDRCQUE0QjtnQkFDNUIsK0JBQStCO2FBQ2hDO1lBQ0QsU0FBUyxFQUFFLENBQUMsR0FBRyxDQUFDO1NBQ2pCLENBQUMsQ0FDSCxDQUFDO1FBRUYseUJBQXlCO1FBQ3pCLE9BQU8sSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSx3QkFBd0IsRUFBRTtZQUM1RCxZQUFZLEVBQUUsV0FBVyxDQUFDLFdBQVc7WUFDckMsWUFBWSxFQUFFLG1DQUFtQztZQUNqRCxVQUFVLEVBQUU7Z0JBQ1YsaUVBQWlFO2dCQUNqRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7Z0JBQ3ZCLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLGNBQWM7Z0JBQ2xELGlCQUFpQixFQUFFLENBQUMsSUFBSSxDQUFDO2FBQzFCO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELHFCQUFxQjtJQUNyQixnQkFBZ0I7SUFDaEIscUJBQXFCO0lBRVgsNEJBQTRCO1FBQ3BDLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXBDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDakIsT0FBTztTQUNSO1FBRUQsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUU7WUFDcEMsT0FBTztTQUNSO1FBRUQsSUFBSSxZQUFZLENBQUMsZ0JBQWdCLEtBQUssSUFBSSxFQUFFO1lBQzFDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFO2dCQUM3QixNQUFNLElBQUksS0FBSyxDQUNiLDJFQUEyRSxDQUM1RSxDQUFDO2FBQ0g7WUFDRCxJQUFJLFlBQVksQ0FBQyxXQUFXLEVBQUU7Z0JBQzVCLE1BQU0sSUFBSSxLQUFLLENBQ2IscUpBQXFKLENBQ3RKLENBQUM7YUFDSDtZQUNELElBQUksWUFBWSxDQUFDLFVBQVUsRUFBRTtnQkFDM0IsTUFBTSxJQUFJLEtBQUssQ0FDYix5SkFBeUosQ0FDMUosQ0FBQzthQUNIO1NBQ0Y7SUFDSCxDQUFDO0lBRVMsZ0JBQWdCO1FBQ3hCLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXBDLHlDQUF5QztRQUN6QyxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE9BQU87U0FDUjtRQUVELElBQUksVUFBVSxDQUFDO1FBRWYsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUU7WUFDcEMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxZQUFZLEVBQUU7Z0JBQzdELFVBQVUsRUFBRSxZQUFZO2FBQ3pCLENBQUMsQ0FBQztTQUNKO2FBQU0sSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDN0QsVUFBVSxHQUFHLFlBQVksQ0FBQyxVQUFpQyxDQUFDO1NBQzdEO2FBQU0sSUFBSSxPQUFPLFlBQVksQ0FBQyxVQUFVLEtBQUssUUFBUSxFQUFFO1lBQ3RELFVBQVUsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsWUFBWSxFQUFFO2dCQUM3RCxVQUFVLEVBQUUsWUFBWSxDQUFDLFVBQVU7YUFDcEMsQ0FBQyxDQUFDO1NBQ0o7YUFBTSxJQUFJLE9BQU8sWUFBWSxDQUFDLFVBQVUsS0FBSyxRQUFRLEVBQUU7WUFDdEQseUNBQXlDO1lBQ3pDLElBQUksWUFBWSxDQUFDLGdCQUFnQixLQUFLLElBQUksRUFBRTtnQkFDMUMsT0FBTzthQUNSO1lBRUQsVUFBVSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxZQUFZLEVBQUU7Z0JBQzdELFVBQVUsRUFBRSxZQUFZLENBQUMsVUFBVTthQUNwQyxDQUFDLENBQUM7U0FDSjthQUFNO1lBQ0wsVUFBVSxHQUFHLFlBQVksQ0FBQyxVQUFpQyxDQUFDO1NBQzdEO1FBRUQsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUVPLGlCQUFpQjtRQUN2QixNQUFNLEVBQUUsWUFBWSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUVwQyxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE9BQU87U0FDUjtRQUVELElBQUksY0FBYyxDQUFDO1FBRW5CLHlDQUF5QztRQUN6QyxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbkIsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUU7Z0JBQ3BDLGNBQWMsR0FBRyxJQUFJLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFO29CQUNwRSxVQUFVLEVBQUUsWUFBWTtvQkFDeEIsVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVO29CQUMzQixNQUFNLEVBQUUsV0FBVztpQkFDcEIsQ0FBQyxDQUFDO2FBQ0o7aUJBQU0sSUFBSSxZQUFZLENBQUMsV0FBVyxFQUFFO2dCQUNuQyxjQUFjLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQzthQUMzQztpQkFBTTtnQkFDTCxjQUFjLEdBQUcsSUFBSSxHQUFHLENBQUMsdUJBQXVCLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRTtvQkFDcEUsVUFBVSxFQUFFLFlBQVksQ0FBQyxVQUFVO29CQUNuQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7b0JBQzNCLE1BQU0sRUFBRSxXQUFXO2lCQUNwQixDQUFDLENBQUM7YUFDSjtTQUNGO1FBQ0QsaURBQWlEO2FBQzVDO1lBQ0gsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUU7Z0JBQ3BDLGNBQWMsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDO2FBQzNDO1NBQ0Y7UUFFRCxPQUFPLGNBQWMsQ0FBQztJQUN4QixDQUFDO0lBRVMsb0JBQW9CO1FBQzVCLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXBDLElBQUksQ0FBQyxZQUFZLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ3JDLE9BQU87U0FDUjtRQUVELElBQUksVUFBVSxDQUFDO1FBQ2YsSUFBSSxXQUFXLENBQUM7UUFDaEIsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUU7WUFDcEMsVUFBVSxHQUFHLFlBQVksQ0FBQztTQUMzQjthQUFNO1lBQ0wsVUFBVSxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUM7WUFDckMsV0FBVyxHQUFHLFlBQVksQ0FBQyxXQUFXLENBQUM7U0FDeEM7UUFFRCxvQkFBb0I7UUFDcEIsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxhQUFhLEVBQUU7WUFDdkMsVUFBVTtZQUNWLElBQUksRUFBRSxJQUFJLENBQUMsVUFBVTtZQUNyQixNQUFNLEVBQUUsT0FBTyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQ3BDLElBQUksY0FBYyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FDekQ7U0FDRixDQUFDLENBQUM7UUFFSCwrQkFBK0I7UUFDL0IsSUFBSSxXQUFXLEVBQUU7WUFDZixJQUFJLGVBQWUsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRTtnQkFDbEQsSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVO2dCQUNyQixXQUFXLEVBQUUsQ0FBQyxXQUFXLENBQUM7Z0JBQzFCLFlBQVksRUFBRSxVQUFVO2FBQ3pCLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQUVELHFCQUFxQjtJQUNyQixtQkFBbUI7SUFDbkIscUJBQXFCO0lBRWIsV0FBVyxDQUFDLE9BQWU7UUFDakMsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxjQUFjLElBQUksRUFBRSxDQUFDO1FBQy9DLE9BQU8sUUFBUSxJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQztZQUNwQyxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLE9BQU8sRUFBRTtZQUNuQyxDQUFDLENBQUMsT0FBTyxDQUFDO0lBQ2QsQ0FBQztJQUVPLGtCQUFrQjtRQUN4QixPQUFPLEVBQUUsQ0FBQyxZQUFZLENBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVksRUFBRSxxQ0FBcUMsQ0FBQyxDQUNwRSxDQUFDO0lBQ0osQ0FBQztJQUVPLHlCQUF5QjtRQUMvQixNQUFNLGFBQWEsR0FBMkIsRUFBRSxDQUFDO1FBRWpELE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLElBQUksRUFBRSxDQUFDO2FBQ3pDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDcEQsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRTtZQUN4QixNQUFNLEtBQUssR0FBRyxNQUFNLEdBQUcsS0FBSyxDQUFDO1lBQzdCLGFBQWEsQ0FBQyxJQUFJLENBQ2hCO2dCQUNFLEtBQUssRUFBRSxXQUFXO2dCQUNsQixNQUFNLEVBQUUsS0FBSztnQkFDYixPQUFPLEVBQUUsS0FBSzthQUNmLEVBQ0Q7Z0JBQ0UsS0FBSyxFQUFFLFNBQVM7Z0JBQ2hCLE1BQU0sRUFBRSxLQUFLO2dCQUNiLE9BQU8sRUFBRSxLQUFLO2FBQ2YsRUFDRDtnQkFDRSxLQUFLLEVBQUUsV0FBVztnQkFDbEIsTUFBTSxFQUFFLEtBQUs7Z0JBQ2IsT0FBTyxFQUFFLEtBQUs7YUFDZixDQUNGLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztRQUNMLE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7SUFFTyw2QkFBNkI7UUFDbkMsTUFBTSxhQUFhLEdBQTJCLEVBQUUsQ0FBQztRQUVqRCxzREFBc0Q7UUFDdEQsdUVBQXVFO1FBQ3ZFLDBEQUEwRDtRQUMxRCxtREFBbUQ7UUFDbkQsc0VBQXNFO1FBQ3RFLHdFQUF3RTtRQUN4RSx3RUFBd0U7UUFDeEUscUNBQXFDO1FBQ3JDLE1BQU0sVUFBVSxHQUE4QixFQUFFLENBQUM7UUFFakQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFO1lBQ3BFLE1BQU0sS0FBSyxHQUFHLE1BQU0sR0FBRyxLQUFLLENBQUM7WUFDN0IsYUFBYSxDQUFDLElBQUksQ0FDaEI7Z0JBQ0UsS0FBSyxFQUFFLFdBQVc7Z0JBQ2xCLE1BQU0sRUFBRSxLQUFLO2dCQUNiLE9BQU8sRUFBRSxLQUFLO2FBQ2YsRUFDRDtnQkFDRSxLQUFLLEVBQUUsU0FBUztnQkFDaEIsTUFBTSxFQUFFLEtBQUs7Z0JBQ2IsT0FBTyxFQUFFLEtBQUs7YUFDZixFQUNEO2dCQUNFLEtBQUssRUFBRSxXQUFXO2dCQUNsQixNQUFNLEVBQUUsS0FBSztnQkFDYixPQUFPLEVBQUUsS0FBSzthQUNmLENBQ0YsQ0FBQztZQUNGLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7UUFDMUIsQ0FBQyxDQUFDLENBQUM7UUFFSCxhQUFhLENBQUMsSUFBSSxDQUFDO1lBQ2pCLEtBQUssRUFBRSxTQUFTO1lBQ2hCLE1BQU0sRUFBRSx1Q0FBdUM7WUFDL0MsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDO1NBQ3BDLENBQUMsQ0FBQztRQUVILE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7SUFFTyx1QkFBdUI7UUFDN0IsTUFBTSxrQkFBa0IsR0FBMkIsRUFBRSxDQUFDO1FBQ3RELEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQyxFQUFFO1lBQ3ZFLE1BQU0sUUFBUSxHQUFHLGNBQWMsR0FBRyxFQUFFLENBQUM7WUFDckMsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQzVELGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNuRTtRQUVELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ25DLElBQUksQ0FBQyx1QkFBdUIsQ0FBQztZQUMzQixFQUFFLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ2hCLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUk7WUFDckIsS0FBSyxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ2pDLGtCQUFrQjtTQUNlLENBQUMsQ0FBQztJQUN2QyxDQUFDOztBQTNsQ0gsZ0NBNGxDQztBQTNsQ2UsaUNBQXNCLEdBQWdDO0lBQ2xFLG1CQUFtQixFQUFFLFVBQVUsQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLEVBQUU7SUFDL0QsY0FBYyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUU7SUFDckQsY0FBYyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUU7SUFDckQsVUFBVSxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztJQUNqQyxNQUFNLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO0lBQzdCLE1BQU0sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7SUFDN0IsMEJBQTBCLEVBQUUsSUFBSTtJQUNoQyx3QkFBd0IsRUFBRSxJQUFJO0lBQzlCLE9BQU8sRUFBRSw0Q0FBNEM7Q0FDdEQsQ0FBQztBQUVZLGdDQUFxQixHQUFnQztJQUNqRSxtQkFBbUIsRUFBRSxVQUFVLENBQUMsd0JBQXdCLENBQUMsR0FBRyxFQUFFO0lBQzlELGNBQWMsRUFBRSxVQUFVLENBQUMsbUJBQW1CLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztJQUNsRSxjQUFjLEVBQUUsVUFBVSxDQUFDLG1CQUFtQixDQUFDLElBQUksRUFBRTtJQUNyRCxVQUFVLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ2hDLE1BQU0sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDOUIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUM1QiwwQkFBMEIsRUFBRSxJQUFJO0lBQ2hDLHdCQUF3QixFQUFFLElBQUk7SUFDOUIsT0FBTyxFQUFFLDJDQUEyQztDQUNyRCxDQUFDO0FBRVksaUNBQXNCLEdBQWdDO0lBQ2xFLG1CQUFtQixFQUFFLFVBQVUsQ0FBQyx3QkFBd0IsQ0FBQyxHQUFHLEVBQUU7SUFDOUQsY0FBYyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUU7SUFDckQsY0FBYyxFQUFFLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLEVBQUU7SUFDcEQsVUFBVSxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUNuQyxNQUFNLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO0lBQzlCLE1BQU0sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDL0IsMEJBQTBCLEVBQUUsSUFBSTtJQUNoQyx3QkFBd0IsRUFBRSxJQUFJO0lBQzlCLE9BQU8sRUFBRSw0Q0FBNEM7Q0FDdEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGFsayBmcm9tIFwiY2hhbGtcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSBcIkBhd3MtY2RrL2NvcmVcIjtcbmltcG9ydCAqIGFzIHMzIGZyb20gXCJAYXdzLWNkay9hd3MtczNcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiQGF3cy1jZGsvYXdzLWlhbVwiO1xuaW1wb3J0ICogYXMgc3FzIGZyb20gXCJAYXdzLWNkay9hd3Mtc3FzXCI7XG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gXCJAYXdzLWNkay9hd3MtbG9nc1wiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJAYXdzLWNkay9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzIGZyb20gXCJAYXdzLWNkay9hd3Mtcm91dGU1M1wiO1xuaW1wb3J0ICogYXMgczNBc3NldHMgZnJvbSBcIkBhd3MtY2RrL2F3cy1zMy1hc3NldHNcIjtcbmltcG9ydCAqIGFzIGNsb3VkZnJvbnQgZnJvbSBcIkBhd3MtY2RrL2F3cy1jbG91ZGZyb250XCI7XG5pbXBvcnQgKiBhcyBhY20gZnJvbSBcIkBhd3MtY2RrL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXJcIjtcbmltcG9ydCB7IEF3c0NsaUxheWVyIH0gZnJvbSBcIkBhd3MtY2RrL2xhbWJkYS1sYXllci1hd3NjbGlcIjtcbmltcG9ydCAqIGFzIG9yaWdpbnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1jbG91ZGZyb250LW9yaWdpbnNcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTNUYXJnZXRzIGZyb20gXCJAYXdzLWNkay9hd3Mtcm91dGU1My10YXJnZXRzXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzUGF0dGVybnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1yb3V0ZTUzLXBhdHRlcm5zXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGFFdmVudFNvdXJjZXMgZnJvbSBcIkBhd3MtY2RrL2F3cy1sYW1iZGEtZXZlbnQtc291cmNlc1wiO1xuaW1wb3J0IHsgUm91dGVzTWFuaWZlc3QgfSBmcm9tIFwiQHNlcnZlcmxlc3Mtc3RhY2svbmV4dGpzLWxhbWJkYVwiO1xuXG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcbmltcG9ydCB7IFN0YWNrIH0gZnJvbSBcIi4vU3RhY2tcIjtcbmltcG9ydCB7IENvbnN0cnVjdCwgSVNzdENvbnN0cnVjdEluZm8gfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7XG4gIEJhc2VTaXRlRG9tYWluUHJvcHMsXG4gIEJhc2VTaXRlUmVwbGFjZVByb3BzLFxuICBCYXNlU2l0ZUNka0Rpc3RyaWJ1dGlvblByb3BzLFxuICBCYXNlU2l0ZUVudmlyb25tZW50T3V0cHV0c0luZm8sXG4gIGdldEJ1aWxkQ21kRW52aXJvbm1lbnQsXG4gIGJ1aWxkRXJyb3JSZXNwb25zZXNGb3JSZWRpcmVjdFRvSW5kZXgsXG59IGZyb20gXCIuL0Jhc2VTaXRlXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucywgYXR0YWNoUGVybWlzc2lvbnNUb1JvbGUgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcbmltcG9ydCB7IGdldEhhbmRsZXJIYXNoIH0gZnJvbSBcIi4vdXRpbC9idWlsZGVyXCI7XG5pbXBvcnQgKiBhcyBjcm9zc1JlZ2lvbkhlbHBlciBmcm9tIFwiLi9uZXh0anMtc2l0ZS9jcm9zcy1yZWdpb24taGVscGVyXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTmV4dGpzU2l0ZVByb3BzIHtcbiAgcGF0aDogc3RyaW5nO1xuICBzM0J1Y2tldD86IHMzLkJ1Y2tldFByb3BzO1xuICBjdXN0b21Eb21haW4/OiBzdHJpbmcgfCBOZXh0anNTaXRlRG9tYWluUHJvcHM7XG4gIGNmQ2FjaGVQb2xpY2llcz86IE5leHRqc1NpdGVDYWNoZVBvbGljeVByb3BzO1xuICBjZkRpc3RyaWJ1dGlvbj86IE5leHRqc1NpdGVDZGtEaXN0cmlidXRpb25Qcm9wcztcbiAgZW52aXJvbm1lbnQ/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9O1xuICBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IE5leHRqc1NpdGVGdW5jdGlvblByb3BzO1xuICBkaXNhYmxlUGxhY2Vob2xkZXI/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE5leHRqc1NpdGVGdW5jdGlvblByb3BzIHtcbiAgdGltZW91dD86IG51bWJlcjtcbiAgbWVtb3J5U2l6ZT86IG51bWJlcjtcbiAgcGVybWlzc2lvbnM/OiBQZXJtaXNzaW9ucztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOZXh0anNTaXRlQ2FjaGVQb2xpY3lQcm9wcyB7XG4gIHN0YXRpY0NhY2hlUG9saWN5PzogY2xvdWRmcm9udC5JQ2FjaGVQb2xpY3k7XG4gIGltYWdlQ2FjaGVQb2xpY3k/OiBjbG91ZGZyb250LklDYWNoZVBvbGljeTtcbiAgbGFtYmRhQ2FjaGVQb2xpY3k/OiBjbG91ZGZyb250LklDYWNoZVBvbGljeTtcbn1cblxuZXhwb3J0IHR5cGUgTmV4dGpzU2l0ZURvbWFpblByb3BzID0gQmFzZVNpdGVEb21haW5Qcm9wcztcbmV4cG9ydCB0eXBlIE5leHRqc1NpdGVDZGtEaXN0cmlidXRpb25Qcm9wcyA9IEJhc2VTaXRlQ2RrRGlzdHJpYnV0aW9uUHJvcHM7XG5cbmV4cG9ydCBjbGFzcyBOZXh0anNTaXRlIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgcHVibGljIHN0YXRpYyBzdGF0aWNDYWNoZVBvbGljeVByb3BzOiBjbG91ZGZyb250LkNhY2hlUG9saWN5UHJvcHMgPSB7XG4gICAgcXVlcnlTdHJpbmdCZWhhdmlvcjogY2xvdWRmcm9udC5DYWNoZVF1ZXJ5U3RyaW5nQmVoYXZpb3Iubm9uZSgpLFxuICAgIGhlYWRlckJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlSGVhZGVyQmVoYXZpb3Iubm9uZSgpLFxuICAgIGNvb2tpZUJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlQ29va2llQmVoYXZpb3Iubm9uZSgpLFxuICAgIGRlZmF1bHRUdGw6IGNkay5EdXJhdGlvbi5kYXlzKDMwKSxcbiAgICBtYXhUdGw6IGNkay5EdXJhdGlvbi5kYXlzKDMwKSxcbiAgICBtaW5UdGw6IGNkay5EdXJhdGlvbi5kYXlzKDMwKSxcbiAgICBlbmFibGVBY2NlcHRFbmNvZGluZ0Jyb3RsaTogdHJ1ZSxcbiAgICBlbmFibGVBY2NlcHRFbmNvZGluZ0d6aXA6IHRydWUsXG4gICAgY29tbWVudDogXCJTU1QgTmV4dGpzU2l0ZSBTdGF0aWMgRGVmYXVsdCBDYWNoZSBQb2xpY3lcIixcbiAgfTtcblxuICBwdWJsaWMgc3RhdGljIGltYWdlQ2FjaGVQb2xpY3lQcm9wczogY2xvdWRmcm9udC5DYWNoZVBvbGljeVByb3BzID0ge1xuICAgIHF1ZXJ5U3RyaW5nQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVRdWVyeVN0cmluZ0JlaGF2aW9yLmFsbCgpLFxuICAgIGhlYWRlckJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlSGVhZGVyQmVoYXZpb3IuYWxsb3dMaXN0KFwiQWNjZXB0XCIpLFxuICAgIGNvb2tpZUJlaGF2aW9yOiBjbG91ZGZyb250LkNhY2hlQ29va2llQmVoYXZpb3Iubm9uZSgpLFxuICAgIGRlZmF1bHRUdGw6IGNkay5EdXJhdGlvbi5kYXlzKDEpLFxuICAgIG1heFR0bDogY2RrLkR1cmF0aW9uLmRheXMoMzY1KSxcbiAgICBtaW5UdGw6IGNkay5EdXJhdGlvbi5kYXlzKDApLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nQnJvdGxpOiB0cnVlLFxuICAgIGVuYWJsZUFjY2VwdEVuY29kaW5nR3ppcDogdHJ1ZSxcbiAgICBjb21tZW50OiBcIlNTVCBOZXh0anNTaXRlIEltYWdlIERlZmF1bHQgQ2FjaGUgUG9saWN5XCIsXG4gIH07XG5cbiAgcHVibGljIHN0YXRpYyBsYW1iZGFDYWNoZVBvbGljeVByb3BzOiBjbG91ZGZyb250LkNhY2hlUG9saWN5UHJvcHMgPSB7XG4gICAgcXVlcnlTdHJpbmdCZWhhdmlvcjogY2xvdWRmcm9udC5DYWNoZVF1ZXJ5U3RyaW5nQmVoYXZpb3IuYWxsKCksXG4gICAgaGVhZGVyQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVIZWFkZXJCZWhhdmlvci5ub25lKCksXG4gICAgY29va2llQmVoYXZpb3I6IGNsb3VkZnJvbnQuQ2FjaGVDb29raWVCZWhhdmlvci5hbGwoKSxcbiAgICBkZWZhdWx0VHRsOiBjZGsuRHVyYXRpb24uc2Vjb25kcygwKSxcbiAgICBtYXhUdGw6IGNkay5EdXJhdGlvbi5kYXlzKDM2NSksXG4gICAgbWluVHRsOiBjZGsuRHVyYXRpb24uc2Vjb25kcygwKSxcbiAgICBlbmFibGVBY2NlcHRFbmNvZGluZ0Jyb3RsaTogdHJ1ZSxcbiAgICBlbmFibGVBY2NlcHRFbmNvZGluZ0d6aXA6IHRydWUsXG4gICAgY29tbWVudDogXCJTU1QgTmV4dGpzU2l0ZSBMYW1iZGEgRGVmYXVsdCBDYWNoZSBQb2xpY3lcIixcbiAgfTtcblxuICBwdWJsaWMgcmVhZG9ubHkgczNCdWNrZXQ6IHMzLkJ1Y2tldDtcbiAgcHVibGljIHJlYWRvbmx5IGNmRGlzdHJpYnV0aW9uOiBjbG91ZGZyb250LkRpc3RyaWJ1dGlvbjtcbiAgcHVibGljIHJlYWRvbmx5IGhvc3RlZFpvbmU/OiByb3V0ZTUzLklIb3N0ZWRab25lO1xuICBwdWJsaWMgcmVhZG9ubHkgYWNtQ2VydGlmaWNhdGU/OiBhY20uSUNlcnRpZmljYXRlO1xuICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBOZXh0anNTaXRlUHJvcHM7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVwbG95SWQ6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSBpc1BsYWNlaG9sZGVyOiBib29sZWFuO1xuICBwcml2YXRlIHJlYWRvbmx5IGJ1aWxkT3V0RGlyOiBzdHJpbmcgfCBudWxsO1xuICBwcml2YXRlIHJlYWRvbmx5IGFzc2V0czogczNBc3NldHMuQXNzZXRbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBhd3NDbGlMYXllcjogQXdzQ2xpTGF5ZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgcm91dGVzTWFuaWZlc3Q6IFJvdXRlc01hbmlmZXN0IHwgbnVsbDtcbiAgcHJpdmF0ZSByZWFkb25seSBlZGdlTGFtYmRhUm9sZTogaWFtLlJvbGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgbWFpbkZ1bmN0aW9uVmVyc2lvbjogbGFtYmRhLklWZXJzaW9uO1xuICBwcml2YXRlIHJlYWRvbmx5IGFwaUZ1bmN0aW9uVmVyc2lvbjogbGFtYmRhLklWZXJzaW9uO1xuICBwcml2YXRlIHJlYWRvbmx5IGltYWdlRnVuY3Rpb25WZXJzaW9uOiBsYW1iZGEuSVZlcnNpb247XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVnZW5lcmF0aW9uUXVldWU6IHNxcy5RdWV1ZTtcbiAgcHJpdmF0ZSByZWFkb25seSByZWdlbmVyYXRpb25GdW5jdGlvbjogbGFtYmRhLkZ1bmN0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogTmV4dGpzU2l0ZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIC8vIExvY2FsIGRldmVsb3BtZW50IG9yIHNraXAgYnVpbGQgPT4gc3R1YiBhc3NldFxuICAgIHRoaXMuaXNQbGFjZWhvbGRlciA9XG4gICAgICAocm9vdC5sb2NhbCB8fCByb290LnNraXBCdWlsZCkgJiYgIXByb3BzLmRpc2FibGVQbGFjZWhvbGRlcjtcbiAgICBjb25zdCBidWlsZERpciA9IHJvb3QuYnVpbGREaXI7XG4gICAgY29uc3QgZmlsZVNpemVMaW1pdCA9IHJvb3QuaXNKZXN0VGVzdCgpXG4gICAgICA/IC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcbiAgICAgICAgLy8gQHRzLWlnbm9yZTogXCJqZXN0RmlsZVNpemVMaW1pdE92ZXJyaWRlXCIgbm90IGV4cG9zZWQgaW4gcHJvcHNcbiAgICAgICAgcHJvcHMuamVzdEZpbGVTaXplTGltaXRPdmVycmlkZSB8fCAyMDBcbiAgICAgIDogMjAwO1xuXG4gICAgdGhpcy5wcm9wcyA9IHByb3BzO1xuICAgIHRoaXMuYXdzQ2xpTGF5ZXIgPSBuZXcgQXdzQ2xpTGF5ZXIodGhpcywgXCJBd3NDbGlMYXllclwiKTtcbiAgICB0aGlzLnJlZ2lzdGVyU2l0ZUVudmlyb25tZW50KCk7XG5cbiAgICAvLyBCdWlsZCBhcHBcbiAgICBpZiAodGhpcy5pc1BsYWNlaG9sZGVyKSB7XG4gICAgICB0aGlzLmJ1aWxkT3V0RGlyID0gbnVsbDtcbiAgICAgIHRoaXMuYXNzZXRzID0gdGhpcy56aXBBcHBTdHViQXNzZXRzKCk7XG4gICAgICB0aGlzLmRlcGxveUlkID0gYGRlcGxveS1saXZlYDtcbiAgICAgIHRoaXMucm91dGVzTWFuaWZlc3QgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmJ1aWxkT3V0RGlyID0gcm9vdC5pc0plc3RUZXN0KClcbiAgICAgICAgPyAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50XG4gICAgICAgICAgLy8gQHRzLWlnbm9yZTogXCJqZXN0QnVpbGRPdXRwdXRQYXRoXCIgbm90IGV4cG9zZWQgaW4gcHJvcHNcbiAgICAgICAgICBwcm9wcy5qZXN0QnVpbGRPdXRwdXRQYXRoIHx8IHRoaXMuYnVpbGRBcHAoKVxuICAgICAgICA6IHRoaXMuYnVpbGRBcHAoKTtcbiAgICAgIGNvbnN0IGJ1aWxkSWRGaWxlID0gcGF0aC5yZXNvbHZlKHRoaXMuYnVpbGRPdXREaXIhLCBcImFzc2V0c1wiLCBcIkJVSUxEX0lEXCIpO1xuICAgICAgY29uc3QgYnVpbGRJZCA9IGZzLnJlYWRGaWxlU3luYyhidWlsZElkRmlsZSkudG9TdHJpbmcoKTtcbiAgICAgIHRoaXMuYXNzZXRzID0gdGhpcy56aXBBcHBBc3NldHMoZmlsZVNpemVMaW1pdCwgYnVpbGREaXIpO1xuICAgICAgdGhpcy5kZXBsb3lJZCA9IGBkZXBsb3ktJHtidWlsZElkfWA7XG4gICAgICB0aGlzLnJvdXRlc01hbmlmZXN0ID0gdGhpcy5yZWFkUm91dGVzTWFuaWZlc3QoKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgQnVja2V0XG4gICAgdGhpcy5zM0J1Y2tldCA9IHRoaXMuY3JlYXRlUzNCdWNrZXQoKTtcblxuICAgIC8vIEhhbmRsZSBJbmNyZW1lbnRhbCBTdGF0aWMgUmVnZW5lcmF0aW9uXG4gICAgdGhpcy5yZWdlbmVyYXRpb25RdWV1ZSA9IHRoaXMuY3JlYXRlUmVnZW5lcmF0aW9uUXVldWUoKTtcbiAgICB0aGlzLnJlZ2VuZXJhdGlvbkZ1bmN0aW9uID0gdGhpcy5jcmVhdGVSZWdlbmVyYXRpb25GdW5jdGlvbigpO1xuXG4gICAgLy8gQ3JlYXRlIExhbWJkYUBFZGdlIGZ1bmN0aW9ucyAoYWx3YXlzIGNyZWF0ZWQgaW4gdXMtZWFzdC0xKVxuICAgIHRoaXMuZWRnZUxhbWJkYVJvbGUgPSB0aGlzLmNyZWF0ZUVkZ2VGdW5jdGlvblJvbGUoKTtcbiAgICB0aGlzLm1haW5GdW5jdGlvblZlcnNpb24gPSB0aGlzLmNyZWF0ZUVkZ2VGdW5jdGlvbihcbiAgICAgIFwiTWFpblwiLFxuICAgICAgXCJkZWZhdWx0LWxhbWJkYVwiXG4gICAgKTtcbiAgICB0aGlzLmFwaUZ1bmN0aW9uVmVyc2lvbiA9IHRoaXMuY3JlYXRlRWRnZUZ1bmN0aW9uKFwiQXBpXCIsIFwiYXBpLWxhbWJkYVwiKTtcbiAgICB0aGlzLmltYWdlRnVuY3Rpb25WZXJzaW9uID0gdGhpcy5jcmVhdGVFZGdlRnVuY3Rpb24oXG4gICAgICBcIkltYWdlXCIsXG4gICAgICBcImltYWdlLWxhbWJkYVwiXG4gICAgKTtcblxuICAgIC8vIENyZWF0ZSBDdXN0b20gRG9tYWluXG4gICAgdGhpcy52YWxpZGF0ZUN1c3RvbURvbWFpblNldHRpbmdzKCk7XG4gICAgdGhpcy5ob3N0ZWRab25lID0gdGhpcy5sb29rdXBIb3N0ZWRab25lKCk7XG4gICAgdGhpcy5hY21DZXJ0aWZpY2F0ZSA9IHRoaXMuY3JlYXRlQ2VydGlmaWNhdGUoKTtcblxuICAgIC8vIENyZWF0ZSBTMyBEZXBsb3ltZW50XG4gICAgY29uc3QgczNkZXBsb3lDUiA9IHRoaXMuY3JlYXRlUzNEZXBsb3ltZW50KCk7XG5cbiAgICAvLyBDcmVhdGUgQ2xvdWRGcm9udFxuICAgIHRoaXMuY2ZEaXN0cmlidXRpb24gPSB0aGlzLmNyZWF0ZUNsb3VkRnJvbnREaXN0cmlidXRpb24oKTtcbiAgICB0aGlzLmNmRGlzdHJpYnV0aW9uLm5vZGUuYWRkRGVwZW5kZW5jeShzM2RlcGxveUNSKTtcblxuICAgIC8vIEludmFsaWRhdGUgQ2xvdWRGcm9udFxuICAgIGNvbnN0IGludmFsaWRhdGlvbkNSID0gdGhpcy5jcmVhdGVDbG91ZEZyb250SW52YWxpZGF0aW9uKCk7XG4gICAgaW52YWxpZGF0aW9uQ1Iubm9kZS5hZGREZXBlbmRlbmN5KHRoaXMuY2ZEaXN0cmlidXRpb24pO1xuXG4gICAgLy8gQ29ubmVjdCBDdXN0b20gRG9tYWluIHRvIENsb3VkRnJvbnQgRGlzdHJpYnV0aW9uXG4gICAgdGhpcy5jcmVhdGVSb3V0ZTUzUmVjb3JkcygpO1xuICB9XG5cbiAgcHVibGljIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYGh0dHBzOi8vJHt0aGlzLmNmRGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbkRvbWFpbk5hbWV9YDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY3VzdG9tRG9tYWluVXJsKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIGBodHRwczovLyR7Y3VzdG9tRG9tYWlufWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBgaHR0cHM6Ly8ke2N1c3RvbURvbWFpbi5kb21haW5OYW1lfWA7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCBidWNrZXRBcm4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zM0J1Y2tldC5idWNrZXRBcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0IGJ1Y2tldE5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zM0J1Y2tldC5idWNrZXROYW1lO1xuICB9XG5cbiAgcHVibGljIGdldCBkaXN0cmlidXRpb25JZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNmRGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbklkO1xuICB9XG5cbiAgcHVibGljIGdldCBkaXN0cmlidXRpb25Eb21haW4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZkRpc3RyaWJ1dGlvbi5kaXN0cmlidXRpb25Eb21haW5OYW1lO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIGF0dGFjaFBlcm1pc3Npb25zVG9Sb2xlKHRoaXMuZWRnZUxhbWJkYVJvbGUsIHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RJbmZvKCk6IElTc3RDb25zdHJ1Y3RJbmZvIHtcbiAgICBjb25zdCBjZm4gPSB0aGlzLmNmRGlzdHJpYnV0aW9uLm5vZGVcbiAgICAgIC5kZWZhdWx0Q2hpbGQgYXMgY2xvdWRmcm9udC5DZm5EaXN0cmlidXRpb247XG4gICAgcmV0dXJuIHtcbiAgICAgIGRpc3RyaWJ1dGlvbkxvZ2ljYWxJZDogU3RhY2sub2YodGhpcykuZ2V0TG9naWNhbElkKGNmbiksXG4gICAgICBjdXN0b21Eb21haW5Vcmw6IHRoaXMuY3VzdG9tRG9tYWluVXJsLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHppcEFwcEFzc2V0cyhcbiAgICBmaWxlU2l6ZUxpbWl0OiBudW1iZXIsXG4gICAgYnVpbGREaXI6IHN0cmluZ1xuICApOiBzM0Fzc2V0cy5Bc3NldFtdIHtcbiAgICAvLyB2YWxpZGF0ZSBidWlsZE91dHB1dCBleGlzdHNcbiAgICBjb25zdCBzaXRlT3V0cHV0UGF0aCA9IHBhdGgucmVzb2x2ZShwYXRoLmpvaW4odGhpcy5idWlsZE91dERpciEsIFwiYXNzZXRzXCIpKTtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc2l0ZU91dHB1dFBhdGgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBObyBidWlsZCBvdXRwdXQgZm91bmQgYXQgXCIke3NpdGVPdXRwdXRQYXRofVwiIGZvciB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBOZXh0anNTaXRlLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gY3JlYXRlIHppcCBmaWxlc1xuICAgIGNvbnN0IHNjcmlwdCA9IHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL0Jhc2VTaXRlL2FyY2hpdmVyLmpzXCIpO1xuICAgIGNvbnN0IHppcFBhdGggPSBwYXRoLnJlc29sdmUoXG4gICAgICBwYXRoLmpvaW4oYnVpbGREaXIsIGBOZXh0anNTaXRlLSR7dGhpcy5ub2RlLmlkfS0ke3RoaXMubm9kZS5hZGRyfWApXG4gICAgKTtcbiAgICAvLyBjbGVhciB6aXAgcGF0aCB0byBlbnN1cmUgbm8gcGFydFguemlwIHJlbWFpbiBmcm9tIHByZXZpb3VzIGJ1aWxkXG4gICAgZnMucmVtb3ZlU3luYyh6aXBQYXRoKTtcbiAgICBjb25zdCBjbWQgPSBbXCJub2RlXCIsIHNjcmlwdCwgc2l0ZU91dHB1dFBhdGgsIHppcFBhdGgsIGZpbGVTaXplTGltaXRdLmpvaW4oXG4gICAgICBcIiBcIlxuICAgICk7XG5cbiAgICB0cnkge1xuICAgICAgZXhlY1N5bmMoY21kLCB7XG4gICAgICAgIHN0ZGlvOiBcImluaGVyaXRcIixcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRoZXJlIHdhcyBhIHByb2JsZW0gZ2VuZXJhdGluZyB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBOZXh0anNTaXRlIHBhY2thZ2UuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBjcmVhdGUgYXNzZXRzXG4gICAgY29uc3QgYXNzZXRzID0gW107XG4gICAgZm9yIChsZXQgcGFydElkID0gMDsgOyBwYXJ0SWQrKykge1xuICAgICAgY29uc3QgemlwRmlsZVBhdGggPSBwYXRoLmpvaW4oemlwUGF0aCwgYHBhcnQke3BhcnRJZH0uemlwYCk7XG4gICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoemlwRmlsZVBhdGgpKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICBhc3NldHMucHVzaChcbiAgICAgICAgbmV3IHMzQXNzZXRzLkFzc2V0KHRoaXMsIGBBc3NldCR7cGFydElkfWAsIHtcbiAgICAgICAgICBwYXRoOiB6aXBGaWxlUGF0aCxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBhc3NldHM7XG4gIH1cblxuICBwcml2YXRlIHppcEFwcFN0dWJBc3NldHMoKTogczNBc3NldHMuQXNzZXRbXSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIG5ldyBzM0Fzc2V0cy5Bc3NldCh0aGlzLCBcIkFzc2V0XCIsIHtcbiAgICAgICAgcGF0aDogcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvTmV4dGpzU2l0ZS9zaXRlLXN0dWJcIiksXG4gICAgICB9KSxcbiAgICBdO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVFZGdlRnVuY3Rpb24oXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIGhhbmRsZXJQYXRoOiBzdHJpbmdcbiAgKTogbGFtYmRhLklWZXJzaW9uIHtcbiAgICAvLyBVc2UgcmVhbCBjb2RlIGlmOlxuICAgIC8vIC0gTmV4dC5qcyBhcHAgd2FzIGJ1aWxkOyBBTkRcbiAgICAvLyAtIHRoZSBMYW1iZGEgY29kZSBkaXJlY3RvcnkgaXMgbm90IGVtcHR5XG4gICAgY29uc3QgaGFzUmVhbENvZGUgPVxuICAgICAgdHlwZW9mIHRoaXMuYnVpbGRPdXREaXIgPT09IFwic3RyaW5nXCIgJiZcbiAgICAgIGZzLnBhdGhFeGlzdHNTeW5jKHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyLCBoYW5kbGVyUGF0aCwgXCJpbmRleC5qc1wiKSk7XG5cbiAgICAvLyBDcmVhdGUgZnVuY3Rpb24gYXNzZXRcbiAgICBjb25zdCBhc3NldFBhdGggPVxuICAgICAgaGFzUmVhbENvZGUgJiYgdGhpcy5idWlsZE91dERpclxuICAgICAgICA/IHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyLCBoYW5kbGVyUGF0aClcbiAgICAgICAgOiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9OZXh0anNTaXRlL2VkZ2UtbGFtYmRhLXN0dWJcIik7XG4gICAgY29uc3QgYXNzZXQgPSBuZXcgczNBc3NldHMuQXNzZXQodGhpcywgYCR7bmFtZX1GdW5jdGlvbkFzc2V0YCwge1xuICAgICAgcGF0aDogYXNzZXRQYXRoLFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIGZ1bmN0aW9uIGJhc2VkIG9uIHJlZ2lvblxuICAgIGNvbnN0IHJvb3QgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgcmV0dXJuIHJvb3QucmVnaW9uID09PSBcInVzLWVhc3QtMVwiXG4gICAgICA/IHRoaXMuY3JlYXRlRWRnZUZ1bmN0aW9uSW5VRTEobmFtZSwgYXNzZXRQYXRoLCBhc3NldCwgaGFzUmVhbENvZGUpXG4gICAgICA6IHRoaXMuY3JlYXRlRWRnZUZ1bmN0aW9uSW5Ob25VRTEobmFtZSwgYXNzZXRQYXRoLCBhc3NldCwgaGFzUmVhbENvZGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVFZGdlRnVuY3Rpb25JblVFMShcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgYXNzZXRQYXRoOiBzdHJpbmcsXG4gICAgYXNzZXQ6IHMzQXNzZXRzLkFzc2V0LFxuICAgIGhhc1JlYWxDb2RlOiBib29sZWFuXG4gICk6IGxhbWJkYS5JVmVyc2lvbiB7XG4gICAgY29uc3QgeyBkZWZhdWx0RnVuY3Rpb25Qcm9wczogZm5Qcm9wcyB9ID0gdGhpcy5wcm9wcztcblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvblxuICAgIGNvbnN0IGZuID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBgJHtuYW1lfUZ1bmN0aW9uYCwge1xuICAgICAgZGVzY3JpcHRpb246IGAke25hbWV9IGhhbmRsZXIgZm9yIE5leHQuanNgLFxuICAgICAgaGFuZGxlcjogXCJpbmRleC5oYW5kbGVyXCIsXG4gICAgICBjdXJyZW50VmVyc2lvbk9wdGlvbnM6IHtcbiAgICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICAgIH0sXG4gICAgICBsb2dSZXRlbnRpb246IGxvZ3MuUmV0ZW50aW9uRGF5cy5USFJFRV9EQVlTLFxuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KGFzc2V0UGF0aCksXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWCxcbiAgICAgIG1lbW9yeVNpemU6IGZuUHJvcHM/Lm1lbW9yeVNpemUgfHwgNTEyLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoZm5Qcm9wcz8udGltZW91dCB8fCAxMCksXG4gICAgICByb2xlOiB0aGlzLmVkZ2VMYW1iZGFSb2xlLFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIGFsaWFzXG4gICAgZm4uY3VycmVudFZlcnNpb24uYWRkQWxpYXMoXCJsaXZlXCIpO1xuXG4gICAgLy8gRGVwbG95IGFmdGVyIHRoZSBjb2RlIGlzIHVwZGF0ZWRcbiAgICBpZiAoaGFzUmVhbENvZGUpIHtcbiAgICAgIGNvbnN0IHVwZGF0ZXJDUiA9IHRoaXMuY3JlYXRlTGFtYmRhQ29kZVJlcGxhY2VyKG5hbWUsIGFzc2V0KTtcbiAgICAgIGZuLm5vZGUuYWRkRGVwZW5kZW5jeSh1cGRhdGVyQ1IpO1xuICAgIH1cblxuICAgIHJldHVybiBmbi5jdXJyZW50VmVyc2lvbjtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlRWRnZUZ1bmN0aW9uSW5Ob25VRTEoXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIGFzc2V0UGF0aDogc3RyaW5nLFxuICAgIGFzc2V0OiBzM0Fzc2V0cy5Bc3NldCxcbiAgICBoYXNSZWFsQ29kZTogYm9vbGVhblxuICApOiBsYW1iZGEuSVZlcnNpb24ge1xuICAgIGNvbnN0IHsgZGVmYXVsdEZ1bmN0aW9uUHJvcHM6IGZuUHJvcHMgfSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyBJZiBhcHAgcmVnaW9uIGlzIE5PVCB1cy1lYXN0LTEsIGNyZWF0ZSBhIEZ1bmN0aW9uIGluIHVzLWVhc3QtMVxuICAgIC8vIHVzaW5nIGEgQ3VzdG9tIFJlc291cmNlXG5cbiAgICAvLyBDcmVhdGUgYSBTMyBidWNrZXQgaW4gdXMtZWFzdC0xIHRvIHN0b3JlIExhbWJkYSBjb2RlLiBDcmVhdGVcbiAgICAvLyAxIGJ1Y2tldCBmb3IgYWxsIEVkZ2UgZnVuY3Rpb25zLlxuICAgIGNvbnN0IGJ1Y2tldENSID0gY3Jvc3NSZWdpb25IZWxwZXIuZ2V0T3JDcmVhdGVCdWNrZXQodGhpcyk7XG4gICAgY29uc3QgYnVja2V0TmFtZSA9IGJ1Y2tldENSLmdldEF0dFN0cmluZyhcIkJ1Y2tldE5hbWVcIik7XG5cbiAgICAvLyBDcmVhdGUgYSBMYW1iZGEgZnVuY3Rpb24gaW4gdXMtZWFzdC0xXG4gICAgY29uc3QgZnVuY3Rpb25DUiA9IGNyb3NzUmVnaW9uSGVscGVyLmNyZWF0ZUZ1bmN0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIG5hbWUsXG4gICAgICB0aGlzLmVkZ2VMYW1iZGFSb2xlLFxuICAgICAgYnVja2V0TmFtZSxcbiAgICAgIHtcbiAgICAgICAgRGVzY3JpcHRpb246IGBoYW5kbGVyIGZvciBOZXh0LmpzYCxcbiAgICAgICAgSGFuZGxlcjogXCJpbmRleC5oYW5kbGVyXCIsXG4gICAgICAgIENvZGU6IHtcbiAgICAgICAgICBTM0J1Y2tldDogYXNzZXQuczNCdWNrZXROYW1lLFxuICAgICAgICAgIFMzS2V5OiBhc3NldC5zM09iamVjdEtleSxcbiAgICAgICAgfSxcbiAgICAgICAgUnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzEyX1gubmFtZSxcbiAgICAgICAgTWVtb3J5U2l6ZTogZm5Qcm9wcz8ubWVtb3J5U2l6ZSB8fCA1MTIsXG4gICAgICAgIFRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKGZuUHJvcHM/LnRpbWVvdXQgfHwgMTApLnRvU2Vjb25kcygpLFxuICAgICAgICBSb2xlOiB0aGlzLmVkZ2VMYW1iZGFSb2xlLnJvbGVBcm4sXG4gICAgICB9XG4gICAgKTtcbiAgICBjb25zdCBmdW5jdGlvbkFybiA9IGZ1bmN0aW9uQ1IuZ2V0QXR0U3RyaW5nKFwiRnVuY3Rpb25Bcm5cIik7XG5cbiAgICAvLyBDcmVhdGUgYSBMYW1iZGEgZnVuY3Rpb24gdmVyc2lvbiBpbiB1cy1lYXN0LTFcbiAgICBjb25zdCB2ZXJzaW9uQ1IgPSBjcm9zc1JlZ2lvbkhlbHBlci5jcmVhdGVWZXJzaW9uKHRoaXMsIG5hbWUsIGZ1bmN0aW9uQXJuKTtcbiAgICBjb25zdCB2ZXJzaW9uSWQgPSB2ZXJzaW9uQ1IuZ2V0QXR0U3RyaW5nKFwiVmVyc2lvblwiKTtcbiAgICBjcm9zc1JlZ2lvbkhlbHBlci51cGRhdGVWZXJzaW9uTG9naWNhbElkKGZ1bmN0aW9uQ1IsIHZlcnNpb25DUik7XG5cbiAgICAvLyBEZXBsb3kgYWZ0ZXIgdGhlIGNvZGUgaXMgdXBkYXRlZFxuICAgIGlmIChoYXNSZWFsQ29kZSkge1xuICAgICAgY29uc3QgdXBkYXRlckNSID0gdGhpcy5jcmVhdGVMYW1iZGFDb2RlUmVwbGFjZXIobmFtZSwgYXNzZXQpO1xuICAgICAgZnVuY3Rpb25DUi5ub2RlLmFkZERlcGVuZGVuY3kodXBkYXRlckNSKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbGFtYmRhLlZlcnNpb24uZnJvbVZlcnNpb25Bcm4oXG4gICAgICB0aGlzLFxuICAgICAgYCR7bmFtZX1GdW5jdGlvblZlcnNpb25gLFxuICAgICAgYCR7ZnVuY3Rpb25Bcm59OiR7dmVyc2lvbklkfWBcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVFZGdlRnVuY3Rpb25Sb2xlKCk6IGlhbS5Sb2xlIHtcbiAgICBjb25zdCB7IGRlZmF1bHRGdW5jdGlvblByb3BzOiBmblByb3BzIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgLy8gQ3JlYXRlIGZ1bmN0aW9uIHJvbGVcbiAgICBjb25zdCByb2xlID0gbmV3IGlhbS5Sb2xlKHRoaXMsIGBFZGdlTGFtYmRhUm9sZWAsIHtcbiAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5Db21wb3NpdGVQcmluY2lwYWwoXG4gICAgICAgIG5ldyBpYW0uU2VydmljZVByaW5jaXBhbChcImxhbWJkYS5hbWF6b25hd3MuY29tXCIpLFxuICAgICAgICBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoXCJlZGdlbGFtYmRhLmFtYXpvbmF3cy5jb21cIilcbiAgICAgICksXG4gICAgICBtYW5hZ2VkUG9saWNpZXM6IFtcbiAgICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbU1hbmFnZWRQb2xpY3lBcm4oXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBcIkVkZ2VMYW1iZGFQb2xpY3lcIixcbiAgICAgICAgICBcImFybjphd3M6aWFtOjphd3M6cG9saWN5L3NlcnZpY2Utcm9sZS9BV1NMYW1iZGFCYXNpY0V4ZWN1dGlvblJvbGVcIlxuICAgICAgICApLFxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIC8vIEF0dGFjaCBwZXJtaXNzaW9uXG4gICAgdGhpcy5zM0J1Y2tldC5ncmFudFJlYWRXcml0ZShyb2xlKTtcbiAgICB0aGlzLnJlZ2VuZXJhdGlvblF1ZXVlLmdyYW50U2VuZE1lc3NhZ2VzKHJvbGUpO1xuICAgIHRoaXMucmVnZW5lcmF0aW9uRnVuY3Rpb24uZ3JhbnRJbnZva2Uocm9sZSk7XG4gICAgaWYgKGZuUHJvcHM/LnBlcm1pc3Npb25zKSB7XG4gICAgICBhdHRhY2hQZXJtaXNzaW9uc1RvUm9sZShyb2xlLCBmblByb3BzLnBlcm1pc3Npb25zKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcm9sZTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUmVnZW5lcmF0aW9uUXVldWUoKTogc3FzLlF1ZXVlIHtcbiAgICByZXR1cm4gbmV3IHNxcy5RdWV1ZSh0aGlzLCBcIlJlZ2VuZXJhdGlvblF1ZXVlXCIsIHtcbiAgICAgIC8vIFdlIGNhbGwgdGhlIHF1ZXVlIHRoZSBzYW1lIG5hbWUgYXMgdGhlIGJ1Y2tldCBzbyB0aGF0IHdlIGNhbiBlYXNpbHlcbiAgICAgIC8vIHJlZmVyZW5jZSBpdCBmcm9tIHdpdGhpbiB0aGUgbGFtYmRhQGVkZ2UsIGdpdmVuIHdlIGNhbid0IHVzZSBlbnYgdmFyc1xuICAgICAgLy8gaW4gYSBsYW1iZGFAZWRnZVxuICAgICAgcXVldWVOYW1lOiBgJHt0aGlzLnMzQnVja2V0LmJ1Y2tldE5hbWV9LmZpZm9gLFxuICAgICAgZmlmbzogdHJ1ZSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVJlZ2VuZXJhdGlvbkZ1bmN0aW9uKCk6IGxhbWJkYS5GdW5jdGlvbiB7XG4gICAgLy8gVXNlIHJlYWwgY29kZSBpZjpcbiAgICAvLyAtIE5leHQuanMgYXBwIHdhcyBidWlsZDsgQU5EXG4gICAgLy8gLSB0aGUgTGFtYmRhIGNvZGUgZGlyZWN0b3J5IGlzIG5vdCBlbXB0eVxuICAgIGxldCBjb2RlO1xuICAgIGxldCB1cGRhdGVyQ1I7XG4gICAgaWYgKFxuICAgICAgdGhpcy5idWlsZE91dERpciAmJlxuICAgICAgZnMucGF0aEV4aXN0c1N5bmMoXG4gICAgICAgIHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyLCBcInJlZ2VuZXJhdGlvbi1sYW1iZGFcIiwgXCJpbmRleC5qc1wiKVxuICAgICAgKVxuICAgICkge1xuICAgICAgY29uc3QgYXNzZXQgPSBuZXcgczNBc3NldHMuQXNzZXQodGhpcywgYFJlZ2VuZXJhdGlvbkZ1bmN0aW9uQXNzZXRgLCB7XG4gICAgICAgIHBhdGg6IHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyLCBcInJlZ2VuZXJhdGlvbi1sYW1iZGFcIiksXG4gICAgICB9KTtcbiAgICAgIGNvZGUgPSBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbih0aGlzLmJ1aWxkT3V0RGlyLCBcInJlZ2VuZXJhdGlvbi1sYW1iZGFcIilcbiAgICAgICk7XG4gICAgICB1cGRhdGVyQ1IgPSB0aGlzLmNyZWF0ZUxhbWJkYUNvZGVSZXBsYWNlcihcIlJlZ2VuZXJhdGlvblwiLCBhc3NldCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvZGUgPSBsYW1iZGEuQ29kZS5mcm9tSW5saW5lKFwiIFwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBmbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJSZWdlbmVyYXRpb25GdW5jdGlvblwiLCB7XG4gICAgICBoYW5kbGVyOiBcImluZGV4LmhhbmRsZXJcIixcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xMl9YLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoMzApLFxuICAgICAgY29kZSxcbiAgICB9KTtcblxuICAgIGZuLmFkZEV2ZW50U291cmNlKFxuICAgICAgbmV3IGxhbWJkYUV2ZW50U291cmNlcy5TcXNFdmVudFNvdXJjZSh0aGlzLnJlZ2VuZXJhdGlvblF1ZXVlKVxuICAgICk7XG5cbiAgICAvLyBHcmFudCBwZXJtaXNzaW9uc1xuICAgIHRoaXMuczNCdWNrZXQuZ3JhbnRSZWFkV3JpdGUoZm4pO1xuXG4gICAgLy8gRGVwbG95IGFmdGVyIHRoZSBjb2RlIGlzIHVwZGF0ZWRcbiAgICBpZiAodXBkYXRlckNSKSB7XG4gICAgICBmbi5ub2RlLmFkZERlcGVuZGVuY3kodXBkYXRlckNSKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZm47XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUxhbWJkYUNvZGVSZXBsYWNlcihcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgYXNzZXQ6IHMzQXNzZXRzLkFzc2V0XG4gICk6IGNkay5DdXN0b21SZXNvdXJjZSB7XG4gICAgLy8gTm90ZTogU291cmNlIGNvZGUgZm9yIHRoZSBMYW1iZGEgZnVuY3Rpb25zIGhhdmUgXCJ7eyBFTlZfS0VZIH19XCIgaW4gdGhlbS5cbiAgICAvLyAgICAgICBUaGV5IG5lZWQgdG8gYmUgcmVwbGFjZWQgd2l0aCByZWFsIHZhbHVlcyBiZWZvcmUgdGhlIExhbWJkYVxuICAgIC8vICAgICAgIGZ1bmN0aW9ucyBnZXQgZGVwbG95ZWQuXG5cbiAgICBjb25zdCBwcm92aWRlcklkID0gXCJMYW1iZGFDb2RlUmVwbGFjZXJQcm92aWRlclwiO1xuICAgIGNvbnN0IHJlc0lkID0gYCR7bmFtZX1MYW1iZGFDb2RlUmVwbGFjZXJgO1xuICAgIGNvbnN0IHN0YWNrID0gY2RrLlN0YWNrLm9mKHRoaXMpO1xuICAgIGxldCBwcm92aWRlciA9IHN0YWNrLm5vZGUudHJ5RmluZENoaWxkKHByb3ZpZGVySWQpIGFzIGxhbWJkYS5GdW5jdGlvbjtcblxuICAgIC8vIENyZWF0ZSBwcm92aWRlciBpZiBub3QgYWxyZWFkeSBjcmVhdGVkXG4gICAgaWYgKCFwcm92aWRlcikge1xuICAgICAgcHJvdmlkZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCBwcm92aWRlcklkLCB7XG4gICAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChcbiAgICAgICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9OZXh0anNTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgICApLFxuICAgICAgICBsYXllcnM6IFt0aGlzLmF3c0NsaUxheWVyXSxcbiAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgICAgaGFuZGxlcjogXCJsYW1iZGEtY29kZS11cGRhdGVyLmhhbmRsZXJcIixcbiAgICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQWxsb3cgcHJvdmlkZXIgdG8gcGVyZm9ybSBzZWFyY2gvcmVwbGFjZSBvbiB0aGUgYXNzZXRcbiAgICBwcm92aWRlci5yb2xlPy5hZGRUb1BvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICBhY3Rpb25zOiBbXCJzMzoqXCJdLFxuICAgICAgICByZXNvdXJjZXM6IFtgYXJuOmF3czpzMzo6OiR7YXNzZXQuczNCdWNrZXROYW1lfS8ke2Fzc2V0LnMzT2JqZWN0S2V5fWBdLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgLy8gQ3JlYXRlIGN1c3RvbSByZXNvdXJjZVxuICAgIGNvbnN0IHJlc291cmNlID0gbmV3IGNkay5DdXN0b21SZXNvdXJjZSh0aGlzLCByZXNJZCwge1xuICAgICAgc2VydmljZVRva2VuOiBwcm92aWRlci5mdW5jdGlvbkFybixcbiAgICAgIHJlc291cmNlVHlwZTogXCJDdXN0b206OlNTVExhbWJkYUNvZGVVcGRhdGVyXCIsXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIFNvdXJjZToge1xuICAgICAgICAgIEJ1Y2tldE5hbWU6IGFzc2V0LnMzQnVja2V0TmFtZSxcbiAgICAgICAgICBPYmplY3RLZXk6IGFzc2V0LnMzT2JqZWN0S2V5LFxuICAgICAgICB9LFxuICAgICAgICBSZXBsYWNlVmFsdWVzOiB0aGlzLmdldExhbWJkYUNvbnRlbnRSZXBsYWNlVmFsdWVzKCksXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJlc291cmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZEFwcCgpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgcGF0aDogc2l0ZVBhdGggfSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyB2YWxpZGF0ZSBzaXRlIHBhdGggZXhpc3RzXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKHNpdGVQYXRoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgTm8gcGF0aCBmb3VuZCBhdCBcIiR7cGF0aC5yZXNvbHZlKHNpdGVQYXRoKX1cIiBmb3IgdGhlIFwiJHtcbiAgICAgICAgICB0aGlzLm5vZGUuaWRcbiAgICAgICAgfVwiIE5leHRqc1NpdGUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBCdWlsZCBjb21tYW5kXG4gICAgLy8gTm90ZTogcHJvYmFibHkgY291bGQgcGFzcyBKU09OIHN0cmluZyBhbHNvLCBidXQgdGhpcyBmZWx0IHNhZmVyLlxuICAgIGNvbnN0IHJvb3QgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3QgcGF0aEhhc2ggPSBnZXRIYW5kbGVySGFzaChzaXRlUGF0aCk7XG4gICAgY29uc3QgYnVpbGRPdXRwdXQgPSBwYXRoLmpvaW4ocm9vdC5idWlsZERpciwgcGF0aEhhc2gpO1xuICAgIGNvbnN0IGNvbmZpZ0J1ZmZlciA9IEJ1ZmZlci5mcm9tKFxuICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBjd2Q6IHBhdGgucmVzb2x2ZShzaXRlUGF0aCksXG4gICAgICAgIGFyZ3M6IFtcImJ1aWxkXCJdLFxuICAgICAgfSlcbiAgICApO1xuICAgIGNvbnN0IGNtZCA9IFtcbiAgICAgIFwibm9kZVwiLFxuICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvTmV4dGpzU2l0ZS9idWlsZC5qc1wiKSxcbiAgICAgIFwiLS1wYXRoXCIsXG4gICAgICBwYXRoLnJlc29sdmUoc2l0ZVBhdGgpLFxuICAgICAgXCItLW91dHB1dFwiLFxuICAgICAgcGF0aC5yZXNvbHZlKGJ1aWxkT3V0cHV0KSxcbiAgICAgIFwiLS1jb25maWdcIixcbiAgICAgIGNvbmZpZ0J1ZmZlci50b1N0cmluZyhcImJhc2U2NFwiKSxcbiAgICBdLmpvaW4oXCIgXCIpO1xuXG4gICAgLy8gUnVuIGJ1aWxkXG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZXkoYEJ1aWxkaW5nIE5leHQuanMgc2l0ZSAke3NpdGVQYXRofWApKTtcbiAgICAgIGV4ZWNTeW5jKGNtZCwge1xuICAgICAgICBjd2Q6IHNpdGVQYXRoLFxuICAgICAgICBzdGRpbzogXCJpbmhlcml0XCIsXG4gICAgICAgIGVudjoge1xuICAgICAgICAgIC4uLnByb2Nlc3MuZW52LFxuICAgICAgICAgIC4uLmdldEJ1aWxkQ21kRW52aXJvbm1lbnQodGhpcy5wcm9wcy5lbnZpcm9ubWVudCksXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGVyZSB3YXMgYSBwcm9ibGVtIGJ1aWxkaW5nIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIE5leHRqc1NpdGUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYnVpbGRPdXRwdXQ7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVMzQnVja2V0KCk6IHMzLkJ1Y2tldCB7XG4gICAgbGV0IHsgczNCdWNrZXQgfSA9IHRoaXMucHJvcHM7XG4gICAgczNCdWNrZXQgPSBzM0J1Y2tldCB8fCB7fTtcblxuICAgIHJldHVybiBuZXcgczMuQnVja2V0KHRoaXMsIFwiQnVja2V0XCIsIHtcbiAgICAgIHB1YmxpY1JlYWRBY2Nlc3M6IHRydWUsXG4gICAgICBhdXRvRGVsZXRlT2JqZWN0czogdHJ1ZSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICAuLi5zM0J1Y2tldCxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUzNEZXBsb3ltZW50KCk6IGNkay5DdXN0b21SZXNvdXJjZSB7XG4gICAgLy8gQ3JlYXRlIGEgTGFtYmRhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBkb2luZyB0aGUgdXBsb2FkaW5nXG4gICAgY29uc3QgdXBsb2FkZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiUzNVcGxvYWRlclwiLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL0Jhc2VTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgKSxcbiAgICAgIGxheWVyczogW3RoaXMuYXdzQ2xpTGF5ZXJdLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgIGhhbmRsZXI6IFwiczMtdXBsb2FkLmhhbmRsZXJcIixcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgfSk7XG4gICAgdGhpcy5zM0J1Y2tldC5ncmFudFJlYWRXcml0ZSh1cGxvYWRlcik7XG4gICAgdGhpcy5hc3NldHMuZm9yRWFjaCgoYXNzZXQpID0+IGFzc2V0LmdyYW50UmVhZCh1cGxvYWRlcikpO1xuXG4gICAgLy8gQ3JlYXRlIHRoZSBjdXN0b20gcmVzb3VyY2UgZnVuY3Rpb25cbiAgICBjb25zdCBoYW5kbGVyID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcIlMzSGFuZGxlclwiLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL0Jhc2VTaXRlL2N1c3RvbS1yZXNvdXJjZVwiKVxuICAgICAgKSxcbiAgICAgIGxheWVyczogW3RoaXMuYXdzQ2xpTGF5ZXJdLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfNyxcbiAgICAgIGhhbmRsZXI6IFwiczMtaGFuZGxlci5oYW5kbGVyXCIsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgVVBMT0FERVJfRlVOQ1RJT05fTkFNRTogdXBsb2FkZXIuZnVuY3Rpb25OYW1lLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICB0aGlzLnMzQnVja2V0LmdyYW50UmVhZFdyaXRlKGhhbmRsZXIpO1xuICAgIHVwbG9hZGVyLmdyYW50SW52b2tlKGhhbmRsZXIpO1xuXG4gICAgLy8gQ3JlYXRlIGN1c3RvbSByZXNvdXJjZVxuICAgIGNvbnN0IGZpbGVPcHRpb25zID0gW1xuICAgICAge1xuICAgICAgICBleGNsdWRlOiBcIipcIixcbiAgICAgICAgaW5jbHVkZTogXCJwdWJsaWMvKlwiLFxuICAgICAgICBjYWNoZUNvbnRyb2w6IFwicHVibGljLG1heC1hZ2U9MzE1MzYwMDAsbXVzdC1yZXZhbGlkYXRlXCIsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBleGNsdWRlOiBcIipcIixcbiAgICAgICAgaW5jbHVkZTogXCJzdGF0aWMvKlwiLFxuICAgICAgICBjYWNoZUNvbnRyb2w6IFwicHVibGljLG1heC1hZ2U9MzE1MzYwMDAsbXVzdC1yZXZhbGlkYXRlXCIsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBleGNsdWRlOiBcIipcIixcbiAgICAgICAgaW5jbHVkZTogXCJzdGF0aWMtcGFnZXMvKlwiLFxuICAgICAgICBjYWNoZUNvbnRyb2w6IFwicHVibGljLG1heC1hZ2U9MCxzLW1heGFnZT0yNjc4NDAwLG11c3QtcmV2YWxpZGF0ZVwiLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgZXhjbHVkZTogXCIqXCIsXG4gICAgICAgIGluY2x1ZGU6IFwiX25leHQvZGF0YS8qXCIsXG4gICAgICAgIGNhY2hlQ29udHJvbDogXCJwdWJsaWMsbWF4LWFnZT0wLHMtbWF4YWdlPTI2Nzg0MDAsbXVzdC1yZXZhbGlkYXRlXCIsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBleGNsdWRlOiBcIipcIixcbiAgICAgICAgaW5jbHVkZTogXCJfbmV4dC9zdGF0aWMvKlwiLFxuICAgICAgICBjYWNoZUNvbnRyb2w6IFwicHVibGljLG1heC1hZ2U9MzE1MzYwMDAsaW1tdXRhYmxlXCIsXG4gICAgICB9LFxuICAgIF07XG4gICAgcmV0dXJuIG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2UodGhpcywgXCJTM0RlcGxveW1lbnRcIiwge1xuICAgICAgc2VydmljZVRva2VuOiBoYW5kbGVyLmZ1bmN0aW9uQXJuLFxuICAgICAgcmVzb3VyY2VUeXBlOiBcIkN1c3RvbTo6U1NUQnVja2V0RGVwbG95bWVudFwiLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBTb3VyY2VzOiB0aGlzLmFzc2V0cy5tYXAoKGFzc2V0KSA9PiAoe1xuICAgICAgICAgIEJ1Y2tldE5hbWU6IGFzc2V0LnMzQnVja2V0TmFtZSxcbiAgICAgICAgICBPYmplY3RLZXk6IGFzc2V0LnMzT2JqZWN0S2V5LFxuICAgICAgICB9KSksXG4gICAgICAgIERlc3RpbmF0aW9uQnVja2V0TmFtZTogdGhpcy5zM0J1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICBEZXN0aW5hdGlvbkJ1Y2tldEtleVByZWZpeDogdGhpcy5kZXBsb3lJZCxcbiAgICAgICAgRmlsZU9wdGlvbnM6IChmaWxlT3B0aW9ucyB8fCBbXSkubWFwKFxuICAgICAgICAgICh7IGV4Y2x1ZGUsIGluY2x1ZGUsIGNhY2hlQ29udHJvbCB9KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICBcIi0tZXhjbHVkZVwiLFxuICAgICAgICAgICAgICBleGNsdWRlLFxuICAgICAgICAgICAgICBcIi0taW5jbHVkZVwiLFxuICAgICAgICAgICAgICBpbmNsdWRlLFxuICAgICAgICAgICAgICBcIi0tY2FjaGUtY29udHJvbFwiLFxuICAgICAgICAgICAgICBjYWNoZUNvbnRyb2wsXG4gICAgICAgICAgICBdO1xuICAgICAgICAgIH1cbiAgICAgICAgKSxcbiAgICAgICAgUmVwbGFjZVZhbHVlczogdGhpcy5nZXRTM0NvbnRlbnRSZXBsYWNlVmFsdWVzKCksXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIENsb3VkRnJvbnQgRGlzdHJpYnV0aW9uXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIHByaXZhdGUgY3JlYXRlQ2xvdWRGcm9udERpc3RyaWJ1dGlvbigpOiBjbG91ZGZyb250LkRpc3RyaWJ1dGlvbiB7XG4gICAgY29uc3QgeyBjZkNhY2hlUG9saWNpZXMsIGNmRGlzdHJpYnV0aW9uLCBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgY2ZEaXN0cmlidXRpb25Qcm9wcyA9IGNmRGlzdHJpYnV0aW9uIHx8IHt9O1xuXG4gICAgLy8gVmFsaWRhdGUgaW5wdXRcbiAgICBpZiAoY2ZEaXN0cmlidXRpb25Qcm9wcy5jZXJ0aWZpY2F0ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRG8gbm90IGNvbmZpZ3VyZSB0aGUgXCJjZkRpc3RyaWJ1dGlvbi5jZXJ0aWZpY2F0ZVwiLiBVc2UgdGhlIFwiY3VzdG9tRG9tYWluXCIgdG8gY29uZmlndXJlIHRoZSBOZXh0anNTaXRlIGRvbWFpbiBjZXJ0aWZpY2F0ZS5gXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoY2ZEaXN0cmlidXRpb25Qcm9wcy5kb21haW5OYW1lcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRG8gbm90IGNvbmZpZ3VyZSB0aGUgXCJjZkRpc3RyaWJ1dGlvbi5kb21haW5OYW1lc1wiLiBVc2UgdGhlIFwiY3VzdG9tRG9tYWluXCIgdG8gY29uZmlndXJlIHRoZSBOZXh0anNTaXRlIGRvbWFpbi5gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIEJ1aWxkIGRvbWFpbk5hbWVzXG4gICAgY29uc3QgZG9tYWluTmFtZXMgPSBbXTtcbiAgICBpZiAoIWN1c3RvbURvbWFpbikge1xuICAgICAgLy8gbm8gZG9tYWluXG4gICAgfSBlbHNlIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBkb21haW5OYW1lcy5wdXNoKGN1c3RvbURvbWFpbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRvbWFpbk5hbWVzLnB1c2goY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUpO1xuICAgIH1cblxuICAgIC8vIEJ1aWxkIGJlaGF2aW9yXG4gICAgY29uc3Qgb3JpZ2luID0gbmV3IG9yaWdpbnMuUzNPcmlnaW4odGhpcy5zM0J1Y2tldCwge1xuICAgICAgb3JpZ2luUGF0aDogdGhpcy5kZXBsb3lJZCxcbiAgICB9KTtcbiAgICBjb25zdCB2aWV3ZXJQcm90b2NvbFBvbGljeSA9XG4gICAgICBjbG91ZGZyb250LlZpZXdlclByb3RvY29sUG9saWN5LlJFRElSRUNUX1RPX0hUVFBTO1xuXG4gICAgaWYgKHRoaXMuaXNQbGFjZWhvbGRlcikge1xuICAgICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkRpc3RyaWJ1dGlvbih0aGlzLCBcIkRpc3RyaWJ1dGlvblwiLCB7XG4gICAgICAgIGRlZmF1bHRSb290T2JqZWN0OiBcImluZGV4Lmh0bWxcIixcbiAgICAgICAgZXJyb3JSZXNwb25zZXM6IGJ1aWxkRXJyb3JSZXNwb25zZXNGb3JSZWRpcmVjdFRvSW5kZXgoXCJpbmRleC5odG1sXCIpLFxuICAgICAgICBkb21haW5OYW1lcyxcbiAgICAgICAgY2VydGlmaWNhdGU6IHRoaXMuYWNtQ2VydGlmaWNhdGUsXG4gICAgICAgIGRlZmF1bHRCZWhhdmlvcjoge1xuICAgICAgICAgIG9yaWdpbixcbiAgICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEJ1aWxkIEVkZ2UgZnVuY3Rpb25zXG4gICAgY29uc3QgZWRnZUxhbWJkYXM6IGNsb3VkZnJvbnQuRWRnZUxhbWJkYVtdID0gW1xuICAgICAge1xuICAgICAgICBpbmNsdWRlQm9keTogdHJ1ZSxcbiAgICAgICAgZXZlbnRUeXBlOiBjbG91ZGZyb250LkxhbWJkYUVkZ2VFdmVudFR5cGUuT1JJR0lOX1JFUVVFU1QsXG4gICAgICAgIGZ1bmN0aW9uVmVyc2lvbjogdGhpcy5tYWluRnVuY3Rpb25WZXJzaW9uLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgZXZlbnRUeXBlOiBjbG91ZGZyb250LkxhbWJkYUVkZ2VFdmVudFR5cGUuT1JJR0lOX1JFU1BPTlNFLFxuICAgICAgICBmdW5jdGlvblZlcnNpb246IHRoaXMubWFpbkZ1bmN0aW9uVmVyc2lvbixcbiAgICAgIH0sXG4gICAgXTtcblxuICAgIC8vIEJ1aWxkIGNhY2hlIHBvbGljeVxuICAgIGNvbnN0IHN0YXRpY0NhY2hlUG9saWN5ID1cbiAgICAgIGNmQ2FjaGVQb2xpY2llcz8uc3RhdGljQ2FjaGVQb2xpY3kgPz9cbiAgICAgIHRoaXMuY3JlYXRlQ2xvdWRGcm9udFN0YXRpY0NhY2hlUG9saWN5KCk7XG4gICAgY29uc3QgaW1hZ2VDYWNoZVBvbGljeSA9XG4gICAgICBjZkNhY2hlUG9saWNpZXM/LmltYWdlQ2FjaGVQb2xpY3kgPz9cbiAgICAgIHRoaXMuY3JlYXRlQ2xvdWRGcm9udEltYWdlQ2FjaGVQb2xpY3koKTtcbiAgICBjb25zdCBsYW1iZGFDYWNoZVBvbGljeSA9XG4gICAgICBjZkNhY2hlUG9saWNpZXM/LmxhbWJkYUNhY2hlUG9saWN5ID8/XG4gICAgICB0aGlzLmNyZWF0ZUNsb3VkRnJvbnRMYW1iZGFDYWNoZVBvbGljeSgpO1xuXG4gICAgLy8gQ3JlYXRlIERpc3RyaWJ1dGlvblxuICAgIHJldHVybiBuZXcgY2xvdWRmcm9udC5EaXN0cmlidXRpb24odGhpcywgXCJEaXN0cmlidXRpb25cIiwge1xuICAgICAgLy8gdGhlc2UgdmFsdWVzIGNhbiBiZSBvdmVyd3JpdHRlbiBieSBjZkRpc3RyaWJ1dGlvblByb3BzXG4gICAgICBkZWZhdWx0Um9vdE9iamVjdDogXCJcIixcbiAgICAgIC8vIE92ZXJyaWRlIHByb3BzLlxuICAgICAgLi4uY2ZEaXN0cmlidXRpb25Qcm9wcyxcbiAgICAgIC8vIHRoZXNlIHZhbHVlcyBjYW4gTk9UIGJlIG92ZXJ3cml0dGVuIGJ5IGNmRGlzdHJpYnV0aW9uUHJvcHNcbiAgICAgIGRvbWFpbk5hbWVzLFxuICAgICAgY2VydGlmaWNhdGU6IHRoaXMuYWNtQ2VydGlmaWNhdGUsXG4gICAgICBkZWZhdWx0QmVoYXZpb3I6IHtcbiAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3ksXG4gICAgICAgIG9yaWdpbixcbiAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfR0VUX0hFQURfT1BUSU9OUyxcbiAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICBjYWNoZVBvbGljeTogbGFtYmRhQ2FjaGVQb2xpY3ksXG4gICAgICAgIC4uLihjZkRpc3RyaWJ1dGlvblByb3BzLmRlZmF1bHRCZWhhdmlvciB8fCB7fSksXG4gICAgICAgIC8vIGNvbmNhdGVuYXRlIGVkZ2VMYW1iZGFzXG4gICAgICAgIGVkZ2VMYW1iZGFzOiBbXG4gICAgICAgICAgLi4uZWRnZUxhbWJkYXMsXG4gICAgICAgICAgLi4uKGNmRGlzdHJpYnV0aW9uUHJvcHMuZGVmYXVsdEJlaGF2aW9yPy5lZGdlTGFtYmRhcyB8fCBbXSksXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgICAgYWRkaXRpb25hbEJlaGF2aW9yczoge1xuICAgICAgICBbdGhpcy5wYXRoUGF0dGVybihcIl9uZXh0L2ltYWdlKlwiKV06IHtcbiAgICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeSxcbiAgICAgICAgICBvcmlnaW4sXG4gICAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfQUxMLFxuICAgICAgICAgIGNhY2hlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQ2FjaGVkTWV0aG9kcy5DQUNIRV9HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICAgIGNhY2hlUG9saWN5OiBpbWFnZUNhY2hlUG9saWN5LFxuICAgICAgICAgIG9yaWdpblJlcXVlc3RQb2xpY3k6IG5ldyBjbG91ZGZyb250Lk9yaWdpblJlcXVlc3RQb2xpY3koXG4gICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgXCJJbWFnZU9yaWdpblJlcXVlc3RcIixcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgcXVlcnlTdHJpbmdCZWhhdmlvcjpcbiAgICAgICAgICAgICAgICBjbG91ZGZyb250Lk9yaWdpblJlcXVlc3RRdWVyeVN0cmluZ0JlaGF2aW9yLmFsbCgpLFxuICAgICAgICAgICAgfVxuICAgICAgICAgICksXG4gICAgICAgICAgZWRnZUxhbWJkYXM6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgZXZlbnRUeXBlOiBjbG91ZGZyb250LkxhbWJkYUVkZ2VFdmVudFR5cGUuT1JJR0lOX1JFUVVFU1QsXG4gICAgICAgICAgICAgIGZ1bmN0aW9uVmVyc2lvbjogdGhpcy5pbWFnZUZ1bmN0aW9uVmVyc2lvbixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAgW3RoaXMucGF0aFBhdHRlcm4oXCJfbmV4dC9kYXRhLypcIildOiB7XG4gICAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3ksXG4gICAgICAgICAgb3JpZ2luLFxuICAgICAgICAgIGFsbG93ZWRNZXRob2RzOiBjbG91ZGZyb250LkFsbG93ZWRNZXRob2RzLkFMTE9XX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY29tcHJlc3M6IHRydWUsXG4gICAgICAgICAgY2FjaGVQb2xpY3k6IGxhbWJkYUNhY2hlUG9saWN5LFxuICAgICAgICAgIGVkZ2VMYW1iZGFzLFxuICAgICAgICB9LFxuICAgICAgICBbdGhpcy5wYXRoUGF0dGVybihcIl9uZXh0LypcIildOiB7XG4gICAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3ksXG4gICAgICAgICAgb3JpZ2luLFxuICAgICAgICAgIGFsbG93ZWRNZXRob2RzOiBjbG91ZGZyb250LkFsbG93ZWRNZXRob2RzLkFMTE9XX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY2FjaGVkTWV0aG9kczogY2xvdWRmcm9udC5DYWNoZWRNZXRob2RzLkNBQ0hFX0dFVF9IRUFEX09QVElPTlMsXG4gICAgICAgICAgY29tcHJlc3M6IHRydWUsXG4gICAgICAgICAgY2FjaGVQb2xpY3k6IHN0YXRpY0NhY2hlUG9saWN5LFxuICAgICAgICB9LFxuICAgICAgICBbdGhpcy5wYXRoUGF0dGVybihcInN0YXRpYy8qXCIpXToge1xuICAgICAgICAgIHZpZXdlclByb3RvY29sUG9saWN5LFxuICAgICAgICAgIG9yaWdpbixcbiAgICAgICAgICBhbGxvd2VkTWV0aG9kczogY2xvdWRmcm9udC5BbGxvd2VkTWV0aG9kcy5BTExPV19HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICAgIGNhY2hlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQ2FjaGVkTWV0aG9kcy5DQUNIRV9HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICAgIGNhY2hlUG9saWN5OiBzdGF0aWNDYWNoZVBvbGljeSxcbiAgICAgICAgfSxcbiAgICAgICAgW3RoaXMucGF0aFBhdHRlcm4oXCJhcGkvKlwiKV06IHtcbiAgICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeSxcbiAgICAgICAgICBvcmlnaW4sXG4gICAgICAgICAgYWxsb3dlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQWxsb3dlZE1ldGhvZHMuQUxMT1dfQUxMLFxuICAgICAgICAgIGNhY2hlZE1ldGhvZHM6IGNsb3VkZnJvbnQuQ2FjaGVkTWV0aG9kcy5DQUNIRV9HRVRfSEVBRF9PUFRJT05TLFxuICAgICAgICAgIGNvbXByZXNzOiB0cnVlLFxuICAgICAgICAgIGNhY2hlUG9saWN5OiBsYW1iZGFDYWNoZVBvbGljeSxcbiAgICAgICAgICBlZGdlTGFtYmRhczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBpbmNsdWRlQm9keTogdHJ1ZSxcbiAgICAgICAgICAgICAgZXZlbnRUeXBlOiBjbG91ZGZyb250LkxhbWJkYUVkZ2VFdmVudFR5cGUuT1JJR0lOX1JFUVVFU1QsXG4gICAgICAgICAgICAgIGZ1bmN0aW9uVmVyc2lvbjogdGhpcy5hcGlGdW5jdGlvblZlcnNpb24sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICAgIC4uLihjZkRpc3RyaWJ1dGlvblByb3BzLmFkZGl0aW9uYWxCZWhhdmlvcnMgfHwge30pLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ2xvdWRGcm9udFN0YXRpY0NhY2hlUG9saWN5KCk6IGNsb3VkZnJvbnQuQ2FjaGVQb2xpY3kge1xuICAgIHJldHVybiBuZXcgY2xvdWRmcm9udC5DYWNoZVBvbGljeShcbiAgICAgIHRoaXMsXG4gICAgICBcIlN0YXRpY3NDYWNoZVwiLFxuICAgICAgTmV4dGpzU2l0ZS5zdGF0aWNDYWNoZVBvbGljeVByb3BzXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ2xvdWRGcm9udEltYWdlQ2FjaGVQb2xpY3koKTogY2xvdWRmcm9udC5DYWNoZVBvbGljeSB7XG4gICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkNhY2hlUG9saWN5KFxuICAgICAgdGhpcyxcbiAgICAgIFwiSW1hZ2VDYWNoZVwiLFxuICAgICAgTmV4dGpzU2l0ZS5pbWFnZUNhY2hlUG9saWN5UHJvcHNcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDbG91ZEZyb250TGFtYmRhQ2FjaGVQb2xpY3koKTogY2xvdWRmcm9udC5DYWNoZVBvbGljeSB7XG4gICAgcmV0dXJuIG5ldyBjbG91ZGZyb250LkNhY2hlUG9saWN5KFxuICAgICAgdGhpcyxcbiAgICAgIFwiTGFtYmRhQ2FjaGVcIixcbiAgICAgIE5leHRqc1NpdGUubGFtYmRhQ2FjaGVQb2xpY3lQcm9wc1xuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNsb3VkRnJvbnRJbnZhbGlkYXRpb24oKTogY2RrLkN1c3RvbVJlc291cmNlIHtcbiAgICAvLyBDcmVhdGUgYSBMYW1iZGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGRvaW5nIHRoZSBpbnZhbGlkYXRpb25cbiAgICBjb25zdCBpbnZhbGlkYXRvciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJDbG91ZEZyb250SW52YWxpZGF0b3JcIiwge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KFxuICAgICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9CYXNlU2l0ZS9jdXN0b20tcmVzb3VyY2VcIilcbiAgICAgICksXG4gICAgICBsYXllcnM6IFt0aGlzLmF3c0NsaUxheWVyXSxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzcsXG4gICAgICBoYW5kbGVyOiBcImNmLWludmFsaWRhdGUuaGFuZGxlclwiLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICB9KTtcblxuICAgIC8vIEdyYW50IHBlcm1pc3Npb25zIHRvIGludmFsaWRhdGUgQ0YgRGlzdHJpYnV0aW9uXG4gICAgaW52YWxpZGF0b3IuYWRkVG9Sb2xlUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICBcImNsb3VkZnJvbnQ6R2V0SW52YWxpZGF0aW9uXCIsXG4gICAgICAgICAgXCJjbG91ZGZyb250OkNyZWF0ZUludmFsaWRhdGlvblwiLFxuICAgICAgICBdLFxuICAgICAgICByZXNvdXJjZXM6IFtcIipcIl0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICAvLyBDcmVhdGUgY3VzdG9tIHJlc291cmNlXG4gICAgcmV0dXJuIG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2UodGhpcywgXCJDbG91ZEZyb250SW52YWxpZGF0aW9uXCIsIHtcbiAgICAgIHNlcnZpY2VUb2tlbjogaW52YWxpZGF0b3IuZnVuY3Rpb25Bcm4sXG4gICAgICByZXNvdXJjZVR5cGU6IFwiQ3VzdG9tOjpTU1RDbG91ZEZyb250SW52YWxpZGF0aW9uXCIsXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIC8vIG5lZWQgdGhlIERlcGxveUlkIGZpZWxkIHNvIHRoaXMgQ1IgZ2V0cyB1cGRhdGVkIG9uIGVhY2ggZGVwbG95XG4gICAgICAgIERlcGxveUlkOiB0aGlzLmRlcGxveUlkLFxuICAgICAgICBEaXN0cmlidXRpb25JZDogdGhpcy5jZkRpc3RyaWJ1dGlvbi5kaXN0cmlidXRpb25JZCxcbiAgICAgICAgRGlzdHJpYnV0aW9uUGF0aHM6IFtcIi8qXCJdLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAvLyBDdXN0b20gRG9tYWluXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIHByb3RlY3RlZCB2YWxpZGF0ZUN1c3RvbURvbWFpblNldHRpbmdzKCkge1xuICAgIGNvbnN0IHsgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChjdXN0b21Eb21haW4uaXNFeHRlcm5hbERvbWFpbiA9PT0gdHJ1ZSkge1xuICAgICAgaWYgKCFjdXN0b21Eb21haW4uY2VydGlmaWNhdGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBBIHZhbGlkIGNlcnRpZmljYXRlIGlzIHJlcXVpcmVkIHdoZW4gXCJpc0V4dGVybmFsRG9tYWluXCIgaXMgc2V0IHRvIFwidHJ1ZVwiLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChjdXN0b21Eb21haW4uZG9tYWluQWxpYXMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBEb21haW4gYWxpYXMgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGRvbWFpbnMgaG9zdGVkIG9uIEFtYXpvbiBSb3V0ZSA1My4gRG8gbm90IHNldCB0aGUgXCJjdXN0b21Eb21haW4uZG9tYWluQWxpYXNcIiB3aGVuIFwiaXNFeHRlcm5hbERvbWFpblwiIGlzIGVuYWJsZWQuYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGN1c3RvbURvbWFpbi5ob3N0ZWRab25lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgSG9zdGVkIHpvbmVzIGNhbiBvbmx5IGJlIGNvbmZpZ3VyZWQgZm9yIGRvbWFpbnMgaG9zdGVkIG9uIEFtYXpvbiBSb3V0ZSA1My4gRG8gbm90IHNldCB0aGUgXCJjdXN0b21Eb21haW4uaG9zdGVkWm9uZVwiIHdoZW4gXCJpc0V4dGVybmFsRG9tYWluXCIgaXMgZW5hYmxlZC5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGxvb2t1cEhvc3RlZFpvbmUoKTogcm91dGU1My5JSG9zdGVkWm9uZSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyBTa2lwIGlmIGN1c3RvbURvbWFpbiBpcyBub3QgY29uZmlndXJlZFxuICAgIGlmICghY3VzdG9tRG9tYWluKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IGhvc3RlZFpvbmU7XG5cbiAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgaG9zdGVkWm9uZSA9IHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHRoaXMsIFwiSG9zdGVkWm9uZVwiLCB7XG4gICAgICAgIGRvbWFpbk5hbWU6IGN1c3RvbURvbWFpbixcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoY2RrLkNvbnN0cnVjdC5pc0NvbnN0cnVjdChjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkpIHtcbiAgICAgIGhvc3RlZFpvbmUgPSBjdXN0b21Eb21haW4uaG9zdGVkWm9uZSBhcyByb3V0ZTUzLklIb3N0ZWRab25lO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGN1c3RvbURvbWFpbi5ob3N0ZWRab25lID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBob3N0ZWRab25lID0gcm91dGU1My5Ib3N0ZWRab25lLmZyb21Mb29rdXAodGhpcywgXCJIb3N0ZWRab25lXCIsIHtcbiAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUsXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgLy8gU2tpcCBpZiBkb21haW4gaXMgbm90IGEgUm91dGU1MyBkb21haW5cbiAgICAgIGlmIChjdXN0b21Eb21haW4uaXNFeHRlcm5hbERvbWFpbiA9PT0gdHJ1ZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGhvc3RlZFpvbmUgPSByb3V0ZTUzLkhvc3RlZFpvbmUuZnJvbUxvb2t1cCh0aGlzLCBcIkhvc3RlZFpvbmVcIiwge1xuICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBob3N0ZWRab25lID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUgYXMgcm91dGU1My5JSG9zdGVkWm9uZTtcbiAgICB9XG5cbiAgICByZXR1cm4gaG9zdGVkWm9uZTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ2VydGlmaWNhdGUoKTogYWNtLklDZXJ0aWZpY2F0ZSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG5cbiAgICBpZiAoIWN1c3RvbURvbWFpbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBhY21DZXJ0aWZpY2F0ZTtcblxuICAgIC8vIEhvc3RlZFpvbmUgaXMgc2V0IGZvciBSb3V0ZSA1MyBkb21haW5zXG4gICAgaWYgKHRoaXMuaG9zdGVkWm9uZSkge1xuICAgICAgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgYWNtQ2VydGlmaWNhdGUgPSBuZXcgYWNtLkRuc1ZhbGlkYXRlZENlcnRpZmljYXRlKHRoaXMsIFwiQ2VydGlmaWNhdGVcIiwge1xuICAgICAgICAgIGRvbWFpbk5hbWU6IGN1c3RvbURvbWFpbixcbiAgICAgICAgICBob3N0ZWRab25lOiB0aGlzLmhvc3RlZFpvbmUsXG4gICAgICAgICAgcmVnaW9uOiBcInVzLWVhc3QtMVwiLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAoY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlKSB7XG4gICAgICAgIGFjbUNlcnRpZmljYXRlID0gY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYWNtQ2VydGlmaWNhdGUgPSBuZXcgYWNtLkRuc1ZhbGlkYXRlZENlcnRpZmljYXRlKHRoaXMsIFwiQ2VydGlmaWNhdGVcIiwge1xuICAgICAgICAgIGRvbWFpbk5hbWU6IGN1c3RvbURvbWFpbi5kb21haW5OYW1lLFxuICAgICAgICAgIGhvc3RlZFpvbmU6IHRoaXMuaG9zdGVkWm9uZSxcbiAgICAgICAgICByZWdpb246IFwidXMtZWFzdC0xXCIsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICAvLyBIb3N0ZWRab25lIGlzIE5PVCBzZXQgZm9yIG5vbi1Sb3V0ZSA1MyBkb21haW5zXG4gICAgZWxzZSB7XG4gICAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgICBhY21DZXJ0aWZpY2F0ZSA9IGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYWNtQ2VydGlmaWNhdGU7XG4gIH1cblxuICBwcm90ZWN0ZWQgY3JlYXRlUm91dGU1M1JlY29yZHMoKTogdm9pZCB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG5cbiAgICBpZiAoIWN1c3RvbURvbWFpbiB8fCAhdGhpcy5ob3N0ZWRab25lKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IHJlY29yZE5hbWU7XG4gICAgbGV0IGRvbWFpbkFsaWFzO1xuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICByZWNvcmROYW1lID0gY3VzdG9tRG9tYWluO1xuICAgIH0gZWxzZSB7XG4gICAgICByZWNvcmROYW1lID0gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWU7XG4gICAgICBkb21haW5BbGlhcyA9IGN1c3RvbURvbWFpbi5kb21haW5BbGlhcztcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgRE5TIHJlY29yZFxuICAgIG5ldyByb3V0ZTUzLkFSZWNvcmQodGhpcywgXCJBbGlhc1JlY29yZFwiLCB7XG4gICAgICByZWNvcmROYW1lLFxuICAgICAgem9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgdGFyZ2V0OiByb3V0ZTUzLlJlY29yZFRhcmdldC5mcm9tQWxpYXMoXG4gICAgICAgIG5ldyByb3V0ZTUzVGFyZ2V0cy5DbG91ZEZyb250VGFyZ2V0KHRoaXMuY2ZEaXN0cmlidXRpb24pXG4gICAgICApLFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIEFsaWFzIHJlZGlyZWN0IHJlY29yZFxuICAgIGlmIChkb21haW5BbGlhcykge1xuICAgICAgbmV3IHJvdXRlNTNQYXR0ZXJucy5IdHRwc1JlZGlyZWN0KHRoaXMsIFwiUmVkaXJlY3RcIiwge1xuICAgICAgICB6b25lOiB0aGlzLmhvc3RlZFpvbmUsXG4gICAgICAgIHJlY29yZE5hbWVzOiBbZG9tYWluQWxpYXNdLFxuICAgICAgICB0YXJnZXREb21haW46IHJlY29yZE5hbWUsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gSGVscGVyIEZ1bmN0aW9uc1xuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICBwcml2YXRlIHBhdGhQYXR0ZXJuKHBhdHRlcm46IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgeyBiYXNlUGF0aCB9ID0gdGhpcy5yb3V0ZXNNYW5pZmVzdCB8fCB7fTtcbiAgICByZXR1cm4gYmFzZVBhdGggJiYgYmFzZVBhdGgubGVuZ3RoID4gMFxuICAgICAgPyBgJHtiYXNlUGF0aC5zbGljZSgxKX0vJHtwYXR0ZXJufWBcbiAgICAgIDogcGF0dGVybjtcbiAgfVxuXG4gIHByaXZhdGUgcmVhZFJvdXRlc01hbmlmZXN0KCk6IFJvdXRlc01hbmlmZXN0IHtcbiAgICByZXR1cm4gZnMucmVhZEpTT05TeW5jKFxuICAgICAgcGF0aC5qb2luKHRoaXMuYnVpbGRPdXREaXIhLCBcImRlZmF1bHQtbGFtYmRhL3JvdXRlcy1tYW5pZmVzdC5qc29uXCIpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UzNDb250ZW50UmVwbGFjZVZhbHVlcygpOiBCYXNlU2l0ZVJlcGxhY2VQcm9wc1tdIHtcbiAgICBjb25zdCByZXBsYWNlVmFsdWVzOiBCYXNlU2l0ZVJlcGxhY2VQcm9wc1tdID0gW107XG5cbiAgICBPYmplY3QuZW50cmllcyh0aGlzLnByb3BzLmVudmlyb25tZW50IHx8IHt9KVxuICAgICAgLmZpbHRlcigoWywgdmFsdWVdKSA9PiBjZGsuVG9rZW4uaXNVbnJlc29sdmVkKHZhbHVlKSlcbiAgICAgIC5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgICAgY29uc3QgdG9rZW4gPSBge3sgJHtrZXl9IH19YDtcbiAgICAgICAgcmVwbGFjZVZhbHVlcy5wdXNoKFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGZpbGVzOiBcIioqLyouaHRtbFwiLFxuICAgICAgICAgICAgc2VhcmNoOiB0b2tlbixcbiAgICAgICAgICAgIHJlcGxhY2U6IHZhbHVlLFxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgZmlsZXM6IFwiKiovKi5qc1wiLFxuICAgICAgICAgICAgc2VhcmNoOiB0b2tlbixcbiAgICAgICAgICAgIHJlcGxhY2U6IHZhbHVlLFxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgZmlsZXM6IFwiKiovKi5qc29uXCIsXG4gICAgICAgICAgICBzZWFyY2g6IHRva2VuLFxuICAgICAgICAgICAgcmVwbGFjZTogdmFsdWUsXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgcmV0dXJuIHJlcGxhY2VWYWx1ZXM7XG4gIH1cblxuICBwcml2YXRlIGdldExhbWJkYUNvbnRlbnRSZXBsYWNlVmFsdWVzKCk6IEJhc2VTaXRlUmVwbGFjZVByb3BzW10ge1xuICAgIGNvbnN0IHJlcGxhY2VWYWx1ZXM6IEJhc2VTaXRlUmVwbGFjZVByb3BzW10gPSBbXTtcblxuICAgIC8vIFRoZSBOZXh0LmpzIGFwcCBjYW4gaGF2ZSBlbnZpcm9ubWVudCB2YXJpYWJsZXMgbGlrZVxuICAgIC8vIGBwcm9jZXNzLmVudi5BUElfVVJMYCBpbiB0aGUgSlMgY29kZS4gYHByb2Nlc3MuZW52LkFQSV9VUkxgIG1pZ2h0IG9yXG4gICAgLy8gbWlnaHQgbm90IGdldCByZXNvbHZlZCBvbiBgbmV4dCBidWlsZGAgaWYgaXQgaXMgdXNlZCBpblxuICAgIC8vIHNlcnZlci1zaWRlIGZ1bmN0aW9ucywgaWUuIGdldFNlcnZlclNpZGVQcm9wcygpLlxuICAgIC8vIEJlY2F1c2UgTGFtYmRhQEVkZ2UgZG9lcyBub3Qgc3VwcG9ydCBlbnZpcm9ubWVudCB2YXJpYWJsZXMsIHdlIHdpbGxcbiAgICAvLyB1c2UgdGhlIHRyaWNrIG9mIHJlcGxhY2luZyBcInt7IF9TU1RfTkVYVEpTX1NJVEVfRU5WSVJPTk1FTlRfIH19XCIgd2l0aFxuICAgIC8vIGEgSlNPTiBlbmNvZGVkIHN0cmluZyBvZiBhbGwgZW52aXJvbm1lbnQga2V5LXZhbHVlIHBhaXJzLiBUaGlzIHN0cmluZ1xuICAgIC8vIHdpbGwgdGhlbiBnZXQgZGVjb2RlZCBhdCBydW4gdGltZS5cbiAgICBjb25zdCBsYW1iZGFFbnZzOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge307XG5cbiAgICBPYmplY3QuZW50cmllcyh0aGlzLnByb3BzLmVudmlyb25tZW50IHx8IHt9KS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIGNvbnN0IHRva2VuID0gYHt7ICR7a2V5fSB9fWA7XG4gICAgICByZXBsYWNlVmFsdWVzLnB1c2goXG4gICAgICAgIHtcbiAgICAgICAgICBmaWxlczogXCIqKi8qLmh0bWxcIixcbiAgICAgICAgICBzZWFyY2g6IHRva2VuLFxuICAgICAgICAgIHJlcGxhY2U6IHZhbHVlLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgZmlsZXM6IFwiKiovKi5qc1wiLFxuICAgICAgICAgIHNlYXJjaDogdG9rZW4sXG4gICAgICAgICAgcmVwbGFjZTogdmFsdWUsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBmaWxlczogXCIqKi8qLmpzb25cIixcbiAgICAgICAgICBzZWFyY2g6IHRva2VuLFxuICAgICAgICAgIHJlcGxhY2U6IHZhbHVlLFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgbGFtYmRhRW52c1trZXldID0gdmFsdWU7XG4gICAgfSk7XG5cbiAgICByZXBsYWNlVmFsdWVzLnB1c2goe1xuICAgICAgZmlsZXM6IFwiKiovKi5qc1wiLFxuICAgICAgc2VhcmNoOiAnXCJ7eyBfU1NUX05FWFRKU19TSVRFX0VOVklST05NRU5UXyB9fVwiJyxcbiAgICAgIHJlcGxhY2U6IEpTT04uc3RyaW5naWZ5KGxhbWJkYUVudnMpLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHJlcGxhY2VWYWx1ZXM7XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyU2l0ZUVudmlyb25tZW50KCkge1xuICAgIGNvbnN0IGVudmlyb25tZW50T3V0cHV0czogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMucHJvcHMuZW52aXJvbm1lbnQgfHwge30pKSB7XG4gICAgICBjb25zdCBvdXRwdXRJZCA9IGBTc3RTaXRlRW52XyR7a2V5fWA7XG4gICAgICBjb25zdCBvdXRwdXQgPSBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBvdXRwdXRJZCwgeyB2YWx1ZSB9KTtcbiAgICAgIGVudmlyb25tZW50T3V0cHV0c1trZXldID0gY2RrLlN0YWNrLm9mKHRoaXMpLmdldExvZ2ljYWxJZChvdXRwdXQpO1xuICAgIH1cblxuICAgIGNvbnN0IHJvb3QgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgcm9vdC5yZWdpc3RlclNpdGVFbnZpcm9ubWVudCh7XG4gICAgICBpZDogdGhpcy5ub2RlLmlkLFxuICAgICAgcGF0aDogdGhpcy5wcm9wcy5wYXRoLFxuICAgICAgc3RhY2s6IGNkay5TdGFjay5vZih0aGlzKS5ub2RlLmlkLFxuICAgICAgZW52aXJvbm1lbnRPdXRwdXRzLFxuICAgIH0gYXMgQmFzZVNpdGVFbnZpcm9ubWVudE91dHB1dHNJbmZvKTtcbiAgfVxufVxuIl19