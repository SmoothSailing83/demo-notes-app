"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Bucket = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const s3 = __importStar(require("@aws-cdk/aws-s3"));
const s3Notifications = __importStar(require("@aws-cdk/aws-s3-notifications"));
const Stack_1 = require("./Stack");
const Queue_1 = require("./Queue");
const Topic_1 = require("./Topic");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
class Bucket extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { s3Bucket, notifications, defaultFunctionProps } = props || {};
        this.notifications = [];
        this.permissionsAttachedForAllNotifications = [];
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create Bucket
        ////////////////////
        if (cdk.Construct.isConstruct(s3Bucket)) {
            this.s3Bucket = s3Bucket;
        }
        else {
            const s3BucketProps = (s3Bucket || {});
            this.s3Bucket = new s3.Bucket(this, "Bucket", Object.assign({}, s3BucketProps));
        }
        ///////////////////////////
        // Create Notifications
        ///////////////////////////
        this.addNotifications(this, notifications || []);
        ///////////////////
        // Register Construct
        ///////////////////
        root.registerConstruct(this);
    }
    get bucketArn() {
        return this.s3Bucket.bucketArn;
    }
    get bucketName() {
        return this.s3Bucket.bucketName;
    }
    get notificationFunctions() {
        return this.notifications.filter((notification) => notification instanceof Function_1.Function);
    }
    addNotifications(scope, notifications) {
        notifications.forEach((notification) => this.addNotification(scope, notification));
    }
    attachPermissions(permissions) {
        this.notifications
            .filter((notification) => notification instanceof Function_1.Function)
            .forEach((notification) => notification.attachPermissions(permissions));
        this.permissionsAttachedForAllNotifications.push(permissions);
    }
    attachPermissionsToNotification(index, permissions) {
        const notification = this.notifications[index];
        if (!(notification instanceof Function_1.Function)) {
            throw new Error(`Cannot attach permissions to the "${this.node.id}" Bucket notification because it's not a Lambda function`);
        }
        notification.attachPermissions(permissions);
    }
    getConstructInfo() {
        // imported
        if (!cdk.Token.isUnresolved(this.s3Bucket.bucketName)) {
            return {
                bucketName: this.s3Bucket.bucketName,
            };
        }
        // created
        const cfn = this.s3Bucket.node.defaultChild;
        return {
            bucketLogicalId: Stack_1.Stack.of(this).getLogicalId(cfn),
        };
    }
    addNotification(scope, notification) {
        if (notification instanceof Queue_1.Queue ||
            notification.queue) {
            notification = notification;
            this.addQueueNotification(scope, notification);
        }
        else if (notification instanceof Topic_1.Topic ||
            notification.topic) {
            notification = notification;
            this.addTopicNotification(scope, notification);
        }
        else {
            notification = notification;
            this.addFunctionNotification(scope, notification);
        }
    }
    addQueueNotification(scope, notification) {
        // Parse notification props
        let notificationProps;
        let queue;
        if (notification instanceof Queue_1.Queue) {
            notification = notification;
            queue = notification;
        }
        else {
            notification = notification;
            notificationProps = notification.notificationProps;
            queue = notification.queue;
        }
        this.notifications.push(queue);
        // Create Notifications
        const events = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.events) || [
            s3.EventType.OBJECT_CREATED,
            s3.EventType.OBJECT_REMOVED,
        ];
        const filters = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.filters) || [];
        events.forEach((event) => this.s3Bucket.addEventNotification(event, new s3Notifications.SqsDestination(queue.sqsQueue), ...filters));
    }
    addTopicNotification(scope, notification) {
        // Parse notification props
        let notificationProps;
        let topic;
        if (notification instanceof Topic_1.Topic) {
            notification = notification;
            topic = notification;
        }
        else {
            notification = notification;
            notificationProps = notification.notificationProps;
            topic = notification.topic;
        }
        this.notifications.push(topic);
        // Create Notifications
        const events = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.events) || [
            s3.EventType.OBJECT_CREATED,
            s3.EventType.OBJECT_REMOVED,
        ];
        const filters = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.filters) || [];
        events.forEach((event) => this.s3Bucket.addEventNotification(event, new s3Notifications.SnsDestination(topic.snsTopic), ...filters));
    }
    addFunctionNotification(scope, notification) {
        // parse notification
        let notificationFunction, notificationProps;
        if (notification.function) {
            notification = notification;
            notificationFunction = notification.function;
            notificationProps = notification.notificationProps;
        }
        else {
            notificationFunction = notification;
        }
        // create function
        const i = this.notifications.length;
        const fn = Function_1.Function.fromDefinition(scope, `Notification_${i}`, notificationFunction, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the consumers using FunctionProps, so the Table construct can apply the "defaultFunctionProps" to them.`);
        this.notifications.push(fn);
        // create Notifications
        const events = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.events) || [
            s3.EventType.OBJECT_CREATED,
            s3.EventType.OBJECT_REMOVED,
        ];
        const filters = (notificationProps === null || notificationProps === void 0 ? void 0 : notificationProps.filters) || [];
        events.forEach((event) => this.s3Bucket.addEventNotification(event, new s3Notifications.LambdaDestination(fn), ...filters));
        // attached permissions
        this.permissionsAttachedForAllNotifications.forEach((permissions) => fn.attachPermissions(permissions));
    }
}
exports.Bucket = Bucket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnVja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0J1Y2tldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbURBQXFDO0FBQ3JDLG9EQUFzQztBQUN0QywrRUFBaUU7QUFFakUsbUNBQWdDO0FBQ2hDLG1DQUFnQztBQUNoQyxtQ0FBZ0M7QUFFaEMseUNBQStFO0FBd0MvRSxxQkFBcUI7QUFDckIsWUFBWTtBQUNaLHFCQUFxQjtBQUVyQixNQUFhLE1BQU8sU0FBUSxHQUFHLENBQUMsU0FBUztJQU12QyxZQUFZLEtBQW9CLEVBQUUsRUFBVSxFQUFFLEtBQW1CO1FBQy9ELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFXLENBQUM7UUFDcEMsTUFBTSxFQUFFLFFBQVEsRUFBRSxhQUFhLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ3RFLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxzQ0FBc0MsR0FBRyxFQUFFLENBQUM7UUFDakQsSUFBSSxDQUFDLG9CQUFvQixHQUFHLG9CQUFvQixDQUFDO1FBRWpELG9CQUFvQjtRQUNwQixnQkFBZ0I7UUFDaEIsb0JBQW9CO1FBRXBCLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDdkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFxQixDQUFDO1NBQ3ZDO2FBQU07WUFDTCxNQUFNLGFBQWEsR0FBRyxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQW1CLENBQUM7WUFDekQsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFFBQVEsb0JBQ3ZDLGFBQWEsRUFDaEIsQ0FBQztTQUNKO1FBRUQsMkJB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ICogYXMgY2RrIGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQgKiBhcyBzMyBmcm9tIFwiQGF3cy1jZGsvYXdzLXMzXCI7XG5pbXBvcnQgKiBhcyBzM05vdGlmaWNhdGlvbnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1zMy1ub3RpZmljYXRpb25zXCI7XG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcbmltcG9ydCB7IFN0YWNrIH0gZnJvbSBcIi4vU3RhY2tcIjtcbmltcG9ydCB7IFF1ZXVlIH0gZnJvbSBcIi4vUXVldWVcIjtcbmltcG9ydCB7IFRvcGljIH0gZnJvbSBcIi4vVG9waWNcIjtcbmltcG9ydCB7IElTc3RDb25zdHJ1Y3QsIElTc3RDb25zdHJ1Y3RJbmZvIH0gZnJvbSBcIi4vQ29uc3RydWN0XCI7XG5pbXBvcnQgeyBGdW5jdGlvbiBhcyBGbiwgRnVuY3Rpb25Qcm9wcywgRnVuY3Rpb25EZWZpbml0aW9uIH0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zIH0gZnJvbSBcIi4vdXRpbC9wZXJtaXNzaW9uXCI7XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gSW50ZXJmYWNlc1xuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBpbnRlcmZhY2UgQnVja2V0UHJvcHMge1xuICByZWFkb25seSBzM0J1Y2tldD86IHMzLkJ1Y2tldCB8IHMzLkJ1Y2tldFByb3BzO1xuICByZWFkb25seSBub3RpZmljYXRpb25zPzogKFxuICAgIHwgRnVuY3Rpb25EZWZpbml0aW9uXG4gICAgfCBCdWNrZXRGdW5jdGlvbk5vdGlmaWNhdGlvblByb3BzXG4gICAgfCBRdWV1ZVxuICAgIHwgQnVja2V0UXVldWVOb3RpZmljYXRpb25Qcm9wc1xuICAgIHwgVG9waWNcbiAgICB8IEJ1Y2tldFRvcGljTm90aWZpY2F0aW9uUHJvcHNcbiAgKVtdO1xuICByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQnVja2V0Tm90aWZpY2F0aW9uUHJvcHMge1xuICByZWFkb25seSBldmVudHM/OiBzMy5FdmVudFR5cGVbXTtcbiAgcmVhZG9ubHkgZmlsdGVycz86IHMzLk5vdGlmaWNhdGlvbktleUZpbHRlcltdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJ1Y2tldEZ1bmN0aW9uTm90aWZpY2F0aW9uUHJvcHMge1xuICByZWFkb25seSBmdW5jdGlvbjogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBub3RpZmljYXRpb25Qcm9wcz86IEJ1Y2tldE5vdGlmaWNhdGlvblByb3BzO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJ1Y2tldFF1ZXVlTm90aWZpY2F0aW9uUHJvcHMge1xuICByZWFkb25seSBxdWV1ZTogUXVldWU7XG4gIHJlYWRvbmx5IG5vdGlmaWNhdGlvblByb3BzPzogQnVja2V0Tm90aWZpY2F0aW9uUHJvcHM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQnVja2V0VG9waWNOb3RpZmljYXRpb25Qcm9wcyB7XG4gIHJlYWRvbmx5IHRvcGljOiBUb3BpYztcbiAgcmVhZG9ubHkgbm90aWZpY2F0aW9uUHJvcHM/OiBCdWNrZXROb3RpZmljYXRpb25Qcm9wcztcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb25zdHJ1Y3Rcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgY2xhc3MgQnVja2V0IGV4dGVuZHMgY2RrLkNvbnN0cnVjdCBpbXBsZW1lbnRzIElTc3RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgczNCdWNrZXQ6IHMzLkJ1Y2tldDtcbiAgcHJpdmF0ZSByZWFkb25seSBub3RpZmljYXRpb25zOiAoRm4gfCBRdWV1ZSB8IFRvcGljKVtdO1xuICBwcml2YXRlIHJlYWRvbmx5IHBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxOb3RpZmljYXRpb25zOiBQZXJtaXNzaW9uc1tdO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcblxuICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkNvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBCdWNrZXRQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICBjb25zdCB7IHMzQnVja2V0LCBub3RpZmljYXRpb25zLCBkZWZhdWx0RnVuY3Rpb25Qcm9wcyB9ID0gcHJvcHMgfHwge307XG4gICAgdGhpcy5ub3RpZmljYXRpb25zID0gW107XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsTm90aWZpY2F0aW9ucyA9IFtdO1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMgPSBkZWZhdWx0RnVuY3Rpb25Qcm9wcztcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIEJ1Y2tldFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoY2RrLkNvbnN0cnVjdC5pc0NvbnN0cnVjdChzM0J1Y2tldCkpIHtcbiAgICAgIHRoaXMuczNCdWNrZXQgPSBzM0J1Y2tldCBhcyBzMy5CdWNrZXQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHMzQnVja2V0UHJvcHMgPSAoczNCdWNrZXQgfHwge30pIGFzIHMzLkJ1Y2tldFByb3BzO1xuICAgICAgdGhpcy5zM0J1Y2tldCA9IG5ldyBzMy5CdWNrZXQodGhpcywgXCJCdWNrZXRcIiwge1xuICAgICAgICAuLi5zM0J1Y2tldFByb3BzLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIE5vdGlmaWNhdGlvbnNcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIHRoaXMuYWRkTm90aWZpY2F0aW9ucyh0aGlzLCBub3RpZmljYXRpb25zIHx8IFtdKTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBSZWdpc3RlciBDb25zdHJ1Y3RcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgcm9vdC5yZWdpc3RlckNvbnN0cnVjdCh0aGlzKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgYnVja2V0QXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuczNCdWNrZXQuYnVja2V0QXJuO1xuICB9XG5cbiAgcHVibGljIGdldCBidWNrZXROYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuczNCdWNrZXQuYnVja2V0TmFtZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbm90aWZpY2F0aW9uRnVuY3Rpb25zKCk6IEZuW10ge1xuICAgIHJldHVybiB0aGlzLm5vdGlmaWNhdGlvbnMuZmlsdGVyKFxuICAgICAgKG5vdGlmaWNhdGlvbikgPT4gbm90aWZpY2F0aW9uIGluc3RhbmNlb2YgRm5cbiAgICApIGFzIEZuW107XG4gIH1cblxuICBwdWJsaWMgYWRkTm90aWZpY2F0aW9ucyhcbiAgICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgICBub3RpZmljYXRpb25zOiAoXG4gICAgICB8IEZ1bmN0aW9uRGVmaW5pdGlvblxuICAgICAgfCBCdWNrZXRGdW5jdGlvbk5vdGlmaWNhdGlvblByb3BzXG4gICAgICB8IFF1ZXVlXG4gICAgICB8IEJ1Y2tldFF1ZXVlTm90aWZpY2F0aW9uUHJvcHNcbiAgICAgIHwgVG9waWNcbiAgICAgIHwgQnVja2V0VG9waWNOb3RpZmljYXRpb25Qcm9wc1xuICAgIClbXVxuICApOiB2b2lkIHtcbiAgICBub3RpZmljYXRpb25zLmZvckVhY2goKG5vdGlmaWNhdGlvbikgPT5cbiAgICAgIHRoaXMuYWRkTm90aWZpY2F0aW9uKHNjb3BlLCBub3RpZmljYXRpb24pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICB0aGlzLm5vdGlmaWNhdGlvbnNcbiAgICAgIC5maWx0ZXIoKG5vdGlmaWNhdGlvbikgPT4gbm90aWZpY2F0aW9uIGluc3RhbmNlb2YgRm4pXG4gICAgICAuZm9yRWFjaCgobm90aWZpY2F0aW9uKSA9PiBub3RpZmljYXRpb24uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpKTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxOb3RpZmljYXRpb25zLnB1c2gocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zVG9Ob3RpZmljYXRpb24oXG4gICAgaW5kZXg6IG51bWJlcixcbiAgICBwZXJtaXNzaW9uczogUGVybWlzc2lvbnNcbiAgKTogdm9pZCB7XG4gICAgY29uc3Qgbm90aWZpY2F0aW9uID0gdGhpcy5ub3RpZmljYXRpb25zW2luZGV4XTtcbiAgICBpZiAoIShub3RpZmljYXRpb24gaW5zdGFuY2VvZiBGbikpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbm5vdCBhdHRhY2ggcGVybWlzc2lvbnMgdG8gdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgQnVja2V0IG5vdGlmaWNhdGlvbiBiZWNhdXNlIGl0J3Mgbm90IGEgTGFtYmRhIGZ1bmN0aW9uYFxuICAgICAgKTtcbiAgICB9XG4gICAgbm90aWZpY2F0aW9uLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RJbmZvKCk6IElTc3RDb25zdHJ1Y3RJbmZvIHtcbiAgICAvLyBpbXBvcnRlZFxuICAgIGlmICghY2RrLlRva2VuLmlzVW5yZXNvbHZlZCh0aGlzLnMzQnVja2V0LmJ1Y2tldE5hbWUpKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBidWNrZXROYW1lOiB0aGlzLnMzQnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICB9O1xuICAgIH1cbiAgICAvLyBjcmVhdGVkXG4gICAgY29uc3QgY2ZuID0gdGhpcy5zM0J1Y2tldC5ub2RlLmRlZmF1bHRDaGlsZCBhcyBzMy5DZm5CdWNrZXQ7XG4gICAgcmV0dXJuIHtcbiAgICAgIGJ1Y2tldExvZ2ljYWxJZDogU3RhY2sub2YodGhpcykuZ2V0TG9naWNhbElkKGNmbiksXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkTm90aWZpY2F0aW9uKFxuICAgIHNjb3BlOiBjZGsuQ29uc3RydWN0LFxuICAgIG5vdGlmaWNhdGlvbjpcbiAgICAgIHwgRnVuY3Rpb25EZWZpbml0aW9uXG4gICAgICB8IEJ1Y2tldEZ1bmN0aW9uTm90aWZpY2F0aW9uUHJvcHNcbiAgICAgIHwgUXVldWVcbiAgICAgIHwgQnVja2V0UXVldWVOb3RpZmljYXRpb25Qcm9wc1xuICAgICAgfCBUb3BpY1xuICAgICAgfCBCdWNrZXRUb3BpY05vdGlmaWNhdGlvblByb3BzXG4gICk6IHZvaWQge1xuICAgIGlmIChcbiAgICAgIG5vdGlmaWNhdGlvbiBpbnN0YW5jZW9mIFF1ZXVlIHx8XG4gICAgICAobm90aWZpY2F0aW9uIGFzIEJ1Y2tldFF1ZXVlTm90aWZpY2F0aW9uUHJvcHMpLnF1ZXVlXG4gICAgKSB7XG4gICAgICBub3RpZmljYXRpb24gPSBub3RpZmljYXRpb24gYXMgUXVldWUgfCBCdWNrZXRRdWV1ZU5vdGlmaWNhdGlvblByb3BzO1xuICAgICAgdGhpcy5hZGRRdWV1ZU5vdGlmaWNhdGlvbihzY29wZSwgbm90aWZpY2F0aW9uKTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgbm90aWZpY2F0aW9uIGluc3RhbmNlb2YgVG9waWMgfHxcbiAgICAgIChub3RpZmljYXRpb24gYXMgQnVja2V0VG9waWNOb3RpZmljYXRpb25Qcm9wcykudG9waWNcbiAgICApIHtcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5vdGlmaWNhdGlvbiBhcyBUb3BpYyB8IEJ1Y2tldFRvcGljTm90aWZpY2F0aW9uUHJvcHM7XG4gICAgICB0aGlzLmFkZFRvcGljTm90aWZpY2F0aW9uKHNjb3BlLCBub3RpZmljYXRpb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICBub3RpZmljYXRpb24gPSBub3RpZmljYXRpb24gYXNcbiAgICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgICAgfCBCdWNrZXRGdW5jdGlvbk5vdGlmaWNhdGlvblByb3BzO1xuICAgICAgdGhpcy5hZGRGdW5jdGlvbk5vdGlmaWNhdGlvbihzY29wZSwgbm90aWZpY2F0aW9uKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZFF1ZXVlTm90aWZpY2F0aW9uKFxuICAgIHNjb3BlOiBjZGsuQ29uc3RydWN0LFxuICAgIG5vdGlmaWNhdGlvbjogUXVldWUgfCBCdWNrZXRRdWV1ZU5vdGlmaWNhdGlvblByb3BzXG4gICk6IHZvaWQge1xuICAgIC8vIFBhcnNlIG5vdGlmaWNhdGlvbiBwcm9wc1xuICAgIGxldCBub3RpZmljYXRpb25Qcm9wcztcbiAgICBsZXQgcXVldWU6IFF1ZXVlO1xuICAgIGlmIChub3RpZmljYXRpb24gaW5zdGFuY2VvZiBRdWV1ZSkge1xuICAgICAgbm90aWZpY2F0aW9uID0gbm90aWZpY2F0aW9uIGFzIFF1ZXVlO1xuICAgICAgcXVldWUgPSBub3RpZmljYXRpb247XG4gICAgfSBlbHNlIHtcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5vdGlmaWNhdGlvbiBhcyBCdWNrZXRRdWV1ZU5vdGlmaWNhdGlvblByb3BzO1xuICAgICAgbm90aWZpY2F0aW9uUHJvcHMgPSBub3RpZmljYXRpb24ubm90aWZpY2F0aW9uUHJvcHM7XG4gICAgICBxdWV1ZSA9IG5vdGlmaWNhdGlvbi5xdWV1ZTtcbiAgICB9XG4gICAgdGhpcy5ub3RpZmljYXRpb25zLnB1c2gocXVldWUpO1xuXG4gICAgLy8gQ3JlYXRlIE5vdGlmaWNhdGlvbnNcbiAgICBjb25zdCBldmVudHMgPSBub3RpZmljYXRpb25Qcm9wcz8uZXZlbnRzIHx8IFtcbiAgICAgIHMzLkV2ZW50VHlwZS5PQkpFQ1RfQ1JFQVRFRCxcbiAgICAgIHMzLkV2ZW50VHlwZS5PQkpFQ1RfUkVNT1ZFRCxcbiAgICBdO1xuICAgIGNvbnN0IGZpbHRlcnMgPSBub3RpZmljYXRpb25Qcm9wcz8uZmlsdGVycyB8fCBbXTtcbiAgICBldmVudHMuZm9yRWFjaCgoZXZlbnQpID0+XG4gICAgICB0aGlzLnMzQnVja2V0LmFkZEV2ZW50Tm90aWZpY2F0aW9uKFxuICAgICAgICBldmVudCxcbiAgICAgICAgbmV3IHMzTm90aWZpY2F0aW9ucy5TcXNEZXN0aW5hdGlvbihxdWV1ZS5zcXNRdWV1ZSksXG4gICAgICAgIC4uLmZpbHRlcnNcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRUb3BpY05vdGlmaWNhdGlvbihcbiAgICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgICBub3RpZmljYXRpb246IFRvcGljIHwgQnVja2V0VG9waWNOb3RpZmljYXRpb25Qcm9wc1xuICApOiB2b2lkIHtcbiAgICAvLyBQYXJzZSBub3RpZmljYXRpb24gcHJvcHNcbiAgICBsZXQgbm90aWZpY2F0aW9uUHJvcHM7XG4gICAgbGV0IHRvcGljOiBUb3BpYztcbiAgICBpZiAobm90aWZpY2F0aW9uIGluc3RhbmNlb2YgVG9waWMpIHtcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5vdGlmaWNhdGlvbiBhcyBUb3BpYztcbiAgICAgIHRvcGljID0gbm90aWZpY2F0aW9uO1xuICAgIH0gZWxzZSB7XG4gICAgICBub3RpZmljYXRpb24gPSBub3RpZmljYXRpb24gYXMgQnVja2V0VG9waWNOb3RpZmljYXRpb25Qcm9wcztcbiAgICAgIG5vdGlmaWNhdGlvblByb3BzID0gbm90aWZpY2F0aW9uLm5vdGlmaWNhdGlvblByb3BzO1xuICAgICAgdG9waWMgPSBub3RpZmljYXRpb24udG9waWM7XG4gICAgfVxuICAgIHRoaXMubm90aWZpY2F0aW9ucy5wdXNoKHRvcGljKTtcblxuICAgIC8vIENyZWF0ZSBOb3RpZmljYXRpb25zXG4gICAgY29uc3QgZXZlbnRzID0gbm90aWZpY2F0aW9uUHJvcHM/LmV2ZW50cyB8fCBbXG4gICAgICBzMy5FdmVudFR5cGUuT0JKRUNUX0NSRUFURUQsXG4gICAgICBzMy5FdmVudFR5cGUuT0JKRUNUX1JFTU9WRUQsXG4gICAgXTtcbiAgICBjb25zdCBmaWx0ZXJzID0gbm90aWZpY2F0aW9uUHJvcHM/LmZpbHRlcnMgfHwgW107XG4gICAgZXZlbnRzLmZvckVhY2goKGV2ZW50KSA9PlxuICAgICAgdGhpcy5zM0J1Y2tldC5hZGRFdmVudE5vdGlmaWNhdGlvbihcbiAgICAgICAgZXZlbnQsXG4gICAgICAgIG5ldyBzM05vdGlmaWNhdGlvbnMuU25zRGVzdGluYXRpb24odG9waWMuc25zVG9waWMpLFxuICAgICAgICAuLi5maWx0ZXJzXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkRnVuY3Rpb25Ob3RpZmljYXRpb24oXG4gICAgc2NvcGU6IGNkay5Db25zdHJ1Y3QsXG4gICAgbm90aWZpY2F0aW9uOiBGdW5jdGlvbkRlZmluaXRpb24gfCBCdWNrZXRGdW5jdGlvbk5vdGlmaWNhdGlvblByb3BzXG4gICk6IHZvaWQge1xuICAgIC8vIHBhcnNlIG5vdGlmaWNhdGlvblxuICAgIGxldCBub3RpZmljYXRpb25GdW5jdGlvbiwgbm90aWZpY2F0aW9uUHJvcHM7XG4gICAgaWYgKChub3RpZmljYXRpb24gYXMgQnVja2V0RnVuY3Rpb25Ob3RpZmljYXRpb25Qcm9wcykuZnVuY3Rpb24pIHtcbiAgICAgIG5vdGlmaWNhdGlvbiA9IG5vdGlmaWNhdGlvbiBhcyBCdWNrZXRGdW5jdGlvbk5vdGlmaWNhdGlvblByb3BzO1xuICAgICAgbm90aWZpY2F0aW9uRnVuY3Rpb24gPSBub3RpZmljYXRpb24uZnVuY3Rpb247XG4gICAgICBub3RpZmljYXRpb25Qcm9wcyA9IG5vdGlmaWNhdGlvbi5ub3RpZmljYXRpb25Qcm9wcztcbiAgICB9IGVsc2Uge1xuICAgICAgbm90aWZpY2F0aW9uRnVuY3Rpb24gPSBub3RpZmljYXRpb24gYXMgRnVuY3Rpb25EZWZpbml0aW9uO1xuICAgIH1cblxuICAgIC8vIGNyZWF0ZSBmdW5jdGlvblxuICAgIGNvbnN0IGkgPSB0aGlzLm5vdGlmaWNhdGlvbnMubGVuZ3RoO1xuICAgIGNvbnN0IGZuID0gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICBzY29wZSxcbiAgICAgIGBOb3RpZmljYXRpb25fJHtpfWAsXG4gICAgICBub3RpZmljYXRpb25GdW5jdGlvbixcbiAgICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMsXG4gICAgICBgVGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiBjYW5ub3QgYmUgYXBwbGllZCBpZiBhbiBpbnN0YW5jZSBvZiBhIEZ1bmN0aW9uIGNvbnN0cnVjdCBpcyBwYXNzZWQgaW4uIE1ha2Ugc3VyZSB0byBkZWZpbmUgYWxsIHRoZSBjb25zdW1lcnMgdXNpbmcgRnVuY3Rpb25Qcm9wcywgc28gdGhlIFRhYmxlIGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiB0byB0aGVtLmBcbiAgICApO1xuICAgIHRoaXMubm90aWZpY2F0aW9ucy5wdXNoKGZuKTtcblxuICAgIC8vIGNyZWF0ZSBOb3RpZmljYXRpb25zXG4gICAgY29uc3QgZXZlbnRzID0gbm90aWZpY2F0aW9uUHJvcHM/LmV2ZW50cyB8fCBbXG4gICAgICBzMy5FdmVudFR5cGUuT0JKRUNUX0NSRUFURUQsXG4gICAgICBzMy5FdmVudFR5cGUuT0JKRUNUX1JFTU9WRUQsXG4gICAgXTtcbiAgICBjb25zdCBmaWx0ZXJzID0gbm90aWZpY2F0aW9uUHJvcHM/LmZpbHRlcnMgfHwgW107XG4gICAgZXZlbnRzLmZvckVhY2goKGV2ZW50KSA9PlxuICAgICAgdGhpcy5zM0J1Y2tldC5hZGRFdmVudE5vdGlmaWNhdGlvbihcbiAgICAgICAgZXZlbnQsXG4gICAgICAgIG5ldyBzM05vdGlmaWNhdGlvbnMuTGFtYmRhRGVzdGluYXRpb24oZm4pLFxuICAgICAgICAuLi5maWx0ZXJzXG4gICAgICApXG4gICAgKTtcblxuICAgIC8vIGF0dGFjaGVkIHBlcm1pc3Npb25zXG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsTm90aWZpY2F0aW9ucy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT5cbiAgICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==