"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.App = void 0;
const chalk_1 = __importDefault(require("chalk"));
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const spawn = __importStar(require("cross-spawn"));
const cdk = __importStar(require("@aws-cdk/core"));
const s3 = __importStar(require("@aws-cdk/aws-s3"));
const s3perms = __importStar(require("@aws-cdk/aws-s3/lib/perms"));
const iam = __importStar(require("@aws-cdk/aws-iam"));
const child_process_1 = require("child_process");
const Stack_1 = require("./Stack");
const Construct_1 = require("./Construct");
const nodeBuilder_1 = require("./util/nodeBuilder");
const core_1 = require("@aws-cdk/core");
const appPath = process.cwd();
/**
 * Finds the path to the tsc package executable by converting the file path of:
 * /Users/spongebob/serverless-stack/node_modules/typescript/dist/index.js
 * to:
 * /Users/spongebob/serverless-stack/node_modules/.bin/tsc
 */
function getTsBinPath() {
    const pkg = "typescript";
    const filePath = require.resolve(pkg);
    const matches = filePath.match(/(^.*[/\\]node_modules)[/\\].*$/);
    if (matches === null || !matches[1]) {
        throw new Error(`There was a problem finding ${pkg}`);
    }
    return path.join(matches[1], ".bin", "tsc");
}
/**
 * Uses the current file path and the package name to figure out the path to the
 * CLI. Converts:
 * /Users/spongebob/Sites/serverless-stack/packages/resources/dist/App.js
 * to:
 * /Users/jayair/Sites/serverless-stack/packages/cli
 */
function getSstCliRootPath() {
    const filePath = __dirname;
    const packageName = "resources";
    const packagePath = filePath.slice(0, filePath.lastIndexOf(packageName) + packageName.length);
    return path.join(packagePath, "../cli");
}
function exitWithMessage(message) {
    console.error(message);
    process.exit(1);
}
class App extends cdk.App {
    constructor(deployProps = {}, props = {}) {
        super(props);
        /**
         * Is the app being deployed locally
         */
        this.local = false;
        /**
         * A list of Lambda functions in the app
         */
        this.lambdaHandlers = [];
        this.siteEnvironments = [];
        /**
         * A list of SST constructs in the app
         */
        this.constructs = [];
        this.stage = deployProps.stage || "dev";
        this.name = deployProps.name || "my-app";
        this.region = deployProps.region || "us-east-1";
        this.lint = deployProps.lint === false ? false : true;
        this.account = process.env.CDK_DEFAULT_ACCOUNT || "my-account";
        this.typeCheck = deployProps.typeCheck === false ? false : true;
        this.esbuildConfig = deployProps.esbuildConfig;
        this.buildDir = deployProps.buildDir || ".build";
        this.skipBuild = deployProps.skipBuild || false;
        this.defaultFunctionProps = [];
        this.synthCallback = deployProps.synthCallback;
        if (deployProps.debugEndpoint) {
            this.local = true;
            this.debugEndpoint = deployProps.debugEndpoint;
            this.debugBucketArn = deployProps.debugBucketArn;
            this.debugBucketName = deployProps.debugBucketName;
            this.debugStartedAt = deployProps.debugStartedAt;
            this.debugIncreaseTimeout = deployProps.debugIncreaseTimeout;
            if (deployProps.debugBridge) {
                this.debugBridge = deployProps.debugBridge;
            }
        }
    }
    get defaultRemovalPolicy() {
        return this._defaultRemovalPolicy;
    }
    logicalPrefixedName(logicalName) {
        const namePrefix = this.name === "" ? "" : `${this.name}-`;
        return `${this.stage}-${namePrefix}${logicalName}`;
    }
    setDefaultRemovalPolicy(policy) {
        this._defaultRemovalPolicy = policy;
    }
    setDefaultFunctionProps(props) {
        if (this.node.children.some((node) => node instanceof cdk.Stack))
            throw new Error("Cannot call 'setDefaultFunctionProps' after a stack has been created. Please use 'addDefaultFunctionEnv' or 'addDefaultFunctionPermissions' to add more default properties. Read more about this change here: https://docs.serverless-stack.com/constructs/App#upgrading-to-v0420");
        this.defaultFunctionProps.push(props);
    }
    addDefaultFunctionPermissions(permissions) {
        this.defaultFunctionProps.push({
            permissions,
        });
    }
    addDefaultFunctionEnv(environment) {
        this.defaultFunctionProps.push({
            environment,
        });
    }
    addDefaultFunctionLayers(layers) {
        this.defaultFunctionProps.push({
            layers,
        });
    }
    applyRemovalPolicy(current, policy) {
        if (current instanceof cdk.CfnResource)
            current.applyRemovalPolicy(policy);
        // Had to copy this in to enable deleting objects in bucket
        // https://github.com/aws/aws-cdk/blob/master/packages/%40aws-cdk/aws-s3/lib/bucket.ts#L1910
        if (current instanceof s3.Bucket &&
            !current.node.tryFindChild("AutoDeleteObjectsCustomResource")) {
            const AUTO_DELETE_OBJECTS_RESOURCE_TYPE = "Custom::S3AutoDeleteObjects";
            const provider = core_1.CustomResourceProvider.getOrCreateProvider(current, AUTO_DELETE_OBJECTS_RESOURCE_TYPE, {
                codeDirectory: path.join(require.resolve("@aws-cdk/aws-s3"), "../auto-delete-objects-handler"),
                runtime: core_1.CustomResourceProviderRuntime.NODEJS_12_X,
                description: `Lambda function for auto-deleting objects in ${current.bucketName} S3 bucket.`,
            });
            // Use a bucket policy to allow the custom resource to delete
            // objects in the bucket
            current.addToResourcePolicy(new iam.PolicyStatement({
                actions: [
                    // list objects
                    ...s3perms.BUCKET_READ_METADATA_ACTIONS,
                    ...s3perms.BUCKET_DELETE_ACTIONS, // and then delete them
                ],
                resources: [current.bucketArn, current.arnForObjects("*")],
                principals: [new iam.ArnPrincipal(provider.roleArn)],
            }));
            const customResource = new core_1.CustomResource(current, "AutoDeleteObjectsCustomResource", {
                resourceType: AUTO_DELETE_OBJECTS_RESOURCE_TYPE,
                serviceToken: provider.serviceToken,
                properties: {
                    BucketName: current.bucketName,
                },
            });
            // Ensure bucket policy is deleted AFTER the custom resource otherwise
            // we don't have permissions to list and delete in the bucket.
            // (add a `if` to make TS happy)
            if (current.policy) {
                customResource.node.addDependency(current.policy);
            }
        }
        current.node.children.forEach((resource) => this.applyRemovalPolicy(resource, policy));
    }
    registerConstructs(construct) {
        if (construct instanceof Construct_1.Construct) {
            const type = construct.constructor.name;
            const stack = Stack_1.Stack.of(construct).node.id;
            const name = construct.node.id;
            const props = construct.getConstructInfo();
            this.constructs.push({ type, stack, name, props });
        }
        else {
            construct.node.children.forEach((child) => this.registerConstructs(child));
        }
    }
    synth(options = {}) {
        // Register constructs
        this.registerConstructs(this);
        for (const child of this.node.children) {
            if (child instanceof cdk.Stack) {
                // Set removal policy
                if (this._defaultRemovalPolicy)
                    this.applyRemovalPolicy(child, this._defaultRemovalPolicy);
                // Stack names need to be parameterized with the stage name
                if (!child.stackName.startsWith(`${this.stage}-`) &&
                    !child.stackName.endsWith(`-${this.stage}`) &&
                    child.stackName.indexOf(`-${this.stage}-`) === -1) {
                    throw new Error(`Stack "${child.stackName}" is not parameterized with the stage name. The stack name needs to either start with "$stage-", end in "-$stage", or contain the stage name "-$stage-".`);
                }
            }
        }
        const cloudAssembly = super.synth(options);
        // Run lint and type check on handler input files
        // Note: do not need to run in two scenarios:
        //  1. do not need to run while debugging because the Lambda functions are
        //     replaced by stubs and have not been transpiled.
        //  2. do not need to run while running resources tests because .eslint file
        //     does not exist inside .build folder.
        //  3. do not need to run if skipBuild is true, ie. sst remove
        if (!this.local && !this.isJestTest() && !this.skipBuild) {
            this.processInputFiles();
        }
        // Run callback after synth has finished
        if (this.synthCallback) {
            this.synthCallback(this.lambdaHandlers, this.siteEnvironments, this.constructs);
        }
        return cloudAssembly;
    }
    isJestTest() {
        // Check the env var set inside test/setup-tests.js
        return process.env.JEST_RESOURCES_TESTS === "enabled";
    }
    registerLambdaHandler(handler) {
        this.lambdaHandlers.push(handler);
    }
    registerSiteEnvironment(environment) {
        this.siteEnvironments.push(environment);
    }
    registerConstruct(construct) {
        const type = construct.constructor.name;
        const stack = Stack_1.Stack.of(construct).node.id;
        const name = construct.node.id;
        const props = construct.getConstructInfo();
        this.constructs.push({ type, stack, name, props });
    }
    processInputFiles() {
        // Get input files
        const inputFilesBySrcPath = {};
        this.lambdaHandlers.forEach(({ srcPath, handler, runtime }) => {
            if (!runtime.startsWith("nodejs")) {
                return;
            }
            const metafile = path.join(srcPath, this.buildDir, (0, nodeBuilder_1.getEsbuildMetafileName)(handler));
            const files = this.getInputFilesFromEsbuildMetafile(metafile);
            files.forEach((file) => {
                inputFilesBySrcPath[srcPath] = inputFilesBySrcPath[srcPath] || {};
                inputFilesBySrcPath[srcPath][file] = true;
            });
        });
        // Process each srcPath
        Object.keys(inputFilesBySrcPath).forEach((srcPath) => {
            const inputFiles = Object.keys(inputFilesBySrcPath[srcPath]);
            if (this.lint) {
                this.runLint(srcPath, inputFiles);
            }
            if (this.typeCheck) {
                this.runTypeCheck(srcPath, inputFiles);
            }
        });
    }
    getInputFilesFromEsbuildMetafile(file) {
        let metaJson;
        try {
            metaJson = fs.readJsonSync(file);
        }
        catch (e) {
            exitWithMessage("There was a problem reading the esbuild metafile.");
        }
        return Object.keys(metaJson.inputs).map((input) => path.resolve(input));
    }
    runLint(srcPath, inputFiles) {
        inputFiles = inputFiles.filter((file) => file.indexOf("node_modules") === -1 &&
            (file.endsWith(".ts") || file.endsWith(".js")));
        console.log(chalk_1.default.grey("Linting Lambda function source"));
        const response = spawn.sync("node", [
            path.join(appPath, this.buildDir, "eslint.js"),
            process.env.NO_COLOR === "true" ? "--no-color" : "--color",
            ...inputFiles,
        ], 
        // Using the ownPath instead of the appPath because there are cases
        // where npm flattens the dependecies and this casues eslint to be
        // unable to find the parsers and plugins. The ownPath hack seems
        // to fix this issue.
        // https://github.com/serverless-stack/serverless-stack/pull/68
        // Steps to replicate, repo: https://github.com/jayair/sst-eu-example
        // Do `yarn add standard -D` and `sst build`
        { stdio: "inherit", cwd: getSstCliRootPath() });
        if (response.error) {
            console.log(response.error);
            exitWithMessage("There was a problem linting the source.");
        }
        else if (response.stderr) {
            console.log(response.stderr);
            exitWithMessage("There was a problem linting the source.");
        }
        else if (response.status === 1) {
            exitWithMessage("There was a problem linting the source.");
        }
    }
    runTypeCheck(srcPath, inputFiles) {
        inputFiles = inputFiles.filter((file) => file.endsWith(".ts"));
        if (inputFiles.length === 0) {
            return;
        }
        console.log(chalk_1.default.grey("Type checking Lambda function source"));
        const hasTsconfig = fs.existsSync(path.join(srcPath, "tsconfig.json"));
        if (!hasTsconfig) {
            throw new Error(`Cannot find a "tsconfig.json" in the function's srcPath: ${path.resolve(srcPath)}`);
        }
        try {
            const stdout = (0, child_process_1.execSync)([
                getTsBinPath(),
                "--pretty",
                process.env.NO_COLOR === "true" ? "false" : "true",
                "--noEmit",
            ].join(" "), { cwd: srcPath });
            const output = stdout.toString();
            if (output.trim() !== "") {
                console.log(output);
            }
        }
        catch (e) {
            console.log(e.stdout.toString());
            exitWithMessage("There was a problem type checking the source.");
        }
    }
}
exports.App = App;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0FwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsa0RBQTBCO0FBQzFCLDJDQUE2QjtBQUM3Qiw2Q0FBK0I7QUFDL0IsbURBQXFDO0FBQ3JDLG1EQUFxQztBQUVyQyxvREFBc0M7QUFDdEMsbUVBQXFEO0FBQ3JELHNEQUF3QztBQUN4QyxpREFBeUM7QUFFekMsbUNBQWdDO0FBQ2hDLDJDQUEwRTtBQUcxRSxvREFBNEQ7QUFDNUQsd0NBSXVCO0FBSXZCLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUU5Qjs7Ozs7R0FLRztBQUNILFNBQVMsWUFBWTtJQUNuQixNQUFNLEdBQUcsR0FBRyxZQUFZLENBQUM7SUFDekIsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN0QyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7SUFFakUsSUFBSSxPQUFPLEtBQUssSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ25DLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLEdBQUcsRUFBRSxDQUFDLENBQUM7S0FDdkQ7SUFFRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM5QyxDQUFDO0FBRUQ7Ozs7OztHQU1HO0FBQ0gsU0FBUyxpQkFBaUI7SUFDeEIsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDO0lBQzNCLE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQztJQUNoQyxNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUNoQyxDQUFDLEVBQ0QsUUFBUSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsR0FB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QUFHLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDckI7U0FDRjtRQUFDLE9BQU8sQ0FBTSxFQUFFO1lBQ2YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFDakMsZUFBZSxDQUFDLCtDQUErQyxDQUFDLENBQUM7U0FDbEU7SUFDSCxDQUFDO0NBQ0Y7QUE3WUQsa0JBNllDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoYWxrIGZyb20gXCJjaGFsa1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgKiBhcyBzcGF3biBmcm9tIFwiY3Jvc3Mtc3Bhd25cIjtcbmltcG9ydCAqIGFzIGNkayBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0ICogYXMgY3hhcGkgZnJvbSBcIkBhd3MtY2RrL2N4LWFwaVwiO1xuaW1wb3J0ICogYXMgczMgZnJvbSBcIkBhd3MtY2RrL2F3cy1zM1wiO1xuaW1wb3J0ICogYXMgczNwZXJtcyBmcm9tIFwiQGF3cy1jZGsvYXdzLXMzL2xpYi9wZXJtc1wiO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gXCJAYXdzLWNkay9hd3MtaWFtXCI7XG5pbXBvcnQgeyBleGVjU3luYyB9IGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XG5cbmltcG9ydCB7IFN0YWNrIH0gZnJvbSBcIi4vU3RhY2tcIjtcbmltcG9ydCB7IENvbnN0cnVjdCwgSVNzdENvbnN0cnVjdCwgSVNzdENvbnN0cnVjdEluZm8gfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uSGFuZGxlclByb3BzIH0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcbmltcG9ydCB7IEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mbyB9IGZyb20gXCIuL0Jhc2VTaXRlXCI7XG5pbXBvcnQgeyBnZXRFc2J1aWxkTWV0YWZpbGVOYW1lIH0gZnJvbSBcIi4vdXRpbC9ub2RlQnVpbGRlclwiO1xuaW1wb3J0IHtcbiAgQ3VzdG9tUmVzb3VyY2UsXG4gIEN1c3RvbVJlc291cmNlUHJvdmlkZXIsXG4gIEN1c3RvbVJlc291cmNlUHJvdmlkZXJSdW50aW1lLFxufSBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcbmltcG9ydCB7IElMYXllclZlcnNpb24gfSBmcm9tIFwiQGF3cy1jZGsvYXdzLWxhbWJkYVwiO1xuXG5jb25zdCBhcHBQYXRoID0gcHJvY2Vzcy5jd2QoKTtcblxuLyoqXG4gKiBGaW5kcyB0aGUgcGF0aCB0byB0aGUgdHNjIHBhY2thZ2UgZXhlY3V0YWJsZSBieSBjb252ZXJ0aW5nIHRoZSBmaWxlIHBhdGggb2Y6XG4gKiAvVXNlcnMvc3BvbmdlYm9iL3NlcnZlcmxlc3Mtc3RhY2svbm9kZV9tb2R1bGVzL3R5cGVzY3JpcHQvZGlzdC9pbmRleC5qc1xuICogdG86XG4gKiAvVXNlcnMvc3BvbmdlYm9iL3NlcnZlcmxlc3Mtc3RhY2svbm9kZV9tb2R1bGVzLy5iaW4vdHNjXG4gKi9cbmZ1bmN0aW9uIGdldFRzQmluUGF0aCgpOiBzdHJpbmcge1xuICBjb25zdCBwa2cgPSBcInR5cGVzY3JpcHRcIjtcbiAgY29uc3QgZmlsZVBhdGggPSByZXF1aXJlLnJlc29sdmUocGtnKTtcbiAgY29uc3QgbWF0Y2hlcyA9IGZpbGVQYXRoLm1hdGNoKC8oXi4qWy9cXFxcXW5vZGVfbW9kdWxlcylbL1xcXFxdLiokLyk7XG5cbiAgaWYgKG1hdGNoZXMgPT09IG51bGwgfHwgIW1hdGNoZXNbMV0pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZXJlIHdhcyBhIHByb2JsZW0gZmluZGluZyAke3BrZ31gKTtcbiAgfVxuXG4gIHJldHVybiBwYXRoLmpvaW4obWF0Y2hlc1sxXSwgXCIuYmluXCIsIFwidHNjXCIpO1xufVxuXG4vKipcbiAqIFVzZXMgdGhlIGN1cnJlbnQgZmlsZSBwYXRoIGFuZCB0aGUgcGFja2FnZSBuYW1lIHRvIGZpZ3VyZSBvdXQgdGhlIHBhdGggdG8gdGhlXG4gKiBDTEkuIENvbnZlcnRzOlxuICogL1VzZXJzL3Nwb25nZWJvYi9TaXRlcy9zZXJ2ZXJsZXNzLXN0YWNrL3BhY2thZ2VzL3Jlc291cmNlcy9kaXN0L0FwcC5qc1xuICogdG86XG4gKiAvVXNlcnMvamF5YWlyL1NpdGVzL3NlcnZlcmxlc3Mtc3RhY2svcGFja2FnZXMvY2xpXG4gKi9cbmZ1bmN0aW9uIGdldFNzdENsaVJvb3RQYXRoKCkge1xuICBjb25zdCBmaWxlUGF0aCA9IF9fZGlybmFtZTtcbiAgY29uc3QgcGFja2FnZU5hbWUgPSBcInJlc291cmNlc1wiO1xuICBjb25zdCBwYWNrYWdlUGF0aCA9IGZpbGVQYXRoLnNsaWNlKFxuICAgIDAsXG4gICAgZmlsZVBhdGgubGFzdEluZGV4T2YocGFja2FnZU5hbWUpICsgcGFja2FnZU5hbWUubGVuZ3RoXG4gICk7XG5cbiAgcmV0dXJuIHBhdGguam9pbihwYWNrYWdlUGF0aCwgXCIuLi9jbGlcIik7XG59XG5cbmZ1bmN0aW9uIGV4aXRXaXRoTWVzc2FnZShtZXNzYWdlOiBzdHJpbmcpIHtcbiAgY29uc29sZS5lcnJvcihtZXNzYWdlKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufVxuXG5leHBvcnQgdHlwZSBEZXBsb3lQcm9wcyA9IEFwcERlcGxveVByb3BzO1xuXG4vKipcbiAqIERlcGxveSBwcm9wcyBmb3IgYXBwcy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBBcHBEZXBsb3lQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgYXBwIG5hbWUsIHVzZWQgdG8gcHJlZml4IHN0YWNrcy5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBEZWZhdWx0cyB0byBlbXB0eSBzdHJpbmdcbiAgICovXG4gIHJlYWRvbmx5IG5hbWU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBzdGFnZSB0byBkZXBsb3kgdGhpcyBhcHAgdG8uXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gRGVmYXVsdHMgdG8gZGV2XG4gICAqL1xuICByZWFkb25seSBzdGFnZT86IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHJlZ2lvbiB0byBkZXBsb3kgdGhpcyBhcHAgdG8uXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gRGVmYXVsdHMgdG8gdXMtZWFzdC0xXG4gICAqL1xuICByZWFkb25seSByZWdpb24/OiBzdHJpbmc7XG5cbiAgcmVhZG9ubHkgbGludD86IGJvb2xlYW47XG4gIHJlYWRvbmx5IHR5cGVDaGVjaz86IGJvb2xlYW47XG4gIHJlYWRvbmx5IGJ1aWxkRGlyPzogc3RyaW5nO1xuICByZWFkb25seSBza2lwQnVpbGQ/OiBib29sZWFuO1xuICByZWFkb25seSBlc2J1aWxkQ29uZmlnPzogc3RyaW5nO1xuICByZWFkb25seSBkZWJ1Z0VuZHBvaW50Pzogc3RyaW5nO1xuICByZWFkb25seSBkZWJ1Z0J1Y2tldEFybj86IHN0cmluZztcbiAgcmVhZG9ubHkgZGVidWdCdWNrZXROYW1lPzogc3RyaW5nO1xuICByZWFkb25seSBkZWJ1Z1N0YXJ0ZWRBdD86IG51bWJlcjtcbiAgcmVhZG9ubHkgZGVidWdCcmlkZ2U/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGRlYnVnSW5jcmVhc2VUaW1lb3V0PzogYm9vbGVhbjtcblxuICAvKipcbiAgICogVGhlIGNhbGxiYWNrIGFmdGVyIHN5bnRoIGNvbXBsZXRlcywgdXNlZCBieSBgc3N0IHN0YXJ0YC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBEZWZhdWx0cyB0byB1bmRlZmluZWRcbiAgICovXG4gIHJlYWRvbmx5IHN5bnRoQ2FsbGJhY2s/OiAoXG4gICAgbGFtYmRhSGFuZGxlcnM6IEZ1bmN0aW9uSGFuZGxlclByb3BzW10sXG4gICAgc2l0ZUVudmlyb25tZW50czogQmFzZVNpdGVFbnZpcm9ubWVudE91dHB1dHNJbmZvW10sXG4gICAgY29uc3RydWN0czogQXBwQ29uc3RydWN0UHJvcHNbXVxuICApID0+IHZvaWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwQ29uc3RydWN0UHJvcHMge1xuICByZWFkb25seSB0eXBlOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHN0YWNrOiBzdHJpbmc7XG4gIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbiAgcmVhZG9ubHkgcHJvcHM6IElTc3RDb25zdHJ1Y3RJbmZvO1xufVxuXG5leHBvcnQgdHlwZSBBcHBQcm9wcyA9IGNkay5BcHBQcm9wcztcblxuZXhwb3J0IGNsYXNzIEFwcCBleHRlbmRzIGNkay5BcHAge1xuICAvKipcbiAgICogSXMgdGhlIGFwcCBiZWluZyBkZXBsb3llZCBsb2NhbGx5XG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgbG9jYWw6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAvKipcbiAgICogVGhlIGFwcCBuYW1lXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgc3RhZ2U6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IHJlZ2lvbjogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgbGludDogYm9vbGVhbjtcbiAgcHVibGljIHJlYWRvbmx5IGFjY291bnQ6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IHR5cGVDaGVjazogYm9vbGVhbjtcbiAgcHVibGljIHJlYWRvbmx5IGJ1aWxkRGlyOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBlc2J1aWxkQ29uZmlnPzogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgZGVidWdCcmlkZ2U/OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBkZWJ1Z0VuZHBvaW50Pzogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgZGVidWdCdWNrZXRBcm4/OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBkZWJ1Z0J1Y2tldE5hbWU/OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBkZWJ1Z1N0YXJ0ZWRBdD86IG51bWJlcjtcbiAgcHVibGljIHJlYWRvbmx5IGRlYnVnSW5jcmVhc2VUaW1lb3V0PzogYm9vbGVhbjtcbiAgcHVibGljIGRlZmF1bHRGdW5jdGlvblByb3BzOiAoXG4gICAgfCBGdW5jdGlvblByb3BzXG4gICAgfCAoKHN0YWNrOiBjZGsuU3RhY2spID0+IEZ1bmN0aW9uUHJvcHMpXG4gIClbXTtcbiAgcHJpdmF0ZSBfZGVmYXVsdFJlbW92YWxQb2xpY3k/OiBjZGsuUmVtb3ZhbFBvbGljeTtcbiAgcHVibGljIGdldCBkZWZhdWx0UmVtb3ZhbFBvbGljeSgpIHtcbiAgICByZXR1cm4gdGhpcy5fZGVmYXVsdFJlbW92YWxQb2xpY3k7XG4gIH1cblxuICAvKipcbiAgICogVGhlIGNhbGxiYWNrIGFmdGVyIHN5bnRoIGNvbXBsZXRlcy5cbiAgICovXG4gIHByaXZhdGUgcmVhZG9ubHkgc3ludGhDYWxsYmFjaz86IChcbiAgICBsYW1iZGFIYW5kbGVyczogRnVuY3Rpb25IYW5kbGVyUHJvcHNbXSxcbiAgICBzaXRlRW52aXJvbm1lbnRzOiBCYXNlU2l0ZUVudmlyb25tZW50T3V0cHV0c0luZm9bXSxcbiAgICBjb25zdHJ1Y3RzOiBBcHBDb25zdHJ1Y3RQcm9wc1tdXG4gICkgPT4gdm9pZDtcblxuICAvKipcbiAgICogQSBsaXN0IG9mIExhbWJkYSBmdW5jdGlvbnMgaW4gdGhlIGFwcFxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBsYW1iZGFIYW5kbGVyczogRnVuY3Rpb25IYW5kbGVyUHJvcHNbXSA9IFtdO1xuICBwcml2YXRlIHJlYWRvbmx5IHNpdGVFbnZpcm9ubWVudHM6IEJhc2VTaXRlRW52aXJvbm1lbnRPdXRwdXRzSW5mb1tdID0gW107XG5cbiAgLyoqXG4gICAqIEEgbGlzdCBvZiBTU1QgY29uc3RydWN0cyBpbiB0aGUgYXBwXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbnN0cnVjdHM6IEFwcENvbnN0cnVjdFByb3BzW10gPSBbXTtcblxuICAvKipcbiAgICogU2tpcCBidWlsZGluZyBGdW5jdGlvbiBjb2RlXG4gICAqIE5vdGUgdGhhdCBvbiBgc3N0IHJlbW92ZWAsIHdlIGRvIG5vdCB3YW50IHRvIGJ1bmRsZSB0aGUgTGFtYmRhIGZ1bmN0aW9ucy5cbiAgICogICAgICBDREsgZGlzYWJsZXMgYnVuZGxpbmcgKGllLiB6aXBwaW5nKSBmb3IgYGNkayBkZXN0cm95YCBjb21tYW5kLlxuICAgKiAgICAgIEJ1dCBTU1QgcnVucyBgY2RrIHN5bnRoYCBmaXJzdCB0aGVuIG1hbnVhbGx5IHJlbW92ZSBlYWNoIHN0YWNrLiBIZW5jZVxuICAgKiAgICAgIHdlIGNhbm5vdCByZWx5IG9uIENESyB0byBkaXNhYmxlIGJ1bmRsaW5nLCBhbmQgd2UgZGlzYWJsZSBpdCBtYW51YWxseS5cbiAgICogICAgICBUaGlzIGFsbG93cyB1cyB0byBkaXNhYmxlIEJPVEggYnVpbGRpbmcgYW5kIGJ1bmRsaW5nLCB3aGVyZSBhcyBDREtcbiAgICogICAgICB3b3VsZCBvbmx5IGRpc2FibGUgdGhlIGxhdHRlci4gRm9yIGV4YW1wbGUsIGBjZGsgZGVzdHJveWAgc3RpbGwgdHJ5c1xuICAgKiAgICAgIHRvIGluc3RhbGwgUHl0aG9uIGRlcGVuZGVuY2llcyBpbiBEb2NrZXIuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgc2tpcEJ1aWxkOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKGRlcGxveVByb3BzOiBBcHBEZXBsb3lQcm9wcyA9IHt9LCBwcm9wczogQXBwUHJvcHMgPSB7fSkge1xuICAgIHN1cGVyKHByb3BzKTtcblxuICAgIHRoaXMuc3RhZ2UgPSBkZXBsb3lQcm9wcy5zdGFnZSB8fCBcImRldlwiO1xuICAgIHRoaXMubmFtZSA9IGRlcGxveVByb3BzLm5hbWUgfHwgXCJteS1hcHBcIjtcbiAgICB0aGlzLnJlZ2lvbiA9IGRlcGxveVByb3BzLnJlZ2lvbiB8fCBcInVzLWVhc3QtMVwiO1xuICAgIHRoaXMubGludCA9IGRlcGxveVByb3BzLmxpbnQgPT09IGZhbHNlID8gZmFsc2UgOiB0cnVlO1xuICAgIHRoaXMuYWNjb3VudCA9IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX0FDQ09VTlQgfHwgXCJteS1hY2NvdW50XCI7XG4gICAgdGhpcy50eXBlQ2hlY2sgPSBkZXBsb3lQcm9wcy50eXBlQ2hlY2sgPT09IGZhbHNlID8gZmFsc2UgOiB0cnVlO1xuICAgIHRoaXMuZXNidWlsZENvbmZpZyA9IGRlcGxveVByb3BzLmVzYnVpbGRDb25maWc7XG4gICAgdGhpcy5idWlsZERpciA9IGRlcGxveVByb3BzLmJ1aWxkRGlyIHx8IFwiLmJ1aWxkXCI7XG4gICAgdGhpcy5za2lwQnVpbGQgPSBkZXBsb3lQcm9wcy5za2lwQnVpbGQgfHwgZmFsc2U7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyA9IFtdO1xuICAgIHRoaXMuc3ludGhDYWxsYmFjayA9IGRlcGxveVByb3BzLnN5bnRoQ2FsbGJhY2s7XG5cbiAgICBpZiAoZGVwbG95UHJvcHMuZGVidWdFbmRwb2ludCkge1xuICAgICAgdGhpcy5sb2NhbCA9IHRydWU7XG4gICAgICB0aGlzLmRlYnVnRW5kcG9pbnQgPSBkZXBsb3lQcm9wcy5kZWJ1Z0VuZHBvaW50O1xuICAgICAgdGhpcy5kZWJ1Z0J1Y2tldEFybiA9IGRlcGxveVByb3BzLmRlYnVnQnVja2V0QXJuO1xuICAgICAgdGhpcy5kZWJ1Z0J1Y2tldE5hbWUgPSBkZXBsb3lQcm9wcy5kZWJ1Z0J1Y2tldE5hbWU7XG4gICAgICB0aGlzLmRlYnVnU3RhcnRlZEF0ID0gZGVwbG95UHJvcHMuZGVidWdTdGFydGVkQXQ7XG4gICAgICB0aGlzLmRlYnVnSW5jcmVhc2VUaW1lb3V0ID0gZGVwbG95UHJvcHMuZGVidWdJbmNyZWFzZVRpbWVvdXQ7XG4gICAgICBpZiAoZGVwbG95UHJvcHMuZGVidWdCcmlkZ2UpIHtcbiAgICAgICAgdGhpcy5kZWJ1Z0JyaWRnZSA9IGRlcGxveVByb3BzLmRlYnVnQnJpZGdlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGxvZ2ljYWxQcmVmaXhlZE5hbWUobG9naWNhbE5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgbmFtZVByZWZpeCA9IHRoaXMubmFtZSA9PT0gXCJcIiA/IFwiXCIgOiBgJHt0aGlzLm5hbWV9LWA7XG4gICAgcmV0dXJuIGAke3RoaXMuc3RhZ2V9LSR7bmFtZVByZWZpeH0ke2xvZ2ljYWxOYW1lfWA7XG4gIH1cblxuICBzZXREZWZhdWx0UmVtb3ZhbFBvbGljeShwb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5KSB7XG4gICAgdGhpcy5fZGVmYXVsdFJlbW92YWxQb2xpY3kgPSBwb2xpY3k7XG4gIH1cblxuICBzZXREZWZhdWx0RnVuY3Rpb25Qcm9wcyhcbiAgICBwcm9wczogRnVuY3Rpb25Qcm9wcyB8ICgoc3RhY2s6IGNkay5TdGFjaykgPT4gRnVuY3Rpb25Qcm9wcylcbiAgKTogdm9pZCB7XG4gICAgaWYgKHRoaXMubm9kZS5jaGlsZHJlbi5zb21lKChub2RlKSA9PiBub2RlIGluc3RhbmNlb2YgY2RrLlN0YWNrKSlcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJDYW5ub3QgY2FsbCAnc2V0RGVmYXVsdEZ1bmN0aW9uUHJvcHMnIGFmdGVyIGEgc3RhY2sgaGFzIGJlZW4gY3JlYXRlZC4gUGxlYXNlIHVzZSAnYWRkRGVmYXVsdEZ1bmN0aW9uRW52JyBvciAnYWRkRGVmYXVsdEZ1bmN0aW9uUGVybWlzc2lvbnMnIHRvIGFkZCBtb3JlIGRlZmF1bHQgcHJvcGVydGllcy4gUmVhZCBtb3JlIGFib3V0IHRoaXMgY2hhbmdlIGhlcmU6IGh0dHBzOi8vZG9jcy5zZXJ2ZXJsZXNzLXN0YWNrLmNvbS9jb25zdHJ1Y3RzL0FwcCN1cGdyYWRpbmctdG8tdjA0MjBcIlxuICAgICAgKTtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLnB1c2gocHJvcHMpO1xuICB9XG5cbiAgYWRkRGVmYXVsdEZ1bmN0aW9uUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKSB7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHtcbiAgICAgIHBlcm1pc3Npb25zLFxuICAgIH0pO1xuICB9XG5cbiAgYWRkRGVmYXVsdEZ1bmN0aW9uRW52KGVudmlyb25tZW50OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+KSB7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHtcbiAgICAgIGVudmlyb25tZW50LFxuICAgIH0pO1xuICB9XG5cbiAgYWRkRGVmYXVsdEZ1bmN0aW9uTGF5ZXJzKGxheWVyczogSUxheWVyVmVyc2lvbltdKSB7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHtcbiAgICAgIGxheWVycyxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXBwbHlSZW1vdmFsUG9saWN5KFxuICAgIGN1cnJlbnQ6IGNkay5JQ29uc3RydWN0LFxuICAgIHBvbGljeTogY2RrLlJlbW92YWxQb2xpY3lcbiAgKSB7XG4gICAgaWYgKGN1cnJlbnQgaW5zdGFuY2VvZiBjZGsuQ2ZuUmVzb3VyY2UpIGN1cnJlbnQuYXBwbHlSZW1vdmFsUG9saWN5KHBvbGljeSk7XG5cbiAgICAvLyBIYWQgdG8gY29weSB0aGlzIGluIHRvIGVuYWJsZSBkZWxldGluZyBvYmplY3RzIGluIGJ1Y2tldFxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MvYXdzLWNkay9ibG9iL21hc3Rlci9wYWNrYWdlcy8lNDBhd3MtY2RrL2F3cy1zMy9saWIvYnVja2V0LnRzI0wxOTEwXG4gICAgaWYgKFxuICAgICAgY3VycmVudCBpbnN0YW5jZW9mIHMzLkJ1Y2tldCAmJlxuICAgICAgIWN1cnJlbnQubm9kZS50cnlGaW5kQ2hpbGQoXCJBdXRvRGVsZXRlT2JqZWN0c0N1c3RvbVJlc291cmNlXCIpXG4gICAgKSB7XG4gICAgICBjb25zdCBBVVRPX0RFTEVURV9PQkpFQ1RTX1JFU09VUkNFX1RZUEUgPSBcIkN1c3RvbTo6UzNBdXRvRGVsZXRlT2JqZWN0c1wiO1xuICAgICAgY29uc3QgcHJvdmlkZXIgPSBDdXN0b21SZXNvdXJjZVByb3ZpZGVyLmdldE9yQ3JlYXRlUHJvdmlkZXIoXG4gICAgICAgIGN1cnJlbnQsXG4gICAgICAgIEFVVE9fREVMRVRFX09CSkVDVFNfUkVTT1VSQ0VfVFlQRSxcbiAgICAgICAge1xuICAgICAgICAgIGNvZGVEaXJlY3Rvcnk6IHBhdGguam9pbihcbiAgICAgICAgICAgIHJlcXVpcmUucmVzb2x2ZShcIkBhd3MtY2RrL2F3cy1zM1wiKSxcbiAgICAgICAgICAgIFwiLi4vYXV0by1kZWxldGUtb2JqZWN0cy1oYW5kbGVyXCJcbiAgICAgICAgICApLFxuICAgICAgICAgIHJ1bnRpbWU6IEN1c3RvbVJlc291cmNlUHJvdmlkZXJSdW50aW1lLk5PREVKU18xMl9YLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBgTGFtYmRhIGZ1bmN0aW9uIGZvciBhdXRvLWRlbGV0aW5nIG9iamVjdHMgaW4gJHtjdXJyZW50LmJ1Y2tldE5hbWV9IFMzIGJ1Y2tldC5gLFxuICAgICAgICB9XG4gICAgICApO1xuXG4gICAgICAvLyBVc2UgYSBidWNrZXQgcG9saWN5IHRvIGFsbG93IHRoZSBjdXN0b20gcmVzb3VyY2UgdG8gZGVsZXRlXG4gICAgICAvLyBvYmplY3RzIGluIHRoZSBidWNrZXRcbiAgICAgIGN1cnJlbnQuYWRkVG9SZXNvdXJjZVBvbGljeShcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgIC8vIGxpc3Qgb2JqZWN0c1xuICAgICAgICAgICAgLi4uczNwZXJtcy5CVUNLRVRfUkVBRF9NRVRBREFUQV9BQ1RJT05TLFxuICAgICAgICAgICAgLi4uczNwZXJtcy5CVUNLRVRfREVMRVRFX0FDVElPTlMsIC8vIGFuZCB0aGVuIGRlbGV0ZSB0aGVtXG4gICAgICAgICAgXSxcbiAgICAgICAgICByZXNvdXJjZXM6IFtjdXJyZW50LmJ1Y2tldEFybiwgY3VycmVudC5hcm5Gb3JPYmplY3RzKFwiKlwiKV0sXG4gICAgICAgICAgcHJpbmNpcGFsczogW25ldyBpYW0uQXJuUHJpbmNpcGFsKHByb3ZpZGVyLnJvbGVBcm4pXSxcbiAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGN1c3RvbVJlc291cmNlID0gbmV3IEN1c3RvbVJlc291cmNlKFxuICAgICAgICBjdXJyZW50LFxuICAgICAgICBcIkF1dG9EZWxldGVPYmplY3RzQ3VzdG9tUmVzb3VyY2VcIixcbiAgICAgICAge1xuICAgICAgICAgIHJlc291cmNlVHlwZTogQVVUT19ERUxFVEVfT0JKRUNUU19SRVNPVVJDRV9UWVBFLFxuICAgICAgICAgIHNlcnZpY2VUb2tlbjogcHJvdmlkZXIuc2VydmljZVRva2VuLFxuICAgICAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgICAgIEJ1Y2tldE5hbWU6IGN1cnJlbnQuYnVja2V0TmFtZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgICApO1xuXG4gICAgICAvLyBFbnN1cmUgYnVja2V0IHBvbGljeSBpcyBkZWxldGVkIEFGVEVSIHRoZSBjdXN0b20gcmVzb3VyY2Ugb3RoZXJ3aXNlXG4gICAgICAvLyB3ZSBkb24ndCBoYXZlIHBlcm1pc3Npb25zIHRvIGxpc3QgYW5kIGRlbGV0ZSBpbiB0aGUgYnVja2V0LlxuICAgICAgLy8gKGFkZCBhIGBpZmAgdG8gbWFrZSBUUyBoYXBweSlcbiAgICAgIGlmIChjdXJyZW50LnBvbGljeSkge1xuICAgICAgICBjdXN0b21SZXNvdXJjZS5ub2RlLmFkZERlcGVuZGVuY3koY3VycmVudC5wb2xpY3kpO1xuICAgICAgfVxuICAgIH1cbiAgICBjdXJyZW50Lm5vZGUuY2hpbGRyZW4uZm9yRWFjaCgocmVzb3VyY2UpID0+XG4gICAgICB0aGlzLmFwcGx5UmVtb3ZhbFBvbGljeShyZXNvdXJjZSwgcG9saWN5KVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyQ29uc3RydWN0cyhjb25zdHJ1Y3Q6IGNkay5JQ29uc3RydWN0KTogdm9pZCB7XG4gICAgaWYgKGNvbnN0cnVjdCBpbnN0YW5jZW9mIENvbnN0cnVjdCkge1xuICAgICAgY29uc3QgdHlwZSA9IGNvbnN0cnVjdC5jb25zdHJ1Y3Rvci5uYW1lO1xuICAgICAgY29uc3Qgc3RhY2sgPSBTdGFjay5vZihjb25zdHJ1Y3QpLm5vZGUuaWQ7XG4gICAgICBjb25zdCBuYW1lID0gY29uc3RydWN0Lm5vZGUuaWQ7XG4gICAgICBjb25zdCBwcm9wcyA9IGNvbnN0cnVjdC5nZXRDb25zdHJ1Y3RJbmZvKCk7XG4gICAgICB0aGlzLmNvbnN0cnVjdHMucHVzaCh7IHR5cGUsIHN0YWNrLCBuYW1lLCBwcm9wcyB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3RydWN0Lm5vZGUuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGQpID0+XG4gICAgICAgIHRoaXMucmVnaXN0ZXJDb25zdHJ1Y3RzKGNoaWxkKVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBzeW50aChvcHRpb25zOiBjZGsuU3RhZ2VTeW50aGVzaXNPcHRpb25zID0ge30pOiBjeGFwaS5DbG91ZEFzc2VtYmx5IHtcbiAgICAvLyBSZWdpc3RlciBjb25zdHJ1Y3RzXG4gICAgdGhpcy5yZWdpc3RlckNvbnN0cnVjdHModGhpcyk7XG5cbiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMubm9kZS5jaGlsZHJlbikge1xuICAgICAgaWYgKGNoaWxkIGluc3RhbmNlb2YgY2RrLlN0YWNrKSB7XG4gICAgICAgIC8vIFNldCByZW1vdmFsIHBvbGljeVxuICAgICAgICBpZiAodGhpcy5fZGVmYXVsdFJlbW92YWxQb2xpY3kpXG4gICAgICAgICAgdGhpcy5hcHBseVJlbW92YWxQb2xpY3koY2hpbGQsIHRoaXMuX2RlZmF1bHRSZW1vdmFsUG9saWN5KTtcblxuICAgICAgICAvLyBTdGFjayBuYW1lcyBuZWVkIHRvIGJlIHBhcmFtZXRlcml6ZWQgd2l0aCB0aGUgc3RhZ2UgbmFtZVxuICAgICAgICBpZiAoXG4gICAgICAgICAgIWNoaWxkLnN0YWNrTmFtZS5zdGFydHNXaXRoKGAke3RoaXMuc3RhZ2V9LWApICYmXG4gICAgICAgICAgIWNoaWxkLnN0YWNrTmFtZS5lbmRzV2l0aChgLSR7dGhpcy5zdGFnZX1gKSAmJlxuICAgICAgICAgIGNoaWxkLnN0YWNrTmFtZS5pbmRleE9mKGAtJHt0aGlzLnN0YWdlfS1gKSA9PT0gLTFcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYFN0YWNrIFwiJHtjaGlsZC5zdGFja05hbWV9XCIgaXMgbm90IHBhcmFtZXRlcml6ZWQgd2l0aCB0aGUgc3RhZ2UgbmFtZS4gVGhlIHN0YWNrIG5hbWUgbmVlZHMgdG8gZWl0aGVyIHN0YXJ0IHdpdGggXCIkc3RhZ2UtXCIsIGVuZCBpbiBcIi0kc3RhZ2VcIiwgb3IgY29udGFpbiB0aGUgc3RhZ2UgbmFtZSBcIi0kc3RhZ2UtXCIuYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBjbG91ZEFzc2VtYmx5ID0gc3VwZXIuc3ludGgob3B0aW9ucyk7XG5cbiAgICAvLyBSdW4gbGludCBhbmQgdHlwZSBjaGVjayBvbiBoYW5kbGVyIGlucHV0IGZpbGVzXG4gICAgLy8gTm90ZTogZG8gbm90IG5lZWQgdG8gcnVuIGluIHR3byBzY2VuYXJpb3M6XG4gICAgLy8gIDEuIGRvIG5vdCBuZWVkIHRvIHJ1biB3aGlsZSBkZWJ1Z2dpbmcgYmVjYXVzZSB0aGUgTGFtYmRhIGZ1bmN0aW9ucyBhcmVcbiAgICAvLyAgICAgcmVwbGFjZWQgYnkgc3R1YnMgYW5kIGhhdmUgbm90IGJlZW4gdHJhbnNwaWxlZC5cbiAgICAvLyAgMi4gZG8gbm90IG5lZWQgdG8gcnVuIHdoaWxlIHJ1bm5pbmcgcmVzb3VyY2VzIHRlc3RzIGJlY2F1c2UgLmVzbGludCBmaWxlXG4gICAgLy8gICAgIGRvZXMgbm90IGV4aXN0IGluc2lkZSAuYnVpbGQgZm9sZGVyLlxuICAgIC8vICAzLiBkbyBub3QgbmVlZCB0byBydW4gaWYgc2tpcEJ1aWxkIGlzIHRydWUsIGllLiBzc3QgcmVtb3ZlXG4gICAgaWYgKCF0aGlzLmxvY2FsICYmICF0aGlzLmlzSmVzdFRlc3QoKSAmJiAhdGhpcy5za2lwQnVpbGQpIHtcbiAgICAgIHRoaXMucHJvY2Vzc0lucHV0RmlsZXMoKTtcbiAgICB9XG5cbiAgICAvLyBSdW4gY2FsbGJhY2sgYWZ0ZXIgc3ludGggaGFzIGZpbmlzaGVkXG4gICAgaWYgKHRoaXMuc3ludGhDYWxsYmFjaykge1xuICAgICAgdGhpcy5zeW50aENhbGxiYWNrKFxuICAgICAgICB0aGlzLmxhbWJkYUhhbmRsZXJzLFxuICAgICAgICB0aGlzLnNpdGVFbnZpcm9ubWVudHMsXG4gICAgICAgIHRoaXMuY29uc3RydWN0c1xuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2xvdWRBc3NlbWJseTtcbiAgfVxuXG4gIGlzSmVzdFRlc3QoKTogYm9vbGVhbiB7XG4gICAgLy8gQ2hlY2sgdGhlIGVudiB2YXIgc2V0IGluc2lkZSB0ZXN0L3NldHVwLXRlc3RzLmpzXG4gICAgcmV0dXJuIHByb2Nlc3MuZW52LkpFU1RfUkVTT1VSQ0VTX1RFU1RTID09PSBcImVuYWJsZWRcIjtcbiAgfVxuXG4gIHJlZ2lzdGVyTGFtYmRhSGFuZGxlcihoYW5kbGVyOiBGdW5jdGlvbkhhbmRsZXJQcm9wcyk6IHZvaWQge1xuICAgIHRoaXMubGFtYmRhSGFuZGxlcnMucHVzaChoYW5kbGVyKTtcbiAgfVxuXG4gIHJlZ2lzdGVyU2l0ZUVudmlyb25tZW50KGVudmlyb25tZW50OiBCYXNlU2l0ZUVudmlyb25tZW50T3V0cHV0c0luZm8pOiB2b2lkIHtcbiAgICB0aGlzLnNpdGVFbnZpcm9ubWVudHMucHVzaChlbnZpcm9ubWVudCk7XG4gIH1cblxuICByZWdpc3RlckNvbnN0cnVjdChjb25zdHJ1Y3Q6IElTc3RDb25zdHJ1Y3QpOiB2b2lkIHtcbiAgICBjb25zdCB0eXBlID0gY29uc3RydWN0LmNvbnN0cnVjdG9yLm5hbWU7XG4gICAgY29uc3Qgc3RhY2sgPSBTdGFjay5vZihjb25zdHJ1Y3QpLm5vZGUuaWQ7XG4gICAgY29uc3QgbmFtZSA9IGNvbnN0cnVjdC5ub2RlLmlkO1xuICAgIGNvbnN0IHByb3BzID0gY29uc3RydWN0LmdldENvbnN0cnVjdEluZm8oKTtcbiAgICB0aGlzLmNvbnN0cnVjdHMucHVzaCh7IHR5cGUsIHN0YWNrLCBuYW1lLCBwcm9wcyB9KTtcbiAgfVxuXG4gIHByb2Nlc3NJbnB1dEZpbGVzKCk6IHZvaWQge1xuICAgIC8vIEdldCBpbnB1dCBmaWxlc1xuICAgIGNvbnN0IGlucHV0RmlsZXNCeVNyY1BhdGg6IHtcbiAgICAgIFtrZXk6IHN0cmluZ106IHsgW2tleTogc3RyaW5nXTogYm9vbGVhbiB9O1xuICAgIH0gPSB7fTtcbiAgICB0aGlzLmxhbWJkYUhhbmRsZXJzLmZvckVhY2goKHsgc3JjUGF0aCwgaGFuZGxlciwgcnVudGltZSB9KSA9PiB7XG4gICAgICBpZiAoIXJ1bnRpbWUuc3RhcnRzV2l0aChcIm5vZGVqc1wiKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG1ldGFmaWxlID0gcGF0aC5qb2luKFxuICAgICAgICBzcmNQYXRoLFxuICAgICAgICB0aGlzLmJ1aWxkRGlyLFxuICAgICAgICBnZXRFc2J1aWxkTWV0YWZpbGVOYW1lKGhhbmRsZXIpXG4gICAgICApO1xuICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLmdldElucHV0RmlsZXNGcm9tRXNidWlsZE1ldGFmaWxlKG1ldGFmaWxlKTtcbiAgICAgIGZpbGVzLmZvckVhY2goKGZpbGUpID0+IHtcbiAgICAgICAgaW5wdXRGaWxlc0J5U3JjUGF0aFtzcmNQYXRoXSA9IGlucHV0RmlsZXNCeVNyY1BhdGhbc3JjUGF0aF0gfHwge307XG4gICAgICAgIGlucHV0RmlsZXNCeVNyY1BhdGhbc3JjUGF0aF1bZmlsZV0gPSB0cnVlO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyBQcm9jZXNzIGVhY2ggc3JjUGF0aFxuICAgIE9iamVjdC5rZXlzKGlucHV0RmlsZXNCeVNyY1BhdGgpLmZvckVhY2goKHNyY1BhdGgpID0+IHtcbiAgICAgIGNvbnN0IGlucHV0RmlsZXMgPSBPYmplY3Qua2V5cyhpbnB1dEZpbGVzQnlTcmNQYXRoW3NyY1BhdGhdKTtcbiAgICAgIGlmICh0aGlzLmxpbnQpIHtcbiAgICAgICAgdGhpcy5ydW5MaW50KHNyY1BhdGgsIGlucHV0RmlsZXMpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMudHlwZUNoZWNrKSB7XG4gICAgICAgIHRoaXMucnVuVHlwZUNoZWNrKHNyY1BhdGgsIGlucHV0RmlsZXMpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZ2V0SW5wdXRGaWxlc0Zyb21Fc2J1aWxkTWV0YWZpbGUoZmlsZTogc3RyaW5nKTogQXJyYXk8c3RyaW5nPiB7XG4gICAgbGV0IG1ldGFKc29uO1xuXG4gICAgdHJ5IHtcbiAgICAgIG1ldGFKc29uID0gZnMucmVhZEpzb25TeW5jKGZpbGUpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGV4aXRXaXRoTWVzc2FnZShcIlRoZXJlIHdhcyBhIHByb2JsZW0gcmVhZGluZyB0aGUgZXNidWlsZCBtZXRhZmlsZS5cIik7XG4gICAgfVxuXG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKG1ldGFKc29uLmlucHV0cykubWFwKChpbnB1dCkgPT4gcGF0aC5yZXNvbHZlKGlucHV0KSk7XG4gIH1cblxuICBydW5MaW50KHNyY1BhdGg6IHN0cmluZywgaW5wdXRGaWxlczogQXJyYXk8c3RyaW5nPik6IHZvaWQge1xuICAgIGlucHV0RmlsZXMgPSBpbnB1dEZpbGVzLmZpbHRlcihcbiAgICAgIChmaWxlOiBzdHJpbmcpID0+XG4gICAgICAgIGZpbGUuaW5kZXhPZihcIm5vZGVfbW9kdWxlc1wiKSA9PT0gLTEgJiZcbiAgICAgICAgKGZpbGUuZW5kc1dpdGgoXCIudHNcIikgfHwgZmlsZS5lbmRzV2l0aChcIi5qc1wiKSlcbiAgICApO1xuXG4gICAgY29uc29sZS5sb2coY2hhbGsuZ3JleShcIkxpbnRpbmcgTGFtYmRhIGZ1bmN0aW9uIHNvdXJjZVwiKSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IHNwYXduLnN5bmMoXG4gICAgICBcIm5vZGVcIixcbiAgICAgIFtcbiAgICAgICAgcGF0aC5qb2luKGFwcFBhdGgsIHRoaXMuYnVpbGREaXIsIFwiZXNsaW50LmpzXCIpLFxuICAgICAgICBwcm9jZXNzLmVudi5OT19DT0xPUiA9PT0gXCJ0cnVlXCIgPyBcIi0tbm8tY29sb3JcIiA6IFwiLS1jb2xvclwiLFxuICAgICAgICAuLi5pbnB1dEZpbGVzLFxuICAgICAgXSxcbiAgICAgIC8vIFVzaW5nIHRoZSBvd25QYXRoIGluc3RlYWQgb2YgdGhlIGFwcFBhdGggYmVjYXVzZSB0aGVyZSBhcmUgY2FzZXNcbiAgICAgIC8vIHdoZXJlIG5wbSBmbGF0dGVucyB0aGUgZGVwZW5kZWNpZXMgYW5kIHRoaXMgY2FzdWVzIGVzbGludCB0byBiZVxuICAgICAgLy8gdW5hYmxlIHRvIGZpbmQgdGhlIHBhcnNlcnMgYW5kIHBsdWdpbnMuIFRoZSBvd25QYXRoIGhhY2sgc2VlbXNcbiAgICAgIC8vIHRvIGZpeCB0aGlzIGlzc3VlLlxuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3NlcnZlcmxlc3Mtc3RhY2svc2VydmVybGVzcy1zdGFjay9wdWxsLzY4XG4gICAgICAvLyBTdGVwcyB0byByZXBsaWNhdGUsIHJlcG86IGh0dHBzOi8vZ2l0aHViLmNvbS9qYXlhaXIvc3N0LWV1LWV4YW1wbGVcbiAgICAgIC8vIERvIGB5YXJuIGFkZCBzdGFuZGFyZCAtRGAgYW5kIGBzc3QgYnVpbGRgXG4gICAgICB7IHN0ZGlvOiBcImluaGVyaXRcIiwgY3dkOiBnZXRTc3RDbGlSb290UGF0aCgpIH1cbiAgICApO1xuXG4gICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7XG4gICAgICBjb25zb2xlLmxvZyhyZXNwb25zZS5lcnJvcik7XG4gICAgICBleGl0V2l0aE1lc3NhZ2UoXCJUaGVyZSB3YXMgYSBwcm9ibGVtIGxpbnRpbmcgdGhlIHNvdXJjZS5cIik7XG4gICAgfSBlbHNlIGlmIChyZXNwb25zZS5zdGRlcnIpIHtcbiAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlLnN0ZGVycik7XG4gICAgICBleGl0V2l0aE1lc3NhZ2UoXCJUaGVyZSB3YXMgYSBwcm9ibGVtIGxpbnRpbmcgdGhlIHNvdXJjZS5cIik7XG4gICAgfSBlbHNlIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDEpIHtcbiAgICAgIGV4aXRXaXRoTWVzc2FnZShcIlRoZXJlIHdhcyBhIHByb2JsZW0gbGludGluZyB0aGUgc291cmNlLlwiKTtcbiAgICB9XG4gIH1cblxuICBydW5UeXBlQ2hlY2soc3JjUGF0aDogc3RyaW5nLCBpbnB1dEZpbGVzOiBBcnJheTxzdHJpbmc+KTogdm9pZCB7XG4gICAgaW5wdXRGaWxlcyA9IGlucHV0RmlsZXMuZmlsdGVyKChmaWxlOiBzdHJpbmcpID0+IGZpbGUuZW5kc1dpdGgoXCIudHNcIikpO1xuXG4gICAgaWYgKGlucHV0RmlsZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coY2hhbGsuZ3JleShcIlR5cGUgY2hlY2tpbmcgTGFtYmRhIGZ1bmN0aW9uIHNvdXJjZVwiKSk7XG5cbiAgICBjb25zdCBoYXNUc2NvbmZpZyA9IGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKHNyY1BhdGgsIFwidHNjb25maWcuanNvblwiKSk7XG5cbiAgICBpZiAoIWhhc1RzY29uZmlnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDYW5ub3QgZmluZCBhIFwidHNjb25maWcuanNvblwiIGluIHRoZSBmdW5jdGlvbidzIHNyY1BhdGg6ICR7cGF0aC5yZXNvbHZlKFxuICAgICAgICAgIHNyY1BhdGhcbiAgICAgICAgKX1gXG4gICAgICApO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdGRvdXQgPSBleGVjU3luYyhcbiAgICAgICAgW1xuICAgICAgICAgIGdldFRzQmluUGF0aCgpLFxuICAgICAgICAgIFwiLS1wcmV0dHlcIixcbiAgICAgICAgICBwcm9jZXNzLmVudi5OT19DT0xPUiA9PT0gXCJ0cnVlXCIgPyBcImZhbHNlXCIgOiBcInRydWVcIixcbiAgICAgICAgICBcIi0tbm9FbWl0XCIsXG4gICAgICAgIF0uam9pbihcIiBcIiksXG4gICAgICAgIHsgY3dkOiBzcmNQYXRoIH1cbiAgICAgICk7XG4gICAgICBjb25zdCBvdXRwdXQgPSBzdGRvdXQudG9TdHJpbmcoKTtcbiAgICAgIGlmIChvdXRwdXQudHJpbSgpICE9PSBcIlwiKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKG91dHB1dCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZTogYW55KSB7XG4gICAgICBjb25zb2xlLmxvZyhlLnN0ZG91dC50b1N0cmluZygpKTtcbiAgICAgIGV4aXRXaXRoTWVzc2FnZShcIlRoZXJlIHdhcyBhIHByb2JsZW0gdHlwZSBjaGVja2luZyB0aGUgc291cmNlLlwiKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==