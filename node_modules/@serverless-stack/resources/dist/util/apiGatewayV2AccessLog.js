"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.cleanupLogGroupName = exports.buildAccessLogData = void 0;
const logs = __importStar(require("@aws-cdk/aws-logs"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2"));
const defaultHttpFields = [
    // request info
    `"requestTime":"$context.requestTime"`,
    `"requestId":"$context.requestId"`,
    `"httpMethod":"$context.httpMethod"`,
    `"path":"$context.path"`,
    `"routeKey":"$context.routeKey"`,
    `"status":$context.status`,
    `"responseLatency":$context.responseLatency`,
    // integration info
    `"integrationRequestId":"$context.integration.requestId"`,
    `"integrationStatus":"$context.integration.status"`,
    `"integrationLatency":"$context.integration.latency"`,
    `"integrationServiceStatus":"$context.integration.integrationStatus"`,
    // caller info
    `"ip":"$context.identity.sourceIp"`,
    `"userAgent":"$context.identity.userAgent"`,
    `"cognitoIdentityId":"$context.identity.cognitoIdentityId"`,
];
const defaultWebSocketFields = [
    // request info
    `"requestTime":"$context.requestTime"`,
    `"requestId":"$context.requestId"`,
    `"eventType":"$context.eventType"`,
    `"routeKey":"$context.routeKey"`,
    `"status":$context.status`,
    // integration info
    `"integrationRequestId":"$context.awsEndpointRequestId"`,
    `"integrationStatus":"$context.integrationStatus"`,
    `"integrationLatency":"$context.integrationLatency"`,
    `"integrationServiceStatus":"$context.integration.integrationStatus"`,
    // caller info
    `"ip":"$context.identity.sourceIp"`,
    `"userAgent":"$context.identity.userAgent"`,
    `"cognitoIdentityId":"$context.identity.cognitoIdentityId"`,
    `"connectedAt":"$context.connectedAt"`,
    `"connectionId":"$context.connectionId"`,
];
function buildAccessLogData(scope, accessLog, apiStage, isDefaultStage) {
    if (accessLog === false) {
        return;
    }
    const isWebSocketApi = apiStage instanceof apig.WebSocketStage;
    // note: Access log configuration is not supported by L2 constructs as of CDK v1.85.0. We
    //       need to define it at L1 construct level.
    // create log group
    let logGroup;
    let destinationArn;
    if (accessLog && accessLog.destinationArn) {
        destinationArn = accessLog.destinationArn;
    }
    else {
        const root = scope.node.root;
        const apiName = root.logicalPrefixedName(scope.node.id);
        // Backwards compatibility, only suffix if not default stage
        const logGroupName = "LogGroup" + (isDefaultStage ? "" : apiStage.stageName);
        const retention = (accessLog && accessLog.retention) || "INFINITE";
        const retentionValue = logs.RetentionDays[retention];
        // validate retention
        if (!retentionValue) {
            throw new Error(`Invalid access log retention value "${retention}".`);
        }
        logGroup = new logs.LogGroup(scope, logGroupName, {
            logGroupName: [
                `/aws/vendedlogs/apis`,
                `/${cleanupLogGroupName(apiName)}-${apiStage.api.apiId}`,
                `/${cleanupLogGroupName(apiStage.stageName)}`,
            ].join(""),
            retention: retentionValue,
        });
        destinationArn = logGroup.logGroupArn;
    }
    // get log format
    let format;
    if (accessLog && accessLog.format) {
        format = accessLog.format;
    }
    else if (typeof accessLog === "string") {
        format = accessLog;
    }
    else {
        format = isWebSocketApi
            ? "{" + defaultWebSocketFields.join(",") + "}"
            : "{" + defaultHttpFields.join(",") + "}";
    }
    // get L1 cfnStage construct
    if (!(apiStage === null || apiStage === void 0 ? void 0 : apiStage.node.defaultChild)) {
        throw new Error(`Failed to define the default stage for Http API`);
    }
    // set access log settings
    const cfnStage = apiStage.node.defaultChild;
    cfnStage.accessLogSettings = { format, destinationArn };
    return logGroup;
}
exports.buildAccessLogData = buildAccessLogData;
function cleanupLogGroupName(str) {
    return str.replace(/[^.\-_/#A-Za-z0-9]/g, "");
}
exports.cleanupLogGroupName = cleanupLogGroupName;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpR2F0ZXdheVYyQWNjZXNzTG9nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvYXBpR2F0ZXdheVYyQWNjZXNzTG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSx3REFBMEM7QUFDMUMsZ0VBQWtEO0FBUWxELE1BQU0saUJBQWlCLEdBQUc7SUFDeEIsZUFBZTtJQUNmLHNDQUFzQztJQUN0QyxrQ0FBa0M7SUFDbEMsb0NBQW9DO0lBQ3BDLHdCQUF3QjtJQUN4QixnQ0FBZ0M7SUFDaEMsMEJBQTBCO0lBQzFCLDRDQUE0QztJQUM1QyxtQkFBbUI7SUFDbkIseURBQXlEO0lBQ3pELG1EQUFtRDtJQUNuRCxxREFBcUQ7SUFDckQscUVBQXFFO0lBQ3JFLGNBQWM7SUFDZCxtQ0FBbUM7SUFDbkMsMkNBQTJDO0lBQzNDLDJEQUEyRDtDQUM1RCxDQUFDO0FBRUYsTUFBTSxzQkFBc0IsR0FBRztJQUM3QixlQUFlO0lBQ2Ysc0NBQXNDO0lBQ3RDLGtDQUFrQztJQUNsQyxrQ0FBa0M7SUFDbEMsZ0NBQWdDO0lBQ2hDLDBCQUEwQjtJQUMxQixtQkFBbUI7SUFDbkIsd0RBQXdEO0lBQ3hELGtEQUFrRDtJQUNsRCxvREFBb0Q7SUFDcEQscUVBQXFFO0lBQ3JFLGNBQWM7SUFDZCxtQ0FBbUM7SUFDbkMsMkNBQTJDO0lBQzNDLDJEQUEyRDtJQUMzRCxzQ0FBc0M7SUFDdEMsd0NBQXdDO0NBQ3pDLENBQUM7QUFFRixTQUFnQixrQkFBa0IsQ0FDaEMsS0FBb0IsRUFDcEIsU0FBd0QsRUFDeEQsUUFBOEMsRUFDOUMsY0FBdUI7SUFFdkIsSUFBSSxTQUFTLEtBQUssS0FBSyxFQUFFO1FBQ3ZCLE9BQU87S0FDUjtJQUVELE1BQU0sY0FBYyxHQUFHLFFBQVEsWUFBWSxJQUFJLENBQUMsY0FBYyxDQUFDO0lBRS9ELHlGQUF5RjtJQUN6RixpREFBaUQ7SUFFakQsbUJBQW1CO0lBQ25CLElBQUksUUFBUSxDQUFDO0lBQ2IsSUFBSSxjQUFjLENBQUM7SUFDbkIsSUFBSSxTQUFTLElBQUssU0FBNEIsQ0FBQyxjQUFjLEVBQUU7UUFDN0QsY0FBYyxHQUFJLFNBQTRCLENBQUMsY0FBYyxDQUFDO0tBQy9EO1NBQU07UUFDTCxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN4RCw0REFBNEQ7UUFDNUQsTUFBTSxZQUFZLEdBQ2hCLFVBQVUsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDMUQsTUFBTSxTQUFTLEdBQ2IsQ0FBQyxTQUFTLElBQUssU0FBNEIsQ0FBQyxTQUFTLENBQUMsSUFBSSxVQUFVLENBQUM7UUFDdkUsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUVyRCxxQkFBcUI7UUFDckIsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLHVDQUF1QyxTQUFTLElBQUksQ0FBQyxDQUFDO1NBQ3ZFO1FBRUQsUUFBUSxHQUFHLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsWUFBWSxFQUFFO1lBQ2hELFlBQVksRUFBRTtnQkFDWixzQkFBc0I7Z0JBQ3RCLElBQUksbUJBQW1CLENBQUMsT0FBTyxDQUFDLElBQUksUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUU7Z0JBQ3hELElBQUksbUJBQW1CLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFFO2FBQzlDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNWLFNBQVMsRUFBRSxjQUFjO1NBQzFCLENBQUMsQ0FBQztRQUNILGNBQWMsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDO0tBQ3ZDO0lBRUQsaUJBQWlCO0lBQ2pCLElBQUksTUFBTSxDQUFDO0lBQ1gsSUFBSSxTQUFTLElBQUssU0FBNEIsQ0FBQyxNQUFNLEVBQUU7UUFDckQsTUFBTSxHQUFJLFNBQTRCLENBQUMsTUFBTSxDQUFDO0tBQy9DO1NBQU0sSUFBSSxPQUFPLFNBQVMsS0FBSyxRQUFRLEVBQUU7UUFDeEMsTUFBTSxHQUFHLFNBQVMsQ0FBQztLQUNwQjtTQUFNO1FBQ0wsTUFBTSxHQUFHLGNBQWM7WUFDckIsQ0FBQyxDQUFDLEdBQUcsR0FBRyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRztZQUM5QyxDQUFDLENBQUMsR0FBRyxHQUFHLGlCQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7S0FDN0M7SUFFRCw0QkFBNEI7SUFDNUIsSUFBSSxDQUFDLENBQUEsUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLElBQUksQ0FBQyxZQUFZLENBQUEsRUFBRTtRQUNoQyxNQUFNLElBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7S0FDcEU7SUFFRCwwQkFBMEI7SUFDMUIsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxZQUE2QixDQUFDO0lBQzdELFFBQVEsQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsQ0FBQztJQUV4RCxPQUFPLFFBQVEsQ0FBQztBQUNsQixDQUFDO0FBcEVELGdEQW9FQztBQUVELFNBQWdCLG1CQUFtQixDQUFDLEdBQVc7SUFDN0MsT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLHFCQUFxQixFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ2hELENBQUM7QUFGRCxrREFFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0ICogYXMgbG9ncyBmcm9tIFwiQGF3cy1jZGsvYXdzLWxvZ3NcIjtcbmltcG9ydCAqIGFzIGFwaWcgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djJcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuLi9BcHBcIjtcblxuZXhwb3J0IGludGVyZmFjZSBBY2Nlc3NMb2dQcm9wc1xuICBleHRlbmRzIGFwaWcuQ2ZuU3RhZ2UuQWNjZXNzTG9nU2V0dGluZ3NQcm9wZXJ0eSB7XG4gIHJldGVudGlvbj86IGtleW9mIHR5cGVvZiBsb2dzLlJldGVudGlvbkRheXM7XG59XG5cbmNvbnN0IGRlZmF1bHRIdHRwRmllbGRzID0gW1xuICAvLyByZXF1ZXN0IGluZm9cbiAgYFwicmVxdWVzdFRpbWVcIjpcIiRjb250ZXh0LnJlcXVlc3RUaW1lXCJgLFxuICBgXCJyZXF1ZXN0SWRcIjpcIiRjb250ZXh0LnJlcXVlc3RJZFwiYCxcbiAgYFwiaHR0cE1ldGhvZFwiOlwiJGNvbnRleHQuaHR0cE1ldGhvZFwiYCxcbiAgYFwicGF0aFwiOlwiJGNvbnRleHQucGF0aFwiYCxcbiAgYFwicm91dGVLZXlcIjpcIiRjb250ZXh0LnJvdXRlS2V5XCJgLFxuICBgXCJzdGF0dXNcIjokY29udGV4dC5zdGF0dXNgLCAvLyBpbnRlZ2VyIHZhbHVlLCBkbyBub3Qgd3JhcCBpbiBxdW90ZXNcbiAgYFwicmVzcG9uc2VMYXRlbmN5XCI6JGNvbnRleHQucmVzcG9uc2VMYXRlbmN5YCwgLy8gaW50ZWdlciB2YWx1ZSwgZG8gbm90IHdyYXAgaW4gcXVvdGVzXG4gIC8vIGludGVncmF0aW9uIGluZm9cbiAgYFwiaW50ZWdyYXRpb25SZXF1ZXN0SWRcIjpcIiRjb250ZXh0LmludGVncmF0aW9uLnJlcXVlc3RJZFwiYCxcbiAgYFwiaW50ZWdyYXRpb25TdGF0dXNcIjpcIiRjb250ZXh0LmludGVncmF0aW9uLnN0YXR1c1wiYCxcbiAgYFwiaW50ZWdyYXRpb25MYXRlbmN5XCI6XCIkY29udGV4dC5pbnRlZ3JhdGlvbi5sYXRlbmN5XCJgLFxuICBgXCJpbnRlZ3JhdGlvblNlcnZpY2VTdGF0dXNcIjpcIiRjb250ZXh0LmludGVncmF0aW9uLmludGVncmF0aW9uU3RhdHVzXCJgLFxuICAvLyBjYWxsZXIgaW5mb1xuICBgXCJpcFwiOlwiJGNvbnRleHQuaWRlbnRpdHkuc291cmNlSXBcImAsXG4gIGBcInVzZXJBZ2VudFwiOlwiJGNvbnRleHQuaWRlbnRpdHkudXNlckFnZW50XCJgLFxuICBgXCJjb2duaXRvSWRlbnRpdHlJZFwiOlwiJGNvbnRleHQuaWRlbnRpdHkuY29nbml0b0lkZW50aXR5SWRcImAsXG5dO1xuXG5jb25zdCBkZWZhdWx0V2ViU29ja2V0RmllbGRzID0gW1xuICAvLyByZXF1ZXN0IGluZm9cbiAgYFwicmVxdWVzdFRpbWVcIjpcIiRjb250ZXh0LnJlcXVlc3RUaW1lXCJgLFxuICBgXCJyZXF1ZXN0SWRcIjpcIiRjb250ZXh0LnJlcXVlc3RJZFwiYCxcbiAgYFwiZXZlbnRUeXBlXCI6XCIkY29udGV4dC5ldmVudFR5cGVcImAsXG4gIGBcInJvdXRlS2V5XCI6XCIkY29udGV4dC5yb3V0ZUtleVwiYCxcbiAgYFwic3RhdHVzXCI6JGNvbnRleHQuc3RhdHVzYCwgLy8gaW50ZWdlciB2YWx1ZSwgZG8gbm90IHdyYXAgaW4gcXVvdGVzXG4gIC8vIGludGVncmF0aW9uIGluZm9cbiAgYFwiaW50ZWdyYXRpb25SZXF1ZXN0SWRcIjpcIiRjb250ZXh0LmF3c0VuZHBvaW50UmVxdWVzdElkXCJgLFxuICBgXCJpbnRlZ3JhdGlvblN0YXR1c1wiOlwiJGNvbnRleHQuaW50ZWdyYXRpb25TdGF0dXNcImAsXG4gIGBcImludGVncmF0aW9uTGF0ZW5jeVwiOlwiJGNvbnRleHQuaW50ZWdyYXRpb25MYXRlbmN5XCJgLFxuICBgXCJpbnRlZ3JhdGlvblNlcnZpY2VTdGF0dXNcIjpcIiRjb250ZXh0LmludGVncmF0aW9uLmludGVncmF0aW9uU3RhdHVzXCJgLFxuICAvLyBjYWxsZXIgaW5mb1xuICBgXCJpcFwiOlwiJGNvbnRleHQuaWRlbnRpdHkuc291cmNlSXBcImAsXG4gIGBcInVzZXJBZ2VudFwiOlwiJGNvbnRleHQuaWRlbnRpdHkudXNlckFnZW50XCJgLFxuICBgXCJjb2duaXRvSWRlbnRpdHlJZFwiOlwiJGNvbnRleHQuaWRlbnRpdHkuY29nbml0b0lkZW50aXR5SWRcImAsXG4gIGBcImNvbm5lY3RlZEF0XCI6XCIkY29udGV4dC5jb25uZWN0ZWRBdFwiYCxcbiAgYFwiY29ubmVjdGlvbklkXCI6XCIkY29udGV4dC5jb25uZWN0aW9uSWRcImAsXG5dO1xuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRBY2Nlc3NMb2dEYXRhKFxuICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgYWNjZXNzTG9nOiBib29sZWFuIHwgc3RyaW5nIHwgQWNjZXNzTG9nUHJvcHMgfCB1bmRlZmluZWQsXG4gIGFwaVN0YWdlOiBhcGlnLldlYlNvY2tldFN0YWdlIHwgYXBpZy5IdHRwU3RhZ2UsXG4gIGlzRGVmYXVsdFN0YWdlOiBib29sZWFuXG4pOiBsb2dzLkxvZ0dyb3VwIHwgdW5kZWZpbmVkIHtcbiAgaWYgKGFjY2Vzc0xvZyA9PT0gZmFsc2UpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBpc1dlYlNvY2tldEFwaSA9IGFwaVN0YWdlIGluc3RhbmNlb2YgYXBpZy5XZWJTb2NrZXRTdGFnZTtcblxuICAvLyBub3RlOiBBY2Nlc3MgbG9nIGNvbmZpZ3VyYXRpb24gaXMgbm90IHN1cHBvcnRlZCBieSBMMiBjb25zdHJ1Y3RzIGFzIG9mIENESyB2MS44NS4wLiBXZVxuICAvLyAgICAgICBuZWVkIHRvIGRlZmluZSBpdCBhdCBMMSBjb25zdHJ1Y3QgbGV2ZWwuXG5cbiAgLy8gY3JlYXRlIGxvZyBncm91cFxuICBsZXQgbG9nR3JvdXA7XG4gIGxldCBkZXN0aW5hdGlvbkFybjtcbiAgaWYgKGFjY2Vzc0xvZyAmJiAoYWNjZXNzTG9nIGFzIEFjY2Vzc0xvZ1Byb3BzKS5kZXN0aW5hdGlvbkFybikge1xuICAgIGRlc3RpbmF0aW9uQXJuID0gKGFjY2Vzc0xvZyBhcyBBY2Nlc3NMb2dQcm9wcykuZGVzdGluYXRpb25Bcm47XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3QgYXBpTmFtZSA9IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShzY29wZS5ub2RlLmlkKTtcbiAgICAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgb25seSBzdWZmaXggaWYgbm90IGRlZmF1bHQgc3RhZ2VcbiAgICBjb25zdCBsb2dHcm91cE5hbWUgPVxuICAgICAgXCJMb2dHcm91cFwiICsgKGlzRGVmYXVsdFN0YWdlID8gXCJcIiA6IGFwaVN0YWdlLnN0YWdlTmFtZSk7XG4gICAgY29uc3QgcmV0ZW50aW9uID1cbiAgICAgIChhY2Nlc3NMb2cgJiYgKGFjY2Vzc0xvZyBhcyBBY2Nlc3NMb2dQcm9wcykucmV0ZW50aW9uKSB8fCBcIklORklOSVRFXCI7XG4gICAgY29uc3QgcmV0ZW50aW9uVmFsdWUgPSBsb2dzLlJldGVudGlvbkRheXNbcmV0ZW50aW9uXTtcblxuICAgIC8vIHZhbGlkYXRlIHJldGVudGlvblxuICAgIGlmICghcmV0ZW50aW9uVmFsdWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBhY2Nlc3MgbG9nIHJldGVudGlvbiB2YWx1ZSBcIiR7cmV0ZW50aW9ufVwiLmApO1xuICAgIH1cblxuICAgIGxvZ0dyb3VwID0gbmV3IGxvZ3MuTG9nR3JvdXAoc2NvcGUsIGxvZ0dyb3VwTmFtZSwge1xuICAgICAgbG9nR3JvdXBOYW1lOiBbXG4gICAgICAgIGAvYXdzL3ZlbmRlZGxvZ3MvYXBpc2AsXG4gICAgICAgIGAvJHtjbGVhbnVwTG9nR3JvdXBOYW1lKGFwaU5hbWUpfS0ke2FwaVN0YWdlLmFwaS5hcGlJZH1gLFxuICAgICAgICBgLyR7Y2xlYW51cExvZ0dyb3VwTmFtZShhcGlTdGFnZS5zdGFnZU5hbWUpfWAsXG4gICAgICBdLmpvaW4oXCJcIiksXG4gICAgICByZXRlbnRpb246IHJldGVudGlvblZhbHVlLFxuICAgIH0pO1xuICAgIGRlc3RpbmF0aW9uQXJuID0gbG9nR3JvdXAubG9nR3JvdXBBcm47XG4gIH1cblxuICAvLyBnZXQgbG9nIGZvcm1hdFxuICBsZXQgZm9ybWF0O1xuICBpZiAoYWNjZXNzTG9nICYmIChhY2Nlc3NMb2cgYXMgQWNjZXNzTG9nUHJvcHMpLmZvcm1hdCkge1xuICAgIGZvcm1hdCA9IChhY2Nlc3NMb2cgYXMgQWNjZXNzTG9nUHJvcHMpLmZvcm1hdDtcbiAgfSBlbHNlIGlmICh0eXBlb2YgYWNjZXNzTG9nID09PSBcInN0cmluZ1wiKSB7XG4gICAgZm9ybWF0ID0gYWNjZXNzTG9nO1xuICB9IGVsc2Uge1xuICAgIGZvcm1hdCA9IGlzV2ViU29ja2V0QXBpXG4gICAgICA/IFwie1wiICsgZGVmYXVsdFdlYlNvY2tldEZpZWxkcy5qb2luKFwiLFwiKSArIFwifVwiXG4gICAgICA6IFwie1wiICsgZGVmYXVsdEh0dHBGaWVsZHMuam9pbihcIixcIikgKyBcIn1cIjtcbiAgfVxuXG4gIC8vIGdldCBMMSBjZm5TdGFnZSBjb25zdHJ1Y3RcbiAgaWYgKCFhcGlTdGFnZT8ubm9kZS5kZWZhdWx0Q2hpbGQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBkZWZpbmUgdGhlIGRlZmF1bHQgc3RhZ2UgZm9yIEh0dHAgQVBJYCk7XG4gIH1cblxuICAvLyBzZXQgYWNjZXNzIGxvZyBzZXR0aW5nc1xuICBjb25zdCBjZm5TdGFnZSA9IGFwaVN0YWdlLm5vZGUuZGVmYXVsdENoaWxkIGFzIGFwaWcuQ2ZuU3RhZ2U7XG4gIGNmblN0YWdlLmFjY2Vzc0xvZ1NldHRpbmdzID0geyBmb3JtYXQsIGRlc3RpbmF0aW9uQXJuIH07XG5cbiAgcmV0dXJuIGxvZ0dyb3VwO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2xlYW51cExvZ0dyb3VwTmFtZShzdHI6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBzdHIucmVwbGFjZSgvW14uXFwtXy8jQS1aYS16MC05XS9nLCBcIlwiKTtcbn1cbiJdfQ==