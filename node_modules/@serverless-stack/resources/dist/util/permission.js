"use strict";
/* eslint-disable @typescript-eslint/ban-ts-comment*/
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.attachPermissionsToRole = exports.PermissionType = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const iam = __importStar(require("@aws-cdk/aws-iam"));
const core_1 = require("@serverless-stack/core");
const index_1 = require("../index");
const construct_1 = require("./construct");
const logger = (0, core_1.getChildLogger)("resources");
var PermissionType;
(function (PermissionType) {
    PermissionType["ALL"] = "*";
})(PermissionType = exports.PermissionType || (exports.PermissionType = {}));
function attachPermissionsToRole(role, permissions) {
    // Four patterns
    //
    // attachPermissions(PermissionType.ALL);
    // attachPermissions([ 'sns', 'sqs' ]);
    // attachPermissions([ event, queue ]);
    // attachPermissions([
    //   [ event.snsTopic, 'grantPublish' ],
    //   [ queue.sqsQueue, 'grantSendMessages' ],
    // ]);
    // attachPermissions([
    //   new iam.PolicyStatement({
    //     actions: ["s3:*"],
    //     effect: iam.Effect.ALLOW,
    //     resources: [
    //       bucket.bucketArn + "/private/${cognito-identity.amazonaws.com:sub}/*",
    //     ],
    //   })
    // ]);
    ////////////////////////////////////
    // Case: 'admin' permissions => '*'
    ////////////////////////////////////
    if (typeof permissions === "string") {
        if (permissions === PermissionType.ALL) {
            role.addToPolicy(buildPolicy(permissions, ["*"]));
        }
        else {
            throw new Error(`The specified permissions are not supported.`);
        }
        return;
    }
    if (!Array.isArray(permissions)) {
        throw new Error(`The specified permissions are not supported. They are expected to be PermissionType.ALL or an array.`);
    }
    // Handle array of permissions
    permissions.forEach((permission) => {
        ////////////////////////////////////
        // Case: string ie. 's3' or 's3:*'
        ////////////////////////////////////
        if (typeof permission === "string") {
            const perm = permission.indexOf(":") === -1 ? `${permission}:*` : permission;
            role.addToPolicy(buildPolicy(perm, ["*"]));
        }
        ////////////////////////////////////
        // Case: iam.PolicyStatement
        ////////////////////////////////////
        else if ((0, construct_1.isConstructOf)(permission, "aws-iam.PolicyStatement")) {
            role.addToPolicy(permission);
        }
        ////////////////////////////////////
        // Case: CDK constructs
        ////////////////////////////////////
        else if ((0, construct_1.isConstructOf)(permission, "aws-dynamodb.Table")) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            const tableArn = permission.tableArn;
            role.addToPolicy(buildPolicy("dynamodb:*", [tableArn, `${tableArn}/*`]));
        }
        else if ((0, construct_1.isConstructOf)(permission, "aws-sns.Topic")) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("sns:*", [permission.topicArn]));
        }
        else if ((0, construct_1.isConstructOf)(permission, "aws-sqs.Queue")) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("sqs:*", [permission.queueArn]));
        }
        else if ((0, construct_1.isConstructOf)(permission, "aws-events.EventBus")) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("events:*", [permission.eventBusArn]));
        }
        else if ((0, construct_1.isConstructOf)(permission, "aws-kinesis.Stream")) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("kinesis:*", [permission.streamArn]));
        }
        else if ((0, construct_1.isConstructOf)(permission, "aws-s3.Bucket")) {
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            const bucketArn = permission.bucketArn;
            role.addToPolicy(buildPolicy("s3:*", [bucketArn, `${bucketArn}/*`]));
        }
        else if ((0, construct_1.isConstructOf)(permission, "aws-rds.ServerlessCluster")) {
            // For ServerlessCluster, we need to grant:
            // - permisssions to access the Data API;
            // - permisssions to access the Secret Manager (required by Data API).
            // No need to grant the permissions for IAM database authentication
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            role.addToPolicy(buildPolicy("rds-data:*", [permission.clusterArn]));
            // @ts-expect-error We do not want to import the cdk modules, just cast to any
            const secret = permission.secret;
            if (secret) {
                role.addToPolicy(buildPolicy("secretsmanager:GetSecretValue", [secret.secretArn]));
            }
        }
        ////////////////////////////////////
        // Case: SST construct
        ////////////////////////////////////
        else if (permission instanceof index_1.Api) {
            const httpApi = permission.httpApi;
            const { account, region } = index_1.Stack.of(httpApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${httpApi.httpApiId}/*`,
            ]));
        }
        else if (permission instanceof index_1.ApiGatewayV1Api) {
            const restApi = permission.restApi;
            const { account, region } = index_1.Stack.of(restApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${restApi.restApiId}/*`,
            ]));
        }
        else if (permission instanceof index_1.WebSocketApi) {
            const webSocketApi = permission.webSocketApi;
            const { account, region } = index_1.Stack.of(webSocketApi);
            role.addToPolicy(buildPolicy("execute-api:Invoke", [
                `arn:aws:execute-api:${region}:${account}:${webSocketApi.apiId}/*`,
            ]));
            role.addToPolicy(buildPolicy("execute-api:ManageConnections", [
                permission._connectionsArn,
            ]));
        }
        else if (permission instanceof index_1.AppSyncApi) {
            const graphqlApi = permission.graphqlApi;
            const { account, region } = index_1.Stack.of(graphqlApi);
            role.addToPolicy(buildPolicy("appsync:GraphQL", [
                `arn:aws:appsync:${region}:${account}:apis/${graphqlApi.apiId}/*`,
            ]));
        }
        else if (permission instanceof index_1.Table) {
            const tableArn = permission.dynamodbTable.tableArn;
            role.addToPolicy(buildPolicy("dynamodb:*", [tableArn, `${tableArn}/*`]));
        }
        else if (permission instanceof index_1.Topic) {
            role.addToPolicy(buildPolicy("sns:*", [permission.snsTopic.topicArn]));
        }
        else if (permission instanceof index_1.Queue) {
            role.addToPolicy(buildPolicy("sqs:*", [permission.sqsQueue.queueArn]));
        }
        else if (permission instanceof index_1.EventBus) {
            role.addToPolicy(buildPolicy("events:*", [permission.eventBridgeEventBus.eventBusArn]));
        }
        else if (permission instanceof index_1.KinesisStream) {
            role.addToPolicy(buildPolicy("kinesis:*", [permission.kinesisStream.streamArn]));
        }
        else if (permission instanceof index_1.Bucket) {
            const bucketArn = permission.s3Bucket.bucketArn;
            role.addToPolicy(buildPolicy("s3:*", [bucketArn, `${bucketArn}/*`]));
        }
        else if (permission instanceof index_1.Function) {
            role.addToPolicy(buildPolicy("lambda:*", [permission.functionArn]));
        }
        ////////////////////////////////////
        // Case: grant method
        ////////////////////////////////////
        else if (Array.isArray(permission) &&
            permission.length === 2 &&
            cdk.Construct.isConstruct(permission[0]) &&
            typeof permission[1] === "string") {
            const construct = permission[0];
            const methodName = permission[1];
            if (typeof construct[methodName] !== "function")
                throw new Error(`The specified grant method is incorrect.
          Check the available methods that prefixed with grants on the Construct`);
            construct[methodName](role);
        }
        else {
            logger.debug("permission object", permission);
            throw new Error(`The specified permissions are not supported.`);
        }
    });
}
exports.attachPermissionsToRole = attachPermissionsToRole;
function buildPolicy(action, resources) {
    return new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        actions: [action],
        resources,
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3Blcm1pc3Npb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHFEQUFxRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVyRCxtREFBcUM7QUFDckMsc0RBQXdDO0FBQ3hDLGlEQUF3RDtBQUN4RCxvQ0Fha0I7QUFDbEIsMkNBQTRDO0FBRTVDLE1BQU0sTUFBTSxHQUFHLElBQUEscUJBQWMsRUFBQyxXQUFXLENBQUMsQ0FBQztBQVMzQyxJQUFZLGNBRVg7QUFGRCxXQUFZLGNBQWM7SUFDeEIsMkJBQVMsQ0FBQTtBQUNYLENBQUMsRUFGVyxjQUFjLEdBQWQsc0JBQWMsS0FBZCxzQkFBYyxRQUV6QjtBQUVELFNBQWdCLHVCQUF1QixDQUNyQyxJQUFjLEVBQ2QsV0FBd0I7SUFFeEIsZ0JBQWdCO0lBQ2hCLEVBQUU7SUFDRix5Q0FBeUM7SUFDekMsdUNBQXVDO0lBQ3ZDLHVDQUF1QztJQUN2QyxzQkFBc0I7SUFDdEIsd0NBQXdDO0lBQ3hDLDZDQUE2QztJQUM3QyxNQUFNO0lBQ04sc0JBQXNCO0lBQ3RCLDhCQUE4QjtJQUM5Qix5QkFBeUI7SUFDekIsZ0NBQWdDO0lBQ2hDLG1CQUFtQjtJQUNuQiwrRUFBK0U7SUFDL0UsU0FBUztJQUNULE9BQU87SUFDUCxNQUFNO0lBRU4sb0NBQW9DO0lBQ3BDLG1DQUFtQztJQUNuQyxvQ0FBb0M7SUFDcEMsSUFBSSxPQUFPLFdBQVcsS0FBSyxRQUFRLEVBQUU7UUFDbkMsSUFBSSxXQUFXLEtBQUssY0FBYyxDQUFDLEdBQUcsRUFBRTtZQUN0QyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbkQ7YUFBTTtZQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsOENBQThDLENBQUMsQ0FBQztTQUNqRTtRQUNELE9BQU87S0FDUjtJQUVELElBQUks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RUFDakM7WUFDQSxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFrQixDQUFDO1lBQ2pELE1BQU0sVUFBVSxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQXdCLENBQUM7WUFDeEQsSUFBSSxPQUFPLFNBQVMsQ0FBQyxVQUFVLENBQUMsS0FBSyxVQUFVO2dCQUM3QyxNQUFNLElBQUksS0FBSyxDQUNiO2lGQUN1RSxDQUN4RSxDQUFDO1lBQ0gsU0FBUyxDQUFDLFVBQVUsQ0FBMEMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN2RTthQUFNO1lBQ0wsTUFBTSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUM5QyxNQUFNLElBQUksS0FBSyxDQUFDLDhDQUE4QyxDQUFDLENBQUM7U0FDakU7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUExTEQsMERBMExDO0FBRUQsU0FBUyxXQUFXLENBQUMsTUFBYyxFQUFFLFNBQW1CO0lBQ3RELE9BQU8sSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO1FBQzdCLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUs7UUFDeEIsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDO1FBQ2pCLFNBQVM7S0FDVixDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50Ki9cblxuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcIkBhd3MtY2RrL2F3cy1pYW1cIjtcbmltcG9ydCB7IGdldENoaWxkTG9nZ2VyIH0gZnJvbSBcIkBzZXJ2ZXJsZXNzLXN0YWNrL2NvcmVcIjtcbmltcG9ydCB7XG4gIEFwaSxcbiAgVGFibGUsXG4gIFRvcGljLFxuICBRdWV1ZSxcbiAgQnVja2V0LFxuICBFdmVudEJ1cyxcbiAgRnVuY3Rpb24sXG4gIEFwcFN5bmNBcGksXG4gIFdlYlNvY2tldEFwaSxcbiAgS2luZXNpc1N0cmVhbSxcbiAgQXBpR2F0ZXdheVYxQXBpLFxuICBTdGFjayxcbn0gZnJvbSBcIi4uL2luZGV4XCI7XG5pbXBvcnQgeyBpc0NvbnN0cnVjdE9mIH0gZnJvbSBcIi4vY29uc3RydWN0XCI7XG5cbmNvbnN0IGxvZ2dlciA9IGdldENoaWxkTG9nZ2VyKFwicmVzb3VyY2VzXCIpO1xuXG5leHBvcnQgdHlwZSBQZXJtaXNzaW9ucyA9IFBlcm1pc3Npb25UeXBlIHwgUGVybWlzc2lvbltdO1xudHlwZSBQZXJtaXNzaW9uID1cbiAgfCBzdHJpbmdcbiAgfCBjZGsuQ29uc3RydWN0XG4gIHwgW2Nkay5Db25zdHJ1Y3QsIHN0cmluZ11cbiAgfCBpYW0uUG9saWN5U3RhdGVtZW50O1xuXG5leHBvcnQgZW51bSBQZXJtaXNzaW9uVHlwZSB7XG4gIEFMTCA9IFwiKlwiLFxufVxuXG5leHBvcnQgZnVuY3Rpb24gYXR0YWNoUGVybWlzc2lvbnNUb1JvbGUoXG4gIHJvbGU6IGlhbS5Sb2xlLFxuICBwZXJtaXNzaW9uczogUGVybWlzc2lvbnNcbik6IHZvaWQge1xuICAvLyBGb3VyIHBhdHRlcm5zXG4gIC8vXG4gIC8vIGF0dGFjaFBlcm1pc3Npb25zKFBlcm1pc3Npb25UeXBlLkFMTCk7XG4gIC8vIGF0dGFjaFBlcm1pc3Npb25zKFsgJ3NucycsICdzcXMnIF0pO1xuICAvLyBhdHRhY2hQZXJtaXNzaW9ucyhbIGV2ZW50LCBxdWV1ZSBdKTtcbiAgLy8gYXR0YWNoUGVybWlzc2lvbnMoW1xuICAvLyAgIFsgZXZlbnQuc25zVG9waWMsICdncmFudFB1Ymxpc2gnIF0sXG4gIC8vICAgWyBxdWV1ZS5zcXNRdWV1ZSwgJ2dyYW50U2VuZE1lc3NhZ2VzJyBdLFxuICAvLyBdKTtcbiAgLy8gYXR0YWNoUGVybWlzc2lvbnMoW1xuICAvLyAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgLy8gICAgIGFjdGlvbnM6IFtcInMzOipcIl0sXG4gIC8vICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gIC8vICAgICByZXNvdXJjZXM6IFtcbiAgLy8gICAgICAgYnVja2V0LmJ1Y2tldEFybiArIFwiL3ByaXZhdGUvJHtjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206c3VifS8qXCIsXG4gIC8vICAgICBdLFxuICAvLyAgIH0pXG4gIC8vIF0pO1xuXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAvLyBDYXNlOiAnYWRtaW4nIHBlcm1pc3Npb25zID0+ICcqJ1xuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgaWYgKHR5cGVvZiBwZXJtaXNzaW9ucyA9PT0gXCJzdHJpbmdcIikge1xuICAgIGlmIChwZXJtaXNzaW9ucyA9PT0gUGVybWlzc2lvblR5cGUuQUxMKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KHBlcm1pc3Npb25zLCBbXCIqXCJdKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHNwZWNpZmllZCBwZXJtaXNzaW9ucyBhcmUgbm90IHN1cHBvcnRlZC5gKTtcbiAgICB9XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKCFBcnJheS5pc0FycmF5KHBlcm1pc3Npb25zKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBUaGUgc3BlY2lmaWVkIHBlcm1pc3Npb25zIGFyZSBub3Qgc3VwcG9ydGVkLiBUaGV5IGFyZSBleHBlY3RlZCB0byBiZSBQZXJtaXNzaW9uVHlwZS5BTEwgb3IgYW4gYXJyYXkuYFxuICAgICk7XG4gIH1cblxuICAvLyBIYW5kbGUgYXJyYXkgb2YgcGVybWlzc2lvbnNcbiAgcGVybWlzc2lvbnMuZm9yRWFjaCgocGVybWlzc2lvbjogUGVybWlzc2lvbikgPT4ge1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENhc2U6IHN0cmluZyBpZS4gJ3MzJyBvciAnczM6KidcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBpZiAodHlwZW9mIHBlcm1pc3Npb24gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGNvbnN0IHBlcm0gPVxuICAgICAgICBwZXJtaXNzaW9uLmluZGV4T2YoXCI6XCIpID09PSAtMSA/IGAke3Blcm1pc3Npb259OipgIDogcGVybWlzc2lvbjtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3kocGVybSwgW1wiKlwiXSkpO1xuICAgIH1cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDYXNlOiBpYW0uUG9saWN5U3RhdGVtZW50XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgZWxzZSBpZiAoXG4gICAgICBpc0NvbnN0cnVjdE9mKHBlcm1pc3Npb24gYXMgY2RrLkNvbnN0cnVjdCwgXCJhd3MtaWFtLlBvbGljeVN0YXRlbWVudFwiKVxuICAgICkge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShwZXJtaXNzaW9uIGFzIGlhbS5Qb2xpY3lTdGF0ZW1lbnQpO1xuICAgIH1cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDYXNlOiBDREsgY29uc3RydWN0c1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGVsc2UgaWYgKGlzQ29uc3RydWN0T2YocGVybWlzc2lvbiBhcyBjZGsuQ29uc3RydWN0LCBcImF3cy1keW5hbW9kYi5UYWJsZVwiKSkge1xuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBXZSBkbyBub3Qgd2FudCB0byBpbXBvcnQgdGhlIGNkayBtb2R1bGVzLCBqdXN0IGNhc3QgdG8gYW55XG4gICAgICBjb25zdCB0YWJsZUFybiA9IHBlcm1pc3Npb24udGFibGVBcm47XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwiZHluYW1vZGI6KlwiLCBbdGFibGVBcm4sIGAke3RhYmxlQXJufS8qYF0pKTtcbiAgICB9IGVsc2UgaWYgKGlzQ29uc3RydWN0T2YocGVybWlzc2lvbiBhcyBjZGsuQ29uc3RydWN0LCBcImF3cy1zbnMuVG9waWNcIikpIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInNuczoqXCIsIFtwZXJtaXNzaW9uLnRvcGljQXJuXSkpO1xuICAgIH0gZWxzZSBpZiAoaXNDb25zdHJ1Y3RPZihwZXJtaXNzaW9uIGFzIGNkay5Db25zdHJ1Y3QsIFwiYXdzLXNxcy5RdWV1ZVwiKSkge1xuICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBXZSBkbyBub3Qgd2FudCB0byBpbXBvcnQgdGhlIGNkayBtb2R1bGVzLCBqdXN0IGNhc3QgdG8gYW55XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwic3FzOipcIiwgW3Blcm1pc3Npb24ucXVldWVBcm5dKSk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIGlzQ29uc3RydWN0T2YocGVybWlzc2lvbiBhcyBjZGsuQ29uc3RydWN0LCBcImF3cy1ldmVudHMuRXZlbnRCdXNcIilcbiAgICApIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcImV2ZW50czoqXCIsIFtwZXJtaXNzaW9uLmV2ZW50QnVzQXJuXSkpO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICBpc0NvbnN0cnVjdE9mKHBlcm1pc3Npb24gYXMgY2RrLkNvbnN0cnVjdCwgXCJhd3Mta2luZXNpcy5TdHJlYW1cIilcbiAgICApIHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcImtpbmVzaXM6KlwiLCBbcGVybWlzc2lvbi5zdHJlYW1Bcm5dKSk7XG4gICAgfSBlbHNlIGlmIChpc0NvbnN0cnVjdE9mKHBlcm1pc3Npb24gYXMgY2RrLkNvbnN0cnVjdCwgXCJhd3MtczMuQnVja2V0XCIpKSB7XG4gICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIFdlIGRvIG5vdCB3YW50IHRvIGltcG9ydCB0aGUgY2RrIG1vZHVsZXMsIGp1c3QgY2FzdCB0byBhbnlcbiAgICAgIGNvbnN0IGJ1Y2tldEFybiA9IHBlcm1pc3Npb24uYnVja2V0QXJuO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInMzOipcIiwgW2J1Y2tldEFybiwgYCR7YnVja2V0QXJufS8qYF0pKTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgaXNDb25zdHJ1Y3RPZihwZXJtaXNzaW9uIGFzIGNkay5Db25zdHJ1Y3QsIFwiYXdzLXJkcy5TZXJ2ZXJsZXNzQ2x1c3RlclwiKVxuICAgICkge1xuICAgICAgLy8gRm9yIFNlcnZlcmxlc3NDbHVzdGVyLCB3ZSBuZWVkIHRvIGdyYW50OlxuICAgICAgLy8gLSBwZXJtaXNzc2lvbnMgdG8gYWNjZXNzIHRoZSBEYXRhIEFQSTtcbiAgICAgIC8vIC0gcGVybWlzc3Npb25zIHRvIGFjY2VzcyB0aGUgU2VjcmV0IE1hbmFnZXIgKHJlcXVpcmVkIGJ5IERhdGEgQVBJKS5cbiAgICAgIC8vIE5vIG5lZWQgdG8gZ3JhbnQgdGhlIHBlcm1pc3Npb25zIGZvciBJQU0gZGF0YWJhc2UgYXV0aGVudGljYXRpb25cbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInJkcy1kYXRhOipcIiwgW3Blcm1pc3Npb24uY2x1c3RlckFybl0pKTtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgV2UgZG8gbm90IHdhbnQgdG8gaW1wb3J0IHRoZSBjZGsgbW9kdWxlcywganVzdCBjYXN0IHRvIGFueVxuICAgICAgY29uc3Qgc2VjcmV0ID0gcGVybWlzc2lvbi5zZWNyZXQ7XG4gICAgICBpZiAoc2VjcmV0KSB7XG4gICAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgICAgYnVpbGRQb2xpY3koXCJzZWNyZXRzbWFuYWdlcjpHZXRTZWNyZXRWYWx1ZVwiLCBbc2VjcmV0LnNlY3JldEFybl0pXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENhc2U6IFNTVCBjb25zdHJ1Y3RcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgQXBpKSB7XG4gICAgICBjb25zdCBodHRwQXBpID0gcGVybWlzc2lvbi5odHRwQXBpO1xuICAgICAgY29uc3QgeyBhY2NvdW50LCByZWdpb24gfSA9IFN0YWNrLm9mKGh0dHBBcGkpO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgYnVpbGRQb2xpY3koXCJleGVjdXRlLWFwaTpJbnZva2VcIiwgW1xuICAgICAgICAgIGBhcm46YXdzOmV4ZWN1dGUtYXBpOiR7cmVnaW9ufToke2FjY291bnR9OiR7aHR0cEFwaS5odHRwQXBpSWR9LypgLFxuICAgICAgICBdKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBBcGlHYXRld2F5VjFBcGkpIHtcbiAgICAgIGNvbnN0IHJlc3RBcGkgPSBwZXJtaXNzaW9uLnJlc3RBcGk7XG4gICAgICBjb25zdCB7IGFjY291bnQsIHJlZ2lvbiB9ID0gU3RhY2sub2YocmVzdEFwaSk7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBidWlsZFBvbGljeShcImV4ZWN1dGUtYXBpOkludm9rZVwiLCBbXG4gICAgICAgICAgYGFybjphd3M6ZXhlY3V0ZS1hcGk6JHtyZWdpb259OiR7YWNjb3VudH06JHtyZXN0QXBpLnJlc3RBcGlJZH0vKmAsXG4gICAgICAgIF0pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIFdlYlNvY2tldEFwaSkge1xuICAgICAgY29uc3Qgd2ViU29ja2V0QXBpID0gcGVybWlzc2lvbi53ZWJTb2NrZXRBcGk7XG4gICAgICBjb25zdCB7IGFjY291bnQsIHJlZ2lvbiB9ID0gU3RhY2sub2Yod2ViU29ja2V0QXBpKTtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koXG4gICAgICAgIGJ1aWxkUG9saWN5KFwiZXhlY3V0ZS1hcGk6SW52b2tlXCIsIFtcbiAgICAgICAgICBgYXJuOmF3czpleGVjdXRlLWFwaToke3JlZ2lvbn06JHthY2NvdW50fToke3dlYlNvY2tldEFwaS5hcGlJZH0vKmAsXG4gICAgICAgIF0pXG4gICAgICApO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgYnVpbGRQb2xpY3koXCJleGVjdXRlLWFwaTpNYW5hZ2VDb25uZWN0aW9uc1wiLCBbXG4gICAgICAgICAgcGVybWlzc2lvbi5fY29ubmVjdGlvbnNBcm4sXG4gICAgICAgIF0pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIEFwcFN5bmNBcGkpIHtcbiAgICAgIGNvbnN0IGdyYXBocWxBcGkgPSBwZXJtaXNzaW9uLmdyYXBocWxBcGk7XG4gICAgICBjb25zdCB7IGFjY291bnQsIHJlZ2lvbiB9ID0gU3RhY2sub2YoZ3JhcGhxbEFwaSk7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgICBidWlsZFBvbGljeShcImFwcHN5bmM6R3JhcGhRTFwiLCBbXG4gICAgICAgICAgYGFybjphd3M6YXBwc3luYzoke3JlZ2lvbn06JHthY2NvdW50fTphcGlzLyR7Z3JhcGhxbEFwaS5hcGlJZH0vKmAsXG4gICAgICAgIF0pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIFRhYmxlKSB7XG4gICAgICBjb25zdCB0YWJsZUFybiA9IHBlcm1pc3Npb24uZHluYW1vZGJUYWJsZS50YWJsZUFybjtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJkeW5hbW9kYjoqXCIsIFt0YWJsZUFybiwgYCR7dGFibGVBcm59LypgXSkpO1xuICAgIH0gZWxzZSBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIFRvcGljKSB7XG4gICAgICByb2xlLmFkZFRvUG9saWN5KGJ1aWxkUG9saWN5KFwic25zOipcIiwgW3Blcm1pc3Npb24uc25zVG9waWMudG9waWNBcm5dKSk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgUXVldWUpIHtcbiAgICAgIHJvbGUuYWRkVG9Qb2xpY3koYnVpbGRQb2xpY3koXCJzcXM6KlwiLCBbcGVybWlzc2lvbi5zcXNRdWV1ZS5xdWV1ZUFybl0pKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBFdmVudEJ1cykge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgYnVpbGRQb2xpY3koXCJldmVudHM6KlwiLCBbcGVybWlzc2lvbi5ldmVudEJyaWRnZUV2ZW50QnVzLmV2ZW50QnVzQXJuXSlcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgS2luZXNpc1N0cmVhbSkge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShcbiAgICAgICAgYnVpbGRQb2xpY3koXCJraW5lc2lzOipcIiwgW3Blcm1pc3Npb24ua2luZXNpc1N0cmVhbS5zdHJlYW1Bcm5dKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBCdWNrZXQpIHtcbiAgICAgIGNvbnN0IGJ1Y2tldEFybiA9IHBlcm1pc3Npb24uczNCdWNrZXQuYnVja2V0QXJuO1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcInMzOipcIiwgW2J1Y2tldEFybiwgYCR7YnVja2V0QXJufS8qYF0pKTtcbiAgICB9IGVsc2UgaWYgKHBlcm1pc3Npb24gaW5zdGFuY2VvZiBGdW5jdGlvbikge1xuICAgICAgcm9sZS5hZGRUb1BvbGljeShidWlsZFBvbGljeShcImxhbWJkYToqXCIsIFtwZXJtaXNzaW9uLmZ1bmN0aW9uQXJuXSkpO1xuICAgIH1cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDYXNlOiBncmFudCBtZXRob2RcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBlbHNlIGlmIChcbiAgICAgIEFycmF5LmlzQXJyYXkocGVybWlzc2lvbikgJiZcbiAgICAgIHBlcm1pc3Npb24ubGVuZ3RoID09PSAyICYmXG4gICAgICBjZGsuQ29uc3RydWN0LmlzQ29uc3RydWN0KHBlcm1pc3Npb25bMF0pICYmXG4gICAgICB0eXBlb2YgcGVybWlzc2lvblsxXSA9PT0gXCJzdHJpbmdcIlxuICAgICkge1xuICAgICAgY29uc3QgY29uc3RydWN0ID0gcGVybWlzc2lvblswXSBhcyBjZGsuQ29uc3RydWN0O1xuICAgICAgY29uc3QgbWV0aG9kTmFtZSA9IHBlcm1pc3Npb25bMV0gYXMga2V5b2YgY2RrLkNvbnN0cnVjdDtcbiAgICAgIGlmICh0eXBlb2YgY29uc3RydWN0W21ldGhvZE5hbWVdICE9PSBcImZ1bmN0aW9uXCIpXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGhlIHNwZWNpZmllZCBncmFudCBtZXRob2QgaXMgaW5jb3JyZWN0LlxuICAgICAgICAgIENoZWNrIHRoZSBhdmFpbGFibGUgbWV0aG9kcyB0aGF0IHByZWZpeGVkIHdpdGggZ3JhbnRzIG9uIHRoZSBDb25zdHJ1Y3RgXG4gICAgICAgICk7XG4gICAgICAoY29uc3RydWN0W21ldGhvZE5hbWVdIGFzIHsgKGNvbnN0cnVjdDogY2RrLkNvbnN0cnVjdCk6IHZvaWQgfSkocm9sZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcInBlcm1pc3Npb24gb2JqZWN0XCIsIHBlcm1pc3Npb24pO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgc3BlY2lmaWVkIHBlcm1pc3Npb25zIGFyZSBub3Qgc3VwcG9ydGVkLmApO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkUG9saWN5KGFjdGlvbjogc3RyaW5nLCByZXNvdXJjZXM6IHN0cmluZ1tdKTogaWFtLlBvbGljeVN0YXRlbWVudCB7XG4gIHJldHVybiBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgIGFjdGlvbnM6IFthY3Rpb25dLFxuICAgIHJlc291cmNlcyxcbiAgfSk7XG59XG4iXX0=