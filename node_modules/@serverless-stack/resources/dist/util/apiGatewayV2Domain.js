"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildCustomDomainData = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2"));
const route53 = __importStar(require("@aws-cdk/aws-route53"));
const route53Targets = __importStar(require("@aws-cdk/aws-route53-targets"));
const acm = __importStar(require("@aws-cdk/aws-certificatemanager"));
function buildCustomDomainData(scope, customDomain) {
    if (customDomain === undefined) {
        return;
    }
    // To be implemented: to allow more flexible use cases, SST should support 3 more use cases:
    //  1. Allow user passing in `hostedZone` object. The use case is when there are multiple
    //     HostedZones with the same domain, but one is public, and one is private.
    //  2. Allow user passing in `certificate` object. The use case is for user to create wildcard
    //     certificate or using an imported certificate.
    //  3. Allow user passing in `apigDomain` object. The use case is a user creates multiple API
    //     endpoints, and is mapping them under the same custom domain. `sst.Api` needs to expose the
    //     `apigDomain` construct created in the first Api, and lets user pass it in when creating
    //     the second Api.
    let domainName, hostedZone, hostedZoneDomain, certificate, apigDomain, mappingKey;
    let isApigDomainCreated = false;
    let isCertificatedCreated = false;
    ///////////////////
    // Parse input
    ///////////////////
    // customDomain is a string
    if (typeof customDomain === "string") {
        // validate: customDomain is a TOKEN string
        // ie. imported SSM value: ssm.StringParameter.valueForStringParameter()
        if (cdk.Token.isUnresolved(customDomain)) {
            throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
        }
        domainName = customDomain;
        assertDomainNameIsLowerCase(domainName);
        hostedZoneDomain = customDomain.split(".").slice(1).join(".");
    }
    // customDomain.domainName not exists
    else if (!customDomain.domainName) {
        throw new Error(`Missing "domainName" in sst.Api's customDomain setting`);
    }
    // customDomain.domainName is a string
    else if (typeof customDomain.domainName === "string") {
        // parse customDomain.domainName
        if (cdk.Token.isUnresolved(customDomain.domainName)) {
            // If customDomain is a TOKEN string, "hostedZone" has to be passed in. This
            // is because "hostedZone" cannot be parsed from a TOKEN value.
            if (!customDomain.hostedZone) {
                throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
            }
            domainName = customDomain.domainName;
        }
        else {
            domainName = customDomain.domainName;
            assertDomainNameIsLowerCase(domainName);
        }
        // parse customDomain.hostedZone
        if (!customDomain.hostedZone) {
            hostedZoneDomain = domainName.split(".").slice(1).join(".");
        }
        else if (typeof customDomain.hostedZone === "string") {
            hostedZoneDomain = customDomain.hostedZone;
        }
        else {
            hostedZone = customDomain.hostedZone;
        }
        certificate = customDomain.certificate;
        mappingKey = customDomain.path;
    }
    // customDomain.domainName is a construct
    else {
        if (customDomain.hostedZone) {
            throw new Error(`Cannot configure the "hostedZone" when the "domainName" is a construct`);
        }
        if (customDomain.certificate) {
            throw new Error(`Cannot configure the "certificate" when the "domainName" is a construct`);
        }
        domainName = customDomain.domainName.name;
        apigDomain = customDomain.domainName;
        mappingKey = customDomain.path;
    }
    ///////////////////
    // Create domain
    ///////////////////
    if (!apigDomain && domainName) {
        // Look up hosted zone
        if (!hostedZone && hostedZoneDomain) {
            hostedZone = route53.HostedZone.fromLookup(scope, "HostedZone", {
                domainName: hostedZoneDomain,
            });
        }
        // Create certificate
        if (!certificate) {
            certificate = new acm.Certificate(scope, "Certificate", {
                domainName,
                validation: acm.CertificateValidation.fromDns(hostedZone),
            });
            isCertificatedCreated = true;
        }
        // Create custom domain in API Gateway
        apigDomain = new apig.DomainName(scope, "DomainName", {
            domainName,
            certificate,
        });
        // Create DNS record
        const record = new route53.ARecord(scope, "AliasRecord", {
            recordName: domainName,
            zone: hostedZone,
            target: route53.RecordTarget.fromAlias(new route53Targets.ApiGatewayv2DomainProperties(apigDomain.regionalDomainName, apigDomain.regionalHostedZoneId)),
        });
        // note: If domainName is a TOKEN string ie. ${TOKEN..}, the route53.ARecord
        //       construct will append ".${hostedZoneName}" to the end of the domain.
        //       This is because the construct tries to check if the record name
        //       ends with the domain name. If not, it will append the domain name.
        //       So, we need remove this behavior.
        if (cdk.Token.isUnresolved(domainName)) {
            const cfnRecord = record.node.defaultChild;
            cfnRecord.name = domainName;
        }
        isApigDomainCreated = true;
    }
    return {
        apigDomain: apigDomain,
        mappingKey,
        certificate,
        isApigDomainCreated,
        isCertificatedCreated,
        // Note: If mapping key is set, the URL needs a trailing slash. Without the
        //       trailing slash, the API fails with the error
        //       {"message":"Not Found"}
        url: mappingKey ? `${domainName}/${mappingKey}/` : domainName,
    };
}
exports.buildCustomDomainData = buildCustomDomainData;
function assertDomainNameIsLowerCase(domainName) {
    if (domainName !== domainName.toLowerCase()) {
        throw new Error(`The domain name needs to be in lowercase`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpR2F0ZXdheVYyRG9tYWluLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWwvYXBpR2F0ZXdheVYyRG9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxtREFBcUM7QUFDckMsZ0VBQWtEO0FBQ2xELDhEQUFnRDtBQUNoRCw2RUFBK0Q7QUFDL0QscUVBQXVEO0FBa0J2RCxTQUFnQixxQkFBcUIsQ0FDbkMsS0FBb0IsRUFDcEIsWUFBb0Q7SUFFcEQsSUFBSSxZQUFZLEtBQUssU0FBUyxFQUFFO1FBQzlCLE9BQU87S0FDUjtJQUVELDRGQUE0RjtJQUM1Rix5RkFBeUY7SUFDekYsK0VBQStFO0lBQy9FLDhGQUE4RjtJQUM5RixvREFBb0Q7SUFDcEQsNkZBQTZGO0lBQzdGLGlHQUFpRztJQUNqRyw4RkFBOEY7SUFDOUYsc0JBQXNCO0lBRXRCLElBQUksVUFBVSxFQUNaLFVBQVUsRUFDVixnQkFBZ0IsRUFDaEIsV0FBVyxFQUNYLFVBQVUsRUFDVixVQUFVLENBQUM7SUFDYixJQUFJLG1CQUFtQixHQUFHLEtBQUssQ0FBQztJQUNoQyxJQUFJLHFCQUFxQixHQUFHLEtBQUssQ0FBQztJQUVsQyxtQkFBbUI7SUFDbkIsY0FBYztJQUNkLG1CQUFtQjtJQUVuQiwyQkFBMkI7SUFDM0IsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUU7UUFDcEMsMkNBQTJDO1FBQzNDLHdFQUF3RTtRQUN4RSxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxFQUFFO1lBQ3hDLE1BQU0sSUFBSSxLQUFLLENBQ2IsNEZBQTRGLENBQzdGLENBQUM7U0FDSDtRQUVELFVBQVUsR0FBRyxZQUFZLENBQUM7UUFDMUIsMkJBQTJCLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDeEMsZ0JBQWdCLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENB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QUFDLEtBQUssRUFBRSxhQUFhLEVBQUU7WUFDdkQsVUFBVSxFQUFFLFVBQVU7WUFDdEIsSUFBSSxFQUFFLFVBQWlDO1lBQ3ZDLE1BQU0sRUFBRSxPQUFPLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FDcEMsSUFBSSxjQUFjLENBQUMsNEJBQTRCLENBQzdDLFVBQVUsQ0FBQyxrQkFBa0IsRUFDN0IsVUFBVSxDQUFDLG9CQUFvQixDQUNoQyxDQUNGO1NBQ0YsQ0FBQyxDQUFDO1FBQ0gsNEVBQTRFO1FBQzVFLDZFQUE2RTtRQUM3RSx3RUFBd0U7UUFDeEUsMkVBQTJFO1FBQzNFLDBDQUEwQztRQUMxQyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ3RDLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBb0MsQ0FBQztZQUNuRSxTQUFTLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQztTQUM3QjtRQUVELG1CQUFtQixHQUFHLElBQUksQ0FBQztLQUM1QjtJQUVELE9BQU87UUFDTCxVQUFVLEVBQUUsVUFBOEI7UUFDMUMsVUFBVTtRQUNWLFdBQVc7UUFDWCxtQkFBbUI7UUFDbkIscUJBQXFCO1FBQ3JCLDJFQUEyRTtRQUMzRSxxREFBcUQ7UUFDckQsZ0NBQWdDO1FBQ2hDLEdBQUcsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsVUFBVSxJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQyxVQUFVO0tBQzlELENBQUM7QUFDSixDQUFDO0FBaEtELHNEQWdLQztBQUVELFNBQVMsMkJBQTJCLENBQUMsVUFBa0I7SUFDckQsSUFBSSxVQUFVLEtBQUssVUFBVSxDQUFDLFdBQVcsRUFBRSxFQUFFO1FBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQztLQUM3RDtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSBcIkBhd3MtY2RrL2NvcmVcIjtcbmltcG9ydCAqIGFzIGFwaWcgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djJcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTMgZnJvbSBcIkBhd3MtY2RrL2F3cy1yb3V0ZTUzXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzVGFyZ2V0cyBmcm9tIFwiQGF3cy1jZGsvYXdzLXJvdXRlNTMtdGFyZ2V0c1wiO1xuaW1wb3J0ICogYXMgYWNtIGZyb20gXCJAYXdzLWNkay9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3VzdG9tRG9tYWluUHJvcHMge1xuICByZWFkb25seSBkb21haW5OYW1lOiBzdHJpbmcgfCBhcGlnLklEb21haW5OYW1lO1xuICByZWFkb25seSBob3N0ZWRab25lPzogc3RyaW5nIHwgcm91dGU1My5JSG9zdGVkWm9uZTtcbiAgcmVhZG9ubHkgY2VydGlmaWNhdGU/OiBhY20uSUNlcnRpZmljYXRlO1xuICByZWFkb25seSBwYXRoPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEN1c3RvbURvbWFpbkRhdGEge1xuICByZWFkb25seSBhcGlnRG9tYWluOiBhcGlnLklEb21haW5OYW1lO1xuICByZWFkb25seSBtYXBwaW5nS2V5Pzogc3RyaW5nO1xuICByZWFkb25seSBjZXJ0aWZpY2F0ZT86IGFjbS5JQ2VydGlmaWNhdGU7XG4gIHJlYWRvbmx5IGlzQXBpZ0RvbWFpbkNyZWF0ZWQ6IGJvb2xlYW47XG4gIHJlYWRvbmx5IGlzQ2VydGlmaWNhdGVkQ3JlYXRlZDogYm9vbGVhbjtcbiAgcmVhZG9ubHkgdXJsOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZEN1c3RvbURvbWFpbkRhdGEoXG4gIHNjb3BlOiBjZGsuQ29uc3RydWN0LFxuICBjdXN0b21Eb21haW46IHN0cmluZyB8IEN1c3RvbURvbWFpblByb3BzIHwgdW5kZWZpbmVkXG4pOiBDdXN0b21Eb21haW5EYXRhIHwgdW5kZWZpbmVkIHtcbiAgaWYgKGN1c3RvbURvbWFpbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gVG8gYmUgaW1wbGVtZW50ZWQ6IHRvIGFsbG93IG1vcmUgZmxleGlibGUgdXNlIGNhc2VzLCBTU1Qgc2hvdWxkIHN1cHBvcnQgMyBtb3JlIHVzZSBjYXNlczpcbiAgLy8gIDEuIEFsbG93IHVzZXIgcGFzc2luZyBpbiBgaG9zdGVkWm9uZWAgb2JqZWN0LiBUaGUgdXNlIGNhc2UgaXMgd2hlbiB0aGVyZSBhcmUgbXVsdGlwbGVcbiAgLy8gICAgIEhvc3RlZFpvbmVzIHdpdGggdGhlIHNhbWUgZG9tYWluLCBidXQgb25lIGlzIHB1YmxpYywgYW5kIG9uZSBpcyBwcml2YXRlLlxuICAvLyAgMi4gQWxsb3cgdXNlciBwYXNzaW5nIGluIGBjZXJ0aWZpY2F0ZWAgb2JqZWN0LiBUaGUgdXNlIGNhc2UgaXMgZm9yIHVzZXIgdG8gY3JlYXRlIHdpbGRjYXJkXG4gIC8vICAgICBjZXJ0aWZpY2F0ZSBvciB1c2luZyBhbiBpbXBvcnRlZCBjZXJ0aWZpY2F0ZS5cbiAgLy8gIDMuIEFsbG93IHVzZXIgcGFzc2luZyBpbiBgYXBpZ0RvbWFpbmAgb2JqZWN0LiBUaGUgdXNlIGNhc2UgaXMgYSB1c2VyIGNyZWF0ZXMgbXVsdGlwbGUgQVBJXG4gIC8vICAgICBlbmRwb2ludHMsIGFuZCBpcyBtYXBwaW5nIHRoZW0gdW5kZXIgdGhlIHNhbWUgY3VzdG9tIGRvbWFpbi4gYHNzdC5BcGlgIG5lZWRzIHRvIGV4cG9zZSB0aGVcbiAgLy8gICAgIGBhcGlnRG9tYWluYCBjb25zdHJ1Y3QgY3JlYXRlZCBpbiB0aGUgZmlyc3QgQXBpLCBhbmQgbGV0cyB1c2VyIHBhc3MgaXQgaW4gd2hlbiBjcmVhdGluZ1xuICAvLyAgICAgdGhlIHNlY29uZCBBcGkuXG5cbiAgbGV0IGRvbWFpbk5hbWUsXG4gICAgaG9zdGVkWm9uZSxcbiAgICBob3N0ZWRab25lRG9tYWluLFxuICAgIGNlcnRpZmljYXRlLFxuICAgIGFwaWdEb21haW4sXG4gICAgbWFwcGluZ0tleTtcbiAgbGV0IGlzQXBpZ0RvbWFpbkNyZWF0ZWQgPSBmYWxzZTtcbiAgbGV0IGlzQ2VydGlmaWNhdGVkQ3JlYXRlZCA9IGZhbHNlO1xuXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gUGFyc2UgaW5wdXRcbiAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIC8vIGN1c3RvbURvbWFpbiBpcyBhIHN0cmluZ1xuICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgIC8vIHZhbGlkYXRlOiBjdXN0b21Eb21haW4gaXMgYSBUT0tFTiBzdHJpbmdcbiAgICAvLyBpZS4gaW1wb3J0ZWQgU1NNIHZhbHVlOiBzc20uU3RyaW5nUGFyYW1ldGVyLnZhbHVlRm9yU3RyaW5nUGFyYW1ldGVyKClcbiAgICBpZiAoY2RrLlRva2VuLmlzVW5yZXNvbHZlZChjdXN0b21Eb21haW4pKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBZb3UgYWxzbyBuZWVkIHRvIHNwZWNpZnkgdGhlIFwiaG9zdGVkWm9uZVwiIGlmIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBwYXNzZWQgaW4gYXMgYSByZWZlcmVuY2UuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBkb21haW5OYW1lID0gY3VzdG9tRG9tYWluO1xuICAgIGFzc2VydERvbWFpbk5hbWVJc0xvd2VyQ2FzZShkb21haW5OYW1lKTtcbiAgICBob3N0ZWRab25lRG9tYWluID0gY3VzdG9tRG9tYWluLnNwbGl0KFwiLlwiKS5zbGljZSgxKS5qb2luKFwiLlwiKTtcbiAgfVxuXG4gIC8vIGN1c3RvbURvbWFpbi5kb21haW5OYW1lIG5vdCBleGlzdHNcbiAgZWxzZSBpZiAoIWN1c3RvbURvbWFpbi5kb21haW5OYW1lKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIFwiZG9tYWluTmFtZVwiIGluIHNzdC5BcGkncyBjdXN0b21Eb21haW4gc2V0dGluZ2ApO1xuICB9XG5cbiAgLy8gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgaXMgYSBzdHJpbmdcbiAgZWxzZSBpZiAodHlwZW9mIGN1c3RvbURvbWFpbi5kb21haW5OYW1lID09PSBcInN0cmluZ1wiKSB7XG4gICAgLy8gcGFyc2UgY3VzdG9tRG9tYWluLmRvbWFpbk5hbWVcbiAgICBpZiAoY2RrLlRva2VuLmlzVW5yZXNvbHZlZChjdXN0b21Eb21haW4uZG9tYWluTmFtZSkpIHtcbiAgICAgIC8vIElmIGN1c3RvbURvbWFpbiBpcyBhIFRPS0VOIHN0cmluZywgXCJob3N0ZWRab25lXCIgaGFzIHRvIGJlIHBhc3NlZCBpbi4gVGhpc1xuICAgICAgLy8gaXMgYmVjYXVzZSBcImhvc3RlZFpvbmVcIiBjYW5ub3QgYmUgcGFyc2VkIGZyb20gYSBUT0tFTiB2YWx1ZS5cbiAgICAgIGlmICghY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBZb3UgYWxzbyBuZWVkIHRvIHNwZWNpZnkgdGhlIFwiaG9zdGVkWm9uZVwiIGlmIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBwYXNzZWQgaW4gYXMgYSByZWZlcmVuY2UuYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgZG9tYWluTmFtZSA9IGN1c3RvbURvbWFpbi5kb21haW5OYW1lO1xuICAgIH0gZWxzZSB7XG4gICAgICBkb21haW5OYW1lID0gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWU7XG4gICAgICBhc3NlcnREb21haW5OYW1lSXNMb3dlckNhc2UoZG9tYWluTmFtZSk7XG4gICAgfVxuXG4gICAgLy8gcGFyc2UgY3VzdG9tRG9tYWluLmhvc3RlZFpvbmVcbiAgICBpZiAoIWN1c3RvbURvbWFpbi5ob3N0ZWRab25lKSB7XG4gICAgICBob3N0ZWRab25lRG9tYWluID0gZG9tYWluTmFtZS5zcGxpdChcIi5cIikuc2xpY2UoMSkuam9pbihcIi5cIik7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGhvc3RlZFpvbmVEb21haW4gPSBjdXN0b21Eb21haW4uaG9zdGVkWm9uZTtcbiAgICB9IGVsc2Uge1xuICAgICAgaG9zdGVkWm9uZSA9IGN1c3RvbURvbWFpbi5ob3N0ZWRab25lO1xuICAgIH1cblxuICAgIGNlcnRpZmljYXRlID0gY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlO1xuICAgIG1hcHBpbmdLZXkgPSBjdXN0b21Eb21haW4ucGF0aDtcbiAgfVxuXG4gIC8vIGN1c3RvbURvbWFpbi5kb21haW5OYW1lIGlzIGEgY29uc3RydWN0XG4gIGVsc2Uge1xuICAgIGlmIChjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJob3N0ZWRab25lXCIgd2hlbiB0aGUgXCJkb21haW5OYW1lXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImNlcnRpZmljYXRlXCIgd2hlbiB0aGUgXCJkb21haW5OYW1lXCIgaXMgYSBjb25zdHJ1Y3RgXG4gICAgICApO1xuICAgIH1cblxuICAgIGRvbWFpbk5hbWUgPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZS5uYW1lO1xuICAgIGFwaWdEb21haW4gPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZTtcbiAgICBtYXBwaW5nS2V5ID0gY3VzdG9tRG9tYWluLnBhdGg7XG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIENyZWF0ZSBkb21haW5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICBpZiAoIWFwaWdEb21haW4gJiYgZG9tYWluTmFtZSkge1xuICAgIC8vIExvb2sgdXAgaG9zdGVkIHpvbmVcbiAgICBpZiAoIWhvc3RlZFpvbmUgJiYgaG9zdGVkWm9uZURvbWFpbikge1xuICAgICAgaG9zdGVkWm9uZSA9IHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHNjb3BlLCBcIkhvc3RlZFpvbmVcIiwge1xuICAgICAgICBkb21haW5OYW1lOiBob3N0ZWRab25lRG9tYWluLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGNlcnRpZmljYXRlXG4gICAgaWYgKCFjZXJ0aWZpY2F0ZSkge1xuICAgICAgY2VydGlmaWNhdGUgPSBuZXcgYWNtLkNlcnRpZmljYXRlKHNjb3BlLCBcIkNlcnRpZmljYXRlXCIsIHtcbiAgICAgICAgZG9tYWluTmFtZSxcbiAgICAgICAgdmFsaWRhdGlvbjogYWNtLkNlcnRpZmljYXRlVmFsaWRhdGlvbi5mcm9tRG5zKGhvc3RlZFpvbmUpLFxuICAgICAgfSk7XG4gICAgICBpc0NlcnRpZmljYXRlZENyZWF0ZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBjdXN0b20gZG9tYWluIGluIEFQSSBHYXRld2F5XG4gICAgYXBpZ0RvbWFpbiA9IG5ldyBhcGlnLkRvbWFpbk5hbWUoc2NvcGUsIFwiRG9tYWluTmFtZVwiLCB7XG4gICAgICBkb21haW5OYW1lLFxuICAgICAgY2VydGlmaWNhdGUsXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgRE5TIHJlY29yZFxuICAgIGNvbnN0IHJlY29yZCA9IG5ldyByb3V0ZTUzLkFSZWNvcmQoc2NvcGUsIFwiQWxpYXNSZWNvcmRcIiwge1xuICAgICAgcmVjb3JkTmFtZTogZG9tYWluTmFtZSxcbiAgICAgIHpvbmU6IGhvc3RlZFpvbmUgYXMgcm91dGU1My5JSG9zdGVkWm9uZSxcbiAgICAgIHRhcmdldDogcm91dGU1My5SZWNvcmRUYXJnZXQuZnJvbUFsaWFzKFxuICAgICAgICBuZXcgcm91dGU1M1RhcmdldHMuQXBpR2F0ZXdheXYyRG9tYWluUHJvcGVydGllcyhcbiAgICAgICAgICBhcGlnRG9tYWluLnJlZ2lvbmFsRG9tYWluTmFtZSxcbiAgICAgICAgICBhcGlnRG9tYWluLnJlZ2lvbmFsSG9zdGVkWm9uZUlkXG4gICAgICAgIClcbiAgICAgICksXG4gICAgfSk7XG4gICAgLy8gbm90ZTogSWYgZG9tYWluTmFtZSBpcyBhIFRPS0VOIHN0cmluZyBpZS4gJHtUT0tFTi4ufSwgdGhlIHJvdXRlNTMuQVJlY29yZFxuICAgIC8vICAgICAgIGNvbnN0cnVjdCB3aWxsIGFwcGVuZCBcIi4ke2hvc3RlZFpvbmVOYW1lfVwiIHRvIHRoZSBlbmQgb2YgdGhlIGRvbWFpbi5cbiAgICAvLyAgICAgICBUaGlzIGlzIGJlY2F1c2UgdGhlIGNvbnN0cnVjdCB0cmllcyB0byBjaGVjayBpZiB0aGUgcmVjb3JkIG5hbWVcbiAgICAvLyAgICAgICBlbmRzIHdpdGggdGhlIGRvbWFpbiBuYW1lLiBJZiBub3QsIGl0IHdpbGwgYXBwZW5kIHRoZSBkb21haW4gbmFtZS5cbiAgICAvLyAgICAgICBTbywgd2UgbmVlZCByZW1vdmUgdGhpcyBiZWhhdmlvci5cbiAgICBpZiAoY2RrLlRva2VuLmlzVW5yZXNvbHZlZChkb21haW5OYW1lKSkge1xuICAgICAgY29uc3QgY2ZuUmVjb3JkID0gcmVjb3JkLm5vZGUuZGVmYXVsdENoaWxkIGFzIHJvdXRlNTMuQ2ZuUmVjb3JkU2V0O1xuICAgICAgY2ZuUmVjb3JkLm5hbWUgPSBkb21haW5OYW1lO1xuICAgIH1cblxuICAgIGlzQXBpZ0RvbWFpbkNyZWF0ZWQgPSB0cnVlO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBhcGlnRG9tYWluOiBhcGlnRG9tYWluIGFzIGFwaWcuSURvbWFpbk5hbWUsXG4gICAgbWFwcGluZ0tleSxcbiAgICBjZXJ0aWZpY2F0ZSxcbiAgICBpc0FwaWdEb21haW5DcmVhdGVkLFxuICAgIGlzQ2VydGlmaWNhdGVkQ3JlYXRlZCxcbiAgICAvLyBOb3RlOiBJZiBtYXBwaW5nIGtleSBpcyBzZXQsIHRoZSBVUkwgbmVlZHMgYSB0cmFpbGluZyBzbGFzaC4gV2l0aG91dCB0aGVcbiAgICAvLyAgICAgICB0cmFpbGluZyBzbGFzaCwgdGhlIEFQSSBmYWlscyB3aXRoIHRoZSBlcnJvclxuICAgIC8vICAgICAgIHtcIm1lc3NhZ2VcIjpcIk5vdCBGb3VuZFwifVxuICAgIHVybDogbWFwcGluZ0tleSA/IGAke2RvbWFpbk5hbWV9LyR7bWFwcGluZ0tleX0vYCA6IGRvbWFpbk5hbWUsXG4gIH07XG59XG5cbmZ1bmN0aW9uIGFzc2VydERvbWFpbk5hbWVJc0xvd2VyQ2FzZShkb21haW5OYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgaWYgKGRvbWFpbk5hbWUgIT09IGRvbWFpbk5hbWUudG9Mb3dlckNhc2UoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGRvbWFpbiBuYW1lIG5lZWRzIHRvIGJlIGluIGxvd2VyY2FzZWApO1xuICB9XG59XG4iXX0=