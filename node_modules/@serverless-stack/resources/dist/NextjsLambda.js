"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NextjsLambda = void 0;
const path = __importStar(require("path"));
const crypto = __importStar(require("crypto"));
const cdk = __importStar(require("@aws-cdk/core"));
const iam = __importStar(require("@aws-cdk/aws-iam"));
const lambda = __importStar(require("@aws-cdk/aws-lambda"));
const s3Assets = __importStar(require("@aws-cdk/aws-s3-assets"));
const customResource_1 = require("./util/customResource");
class NextjsLambda extends cdk.Construct {
    constructor(scope, id) {
        super(scope, id);
        const bucketCR = this.createBucket();
        const role = this.createEdgeFunctionRole();
        const version = this.createEdgeFunction(role, bucketCR);
        new cdk.CfnOutput(this, "VERSION", { value: version.functionArn });
    }
    createBucket() {
        const { resource } = (0, customResource_1.createCustomResource)(this, "EdgeLambdaBucket", {
            resourceType: "Custom::SSTEdgeLambdaBucket",
            srcPath: path.join(__dirname, "nextjs-site/custom-resource"),
            handler: "s3-bucket.handler",
            policyStatements: [
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["s3:*"],
                    resources: ["*"],
                }),
            ],
            properties: {
                BucketNamePrefix: `${cdk.Stack.of(this).stackName}-EdgeLambdaAsset`,
            },
        });
        return resource;
    }
    createEdgeFunctionRole() {
        return new iam.Role(this, `EdgeLambdaRole`, {
            assumedBy: new iam.ServicePrincipal("lambda.amazonaws.com"),
            managedPolicies: [
                iam.ManagedPolicy.fromManagedPolicyArn(this, "EdgeLambdaPolicy", "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole")
            ]
        });
    }
    createEdgeFunction(role, bucketCR) {
        // Create function based on region
        let fn;
        let fnVersion;
        const root = this.node.root;
        // Create function asset
        const asset = new s3Assets.Asset(this, `FunctionAsset`, {
            //path: path.join(__dirname, "Script"),
            //path: path.join(__dirname, "util"),
            path: path.join(__dirname, "NextjsSite"),
        });
        // Create function
        const functionProperties = {
            Description: `handler for Next.js`,
            Handler: "index.handler",
            Code: {
                S3Bucket: asset.s3BucketName,
                S3Key: asset.s3ObjectKey,
            },
            Runtime: lambda.Runtime.NODEJS_12_X.name,
            MemorySize: 512,
            Timeout: 10,
            Role: role.roleArn,
        };
        const functionCR = (0, customResource_1.createCustomResource)(this, "EdgeLambda", {
            resourceType: "Custom::SSTEdgeLambda",
            srcPath: path.join(__dirname, "nextjs-site/custom-resource"),
            handler: "edge-lambda.handler",
            policyStatements: [
                // allow custom resource to create/update/remove Lambda functions
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["lambda:*", "s3:*"],
                    resources: ["*"],
                }),
            ],
            properties: {
                FunctionNamePrefix: `${cdk.Stack.of(this).stackName}-EdgeLambda`,
                FunctionBucket: bucketCR.getAttString("BucketName"),
                FunctionParams: functionProperties,
            },
        });
        if (functionCR.handler.role) {
            role.grantPassRole(functionCR.handler.role);
        }
        functionCR.resource.node.addDependency(bucketCR);
        // Create Function Version
        const versionCR = (0, customResource_1.createCustomResource)(this, "EdgeLambdaVersion", {
            resourceType: "Custom::SSTEdgeLambdaVersion",
            srcPath: path.join(__dirname, "nextjs-site/custom-resource"),
            handler: "edge-lambda-version.handler",
            policyStatements: [
                // allow custom resource to create/update/remove Lambda function versions
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ["lambda:*"],
                    resources: ["*"],
                }),
            ],
            properties: {
                FunctionArn: functionCR.resource.getAttString("FunctionArn"),
            },
        });
        // Override the version's logical ID with a lazy string which includes the
        // hash of the function itself, so a new version resource is created when
        // the function configuration changes.
        const cfn = versionCR.resource.node.defaultChild;
        const originalLogicalId = cdk.Stack.of(this).resolve(cfn.logicalId);
        cfn.overrideLogicalId(cdk.Lazy.uncachedString({
            produce: () => {
                const hash = calculateHash(functionCR.resource);
                const logicalId = trimFromStart(originalLogicalId, 255 - 32);
                return `${logicalId}${hash}`;
            },
        }));
        fnVersion = lambda.Version.fromVersionArn(this, `FunctionVersion`, `${functionCR.resource.getAttString("FunctionArn")}:${versionCR.resource.getAttString("Version")}`);
        return fnVersion;
    }
}
exports.NextjsLambda = NextjsLambda;
function trimFromStart(s, maxLength) {
    const desiredLength = Math.min(maxLength, s.length);
    const newStart = s.length - desiredLength;
    return s.substring(newStart);
}
function calculateHash(resource) {
    // render the cloudformation resource from this function
    // config is of the shape:
    // {
    //  Resources: {
    //    LogicalId: {
    //      Type: 'Function',
    //      Properties: { ... }
    // }}}
    const cfnResource = resource.node.defaultChild;
    const config = cdk.Stack.of(resource).resolve(cfnResource._toCloudFormation());
    const resources = config.Resources;
    const resourceKeys = Object.keys(resources);
    if (resourceKeys.length !== 1) {
        throw new Error(`Expected one rendered CloudFormation resource but found ${resourceKeys.length}`);
    }
    const logicalId = resourceKeys[0];
    const properties = resources[logicalId].Properties.FunctionParams;
    const hash = crypto.createHash('md5');
    hash.update(JSON.stringify(properties));
    return hash.digest('hex');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTmV4dGpzTGFtYmRhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL05leHRqc0xhbWJkYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EsMkNBQTZCO0FBRTdCLCtDQUFpQztBQUdqQyxtREFBcUM7QUFFckMsc0RBQXdDO0FBR3hDLDREQUE4QztBQUU5QyxpRUFBbUQ7QUFhbkQsMERBQTZEO0FBRTdELE1BQWEsWUFBYSxTQUFRLEdBQUcsQ0FBQyxTQUFTO0lBRTdDLFlBQVksS0FBb0IsRUFBRSxFQUFVO1FBQzFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3JDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1FBQzNDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFeEQsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7SUFDckUsQ0FBQztJQUVPLFlBQVk7UUFDbEIsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLElBQUEscUNBQW9CLEVBQUMsSUFBSSxFQUFFLGtCQUFrQixFQUFFO1lBQ2xFLFlBQVksRUFBRSw2QkFBNkI7WUFDM0MsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLDZCQUE2QixDQUFDO1lBQzVELE9BQU8sRUFBRSxtQkFBbUI7WUFDNUIsZ0JBQWdCLEVBQUU7Z0JBQ2hCLElBQUksR0FBRyxDQUFDLGVBQWUsQ0FBQztvQkFDdEIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztvQkFDeEIsT0FBTyxFQUFFLENBQUMsTUFB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QUMsMkRBQTJELFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0tBQ25HO0lBQ0QsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xDLE1BQU0sVUFBVSxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDO0lBRWxFLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFDeEMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzVCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hhbGsgZnJvbSBcImNoYWxrXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSBcIkBhd3MtY2RrL2NvcmVcIjtcbmltcG9ydCAqIGFzIHMzIGZyb20gXCJAYXdzLWNkay9hd3MtczNcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiQGF3cy1jZGsvYXdzLWlhbVwiO1xuaW1wb3J0ICogYXMgc3FzIGZyb20gXCJAYXdzLWNkay9hd3Mtc3FzXCI7XG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gXCJAYXdzLWNkay9hd3MtbG9nc1wiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJAYXdzLWNkay9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzIGZyb20gXCJAYXdzLWNkay9hd3Mtcm91dGU1M1wiO1xuaW1wb3J0ICogYXMgczNBc3NldHMgZnJvbSBcIkBhd3MtY2RrL2F3cy1zMy1hc3NldHNcIjtcbmltcG9ydCAqIGFzIGNsb3VkZnJvbnQgZnJvbSBcIkBhd3MtY2RrL2F3cy1jbG91ZGZyb250XCI7XG5pbXBvcnQgKiBhcyBhY20gZnJvbSBcIkBhd3MtY2RrL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXJcIjtcbmltcG9ydCB7IEF3c0NsaUxheWVyIH0gZnJvbSBcIkBhd3MtY2RrL2xhbWJkYS1sYXllci1hd3NjbGlcIjtcbmltcG9ydCAqIGFzIG9yaWdpbnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1jbG91ZGZyb250LW9yaWdpbnNcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTNUYXJnZXRzIGZyb20gXCJAYXdzLWNkay9hd3Mtcm91dGU1My10YXJnZXRzXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzUGF0dGVybnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1yb3V0ZTUzLXBhdHRlcm5zXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGFFdmVudFNvdXJjZXMgZnJvbSBcIkBhd3MtY2RrL2F3cy1sYW1iZGEtZXZlbnQtc291cmNlc1wiO1xuaW1wb3J0IHsgUm91dGVzTWFuaWZlc3QgfSBmcm9tIFwiQHNlcnZlcmxlc3Mtc3RhY2svbmV4dGpzLWxhbWJkYVwiO1xuXG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zLCBhdHRhY2hQZXJtaXNzaW9uc1RvUm9sZSB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuaW1wb3J0IHsgZ2V0SGFuZGxlckhhc2ggfSBmcm9tIFwiLi91dGlsL2J1aWxkZXJcIjtcbmltcG9ydCB7IGNyZWF0ZUN1c3RvbVJlc291cmNlIH0gZnJvbSBcIi4vdXRpbC9jdXN0b21SZXNvdXJjZVwiO1xuXG5leHBvcnQgY2xhc3MgTmV4dGpzTGFtYmRhIGV4dGVuZHMgY2RrLkNvbnN0cnVjdCB7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3QgYnVja2V0Q1IgPSB0aGlzLmNyZWF0ZUJ1Y2tldCgpO1xuICAgIGNvbnN0IHJvbGUgPSB0aGlzLmNyZWF0ZUVkZ2VGdW5jdGlvblJvbGUoKTtcbiAgICBjb25zdCB2ZXJzaW9uID0gdGhpcy5jcmVhdGVFZGdlRnVuY3Rpb24ocm9sZSwgYnVja2V0Q1IpO1xuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgXCJWRVJTSU9OXCIsIHsgdmFsdWU6IHZlcnNpb24uZnVuY3Rpb25Bcm4gfSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUJ1Y2tldCgpOiBjZGsuQ3VzdG9tUmVzb3VyY2Uge1xuICAgIGNvbnN0IHsgcmVzb3VyY2UgfSA9IGNyZWF0ZUN1c3RvbVJlc291cmNlKHRoaXMsIFwiRWRnZUxhbWJkYUJ1Y2tldFwiLCB7XG4gICAgICByZXNvdXJjZVR5cGU6IFwiQ3VzdG9tOjpTU1RFZGdlTGFtYmRhQnVja2V0XCIsXG4gICAgICBzcmNQYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIm5leHRqcy1zaXRlL2N1c3RvbS1yZXNvdXJjZVwiKSxcbiAgICAgIGhhbmRsZXI6IFwiczMtYnVja2V0LmhhbmRsZXJcIixcbiAgICAgIHBvbGljeVN0YXRlbWVudHM6IFtcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICBhY3Rpb25zOiBbXCJzMzoqXCJdLFxuICAgICAgICAgIHJlc291cmNlczogW1wiKlwiXSxcbiAgICAgICAgfSksXG4gICAgICBdLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBCdWNrZXROYW1lUHJlZml4OiBgJHtjZGsuU3RhY2sub2YodGhpcykuc3RhY2tOYW1lfS1FZGdlTGFtYmRhQXNzZXRgLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzb3VyY2U7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUVkZ2VGdW5jdGlvblJvbGUoKTogaWFtLlJvbGUge1xuICAgIHJldHVybiBuZXcgaWFtLlJvbGUodGhpcywgYEVkZ2VMYW1iZGFSb2xlYCwge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoXCJsYW1iZGEuYW1hem9uYXdzLmNvbVwiKSxcbiAgICAgIG1hbmFnZWRQb2xpY2llczogW1xuICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tTWFuYWdlZFBvbGljeUFybihcbiAgICAgICAgICB0aGlzLFxuICAgICAgICAgIFwiRWRnZUxhbWJkYVBvbGljeVwiLFxuICAgICAgICAgIFwiYXJuOmF3czppYW06OmF3czpwb2xpY3kvc2VydmljZS1yb2xlL0FXU0xhbWJkYUJhc2ljRXhlY3V0aW9uUm9sZVwiXG4gICAgICAgIClcbiAgICAgIF1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlRWRnZUZ1bmN0aW9uKHJvbGU6IGlhbS5Sb2xlLCBidWNrZXRDUjogY2RrLkN1c3RvbVJlc291cmNlKTogbGFtYmRhLklWZXJzaW9uIHtcblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvbiBiYXNlZCBvbiByZWdpb25cbiAgICBsZXQgZm47XG4gICAgbGV0IGZuVmVyc2lvbjtcbiAgICBjb25zdCByb290ID0gdGhpcy5ub2RlLnJvb3QgYXMgQXBwO1xuXG4gICAgLy8gQ3JlYXRlIGZ1bmN0aW9uIGFzc2V0XG4gICAgY29uc3QgYXNzZXQgPSBuZXcgczNBc3NldHMuQXNzZXQodGhpcywgYEZ1bmN0aW9uQXNzZXRgLCB7XG4gICAgICAvL3BhdGg6IHBhdGguam9pbihfX2Rpcm5hbWUsIFwiU2NyaXB0XCIpLFxuICAgICAgLy9wYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcInV0aWxcIiksXG4gICAgICBwYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIk5leHRqc1NpdGVcIiksXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgZnVuY3Rpb25cbiAgICBjb25zdCBmdW5jdGlvblByb3BlcnRpZXMgPSB7XG4gICAgICBEZXNjcmlwdGlvbjogYGhhbmRsZXIgZm9yIE5leHQuanNgLFxuICAgICAgSGFuZGxlcjogXCJpbmRleC5oYW5kbGVyXCIsXG4gICAgICBDb2RlOiB7XG4gICAgICAgIFMzQnVja2V0OiBhc3NldC5zM0J1Y2tldE5hbWUsXG4gICAgICAgIFMzS2V5OiBhc3NldC5zM09iamVjdEtleSxcbiAgICAgIH0sXG4gICAgICBSdW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWC5uYW1lLFxuICAgICAgTWVtb3J5U2l6ZTogNTEyLFxuICAgICAgVGltZW91dDogMTAsXG4gICAgICBSb2xlOiByb2xlLnJvbGVBcm4sXG4gICAgfTtcbiAgICBjb25zdCBmdW5jdGlvbkNSID0gY3JlYXRlQ3VzdG9tUmVzb3VyY2UodGhpcywgXCJFZGdlTGFtYmRhXCIsIHtcbiAgICAgIHJlc291cmNlVHlwZTogXCJDdXN0b206OlNTVEVkZ2VMYW1iZGFcIixcbiAgICAgIHNyY1BhdGg6IHBhdGguam9pbihfX2Rpcm5hbWUsIFwibmV4dGpzLXNpdGUvY3VzdG9tLXJlc291cmNlXCIpLFxuICAgICAgaGFuZGxlcjogXCJlZGdlLWxhbWJkYS5oYW5kbGVyXCIsXG4gICAgICBwb2xpY3lTdGF0ZW1lbnRzOiBbXG4gICAgICAgIC8vIGFsbG93IGN1c3RvbSByZXNvdXJjZSB0byBjcmVhdGUvdXBkYXRlL3JlbW92ZSBMYW1iZGEgZnVuY3Rpb25zXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgYWN0aW9uczogW1wibGFtYmRhOipcIiwgXCJzMzoqXCJdLFxuICAgICAgICAgIHJlc291cmNlczogW1wiKlwiXSxcbiAgICAgICAgfSksXG4gICAgICBdLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBGdW5jdGlvbk5hbWVQcmVmaXg6IGAke2Nkay5TdGFjay5vZih0aGlzKS5zdGFja05hbWV9LUVkZ2VMYW1iZGFgLFxuICAgICAgICBGdW5jdGlvbkJ1Y2tldDogYnVja2V0Q1IuZ2V0QXR0U3RyaW5nKFwiQnVja2V0TmFtZVwiKSxcbiAgICAgICAgRnVuY3Rpb25QYXJhbXM6IGZ1bmN0aW9uUHJvcGVydGllcyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBpZiAoZnVuY3Rpb25DUi5oYW5kbGVyLnJvbGUpIHtcbiAgICAgIHJvbGUuZ3JhbnRQYXNzUm9sZShmdW5jdGlvbkNSLmhhbmRsZXIucm9sZSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb25DUi5yZXNvdXJjZS5ub2RlLmFkZERlcGVuZGVuY3koYnVja2V0Q1IpO1xuXG4gICAgLy8gQ3JlYXRlIEZ1bmN0aW9uIFZlcnNpb25cbiAgICBjb25zdCB2ZXJzaW9uQ1IgPSBjcmVhdGVDdXN0b21SZXNvdXJjZSh0aGlzLCBcIkVkZ2VMYW1iZGFWZXJzaW9uXCIsIHtcbiAgICAgIHJlc291cmNlVHlwZTogXCJDdXN0b206OlNTVEVkZ2VMYW1iZGFWZXJzaW9uXCIsXG4gICAgICBzcmNQYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIm5leHRqcy1zaXRlL2N1c3RvbS1yZXNvdXJjZVwiKSxcbiAgICAgIGhhbmRsZXI6IFwiZWRnZS1sYW1iZGEtdmVyc2lvbi5oYW5kbGVyXCIsXG4gICAgICBwb2xpY3lTdGF0ZW1lbnRzOiBbXG4gICAgICAgIC8vIGFsbG93IGN1c3RvbSByZXNvdXJjZSB0byBjcmVhdGUvdXBkYXRlL3JlbW92ZSBMYW1iZGEgZnVuY3Rpb24gdmVyc2lvbnNcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICBhY3Rpb25zOiBbXCJsYW1iZGE6KlwiXSxcbiAgICAgICAgICByZXNvdXJjZXM6IFtcIipcIl0sXG4gICAgICAgIH0pLFxuICAgICAgXSxcbiAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgRnVuY3Rpb25Bcm46IGZ1bmN0aW9uQ1IucmVzb3VyY2UuZ2V0QXR0U3RyaW5nKFwiRnVuY3Rpb25Bcm5cIiksXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gT3ZlcnJpZGUgdGhlIHZlcnNpb24ncyBsb2dpY2FsIElEIHdpdGggYSBsYXp5IHN0cmluZyB3aGljaCBpbmNsdWRlcyB0aGVcbiAgICAvLyBoYXNoIG9mIHRoZSBmdW5jdGlvbiBpdHNlbGYsIHNvIGEgbmV3IHZlcnNpb24gcmVzb3VyY2UgaXMgY3JlYXRlZCB3aGVuXG4gICAgLy8gdGhlIGZ1bmN0aW9uIGNvbmZpZ3VyYXRpb24gY2hhbmdlcy5cbiAgICBjb25zdCBjZm4gPSB2ZXJzaW9uQ1IucmVzb3VyY2Uubm9kZS5kZWZhdWx0Q2hpbGQgYXMgY2RrLkNmblJlc291cmNlO1xuICAgIGNvbnN0IG9yaWdpbmFsTG9naWNhbElkID0gY2RrLlN0YWNrLm9mKHRoaXMpLnJlc29sdmUoY2ZuLmxvZ2ljYWxJZCkgYXMgc3RyaW5nO1xuICAgIGNmbi5vdmVycmlkZUxvZ2ljYWxJZChjZGsuTGF6eS51bmNhY2hlZFN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGhhc2ggPSBjYWxjdWxhdGVIYXNoKGZ1bmN0aW9uQ1IucmVzb3VyY2UpO1xuICAgICAgICBjb25zdCBsb2dpY2FsSWQgPSB0cmltRnJvbVN0YXJ0KG9yaWdpbmFsTG9naWNhbElkLCAyNTUgLSAzMik7XG4gICAgICAgIHJldHVybiBgJHtsb2dpY2FsSWR9JHtoYXNofWA7XG4gICAgICB9LFxuICAgIH0pKTtcblxuICAgIGZuVmVyc2lvbiA9IGxhbWJkYS5WZXJzaW9uLmZyb21WZXJzaW9uQXJuKFxuICAgICAgdGhpcyxcbiAgICAgIGBGdW5jdGlvblZlcnNpb25gLFxuICAgICAgYCR7ZnVuY3Rpb25DUi5yZXNvdXJjZS5nZXRBdHRTdHJpbmcoXCJGdW5jdGlvbkFyblwiKX06JHt2ZXJzaW9uQ1IucmVzb3VyY2UuZ2V0QXR0U3RyaW5nKFwiVmVyc2lvblwiKX1gXG4gICAgKTtcblxuICAgIHJldHVybiBmblZlcnNpb247XG4gIH1cbn1cblxuZnVuY3Rpb24gdHJpbUZyb21TdGFydChzOiBzdHJpbmcsIG1heExlbmd0aDogbnVtYmVyKSB7XG4gIGNvbnN0IGRlc2lyZWRMZW5ndGggPSBNYXRoLm1pbihtYXhMZW5ndGgsIHMubGVuZ3RoKTtcbiAgY29uc3QgbmV3U3RhcnQgPSBzLmxlbmd0aCAtIGRlc2lyZWRMZW5ndGg7XG4gIHJldHVybiBzLnN1YnN0cmluZyhuZXdTdGFydCk7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUhhc2gocmVzb3VyY2U6IGNkay5DdXN0b21SZXNvdXJjZSk6IHN0cmluZyB7XG4gIC8vIHJlbmRlciB0aGUgY2xvdWRmb3JtYXRpb24gcmVzb3VyY2UgZnJvbSB0aGlzIGZ1bmN0aW9uXG4gIC8vIGNvbmZpZyBpcyBvZiB0aGUgc2hhcGU6XG4gIC8vIHtcbiAgLy8gIFJlc291cmNlczoge1xuICAvLyAgICBMb2dpY2FsSWQ6IHtcbiAgLy8gICAgICBUeXBlOiAnRnVuY3Rpb24nLFxuICAvLyAgICAgIFByb3BlcnRpZXM6IHsgLi4uIH1cbiAgLy8gfX19XG4gIGNvbnN0IGNmblJlc291cmNlID0gcmVzb3VyY2Uubm9kZS5kZWZhdWx0Q2hpbGQgYXMgY2RrLkNmblJlc291cmNlO1xuICBjb25zdCBjb25maWcgPSBjZGsuU3RhY2sub2YocmVzb3VyY2UpLnJlc29sdmUoKGNmblJlc291cmNlIGFzIGFueSkuX3RvQ2xvdWRGb3JtYXRpb24oKSk7XG4gIGNvbnN0IHJlc291cmNlcyA9IGNvbmZpZy5SZXNvdXJjZXM7XG4gIGNvbnN0IHJlc291cmNlS2V5cyA9IE9iamVjdC5rZXlzKHJlc291cmNlcyk7XG4gIGlmIChyZXNvdXJjZUtleXMubGVuZ3RoICE9PSAxKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBvbmUgcmVuZGVyZWQgQ2xvdWRGb3JtYXRpb24gcmVzb3VyY2UgYnV0IGZvdW5kICR7cmVzb3VyY2VLZXlzLmxlbmd0aH1gKTtcbiAgfVxuICBjb25zdCBsb2dpY2FsSWQgPSByZXNvdXJjZUtleXNbMF07XG4gIGNvbnN0IHByb3BlcnRpZXMgPSByZXNvdXJjZXNbbG9naWNhbElkXS5Qcm9wZXJ0aWVzLkZ1bmN0aW9uUGFyYW1zO1xuXG4gIGNvbnN0IGhhc2ggPSBjcnlwdG8uY3JlYXRlSGFzaCgnbWQ1Jyk7XG4gIGhhc2gudXBkYXRlKEpTT04uc3RyaW5naWZ5KHByb3BlcnRpZXMpKTtcbiAgcmV0dXJuIGhhc2guZGlnZXN0KCdoZXgnKTtcbn1cbiJdfQ==