"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Stack = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const Function_1 = require("./Function");
const construct_1 = require("./util/construct");
class Stack extends cdk.Stack {
    constructor(scope, id, props) {
        const root = scope.node.root;
        const stackId = root.logicalPrefixedName(id);
        Stack.checkForPropsIsConstruct(id, props);
        Stack.checkForEnvInProps(id, props);
        super(scope, stackId, Object.assign(Object.assign({}, props), { env: {
                account: process.env.CDK_DEFAULT_ACCOUNT,
                region: root.region,
            } }));
        this.stage = root.stage;
        this.defaultFunctionProps = root.defaultFunctionProps.map((dfp) => typeof dfp === "function" ? dfp(this) : dfp);
        this.addMetadataResource();
    }
    setDefaultFunctionProps(props) {
        if (this.node.children.length > 1)
            throw new Error("Default function props for the stack must be set before any resources have been added. Use 'addDefaultFunctionEnv' or 'addDefaultFunctionPermissions' instead to add more default properties.");
        this.defaultFunctionProps.push(props);
    }
    addDefaultFunctionPermissions(permissions) {
        this.defaultFunctionProps.push({
            permissions,
        });
    }
    addDefaultFunctionEnv(environment) {
        this.defaultFunctionProps.push({
            environment,
        });
    }
    addDefaultFunctionLayers(layers) {
        this.defaultFunctionProps.push({
            layers,
        });
    }
    getAllFunctions() {
        return this.doGetAllFunctions(this);
    }
    doGetAllFunctions(construct) {
        const results = [];
        for (const child of construct.node.children) {
            if (child instanceof Function_1.Function)
                results.push(child);
            results.push(...this.doGetAllFunctions(child));
        }
        return results;
    }
    addOutputs(outputs) {
        Object.keys(outputs).forEach((key) => {
            const value = outputs[key];
            if (value === undefined) {
                throw new Error(`The stack output "${key}" is undefined`);
            }
            else if (typeof value === "string") {
                new cdk.CfnOutput(this, key, { value });
            }
            else {
                new cdk.CfnOutput(this, key, value);
            }
        });
    }
    addMetadataResource() {
        // Add a placeholder resource to ensure stacks with just an imported construct
        // has at least 1 resource, so the deployment succeeds.
        // For example: users often create a stack and use it to import a VPC. The
        //              stack does not have any resources.
        new cdk.CfnResource(this, "SSTMetadata", {
            type: "AWS::CDK::Metadata",
        });
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    static checkForPropsIsConstruct(id, props) {
        // If a construct is passed in as stack props, let's detect it and throw a
        // friendlier error.
        if (props && (0, construct_1.isConstruct)(props)) {
            throw new Error(`Expected an associative array as the stack props while initializing "${id}" stack. Received a construct instead.`);
        }
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    static checkForEnvInProps(id, props) {
        if (props && props.env) {
            let envS = "";
            try {
                envS = " (" + JSON.stringify(props.env) + ")";
            }
            catch (e) {
                // Ignore
            }
            throw new Error(`Do not set the "env" prop while initializing "${id}" stack${envS}. Use the "AWS_PROFILE" environment variable and "--region" CLI option instead.`);
        }
    }
}
exports.Stack = Stack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvU3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1EQUFxQztBQUNyQyx5Q0FBMkQ7QUFFM0QsZ0RBQStDO0FBTS9DLE1BQWEsS0FBTSxTQUFRLEdBQUcsQ0FBQyxLQUFLO0lBSWxDLFlBQVksS0FBb0IsRUFBRSxFQUFVLEVBQUUsS0FBa0I7UUFDOUQsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFXLENBQUM7UUFDcEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTdDLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDMUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUVwQyxLQUFLLENBQUMsS0FBSyxFQUFFLE9BQU8sa0NBQ2YsS0FBSyxLQUNSLEdBQUcsRUFBRTtnQkFDSCxPQUFPLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUI7Z0JBQ3hDLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTTthQUNwQixJQUNELENBQUM7UUFFSCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDeEIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUNoRSxPQUFPLEdBQUcsS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUM1QyxDQUFDO1FBRUYsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7SUFDN0IsQ0FBQztJQUVNLHVCQUF1QixDQUFDLEtBQW9CO1FBQ2pELElBQUksSUFBSSxDQUFD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QUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO2FBQy9DO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1YsU0FBUzthQUNWO1lBRUQsTUFBTSxJQUFJLEtBQUssQ0FDYixpREFBaUQsRUFBRSxVQUFVLElBQUksaUZBQWlGLENBQ25KLENBQUM7U0FDSDtJQUNILENBQUM7Q0FDRjtBQXRIRCxzQkFzSEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSBcIkBhd3MtY2RrL2NvcmVcIjtcbmltcG9ydCB7IEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uIGFzIEZuIH0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgaXNDb25zdHJ1Y3QgfSBmcm9tIFwiLi91dGlsL2NvbnN0cnVjdFwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiQGF3cy1jZGsvYXdzLWxhbWJkYVwiO1xuXG5leHBvcnQgdHlwZSBTdGFja1Byb3BzID0gY2RrLlN0YWNrUHJvcHM7XG5cbmV4cG9ydCBjbGFzcyBTdGFjayBleHRlbmRzIGNkay5TdGFjayB7XG4gIHB1YmxpYyByZWFkb25seSBzdGFnZTogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM6IEZ1bmN0aW9uUHJvcHNbXTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkNvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBTdGFja1Byb3BzKSB7XG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3Qgc3RhY2tJZCA9IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShpZCk7XG5cbiAgICBTdGFjay5jaGVja0ZvclByb3BzSXNDb25zdHJ1Y3QoaWQsIHByb3BzKTtcbiAgICBTdGFjay5jaGVja0ZvckVudkluUHJvcHMoaWQsIHByb3BzKTtcblxuICAgIHN1cGVyKHNjb3BlLCBzdGFja0lkLCB7XG4gICAgICAuLi5wcm9wcyxcbiAgICAgIGVudjoge1xuICAgICAgICBhY2NvdW50OiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9BQ0NPVU5ULFxuICAgICAgICByZWdpb246IHJvb3QucmVnaW9uLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMuc3RhZ2UgPSByb290LnN0YWdlO1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMgPSByb290LmRlZmF1bHRGdW5jdGlvblByb3BzLm1hcCgoZGZwKSA9PlxuICAgICAgdHlwZW9mIGRmcCA9PT0gXCJmdW5jdGlvblwiID8gZGZwKHRoaXMpIDogZGZwXG4gICAgKTtcblxuICAgIHRoaXMuYWRkTWV0YWRhdGFSZXNvdXJjZSgpO1xuICB9XG5cbiAgcHVibGljIHNldERlZmF1bHRGdW5jdGlvblByb3BzKHByb3BzOiBGdW5jdGlvblByb3BzKTogdm9pZCB7XG4gICAgaWYgKHRoaXMubm9kZS5jaGlsZHJlbi5sZW5ndGggPiAxKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIkRlZmF1bHQgZnVuY3Rpb24gcHJvcHMgZm9yIHRoZSBzdGFjayBtdXN0IGJlIHNldCBiZWZvcmUgYW55IHJlc291cmNlcyBoYXZlIGJlZW4gYWRkZWQuIFVzZSAnYWRkRGVmYXVsdEZ1bmN0aW9uRW52JyBvciAnYWRkRGVmYXVsdEZ1bmN0aW9uUGVybWlzc2lvbnMnIGluc3RlYWQgdG8gYWRkIG1vcmUgZGVmYXVsdCBwcm9wZXJ0aWVzLlwiXG4gICAgICApO1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMucHVzaChwcm9wcyk7XG4gIH1cblxuICBwdWJsaWMgYWRkRGVmYXVsdEZ1bmN0aW9uUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKSB7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHtcbiAgICAgIHBlcm1pc3Npb25zLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFkZERlZmF1bHRGdW5jdGlvbkVudihlbnZpcm9ubWVudDogUmVjb3JkPHN0cmluZywgc3RyaW5nPikge1xuICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMucHVzaCh7XG4gICAgICBlbnZpcm9ubWVudCxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhZGREZWZhdWx0RnVuY3Rpb25MYXllcnMobGF5ZXJzOiBsYW1iZGEuSUxheWVyVmVyc2lvbltdKSB7XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcy5wdXNoKHtcbiAgICAgIGxheWVycyxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRBbGxGdW5jdGlvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuZG9HZXRBbGxGdW5jdGlvbnModGhpcyk7XG4gIH1cblxuICBwcml2YXRlIGRvR2V0QWxsRnVuY3Rpb25zKGNvbnN0cnVjdDogY2RrLklDb25zdHJ1Y3QpIHtcbiAgICBjb25zdCByZXN1bHRzOiBGbltdID0gW107XG4gICAgZm9yIChjb25zdCBjaGlsZCBvZiBjb25zdHJ1Y3Qubm9kZS5jaGlsZHJlbikge1xuICAgICAgaWYgKGNoaWxkIGluc3RhbmNlb2YgRm4pIHJlc3VsdHMucHVzaChjaGlsZCk7XG4gICAgICByZXN1bHRzLnB1c2goLi4udGhpcy5kb0dldEFsbEZ1bmN0aW9ucyhjaGlsZCkpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0cztcbiAgfVxuXG4gIHB1YmxpYyBhZGRPdXRwdXRzKG91dHB1dHM6IHtcbiAgICBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBjZGsuQ2ZuT3V0cHV0UHJvcHM7XG4gIH0pOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyhvdXRwdXRzKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIGNvbnN0IHZhbHVlID0gb3V0cHV0c1trZXldO1xuICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgc3RhY2sgb3V0cHV0IFwiJHtrZXl9XCIgaXMgdW5kZWZpbmVkYCk7XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBrZXksIHsgdmFsdWUgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBrZXksIHZhbHVlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkTWV0YWRhdGFSZXNvdXJjZSgpOiB2b2lkIHtcbiAgICAvLyBBZGQgYSBwbGFjZWhvbGRlciByZXNvdXJjZSB0byBlbnN1cmUgc3RhY2tzIHdpdGgganVzdCBhbiBpbXBvcnRlZCBjb25zdHJ1Y3RcbiAgICAvLyBoYXMgYXQgbGVhc3QgMSByZXNvdXJjZSwgc28gdGhlIGRlcGxveW1lbnQgc3VjY2VlZHMuXG4gICAgLy8gRm9yIGV4YW1wbGU6IHVzZXJzIG9mdGVuIGNyZWF0ZSBhIHN0YWNrIGFuZCB1c2UgaXQgdG8gaW1wb3J0IGEgVlBDLiBUaGVcbiAgICAvLyAgICAgICAgICAgICAgc3RhY2sgZG9lcyBub3QgaGF2ZSBhbnkgcmVzb3VyY2VzLlxuICAgIG5ldyBjZGsuQ2ZuUmVzb3VyY2UodGhpcywgXCJTU1RNZXRhZGF0YVwiLCB7XG4gICAgICB0eXBlOiBcIkFXUzo6Q0RLOjpNZXRhZGF0YVwiLFxuICAgIH0pO1xuICB9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgcHJpdmF0ZSBzdGF0aWMgY2hlY2tGb3JQcm9wc0lzQ29uc3RydWN0KGlkOiBzdHJpbmcsIHByb3BzPzogYW55KSB7XG4gICAgLy8gSWYgYSBjb25zdHJ1Y3QgaXMgcGFzc2VkIGluIGFzIHN0YWNrIHByb3BzLCBsZXQncyBkZXRlY3QgaXQgYW5kIHRocm93IGFcbiAgICAvLyBmcmllbmRsaWVyIGVycm9yLlxuICAgIGlmIChwcm9wcyAmJiBpc0NvbnN0cnVjdChwcm9wcykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEV4cGVjdGVkIGFuIGFzc29jaWF0aXZlIGFycmF5IGFzIHRoZSBzdGFjayBwcm9wcyB3aGlsZSBpbml0aWFsaXppbmcgXCIke2lkfVwiIHN0YWNrLiBSZWNlaXZlZCBhIGNvbnN0cnVjdCBpbnN0ZWFkLmBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgcHJpdmF0ZSBzdGF0aWMgY2hlY2tGb3JFbnZJblByb3BzKGlkOiBzdHJpbmcsIHByb3BzPzogYW55KSB7XG4gICAgaWYgKHByb3BzICYmIHByb3BzLmVudikge1xuICAgICAgbGV0IGVudlMgPSBcIlwiO1xuXG4gICAgICB0cnkge1xuICAgICAgICBlbnZTID0gXCIgKFwiICsgSlNPTi5zdHJpbmdpZnkocHJvcHMuZW52KSArIFwiKVwiO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvLyBJZ25vcmVcbiAgICAgIH1cblxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRG8gbm90IHNldCB0aGUgXCJlbnZcIiBwcm9wIHdoaWxlIGluaXRpYWxpemluZyBcIiR7aWR9XCIgc3RhY2ske2VudlN9LiBVc2UgdGhlIFwiQVdTX1BST0ZJTEVcIiBlbnZpcm9ubWVudCB2YXJpYWJsZSBhbmQgXCItLXJlZ2lvblwiIENMSSBvcHRpb24gaW5zdGVhZC5gXG4gICAgICApO1xuICAgIH1cbiAgfVxufVxuIl19