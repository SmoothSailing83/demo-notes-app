"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Queue = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const sqs = __importStar(require("@aws-cdk/aws-sqs"));
const lambdaEventSources = __importStar(require("@aws-cdk/aws-lambda-event-sources"));
const Stack_1 = require("./Stack");
const Function_1 = require("./Function");
class Queue extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { 
        // Queue props
        sqsQueue, 
        // Function props
        consumer, } = props || {};
        this.permissionsAttachedForAllConsumers = [];
        ////////////////////
        // Create Queue
        ////////////////////
        if (cdk.Construct.isConstruct(sqsQueue)) {
            this.sqsQueue = sqsQueue;
        }
        else {
            const sqsQueueProps = sqsQueue || {};
            // If debugIncreaseTimeout is enabled (ie. sst start):
            // - Set visibilityTimeout to > 900s. This is because Lambda timeout is
            //   set to 900s, and visibilityTimeout has to be greater or equal to it.
            //   This will give people more time to debug the function without timing
            //   out the request.
            let debugOverrideProps;
            if (root.debugIncreaseTimeout) {
                if (!sqsQueueProps.visibilityTimeout ||
                    sqsQueueProps.visibilityTimeout.toSeconds() < 900) {
                    debugOverrideProps = {
                        visibilityTimeout: cdk.Duration.seconds(900),
                    };
                }
            }
            const name = root.logicalPrefixedName(id) + (sqsQueueProps.fifo ? ".fifo" : "");
            this.sqsQueue = new sqs.Queue(this, "Queue", Object.assign(Object.assign({ queueName: name }, sqsQueueProps), (debugOverrideProps || {})));
        }
        ///////////////////////////
        // Create Consumer
        ///////////////////////////
        if (consumer) {
            this.addConsumer(this, consumer);
        }
        ///////////////////
        // Register Construct
        ///////////////////
        root.registerConstruct(this);
    }
    addConsumer(scope, consumer) {
        if (this.consumerFunction) {
            throw new Error("Cannot configure more than 1 consumer for a Queue");
        }
        // create consumer
        if (consumer.function) {
            consumer = consumer;
            this.consumerFunction = Function_1.Function.fromDefinition(scope, "Consumer", consumer.function);
            this.consumerFunction.addEventSource(new lambdaEventSources.SqsEventSource(this.sqsQueue, consumer.consumerProps));
        }
        else {
            consumer = consumer;
            this.consumerFunction = Function_1.Function.fromDefinition(scope, `Consumer`, consumer);
            this.consumerFunction.addEventSource(new lambdaEventSources.SqsEventSource(this.sqsQueue));
        }
        // attach permissions
        this.permissionsAttachedForAllConsumers.forEach((permissions) => {
            if (this.consumerFunction) {
                this.consumerFunction.attachPermissions(permissions);
            }
        });
    }
    attachPermissions(permissions) {
        if (this.consumerFunction) {
            this.consumerFunction.attachPermissions(permissions);
        }
        this.permissionsAttachedForAllConsumers.push(permissions);
    }
    getConstructInfo() {
        // imported
        // queueArn: arn:aws:sqs:us-east-1:112233445566:myQueue
        // queueUrl: https://sqs.us-east-1.${Token[AWS.URLSuffix.9]}/112233445566/myQueue
        if (!cdk.Token.isUnresolved(this.sqsQueue.queueArn)) {
            const [, , , region, accountId, name] = this.sqsQueue.queueArn.split(":");
            return {
                queueUrl: `https://sqs.${region}.amazonaws.com/${accountId}/${name}`,
            };
        }
        // created
        const cfn = this.sqsQueue.node.defaultChild;
        return {
            queueLogicalId: Stack_1.Stack.of(this).getLogicalId(cfn),
        };
    }
}
exports.Queue = Queue;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUXVldWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvUXVldWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1EQUFxQztBQUNyQyxzREFBd0M7QUFDeEMsc0ZBQXdFO0FBRXhFLG1DQUFnQztBQUVoQyx5Q0FBZ0U7QUFhaEUsTUFBYSxLQUFNLFNBQVEsR0FBRyxDQUFDLFNBQVM7SUFLdEMsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFrQjtRQUM5RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLE1BQU07UUFDSixjQUFjO1FBQ2QsUUFBUTtRQUNSLGlCQUFpQjtRQUNqQixRQUFRLEdBQ1QsR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxrQ0FBa0MsR0FBRyxFQUFFLENBQUM7UUFFN0Msb0JBQW9CO1FBQ3BCLGVBQWU7UUFDZixvQkFBb0I7UUFDcEIsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUN2QyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQXFCLENBQUM7U0FDdkM7YUFBTTtZQUNMLE1BQU0sYUFBYSxHQUFtQixRQUFRLElBQUksRUFBRSxDQUFDO1lBRXJELHNEQUFzRDtZQUN0RCx1RUFBdUU7WUFDdkUseUVBQXlFO1lBQ3pFLHlFQUF5RTtZQUN6RSxxQkFBcUI7WUFDckIsSUFBSSxrQkFBa0IsQ0FBQztZQUN2QixJQUFJLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtnQkFDN0IsSUFDRSxDQUFDLGFBQWEsQ0FBQyxpQkFBaUI7b0JBQ2hDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLEVBQUUsR0FBRyxHQUFHLEVBQ2pEO29CQUNBLGtCQUFrQixHQUFHO3dCQUNuQixpQkFBaUIsRUFB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QztZQUMxRSxPQUFPO2dCQUNMLFFBQVEsRUFBRSxlQUFlLE1BQU0sa0JBQWtCLFNBQVMsSUFBSSxJQUFJLEVBQUU7YUFDckUsQ0FBQztTQUNIO1FBQ0QsVUFBVTtRQUNWLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFlBQTRCLENBQUM7UUFDNUQsT0FBTztZQUNMLGNBQWMsRUFBRSxhQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUM7U0FDakQsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQTlIRCxzQkE4SEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSBcIkBhd3MtY2RrL2NvcmVcIjtcbmltcG9ydCAqIGFzIHNxcyBmcm9tIFwiQGF3cy1jZGsvYXdzLXNxc1wiO1xuaW1wb3J0ICogYXMgbGFtYmRhRXZlbnRTb3VyY2VzIGZyb20gXCJAYXdzLWNkay9hd3MtbGFtYmRhLWV2ZW50LXNvdXJjZXNcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgU3RhY2sgfSBmcm9tIFwiLi9TdGFja1wiO1xuaW1wb3J0IHsgSVNzdENvbnN0cnVjdCwgSVNzdENvbnN0cnVjdEluZm8gfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuZXhwb3J0IGludGVyZmFjZSBRdWV1ZVByb3BzIHtcbiAgcmVhZG9ubHkgc3FzUXVldWU/OiBzcXMuSVF1ZXVlIHwgc3FzLlF1ZXVlUHJvcHM7XG4gIHJlYWRvbmx5IGNvbnN1bWVyPzogRnVuY3Rpb25EZWZpbml0aW9uIHwgUXVldWVDb25zdW1lclByb3BzO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXVlQ29uc3VtZXJQcm9wcyB7XG4gIHJlYWRvbmx5IGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IGNvbnN1bWVyUHJvcHM/OiBsYW1iZGFFdmVudFNvdXJjZXMuU3FzRXZlbnRTb3VyY2VQcm9wcztcbn1cblxuZXhwb3J0IGNsYXNzIFF1ZXVlIGV4dGVuZHMgY2RrLkNvbnN0cnVjdCBpbXBsZW1lbnRzIElTc3RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgc3FzUXVldWU6IHNxcy5RdWV1ZTtcbiAgcHVibGljIGNvbnN1bWVyRnVuY3Rpb24/OiBGbjtcbiAgcHJpdmF0ZSByZWFkb25seSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsQ29uc3VtZXJzOiBQZXJtaXNzaW9uc1tdO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IFF1ZXVlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3Qge1xuICAgICAgLy8gUXVldWUgcHJvcHNcbiAgICAgIHNxc1F1ZXVlLFxuICAgICAgLy8gRnVuY3Rpb24gcHJvcHNcbiAgICAgIGNvbnN1bWVyLFxuICAgIH0gPSBwcm9wcyB8fCB7fTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxDb25zdW1lcnMgPSBbXTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIFF1ZXVlXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBpZiAoY2RrLkNvbnN0cnVjdC5pc0NvbnN0cnVjdChzcXNRdWV1ZSkpIHtcbiAgICAgIHRoaXMuc3FzUXVldWUgPSBzcXNRdWV1ZSBhcyBzcXMuUXVldWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHNxc1F1ZXVlUHJvcHM6IHNxcy5RdWV1ZVByb3BzID0gc3FzUXVldWUgfHwge307XG5cbiAgICAgIC8vIElmIGRlYnVnSW5jcmVhc2VUaW1lb3V0IGlzIGVuYWJsZWQgKGllLiBzc3Qgc3RhcnQpOlxuICAgICAgLy8gLSBTZXQgdmlzaWJpbGl0eVRpbWVvdXQgdG8gPiA5MDBzLiBUaGlzIGlzIGJlY2F1c2UgTGFtYmRhIHRpbWVvdXQgaXNcbiAgICAgIC8vICAgc2V0IHRvIDkwMHMsIGFuZCB2aXNpYmlsaXR5VGltZW91dCBoYXMgdG8gYmUgZ3JlYXRlciBvciBlcXVhbCB0byBpdC5cbiAgICAgIC8vICAgVGhpcyB3aWxsIGdpdmUgcGVvcGxlIG1vcmUgdGltZSB0byBkZWJ1ZyB0aGUgZnVuY3Rpb24gd2l0aG91dCB0aW1pbmdcbiAgICAgIC8vICAgb3V0IHRoZSByZXF1ZXN0LlxuICAgICAgbGV0IGRlYnVnT3ZlcnJpZGVQcm9wcztcbiAgICAgIGlmIChyb290LmRlYnVnSW5jcmVhc2VUaW1lb3V0KSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAhc3FzUXVldWVQcm9wcy52aXNpYmlsaXR5VGltZW91dCB8fFxuICAgICAgICAgIHNxc1F1ZXVlUHJvcHMudmlzaWJpbGl0eVRpbWVvdXQudG9TZWNvbmRzKCkgPCA5MDBcbiAgICAgICAgKSB7XG4gICAgICAgICAgZGVidWdPdmVycmlkZVByb3BzID0ge1xuICAgICAgICAgICAgdmlzaWJpbGl0eVRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDkwMCksXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBuYW1lID1cbiAgICAgICAgcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSArIChzcXNRdWV1ZVByb3BzLmZpZm8gPyBcIi5maWZvXCIgOiBcIlwiKTtcbiAgICAgIHRoaXMuc3FzUXVldWUgPSBuZXcgc3FzLlF1ZXVlKHRoaXMsIFwiUXVldWVcIiwge1xuICAgICAgICBxdWV1ZU5hbWU6IG5hbWUsXG4gICAgICAgIC4uLnNxc1F1ZXVlUHJvcHMsXG4gICAgICAgIC4uLihkZWJ1Z092ZXJyaWRlUHJvcHMgfHwge30pLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIENvbnN1bWVyXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgaWYgKGNvbnN1bWVyKSB7XG4gICAgICB0aGlzLmFkZENvbnN1bWVyKHRoaXMsIGNvbnN1bWVyKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gUmVnaXN0ZXIgQ29uc3RydWN0XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIHJvb3QucmVnaXN0ZXJDb25zdHJ1Y3QodGhpcyk7XG4gIH1cblxuICBwdWJsaWMgYWRkQ29uc3VtZXIoXG4gICAgc2NvcGU6IGNkay5Db25zdHJ1Y3QsXG4gICAgY29uc3VtZXI6IEZ1bmN0aW9uRGVmaW5pdGlvbiB8IFF1ZXVlQ29uc3VtZXJQcm9wc1xuICApOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jb25zdW1lckZ1bmN0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgY29uZmlndXJlIG1vcmUgdGhhbiAxIGNvbnN1bWVyIGZvciBhIFF1ZXVlXCIpO1xuICAgIH1cblxuICAgIC8vIGNyZWF0ZSBjb25zdW1lclxuICAgIGlmICgoY29uc3VtZXIgYXMgUXVldWVDb25zdW1lclByb3BzKS5mdW5jdGlvbikge1xuICAgICAgY29uc3VtZXIgPSBjb25zdW1lciBhcyBRdWV1ZUNvbnN1bWVyUHJvcHM7XG4gICAgICB0aGlzLmNvbnN1bWVyRnVuY3Rpb24gPSBGbi5mcm9tRGVmaW5pdGlvbihcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIFwiQ29uc3VtZXJcIixcbiAgICAgICAgY29uc3VtZXIuZnVuY3Rpb25cbiAgICAgICk7XG4gICAgICB0aGlzLmNvbnN1bWVyRnVuY3Rpb24uYWRkRXZlbnRTb3VyY2UoXG4gICAgICAgIG5ldyBsYW1iZGFFdmVudFNvdXJjZXMuU3FzRXZlbnRTb3VyY2UoXG4gICAgICAgICAgdGhpcy5zcXNRdWV1ZSxcbiAgICAgICAgICBjb25zdW1lci5jb25zdW1lclByb3BzXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN1bWVyID0gY29uc3VtZXIgYXMgRnVuY3Rpb25EZWZpbml0aW9uO1xuICAgICAgdGhpcy5jb25zdW1lckZ1bmN0aW9uID0gRm4uZnJvbURlZmluaXRpb24oc2NvcGUsIGBDb25zdW1lcmAsIGNvbnN1bWVyKTtcbiAgICAgIHRoaXMuY29uc3VtZXJGdW5jdGlvbi5hZGRFdmVudFNvdXJjZShcbiAgICAgICAgbmV3IGxhbWJkYUV2ZW50U291cmNlcy5TcXNFdmVudFNvdXJjZSh0aGlzLnNxc1F1ZXVlKVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBhdHRhY2ggcGVybWlzc2lvbnNcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxDb25zdW1lcnMuZm9yRWFjaCgocGVybWlzc2lvbnMpID0+IHtcbiAgICAgIGlmICh0aGlzLmNvbnN1bWVyRnVuY3Rpb24pIHtcbiAgICAgICAgdGhpcy5jb25zdW1lckZ1bmN0aW9uLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jb25zdW1lckZ1bmN0aW9uKSB7XG4gICAgICB0aGlzLmNvbnN1bWVyRnVuY3Rpb24uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICAgIH1cblxuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbENvbnN1bWVycy5wdXNoKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RJbmZvKCk6IElTc3RDb25zdHJ1Y3RJbmZvIHtcbiAgICAvLyBpbXBvcnRlZFxuICAgIC8vIHF1ZXVlQXJuOiBhcm46YXdzOnNxczp1cy1lYXN0LTE6MTEyMjMzNDQ1NTY2Om15UXVldWVcbiAgICAvLyBxdWV1ZVVybDogaHR0cHM6Ly9zcXMudXMtZWFzdC0xLiR7VG9rZW5bQVdTLlVSTFN1ZmZpeC45XX0vMTEyMjMzNDQ1NTY2L215UXVldWVcbiAgICBpZiAoIWNkay5Ub2tlbi5pc1VucmVzb2x2ZWQodGhpcy5zcXNRdWV1ZS5xdWV1ZUFybikpIHtcbiAgICAgIGNvbnN0IFssICwgLCByZWdpb24sIGFjY291bnRJZCwgbmFtZV0gPSB0aGlzLnNxc1F1ZXVlLnF1ZXVlQXJuLnNwbGl0KFwiOlwiKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHF1ZXVlVXJsOiBgaHR0cHM6Ly9zcXMuJHtyZWdpb259LmFtYXpvbmF3cy5jb20vJHthY2NvdW50SWR9LyR7bmFtZX1gLFxuICAgICAgfTtcbiAgICB9XG4gICAgLy8gY3JlYXRlZFxuICAgIGNvbnN0IGNmbiA9IHRoaXMuc3FzUXVldWUubm9kZS5kZWZhdWx0Q2hpbGQgYXMgc3FzLkNmblF1ZXVlO1xuICAgIHJldHVybiB7XG4gICAgICBxdWV1ZUxvZ2ljYWxJZDogU3RhY2sub2YodGhpcykuZ2V0TG9naWNhbElkKGNmbiksXG4gICAgfTtcbiAgfVxufVxuIl19