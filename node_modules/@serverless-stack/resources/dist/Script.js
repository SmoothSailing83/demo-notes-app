"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Script = void 0;
const path_1 = __importDefault(require("path"));
const cdk = __importStar(require("@aws-cdk/core"));
const lambda = __importStar(require("@aws-cdk/aws-lambda"));
const Function_1 = require("./Function");
class Script extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // Validate deprecated "function" prop
        if (props.function)
            this.checkDeprecatedFunction();
        // Validate at least 1 function is provided
        if (!props.onCreate && !props.onUpdate && !props.onDelete) {
            throw new Error(`Need to provide at least one of "onCreate", "onUpdate", or "onDelete" functions for the "${this.node.id}" Script`);
        }
        const root = scope.node.root;
        this.props = props;
        this.createFunction = this.createUserFunction("onCreate", props.onCreate);
        this.updateFunction = this.createUserFunction("onUpdate", props.onUpdate);
        this.deleteFunction = this.createUserFunction("onDelete", props.onDelete);
        const crFunction = this.createCustomResourceFunction();
        this.createCustomResource(root, crFunction);
    }
    attachPermissions(permissions) {
        var _a, _b, _c;
        (_a = this.createFunction) === null || _a === void 0 ? void 0 : _a.attachPermissions(permissions);
        (_b = this.updateFunction) === null || _b === void 0 ? void 0 : _b.attachPermissions(permissions);
        (_c = this.deleteFunction) === null || _c === void 0 ? void 0 : _c.attachPermissions(permissions);
    }
    createUserFunction(type, fnDef) {
        if (!fnDef) {
            return;
        }
        // function is construct => return function directly
        if (fnDef instanceof Function_1.Function) {
            // validate live dev is not enabled
            if (fnDef._isLiveDevEnabled) {
                throw new Error(`Live Lambda Dev cannot be enabled for functions in the Script construct. Set the "enableLiveDev" prop for the function to "false".`);
            }
            return Function_1.Function.fromDefinition(this, `${type}Function`, fnDef, this.props.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define the "${type}" function using FunctionProps, so the Script construct can apply the "defaultFunctionProps" to them.`);
        }
        // function is string => create function
        else if (typeof fnDef === "string") {
            return Function_1.Function.fromDefinition(this, `${type}Function`, {
                handler: fnDef,
                enableLiveDev: false,
            }, Object.assign({ timeout: 900 }, this.props.defaultFunctionProps));
        }
        // function is props => create function
        return Function_1.Function.fromDefinition(this, `${type}Function`, Object.assign(Object.assign({}, fnDef), { enableLiveDev: false }), Object.assign({ timeout: 900 }, this.props.defaultFunctionProps));
    }
    createCustomResourceFunction() {
        var _a, _b, _c;
        const handler = new lambda.Function(this, "ScriptHandler", {
            code: lambda.Code.fromAsset(path_1.default.join(__dirname, "Script")),
            runtime: lambda.Runtime.NODEJS_14_X,
            handler: "index.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        (_a = this.createFunction) === null || _a === void 0 ? void 0 : _a.grantInvoke(handler);
        (_b = this.updateFunction) === null || _b === void 0 ? void 0 : _b.grantInvoke(handler);
        (_c = this.deleteFunction) === null || _c === void 0 ? void 0 : _c.grantInvoke(handler);
        return handler;
    }
    createCustomResource(app, crFunction) {
        var _a, _b, _c;
        // Note: "BuiltAt" is set to current timestamp to ensure the Custom
        //       Resource function is run on every update.
        //
        //       Do not use the current timestamp in Live mode, b/c we want the
        //       this custom resource to remain the same in CloudFormation template
        //       when rebuilding infrastructure. Otherwise, there will always be
        //       a change when rebuilding infrastructure b/c the "BuildAt" property
        //       changes on each build.
        const builtAt = app.local ? app.debugStartedAt : Date.now();
        new cdk.CustomResource(this, "ScriptResource", {
            serviceToken: crFunction.functionArn,
            resourceType: "Custom::SSTScript",
            properties: {
                UserCreateFunction: (_a = this.createFunction) === null || _a === void 0 ? void 0 : _a.functionName,
                UserUpdateFunction: (_b = this.updateFunction) === null || _b === void 0 ? void 0 : _b.functionName,
                UserDeleteFunction: (_c = this.deleteFunction) === null || _c === void 0 ? void 0 : _c.functionName,
                UserParams: JSON.stringify(this.props.params || {}),
                BuiltAt: builtAt,
            },
        });
    }
    checkDeprecatedFunction() {
        throw new Error(`The "function" property has been replaced by "onCreate" and "onUpdate". More details on upgrading - https://docs.serverless-stack.com/constructs/Script#upgrading-to-v0460`);
    }
}
exports.Script = Script;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1NjcmlwdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsZ0RBQXdCO0FBQ3hCLG1EQUFxQztBQUNyQyw0REFBOEM7QUFFOUMseUNBQStFO0FBVy9FLE1BQWEsTUFBTyxTQUFRLEdBQUcsQ0FBQyxTQUFTO0lBTXZDLFlBQVksS0FBb0IsRUFBRSxFQUFVLEVBQUUsS0FBa0I7UUFDOUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixzQ0FBc0M7UUFDdEMsSUFBSyxLQUFhLENBQUMsUUFBUTtZQUFFLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBRTVELDJDQUEyQztRQUMzQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFO1lBQ3pELE1BQU0sSUFBSSxLQUFLLENBQ2IsNEZBQTRGLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxVQUFVLENBQ25ILENBQUM7U0FDSDtRQUVELE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBRW5CLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUUsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMxRSxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzFFLE1BQU0sVUFBVSxHQUFHLElB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Q0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDNUQsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRTtZQUM3QyxZQUFZLEVBQUUsVUFBVSxDQUFDLFdBQVc7WUFDcEMsWUFBWSxFQUFFLG1CQUFtQjtZQUNqQyxVQUFVLEVBQUU7Z0JBQ1Ysa0JBQWtCLEVBQUUsTUFBQSxJQUFJLENBQUMsY0FBYywwQ0FBRSxZQUFZO2dCQUNyRCxrQkFBa0IsRUFBRSxNQUFBLElBQUksQ0FBQyxjQUFjLDBDQUFFLFlBQVk7Z0JBQ3JELGtCQUFrQixFQUFFLE1BQUEsSUFBSSxDQUFDLGNBQWMsMENBQUUsWUFBWTtnQkFDckQsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO2dCQUNuRCxPQUFPLEVBQUUsT0FBTzthQUNqQjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyx1QkFBdUI7UUFDN0IsTUFBTSxJQUFJLEtBQUssQ0FDYiw0S0FBNEssQ0FDN0ssQ0FBQztJQUNKLENBQUM7Q0FDRjtBQXZJRCx3QkF1SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSBcIkBhd3MtY2RrL2F3cy1sYW1iZGFcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gYXMgRm4sIEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uRGVmaW5pdGlvbiB9IGZyb20gXCIuL0Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucyB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNjcmlwdFByb3BzIHtcbiAgcmVhZG9ubHkgb25DcmVhdGU/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IG9uVXBkYXRlPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBvbkRlbGV0ZT86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgcGFyYW1zPzogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbiAgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xufVxuXG5leHBvcnQgY2xhc3MgU2NyaXB0IGV4dGVuZHMgY2RrLkNvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBjcmVhdGVGdW5jdGlvbj86IEZuO1xuICBwdWJsaWMgcmVhZG9ubHkgdXBkYXRlRnVuY3Rpb24/OiBGbjtcbiAgcHVibGljIHJlYWRvbmx5IGRlbGV0ZUZ1bmN0aW9uPzogRm47XG4gIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IFNjcmlwdFByb3BzO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogU2NyaXB0UHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgLy8gVmFsaWRhdGUgZGVwcmVjYXRlZCBcImZ1bmN0aW9uXCIgcHJvcFxuICAgIGlmICgocHJvcHMgYXMgYW55KS5mdW5jdGlvbikgdGhpcy5jaGVja0RlcHJlY2F0ZWRGdW5jdGlvbigpO1xuXG4gICAgLy8gVmFsaWRhdGUgYXQgbGVhc3QgMSBmdW5jdGlvbiBpcyBwcm92aWRlZFxuICAgIGlmICghcHJvcHMub25DcmVhdGUgJiYgIXByb3BzLm9uVXBkYXRlICYmICFwcm9wcy5vbkRlbGV0ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgTmVlZCB0byBwcm92aWRlIGF0IGxlYXN0IG9uZSBvZiBcIm9uQ3JlYXRlXCIsIFwib25VcGRhdGVcIiwgb3IgXCJvbkRlbGV0ZVwiIGZ1bmN0aW9ucyBmb3IgdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgU2NyaXB0YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICB0aGlzLnByb3BzID0gcHJvcHM7XG5cbiAgICB0aGlzLmNyZWF0ZUZ1bmN0aW9uID0gdGhpcy5jcmVhdGVVc2VyRnVuY3Rpb24oXCJvbkNyZWF0ZVwiLCBwcm9wcy5vbkNyZWF0ZSk7XG4gICAgdGhpcy51cGRhdGVGdW5jdGlvbiA9IHRoaXMuY3JlYXRlVXNlckZ1bmN0aW9uKFwib25VcGRhdGVcIiwgcHJvcHMub25VcGRhdGUpO1xuICAgIHRoaXMuZGVsZXRlRnVuY3Rpb24gPSB0aGlzLmNyZWF0ZVVzZXJGdW5jdGlvbihcIm9uRGVsZXRlXCIsIHByb3BzLm9uRGVsZXRlKTtcbiAgICBjb25zdCBjckZ1bmN0aW9uID0gdGhpcy5jcmVhdGVDdXN0b21SZXNvdXJjZUZ1bmN0aW9uKCk7XG4gICAgdGhpcy5jcmVhdGVDdXN0b21SZXNvdXJjZShyb290LCBjckZ1bmN0aW9uKTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICB0aGlzLmNyZWF0ZUZ1bmN0aW9uPy5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gICAgdGhpcy51cGRhdGVGdW5jdGlvbj8uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICAgIHRoaXMuZGVsZXRlRnVuY3Rpb24/LmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlVXNlckZ1bmN0aW9uKFxuICAgIHR5cGU6IHN0cmluZyxcbiAgICBmbkRlZj86IEZ1bmN0aW9uRGVmaW5pdGlvblxuICApOiBGbiB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKCFmbkRlZikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGZ1bmN0aW9uIGlzIGNvbnN0cnVjdCA9PiByZXR1cm4gZnVuY3Rpb24gZGlyZWN0bHlcbiAgICBpZiAoZm5EZWYgaW5zdGFuY2VvZiBGbikge1xuICAgICAgLy8gdmFsaWRhdGUgbGl2ZSBkZXYgaXMgbm90IGVuYWJsZWRcbiAgICAgIGlmIChmbkRlZi5faXNMaXZlRGV2RW5hYmxlZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYExpdmUgTGFtYmRhIERldiBjYW5ub3QgYmUgZW5hYmxlZCBmb3IgZnVuY3Rpb25zIGluIHRoZSBTY3JpcHQgY29uc3RydWN0LiBTZXQgdGhlIFwiZW5hYmxlTGl2ZURldlwiIHByb3AgZm9yIHRoZSBmdW5jdGlvbiB0byBcImZhbHNlXCIuYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3R5cGV9RnVuY3Rpb25gLFxuICAgICAgICBmbkRlZixcbiAgICAgICAgdGhpcy5wcm9wcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgICAgYFRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgY2Fubm90IGJlIGFwcGxpZWQgaWYgYW4gaW5zdGFuY2Ugb2YgYSBGdW5jdGlvbiBjb25zdHJ1Y3QgaXMgcGFzc2VkIGluLiBNYWtlIHN1cmUgdG8gZGVmaW5lIHRoZSBcIiR7dHlwZX1cIiBmdW5jdGlvbiB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgU2NyaXB0IGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiB0byB0aGVtLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gZnVuY3Rpb24gaXMgc3RyaW5nID0+IGNyZWF0ZSBmdW5jdGlvblxuICAgIGVsc2UgaWYgKHR5cGVvZiBmbkRlZiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0eXBlfUZ1bmN0aW9uYCxcbiAgICAgICAge1xuICAgICAgICAgIGhhbmRsZXI6IGZuRGVmLFxuICAgICAgICAgIGVuYWJsZUxpdmVEZXY6IGZhbHNlLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgdGltZW91dDogOTAwLFxuICAgICAgICAgIC4uLnRoaXMucHJvcHMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gZnVuY3Rpb24gaXMgcHJvcHMgPT4gY3JlYXRlIGZ1bmN0aW9uXG4gICAgcmV0dXJuIEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIGAke3R5cGV9RnVuY3Rpb25gLFxuICAgICAge1xuICAgICAgICAuLi5mbkRlZixcbiAgICAgICAgZW5hYmxlTGl2ZURldjogZmFsc2UsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICB0aW1lb3V0OiA5MDAsXG4gICAgICAgIC4uLnRoaXMucHJvcHMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMsXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ3VzdG9tUmVzb3VyY2VGdW5jdGlvbigpOiBsYW1iZGEuRnVuY3Rpb24ge1xuICAgIGNvbnN0IGhhbmRsZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiU2NyaXB0SGFuZGxlclwiLCB7XG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgXCJTY3JpcHRcIikpLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgICBoYW5kbGVyOiBcImluZGV4LmhhbmRsZXJcIixcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgfSk7XG4gICAgdGhpcy5jcmVhdGVGdW5jdGlvbj8uZ3JhbnRJbnZva2UoaGFuZGxlcik7XG4gICAgdGhpcy51cGRhdGVGdW5jdGlvbj8uZ3JhbnRJbnZva2UoaGFuZGxlcik7XG4gICAgdGhpcy5kZWxldGVGdW5jdGlvbj8uZ3JhbnRJbnZva2UoaGFuZGxlcik7XG5cbiAgICByZXR1cm4gaGFuZGxlcjtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ3VzdG9tUmVzb3VyY2UoYXBwOiBBcHAsIGNyRnVuY3Rpb246IGxhbWJkYS5GdW5jdGlvbik6IHZvaWQge1xuICAgIC8vIE5vdGU6IFwiQnVpbHRBdFwiIGlzIHNldCB0byBjdXJyZW50IHRpbWVzdGFtcCB0byBlbnN1cmUgdGhlIEN1c3RvbVxuICAgIC8vICAgICAgIFJlc291cmNlIGZ1bmN0aW9uIGlzIHJ1biBvbiBldmVyeSB1cGRhdGUuXG4gICAgLy9cbiAgICAvLyAgICAgICBEbyBub3QgdXNlIHRoZSBjdXJyZW50IHRpbWVzdGFtcCBpbiBMaXZlIG1vZGUsIGIvYyB3ZSB3YW50IHRoZVxuICAgIC8vICAgICAgIHRoaXMgY3VzdG9tIHJlc291cmNlIHRvIHJlbWFpbiB0aGUgc2FtZSBpbiBDbG91ZEZvcm1hdGlvbiB0ZW1wbGF0ZVxuICAgIC8vICAgICAgIHdoZW4gcmVidWlsZGluZyBpbmZyYXN0cnVjdHVyZS4gT3RoZXJ3aXNlLCB0aGVyZSB3aWxsIGFsd2F5cyBiZVxuICAgIC8vICAgICAgIGEgY2hhbmdlIHdoZW4gcmVidWlsZGluZyBpbmZyYXN0cnVjdHVyZSBiL2MgdGhlIFwiQnVpbGRBdFwiIHByb3BlcnR5XG4gICAgLy8gICAgICAgY2hhbmdlcyBvbiBlYWNoIGJ1aWxkLlxuICAgIGNvbnN0IGJ1aWx0QXQgPSBhcHAubG9jYWwgPyBhcHAuZGVidWdTdGFydGVkQXQgOiBEYXRlLm5vdygpO1xuICAgIG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2UodGhpcywgXCJTY3JpcHRSZXNvdXJjZVwiLCB7XG4gICAgICBzZXJ2aWNlVG9rZW46IGNyRnVuY3Rpb24uZnVuY3Rpb25Bcm4sXG4gICAgICByZXNvdXJjZVR5cGU6IFwiQ3VzdG9tOjpTU1RTY3JpcHRcIixcbiAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgVXNlckNyZWF0ZUZ1bmN0aW9uOiB0aGlzLmNyZWF0ZUZ1bmN0aW9uPy5mdW5jdGlvbk5hbWUsXG4gICAgICAgIFVzZXJVcGRhdGVGdW5jdGlvbjogdGhpcy51cGRhdGVGdW5jdGlvbj8uZnVuY3Rpb25OYW1lLFxuICAgICAgICBVc2VyRGVsZXRlRnVuY3Rpb246IHRoaXMuZGVsZXRlRnVuY3Rpb24/LmZ1bmN0aW9uTmFtZSxcbiAgICAgICAgVXNlclBhcmFtczogSlNPTi5zdHJpbmdpZnkodGhpcy5wcm9wcy5wYXJhbXMgfHwge30pLFxuICAgICAgICBCdWlsdEF0OiBidWlsdEF0LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tEZXByZWNhdGVkRnVuY3Rpb24oKTogdm9pZCB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYFRoZSBcImZ1bmN0aW9uXCIgcHJvcGVydHkgaGFzIGJlZW4gcmVwbGFjZWQgYnkgXCJvbkNyZWF0ZVwiIGFuZCBcIm9uVXBkYXRlXCIuIE1vcmUgZGV0YWlscyBvbiB1cGdyYWRpbmcgLSBodHRwczovL2RvY3Muc2VydmVybGVzcy1zdGFjay5jb20vY29uc3RydWN0cy9TY3JpcHQjdXBncmFkaW5nLXRvLXYwNDYwYFxuICAgICk7XG4gIH1cbn1cbiJdfQ==