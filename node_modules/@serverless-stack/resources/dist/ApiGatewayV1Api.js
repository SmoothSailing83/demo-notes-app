"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApiGatewayV1Api = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const route53 = __importStar(require("@aws-cdk/aws-route53"));
const route53Targets = __importStar(require("@aws-cdk/aws-route53-targets"));
const acm = __importStar(require("@aws-cdk/aws-certificatemanager"));
const apig = __importStar(require("@aws-cdk/aws-apigateway"));
const apigV1AccessLog = __importStar(require("./util/apiGatewayV1AccessLog"));
const Stack_1 = require("./Stack");
const Function_1 = require("./Function");
const allowedMethods = [
    "ANY",
    "GET",
    "PUT",
    "POST",
    "HEAD",
    "PATCH",
    "DELETE",
    "OPTIONS",
];
/////////////////////
// Construct
/////////////////////
class ApiGatewayV1Api extends cdk.Construct {
    constructor(scope, id, props) {
        var _a, _b, _c, _d, _e, _f, _g;
        super(scope, id);
        const root = scope.node.root;
        const { restApi, routes, cors, accessLog, customDomain, importedPaths, defaultFunctionProps, defaultAuthorizer, defaultAuthorizationType, defaultAuthorizationScopes, } = props || {};
        this.functions = {};
        this.routesInfo = {};
        this.importedResources = {};
        this.permissionsAttachedForAllRoutes = [];
        this.defaultFunctionProps = defaultFunctionProps;
        this.defaultAuthorizer = defaultAuthorizer;
        this.defaultAuthorizationType = defaultAuthorizationType;
        this.defaultAuthorizationScopes = defaultAuthorizationScopes;
        ////////////////////
        // Create Api
        ////////////////////
        if (cdk.Construct.isConstruct(restApi)) {
            if (cors !== undefined) {
                throw new Error(`Cannot configure the "cors" when the "restApi" is imported`);
            }
            if (accessLog !== undefined) {
                throw new Error(`Cannot configure the "accessLog" when the "restApi" is imported`);
            }
            if (customDomain !== undefined) {
                throw new Error(`Cannot configure the "customDomain" when the "restApi" is imported`);
            }
            this.restApi = restApi;
            // Create an API Gateway deployment resource to trigger a deployment
            this._deployment = new apig.Deployment(this, "Deployment", {
                api: this.restApi,
            });
            const cfnDeployment = this._deployment.node
                .defaultChild;
            cfnDeployment.stageName = root.stage;
            if (importedPaths) {
                this.importResources(importedPaths);
            }
        }
        else {
            const restApiProps = (restApi || {});
            // Validate input
            if (importedPaths !== undefined) {
                throw new Error(`Cannot import route paths when creating a new API.`);
            }
            if (customDomain !== undefined && restApiProps.domainName !== undefined) {
                throw new Error(`Use either the "customDomain" or the "restApi.domainName" to configure the Api domain. Do not use both.`);
            }
            if (cors !== undefined &&
                restApiProps.defaultCorsPreflightOptions !== undefined) {
                throw new Error(`Use either the "cors" or the "restApi.defaultCorsPreflightOptions" to configure the Api's CORS config. Do not use both.`);
            }
            if (accessLog !== undefined &&
                ((_a = restApiProps.deployOptions) === null || _a === void 0 ? void 0 : _a.accessLogDestination) !== undefined) {
                throw new Error(`Use either the "accessLog" or the "restApi.deployOptions.accessLogDestination" to configure the Api's access log. Do not use both.`);
            }
            if (accessLog !== undefined &&
                ((_b = restApiProps.deployOptions) === null || _b === void 0 ? void 0 : _b.accessLogFormat) !== undefined) {
                throw new Error(`Use either the "accessLog" or the "restApi.deployOptions.accessLogFormat" to configure the Api's access log. Do not use both.`);
            }
            const stageName = ((_c = restApiProps.deployOptions) === null || _c === void 0 ? void 0 : _c.stageName) || this.node.root.stage;
            const accessLogData = apigV1AccessLog.buildAccessLogData(this, accessLog);
            this.accessLogGroup = accessLogData === null || accessLogData === void 0 ? void 0 : accessLogData.logGroup;
            this.restApi = new apig.RestApi(this, "Api", Object.assign(Object.assign({}, restApiProps), { restApiName: root.logicalPrefixedName(id), domainName: restApiProps.domainName, defaultCorsPreflightOptions: restApiProps.defaultCorsPreflightOptions ||
                    this.buildCorsConfig(cors), deployOptions: Object.assign(Object.assign({}, (restApiProps.deployOptions || {})), { accessLogDestination: ((_d = restApiProps.deployOptions) === null || _d === void 0 ? void 0 : _d.accessLogDestination) ||
                        (accessLogData === null || accessLogData === void 0 ? void 0 : accessLogData.destination), accessLogFormat: ((_e = restApiProps.deployOptions) === null || _e === void 0 ? void 0 : _e.accessLogFormat) ||
                        (accessLogData === null || accessLogData === void 0 ? void 0 : accessLogData.format), 
                    // default to the name of the sage
                    stageName: stageName, 
                    // default to true
                    tracingEnabled: ((_f = restApiProps.deployOptions) === null || _f === void 0 ? void 0 : _f.tracingEnabled) === undefined
                        ? true
                        : (_g = restApiProps.deployOptions) === null || _g === void 0 ? void 0 : _g.tracingEnabled }) }));
            this.createCustomDomain(customDomain);
            this.createGatewayResponseForCors(cors);
        }
        ///////////////////////////
        // Configure routes
        ///////////////////////////
        if (routes) {
            Object.keys(routes).forEach((routeKey) => this.addRoute(this, routeKey, routes[routeKey]));
        }
        ///////////////////
        // Register Construct
        ///////////////////
        root.registerConstruct(this);
    }
    get url() {
        return this.restApi.url;
    }
    get customDomainUrl() {
        return this._customDomainUrl;
    }
    get routes() {
        return Object.keys(this.functions);
    }
    addRoutes(scope, routes) {
        Object.keys(routes).forEach((routeKey) => {
            // add route
            const fn = this.addRoute(scope, routeKey, routes[routeKey]);
            // attached existing permissions
            this.permissionsAttachedForAllRoutes.forEach((permissions) => fn.attachPermissions(permissions));
        });
    }
    getFunction(routeKey) {
        return this.functions[this.normalizeRouteKey(routeKey)];
    }
    attachPermissions(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllRoutes.push(permissions);
    }
    getConstructInfo() {
        // imported
        if (!cdk.Token.isUnresolved(this.restApi.restApiId)) {
            return {
                restApiId: this.restApi.restApiId,
                routes: this.routesInfo,
            };
        }
        // created
        const cfn = this.restApi.node.defaultChild;
        return {
            restApiLogicalId: Stack_1.Stack.of(this).getLogicalId(cfn),
            customDomainUrl: this._customDomainUrl,
            routes: this.routesInfo,
        };
    }
    attachPermissionsToRoute(routeKey, permissions) {
        const fn = this.getFunction(routeKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Route "${routeKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
    buildCorsConfig(cors) {
        // Case: cors is false
        if (cors === false) {
            return undefined;
        }
        // Case: cors is true or undefined
        return {
            allowOrigins: apig.Cors.ALL_ORIGINS,
        };
    }
    createGatewayResponseForCors(cors) {
        if (!cors) {
            return;
        }
        this.restApi.addGatewayResponse("GatewayResponseDefault4XX", {
            type: apig.ResponseType.DEFAULT_4XX,
            responseHeaders: {
                "Access-Control-Allow-Origin": "'*'",
                "Access-Control-Allow-Headers": "'*'",
            },
        });
        this.restApi.addGatewayResponse("GatewayResponseDefault5XX", {
            type: apig.ResponseType.DEFAULT_5XX,
            responseHeaders: {
                "Access-Control-Allow-Origin": "'*'",
                "Access-Control-Allow-Headers": "'*'",
            },
        });
    }
    createCustomDomain(customDomain) {
        // Case: customDomain is not set
        if (customDomain === undefined) {
            return;
        }
        // To be implemented: to allow more flexible use cases, SST should support 3 more use cases:
        //  1. Allow user passing in `hostedZone` object. The use case is when there are multiple
        //     HostedZones with the same domain, but one is public, and one is private.
        //  2. Allow user passing in `certificate` object. The use case is for user to create wildcard
        //     certificate or using an imported certificate.
        //  3. Allow user passing in `apigDomainName` object. The use case is a user creates multiple API
        //     endpoints, and is mapping them under the same custom domain. `sst.Api` needs to expose the
        //     `apigDomainName` construct created in the first Api, and lets user pass it in when creating
        //     the second Api.
        let domainName, hostedZone, hostedZoneDomain, certificate, apigDomainName, basePath, endpointType, mtls, securityPolicy;
        /////////////////////
        // Parse input
        /////////////////////
        // Case: customDomain is a string
        if (typeof customDomain === "string") {
            // validate: customDomain is a TOKEN string
            // ie. imported SSM value: ssm.StringParameter.valueForStringParameter()
            if (cdk.Token.isUnresolved(customDomain)) {
                throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
            }
            domainName = customDomain;
            this.assertDomainNameIsLowerCase(domainName);
            hostedZoneDomain = customDomain.split(".").slice(1).join(".");
        }
        // Case: customDomain.domainName not exists
        else if (!customDomain.domainName) {
            throw new Error(`Missing "domainName" in Api's customDomain setting`);
        }
        // Case: customDomain.domainName is a string
        else if (typeof customDomain.domainName === "string") {
            domainName = customDomain.domainName;
            // parse customDomain.domainName
            if (cdk.Token.isUnresolved(customDomain.domainName)) {
                // If customDomain is a TOKEN string, "hostedZone" has to be passed in. This
                // is because "hostedZone" cannot be parsed from a TOKEN value.
                if (!customDomain.hostedZone) {
                    throw new Error(`You also need to specify the "hostedZone" if the "domainName" is passed in as a reference.`);
                }
                domainName = customDomain.domainName;
            }
            else {
                domainName = customDomain.domainName;
                this.assertDomainNameIsLowerCase(domainName);
            }
            // parse customDomain.hostedZone
            if (!customDomain.hostedZone) {
                hostedZoneDomain = domainName.split(".").slice(1).join(".");
            }
            else if (typeof customDomain.hostedZone === "string") {
                hostedZoneDomain = customDomain.hostedZone;
            }
            else {
                hostedZone = customDomain.hostedZone;
            }
            certificate = customDomain.certificate;
            basePath = customDomain.path;
            endpointType = customDomain.endpointType;
            mtls = customDomain.mtls;
            securityPolicy = customDomain.securityPolicy;
        }
        // Case: customDomain.domainName is a construct
        else {
            apigDomainName = customDomain.domainName;
            // customDomain.domainName is imported
            if (apigDomainName && customDomain.hostedZone) {
                throw new Error(`Cannot configure the "hostedZone" when the "domainName" is a construct`);
            }
            if (apigDomainName && customDomain.certificate) {
                throw new Error(`Cannot configure the "certificate" when the "domainName" is a construct`);
            }
            if (apigDomainName && customDomain.endpointType) {
                throw new Error(`Cannot configure the "endpointType" when the "domainName" is a construct`);
            }
            if (apigDomainName && customDomain.mtls) {
                throw new Error(`Cannot configure the "mtls" when the "domainName" is a construct`);
            }
            if (apigDomainName && customDomain.securityPolicy) {
                throw new Error(`Cannot configure the "securityPolicy" when the "domainName" is a construct`);
            }
            basePath = customDomain.path;
        }
        /////////////////////
        // Find hosted zone
        /////////////////////
        if (!apigDomainName && !hostedZone) {
            // Look up hosted zone
            if (!hostedZone && hostedZoneDomain) {
                hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                    domainName: hostedZoneDomain,
                });
            }
        }
        /////////////////////
        // Create certificate
        /////////////////////
        if (!apigDomainName && !certificate) {
            if (endpointType === apig.EndpointType.EDGE) {
                certificate = new acm.DnsValidatedCertificate(this, "CrossRegionCertificate", {
                    domainName: domainName,
                    hostedZone: hostedZone,
                    region: "us-east-1",
                });
            }
            else {
                certificate = new acm.Certificate(this, "Certificate", {
                    domainName: domainName,
                    validation: acm.CertificateValidation.fromDns(hostedZone),
                });
            }
            this.acmCertificate = certificate;
        }
        /////////////////////
        // Create API Gateway domain name
        /////////////////////
        if (!apigDomainName && domainName) {
            // Create custom domain in API Gateway
            apigDomainName = new apig.DomainName(this, "DomainName", {
                domainName,
                certificate: certificate,
                endpointType,
                mtls,
                securityPolicy,
            });
            this.apiGatewayDomain = apigDomainName;
            // Create DNS record
            const record = new route53.ARecord(this, "AliasRecord", {
                recordName: domainName,
                zone: hostedZone,
                target: route53.RecordTarget.fromAlias(new route53Targets.ApiGatewayDomain(apigDomainName)),
            });
            // note: If domainName is a TOKEN string ie. ${TOKEN..}, the route53.ARecord
            //       construct will append ".${hostedZoneName}" to the end of the domain.
            //       This is because the construct tries to check if the record name
            //       ends with the domain name. If not, it will append the domain name.
            //       So, we need remove this behavior.
            if (cdk.Token.isUnresolved(domainName)) {
                const cfnRecord = record.node.defaultChild;
                cfnRecord.name = domainName;
            }
        }
        /////////////////////
        // Create base mapping
        /////////////////////
        if (apigDomainName) {
            new apig.BasePathMapping(this, "BasePath", {
                domainName: apigDomainName,
                restApi: this.restApi,
                basePath,
            });
        }
        // Note: We only know the full custom domain if domainName is a string.
        //       _customDomainUrl will be undefined if apigDomainName is imported.
        if (domainName && !cdk.Token.isUnresolved(domainName)) {
            this._customDomainUrl = basePath
                ? `https://${domainName}/${basePath}/`
                : `https://${domainName}`;
        }
    }
    importResources(resources) {
        Object.keys(resources).forEach((path) => {
            const resource = apig.Resource.fromResourceAttributes(this, `Resource_${path}`, {
                path,
                resourceId: resources[path],
                restApi: this.restApi,
            });
            this.importedResources[path] = resource;
        });
    }
    getResourceForPath(path) {
        // Lookup exact match imported resource
        if (this.importedResources[path]) {
            return this.importedResources[path];
        }
        // Lookup parents matching imported resource first
        const parts = path.split("/");
        for (let i = parts.length; i >= 1; i--) {
            const partialPath = parts.slice(0, i).join("/");
            if (this.importedResources[partialPath]) {
                return this.importedResources[partialPath].resourceForPath(parts.slice(i).join("/"));
            }
        }
        // Not child of imported resources, create off the root
        return this.restApi.root.resourceForPath(path);
    }
    addRoute(scope, routeKey, routeValue) {
        // Normalize routeProps
        const routeProps = (this.isInstanceOfApiRouteProps(routeValue)
            ? routeValue
            : {
                function: routeValue,
            });
        // Normalize routeKey
        routeKey = this.normalizeRouteKey(routeKey);
        if (this.functions[routeKey]) {
            throw new Error(`A route already exists for "${routeKey}"`);
        }
        ///////////////////
        // Get path and method
        ///////////////////
        const routeKeyParts = routeKey.split(" ");
        if (routeKeyParts.length !== 2) {
            throw new Error(`Invalid route ${routeKey}`);
        }
        const methodStr = routeKeyParts[0].toUpperCase();
        const path = routeKeyParts[1];
        const method = allowedMethods.find((per) => per === methodStr);
        if (!method) {
            throw new Error(`Invalid method defined for "${routeKey}"`);
        }
        if (path.length === 0) {
            throw new Error(`Invalid path defined for "${routeKey}"`);
        }
        ///////////////////
        // Create Resources
        ///////////////////
        let resource;
        if (path.endsWith("/{proxy+}")) {
            const parentResource = this.getResourceForPath(path.split("/").slice(0, -1).join("/"));
            resource = parentResource.addProxy({ anyMethod: false });
        }
        else {
            resource = this.getResourceForPath(path);
        }
        ///////////////////
        // Create Method
        ///////////////////
        const lambda = Function_1.Function.fromDefinition(scope, `Lambda_${methodStr}_${path}`, routeProps.function, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the routes using FunctionProps, so the Api construct can apply the "defaultFunctionProps" to them.`);
        const integration = new apig.LambdaIntegration(lambda, routeProps.integrationOptions);
        const methodOptions = this.buildRouteMethodOptions(routeProps.methodOptions);
        const apigMethod = resource.addMethod(method, integration, methodOptions);
        // Add an environment variable to determine if the function is an Api route.
        // If it is, when "sst start" is not connected, we want to return an 500
        // status code and a descriptive error message.
        const root = scope.node.root;
        if (root.local) {
            lambda.addEnvironment("SST_DEBUG_IS_API_ROUTE", "1", {
                removeInEdge: true,
            });
        }
        ///////////////////
        // Handle manually created Deployment resource (ie. imported REST API)
        ///////////////////
        if (this._deployment) {
            this._deployment.addToLogicalId({ route: { routeKey, routeValue } });
            this._deployment.node.addDependency(apigMethod);
        }
        ///////////////////
        // Store function
        ///////////////////
        this.functions[routeKey] = lambda;
        this.routesInfo[routeKey] = {
            method: methodStr,
            path,
        };
        return lambda;
    }
    buildRouteMethodOptions(options) {
        // Merge method options
        const methodOptions = Object.assign({ authorizationType: this.defaultAuthorizationType }, (options || {}));
        // Set authorization info
        if (methodOptions.authorizationType !== apig.AuthorizationType.NONE &&
            methodOptions.authorizationType !== apig.AuthorizationType.IAM) {
            methodOptions.authorizer =
                methodOptions.authorizer || this.defaultAuthorizer;
            methodOptions.authorizationScopes =
                methodOptions.authorizationScopes || this.defaultAuthorizationScopes;
        }
        return methodOptions;
    }
    isInstanceOfApiRouteProps(object) {
        return object.function !== undefined;
    }
    normalizeRouteKey(routeKey) {
        return routeKey.split(/\s+/).join(" ");
    }
    assertDomainNameIsLowerCase(domainName) {
        if (domainName !== domainName.toLowerCase()) {
            throw new Error(`The domain name needs to be in lowercase`);
        }
    }
}
exports.ApiGatewayV1Api = ApiGatewayV1Api;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBpR2F0ZXdheVYxQXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0FwaUdhdGV3YXlWMUFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbURBQXFDO0FBRXJDLDhEQUFnRDtBQUNoRCw2RUFBK0Q7QUFDL0QscUVBQXVEO0FBQ3ZELDhEQUFnRDtBQUNoRCw4RUFBZ0U7QUFHaEUsbUNBQWdDO0FBRWhDLHlDQUErRTtBQUcvRSxNQUFNLGNBQWMsR0FBRztJQUNyQixLQUFLO0lBQ0wsS0FBSztJQUNMLEtBQUs7SUFDTCxNQUFNO0lBQ04sTUFBTTtJQUNOLE9BQU87SUFDUCxRQUFRO0lBQ1IsU0FBUztDQUNWLENBQUM7QUE2Q0YscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckIsTUFBYSxlQUFnQixTQUFRLEdBQUcsQ0FBQyxTQUFTO0lBa0JoRCxZQUFZLEtBQW9CLEVBQUUsRUFBVSxFQUFFLEtBQTRCOztRQUN4RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLE1BQU0sRUFDSixPQUFPLEVBQ1AsTUFBTSxFQUNOLElBQUksRUFDSixTQUFTLEVBQ1QsWUFBWSxFQUNaLGFBQWEsRUFDYixvQkFBb0IsRUFDcEIsaUJBQWlCLEVBQ2pCLHdCQUF3QixFQUN4QiwwQkFBMEIsR0FDM0IsR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLCtCQUErQixHQUFHLEVBQUUsQ0FBQztRQUMxQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsb0JBQW9CLENB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QUNFLGFBQWEsQ0FBQyxpQkFBaUIsS0FBSyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSTtZQUMvRCxhQUFhLENBQUMsaUJBQWlCLEtBQUssSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsRUFDOUQ7WUFDQSxhQUFhLENBQUMsVUFBVTtnQkFDdEIsYUFBYSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsaUJBQWlCLENBQUM7WUFDckQsYUFBYSxDQUFDLG1CQUFtQjtnQkFDL0IsYUFBYSxDQUFDLG1CQUFtQixJQUFJLElBQUksQ0FBQywwQkFBMEIsQ0FBQztTQUN4RTtRQUVELE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7SUFFTyx5QkFBeUIsQ0FDL0IsTUFBaUM7UUFFakMsT0FBTyxNQUFNLENBQUMsUUFBUSxLQUFLLFNBQVMsQ0FBQztJQUN2QyxDQUFDO0lBRU8saUJBQWlCLENBQUMsUUFBZ0I7UUFDeEMsT0FBTyxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRU8sMkJBQTJCLENBQUMsVUFBa0I7UUFDcEQsSUFBSSxVQUFVLEtBQUssVUFBVSxDQUFDLFdBQVcsRUFBRSxFQUFFO1lBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQztTQUM3RDtJQUNILENBQUM7Q0FDRjtBQTlvQkQsMENBOG9CQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0ICogYXMgbG9ncyBmcm9tIFwiQGF3cy1jZGsvYXdzLWxvZ3NcIjtcbmltcG9ydCAqIGFzIHJvdXRlNTMgZnJvbSBcIkBhd3MtY2RrL2F3cy1yb3V0ZTUzXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzVGFyZ2V0cyBmcm9tIFwiQGF3cy1jZGsvYXdzLXJvdXRlNTMtdGFyZ2V0c1wiO1xuaW1wb3J0ICogYXMgYWNtIGZyb20gXCJAYXdzLWNkay9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyXCI7XG5pbXBvcnQgKiBhcyBhcGlnIGZyb20gXCJAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheVwiO1xuaW1wb3J0ICogYXMgYXBpZ1YxQWNjZXNzTG9nIGZyb20gXCIuL3V0aWwvYXBpR2F0ZXdheVYxQWNjZXNzTG9nXCI7XG5cbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgU3RhY2sgfSBmcm9tIFwiLi9TdGFja1wiO1xuaW1wb3J0IHsgSVNzdENvbnN0cnVjdCwgSVNzdENvbnN0cnVjdEluZm8gfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuY29uc3QgYWxsb3dlZE1ldGhvZHMgPSBbXG4gIFwiQU5ZXCIsXG4gIFwiR0VUXCIsXG4gIFwiUFVUXCIsXG4gIFwiUE9TVFwiLFxuICBcIkhFQURcIixcbiAgXCJQQVRDSFwiLFxuICBcIkRFTEVURVwiLFxuICBcIk9QVElPTlNcIixcbl07XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gSW50ZXJmYWNlc1xuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBpR2F0ZXdheVYxQXBpUHJvcHMge1xuICByZWFkb25seSByZXN0QXBpPzogYXBpZy5JUmVzdEFwaSB8IGFwaWcuUmVzdEFwaVByb3BzO1xuICByZWFkb25seSByb3V0ZXM/OiB7XG4gICAgW2tleTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uIHwgQXBpR2F0ZXdheVYxQXBpUm91dGVQcm9wcztcbiAgfTtcbiAgcmVhZG9ubHkgY29ycz86IGJvb2xlYW47XG4gIHJlYWRvbmx5IGFjY2Vzc0xvZz86IGJvb2xlYW4gfCBzdHJpbmcgfCBBcGlHYXRld2F5VjFBcGlBY2NjZXNzTG9nUHJvcHM7XG4gIHJlYWRvbmx5IGN1c3RvbURvbWFpbj86IHN0cmluZyB8IEFwaUdhdGV3YXlWMUFwaUN1c3RvbURvbWFpblByb3BzO1xuICByZWFkb25seSBpbXBvcnRlZFBhdGhzPzogeyBbcGF0aDogc3RyaW5nXTogc3RyaW5nIH07XG5cbiAgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuICByZWFkb25seSBkZWZhdWx0QXV0aG9yaXplcj86IGFwaWcuSUF1dGhvcml6ZXI7XG4gIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uVHlwZT86IGFwaWcuQXV0aG9yaXphdGlvblR5cGU7XG4gIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzPzogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBpR2F0ZXdheVYxQXBpUm91dGVQcm9wcyB7XG4gIHJlYWRvbmx5IGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IG1ldGhvZE9wdGlvbnM/OiBhcGlnLk1ldGhvZE9wdGlvbnM7XG4gIHJlYWRvbmx5IGludGVncmF0aW9uT3B0aW9ucz86IGFwaWcuTGFtYmRhSW50ZWdyYXRpb25PcHRpb25zO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwaUdhdGV3YXlWMUFwaUN1c3RvbURvbWFpblByb3BzIHtcbiAgcmVhZG9ubHkgZG9tYWluTmFtZTogc3RyaW5nIHwgYXBpZy5JRG9tYWluTmFtZTtcbiAgcmVhZG9ubHkgaG9zdGVkWm9uZT86IHN0cmluZyB8IHJvdXRlNTMuSUhvc3RlZFpvbmU7XG4gIHJlYWRvbmx5IGNlcnRpZmljYXRlPzogYWNtLklDZXJ0aWZpY2F0ZTtcbiAgcmVhZG9ubHkgcGF0aD86IHN0cmluZztcbiAgcmVhZG9ubHkgZW5kcG9pbnRUeXBlPzogYXBpZy5FbmRwb2ludFR5cGU7XG4gIHJlYWRvbmx5IG10bHM/OiBhcGlnLk1UTFNDb25maWc7XG4gIHJlYWRvbmx5IHNlY3VyaXR5UG9saWN5PzogYXBpZy5TZWN1cml0eVBvbGljeTtcbn1cblxuaW50ZXJmYWNlIEFwaUdhdGV3YXlWMUFwaUNvbnN0cnVjdFJvdXRlSW5mbyB7XG4gIHJlYWRvbmx5IG1ldGhvZDogc3RyaW5nO1xuICByZWFkb25seSBwYXRoOiBzdHJpbmc7XG59XG5cbmV4cG9ydCB0eXBlIEFwaUdhdGV3YXlWMUFwaUFjY2Nlc3NMb2dQcm9wcyA9IGFwaWdWMUFjY2Vzc0xvZy5BY2Nlc3NMb2dQcm9wcztcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb25zdHJ1Y3Rcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgY2xhc3MgQXBpR2F0ZXdheVYxQXBpIGV4dGVuZHMgY2RrLkNvbnN0cnVjdCBpbXBsZW1lbnRzIElTc3RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgcmVzdEFwaTogYXBpZy5SZXN0QXBpO1xuICBwdWJsaWMgYWNjZXNzTG9nR3JvdXA/OiBsb2dzLkxvZ0dyb3VwO1xuICBwdWJsaWMgYXBpR2F0ZXdheURvbWFpbj86IGFwaWcuRG9tYWluTmFtZTtcbiAgcHVibGljIGFjbUNlcnRpZmljYXRlPzogYWNtLkNlcnRpZmljYXRlIHwgYWNtLkRuc1ZhbGlkYXRlZENlcnRpZmljYXRlO1xuICBwcml2YXRlIF9kZXBsb3ltZW50PzogYXBpZy5EZXBsb3ltZW50O1xuICBwcml2YXRlIF9jdXN0b21Eb21haW5Vcmw/OiBzdHJpbmc7XG4gIHByaXZhdGUgaW1wb3J0ZWRSZXNvdXJjZXM6IHsgW3BhdGg6IHN0cmluZ106IGFwaWcuSVJlc291cmNlIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25zOiB7IFtrZXk6IHN0cmluZ106IEZuIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgcm91dGVzSW5mbzoge1xuICAgIFtrZXk6IHN0cmluZ106IEFwaUdhdGV3YXlWMUFwaUNvbnN0cnVjdFJvdXRlSW5mbztcbiAgfTtcbiAgcHJpdmF0ZSByZWFkb25seSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzOiBQZXJtaXNzaW9uc1tdO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRGdW5jdGlvblByb3BzPzogRnVuY3Rpb25Qcm9wcztcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0QXV0aG9yaXplcj86IGFwaWcuSUF1dGhvcml6ZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlPzogYXBpZy5BdXRob3JpemF0aW9uVHlwZTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0QXV0aG9yaXphdGlvblNjb3Blcz86IHN0cmluZ1tdO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IEFwaUdhdGV3YXlWMUFwaVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGNvbnN0IHtcbiAgICAgIHJlc3RBcGksXG4gICAgICByb3V0ZXMsXG4gICAgICBjb3JzLFxuICAgICAgYWNjZXNzTG9nLFxuICAgICAgY3VzdG9tRG9tYWluLFxuICAgICAgaW1wb3J0ZWRQYXRocyxcbiAgICAgIGRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgZGVmYXVsdEF1dGhvcml6ZXIsXG4gICAgICBkZWZhdWx0QXV0aG9yaXphdGlvblR5cGUsXG4gICAgICBkZWZhdWx0QXV0aG9yaXphdGlvblNjb3BlcyxcbiAgICB9ID0gcHJvcHMgfHwge307XG4gICAgdGhpcy5mdW5jdGlvbnMgPSB7fTtcbiAgICB0aGlzLnJvdXRlc0luZm8gPSB7fTtcbiAgICB0aGlzLmltcG9ydGVkUmVzb3VyY2VzID0ge307XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzID0gW107XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyA9IGRlZmF1bHRGdW5jdGlvblByb3BzO1xuICAgIHRoaXMuZGVmYXVsdEF1dGhvcml6ZXIgPSBkZWZhdWx0QXV0aG9yaXplcjtcbiAgICB0aGlzLmRlZmF1bHRBdXRob3JpemF0aW9uVHlwZSA9IGRlZmF1bHRBdXRob3JpemF0aW9uVHlwZTtcbiAgICB0aGlzLmRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzID0gZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXM7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBBcGlcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKGNkay5Db25zdHJ1Y3QuaXNDb25zdHJ1Y3QocmVzdEFwaSkpIHtcbiAgICAgIGlmIChjb3JzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImNvcnNcIiB3aGVuIHRoZSBcInJlc3RBcGlcIiBpcyBpbXBvcnRlZGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChhY2Nlc3NMb2cgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiYWNjZXNzTG9nXCIgd2hlbiB0aGUgXCJyZXN0QXBpXCIgaXMgaW1wb3J0ZWRgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoY3VzdG9tRG9tYWluICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImN1c3RvbURvbWFpblwiIHdoZW4gdGhlIFwicmVzdEFwaVwiIGlzIGltcG9ydGVkYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhpcy5yZXN0QXBpID0gcmVzdEFwaSBhcyBhcGlnLlJlc3RBcGk7XG5cbiAgICAgIC8vIENyZWF0ZSBhbiBBUEkgR2F0ZXdheSBkZXBsb3ltZW50IHJlc291cmNlIHRvIHRyaWdnZXIgYSBkZXBsb3ltZW50XG4gICAgICB0aGlzLl9kZXBsb3ltZW50ID0gbmV3IGFwaWcuRGVwbG95bWVudCh0aGlzLCBcIkRlcGxveW1lbnRcIiwge1xuICAgICAgICBhcGk6IHRoaXMucmVzdEFwaSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgY2ZuRGVwbG95bWVudCA9IHRoaXMuX2RlcGxveW1lbnQubm9kZVxuICAgICAgICAuZGVmYXVsdENoaWxkIGFzIGFwaWcuQ2ZuRGVwbG95bWVudDtcbiAgICAgIGNmbkRlcGxveW1lbnQuc3RhZ2VOYW1lID0gcm9vdC5zdGFnZTtcblxuICAgICAgaWYgKGltcG9ydGVkUGF0aHMpIHtcbiAgICAgICAgdGhpcy5pbXBvcnRSZXNvdXJjZXMoaW1wb3J0ZWRQYXRocyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJlc3RBcGlQcm9wcyA9IChyZXN0QXBpIHx8IHt9KSBhcyBhcGlnLlJlc3RBcGlQcm9wcztcblxuICAgICAgLy8gVmFsaWRhdGUgaW5wdXRcbiAgICAgIGlmIChpbXBvcnRlZFBhdGhzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgaW1wb3J0IHJvdXRlIHBhdGhzIHdoZW4gY3JlYXRpbmcgYSBuZXcgQVBJLmApO1xuICAgICAgfVxuICAgICAgaWYgKGN1c3RvbURvbWFpbiAhPT0gdW5kZWZpbmVkICYmIHJlc3RBcGlQcm9wcy5kb21haW5OYW1lICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBVc2UgZWl0aGVyIHRoZSBcImN1c3RvbURvbWFpblwiIG9yIHRoZSBcInJlc3RBcGkuZG9tYWluTmFtZVwiIHRvIGNvbmZpZ3VyZSB0aGUgQXBpIGRvbWFpbi4gRG8gbm90IHVzZSBib3RoLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgY29ycyAhPT0gdW5kZWZpbmVkICYmXG4gICAgICAgIHJlc3RBcGlQcm9wcy5kZWZhdWx0Q29yc1ByZWZsaWdodE9wdGlvbnMgIT09IHVuZGVmaW5lZFxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVXNlIGVpdGhlciB0aGUgXCJjb3JzXCIgb3IgdGhlIFwicmVzdEFwaS5kZWZhdWx0Q29yc1ByZWZsaWdodE9wdGlvbnNcIiB0byBjb25maWd1cmUgdGhlIEFwaSdzIENPUlMgY29uZmlnLiBEbyBub3QgdXNlIGJvdGguYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICBhY2Nlc3NMb2cgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgICByZXN0QXBpUHJvcHMuZGVwbG95T3B0aW9ucz8uYWNjZXNzTG9nRGVzdGluYXRpb24gIT09IHVuZGVmaW5lZFxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVXNlIGVpdGhlciB0aGUgXCJhY2Nlc3NMb2dcIiBvciB0aGUgXCJyZXN0QXBpLmRlcGxveU9wdGlvbnMuYWNjZXNzTG9nRGVzdGluYXRpb25cIiB0byBjb25maWd1cmUgdGhlIEFwaSdzIGFjY2VzcyBsb2cuIERvIG5vdCB1c2UgYm90aC5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIGFjY2Vzc0xvZyAhPT0gdW5kZWZpbmVkICYmXG4gICAgICAgIHJlc3RBcGlQcm9wcy5kZXBsb3lPcHRpb25zPy5hY2Nlc3NMb2dGb3JtYXQgIT09IHVuZGVmaW5lZFxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVXNlIGVpdGhlciB0aGUgXCJhY2Nlc3NMb2dcIiBvciB0aGUgXCJyZXN0QXBpLmRlcGxveU9wdGlvbnMuYWNjZXNzTG9nRm9ybWF0XCIgdG8gY29uZmlndXJlIHRoZSBBcGkncyBhY2Nlc3MgbG9nLiBEbyBub3QgdXNlIGJvdGguYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzdGFnZU5hbWUgPVxuICAgICAgICByZXN0QXBpUHJvcHMuZGVwbG95T3B0aW9ucz8uc3RhZ2VOYW1lIHx8ICh0aGlzLm5vZGUucm9vdCBhcyBBcHApLnN0YWdlO1xuXG4gICAgICBjb25zdCBhY2Nlc3NMb2dEYXRhID0gYXBpZ1YxQWNjZXNzTG9nLmJ1aWxkQWNjZXNzTG9nRGF0YSh0aGlzLCBhY2Nlc3NMb2cpO1xuXG4gICAgICB0aGlzLmFjY2Vzc0xvZ0dyb3VwID0gYWNjZXNzTG9nRGF0YT8ubG9nR3JvdXA7XG5cbiAgICAgIHRoaXMucmVzdEFwaSA9IG5ldyBhcGlnLlJlc3RBcGkodGhpcywgXCJBcGlcIiwge1xuICAgICAgICAuLi5yZXN0QXBpUHJvcHMsXG4gICAgICAgIHJlc3RBcGlOYW1lOiByb290LmxvZ2ljYWxQcmVmaXhlZE5hbWUoaWQpLFxuICAgICAgICBkb21haW5OYW1lOiByZXN0QXBpUHJvcHMuZG9tYWluTmFtZSxcbiAgICAgICAgZGVmYXVsdENvcnNQcmVmbGlnaHRPcHRpb25zOlxuICAgICAgICAgIHJlc3RBcGlQcm9wcy5kZWZhdWx0Q29yc1ByZWZsaWdodE9wdGlvbnMgfHxcbiAgICAgICAgICB0aGlzLmJ1aWxkQ29yc0NvbmZpZyhjb3JzKSxcbiAgICAgICAgZGVwbG95T3B0aW9uczoge1xuICAgICAgICAgIC4uLihyZXN0QXBpUHJvcHMuZGVwbG95T3B0aW9ucyB8fCB7fSksXG4gICAgICAgICAgYWNjZXNzTG9nRGVzdGluYXRpb246XG4gICAgICAgICAgICByZXN0QXBpUHJvcHMuZGVwbG95T3B0aW9ucz8uYWNjZXNzTG9nRGVzdGluYXRpb24gfHxcbiAgICAgICAgICAgIGFjY2Vzc0xvZ0RhdGE/LmRlc3RpbmF0aW9uLFxuICAgICAgICAgIGFjY2Vzc0xvZ0Zvcm1hdDpcbiAgICAgICAgICAgIHJlc3RBcGlQcm9wcy5kZXBsb3lPcHRpb25zPy5hY2Nlc3NMb2dGb3JtYXQgfHxcbiAgICAgICAgICAgIGFjY2Vzc0xvZ0RhdGE/LmZvcm1hdCxcblxuICAgICAgICAgIC8vIGRlZmF1bHQgdG8gdGhlIG5hbWUgb2YgdGhlIHNhZ2VcbiAgICAgICAgICBzdGFnZU5hbWU6IHN0YWdlTmFtZSxcblxuICAgICAgICAgIC8vIGRlZmF1bHQgdG8gdHJ1ZVxuICAgICAgICAgIHRyYWNpbmdFbmFibGVkOlxuICAgICAgICAgICAgcmVzdEFwaVByb3BzLmRlcGxveU9wdGlvbnM/LnRyYWNpbmdFbmFibGVkID09PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgPyB0cnVlXG4gICAgICAgICAgICAgIDogcmVzdEFwaVByb3BzLmRlcGxveU9wdGlvbnM/LnRyYWNpbmdFbmFibGVkLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuY3JlYXRlQ3VzdG9tRG9tYWluKGN1c3RvbURvbWFpbik7XG4gICAgICB0aGlzLmNyZWF0ZUdhdGV3YXlSZXNwb25zZUZvckNvcnMoY29ycyk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ29uZmlndXJlIHJvdXRlc1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKHJvdXRlcykge1xuICAgICAgT2JqZWN0LmtleXMocm91dGVzKS5mb3JFYWNoKChyb3V0ZUtleTogc3RyaW5nKSA9PlxuICAgICAgICB0aGlzLmFkZFJvdXRlKHRoaXMsIHJvdXRlS2V5LCByb3V0ZXNbcm91dGVLZXldKVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gUmVnaXN0ZXIgQ29uc3RydWN0XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIHJvb3QucmVnaXN0ZXJDb25zdHJ1Y3QodGhpcyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHVybCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnJlc3RBcGkudXJsO1xuICB9XG5cbiAgcHVibGljIGdldCBjdXN0b21Eb21haW5VcmwoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5fY3VzdG9tRG9tYWluVXJsO1xuICB9XG5cbiAgcHVibGljIGdldCByb3V0ZXMoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLmZ1bmN0aW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYWRkUm91dGVzKFxuICAgIHNjb3BlOiBjZGsuQ29uc3RydWN0LFxuICAgIHJvdXRlczoge1xuICAgICAgW2tleTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uIHwgQXBpR2F0ZXdheVYxQXBpUm91dGVQcm9wcztcbiAgICB9XG4gICk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKHJvdXRlcykuZm9yRWFjaCgocm91dGVLZXk6IHN0cmluZykgPT4ge1xuICAgICAgLy8gYWRkIHJvdXRlXG4gICAgICBjb25zdCBmbiA9IHRoaXMuYWRkUm91dGUoc2NvcGUsIHJvdXRlS2V5LCByb3V0ZXNbcm91dGVLZXldKTtcblxuICAgICAgLy8gYXR0YWNoZWQgZXhpc3RpbmcgcGVybWlzc2lvbnNcbiAgICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFJvdXRlcy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT5cbiAgICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldEZ1bmN0aW9uKHJvdXRlS2V5OiBzdHJpbmcpOiBGbiB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuZnVuY3Rpb25zW3RoaXMubm9ybWFsaXplUm91dGVLZXkocm91dGVLZXkpXTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBPYmplY3QudmFsdWVzKHRoaXMuZnVuY3Rpb25zKS5mb3JFYWNoKChmbikgPT5cbiAgICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICk7XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzLnB1c2gocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdEluZm8oKTogSVNzdENvbnN0cnVjdEluZm8ge1xuICAgIC8vIGltcG9ydGVkXG4gICAgaWYgKCFjZGsuVG9rZW4uaXNVbnJlc29sdmVkKHRoaXMucmVzdEFwaS5yZXN0QXBpSWQpKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICByZXN0QXBpSWQ6IHRoaXMucmVzdEFwaS5yZXN0QXBpSWQsXG4gICAgICAgIHJvdXRlczogdGhpcy5yb3V0ZXNJbmZvLFxuICAgICAgfTtcbiAgICB9XG4gICAgLy8gY3JlYXRlZFxuICAgIGNvbnN0IGNmbiA9IHRoaXMucmVzdEFwaS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBhcGlnLkNmblJlc3RBcGk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHJlc3RBcGlMb2dpY2FsSWQ6IFN0YWNrLm9mKHRoaXMpLmdldExvZ2ljYWxJZChjZm4pLFxuICAgICAgY3VzdG9tRG9tYWluVXJsOiB0aGlzLl9jdXN0b21Eb21haW5VcmwsXG4gICAgICByb3V0ZXM6IHRoaXMucm91dGVzSW5mbyxcbiAgICB9O1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zVG9Sb3V0ZShcbiAgICByb3V0ZUtleTogc3RyaW5nLFxuICAgIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uc1xuICApOiB2b2lkIHtcbiAgICBjb25zdCBmbiA9IHRoaXMuZ2V0RnVuY3Rpb24ocm91dGVLZXkpO1xuICAgIGlmICghZm4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBhdHRhY2ggcGVybWlzc2lvbnMuIFJvdXRlIFwiJHtyb3V0ZUtleX1cIiBkb2VzIG5vdCBleGlzdC5gXG4gICAgICApO1xuICAgIH1cblxuICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRDb3JzQ29uZmlnKGNvcnM/OiBib29sZWFuKTogYXBpZy5Db3JzT3B0aW9ucyB8IHVuZGVmaW5lZCB7XG4gICAgLy8gQ2FzZTogY29ycyBpcyBmYWxzZVxuICAgIGlmIChjb3JzID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICAvLyBDYXNlOiBjb3JzIGlzIHRydWUgb3IgdW5kZWZpbmVkXG4gICAgcmV0dXJuIHtcbiAgICAgIGFsbG93T3JpZ2luczogYXBpZy5Db3JzLkFMTF9PUklHSU5TLFxuICAgIH0gYXMgYXBpZy5Db3JzT3B0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlR2F0ZXdheVJlc3BvbnNlRm9yQ29ycyhjb3JzPzogYm9vbGVhbik6IHZvaWQge1xuICAgIGlmICghY29ycykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMucmVzdEFwaS5hZGRHYXRld2F5UmVzcG9uc2UoXCJHYXRld2F5UmVzcG9uc2VEZWZhdWx0NFhYXCIsIHtcbiAgICAgIHR5cGU6IGFwaWcuUmVzcG9uc2VUeXBlLkRFRkFVTFRfNFhYLFxuICAgICAgcmVzcG9uc2VIZWFkZXJzOiB7XG4gICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luXCI6IFwiJyonXCIsXG4gICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVyc1wiOiBcIicqJ1wiLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMucmVzdEFwaS5hZGRHYXRld2F5UmVzcG9uc2UoXCJHYXRld2F5UmVzcG9uc2VEZWZhdWx0NVhYXCIsIHtcbiAgICAgIHR5cGU6IGFwaWcuUmVzcG9uc2VUeXBlLkRFRkFVTFRfNVhYLFxuICAgICAgcmVzcG9uc2VIZWFkZXJzOiB7XG4gICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luXCI6IFwiJyonXCIsXG4gICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVyc1wiOiBcIicqJ1wiLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ3VzdG9tRG9tYWluKFxuICAgIGN1c3RvbURvbWFpbj86IHN0cmluZyB8IEFwaUdhdGV3YXlWMUFwaUN1c3RvbURvbWFpblByb3BzXG4gICk6IHZvaWQge1xuICAgIC8vIENhc2U6IGN1c3RvbURvbWFpbiBpcyBub3Qgc2V0XG4gICAgaWYgKGN1c3RvbURvbWFpbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gVG8gYmUgaW1wbGVtZW50ZWQ6IHRvIGFsbG93IG1vcmUgZmxleGlibGUgdXNlIGNhc2VzLCBTU1Qgc2hvdWxkIHN1cHBvcnQgMyBtb3JlIHVzZSBjYXNlczpcbiAgICAvLyAgMS4gQWxsb3cgdXNlciBwYXNzaW5nIGluIGBob3N0ZWRab25lYCBvYmplY3QuIFRoZSB1c2UgY2FzZSBpcyB3aGVuIHRoZXJlIGFyZSBtdWx0aXBsZVxuICAgIC8vICAgICBIb3N0ZWRab25lcyB3aXRoIHRoZSBzYW1lIGRvbWFpbiwgYnV0IG9uZSBpcyBwdWJsaWMsIGFuZCBvbmUgaXMgcHJpdmF0ZS5cbiAgICAvLyAgMi4gQWxsb3cgdXNlciBwYXNzaW5nIGluIGBjZXJ0aWZpY2F0ZWAgb2JqZWN0LiBUaGUgdXNlIGNhc2UgaXMgZm9yIHVzZXIgdG8gY3JlYXRlIHdpbGRjYXJkXG4gICAgLy8gICAgIGNlcnRpZmljYXRlIG9yIHVzaW5nIGFuIGltcG9ydGVkIGNlcnRpZmljYXRlLlxuICAgIC8vICAzLiBBbGxvdyB1c2VyIHBhc3NpbmcgaW4gYGFwaWdEb21haW5OYW1lYCBvYmplY3QuIFRoZSB1c2UgY2FzZSBpcyBhIHVzZXIgY3JlYXRlcyBtdWx0aXBsZSBBUElcbiAgICAvLyAgICAgZW5kcG9pbnRzLCBhbmQgaXMgbWFwcGluZyB0aGVtIHVuZGVyIHRoZSBzYW1lIGN1c3RvbSBkb21haW4uIGBzc3QuQXBpYCBuZWVkcyB0byBleHBvc2UgdGhlXG4gICAgLy8gICAgIGBhcGlnRG9tYWluTmFtZWAgY29uc3RydWN0IGNyZWF0ZWQgaW4gdGhlIGZpcnN0IEFwaSwgYW5kIGxldHMgdXNlciBwYXNzIGl0IGluIHdoZW4gY3JlYXRpbmdcbiAgICAvLyAgICAgdGhlIHNlY29uZCBBcGkuXG5cbiAgICBsZXQgZG9tYWluTmFtZSxcbiAgICAgIGhvc3RlZFpvbmUsXG4gICAgICBob3N0ZWRab25lRG9tYWluLFxuICAgICAgY2VydGlmaWNhdGUsXG4gICAgICBhcGlnRG9tYWluTmFtZSxcbiAgICAgIGJhc2VQYXRoLFxuICAgICAgZW5kcG9pbnRUeXBlLFxuICAgICAgbXRscyxcbiAgICAgIHNlY3VyaXR5UG9saWN5O1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gUGFyc2UgaW5wdXRcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIC8vIENhc2U6IGN1c3RvbURvbWFpbiBpcyBhIHN0cmluZ1xuICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAvLyB2YWxpZGF0ZTogY3VzdG9tRG9tYWluIGlzIGEgVE9LRU4gc3RyaW5nXG4gICAgICAvLyBpZS4gaW1wb3J0ZWQgU1NNIHZhbHVlOiBzc20uU3RyaW5nUGFyYW1ldGVyLnZhbHVlRm9yU3RyaW5nUGFyYW1ldGVyKClcbiAgICAgIGlmIChjZGsuVG9rZW4uaXNVbnJlc29sdmVkKGN1c3RvbURvbWFpbikpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBZb3UgYWxzbyBuZWVkIHRvIHNwZWNpZnkgdGhlIFwiaG9zdGVkWm9uZVwiIGlmIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBwYXNzZWQgaW4gYXMgYSByZWZlcmVuY2UuYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBkb21haW5OYW1lID0gY3VzdG9tRG9tYWluO1xuICAgICAgdGhpcy5hc3NlcnREb21haW5OYW1lSXNMb3dlckNhc2UoZG9tYWluTmFtZSk7XG4gICAgICBob3N0ZWRab25lRG9tYWluID0gY3VzdG9tRG9tYWluLnNwbGl0KFwiLlwiKS5zbGljZSgxKS5qb2luKFwiLlwiKTtcbiAgICB9XG5cbiAgICAvLyBDYXNlOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBub3QgZXhpc3RzXG4gICAgZWxzZSBpZiAoIWN1c3RvbURvbWFpbi5kb21haW5OYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgXCJkb21haW5OYW1lXCIgaW4gQXBpJ3MgY3VzdG9tRG9tYWluIHNldHRpbmdgKTtcbiAgICB9XG5cbiAgICAvLyBDYXNlOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBpcyBhIHN0cmluZ1xuICAgIGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgZG9tYWluTmFtZSA9IGN1c3RvbURvbWFpbi5kb21haW5OYW1lO1xuXG4gICAgICAvLyBwYXJzZSBjdXN0b21Eb21haW4uZG9tYWluTmFtZVxuICAgICAgaWYgKGNkay5Ub2tlbi5pc1VucmVzb2x2ZWQoY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUpKSB7XG4gICAgICAgIC8vIElmIGN1c3RvbURvbWFpbiBpcyBhIFRPS0VOIHN0cmluZywgXCJob3N0ZWRab25lXCIgaGFzIHRvIGJlIHBhc3NlZCBpbi4gVGhpc1xuICAgICAgICAvLyBpcyBiZWNhdXNlIFwiaG9zdGVkWm9uZVwiIGNhbm5vdCBiZSBwYXJzZWQgZnJvbSBhIFRPS0VOIHZhbHVlLlxuICAgICAgICBpZiAoIWN1c3RvbURvbWFpbi5ob3N0ZWRab25lKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYFlvdSBhbHNvIG5lZWQgdG8gc3BlY2lmeSB0aGUgXCJob3N0ZWRab25lXCIgaWYgdGhlIFwiZG9tYWluTmFtZVwiIGlzIHBhc3NlZCBpbiBhcyBhIHJlZmVyZW5jZS5gXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBkb21haW5OYW1lID0gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb21haW5OYW1lID0gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWU7XG4gICAgICAgIHRoaXMuYXNzZXJ0RG9tYWluTmFtZUlzTG93ZXJDYXNlKGRvbWFpbk5hbWUpO1xuICAgICAgfVxuXG4gICAgICAvLyBwYXJzZSBjdXN0b21Eb21haW4uaG9zdGVkWm9uZVxuICAgICAgaWYgKCFjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkge1xuICAgICAgICBob3N0ZWRab25lRG9tYWluID0gZG9tYWluTmFtZS5zcGxpdChcIi5cIikuc2xpY2UoMSkuam9pbihcIi5cIik7XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4uaG9zdGVkWm9uZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICBob3N0ZWRab25lRG9tYWluID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBob3N0ZWRab25lID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmU7XG4gICAgICB9XG5cbiAgICAgIGNlcnRpZmljYXRlID0gY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlO1xuICAgICAgYmFzZVBhdGggPSBjdXN0b21Eb21haW4ucGF0aDtcbiAgICAgIGVuZHBvaW50VHlwZSA9IGN1c3RvbURvbWFpbi5lbmRwb2ludFR5cGU7XG4gICAgICBtdGxzID0gY3VzdG9tRG9tYWluLm10bHM7XG4gICAgICBzZWN1cml0eVBvbGljeSA9IGN1c3RvbURvbWFpbi5zZWN1cml0eVBvbGljeTtcbiAgICB9XG5cbiAgICAvLyBDYXNlOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSBpcyBhIGNvbnN0cnVjdFxuICAgIGVsc2Uge1xuICAgICAgYXBpZ0RvbWFpbk5hbWUgPSBjdXN0b21Eb21haW4uZG9tYWluTmFtZTtcblxuICAgICAgLy8gY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgaXMgaW1wb3J0ZWRcbiAgICAgIGlmIChhcGlnRG9tYWluTmFtZSAmJiBjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiaG9zdGVkWm9uZVwiIHdoZW4gdGhlIFwiZG9tYWluTmFtZVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGFwaWdEb21haW5OYW1lICYmIGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiY2VydGlmaWNhdGVcIiB3aGVuIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChhcGlnRG9tYWluTmFtZSAmJiBjdXN0b21Eb21haW4uZW5kcG9pbnRUeXBlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJlbmRwb2ludFR5cGVcIiB3aGVuIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChhcGlnRG9tYWluTmFtZSAmJiBjdXN0b21Eb21haW4ubXRscykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwibXRsc1wiIHdoZW4gdGhlIFwiZG9tYWluTmFtZVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGFwaWdEb21haW5OYW1lICYmIGN1c3RvbURvbWFpbi5zZWN1cml0eVBvbGljeSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwic2VjdXJpdHlQb2xpY3lcIiB3aGVuIHRoZSBcImRvbWFpbk5hbWVcIiBpcyBhIGNvbnN0cnVjdGBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgYmFzZVBhdGggPSBjdXN0b21Eb21haW4ucGF0aDtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBGaW5kIGhvc3RlZCB6b25lXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgaWYgKCFhcGlnRG9tYWluTmFtZSAmJiAhaG9zdGVkWm9uZSkge1xuICAgICAgLy8gTG9vayB1cCBob3N0ZWQgem9uZVxuICAgICAgaWYgKCFob3N0ZWRab25lICYmIGhvc3RlZFpvbmVEb21haW4pIHtcbiAgICAgICAgaG9zdGVkWm9uZSA9IHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHRoaXMsIFwiSG9zdGVkWm9uZVwiLCB7XG4gICAgICAgICAgZG9tYWluTmFtZTogaG9zdGVkWm9uZURvbWFpbixcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIGNlcnRpZmljYXRlXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgaWYgKCFhcGlnRG9tYWluTmFtZSAmJiAhY2VydGlmaWNhdGUpIHtcbiAgICAgIGlmIChlbmRwb2ludFR5cGUgPT09IGFwaWcuRW5kcG9pbnRUeXBlLkVER0UpIHtcbiAgICAgICAgY2VydGlmaWNhdGUgPSBuZXcgYWNtLkRuc1ZhbGlkYXRlZENlcnRpZmljYXRlKFxuICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgXCJDcm9zc1JlZ2lvbkNlcnRpZmljYXRlXCIsXG4gICAgICAgICAge1xuICAgICAgICAgICAgZG9tYWluTmFtZTogZG9tYWluTmFtZSBhcyBzdHJpbmcsXG4gICAgICAgICAgICBob3N0ZWRab25lOiBob3N0ZWRab25lIGFzIHJvdXRlNTMuSUhvc3RlZFpvbmUsXG4gICAgICAgICAgICByZWdpb246IFwidXMtZWFzdC0xXCIsXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2VydGlmaWNhdGUgPSBuZXcgYWNtLkNlcnRpZmljYXRlKHRoaXMsIFwiQ2VydGlmaWNhdGVcIiwge1xuICAgICAgICAgIGRvbWFpbk5hbWU6IGRvbWFpbk5hbWUgYXMgc3RyaW5nLFxuICAgICAgICAgIHZhbGlkYXRpb246IGFjbS5DZXJ0aWZpY2F0ZVZhbGlkYXRpb24uZnJvbURucyhob3N0ZWRab25lKSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICB0aGlzLmFjbUNlcnRpZmljYXRlID0gY2VydGlmaWNhdGU7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIEFQSSBHYXRld2F5IGRvbWFpbiBuYW1lXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgaWYgKCFhcGlnRG9tYWluTmFtZSAmJiBkb21haW5OYW1lKSB7XG4gICAgICAvLyBDcmVhdGUgY3VzdG9tIGRvbWFpbiBpbiBBUEkgR2F0ZXdheVxuICAgICAgYXBpZ0RvbWFpbk5hbWUgPSBuZXcgYXBpZy5Eb21haW5OYW1lKHRoaXMsIFwiRG9tYWluTmFtZVwiLCB7XG4gICAgICAgIGRvbWFpbk5hbWUsXG4gICAgICAgIGNlcnRpZmljYXRlOiBjZXJ0aWZpY2F0ZSBhcyBhY20uSUNlcnRpZmljYXRlLFxuICAgICAgICBlbmRwb2ludFR5cGUsXG4gICAgICAgIG10bHMsXG4gICAgICAgIHNlY3VyaXR5UG9saWN5LFxuICAgICAgfSk7XG4gICAgICB0aGlzLmFwaUdhdGV3YXlEb21haW4gPSBhcGlnRG9tYWluTmFtZTtcblxuICAgICAgLy8gQ3JlYXRlIEROUyByZWNvcmRcbiAgICAgIGNvbnN0IHJlY29yZCA9IG5ldyByb3V0ZTUzLkFSZWNvcmQodGhpcywgXCJBbGlhc1JlY29yZFwiLCB7XG4gICAgICAgIHJlY29yZE5hbWU6IGRvbWFpbk5hbWUsXG4gICAgICAgIHpvbmU6IGhvc3RlZFpvbmUgYXMgcm91dGU1My5JSG9zdGVkWm9uZSxcbiAgICAgICAgdGFyZ2V0OiByb3V0ZTUzLlJlY29yZFRhcmdldC5mcm9tQWxpYXMoXG4gICAgICAgICAgbmV3IHJvdXRlNTNUYXJnZXRzLkFwaUdhdGV3YXlEb21haW4oYXBpZ0RvbWFpbk5hbWUpXG4gICAgICAgICksXG4gICAgICB9KTtcbiAgICAgIC8vIG5vdGU6IElmIGRvbWFpbk5hbWUgaXMgYSBUT0tFTiBzdHJpbmcgaWUuICR7VE9LRU4uLn0sIHRoZSByb3V0ZTUzLkFSZWNvcmRcbiAgICAgIC8vICAgICAgIGNvbnN0cnVjdCB3aWxsIGFwcGVuZCBcIi4ke2hvc3RlZFpvbmVOYW1lfVwiIHRvIHRoZSBlbmQgb2YgdGhlIGRvbWFpbi5cbiAgICAgIC8vICAgICAgIFRoaXMgaXMgYmVjYXVzZSB0aGUgY29uc3RydWN0IHRyaWVzIHRvIGNoZWNrIGlmIHRoZSByZWNvcmQgbmFtZVxuICAgICAgLy8gICAgICAgZW5kcyB3aXRoIHRoZSBkb21haW4gbmFtZS4gSWYgbm90LCBpdCB3aWxsIGFwcGVuZCB0aGUgZG9tYWluIG5hbWUuXG4gICAgICAvLyAgICAgICBTbywgd2UgbmVlZCByZW1vdmUgdGhpcyBiZWhhdmlvci5cbiAgICAgIGlmIChjZGsuVG9rZW4uaXNVbnJlc29sdmVkKGRvbWFpbk5hbWUpKSB7XG4gICAgICAgIGNvbnN0IGNmblJlY29yZCA9IHJlY29yZC5ub2RlLmRlZmF1bHRDaGlsZCBhcyByb3V0ZTUzLkNmblJlY29yZFNldDtcbiAgICAgICAgY2ZuUmVjb3JkLm5hbWUgPSBkb21haW5OYW1lO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBiYXNlIG1hcHBpbmdcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBpZiAoYXBpZ0RvbWFpbk5hbWUpIHtcbiAgICAgIG5ldyBhcGlnLkJhc2VQYXRoTWFwcGluZyh0aGlzLCBcIkJhc2VQYXRoXCIsIHtcbiAgICAgICAgZG9tYWluTmFtZTogYXBpZ0RvbWFpbk5hbWUsXG4gICAgICAgIHJlc3RBcGk6IHRoaXMucmVzdEFwaSxcbiAgICAgICAgYmFzZVBhdGgsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBOb3RlOiBXZSBvbmx5IGtub3cgdGhlIGZ1bGwgY3VzdG9tIGRvbWFpbiBpZiBkb21haW5OYW1lIGlzIGEgc3RyaW5nLlxuICAgIC8vICAgICAgIF9jdXN0b21Eb21haW5Vcmwgd2lsbCBiZSB1bmRlZmluZWQgaWYgYXBpZ0RvbWFpbk5hbWUgaXMgaW1wb3J0ZWQuXG4gICAgaWYgKGRvbWFpbk5hbWUgJiYgIWNkay5Ub2tlbi5pc1VucmVzb2x2ZWQoZG9tYWluTmFtZSkpIHtcbiAgICAgIHRoaXMuX2N1c3RvbURvbWFpblVybCA9IGJhc2VQYXRoXG4gICAgICAgID8gYGh0dHBzOi8vJHtkb21haW5OYW1lfS8ke2Jhc2VQYXRofS9gXG4gICAgICAgIDogYGh0dHBzOi8vJHtkb21haW5OYW1lfWA7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbXBvcnRSZXNvdXJjZXMocmVzb3VyY2VzOiB7IFtwYXRoOiBzdHJpbmddOiBzdHJpbmcgfSk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKHJlc291cmNlcykuZm9yRWFjaCgocGF0aCkgPT4ge1xuICAgICAgY29uc3QgcmVzb3VyY2UgPSBhcGlnLlJlc291cmNlLmZyb21SZXNvdXJjZUF0dHJpYnV0ZXMoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGBSZXNvdXJjZV8ke3BhdGh9YCxcbiAgICAgICAge1xuICAgICAgICAgIHBhdGgsXG4gICAgICAgICAgcmVzb3VyY2VJZDogcmVzb3VyY2VzW3BhdGhdLFxuICAgICAgICAgIHJlc3RBcGk6IHRoaXMucmVzdEFwaSxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHRoaXMuaW1wb3J0ZWRSZXNvdXJjZXNbcGF0aF0gPSByZXNvdXJjZTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UmVzb3VyY2VGb3JQYXRoKHBhdGg6IHN0cmluZyk6IGFwaWcuSVJlc291cmNlIHtcbiAgICAvLyBMb29rdXAgZXhhY3QgbWF0Y2ggaW1wb3J0ZWQgcmVzb3VyY2VcbiAgICBpZiAodGhpcy5pbXBvcnRlZFJlc291cmNlc1twYXRoXSkge1xuICAgICAgcmV0dXJuIHRoaXMuaW1wb3J0ZWRSZXNvdXJjZXNbcGF0aF07XG4gICAgfVxuXG4gICAgLy8gTG9va3VwIHBhcmVudHMgbWF0Y2hpbmcgaW1wb3J0ZWQgcmVzb3VyY2UgZmlyc3RcbiAgICBjb25zdCBwYXJ0cyA9IHBhdGguc3BsaXQoXCIvXCIpO1xuICAgIGZvciAobGV0IGkgPSBwYXJ0cy5sZW5ndGg7IGkgPj0gMTsgaS0tKSB7XG4gICAgICBjb25zdCBwYXJ0aWFsUGF0aCA9IHBhcnRzLnNsaWNlKDAsIGkpLmpvaW4oXCIvXCIpO1xuICAgICAgaWYgKHRoaXMuaW1wb3J0ZWRSZXNvdXJjZXNbcGFydGlhbFBhdGhdKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmltcG9ydGVkUmVzb3VyY2VzW3BhcnRpYWxQYXRoXS5yZXNvdXJjZUZvclBhdGgoXG4gICAgICAgICAgcGFydHMuc2xpY2UoaSkuam9pbihcIi9cIilcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBOb3QgY2hpbGQgb2YgaW1wb3J0ZWQgcmVzb3VyY2VzLCBjcmVhdGUgb2ZmIHRoZSByb290XG4gICAgcmV0dXJuIHRoaXMucmVzdEFwaS5yb290LnJlc291cmNlRm9yUGF0aChwYXRoKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkUm91dGUoXG4gICAgc2NvcGU6IGNkay5Db25zdHJ1Y3QsXG4gICAgcm91dGVLZXk6IHN0cmluZyxcbiAgICByb3V0ZVZhbHVlOiBGdW5jdGlvbkRlZmluaXRpb24gfCBBcGlHYXRld2F5VjFBcGlSb3V0ZVByb3BzXG4gICk6IEZuIHtcbiAgICAvLyBOb3JtYWxpemUgcm91dGVQcm9wc1xuICAgIGNvbnN0IHJvdXRlUHJvcHMgPSAoXG4gICAgICB0aGlzLmlzSW5zdGFuY2VPZkFwaVJvdXRlUHJvcHMocm91dGVWYWx1ZSBhcyBBcGlHYXRld2F5VjFBcGlSb3V0ZVByb3BzKVxuICAgICAgICA/IHJvdXRlVmFsdWVcbiAgICAgICAgOiB7XG4gICAgICAgICAgICBmdW5jdGlvbjogcm91dGVWYWx1ZSBhcyBGdW5jdGlvbkRlZmluaXRpb24sXG4gICAgICAgICAgfVxuICAgICkgYXMgQXBpR2F0ZXdheVYxQXBpUm91dGVQcm9wcztcblxuICAgIC8vIE5vcm1hbGl6ZSByb3V0ZUtleVxuICAgIHJvdXRlS2V5ID0gdGhpcy5ub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleSk7XG4gICAgaWYgKHRoaXMuZnVuY3Rpb25zW3JvdXRlS2V5XSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBBIHJvdXRlIGFscmVhZHkgZXhpc3RzIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gR2V0IHBhdGggYW5kIG1ldGhvZFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCByb3V0ZUtleVBhcnRzID0gcm91dGVLZXkuc3BsaXQoXCIgXCIpO1xuICAgIGlmIChyb3V0ZUtleVBhcnRzLmxlbmd0aCAhPT0gMikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHJvdXRlICR7cm91dGVLZXl9YCk7XG4gICAgfVxuICAgIGNvbnN0IG1ldGhvZFN0ciA9IHJvdXRlS2V5UGFydHNbMF0udG9VcHBlckNhc2UoKTtcbiAgICBjb25zdCBwYXRoID0gcm91dGVLZXlQYXJ0c1sxXTtcbiAgICBjb25zdCBtZXRob2QgPSBhbGxvd2VkTWV0aG9kcy5maW5kKChwZXIpID0+IHBlciA9PT0gbWV0aG9kU3RyKTtcbiAgICBpZiAoIW1ldGhvZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIG1ldGhvZCBkZWZpbmVkIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICB9XG4gICAgaWYgKHBhdGgubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcGF0aCBkZWZpbmVkIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIFJlc291cmNlc1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBsZXQgcmVzb3VyY2U7XG4gICAgaWYgKHBhdGguZW5kc1dpdGgoXCIve3Byb3h5K31cIikpIHtcbiAgICAgIGNvbnN0IHBhcmVudFJlc291cmNlID0gdGhpcy5nZXRSZXNvdXJjZUZvclBhdGgoXG4gICAgICAgIHBhdGguc3BsaXQoXCIvXCIpLnNsaWNlKDAsIC0xKS5qb2luKFwiL1wiKVxuICAgICAgKTtcbiAgICAgIHJlc291cmNlID0gcGFyZW50UmVzb3VyY2UuYWRkUHJveHkoeyBhbnlNZXRob2Q6IGZhbHNlIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXNvdXJjZSA9IHRoaXMuZ2V0UmVzb3VyY2VGb3JQYXRoKHBhdGgpO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgTWV0aG9kXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IGxhbWJkYSA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICBgTGFtYmRhXyR7bWV0aG9kU3RyfV8ke3BhdGh9YCxcbiAgICAgIHJvdXRlUHJvcHMuZnVuY3Rpb24sXG4gICAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgYFRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgY2Fubm90IGJlIGFwcGxpZWQgaWYgYW4gaW5zdGFuY2Ugb2YgYSBGdW5jdGlvbiBjb25zdHJ1Y3QgaXMgcGFzc2VkIGluLiBNYWtlIHN1cmUgdG8gZGVmaW5lIGFsbCB0aGUgcm91dGVzIHVzaW5nIEZ1bmN0aW9uUHJvcHMsIHNvIHRoZSBBcGkgY29uc3RydWN0IGNhbiBhcHBseSB0aGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIHRvIHRoZW0uYFxuICAgICk7XG4gICAgY29uc3QgaW50ZWdyYXRpb24gPSBuZXcgYXBpZy5MYW1iZGFJbnRlZ3JhdGlvbihcbiAgICAgIGxhbWJkYSxcbiAgICAgIHJvdXRlUHJvcHMuaW50ZWdyYXRpb25PcHRpb25zXG4gICAgKTtcbiAgICBjb25zdCBtZXRob2RPcHRpb25zID0gdGhpcy5idWlsZFJvdXRlTWV0aG9kT3B0aW9ucyhcbiAgICAgIHJvdXRlUHJvcHMubWV0aG9kT3B0aW9uc1xuICAgICk7XG4gICAgY29uc3QgYXBpZ01ldGhvZCA9IHJlc291cmNlLmFkZE1ldGhvZChtZXRob2QsIGludGVncmF0aW9uLCBtZXRob2RPcHRpb25zKTtcblxuICAgIC8vIEFkZCBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZSB0byBkZXRlcm1pbmUgaWYgdGhlIGZ1bmN0aW9uIGlzIGFuIEFwaSByb3V0ZS5cbiAgICAvLyBJZiBpdCBpcywgd2hlbiBcInNzdCBzdGFydFwiIGlzIG5vdCBjb25uZWN0ZWQsIHdlIHdhbnQgdG8gcmV0dXJuIGFuIDUwMFxuICAgIC8vIHN0YXR1cyBjb2RlIGFuZCBhIGRlc2NyaXB0aXZlIGVycm9yIG1lc3NhZ2UuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgaWYgKHJvb3QubG9jYWwpIHtcbiAgICAgIGxhbWJkYS5hZGRFbnZpcm9ubWVudChcIlNTVF9ERUJVR19JU19BUElfUk9VVEVcIiwgXCIxXCIsIHtcbiAgICAgICAgcmVtb3ZlSW5FZGdlOiB0cnVlLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEhhbmRsZSBtYW51YWxseSBjcmVhdGVkIERlcGxveW1lbnQgcmVzb3VyY2UgKGllLiBpbXBvcnRlZCBSRVNUIEFQSSlcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgaWYgKHRoaXMuX2RlcGxveW1lbnQpIHtcbiAgICAgIHRoaXMuX2RlcGxveW1lbnQuYWRkVG9Mb2dpY2FsSWQoeyByb3V0ZTogeyByb3V0ZUtleSwgcm91dGVWYWx1ZSB9IH0pO1xuICAgICAgdGhpcy5fZGVwbG95bWVudC5ub2RlLmFkZERlcGVuZGVuY3koYXBpZ01ldGhvZCk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIFN0b3JlIGZ1bmN0aW9uXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIHRoaXMuZnVuY3Rpb25zW3JvdXRlS2V5XSA9IGxhbWJkYTtcbiAgICB0aGlzLnJvdXRlc0luZm9bcm91dGVLZXldID0ge1xuICAgICAgbWV0aG9kOiBtZXRob2RTdHIsXG4gICAgICBwYXRoLFxuICAgIH07XG5cbiAgICByZXR1cm4gbGFtYmRhO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFJvdXRlTWV0aG9kT3B0aW9ucyhcbiAgICBvcHRpb25zPzogYXBpZy5NZXRob2RPcHRpb25zXG4gICk6IGFwaWcuTWV0aG9kT3B0aW9ucyB7XG4gICAgLy8gTWVyZ2UgbWV0aG9kIG9wdGlvbnNcbiAgICBjb25zdCBtZXRob2RPcHRpb25zID0ge1xuICAgICAgYXV0aG9yaXphdGlvblR5cGU6IHRoaXMuZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlLFxuICAgICAgLi4uKG9wdGlvbnMgfHwge30pLFxuICAgIH07XG5cbiAgICAvLyBTZXQgYXV0aG9yaXphdGlvbiBpbmZvXG4gICAgaWYgKFxuICAgICAgbWV0aG9kT3B0aW9ucy5hdXRob3JpemF0aW9uVHlwZSAhPT0gYXBpZy5BdXRob3JpemF0aW9uVHlwZS5OT05FICYmXG4gICAgICBtZXRob2RPcHRpb25zLmF1dGhvcml6YXRpb25UeXBlICE9PSBhcGlnLkF1dGhvcml6YXRpb25UeXBlLklBTVxuICAgICkge1xuICAgICAgbWV0aG9kT3B0aW9ucy5hdXRob3JpemVyID1cbiAgICAgICAgbWV0aG9kT3B0aW9ucy5hdXRob3JpemVyIHx8IHRoaXMuZGVmYXVsdEF1dGhvcml6ZXI7XG4gICAgICBtZXRob2RPcHRpb25zLmF1dGhvcml6YXRpb25TY29wZXMgPVxuICAgICAgICBtZXRob2RPcHRpb25zLmF1dGhvcml6YXRpb25TY29wZXMgfHwgdGhpcy5kZWZhdWx0QXV0aG9yaXphdGlvblNjb3BlcztcbiAgICB9XG5cbiAgICByZXR1cm4gbWV0aG9kT3B0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgaXNJbnN0YW5jZU9mQXBpUm91dGVQcm9wcyhcbiAgICBvYmplY3Q6IEFwaUdhdGV3YXlWMUFwaVJvdXRlUHJvcHNcbiAgKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG9iamVjdC5mdW5jdGlvbiAhPT0gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gcm91dGVLZXkuc3BsaXQoL1xccysvKS5qb2luKFwiIFwiKTtcbiAgfVxuXG4gIHByaXZhdGUgYXNzZXJ0RG9tYWluTmFtZUlzTG93ZXJDYXNlKGRvbWFpbk5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChkb21haW5OYW1lICE9PSBkb21haW5OYW1lLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGRvbWFpbiBuYW1lIG5lZWRzIHRvIGJlIGluIGxvd2VyY2FzZWApO1xuICAgIH1cbiAgfVxufVxuIl19