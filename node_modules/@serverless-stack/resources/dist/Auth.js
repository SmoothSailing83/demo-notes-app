"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Auth = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const iam = __importStar(require("@aws-cdk/aws-iam"));
const cognito = __importStar(require("@aws-cdk/aws-cognito"));
const Stack_1 = require("./Stack");
const Function_1 = require("./Function");
const permission_1 = require("./util/permission");
const AuthUserPoolTriggerOperationMapping = {
    createAuthChallenge: cognito.UserPoolOperation.CREATE_AUTH_CHALLENGE,
    customMessage: cognito.UserPoolOperation.CUSTOM_MESSAGE,
    defineAuthChallenge: cognito.UserPoolOperation.DEFINE_AUTH_CHALLENGE,
    postAuthentication: cognito.UserPoolOperation.POST_AUTHENTICATION,
    postConfirmation: cognito.UserPoolOperation.POST_CONFIRMATION,
    preAuthentication: cognito.UserPoolOperation.PRE_AUTHENTICATION,
    preSignUp: cognito.UserPoolOperation.PRE_SIGN_UP,
    preTokenGeneration: cognito.UserPoolOperation.PRE_TOKEN_GENERATION,
    userMigration: cognito.UserPoolOperation.USER_MIGRATION,
    verifyAuthChallengeResponse: cognito.UserPoolOperation.VERIFY_AUTH_CHALLENGE_RESPONSE,
};
class Auth extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // Handle deprecated props
        this.checkDeprecatedProps(props);
        const root = scope.node.root;
        const { cognito: cognitoProps, auth0, amazon, apple, facebook, google, twitter, identityPool, } = props;
        this.functions = {};
        this.permissionsAttachedForAllTriggers = [];
        ////////////////////
        // Handle Cognito Identity Providers (ie. User Pool)
        ////////////////////
        const cognitoIdentityProviders = [];
        if (cognitoProps) {
            let isUserPoolImported = false;
            // Create User Pool
            if (typeof cognitoProps === "boolean") {
                this.cognitoUserPool = new cognito.UserPool(this, "UserPool", {
                    userPoolName: root.logicalPrefixedName(id),
                    selfSignUpEnabled: true,
                    signInCaseSensitive: false,
                });
            }
            else if (cdk.Construct.isConstruct(cognitoProps.userPool)) {
                isUserPoolImported = true;
                this.cognitoUserPool = cognitoProps.userPool;
            }
            else {
                // validate `lambdaTriggers` is not specified
                if (cognitoProps.userPool && cognitoProps.userPool.lambdaTriggers) {
                    throw new Error(`Cannot configure the "cognito.userPool.lambdaTriggers" in the Auth construct. Use the "cognito.triggers" instead.`);
                }
                this.cognitoUserPool = new cognito.UserPool(this, "UserPool", Object.assign({ userPoolName: root.logicalPrefixedName(id), selfSignUpEnabled: true, signInCaseSensitive: false }, (cognitoProps.userPool || {})));
                // Create Trigger functions
                const { triggers, defaultFunctionProps } = cognitoProps;
                this.defaultFunctionProps = defaultFunctionProps;
                if (triggers) {
                    Object.entries(triggers).forEach(([triggerKey, triggerValue]) => this.addTrigger(this, triggerKey, triggerValue));
                }
            }
            // Create User Pool Client
            if (typeof cognitoProps === "boolean") {
                this.cognitoUserPoolClient = new cognito.UserPoolClient(this, "UserPoolClient", {
                    userPool: this.cognitoUserPool,
                });
            }
            else if (cdk.Construct.isConstruct(cognitoProps.userPoolClient)) {
                if (!isUserPoolImported) {
                    throw new Error(`Cannot import the "userPoolClient" when the "userPool" is not imported.`);
                }
                this.cognitoUserPoolClient = cognitoProps.userPoolClient;
            }
            else {
                this.cognitoUserPoolClient = new cognito.UserPoolClient(this, "UserPoolClient", Object.assign({ userPool: this.cognitoUserPool }, (cognitoProps.userPoolClient || {})));
            }
            // Set cognito providers
            cognitoIdentityProviders.push({
                providerName: this.cognitoUserPool.userPoolProviderName,
                clientId: this.cognitoUserPoolClient.userPoolClientId,
            });
        }
        ////////////////////
        // Handle OpenId Connect Providers (ie. Auth0)
        ////////////////////
        const openIdConnectProviderArns = [];
        if (auth0) {
            if (!auth0.domain) {
                throw new Error(`No Auth0 domain defined for the "${id}" Auth`);
            }
            if (!auth0.clientId) {
                throw new Error(`No Auth0 clientId defined for the "${id}" Auth`);
            }
            const provider = new iam.OpenIdConnectProvider(this, "Auth0Provider", {
                url: auth0.domain.startsWith("https://")
                    ? auth0.domain
                    : `https://${auth0.domain}`,
                clientIds: [auth0.clientId],
            });
            openIdConnectProviderArns.push(provider.openIdConnectProviderArn);
        }
        ////////////////////
        // Handle Social Identity Providers
        ////////////////////
        const supportedLoginProviders = {};
        if (amazon) {
            if (!amazon.appId) {
                throw new Error(`No Amazon appId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["www.amazon.com"] = amazon.appId;
        }
        if (facebook) {
            if (!facebook.appId) {
                throw new Error(`No Facebook appId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["graph.facebook.com"] = facebook.appId;
        }
        if (google) {
            if (!google.clientId) {
                throw new Error(`No Google appId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["accounts.google.com"] = google.clientId;
        }
        if (twitter) {
            if (!twitter.consumerKey) {
                throw new Error(`No Twitter consumer key defined for the "${id}" Auth`);
            }
            if (!twitter.consumerSecret) {
                throw new Error(`No Twitter consumer secret defined for the "${id}" Auth`);
            }
            supportedLoginProviders["api.twitter.com"] = `${twitter.consumerKey};${twitter.consumerSecret}`;
        }
        if (apple) {
            if (!apple.servicesId) {
                throw new Error(`No Apple servicesId defined for the "${id}" Auth`);
            }
            supportedLoginProviders["appleid.apple.com"] = apple.servicesId;
        }
        ////////////////////
        // Create Identity Pool
        ////////////////////
        // Create Cognito Identity Pool
        this.cognitoCfnIdentityPool = new cognito.CfnIdentityPool(this, "IdentityPool", Object.assign({ identityPoolName: root.logicalPrefixedName(id), allowUnauthenticatedIdentities: true, cognitoIdentityProviders,
            supportedLoginProviders,
            openIdConnectProviderArns }, (identityPool || {})));
        this.iamAuthRole = this.createAuthRole(this.cognitoCfnIdentityPool);
        this.iamUnauthRole = this.createUnauthRole(this.cognitoCfnIdentityPool);
        // Attach roles to Identity Pool
        new cognito.CfnIdentityPoolRoleAttachment(this, "IdentityPoolRoleAttachment", {
            identityPoolId: this.cognitoCfnIdentityPool.ref,
            roles: {
                authenticated: this.iamAuthRole.roleArn,
                unauthenticated: this.iamUnauthRole.roleArn,
            },
        });
        ///////////////////
        // Register Construct
        ///////////////////
        root.registerConstruct(this);
    }
    get cognitoIdentityPoolId() {
        return this.cognitoCfnIdentityPool.ref;
    }
    attachPermissionsForAuthUsers(permissions) {
        (0, permission_1.attachPermissionsToRole)(this.iamAuthRole, permissions);
    }
    attachPermissionsForUnauthUsers(permissions) {
        (0, permission_1.attachPermissionsToRole)(this.iamUnauthRole, permissions);
    }
    attachPermissionsForTriggers(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllTriggers.push(permissions);
    }
    attachPermissionsForTrigger(triggerKey, permissions) {
        const fn = this.getFunction(triggerKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Trigger "${triggerKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
    getFunction(triggerKey) {
        return this.functions[triggerKey];
    }
    getConstructInfo() {
        return {
            identityPoolLogicalId: Stack_1.Stack.of(this).getLogicalId(this.cognitoCfnIdentityPool),
        };
    }
    checkDeprecatedProps(props) {
        var _a;
        if (props.cognitoUserPool) {
            throw new Error(`The "cognitoUserPool" property is deprecated. Use the "cognito.userPool" instead. More details on upgrading - https://docs.serverless-stack.com/constructs/Auth#upgrading-to-v0120`);
        }
        if (props.cognitoUserPoolClient) {
            throw new Error(`The "cognitoUserPoolClient" property is deprecated. Use the "cognito.userPoolClient" instead. More details on upgrading - https://docs.serverless-stack.com/constructs/Auth#upgrading-to-v0120`);
        }
        if (props.cognito) {
            if (props.cognito !== true && ((_a = props.cognito) === null || _a === void 0 ? void 0 : _a.signInAliases)) {
                throw new Error(`The "cognito.signInAliases" property is deprecated. Use the "cognito.userPool.signInAliases" instead. More details on upgrading - https://docs.serverless-stack.com/constructs/Auth#upgrading-to-v0120`);
            }
        }
    }
    addTrigger(scope, triggerKey, triggerValue) {
        // Validate cognito user pool is defined
        if (!this.cognitoUserPool) {
            throw new Error(`Triggers cannot be added. No Cognito UserPool defined for the Auth construct.`);
        }
        // Create Function
        const lambda = Function_1.Function.fromDefinition(scope, triggerKey, triggerValue, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the triggers using FunctionProps, so the Auth construct can apply the "defaultFunctionProps" to them.`);
        // Create trigger
        const operation = AuthUserPoolTriggerOperationMapping[triggerKey];
        this.cognitoUserPool.addTrigger(operation, lambda);
        // Store function
        this.functions[triggerKey] = lambda;
        return lambda;
    }
    createAuthRole(identityPool) {
        const role = new iam.Role(this, "IdentityPoolAuthRole", {
            assumedBy: new iam.FederatedPrincipal("cognito-identity.amazonaws.com", {
                StringEquals: {
                    "cognito-identity.amazonaws.com:aud": identityPool.ref,
                },
                "ForAnyValue:StringLike": {
                    "cognito-identity.amazonaws.com:amr": "authenticated",
                },
            }, "sts:AssumeRoleWithWebIdentity"),
        });
        role.addToPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "mobileanalytics:PutEvents",
                "cognito-sync:*",
                "cognito-identity:*",
            ],
            resources: ["*"],
        }));
        return role;
    }
    createUnauthRole(identityPool) {
        const role = new iam.Role(this, "IdentityPoolUnauthRole", {
            assumedBy: new iam.FederatedPrincipal("cognito-identity.amazonaws.com", {
                StringEquals: {
                    "cognito-identity.amazonaws.com:aud": identityPool.ref,
                },
                "ForAnyValue:StringLike": {
                    "cognito-identity.amazonaws.com:amr": "unauthenticated",
                },
            }, "sts:AssumeRoleWithWebIdentity"),
        });
        role.addToPolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["mobileanalytics:PutEvents", "cognito-sync:*"],
            resources: ["*"],
        }));
        return role;
    }
}
exports.Auth = Auth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9BdXRoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxtREFBcUM7QUFDckMsc0RBQXdDO0FBQ3hDLDhEQUFnRDtBQUdoRCxtQ0FBZ0M7QUFFaEMseUNBQStFO0FBQy9FLGtEQUF5RTtBQUV6RSxNQUFNLG1DQUFtQyxHQUFHO0lBQzFDLG1CQUFtQixFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxxQkFBcUI7SUFDcEUsYUFBYSxFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjO0lBQ3ZELG1CQUFtQixFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxxQkFBcUI7SUFDcEUsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLGlCQUFpQixDQUFDLG1CQUFtQjtJQUNqRSxnQkFBZ0IsRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCO0lBQzdELGlCQUFpQixFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxrQkFBa0I7SUFDL0QsU0FBUyxFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXO0lBQ2hELGtCQUFrQixFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxvQkFBb0I7SUFDbEUsYUFBYSxFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjO0lBQ3ZELDJCQUEyQixFQUN6QixPQUFPLENBQUMsaUJBQWlCLENBQUMsOEJBQThCO0NBQzNELENBQUM7QUEwRUYsTUFBYSxJQUFLLFNBQVEsR0FBRyxDQUFDLFNBQVM7SUFVckMsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFnQjtRQUM1RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLDBCQUEwQjtRQUMxQixJQUFJLENBQUMsb0JBQW9CLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFakMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FB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QUFFLENBQUMsR0FBRyxDQUFDO1NBQ2pCLENBQUMsQ0FDSCxDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0Y7QUE5V0Qsb0JBOFdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcIkBhd3MtY2RrL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIGNvZ25pdG8gZnJvbSBcIkBhd3MtY2RrL2F3cy1jb2duaXRvXCI7XG5cbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgU3RhY2sgfSBmcm9tIFwiLi9TdGFja1wiO1xuaW1wb3J0IHsgSVNzdENvbnN0cnVjdCwgSVNzdENvbnN0cnVjdEluZm8gfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMsIGF0dGFjaFBlcm1pc3Npb25zVG9Sb2xlIH0gZnJvbSBcIi4vdXRpbC9wZXJtaXNzaW9uXCI7XG5cbmNvbnN0IEF1dGhVc2VyUG9vbFRyaWdnZXJPcGVyYXRpb25NYXBwaW5nID0ge1xuICBjcmVhdGVBdXRoQ2hhbGxlbmdlOiBjb2duaXRvLlVzZXJQb29sT3BlcmF0aW9uLkNSRUFURV9BVVRIX0NIQUxMRU5HRSxcbiAgY3VzdG9tTWVzc2FnZTogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5DVVNUT01fTUVTU0FHRSxcbiAgZGVmaW5lQXV0aENoYWxsZW5nZTogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5ERUZJTkVfQVVUSF9DSEFMTEVOR0UsXG4gIHBvc3RBdXRoZW50aWNhdGlvbjogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5QT1NUX0FVVEhFTlRJQ0FUSU9OLFxuICBwb3N0Q29uZmlybWF0aW9uOiBjb2duaXRvLlVzZXJQb29sT3BlcmF0aW9uLlBPU1RfQ09ORklSTUFUSU9OLFxuICBwcmVBdXRoZW50aWNhdGlvbjogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5QUkVfQVVUSEVOVElDQVRJT04sXG4gIHByZVNpZ25VcDogY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5QUkVfU0lHTl9VUCxcbiAgcHJlVG9rZW5HZW5lcmF0aW9uOiBjb2duaXRvLlVzZXJQb29sT3BlcmF0aW9uLlBSRV9UT0tFTl9HRU5FUkFUSU9OLFxuICB1c2VyTWlncmF0aW9uOiBjb2duaXRvLlVzZXJQb29sT3BlcmF0aW9uLlVTRVJfTUlHUkFUSU9OLFxuICB2ZXJpZnlBdXRoQ2hhbGxlbmdlUmVzcG9uc2U6XG4gICAgY29nbml0by5Vc2VyUG9vbE9wZXJhdGlvbi5WRVJJRllfQVVUSF9DSEFMTEVOR0VfUkVTUE9OU0UsXG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhQcm9wcyB7XG4gIHJlYWRvbmx5IGNvZ25pdG8/OiBib29sZWFuIHwgQXV0aENvZ25pdG9Qcm9wcztcbiAgcmVhZG9ubHkgYXV0aDA/OiBBdXRoQXV0aDBQcm9wcztcbiAgcmVhZG9ubHkgYW1hem9uPzogQXV0aEFtYXpvblByb3BzO1xuICByZWFkb25seSBhcHBsZT86IEF1dGhBcHBsZVByb3BzO1xuICByZWFkb25seSBmYWNlYm9vaz86IEF1dGhGYWNlYm9va1Byb3BzO1xuICByZWFkb25seSBnb29nbGU/OiBBdXRoR29vZ2xlUHJvcHM7XG4gIHJlYWRvbmx5IHR3aXR0ZXI/OiBBdXRoVHdpdHRlclByb3BzO1xuICByZWFkb25seSBpZGVudGl0eVBvb2w/OiBBdXRoQ2RrQ2ZuSWRlbnRpdHlQb29sUHJvcHM7XG4gIC8vIGRlcHJlY2F0ZWRcbiAgcmVhZG9ubHkgY29nbml0b1VzZXJQb29sPzogY29nbml0by5JVXNlclBvb2w7XG4gIHJlYWRvbmx5IGNvZ25pdG9Vc2VyUG9vbENsaWVudD86IGNvZ25pdG8uSVVzZXJQb29sQ2xpZW50O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhDb2duaXRvUHJvcHMge1xuICAvLyBOb3RlOiBDREsgY3VycmVudGx5IGRvZXMgbm90IHN1cHBvcnQgaW1wb3J0aW5nIGV4aXN0aW5nIFVzZXJQb29sIGJlY2F1c2UgdGhlXG4gIC8vICAgICAgIGltcG9ydGVkIElVc2VyUG9vbCBpbnRlcmZhY2UgZG9lcyBub3QgaGF2ZSB0aGUgXCJ1c2VyUG9vbFByb3ZpZGVyTmFtZVwiXG4gIC8vICAgICAgIHByb3BlcnR5LiBcInVzZXJQb29sUHJvdmlkZXJOYW1lXCIgbmVlZHMgdG8gYmUgcGFzc2VkIGludG8gSWRlbnRpdHkgUG9vbC5cbiAgcmVhZG9ubHkgdXNlclBvb2w/OiBjb2duaXRvLlVzZXJQb29sUHJvcHMgfCBjb2duaXRvLlVzZXJQb29sO1xuICByZWFkb25seSB1c2VyUG9vbENsaWVudD86XG4gICAgfCBjb2duaXRvLlVzZXJQb29sQ2xpZW50T3B0aW9uc1xuICAgIHwgY29nbml0by5Vc2VyUG9vbENsaWVudDtcbiAgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuICByZWFkb25seSB0cmlnZ2Vycz86IEF1dGhVc2VyUG9vbFRyaWdnZXJzO1xuICAvLyBkZXByZWNhdGVkXG4gIHJlYWRvbmx5IHNpZ25JbkFsaWFzZXM/OiBjb2duaXRvLlNpZ25JbkFsaWFzZXM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aFVzZXJQb29sVHJpZ2dlcnMge1xuICByZWFkb25seSBjcmVhdGVBdXRoQ2hhbGxlbmdlPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBjdXN0b21NZXNzYWdlPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBkZWZpbmVBdXRoQ2hhbGxlbmdlPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBwb3N0QXV0aGVudGljYXRpb24/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHBvc3RDb25maXJtYXRpb24/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHByZUF1dGhlbnRpY2F0aW9uPzogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBwcmVTaWduVXA/OiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHByZVRva2VuR2VuZXJhdGlvbj86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgdXNlck1pZ3JhdGlvbj86IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgdmVyaWZ5QXV0aENoYWxsZW5nZVJlc3BvbnNlPzogRnVuY3Rpb25EZWZpbml0aW9uO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhBdXRoMFByb3BzIHtcbiAgcmVhZG9ubHkgZG9tYWluOiBzdHJpbmc7XG4gIHJlYWRvbmx5IGNsaWVudElkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aEFtYXpvblByb3BzIHtcbiAgcmVhZG9ubHkgYXBwSWQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoQXBwbGVQcm9wcyB7XG4gIHJlYWRvbmx5IHNlcnZpY2VzSWQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoRmFjZWJvb2tQcm9wcyB7XG4gIHJlYWRvbmx5IGFwcElkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aEdvb2dsZVByb3BzIHtcbiAgcmVhZG9ubHkgY2xpZW50SWQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoVHdpdHRlclByb3BzIHtcbiAgcmVhZG9ubHkgY29uc3VtZXJLZXk6IHN0cmluZztcbiAgcmVhZG9ubHkgY29uc3VtZXJTZWNyZXQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoQ2RrQ2ZuSWRlbnRpdHlQb29sUHJvcHNcbiAgZXh0ZW5kcyBPbWl0PGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sUHJvcHMsIFwiYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzXCI+IHtcbiAgcmVhZG9ubHkgYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIEF1dGggZXh0ZW5kcyBjZGsuQ29uc3RydWN0IGltcGxlbWVudHMgSVNzdENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBjb2duaXRvVXNlclBvb2w/OiBjb2duaXRvLlVzZXJQb29sO1xuICBwdWJsaWMgcmVhZG9ubHkgY29nbml0b1VzZXJQb29sQ2xpZW50PzogY29nbml0by5Vc2VyUG9vbENsaWVudDtcbiAgcHVibGljIHJlYWRvbmx5IGNvZ25pdG9DZm5JZGVudGl0eVBvb2w6IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sO1xuICBwdWJsaWMgcmVhZG9ubHkgaWFtQXV0aFJvbGU6IGlhbS5Sb2xlO1xuICBwdWJsaWMgcmVhZG9ubHkgaWFtVW5hdXRoUm9sZTogaWFtLlJvbGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25zOiB7IFtrZXk6IHN0cmluZ106IEZuIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuICBwcml2YXRlIHJlYWRvbmx5IHBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxUcmlnZ2VyczogUGVybWlzc2lvbnNbXTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkNvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEF1dGhQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICAvLyBIYW5kbGUgZGVwcmVjYXRlZCBwcm9wc1xuICAgIHRoaXMuY2hlY2tEZXByZWNhdGVkUHJvcHMocHJvcHMpO1xuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3Qge1xuICAgICAgY29nbml0bzogY29nbml0b1Byb3BzLFxuICAgICAgYXV0aDAsXG4gICAgICBhbWF6b24sXG4gICAgICBhcHBsZSxcbiAgICAgIGZhY2Vib29rLFxuICAgICAgZ29vZ2xlLFxuICAgICAgdHdpdHRlcixcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICB9ID0gcHJvcHM7XG4gICAgdGhpcy5mdW5jdGlvbnMgPSB7fTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxUcmlnZ2VycyA9IFtdO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBIYW5kbGUgQ29nbml0byBJZGVudGl0eSBQcm92aWRlcnMgKGllLiBVc2VyIFBvb2wpXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBjb2duaXRvSWRlbnRpdHlQcm92aWRlcnMgPSBbXTtcblxuICAgIGlmIChjb2duaXRvUHJvcHMpIHtcbiAgICAgIGxldCBpc1VzZXJQb29sSW1wb3J0ZWQgPSBmYWxzZTtcblxuICAgICAgLy8gQ3JlYXRlIFVzZXIgUG9vbFxuICAgICAgaWYgKHR5cGVvZiBjb2duaXRvUHJvcHMgPT09IFwiYm9vbGVhblwiKSB7XG4gICAgICAgIHRoaXMuY29nbml0b1VzZXJQb29sID0gbmV3IGNvZ25pdG8uVXNlclBvb2wodGhpcywgXCJVc2VyUG9vbFwiLCB7XG4gICAgICAgICAgdXNlclBvb2xOYW1lOiByb290LmxvZ2ljYWxQcmVmaXhlZE5hbWUoaWQpLFxuICAgICAgICAgIHNlbGZTaWduVXBFbmFibGVkOiB0cnVlLFxuICAgICAgICAgIHNpZ25JbkNhc2VTZW5zaXRpdmU6IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAoY2RrLkNvbnN0cnVjdC5pc0NvbnN0cnVjdChjb2duaXRvUHJvcHMudXNlclBvb2wpKSB7XG4gICAgICAgIGlzVXNlclBvb2xJbXBvcnRlZCA9IHRydWU7XG4gICAgICAgIHRoaXMuY29nbml0b1VzZXJQb29sID0gY29nbml0b1Byb3BzLnVzZXJQb29sO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gdmFsaWRhdGUgYGxhbWJkYVRyaWdnZXJzYCBpcyBub3Qgc3BlY2lmaWVkXG4gICAgICAgIGlmIChjb2duaXRvUHJvcHMudXNlclBvb2wgJiYgY29nbml0b1Byb3BzLnVzZXJQb29sLmxhbWJkYVRyaWdnZXJzKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYENhbm5vdCBjb25maWd1cmUgdGhlIFwiY29nbml0by51c2VyUG9vbC5sYW1iZGFUcmlnZ2Vyc1wiIGluIHRoZSBBdXRoIGNvbnN0cnVjdC4gVXNlIHRoZSBcImNvZ25pdG8udHJpZ2dlcnNcIiBpbnN0ZWFkLmBcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jb2duaXRvVXNlclBvb2wgPSBuZXcgY29nbml0by5Vc2VyUG9vbCh0aGlzLCBcIlVzZXJQb29sXCIsIHtcbiAgICAgICAgICB1c2VyUG9vbE5hbWU6IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShpZCksXG4gICAgICAgICAgc2VsZlNpZ25VcEVuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgc2lnbkluQ2FzZVNlbnNpdGl2ZTogZmFsc2UsXG4gICAgICAgICAgLi4uKGNvZ25pdG9Qcm9wcy51c2VyUG9vbCB8fCB7fSksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIENyZWF0ZSBUcmlnZ2VyIGZ1bmN0aW9uc1xuICAgICAgICBjb25zdCB7IHRyaWdnZXJzLCBkZWZhdWx0RnVuY3Rpb25Qcm9wcyB9ID0gY29nbml0b1Byb3BzO1xuICAgICAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzID0gZGVmYXVsdEZ1bmN0aW9uUHJvcHM7XG5cbiAgICAgICAgaWYgKHRyaWdnZXJzKSB7XG4gICAgICAgICAgT2JqZWN0LmVudHJpZXModHJpZ2dlcnMpLmZvckVhY2goKFt0cmlnZ2VyS2V5LCB0cmlnZ2VyVmFsdWVdKSA9PlxuICAgICAgICAgICAgdGhpcy5hZGRUcmlnZ2VyKFxuICAgICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgICB0cmlnZ2VyS2V5IGFzIGtleW9mIEF1dGhVc2VyUG9vbFRyaWdnZXJzLFxuICAgICAgICAgICAgICB0cmlnZ2VyVmFsdWVcbiAgICAgICAgICAgIClcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSBVc2VyIFBvb2wgQ2xpZW50XG4gICAgICBpZiAodHlwZW9mIGNvZ25pdG9Qcm9wcyA9PT0gXCJib29sZWFuXCIpIHtcbiAgICAgICAgdGhpcy5jb2duaXRvVXNlclBvb2xDbGllbnQgPSBuZXcgY29nbml0by5Vc2VyUG9vbENsaWVudChcbiAgICAgICAgICB0aGlzLFxuICAgICAgICAgIFwiVXNlclBvb2xDbGllbnRcIixcbiAgICAgICAgICB7XG4gICAgICAgICAgICB1c2VyUG9vbDogdGhpcy5jb2duaXRvVXNlclBvb2wsXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChjZGsuQ29uc3RydWN0LmlzQ29uc3RydWN0KGNvZ25pdG9Qcm9wcy51c2VyUG9vbENsaWVudCkpIHtcbiAgICAgICAgaWYgKCFpc1VzZXJQb29sSW1wb3J0ZWQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgQ2Fubm90IGltcG9ydCB0aGUgXCJ1c2VyUG9vbENsaWVudFwiIHdoZW4gdGhlIFwidXNlclBvb2xcIiBpcyBub3QgaW1wb3J0ZWQuYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jb2duaXRvVXNlclBvb2xDbGllbnQgPSBjb2duaXRvUHJvcHMudXNlclBvb2xDbGllbnQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmNvZ25pdG9Vc2VyUG9vbENsaWVudCA9IG5ldyBjb2duaXRvLlVzZXJQb29sQ2xpZW50KFxuICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgXCJVc2VyUG9vbENsaWVudFwiLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHVzZXJQb29sOiB0aGlzLmNvZ25pdG9Vc2VyUG9vbCxcbiAgICAgICAgICAgIC4uLihjb2duaXRvUHJvcHMudXNlclBvb2xDbGllbnQgfHwge30pLFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gU2V0IGNvZ25pdG8gcHJvdmlkZXJzXG4gICAgICBjb2duaXRvSWRlbnRpdHlQcm92aWRlcnMucHVzaCh7XG4gICAgICAgIHByb3ZpZGVyTmFtZTogdGhpcy5jb2duaXRvVXNlclBvb2wudXNlclBvb2xQcm92aWRlck5hbWUsXG4gICAgICAgIGNsaWVudElkOiB0aGlzLmNvZ25pdG9Vc2VyUG9vbENsaWVudC51c2VyUG9vbENsaWVudElkLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBIYW5kbGUgT3BlbklkIENvbm5lY3QgUHJvdmlkZXJzIChpZS4gQXV0aDApXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBvcGVuSWRDb25uZWN0UHJvdmlkZXJBcm5zID0gW107XG5cbiAgICBpZiAoYXV0aDApIHtcbiAgICAgIGlmICghYXV0aDAuZG9tYWluKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gQXV0aDAgZG9tYWluIGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGApO1xuICAgICAgfVxuICAgICAgaWYgKCFhdXRoMC5jbGllbnRJZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIEF1dGgwIGNsaWVudElkIGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGApO1xuICAgICAgfVxuICAgICAgY29uc3QgcHJvdmlkZXIgPSBuZXcgaWFtLk9wZW5JZENvbm5lY3RQcm92aWRlcih0aGlzLCBcIkF1dGgwUHJvdmlkZXJcIiwge1xuICAgICAgICB1cmw6IGF1dGgwLmRvbWFpbi5zdGFydHNXaXRoKFwiaHR0cHM6Ly9cIilcbiAgICAgICAgICA/IGF1dGgwLmRvbWFpblxuICAgICAgICAgIDogYGh0dHBzOi8vJHthdXRoMC5kb21haW59YCxcbiAgICAgICAgY2xpZW50SWRzOiBbYXV0aDAuY2xpZW50SWRdLFxuICAgICAgfSk7XG4gICAgICBvcGVuSWRDb25uZWN0UHJvdmlkZXJBcm5zLnB1c2gocHJvdmlkZXIub3BlbklkQ29ubmVjdFByb3ZpZGVyQXJuKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEhhbmRsZSBTb2NpYWwgSWRlbnRpdHkgUHJvdmlkZXJzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCBzdXBwb3J0ZWRMb2dpblByb3ZpZGVycyA9IHt9IGFzIHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XG5cbiAgICBpZiAoYW1hem9uKSB7XG4gICAgICBpZiAoIWFtYXpvbi5hcHBJZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIEFtYXpvbiBhcHBJZCBkZWZpbmVkIGZvciB0aGUgXCIke2lkfVwiIEF1dGhgKTtcbiAgICAgIH1cbiAgICAgIHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzW1wid3d3LmFtYXpvbi5jb21cIl0gPSBhbWF6b24uYXBwSWQ7XG4gICAgfVxuICAgIGlmIChmYWNlYm9vaykge1xuICAgICAgaWYgKCFmYWNlYm9vay5hcHBJZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIEZhY2Vib29rIGFwcElkIGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGApO1xuICAgICAgfVxuICAgICAgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnNbXCJncmFwaC5mYWNlYm9vay5jb21cIl0gPSBmYWNlYm9vay5hcHBJZDtcbiAgICB9XG4gICAgaWYgKGdvb2dsZSkge1xuICAgICAgaWYgKCFnb29nbGUuY2xpZW50SWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBHb29nbGUgYXBwSWQgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBBdXRoYCk7XG4gICAgICB9XG4gICAgICBzdXBwb3J0ZWRMb2dpblByb3ZpZGVyc1tcImFjY291bnRzLmdvb2dsZS5jb21cIl0gPSBnb29nbGUuY2xpZW50SWQ7XG4gICAgfVxuICAgIGlmICh0d2l0dGVyKSB7XG4gICAgICBpZiAoIXR3aXR0ZXIuY29uc3VtZXJLZXkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBUd2l0dGVyIGNvbnN1bWVyIGtleSBkZWZpbmVkIGZvciB0aGUgXCIke2lkfVwiIEF1dGhgKTtcbiAgICAgIH1cbiAgICAgIGlmICghdHdpdHRlci5jb25zdW1lclNlY3JldCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYE5vIFR3aXR0ZXIgY29uc3VtZXIgc2VjcmV0IGRlZmluZWQgZm9yIHRoZSBcIiR7aWR9XCIgQXV0aGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzW1xuICAgICAgICBcImFwaS50d2l0dGVyLmNvbVwiXG4gICAgICBdID0gYCR7dHdpdHRlci5jb25zdW1lcktleX07JHt0d2l0dGVyLmNvbnN1bWVyU2VjcmV0fWA7XG4gICAgfVxuICAgIGlmIChhcHBsZSkge1xuICAgICAgaWYgKCFhcHBsZS5zZXJ2aWNlc0lkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gQXBwbGUgc2VydmljZXNJZCBkZWZpbmVkIGZvciB0aGUgXCIke2lkfVwiIEF1dGhgKTtcbiAgICAgIH1cbiAgICAgIHN1cHBvcnRlZExvZ2luUHJvdmlkZXJzW1wiYXBwbGVpZC5hcHBsZS5jb21cIl0gPSBhcHBsZS5zZXJ2aWNlc0lkO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIElkZW50aXR5IFBvb2xcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgLy8gQ3JlYXRlIENvZ25pdG8gSWRlbnRpdHkgUG9vbFxuICAgIHRoaXMuY29nbml0b0NmbklkZW50aXR5UG9vbCA9IG5ldyBjb2duaXRvLkNmbklkZW50aXR5UG9vbChcbiAgICAgIHRoaXMsXG4gICAgICBcIklkZW50aXR5UG9vbFwiLFxuICAgICAge1xuICAgICAgICBpZGVudGl0eVBvb2xOYW1lOiByb290LmxvZ2ljYWxQcmVmaXhlZE5hbWUoaWQpLFxuICAgICAgICBhbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXM6IHRydWUsXG4gICAgICAgIGNvZ25pdG9JZGVudGl0eVByb3ZpZGVycyxcbiAgICAgICAgc3VwcG9ydGVkTG9naW5Qcm92aWRlcnMsXG4gICAgICAgIG9wZW5JZENvbm5lY3RQcm92aWRlckFybnMsXG4gICAgICAgIC4uLihpZGVudGl0eVBvb2wgfHwge30pLFxuICAgICAgfVxuICAgICk7XG4gICAgdGhpcy5pYW1BdXRoUm9sZSA9IHRoaXMuY3JlYXRlQXV0aFJvbGUodGhpcy5jb2duaXRvQ2ZuSWRlbnRpdHlQb29sKTtcbiAgICB0aGlzLmlhbVVuYXV0aFJvbGUgPSB0aGlzLmNyZWF0ZVVuYXV0aFJvbGUodGhpcy5jb2duaXRvQ2ZuSWRlbnRpdHlQb29sKTtcblxuICAgIC8vIEF0dGFjaCByb2xlcyB0byBJZGVudGl0eSBQb29sXG4gICAgbmV3IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQoXG4gICAgICB0aGlzLFxuICAgICAgXCJJZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudFwiLFxuICAgICAge1xuICAgICAgICBpZGVudGl0eVBvb2xJZDogdGhpcy5jb2duaXRvQ2ZuSWRlbnRpdHlQb29sLnJlZixcbiAgICAgICAgcm9sZXM6IHtcbiAgICAgICAgICBhdXRoZW50aWNhdGVkOiB0aGlzLmlhbUF1dGhSb2xlLnJvbGVBcm4sXG4gICAgICAgICAgdW5hdXRoZW50aWNhdGVkOiB0aGlzLmlhbVVuYXV0aFJvbGUucm9sZUFybixcbiAgICAgICAgfSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIFJlZ2lzdGVyIENvbnN0cnVjdFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICByb290LnJlZ2lzdGVyQ29uc3RydWN0KHRoaXMpO1xuICB9XG5cbiAgcHVibGljIGdldCBjb2duaXRvSWRlbnRpdHlQb29sSWQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jb2duaXRvQ2ZuSWRlbnRpdHlQb29sLnJlZjtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9uc0ZvckF1dGhVc2VycyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBhdHRhY2hQZXJtaXNzaW9uc1RvUm9sZSh0aGlzLmlhbUF1dGhSb2xlLCBwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNGb3JVbmF1dGhVc2VycyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBhdHRhY2hQZXJtaXNzaW9uc1RvUm9sZSh0aGlzLmlhbVVuYXV0aFJvbGUsIHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9uc0ZvclRyaWdnZXJzKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIE9iamVjdC52YWx1ZXModGhpcy5mdW5jdGlvbnMpLmZvckVhY2goKGZuKSA9PlxuICAgICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgKTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxUcmlnZ2Vycy5wdXNoKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9uc0ZvclRyaWdnZXIoXG4gICAgdHJpZ2dlcktleToga2V5b2YgQXV0aFVzZXJQb29sVHJpZ2dlcnMsXG4gICAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25zXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGZuID0gdGhpcy5nZXRGdW5jdGlvbih0cmlnZ2VyS2V5KTtcbiAgICBpZiAoIWZuKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gYXR0YWNoIHBlcm1pc3Npb25zLiBUcmlnZ2VyIFwiJHt0cmlnZ2VyS2V5fVwiIGRvZXMgbm90IGV4aXN0LmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldEZ1bmN0aW9uKHRyaWdnZXJLZXk6IGtleW9mIEF1dGhVc2VyUG9vbFRyaWdnZXJzKTogRm4gfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmZ1bmN0aW9uc1t0cmlnZ2VyS2V5XTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RJbmZvKCk6IElTc3RDb25zdHJ1Y3RJbmZvIHtcbiAgICByZXR1cm4ge1xuICAgICAgaWRlbnRpdHlQb29sTG9naWNhbElkOiBTdGFjay5vZih0aGlzKS5nZXRMb2dpY2FsSWQodGhpcy5jb2duaXRvQ2ZuSWRlbnRpdHlQb29sKSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0RlcHJlY2F0ZWRQcm9wcyhwcm9wczogQXV0aFByb3BzKTogdm9pZCB7XG4gICAgaWYgKHByb3BzLmNvZ25pdG9Vc2VyUG9vbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgVGhlIFwiY29nbml0b1VzZXJQb29sXCIgcHJvcGVydHkgaXMgZGVwcmVjYXRlZC4gVXNlIHRoZSBcImNvZ25pdG8udXNlclBvb2xcIiBpbnN0ZWFkLiBNb3JlIGRldGFpbHMgb24gdXBncmFkaW5nIC0gaHR0cHM6Ly9kb2NzLnNlcnZlcmxlc3Mtc3RhY2suY29tL2NvbnN0cnVjdHMvQXV0aCN1cGdyYWRpbmctdG8tdjAxMjBgXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAocHJvcHMuY29nbml0b1VzZXJQb29sQ2xpZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGUgXCJjb2duaXRvVXNlclBvb2xDbGllbnRcIiBwcm9wZXJ0eSBpcyBkZXByZWNhdGVkLiBVc2UgdGhlIFwiY29nbml0by51c2VyUG9vbENsaWVudFwiIGluc3RlYWQuIE1vcmUgZGV0YWlscyBvbiB1cGdyYWRpbmcgLSBodHRwczovL2RvY3Muc2VydmVybGVzcy1zdGFjay5jb20vY29uc3RydWN0cy9BdXRoI3VwZ3JhZGluZy10by12MDEyMGBcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChwcm9wcy5jb2duaXRvKSB7XG4gICAgICBpZiAocHJvcHMuY29nbml0byAhPT0gdHJ1ZSAmJiBwcm9wcy5jb2duaXRvPy5zaWduSW5BbGlhc2VzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGhlIFwiY29nbml0by5zaWduSW5BbGlhc2VzXCIgcHJvcGVydHkgaXMgZGVwcmVjYXRlZC4gVXNlIHRoZSBcImNvZ25pdG8udXNlclBvb2wuc2lnbkluQWxpYXNlc1wiIGluc3RlYWQuIE1vcmUgZGV0YWlscyBvbiB1cGdyYWRpbmcgLSBodHRwczovL2RvY3Muc2VydmVybGVzcy1zdGFjay5jb20vY29uc3RydWN0cy9BdXRoI3VwZ3JhZGluZy10by12MDEyMGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZFRyaWdnZXIoXG4gICAgc2NvcGU6IGNkay5Db25zdHJ1Y3QsXG4gICAgdHJpZ2dlcktleToga2V5b2YgQXV0aFVzZXJQb29sVHJpZ2dlcnMsXG4gICAgdHJpZ2dlclZhbHVlOiBGdW5jdGlvbkRlZmluaXRpb25cbiAgKTogRm4ge1xuICAgIC8vIFZhbGlkYXRlIGNvZ25pdG8gdXNlciBwb29sIGlzIGRlZmluZWRcbiAgICBpZiAoIXRoaXMuY29nbml0b1VzZXJQb29sKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUcmlnZ2VycyBjYW5ub3QgYmUgYWRkZWQuIE5vIENvZ25pdG8gVXNlclBvb2wgZGVmaW5lZCBmb3IgdGhlIEF1dGggY29uc3RydWN0LmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIEZ1bmN0aW9uXG4gICAgY29uc3QgbGFtYmRhID0gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICBzY29wZSxcbiAgICAgIHRyaWdnZXJLZXksXG4gICAgICB0cmlnZ2VyVmFsdWUsXG4gICAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgYFRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgY2Fubm90IGJlIGFwcGxpZWQgaWYgYW4gaW5zdGFuY2Ugb2YgYSBGdW5jdGlvbiBjb25zdHJ1Y3QgaXMgcGFzc2VkIGluLiBNYWtlIHN1cmUgdG8gZGVmaW5lIGFsbCB0aGUgdHJpZ2dlcnMgdXNpbmcgRnVuY3Rpb25Qcm9wcywgc28gdGhlIEF1dGggY29uc3RydWN0IGNhbiBhcHBseSB0aGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIHRvIHRoZW0uYFxuICAgICk7XG5cbiAgICAvLyBDcmVhdGUgdHJpZ2dlclxuICAgIGNvbnN0IG9wZXJhdGlvbiA9IEF1dGhVc2VyUG9vbFRyaWdnZXJPcGVyYXRpb25NYXBwaW5nW3RyaWdnZXJLZXldO1xuICAgIHRoaXMuY29nbml0b1VzZXJQb29sLmFkZFRyaWdnZXIob3BlcmF0aW9uLCBsYW1iZGEpO1xuXG4gICAgLy8gU3RvcmUgZnVuY3Rpb25cbiAgICB0aGlzLmZ1bmN0aW9uc1t0cmlnZ2VyS2V5XSA9IGxhbWJkYTtcblxuICAgIHJldHVybiBsYW1iZGE7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUF1dGhSb2xlKGlkZW50aXR5UG9vbDogY29nbml0by5DZm5JZGVudGl0eVBvb2wpOiBpYW0uUm9sZSB7XG4gICAgY29uc3Qgcm9sZSA9IG5ldyBpYW0uUm9sZSh0aGlzLCBcIklkZW50aXR5UG9vbEF1dGhSb2xlXCIsIHtcbiAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5GZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tXCIsXG4gICAgICAgIHtcbiAgICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZFwiOiBpZGVudGl0eVBvb2wucmVmLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgXCJGb3JBbnlWYWx1ZTpTdHJpbmdMaWtlXCI6IHtcbiAgICAgICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmFtclwiOiBcImF1dGhlbnRpY2F0ZWRcIixcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBcInN0czpBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5XCJcbiAgICAgICksXG4gICAgfSk7XG5cbiAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICBcIm1vYmlsZWFuYWx5dGljczpQdXRFdmVudHNcIixcbiAgICAgICAgICBcImNvZ25pdG8tc3luYzoqXCIsXG4gICAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5OipcIixcbiAgICAgICAgXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgcmV0dXJuIHJvbGU7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVVuYXV0aFJvbGUoaWRlbnRpdHlQb29sOiBjb2duaXRvLkNmbklkZW50aXR5UG9vbCk6IGlhbS5Sb2xlIHtcbiAgICBjb25zdCByb2xlID0gbmV3IGlhbS5Sb2xlKHRoaXMsIFwiSWRlbnRpdHlQb29sVW5hdXRoUm9sZVwiLCB7XG4gICAgICBhc3N1bWVkQnk6IG5ldyBpYW0uRmVkZXJhdGVkUHJpbmNpcGFsKFxuICAgICAgICBcImNvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbVwiLFxuICAgICAgICB7XG4gICAgICAgICAgU3RyaW5nRXF1YWxzOiB7XG4gICAgICAgICAgICBcImNvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphdWRcIjogaWRlbnRpdHlQb29sLnJlZixcbiAgICAgICAgICB9LFxuICAgICAgICAgIFwiRm9yQW55VmFsdWU6U3RyaW5nTGlrZVwiOiB7XG4gICAgICAgICAgICBcImNvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphbXJcIjogXCJ1bmF1dGhlbnRpY2F0ZWRcIixcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBcInN0czpBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5XCJcbiAgICAgICksXG4gICAgfSk7XG5cbiAgICByb2xlLmFkZFRvUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcIm1vYmlsZWFuYWx5dGljczpQdXRFdmVudHNcIiwgXCJjb2duaXRvLXN5bmM6KlwiXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgcmV0dXJuIHJvbGU7XG4gIH1cbn1cbiJdfQ==