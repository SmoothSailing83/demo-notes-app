"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.StaticSite = exports.StaticSiteErrorOptions = void 0;
const chalk_1 = __importDefault(require("chalk"));
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const crypto = __importStar(require("crypto"));
const child_process_1 = require("child_process");
const cdk = __importStar(require("@aws-cdk/core"));
const s3 = __importStar(require("@aws-cdk/aws-s3"));
const s3Assets = __importStar(require("@aws-cdk/aws-s3-assets"));
const acm = __importStar(require("@aws-cdk/aws-certificatemanager"));
const iam = __importStar(require("@aws-cdk/aws-iam"));
const lambda = __importStar(require("@aws-cdk/aws-lambda"));
const route53 = __importStar(require("@aws-cdk/aws-route53"));
const route53Patterns = __importStar(require("@aws-cdk/aws-route53-patterns"));
const route53Targets = __importStar(require("@aws-cdk/aws-route53-targets"));
const cloudfront = __importStar(require("@aws-cdk/aws-cloudfront"));
const cfOrigins = __importStar(require("@aws-cdk/aws-cloudfront-origins"));
const lambda_layer_awscli_1 = require("@aws-cdk/lambda-layer-awscli");
const BaseSite_1 = require("./BaseSite");
const Stack_1 = require("./Stack");
const Construct_1 = require("./Construct");
var StaticSiteErrorOptions;
(function (StaticSiteErrorOptions) {
    StaticSiteErrorOptions["REDIRECT_TO_INDEX_PAGE"] = "REDIRECT_TO_INDEX_PAGE";
})(StaticSiteErrorOptions = exports.StaticSiteErrorOptions || (exports.StaticSiteErrorOptions = {}));
class StaticSite extends Construct_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        // Local development or skip build => stub asset
        this.isPlaceholder =
            (root.local || root.skipBuild) && !props.disablePlaceholder;
        const buildDir = root.buildDir;
        const fileSizeLimit = root.isJestTest()
            ? // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                // @ts-ignore: "jestFileSizeLimitOverride" not exposed in props
                props.jestFileSizeLimitOverride || 200
            : 200;
        this.props = props;
        this.awsCliLayer = new lambda_layer_awscli_1.AwsCliLayer(this, "AwsCliLayer");
        this.registerSiteEnvironment();
        // Validate input
        this.validateCustomDomainSettings();
        // Build app
        this.assets = this.buildApp(fileSizeLimit, buildDir);
        const assetsHash = crypto
            .createHash("md5")
            .update(this.assets.map(({ assetHash }) => assetHash).join(""))
            .digest("hex");
        this.deployId = this.isPlaceholder ? `deploy-live` : `deploy-${assetsHash}`;
        // Create Bucket
        this.s3Bucket = this.createS3Bucket();
        // Create Custom Domain
        this.hostedZone = this.lookupHostedZone();
        this.acmCertificate = this.createCertificate();
        // Create S3 Deployment
        const s3deployCR = this.createS3Deployment();
        // Create CloudFront
        this.cfDistribution = this.createCfDistribution();
        this.cfDistribution.node.addDependency(s3deployCR);
        // Invalidate CloudFront
        const invalidationCR = this.createCloudFrontInvalidation();
        invalidationCR.node.addDependency(this.cfDistribution);
        // Connect Custom Domain to CloudFront Distribution
        this.createRoute53Records();
        ///////////////////
        // Register Construct
        ///////////////////
        root.registerConstruct(this);
    }
    get url() {
        return `https://${this.cfDistribution.distributionDomainName}`;
    }
    get customDomainUrl() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === "string") {
            return `https://${customDomain}`;
        }
        else {
            return `https://${customDomain.domainName}`;
        }
    }
    get bucketArn() {
        return this.s3Bucket.bucketArn;
    }
    get bucketName() {
        return this.s3Bucket.bucketName;
    }
    get distributionId() {
        return this.cfDistribution.distributionId;
    }
    get distributionDomain() {
        return this.cfDistribution.distributionDomainName;
    }
    getConstructInfo() {
        const cfn = this.cfDistribution.node
            .defaultChild;
        return {
            distributionLogicalId: Stack_1.Stack.of(this).getLogicalId(cfn),
            customDomainUrl: this.customDomainUrl,
        };
    }
    buildApp(fileSizeLimit, buildDir) {
        if (this.isPlaceholder) {
            return [
                new s3Assets.Asset(this, "Asset", {
                    path: path.resolve(__dirname, "../assets/StaticSite/stub"),
                }),
            ];
        }
        const { path: sitePath, buildCommand } = this.props;
        const buildOutput = this.props.buildOutput || ".";
        // validate site path exists
        if (!fs.existsSync(sitePath)) {
            throw new Error(`No path found at "${path.resolve(sitePath)}" for the "${this.node.id}" StaticSite.`);
        }
        // Build and package user's website
        // build
        if (buildCommand) {
            try {
                console.log(chalk_1.default.grey(`Building static site ${sitePath}`));
                (0, child_process_1.execSync)(buildCommand, {
                    cwd: sitePath,
                    stdio: "inherit",
                    env: Object.assign(Object.assign({}, process.env), (0, BaseSite_1.getBuildCmdEnvironment)(this.props.environment)),
                });
            }
            catch (e) {
                throw new Error(`There was a problem building the "${this.node.id}" StaticSite.`);
            }
        }
        // validate buildOutput exists
        const siteOutputPath = path.resolve(path.join(sitePath, buildOutput));
        if (!fs.existsSync(siteOutputPath)) {
            throw new Error(`No build output found at "${siteOutputPath}" for the "${this.node.id}" StaticSite.`);
        }
        // create zip files
        const script = path.join(__dirname, "../assets/BaseSite/archiver.js");
        const zipPath = path.resolve(path.join(buildDir, `StaticSite-${this.node.id}-${this.node.addr}`));
        // clear zip path to ensure no partX.zip remain from previous build
        fs.removeSync(zipPath);
        const cmd = ["node", script, siteOutputPath, zipPath, fileSizeLimit].join(" ");
        try {
            (0, child_process_1.execSync)(cmd, {
                cwd: sitePath,
                stdio: "inherit",
            });
        }
        catch (e) {
            throw new Error(`There was a problem generating the "${this.node.id}" StaticSite package.`);
        }
        // create assets
        const assets = [];
        for (let partId = 0;; partId++) {
            const zipFilePath = path.join(zipPath, `part${partId}.zip`);
            if (!fs.existsSync(zipFilePath)) {
                break;
            }
            assets.push(new s3Assets.Asset(this, `Asset${partId}`, {
                path: zipFilePath,
            }));
        }
        return assets;
    }
    createS3Bucket() {
        let { s3Bucket } = this.props;
        s3Bucket = s3Bucket || {};
        // Validate s3Bucket
        if (s3Bucket.websiteIndexDocument) {
            throw new Error(`Do not configure the "s3Bucket.websiteIndexDocument". Use the "indexPage" to configure the StaticSite index page.`);
        }
        if (s3Bucket.websiteErrorDocument) {
            throw new Error(`Do not configure the "s3Bucket.websiteErrorDocument". Use the "errorPage" to configure the StaticSite index page.`);
        }
        return new s3.Bucket(this, "Bucket", Object.assign({ autoDeleteObjects: true, removalPolicy: cdk.RemovalPolicy.DESTROY }, s3Bucket));
    }
    createS3Deployment() {
        const { fileOptions } = this.props;
        // Create a Lambda function that will be doing the uploading
        const uploader = new lambda.Function(this, "S3Uploader", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "s3-upload.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        this.s3Bucket.grantReadWrite(uploader);
        this.assets.forEach((asset) => asset.grantRead(uploader));
        // Create the custom resource function
        const handler = new lambda.Function(this, "S3Handler", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "s3-handler.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
            environment: {
                UPLOADER_FUNCTION_NAME: uploader.functionName,
            },
        });
        this.s3Bucket.grantReadWrite(handler);
        uploader.grantInvoke(handler);
        // Create custom resource
        return new cdk.CustomResource(this, "S3Deployment", {
            serviceToken: handler.functionArn,
            resourceType: "Custom::SSTBucketDeployment",
            properties: {
                Sources: this.assets.map((asset) => ({
                    BucketName: asset.s3BucketName,
                    ObjectKey: asset.s3ObjectKey,
                })),
                DestinationBucketName: this.s3Bucket.bucketName,
                DestinationBucketKeyPrefix: this.deployId,
                FileOptions: (fileOptions || []).map(({ exclude, include, cacheControl }) => {
                    if (typeof exclude === "string") {
                        exclude = [exclude];
                    }
                    if (typeof include === "string") {
                        include = [include];
                    }
                    const options = [];
                    exclude.forEach((per) => options.push("--exclude", per));
                    include.forEach((per) => options.push("--include", per));
                    options.push("--cache-control", cacheControl);
                    return options;
                }),
                ReplaceValues: this.getS3ContentReplaceValues(),
            },
        });
    }
    /////////////////////
    // CloudFront Distribution
    /////////////////////
    createCfDistribution() {
        const { cfDistribution, customDomain } = this.props;
        const indexPage = this.props.indexPage || "index.html";
        const errorPage = this.props.errorPage;
        const cfDistributionProps = cfDistribution || {};
        // Validate input
        if (cfDistributionProps.certificate) {
            throw new Error(`Do not configure the "cfDistribution.certificate". Use the "customDomain" to configure the StaticSite domain certificate.`);
        }
        if (cfDistributionProps.domainNames) {
            throw new Error(`Do not configure the "cfDistribution.domainNames". Use the "customDomain" to configure the StaticSite domain.`);
        }
        // Build domainNames
        const domainNames = [];
        if (!customDomain) {
            // no domain
        }
        else if (typeof customDomain === "string") {
            domainNames.push(customDomain);
        }
        else {
            domainNames.push(customDomain.domainName);
            if (customDomain.alternateNames) {
                if (!customDomain.certificate)
                    throw new Error("Certificates for alternate domains cannot be automatically created. Please specify certificate to use");
                domainNames.push(...customDomain.alternateNames);
            }
        }
        // Build errorResponses
        let errorResponses;
        // case: sst start => showing stub site, and redirect all routes to the index page
        if (this.isPlaceholder) {
            errorResponses = (0, BaseSite_1.buildErrorResponsesForRedirectToIndex)(indexPage);
        }
        else if (errorPage) {
            if (cfDistributionProps.errorResponses) {
                throw new Error(`Cannot configure the "cfDistribution.errorResponses" when "errorPage" is passed in. Use one or the other to configure the behavior for error pages.`);
            }
            errorResponses =
                errorPage === StaticSiteErrorOptions.REDIRECT_TO_INDEX_PAGE
                    ? (0, BaseSite_1.buildErrorResponsesForRedirectToIndex)(indexPage)
                    : (0, BaseSite_1.buildErrorResponsesFor404ErrorPage)(errorPage);
        }
        // Create CloudFront distribution
        return new cloudfront.Distribution(this, "Distribution", Object.assign(Object.assign({ 
            // these values can be overwritten by cfDistributionProps
            defaultRootObject: indexPage, errorResponses }, cfDistributionProps), { 
            // these values can NOT be overwritten by cfDistributionProps
            domainNames, certificate: this.acmCertificate, defaultBehavior: Object.assign({ origin: new cfOrigins.S3Origin(this.s3Bucket, {
                    originPath: this.deployId,
                }), viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS }, (cfDistributionProps.defaultBehavior || {})) }));
    }
    createCloudFrontInvalidation() {
        // Create a Lambda function that will be doing the invalidation
        const invalidator = new lambda.Function(this, "CloudFrontInvalidator", {
            code: lambda.Code.fromAsset(path.join(__dirname, "../assets/BaseSite/custom-resource")),
            layers: [this.awsCliLayer],
            runtime: lambda.Runtime.PYTHON_3_7,
            handler: "cf-invalidate.handler",
            timeout: cdk.Duration.minutes(15),
            memorySize: 1024,
        });
        // Grant permissions to invalidate CF Distribution
        invalidator.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "cloudfront:GetInvalidation",
                "cloudfront:CreateInvalidation",
            ],
            resources: ["*"],
        }));
        // Create custom resource
        return new cdk.CustomResource(this, "CloudFrontInvalidation", {
            serviceToken: invalidator.functionArn,
            resourceType: "Custom::SSTCloudFrontInvalidation",
            properties: {
                // need the DeployId field so this CR gets updated on each deploy
                DeployId: this.deployId,
                DistributionId: this.cfDistribution.distributionId,
                DistributionPaths: ["/*"],
            },
        });
    }
    /////////////////////
    // Custom Domain
    /////////////////////
    validateCustomDomainSettings() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        if (typeof customDomain === "string") {
            return;
        }
        if (customDomain.isExternalDomain === true) {
            if (!customDomain.certificate) {
                throw new Error(`A valid certificate is required when "isExternalDomain" is set to "true".`);
            }
            if (customDomain.domainAlias) {
                throw new Error(`Domain alias is only supported for domains hosted on Amazon Route 53. Do not set the "customDomain.domainAlias" when "isExternalDomain" is enabled.`);
            }
            if (customDomain.hostedZone) {
                throw new Error(`Hosted zones can only be configured for domains hosted on Amazon Route 53. Do not set the "customDomain.hostedZone" when "isExternalDomain" is enabled.`);
            }
        }
    }
    lookupHostedZone() {
        const { customDomain } = this.props;
        // Skip if customDomain is not configured
        if (!customDomain) {
            return;
        }
        let hostedZone;
        if (typeof customDomain === "string") {
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain,
            });
        }
        else if (cdk.Construct.isConstruct(customDomain.hostedZone)) {
            hostedZone = customDomain.hostedZone;
        }
        else if (typeof customDomain.hostedZone === "string") {
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain.hostedZone,
            });
        }
        else if (typeof customDomain.domainName === "string") {
            // Skip if domain is not a Route53 domain
            if (customDomain.isExternalDomain === true) {
                return;
            }
            hostedZone = route53.HostedZone.fromLookup(this, "HostedZone", {
                domainName: customDomain.domainName,
            });
        }
        else {
            hostedZone = customDomain.hostedZone;
        }
        return hostedZone;
    }
    createCertificate() {
        const { customDomain } = this.props;
        if (!customDomain) {
            return;
        }
        let acmCertificate;
        // HostedZone is set for Route 53 domains
        if (this.hostedZone) {
            if (typeof customDomain === "string") {
                acmCertificate = new acm.DnsValidatedCertificate(this, "Certificate", {
                    domainName: customDomain,
                    hostedZone: this.hostedZone,
                    region: "us-east-1",
                });
            }
            else if (customDomain.certificate) {
                acmCertificate = customDomain.certificate;
            }
            else {
                acmCertificate = new acm.DnsValidatedCertificate(this, "Certificate", {
                    domainName: customDomain.domainName,
                    hostedZone: this.hostedZone,
                    region: "us-east-1",
                });
            }
        }
        // HostedZone is NOT set for non-Route 53 domains
        else {
            if (typeof customDomain !== "string") {
                acmCertificate = customDomain.certificate;
            }
        }
        return acmCertificate;
    }
    createRoute53Records() {
        const { customDomain } = this.props;
        if (!customDomain || !this.hostedZone) {
            return;
        }
        let recordName;
        let domainAlias;
        if (typeof customDomain === "string") {
            recordName = customDomain;
        }
        else {
            recordName = customDomain.domainName;
            domainAlias = customDomain.domainAlias;
        }
        // Create DNS record
        new route53.ARecord(this, "AliasRecord", {
            recordName,
            zone: this.hostedZone,
            target: route53.RecordTarget.fromAlias(new route53Targets.CloudFrontTarget(this.cfDistribution)),
        });
        // Create Alias redirect record
        if (domainAlias) {
            new route53Patterns.HttpsRedirect(this, "Redirect", {
                zone: this.hostedZone,
                recordNames: [domainAlias],
                targetDomain: recordName,
            });
        }
    }
    /////////////////////
    // Helper Functions
    /////////////////////
    getS3ContentReplaceValues() {
        const replaceValues = this.props.replaceValues || [];
        Object.entries(this.props.environment || {})
            .filter(([, value]) => cdk.Token.isUnresolved(value))
            .forEach(([key, value]) => {
            const token = `{{ ${key} }}`;
            replaceValues.push({
                files: "index.html",
                search: token,
                replace: value,
            }, {
                files: "**/*.js",
                search: token,
                replace: value,
            });
        });
        return replaceValues;
    }
    registerSiteEnvironment() {
        const environmentOutputs = {};
        for (const [key, value] of Object.entries(this.props.environment || {})) {
            const outputId = `SstSiteEnv_${key}`;
            const output = new cdk.CfnOutput(this, outputId, { value });
            environmentOutputs[key] = cdk.Stack.of(this).getLogicalId(output);
        }
        const root = this.node.root;
        root.registerSiteEnvironment({
            id: this.node.id,
            path: this.props.path,
            stack: cdk.Stack.of(this).node.id,
            environmentOutputs,
        });
    }
}
exports.StaticSite = StaticSite;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RhdGljU2l0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9TdGF0aWNTaXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxrREFBMEI7QUFDMUIsMkNBQTZCO0FBQzdCLDZDQUErQjtBQUMvQiwrQ0FBaUM7QUFDakMsaURBQXlDO0FBRXpDLG1EQUFxQztBQUNyQyxvREFBc0M7QUFDdEMsaUVBQW1EO0FBQ25ELHFFQUF1RDtBQUN2RCxzREFBd0M7QUFDeEMsNERBQThDO0FBQzlDLDhEQUFnRDtBQUNoRCwrRUFBaUU7QUFDakUsNkVBQStEO0FBQy9ELG9FQUFzRDtBQUN0RCwyRUFBNkQ7QUFDN0Qsc0VBQTJEO0FBRzNELHlDQVFvQjtBQUNwQixtQ0FBZ0M7QUFDaEMsMkNBQTJEO0FBRTNELElBQVksc0JBRVg7QUFGRCxXQUFZLHNCQUFzQjtJQUNoQywyRUFBaUQsQ0FBQTtBQUNuRCxDQUFDLEVBRlcsc0JBQXNCLEdBQXRCLDhCQUFzQixLQUF0Qiw4QkFBc0IsUUFFakM7QUEyQkQsTUFBYSxVQUFXLFNBQVEscUJBQVM7SUFXdkMsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUNsRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLGdEQUFnRDtRQUNoRCxJQUFJLENBQUMsYUFBYTtZQUNoQixDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDO1FBQzlELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDL0IsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNyQyxDQUFDLENBQUMsNkRBQTZEO2dCQUM3RCwrREFBK0Q7Z0JBQy9E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aW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSBcIkBhd3MtY2RrL2NvcmVcIjtcbmltcG9ydCAqIGFzIHMzIGZyb20gXCJAYXdzLWNkay9hd3MtczNcIjtcbmltcG9ydCAqIGFzIHMzQXNzZXRzIGZyb20gXCJAYXdzLWNkay9hd3MtczMtYXNzZXRzXCI7XG5pbXBvcnQgKiBhcyBhY20gZnJvbSBcIkBhd3MtY2RrL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXJcIjtcbmltcG9ydCAqIGFzIGlhbSBmcm9tIFwiQGF3cy1jZGsvYXdzLWlhbVwiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJAYXdzLWNkay9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyByb3V0ZTUzIGZyb20gXCJAYXdzLWNkay9hd3Mtcm91dGU1M1wiO1xuaW1wb3J0ICogYXMgcm91dGU1M1BhdHRlcm5zIGZyb20gXCJAYXdzLWNkay9hd3Mtcm91dGU1My1wYXR0ZXJuc1wiO1xuaW1wb3J0ICogYXMgcm91dGU1M1RhcmdldHMgZnJvbSBcIkBhd3MtY2RrL2F3cy1yb3V0ZTUzLXRhcmdldHNcIjtcbmltcG9ydCAqIGFzIGNsb3VkZnJvbnQgZnJvbSBcIkBhd3MtY2RrL2F3cy1jbG91ZGZyb250XCI7XG5pbXBvcnQgKiBhcyBjZk9yaWdpbnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1jbG91ZGZyb250LW9yaWdpbnNcIjtcbmltcG9ydCB7IEF3c0NsaUxheWVyIH0gZnJvbSBcIkBhd3MtY2RrL2xhbWJkYS1sYXllci1hd3NjbGlcIjtcblxuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQge1xuICBCYXNlU2l0ZURvbWFpblByb3BzLFxuICBCYXNlU2l0ZVJlcGxhY2VQcm9wcyxcbiAgQmFzZVNpdGVDZGtEaXN0cmlidXRpb25Qcm9wcyxcbiAgQmFzZVNpdGVFbnZpcm9ubWVudE91dHB1dHNJbmZvLFxuICBnZXRCdWlsZENtZEVudmlyb25tZW50LFxuICBidWlsZEVycm9yUmVzcG9uc2VzRm9yNDA0RXJyb3JQYWdlLFxuICBidWlsZEVycm9yUmVzcG9uc2VzRm9yUmVkaXJlY3RUb0luZGV4LFxufSBmcm9tIFwiLi9CYXNlU2l0ZVwiO1xuaW1wb3J0IHsgU3RhY2sgfSBmcm9tIFwiLi9TdGFja1wiO1xuaW1wb3J0IHsgQ29uc3RydWN0LCBJU3N0Q29uc3RydWN0SW5mbyB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuXG5leHBvcnQgZW51bSBTdGF0aWNTaXRlRXJyb3JPcHRpb25zIHtcbiAgUkVESVJFQ1RfVE9fSU5ERVhfUEFHRSA9IFwiUkVESVJFQ1RfVE9fSU5ERVhfUEFHRVwiLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN0YXRpY1NpdGVQcm9wcyB7XG4gIHJlYWRvbmx5IHBhdGg6IHN0cmluZztcbiAgcmVhZG9ubHkgaW5kZXhQYWdlPzogc3RyaW5nO1xuICByZWFkb25seSBlcnJvclBhZ2U/OiBzdHJpbmcgfCBTdGF0aWNTaXRlRXJyb3JPcHRpb25zO1xuICByZWFkb25seSBidWlsZENvbW1hbmQ/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGJ1aWxkT3V0cHV0Pzogc3RyaW5nO1xuICByZWFkb25seSBmaWxlT3B0aW9ucz86IFN0YXRpY1NpdGVGaWxlT3B0aW9uW107XG4gIHJlYWRvbmx5IHJlcGxhY2VWYWx1ZXM/OiBTdGF0aWNTaXRlUmVwbGFjZVByb3BzW107XG4gIHJlYWRvbmx5IGN1c3RvbURvbWFpbj86IHN0cmluZyB8IFN0YXRpY1NpdGVEb21haW5Qcm9wcztcbiAgcmVhZG9ubHkgczNCdWNrZXQ/OiBzMy5CdWNrZXRQcm9wcztcbiAgcmVhZG9ubHkgY2ZEaXN0cmlidXRpb24/OiBTdGF0aWNTaXRlQ2RrRGlzdHJpYnV0aW9uUHJvcHM7XG4gIHJlYWRvbmx5IGVudmlyb25tZW50PzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcbiAgcmVhZG9ubHkgZGlzYWJsZVBsYWNlaG9sZGVyPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTdGF0aWNTaXRlRmlsZU9wdGlvbiB7XG4gIHJlYWRvbmx5IGV4Y2x1ZGU6IHN0cmluZyB8IHN0cmluZ1tdO1xuICByZWFkb25seSBpbmNsdWRlOiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgcmVhZG9ubHkgY2FjaGVDb250cm9sOiBzdHJpbmc7XG59XG5cbmV4cG9ydCB0eXBlIFN0YXRpY1NpdGVEb21haW5Qcm9wcyA9IEJhc2VTaXRlRG9tYWluUHJvcHM7XG5leHBvcnQgdHlwZSBTdGF0aWNTaXRlUmVwbGFjZVByb3BzID0gQmFzZVNpdGVSZXBsYWNlUHJvcHM7XG5leHBvcnQgdHlwZSBTdGF0aWNTaXRlQ2RrRGlzdHJpYnV0aW9uUHJvcHMgPSBCYXNlU2l0ZUNka0Rpc3RyaWJ1dGlvblByb3BzO1xuXG5leHBvcnQgY2xhc3MgU3RhdGljU2l0ZSBleHRlbmRzIENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBzM0J1Y2tldDogczMuQnVja2V0O1xuICBwdWJsaWMgcmVhZG9ubHkgY2ZEaXN0cmlidXRpb246IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uO1xuICBwdWJsaWMgcmVhZG9ubHkgaG9zdGVkWm9uZT86IHJvdXRlNTMuSUhvc3RlZFpvbmU7XG4gIHB1YmxpYyByZWFkb25seSBhY21DZXJ0aWZpY2F0ZT86IGFjbS5JQ2VydGlmaWNhdGU7XG4gIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IFN0YXRpY1NpdGVQcm9wcztcbiAgcHJpdmF0ZSByZWFkb25seSBkZXBsb3lJZDogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IGlzUGxhY2Vob2xkZXI6IGJvb2xlYW47XG4gIHByaXZhdGUgcmVhZG9ubHkgYXNzZXRzOiBzM0Fzc2V0cy5Bc3NldFtdO1xuICBwcml2YXRlIHJlYWRvbmx5IGF3c0NsaUxheWVyOiBBd3NDbGlMYXllcjtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkNvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFN0YXRpY1NpdGVQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICAvLyBMb2NhbCBkZXZlbG9wbWVudCBvciBza2lwIGJ1aWxkID0+IHN0dWIgYXNzZXRcbiAgICB0aGlzLmlzUGxhY2Vob2xkZXIgPVxuICAgICAgKHJvb3QubG9jYWwgfHwgcm9vdC5za2lwQnVpbGQpICYmICFwcm9wcy5kaXNhYmxlUGxhY2Vob2xkZXI7XG4gICAgY29uc3QgYnVpbGREaXIgPSByb290LmJ1aWxkRGlyO1xuICAgIGNvbnN0IGZpbGVTaXplTGltaXQgPSByb290LmlzSmVzdFRlc3QoKVxuICAgICAgPyAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10cy1jb21tZW50XG4gICAgICAgIC8vIEB0cy1pZ25vcmU6IFwiamVzdEZpbGVTaXplTGltaXRPdmVycmlkZVwiIG5vdCBleHBvc2VkIGluIHByb3BzXG4gICAgICAgIHByb3BzLmplc3RGaWxlU2l6ZUxpbWl0T3ZlcnJpZGUgfHwgMjAwXG4gICAgICA6IDIwMDtcblxuICAgIHRoaXMucHJvcHMgPSBwcm9wcztcbiAgICB0aGlzLmF3c0NsaUxheWVyID0gbmV3IEF3c0NsaUxheWVyKHRoaXMsIFwiQXdzQ2xpTGF5ZXJcIik7XG4gICAgdGhpcy5yZWdpc3RlclNpdGVFbnZpcm9ubWVudCgpO1xuXG4gICAgLy8gVmFsaWRhdGUgaW5wdXRcbiAgICB0aGlzLnZhbGlkYXRlQ3VzdG9tRG9tYWluU2V0dGluZ3MoKTtcblxuICAgIC8vIEJ1aWxkIGFwcFxuICAgIHRoaXMuYXNzZXRzID0gdGhpcy5idWlsZEFwcChmaWxlU2l6ZUxpbWl0LCBidWlsZERpcik7XG4gICAgY29uc3QgYXNzZXRzSGFzaCA9IGNyeXB0b1xuICAgICAgLmNyZWF0ZUhhc2goXCJtZDVcIilcbiAgICAgIC51cGRhdGUodGhpcy5hc3NldHMubWFwKCh7IGFzc2V0SGFzaCB9KSA9PiBhc3NldEhhc2gpLmpvaW4oXCJcIikpXG4gICAgICAuZGlnZXN0KFwiaGV4XCIpO1xuICAgIHRoaXMuZGVwbG95SWQgPSB0aGlzLmlzUGxhY2Vob2xkZXIgPyBgZGVwbG95LWxpdmVgIDogYGRlcGxveS0ke2Fzc2V0c0hhc2h9YDtcblxuICAgIC8vIENyZWF0ZSBCdWNrZXRcbiAgICB0aGlzLnMzQnVja2V0ID0gdGhpcy5jcmVhdGVTM0J1Y2tldCgpO1xuXG4gICAgLy8gQ3JlYXRlIEN1c3RvbSBEb21haW5cbiAgICB0aGlzLmhvc3RlZFpvbmUgPSB0aGlzLmxvb2t1cEhvc3RlZFpvbmUoKTtcbiAgICB0aGlzLmFjbUNlcnRpZmljYXRlID0gdGhpcy5jcmVhdGVDZXJ0aWZpY2F0ZSgpO1xuXG4gICAgLy8gQ3JlYXRlIFMzIERlcGxveW1lbnRcbiAgICBjb25zdCBzM2RlcGxveUNSID0gdGhpcy5jcmVhdGVTM0RlcGxveW1lbnQoKTtcblxuICAgIC8vIENyZWF0ZSBDbG91ZEZyb250XG4gICAgdGhpcy5jZkRpc3RyaWJ1dGlvbiA9IHRoaXMuY3JlYXRlQ2ZEaXN0cmlidXRpb24oKTtcbiAgICB0aGlzLmNmRGlzdHJpYnV0aW9uLm5vZGUuYWRkRGVwZW5kZW5jeShzM2RlcGxveUNSKTtcblxuICAgIC8vIEludmFsaWRhdGUgQ2xvdWRGcm9udFxuICAgIGNvbnN0IGludmFsaWRhdGlvbkNSID0gdGhpcy5jcmVhdGVDbG91ZEZyb250SW52YWxpZGF0aW9uKCk7XG4gICAgaW52YWxpZGF0aW9uQ1Iubm9kZS5hZGREZXBlbmRlbmN5KHRoaXMuY2ZEaXN0cmlidXRpb24pO1xuXG4gICAgLy8gQ29ubmVjdCBDdXN0b20gRG9tYWluIHRvIENsb3VkRnJvbnQgRGlzdHJpYnV0aW9uXG4gICAgdGhpcy5jcmVhdGVSb3V0ZTUzUmVjb3JkcygpO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIFJlZ2lzdGVyIENvbnN0cnVjdFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICByb290LnJlZ2lzdGVyQ29uc3RydWN0KHRoaXMpO1xuICB9XG5cbiAgcHVibGljIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYGh0dHBzOi8vJHt0aGlzLmNmRGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbkRvbWFpbk5hbWV9YDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY3VzdG9tRG9tYWluVXJsKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgeyBjdXN0b21Eb21haW4gfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIGBodHRwczovLyR7Y3VzdG9tRG9tYWlufWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBgaHR0cHM6Ly8ke2N1c3RvbURvbWFpbi5kb21haW5OYW1lfWA7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCBidWNrZXRBcm4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zM0J1Y2tldC5idWNrZXRBcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0IGJ1Y2tldE5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zM0J1Y2tldC5idWNrZXROYW1lO1xuICB9XG5cbiAgcHVibGljIGdldCBkaXN0cmlidXRpb25JZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNmRGlzdHJpYnV0aW9uLmRpc3RyaWJ1dGlvbklkO1xuICB9XG5cbiAgcHVibGljIGdldCBkaXN0cmlidXRpb25Eb21haW4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jZkRpc3RyaWJ1dGlvbi5kaXN0cmlidXRpb25Eb21haW5OYW1lO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdEluZm8oKTogSVNzdENvbnN0cnVjdEluZm8ge1xuICAgIGNvbnN0IGNmbiA9IHRoaXMuY2ZEaXN0cmlidXRpb24ubm9kZVxuICAgICAgLmRlZmF1bHRDaGlsZCBhcyBjbG91ZGZyb250LkNmbkRpc3RyaWJ1dGlvbjtcbiAgICByZXR1cm4ge1xuICAgICAgZGlzdHJpYnV0aW9uTG9naWNhbElkOiBTdGFjay5vZih0aGlzKS5nZXRMb2dpY2FsSWQoY2ZuKSxcbiAgICAgIGN1c3RvbURvbWFpblVybDogdGhpcy5jdXN0b21Eb21haW5VcmwsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRBcHAoZmlsZVNpemVMaW1pdDogbnVtYmVyLCBidWlsZERpcjogc3RyaW5nKTogczNBc3NldHMuQXNzZXRbXSB7XG4gICAgaWYgKHRoaXMuaXNQbGFjZWhvbGRlcikge1xuICAgICAgcmV0dXJuIFtcbiAgICAgICAgbmV3IHMzQXNzZXRzLkFzc2V0KHRoaXMsIFwiQXNzZXRcIiwge1xuICAgICAgICAgIHBhdGg6IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIFwiLi4vYXNzZXRzL1N0YXRpY1NpdGUvc3R1YlwiKSxcbiAgICAgICAgfSksXG4gICAgICBdO1xuICAgIH1cblxuICAgIGNvbnN0IHsgcGF0aDogc2l0ZVBhdGgsIGJ1aWxkQ29tbWFuZCB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBidWlsZE91dHB1dCA9IHRoaXMucHJvcHMuYnVpbGRPdXRwdXQgfHwgXCIuXCI7XG5cbiAgICAvLyB2YWxpZGF0ZSBzaXRlIHBhdGggZXhpc3RzXG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKHNpdGVQYXRoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgTm8gcGF0aCBmb3VuZCBhdCBcIiR7cGF0aC5yZXNvbHZlKHNpdGVQYXRoKX1cIiBmb3IgdGhlIFwiJHtcbiAgICAgICAgICB0aGlzLm5vZGUuaWRcbiAgICAgICAgfVwiIFN0YXRpY1NpdGUuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBCdWlsZCBhbmQgcGFja2FnZSB1c2VyJ3Mgd2Vic2l0ZVxuXG4gICAgLy8gYnVpbGRcbiAgICBpZiAoYnVpbGRDb21tYW5kKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ncmV5KGBCdWlsZGluZyBzdGF0aWMgc2l0ZSAke3NpdGVQYXRofWApKTtcbiAgICAgICAgZXhlY1N5bmMoYnVpbGRDb21tYW5kLCB7XG4gICAgICAgICAgY3dkOiBzaXRlUGF0aCxcbiAgICAgICAgICBzdGRpbzogXCJpbmhlcml0XCIsXG4gICAgICAgICAgZW52OiB7XG4gICAgICAgICAgICAuLi5wcm9jZXNzLmVudixcbiAgICAgICAgICAgIC4uLmdldEJ1aWxkQ21kRW52aXJvbm1lbnQodGhpcy5wcm9wcy5lbnZpcm9ubWVudCksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGhlcmUgd2FzIGEgcHJvYmxlbSBidWlsZGluZyB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBTdGF0aWNTaXRlLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB2YWxpZGF0ZSBidWlsZE91dHB1dCBleGlzdHNcbiAgICBjb25zdCBzaXRlT3V0cHV0UGF0aCA9IHBhdGgucmVzb2x2ZShwYXRoLmpvaW4oc2l0ZVBhdGgsIGJ1aWxkT3V0cHV0KSk7XG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKHNpdGVPdXRwdXRQYXRoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgTm8gYnVpbGQgb3V0cHV0IGZvdW5kIGF0IFwiJHtzaXRlT3V0cHV0UGF0aH1cIiBmb3IgdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgU3RhdGljU2l0ZS5gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIGNyZWF0ZSB6aXAgZmlsZXNcbiAgICBjb25zdCBzY3JpcHQgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2Fzc2V0cy9CYXNlU2l0ZS9hcmNoaXZlci5qc1wiKTtcbiAgICBjb25zdCB6aXBQYXRoID0gcGF0aC5yZXNvbHZlKFxuICAgICAgcGF0aC5qb2luKGJ1aWxkRGlyLCBgU3RhdGljU2l0ZS0ke3RoaXMubm9kZS5pZH0tJHt0aGlzLm5vZGUuYWRkcn1gKVxuICAgICk7XG4gICAgLy8gY2xlYXIgemlwIHBhdGggdG8gZW5zdXJlIG5vIHBhcnRYLnppcCByZW1haW4gZnJvbSBwcmV2aW91cyBidWlsZFxuICAgIGZzLnJlbW92ZVN5bmMoemlwUGF0aCk7XG4gICAgY29uc3QgY21kID0gW1wibm9kZVwiLCBzY3JpcHQsIHNpdGVPdXRwdXRQYXRoLCB6aXBQYXRoLCBmaWxlU2l6ZUxpbWl0XS5qb2luKFxuICAgICAgXCIgXCJcbiAgICApO1xuXG4gICAgdHJ5IHtcbiAgICAgIGV4ZWNTeW5jKGNtZCwge1xuICAgICAgICBjd2Q6IHNpdGVQYXRoLFxuICAgICAgICBzdGRpbzogXCJpbmhlcml0XCIsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGVyZSB3YXMgYSBwcm9ibGVtIGdlbmVyYXRpbmcgdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgU3RhdGljU2l0ZSBwYWNrYWdlLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gY3JlYXRlIGFzc2V0c1xuICAgIGNvbnN0IGFzc2V0cyA9IFtdO1xuICAgIGZvciAobGV0IHBhcnRJZCA9IDA7IDsgcGFydElkKyspIHtcbiAgICAgIGNvbnN0IHppcEZpbGVQYXRoID0gcGF0aC5qb2luKHppcFBhdGgsIGBwYXJ0JHtwYXJ0SWR9LnppcGApO1xuICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHppcEZpbGVQYXRoKSkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgYXNzZXRzLnB1c2goXG4gICAgICAgIG5ldyBzM0Fzc2V0cy5Bc3NldCh0aGlzLCBgQXNzZXQke3BhcnRJZH1gLCB7XG4gICAgICAgICAgcGF0aDogemlwRmlsZVBhdGgsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gYXNzZXRzO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVTM0J1Y2tldCgpOiBzMy5CdWNrZXQge1xuICAgIGxldCB7IHMzQnVja2V0IH0gPSB0aGlzLnByb3BzO1xuICAgIHMzQnVja2V0ID0gczNCdWNrZXQgfHwge307XG5cbiAgICAvLyBWYWxpZGF0ZSBzM0J1Y2tldFxuICAgIGlmIChzM0J1Y2tldC53ZWJzaXRlSW5kZXhEb2N1bWVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRG8gbm90IGNvbmZpZ3VyZSB0aGUgXCJzM0J1Y2tldC53ZWJzaXRlSW5kZXhEb2N1bWVudFwiLiBVc2UgdGhlIFwiaW5kZXhQYWdlXCIgdG8gY29uZmlndXJlIHRoZSBTdGF0aWNTaXRlIGluZGV4IHBhZ2UuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoczNCdWNrZXQud2Vic2l0ZUVycm9yRG9jdW1lbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYERvIG5vdCBjb25maWd1cmUgdGhlIFwiczNCdWNrZXQud2Vic2l0ZUVycm9yRG9jdW1lbnRcIi4gVXNlIHRoZSBcImVycm9yUGFnZVwiIHRvIGNvbmZpZ3VyZSB0aGUgU3RhdGljU2l0ZSBpbmRleCBwYWdlLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBzMy5CdWNrZXQodGhpcywgXCJCdWNrZXRcIiwge1xuICAgICAgYXV0b0RlbGV0ZU9iamVjdHM6IHRydWUsXG4gICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgLi4uczNCdWNrZXQsXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVMzRGVwbG95bWVudCgpOiBjZGsuQ3VzdG9tUmVzb3VyY2Uge1xuICAgIGNvbnN0IHsgZmlsZU9wdGlvbnMgfSA9IHRoaXMucHJvcHM7XG5cbiAgICAvLyBDcmVhdGUgYSBMYW1iZGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGRvaW5nIHRoZSB1cGxvYWRpbmdcbiAgICBjb25zdCB1cGxvYWRlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJTM1VwbG9hZGVyXCIsIHtcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChcbiAgICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvQmFzZVNpdGUvY3VzdG9tLXJlc291cmNlXCIpXG4gICAgICApLFxuICAgICAgbGF5ZXJzOiBbdGhpcy5hd3NDbGlMYXllcl0sXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5QWVRIT05fM183LFxuICAgICAgaGFuZGxlcjogXCJzMy11cGxvYWQuaGFuZGxlclwiLFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoMTUpLFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICB9KTtcbiAgICB0aGlzLnMzQnVja2V0LmdyYW50UmVhZFdyaXRlKHVwbG9hZGVyKTtcbiAgICB0aGlzLmFzc2V0cy5mb3JFYWNoKChhc3NldCkgPT4gYXNzZXQuZ3JhbnRSZWFkKHVwbG9hZGVyKSk7XG5cbiAgICAvLyBDcmVhdGUgdGhlIGN1c3RvbSByZXNvdXJjZSBmdW5jdGlvblxuICAgIGNvbnN0IGhhbmRsZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiUzNIYW5kbGVyXCIsIHtcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChcbiAgICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvQmFzZVNpdGUvY3VzdG9tLXJlc291cmNlXCIpXG4gICAgICApLFxuICAgICAgbGF5ZXJzOiBbdGhpcy5hd3NDbGlMYXllcl0sXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5QWVRIT05fM183LFxuICAgICAgaGFuZGxlcjogXCJzMy1oYW5kbGVyLmhhbmRsZXJcIixcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBVUExPQURFUl9GVU5DVElPTl9OQU1FOiB1cGxvYWRlci5mdW5jdGlvbk5hbWUsXG4gICAgICB9LFxuICAgIH0pO1xuICAgIHRoaXMuczNCdWNrZXQuZ3JhbnRSZWFkV3JpdGUoaGFuZGxlcik7XG4gICAgdXBsb2FkZXIuZ3JhbnRJbnZva2UoaGFuZGxlcik7XG5cbiAgICAvLyBDcmVhdGUgY3VzdG9tIHJlc291cmNlXG4gICAgcmV0dXJuIG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2UodGhpcywgXCJTM0RlcGxveW1lbnRcIiwge1xuICAgICAgc2VydmljZVRva2VuOiBoYW5kbGVyLmZ1bmN0aW9uQXJuLFxuICAgICAgcmVzb3VyY2VUeXBlOiBcIkN1c3RvbTo6U1NUQnVja2V0RGVwbG95bWVudFwiLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBTb3VyY2VzOiB0aGlzLmFzc2V0cy5tYXAoKGFzc2V0KSA9PiAoe1xuICAgICAgICAgIEJ1Y2tldE5hbWU6IGFzc2V0LnMzQnVja2V0TmFtZSxcbiAgICAgICAgICBPYmplY3RLZXk6IGFzc2V0LnMzT2JqZWN0S2V5LFxuICAgICAgICB9KSksXG4gICAgICAgIERlc3RpbmF0aW9uQnVja2V0TmFtZTogdGhpcy5zM0J1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICBEZXN0aW5hdGlvbkJ1Y2tldEtleVByZWZpeDogdGhpcy5kZXBsb3lJZCxcbiAgICAgICAgRmlsZU9wdGlvbnM6IChmaWxlT3B0aW9ucyB8fCBbXSkubWFwKFxuICAgICAgICAgICh7IGV4Y2x1ZGUsIGluY2x1ZGUsIGNhY2hlQ29udHJvbCB9KSA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGV4Y2x1ZGUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgICAgZXhjbHVkZSA9IFtleGNsdWRlXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5jbHVkZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgICBpbmNsdWRlID0gW2luY2x1ZGVdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IFtdO1xuICAgICAgICAgICAgZXhjbHVkZS5mb3JFYWNoKChwZXIpID0+IG9wdGlvbnMucHVzaChcIi0tZXhjbHVkZVwiLCBwZXIpKTtcbiAgICAgICAgICAgIGluY2x1ZGUuZm9yRWFjaCgocGVyKSA9PiBvcHRpb25zLnB1c2goXCItLWluY2x1ZGVcIiwgcGVyKSk7XG4gICAgICAgICAgICBvcHRpb25zLnB1c2goXCItLWNhY2hlLWNvbnRyb2xcIiwgY2FjaGVDb250cm9sKTtcbiAgICAgICAgICAgIHJldHVybiBvcHRpb25zO1xuICAgICAgICAgIH1cbiAgICAgICAgKSxcbiAgICAgICAgUmVwbGFjZVZhbHVlczogdGhpcy5nZXRTM0NvbnRlbnRSZXBsYWNlVmFsdWVzKCksXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIENsb3VkRnJvbnQgRGlzdHJpYnV0aW9uXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIHByaXZhdGUgY3JlYXRlQ2ZEaXN0cmlidXRpb24oKTogY2xvdWRmcm9udC5EaXN0cmlidXRpb24ge1xuICAgIGNvbnN0IHsgY2ZEaXN0cmlidXRpb24sIGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBpbmRleFBhZ2UgPSB0aGlzLnByb3BzLmluZGV4UGFnZSB8fCBcImluZGV4Lmh0bWxcIjtcbiAgICBjb25zdCBlcnJvclBhZ2UgPSB0aGlzLnByb3BzLmVycm9yUGFnZTtcblxuICAgIGNvbnN0IGNmRGlzdHJpYnV0aW9uUHJvcHMgPSBjZkRpc3RyaWJ1dGlvbiB8fCB7fTtcblxuICAgIC8vIFZhbGlkYXRlIGlucHV0XG4gICAgaWYgKGNmRGlzdHJpYnV0aW9uUHJvcHMuY2VydGlmaWNhdGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYERvIG5vdCBjb25maWd1cmUgdGhlIFwiY2ZEaXN0cmlidXRpb24uY2VydGlmaWNhdGVcIi4gVXNlIHRoZSBcImN1c3RvbURvbWFpblwiIHRvIGNvbmZpZ3VyZSB0aGUgU3RhdGljU2l0ZSBkb21haW4gY2VydGlmaWNhdGUuYFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKGNmRGlzdHJpYnV0aW9uUHJvcHMuZG9tYWluTmFtZXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYERvIG5vdCBjb25maWd1cmUgdGhlIFwiY2ZEaXN0cmlidXRpb24uZG9tYWluTmFtZXNcIi4gVXNlIHRoZSBcImN1c3RvbURvbWFpblwiIHRvIGNvbmZpZ3VyZSB0aGUgU3RhdGljU2l0ZSBkb21haW4uYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBCdWlsZCBkb21haW5OYW1lc1xuICAgIGNvbnN0IGRvbWFpbk5hbWVzID0gW107XG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIC8vIG5vIGRvbWFpblxuICAgIH0gZWxzZSBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgZG9tYWluTmFtZXMucHVzaChjdXN0b21Eb21haW4pO1xuICAgIH0gZWxzZSB7XG4gICAgICBkb21haW5OYW1lcy5wdXNoKGN1c3RvbURvbWFpbi5kb21haW5OYW1lKTtcbiAgICAgIGlmIChjdXN0b21Eb21haW4uYWx0ZXJuYXRlTmFtZXMpIHtcbiAgICAgICAgaWYgKCFjdXN0b21Eb21haW4uY2VydGlmaWNhdGUpXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgXCJDZXJ0aWZpY2F0ZXMgZm9yIGFsdGVybmF0ZSBkb21haW5zIGNhbm5vdCBiZSBhdXRvbWF0aWNhbGx5IGNyZWF0ZWQuIFBsZWFzZSBzcGVjaWZ5IGNlcnRpZmljYXRlIHRvIHVzZVwiXG4gICAgICAgICAgKTtcbiAgICAgICAgZG9tYWluTmFtZXMucHVzaCguLi5jdXN0b21Eb21haW4uYWx0ZXJuYXRlTmFtZXMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEJ1aWxkIGVycm9yUmVzcG9uc2VzXG4gICAgbGV0IGVycm9yUmVzcG9uc2VzO1xuICAgIC8vIGNhc2U6IHNzdCBzdGFydCA9PiBzaG93aW5nIHN0dWIgc2l0ZSwgYW5kIHJlZGlyZWN0IGFsbCByb3V0ZXMgdG8gdGhlIGluZGV4IHBhZ2VcbiAgICBpZiAodGhpcy5pc1BsYWNlaG9sZGVyKSB7XG4gICAgICBlcnJvclJlc3BvbnNlcyA9IGJ1aWxkRXJyb3JSZXNwb25zZXNGb3JSZWRpcmVjdFRvSW5kZXgoaW5kZXhQYWdlKTtcbiAgICB9IGVsc2UgaWYgKGVycm9yUGFnZSkge1xuICAgICAgaWYgKGNmRGlzdHJpYnV0aW9uUHJvcHMuZXJyb3JSZXNwb25zZXMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImNmRGlzdHJpYnV0aW9uLmVycm9yUmVzcG9uc2VzXCIgd2hlbiBcImVycm9yUGFnZVwiIGlzIHBhc3NlZCBpbi4gVXNlIG9uZSBvciB0aGUgb3RoZXIgdG8gY29uZmlndXJlIHRoZSBiZWhhdmlvciBmb3IgZXJyb3IgcGFnZXMuYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBlcnJvclJlc3BvbnNlcyA9XG4gICAgICAgIGVycm9yUGFnZSA9PT0gU3RhdGljU2l0ZUVycm9yT3B0aW9ucy5SRURJUkVDVF9UT19JTkRFWF9QQUdFXG4gICAgICAgICAgPyBidWlsZEVycm9yUmVzcG9uc2VzRm9yUmVkaXJlY3RUb0luZGV4KGluZGV4UGFnZSlcbiAgICAgICAgICA6IGJ1aWxkRXJyb3JSZXNwb25zZXNGb3I0MDRFcnJvclBhZ2UoZXJyb3JQYWdlKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgQ2xvdWRGcm9udCBkaXN0cmlidXRpb25cbiAgICByZXR1cm4gbmV3IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uKHRoaXMsIFwiRGlzdHJpYnV0aW9uXCIsIHtcbiAgICAgIC8vIHRoZXNlIHZhbHVlcyBjYW4gYmUgb3ZlcndyaXR0ZW4gYnkgY2ZEaXN0cmlidXRpb25Qcm9wc1xuICAgICAgZGVmYXVsdFJvb3RPYmplY3Q6IGluZGV4UGFnZSxcbiAgICAgIGVycm9yUmVzcG9uc2VzLFxuICAgICAgLi4uY2ZEaXN0cmlidXRpb25Qcm9wcyxcbiAgICAgIC8vIHRoZXNlIHZhbHVlcyBjYW4gTk9UIGJlIG92ZXJ3cml0dGVuIGJ5IGNmRGlzdHJpYnV0aW9uUHJvcHNcbiAgICAgIGRvbWFpbk5hbWVzLFxuICAgICAgY2VydGlmaWNhdGU6IHRoaXMuYWNtQ2VydGlmaWNhdGUsXG4gICAgICBkZWZhdWx0QmVoYXZpb3I6IHtcbiAgICAgICAgb3JpZ2luOiBuZXcgY2ZPcmlnaW5zLlMzT3JpZ2luKHRoaXMuczNCdWNrZXQsIHtcbiAgICAgICAgICBvcmlnaW5QYXRoOiB0aGlzLmRlcGxveUlkLFxuICAgICAgICB9KSxcbiAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3k6IGNsb3VkZnJvbnQuVmlld2VyUHJvdG9jb2xQb2xpY3kuUkVESVJFQ1RfVE9fSFRUUFMsXG4gICAgICAgIC4uLihjZkRpc3RyaWJ1dGlvblByb3BzLmRlZmF1bHRCZWhhdmlvciB8fCB7fSksXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDbG91ZEZyb250SW52YWxpZGF0aW9uKCk6IGNkay5DdXN0b21SZXNvdXJjZSB7XG4gICAgLy8gQ3JlYXRlIGEgTGFtYmRhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBkb2luZyB0aGUgaW52YWxpZGF0aW9uXG4gICAgY29uc3QgaW52YWxpZGF0b3IgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiQ2xvdWRGcm9udEludmFsaWRhdG9yXCIsIHtcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChcbiAgICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9hc3NldHMvQmFzZVNpdGUvY3VzdG9tLXJlc291cmNlXCIpXG4gICAgICApLFxuICAgICAgbGF5ZXJzOiBbdGhpcy5hd3NDbGlMYXllcl0sXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5QWVRIT05fM183LFxuICAgICAgaGFuZGxlcjogXCJjZi1pbnZhbGlkYXRlLmhhbmRsZXJcIixcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICAgIG1lbW9yeVNpemU6IDEwMjQsXG4gICAgfSk7XG5cbiAgICAvLyBHcmFudCBwZXJtaXNzaW9ucyB0byBpbnZhbGlkYXRlIENGIERpc3RyaWJ1dGlvblxuICAgIGludmFsaWRhdG9yLmFkZFRvUm9sZVBvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgXCJjbG91ZGZyb250OkdldEludmFsaWRhdGlvblwiLFxuICAgICAgICAgIFwiY2xvdWRmcm9udDpDcmVhdGVJbnZhbGlkYXRpb25cIixcbiAgICAgICAgXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgLy8gQ3JlYXRlIGN1c3RvbSByZXNvdXJjZVxuICAgIHJldHVybiBuZXcgY2RrLkN1c3RvbVJlc291cmNlKHRoaXMsIFwiQ2xvdWRGcm9udEludmFsaWRhdGlvblwiLCB7XG4gICAgICBzZXJ2aWNlVG9rZW46IGludmFsaWRhdG9yLmZ1bmN0aW9uQXJuLFxuICAgICAgcmVzb3VyY2VUeXBlOiBcIkN1c3RvbTo6U1NUQ2xvdWRGcm9udEludmFsaWRhdGlvblwiLFxuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAvLyBuZWVkIHRoZSBEZXBsb3lJZCBmaWVsZCBzbyB0aGlzIENSIGdldHMgdXBkYXRlZCBvbiBlYWNoIGRlcGxveVxuICAgICAgICBEZXBsb3lJZDogdGhpcy5kZXBsb3lJZCxcbiAgICAgICAgRGlzdHJpYnV0aW9uSWQ6IHRoaXMuY2ZEaXN0cmlidXRpb24uZGlzdHJpYnV0aW9uSWQsXG4gICAgICAgIERpc3RyaWJ1dGlvblBhdGhzOiBbXCIvKlwiXSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy8gQ3VzdG9tIERvbWFpblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICBwcm90ZWN0ZWQgdmFsaWRhdGVDdXN0b21Eb21haW5TZXR0aW5ncygpIHtcbiAgICBjb25zdCB7IGN1c3RvbURvbWFpbiB9ID0gdGhpcy5wcm9wcztcblxuICAgIGlmICghY3VzdG9tRG9tYWluKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoY3VzdG9tRG9tYWluLmlzRXh0ZXJuYWxEb21haW4gPT09IHRydWUpIHtcbiAgICAgIGlmICghY3VzdG9tRG9tYWluLmNlcnRpZmljYXRlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQSB2YWxpZCBjZXJ0aWZpY2F0ZSBpcyByZXF1aXJlZCB3aGVuIFwiaXNFeHRlcm5hbERvbWFpblwiIGlzIHNldCB0byBcInRydWVcIi5gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoY3VzdG9tRG9tYWluLmRvbWFpbkFsaWFzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgRG9tYWluIGFsaWFzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBkb21haW5zIGhvc3RlZCBvbiBBbWF6b24gUm91dGUgNTMuIERvIG5vdCBzZXQgdGhlIFwiY3VzdG9tRG9tYWluLmRvbWFpbkFsaWFzXCIgd2hlbiBcImlzRXh0ZXJuYWxEb21haW5cIiBpcyBlbmFibGVkLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChjdXN0b21Eb21haW4uaG9zdGVkWm9uZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEhvc3RlZCB6b25lcyBjYW4gb25seSBiZSBjb25maWd1cmVkIGZvciBkb21haW5zIGhvc3RlZCBvbiBBbWF6b24gUm91dGUgNTMuIERvIG5vdCBzZXQgdGhlIFwiY3VzdG9tRG9tYWluLmhvc3RlZFpvbmVcIiB3aGVuIFwiaXNFeHRlcm5hbERvbWFpblwiIGlzIGVuYWJsZWQuYFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBsb29rdXBIb3N0ZWRab25lKCk6IHJvdXRlNTMuSUhvc3RlZFpvbmUgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHsgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgLy8gU2tpcCBpZiBjdXN0b21Eb21haW4gaXMgbm90IGNvbmZpZ3VyZWRcbiAgICBpZiAoIWN1c3RvbURvbWFpbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBob3N0ZWRab25lO1xuXG4gICAgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGhvc3RlZFpvbmUgPSByb3V0ZTUzLkhvc3RlZFpvbmUuZnJvbUxvb2t1cCh0aGlzLCBcIkhvc3RlZFpvbmVcIiwge1xuICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4sXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKGNkay5Db25zdHJ1Y3QuaXNDb25zdHJ1Y3QoY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUpKSB7XG4gICAgICBob3N0ZWRab25lID0gY3VzdG9tRG9tYWluLmhvc3RlZFpvbmUgYXMgcm91dGU1My5JSG9zdGVkWm9uZTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4uaG9zdGVkWm9uZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgaG9zdGVkWm9uZSA9IHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tTG9va3VwKHRoaXMsIFwiSG9zdGVkWm9uZVwiLCB7XG4gICAgICAgIGRvbWFpbk5hbWU6IGN1c3RvbURvbWFpbi5ob3N0ZWRab25lLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIC8vIFNraXAgaWYgZG9tYWluIGlzIG5vdCBhIFJvdXRlNTMgZG9tYWluXG4gICAgICBpZiAoY3VzdG9tRG9tYWluLmlzRXh0ZXJuYWxEb21haW4gPT09IHRydWUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBob3N0ZWRab25lID0gcm91dGU1My5Ib3N0ZWRab25lLmZyb21Mb29rdXAodGhpcywgXCJIb3N0ZWRab25lXCIsIHtcbiAgICAgICAgZG9tYWluTmFtZTogY3VzdG9tRG9tYWluLmRvbWFpbk5hbWUsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgaG9zdGVkWm9uZSA9IGN1c3RvbURvbWFpbi5ob3N0ZWRab25lIGFzIHJvdXRlNTMuSUhvc3RlZFpvbmU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGhvc3RlZFpvbmU7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNlcnRpZmljYXRlKCk6IGFjbS5JQ2VydGlmaWNhdGUgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHsgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgaWYgKCFjdXN0b21Eb21haW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgYWNtQ2VydGlmaWNhdGU7XG5cbiAgICAvLyBIb3N0ZWRab25lIGlzIHNldCBmb3IgUm91dGUgNTMgZG9tYWluc1xuICAgIGlmICh0aGlzLmhvc3RlZFpvbmUpIHtcbiAgICAgIGlmICh0eXBlb2YgY3VzdG9tRG9tYWluID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIGFjbUNlcnRpZmljYXRlID0gbmV3IGFjbS5EbnNWYWxpZGF0ZWRDZXJ0aWZpY2F0ZSh0aGlzLCBcIkNlcnRpZmljYXRlXCIsIHtcbiAgICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4sXG4gICAgICAgICAgaG9zdGVkWm9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgICAgIHJlZ2lvbjogXCJ1cy1lYXN0LTFcIixcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2UgaWYgKGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZSkge1xuICAgICAgICBhY21DZXJ0aWZpY2F0ZSA9IGN1c3RvbURvbWFpbi5jZXJ0aWZpY2F0ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFjbUNlcnRpZmljYXRlID0gbmV3IGFjbS5EbnNWYWxpZGF0ZWRDZXJ0aWZpY2F0ZSh0aGlzLCBcIkNlcnRpZmljYXRlXCIsIHtcbiAgICAgICAgICBkb21haW5OYW1lOiBjdXN0b21Eb21haW4uZG9tYWluTmFtZSxcbiAgICAgICAgICBob3N0ZWRab25lOiB0aGlzLmhvc3RlZFpvbmUsXG4gICAgICAgICAgcmVnaW9uOiBcInVzLWVhc3QtMVwiLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gSG9zdGVkWm9uZSBpcyBOT1Qgc2V0IGZvciBub24tUm91dGUgNTMgZG9tYWluc1xuICAgIGVsc2Uge1xuICAgICAgaWYgKHR5cGVvZiBjdXN0b21Eb21haW4gIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgYWNtQ2VydGlmaWNhdGUgPSBjdXN0b21Eb21haW4uY2VydGlmaWNhdGU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGFjbUNlcnRpZmljYXRlO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNyZWF0ZVJvdXRlNTNSZWNvcmRzKCk6IHZvaWQge1xuICAgIGNvbnN0IHsgY3VzdG9tRG9tYWluIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgaWYgKCFjdXN0b21Eb21haW4gfHwgIXRoaXMuaG9zdGVkWm9uZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCByZWNvcmROYW1lO1xuICAgIGxldCBkb21haW5BbGlhcztcbiAgICBpZiAodHlwZW9mIGN1c3RvbURvbWFpbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmVjb3JkTmFtZSA9IGN1c3RvbURvbWFpbjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVjb3JkTmFtZSA9IGN1c3RvbURvbWFpbi5kb21haW5OYW1lO1xuICAgICAgZG9tYWluQWxpYXMgPSBjdXN0b21Eb21haW4uZG9tYWluQWxpYXM7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIEROUyByZWNvcmRcbiAgICBuZXcgcm91dGU1My5BUmVjb3JkKHRoaXMsIFwiQWxpYXNSZWNvcmRcIiwge1xuICAgICAgcmVjb3JkTmFtZSxcbiAgICAgIHpvbmU6IHRoaXMuaG9zdGVkWm9uZSxcbiAgICAgIHRhcmdldDogcm91dGU1My5SZWNvcmRUYXJnZXQuZnJvbUFsaWFzKFxuICAgICAgICBuZXcgcm91dGU1M1RhcmdldHMuQ2xvdWRGcm9udFRhcmdldCh0aGlzLmNmRGlzdHJpYnV0aW9uKVxuICAgICAgKSxcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBBbGlhcyByZWRpcmVjdCByZWNvcmRcbiAgICBpZiAoZG9tYWluQWxpYXMpIHtcbiAgICAgIG5ldyByb3V0ZTUzUGF0dGVybnMuSHR0cHNSZWRpcmVjdCh0aGlzLCBcIlJlZGlyZWN0XCIsIHtcbiAgICAgICAgem9uZTogdGhpcy5ob3N0ZWRab25lLFxuICAgICAgICByZWNvcmROYW1lczogW2RvbWFpbkFsaWFzXSxcbiAgICAgICAgdGFyZ2V0RG9tYWluOiByZWNvcmROYW1lLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIEhlbHBlciBGdW5jdGlvbnNcbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgcHJpdmF0ZSBnZXRTM0NvbnRlbnRSZXBsYWNlVmFsdWVzKCk6IEJhc2VTaXRlUmVwbGFjZVByb3BzW10ge1xuICAgIGNvbnN0IHJlcGxhY2VWYWx1ZXM6IEJhc2VTaXRlUmVwbGFjZVByb3BzW10gPVxuICAgICAgdGhpcy5wcm9wcy5yZXBsYWNlVmFsdWVzIHx8IFtdO1xuXG4gICAgT2JqZWN0LmVudHJpZXModGhpcy5wcm9wcy5lbnZpcm9ubWVudCB8fCB7fSlcbiAgICAgIC5maWx0ZXIoKFssIHZhbHVlXSkgPT4gY2RrLlRva2VuLmlzVW5yZXNvbHZlZCh2YWx1ZSkpXG4gICAgICAuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgIGNvbnN0IHRva2VuID0gYHt7ICR7a2V5fSB9fWA7XG4gICAgICAgIHJlcGxhY2VWYWx1ZXMucHVzaChcbiAgICAgICAgICB7XG4gICAgICAgICAgICBmaWxlczogXCJpbmRleC5odG1sXCIsXG4gICAgICAgICAgICBzZWFyY2g6IHRva2VuLFxuICAgICAgICAgICAgcmVwbGFjZTogdmFsdWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBmaWxlczogXCIqKi8qLmpzXCIsXG4gICAgICAgICAgICBzZWFyY2g6IHRva2VuLFxuICAgICAgICAgICAgcmVwbGFjZTogdmFsdWUsXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgcmV0dXJuIHJlcGxhY2VWYWx1ZXM7XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyU2l0ZUVudmlyb25tZW50KCkge1xuICAgIGNvbnN0IGVudmlyb25tZW50T3V0cHV0czogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMucHJvcHMuZW52aXJvbm1lbnQgfHwge30pKSB7XG4gICAgICBjb25zdCBvdXRwdXRJZCA9IGBTc3RTaXRlRW52XyR7a2V5fWA7XG4gICAgICBjb25zdCBvdXRwdXQgPSBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBvdXRwdXRJZCwgeyB2YWx1ZSB9KTtcbiAgICAgIGVudmlyb25tZW50T3V0cHV0c1trZXldID0gY2RrLlN0YWNrLm9mKHRoaXMpLmdldExvZ2ljYWxJZChvdXRwdXQpO1xuICAgIH1cblxuICAgIGNvbnN0IHJvb3QgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgcm9vdC5yZWdpc3RlclNpdGVFbnZpcm9ubWVudCh7XG4gICAgICBpZDogdGhpcy5ub2RlLmlkLFxuICAgICAgcGF0aDogdGhpcy5wcm9wcy5wYXRoLFxuICAgICAgc3RhY2s6IGNkay5TdGFjay5vZih0aGlzKS5ub2RlLmlkLFxuICAgICAgZW52aXJvbm1lbnRPdXRwdXRzLFxuICAgIH0gYXMgQmFzZVNpdGVFbnZpcm9ubWVudE91dHB1dHNJbmZvKTtcbiAgfVxufVxuIl19