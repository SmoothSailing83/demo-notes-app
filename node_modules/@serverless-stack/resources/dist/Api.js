"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Api = exports.ApiPayloadFormatVersion = exports.ApiAuthorizationType = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const apig = __importStar(require("@aws-cdk/aws-apigatewayv2"));
const apigIntegrations = __importStar(require("@aws-cdk/aws-apigatewayv2-integrations"));
const Stack_1 = require("./Stack");
const Function_1 = require("./Function");
const apigV2Domain = __importStar(require("./util/apiGatewayV2Domain"));
const apigV2AccessLog = __importStar(require("./util/apiGatewayV2AccessLog"));
const allowedMethods = [
    apig.HttpMethod.ANY,
    apig.HttpMethod.GET,
    apig.HttpMethod.PUT,
    apig.HttpMethod.POST,
    apig.HttpMethod.HEAD,
    apig.HttpMethod.PATCH,
    apig.HttpMethod.DELETE,
    apig.HttpMethod.OPTIONS,
];
var ApiAuthorizationType;
(function (ApiAuthorizationType) {
    ApiAuthorizationType["JWT"] = "JWT";
    ApiAuthorizationType["NONE"] = "NONE";
    ApiAuthorizationType["CUSTOM"] = "CUSTOM";
    ApiAuthorizationType["AWS_IAM"] = "AWS_IAM";
})(ApiAuthorizationType = exports.ApiAuthorizationType || (exports.ApiAuthorizationType = {}));
var ApiPayloadFormatVersion;
(function (ApiPayloadFormatVersion) {
    ApiPayloadFormatVersion["V1"] = "1.0";
    ApiPayloadFormatVersion["V2"] = "2.0";
})(ApiPayloadFormatVersion = exports.ApiPayloadFormatVersion || (exports.ApiPayloadFormatVersion = {}));
/////////////////////
// Construct
/////////////////////
class Api extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        props = props || {};
        const { httpApi, routes, cors, accessLog, customDomain, defaultFunctionProps, defaultAuthorizer, defaultAuthorizationType, defaultAuthorizationScopes, defaultPayloadFormatVersion, defaultThrottlingBurstLimit, defaultThrottlingRateLimit, } = props;
        this.routesData = {};
        this.routesInfo = {};
        this.permissionsAttachedForAllRoutes = [];
        this.defaultFunctionProps = defaultFunctionProps;
        this.defaultAuthorizer = defaultAuthorizer;
        this.defaultAuthorizationType = defaultAuthorizationType;
        this.defaultAuthorizationScopes = defaultAuthorizationScopes;
        this.defaultPayloadFormatVersion = defaultPayloadFormatVersion;
        ////////////////////
        // Create Api
        ////////////////////
        if (cdk.Construct.isConstruct(httpApi)) {
            if (cors !== undefined) {
                throw new Error(`Cannot configure the "cors" when "httpApi" is a construct`);
            }
            if (accessLog !== undefined) {
                throw new Error(`Cannot configure the "accessLog" when "httpApi" is a construct`);
            }
            if (customDomain !== undefined) {
                throw new Error(`Cannot configure the "customDomain" when "httpApi" is a construct`);
            }
            if (props.stages !== undefined) {
                throw new Error(`Cannot configure the "stages" when "httpApi" is a construct`);
            }
            this.httpApi = httpApi;
        }
        else {
            const httpApiProps = (httpApi || {});
            // Validate input
            if (httpApiProps.corsPreflight !== undefined) {
                throw new Error(`Cannot configure the "httpApi.corsPreflight" in the Api`);
            }
            if (httpApiProps.defaultDomainMapping !== undefined) {
                throw new Error(`Cannot configure the "httpApi.defaultDomainMapping" in the Api`);
            }
            // Handle CORS
            const corsPreflight = this.buildCorsConfig(cors);
            // Handle Custom Domain
            const customDomainData = apigV2Domain.buildCustomDomainData(this, customDomain);
            let defaultDomainMapping;
            if (customDomainData) {
                if (customDomainData.isApigDomainCreated) {
                    this.apiGatewayDomain =
                        customDomainData.apigDomain;
                }
                if (customDomainData.isCertificatedCreated) {
                    this.acmCertificate = customDomainData.certificate;
                }
                defaultDomainMapping = {
                    domainName: customDomainData.apigDomain,
                    mappingKey: customDomainData.mappingKey,
                };
                this._customDomainUrl = `https://${customDomainData.url}`;
            }
            this.httpApi = new apig.HttpApi(this, "Api", Object.assign({ apiName: root.logicalPrefixedName(id), corsPreflight,
                defaultDomainMapping }, httpApiProps));
            const httpStage = this.httpApi.defaultStage;
            // Configure throttling
            if (defaultThrottlingBurstLimit &&
                defaultThrottlingRateLimit &&
                httpStage.node.defaultChild) {
                const cfnStage = httpStage.node.defaultChild;
                cfnStage.defaultRouteSettings = Object.assign(Object.assign({}, (cfnStage.routeSettings || {})), { throttlingBurstLimit: defaultThrottlingBurstLimit, throttlingRateLimit: defaultThrottlingRateLimit });
                this.defaultThrottlingBurstLimit = defaultThrottlingBurstLimit;
                this.defaultThrottlingRateLimit = defaultThrottlingRateLimit;
            }
            // Configure access log
            for (const def of props.stages || []) {
                const stage = new apig.HttpStage(this, "Stage" + def.stageName, Object.assign(Object.assign({}, def), { httpApi: this.httpApi }));
                apigV2AccessLog.buildAccessLogData(this, accessLog, stage, false);
            }
            if (this.httpApi.defaultStage)
                this.accessLogGroup = apigV2AccessLog.buildAccessLogData(this, accessLog, this.httpApi.defaultStage, true);
        }
        ///////////////////////////
        // Configure routes
        ///////////////////////////
        this.addRoutes(this, routes || {});
        ///////////////////
        // Register Construct
        ///////////////////
        root.registerConstruct(this);
    }
    get url() {
        return this.httpApi.apiEndpoint;
    }
    get customDomainUrl() {
        return this._customDomainUrl;
    }
    get routes() {
        return Object.keys(this.routesData);
    }
    get httpApiArn() {
        const stack = Stack_1.Stack.of(this);
        return `arn:${stack.partition}:apigateway:${stack.region}::/apis/${this.httpApi.apiId}`;
    }
    addRoutes(scope, routes) {
        Object.keys(routes).forEach((routeKey) => {
            this.addRoute(scope, routeKey, routes[routeKey]);
        });
    }
    getFunction(routeKey) {
        const route = this.routesData[this.normalizeRouteKey(routeKey)];
        return route instanceof Function_1.Function ? route : undefined;
    }
    attachPermissions(permissions) {
        Object.values(this.routesData)
            .filter((route) => route instanceof Function_1.Function)
            .forEach((route) => route.attachPermissions(permissions));
        this.permissionsAttachedForAllRoutes.push(permissions);
    }
    attachPermissionsToRoute(routeKey, permissions) {
        const fn = this.getFunction(routeKey);
        if (!fn) {
            throw new Error(`Failed to attach permissions. Route "${routeKey}" does not exist.`);
        }
        fn.attachPermissions(permissions);
    }
    getConstructInfo() {
        // imported
        if (!cdk.Token.isUnresolved(this.httpApi.apiId)) {
            return {
                httpApiId: this.httpApi.apiId,
                routes: this.routesInfo,
            };
        }
        // created
        const cfn = this.httpApi.node.defaultChild;
        return {
            httpApiLogicalId: Stack_1.Stack.of(this).getLogicalId(cfn),
            customDomainUrl: this._customDomainUrl,
            routes: this.routesInfo,
        };
    }
    buildCorsConfig(cors) {
        // Handle cors: false
        if (cors === false) {
            return;
        }
        // Handle cors: true | undefined
        else if (cors === undefined || cors === true) {
            return {
                allowHeaders: ["*"],
                allowMethods: [apig.CorsHttpMethod.ANY],
                allowOrigins: ["*"],
            };
        }
        // Handle cors: apig.CorsPreflightOptions
        else {
            return cors;
        }
    }
    addRoute(scope, routeKey, routeValue) {
        ///////////////////
        // Normalize routeProps
        ///////////////////
        let routeProps;
        if (routeValue.albListener) {
            routeProps = routeValue;
        }
        else if (routeValue.url) {
            routeProps = routeValue;
        }
        else if (routeValue.function) {
            routeProps = routeValue;
        }
        else {
            routeProps = {
                function: routeValue,
            };
        }
        ///////////////////
        // Normalize routeKey
        ///////////////////
        routeKey = this.normalizeRouteKey(routeKey);
        if (this.routesData[routeKey]) {
            throw new Error(`A route already exists for "${routeKey}"`);
        }
        ///////////////////
        // Get path and method
        ///////////////////
        let postfixName;
        let httpRouteKey;
        let methodStr;
        let path;
        if (routeKey === "$default") {
            postfixName = "default";
            httpRouteKey = apig.HttpRouteKey.DEFAULT;
            methodStr = "ANY";
            path = routeKey;
        }
        else {
            const routeKeyParts = routeKey.split(" ");
            if (routeKeyParts.length !== 2) {
                throw new Error(`Invalid route ${routeKey}`);
            }
            methodStr = routeKeyParts[0].toUpperCase();
            path = routeKeyParts[1];
            const method = allowedMethods.find((per) => per === methodStr);
            if (!method) {
                throw new Error(`Invalid method defined for "${routeKey}"`);
            }
            if (path.length === 0) {
                throw new Error(`Invalid path defined for "${routeKey}"`);
            }
            postfixName = `${methodStr}_${path}`;
            httpRouteKey = apig.HttpRouteKey.with(path, method);
        }
        ///////////////////
        // Get authorization
        ///////////////////
        const { authorizationType, authorizer, authorizationScopes } = this.buildRouteAuth(routeKey, routeProps);
        ///////////////////
        // Create route
        ///////////////////
        let integration;
        if (routeProps.albListener) {
            routeProps = routeProps;
            integration = this.createAlbIntegration(scope, routeKey, routeProps);
        }
        else if (routeProps.url) {
            routeProps = routeProps;
            integration = this.createHttpIntegration(scope, routeKey, routeProps);
        }
        else {
            routeProps = routeProps;
            integration = this.createFunctionIntegration(scope, routeKey, routeProps, postfixName);
        }
        const route = new apig.HttpRoute(scope, `Route_${postfixName}`, {
            httpApi: this.httpApi,
            routeKey: httpRouteKey,
            integration,
            authorizer,
            authorizationScopes,
        });
        ////////////////////
        // Configure route authorization type
        ////////////////////
        // Note: we need to explicitly set `cfnRoute.authorizationType` to `NONE`
        //       because if it were set to `AWS_IAM`, and then it is removed from
        //       the CloudFormation template (ie. set to undefined), CloudFormation
        //       doesn't updates the route. The route's authorizationType would still
        //       be `AWS_IAM`.
        if (authorizationType === ApiAuthorizationType.AWS_IAM ||
            authorizationType === ApiAuthorizationType.NONE) {
            if (!route.node.defaultChild) {
                throw new Error(`Failed to define the default route for "${routeKey}"`);
            }
            const cfnRoute = route.node.defaultChild;
            cfnRoute.authorizationType = authorizationType;
        }
        ///////////////////
        // Store function
        ///////////////////
        this.routesInfo[routeKey] = {
            method: methodStr,
            path,
        };
    }
    createHttpIntegration(scope, routeKey, routeProps) {
        ///////////////////
        // Create integration
        ///////////////////
        const errorMessage = `Invalid HTTP integration method defined for "${routeKey}"`;
        const integration = new apigIntegrations.HttpProxyIntegration({
            url: routeProps.url,
            method: this.buildHttpMethod(routeProps.method, errorMessage),
        });
        // Store route
        this.routesData[routeKey] = routeProps.url;
        return integration;
    }
    createAlbIntegration(scope, routeKey, routeProps) {
        ///////////////////
        // Create integration
        ///////////////////
        const errorMessage = `Invalid ALB integration method defined for "${routeKey}"`;
        const integration = new apigIntegrations.HttpAlbIntegration({
            listener: routeProps.albListener,
            method: this.buildHttpMethod(routeProps.method, errorMessage),
            vpcLink: routeProps.vpcLink,
        });
        // Store route
        this.routesData[routeKey] = routeProps.albListener;
        return integration;
    }
    createFunctionIntegration(scope, routeKey, routeProps, postfixName) {
        ///////////////////
        // Get payload format
        ///////////////////
        const payloadFormatVersion = routeProps.payloadFormatVersion ||
            this.defaultPayloadFormatVersion ||
            ApiPayloadFormatVersion.V2;
        if (!Object.values(ApiPayloadFormatVersion).includes(payloadFormatVersion)) {
            throw new Error(`sst.Api does not currently support ${payloadFormatVersion} payload format version. Only "V1" and "V2" are currently supported.`);
        }
        const integrationPayloadFormatVersion = payloadFormatVersion === ApiPayloadFormatVersion.V1
            ? apig.PayloadFormatVersion.VERSION_1_0
            : apig.PayloadFormatVersion.VERSION_2_0;
        ///////////////////
        // Create Function
        ///////////////////
        const lambda = Function_1.Function.fromDefinition(scope, `Lambda_${postfixName}`, routeProps.function, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the routes using FunctionProps, so the Api construct can apply the "defaultFunctionProps" to them.`);
        // Add an environment variable to determine if the function is an Api route.
        // If it is, when "sst start" is not connected, we want to return an 500
        // status code and a descriptive error message.
        const root = scope.node.root;
        if (root.local) {
            lambda.addEnvironment("SST_DEBUG_IS_API_ROUTE", "1", {
                removeInEdge: true,
            });
        }
        ///////////////////
        // Create integration
        ///////////////////
        const integration = new apigIntegrations.LambdaProxyIntegration({
            handler: lambda,
            payloadFormatVersion: integrationPayloadFormatVersion,
        });
        // Store route
        this.routesData[routeKey] = lambda;
        // Attached existing permissions
        this.permissionsAttachedForAllRoutes.forEach((permissions) => lambda.attachPermissions(permissions));
        return integration;
    }
    buildRouteAuth(routeKey, routeProps) {
        let authorizer, authorizationScopes;
        const authorizationType = routeProps.authorizationType ||
            this.defaultAuthorizationType ||
            ApiAuthorizationType.NONE;
        if (!Object.values(ApiAuthorizationType).includes(authorizationType)) {
            throw new Error(`sst.Api does not currently support ${authorizationType}. Only "AWS_IAM", "JWT" and "CUSTOM" are currently supported.`);
        }
        // Handle JWT Auth
        if (authorizationType === ApiAuthorizationType.JWT) {
            authorizer = routeProps.authorizer || this.defaultAuthorizer;
            authorizationScopes =
                routeProps.authorizationScopes || this.defaultAuthorizationScopes;
            if (!authorizer) {
                throw new Error(`Missing JWT authorizer for "${routeKey}"`);
            }
        }
        // Handle CUSTOM Auth
        else if (authorizationType === ApiAuthorizationType.CUSTOM) {
            authorizer = routeProps.authorizer || this.defaultAuthorizer;
            if (!authorizer) {
                throw new Error(`Missing custom Lambda authorizer for "${routeKey}"`);
            }
        }
        return { authorizationType, authorizer, authorizationScopes };
    }
    normalizeRouteKey(routeKey) {
        return routeKey.split(/\s+/).join(" ");
    }
    buildHttpMethod(method, errorMessage) {
        if (method === undefined) {
            return undefined;
        }
        if (typeof method === "string") {
            method = method.toUpperCase();
            method = allowedMethods.find((per) => per === method);
            if (!method) {
                throw new Error(errorMessage);
            }
        }
        return method;
    }
}
exports.Api = Api;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0FwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsbURBQXFDO0FBRXJDLGdFQUFrRDtBQUVsRCx5RkFBMkU7QUFLM0UsbUNBQWdDO0FBRWhDLHlDQUErRTtBQUUvRSx3RUFBMEQ7QUFDMUQsOEVBQWdFO0FBRWhFLE1BQU0sY0FBYyxHQUFHO0lBQ3JCLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRztJQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUc7SUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHO0lBQ25CLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSTtJQUNwQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUk7SUFDcEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLO0lBQ3JCLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTTtJQUN0QixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU87Q0FDeEIsQ0FBQztBQUVGLElBQVksb0JBS1g7QUFMRCxXQUFZLG9CQUFvQjtJQUM5QixtQ0FBVyxDQUFBO0lBQ1gscUNBQWEsQ0FBQTtJQUNiLHlDQUFpQixDQUFBO0lBQ2pCLDJDQUFtQixDQUFBO0FBQ3JCLENBQUMsRUFMVyxvQkFBb0IsR0FBcEIsNEJBQW9CLEtBQXBCLDRCQUFvQixRQUsvQjtBQUVELElBQVksdUJBR1g7QUFIRCxXQUFZLHVCQUF1QjtJQUNqQyxxQ0FBVSxDQUFBO0lBQ1YscUNBQVUsQ0FBQTtBQUNaLENBQUMsRUFIVyx1QkFBdUIsR0FBdkIsK0JBQXVCLEtBQXZCLCtCQUF1QixRQUdsQztBQTBFRCxxQkFBcUI7QUFDckIsWUFBWTtBQUNaLHFCQUFxQjtBQUVyQixNQUFhLEdBQUksU0FBUSxHQUFHLENBQUMsU0FBUztJQXNCcEMsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFnQjtRQUM1RCxLQUFLLENBQUMsS0FBSyxFQUFF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USxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVPLGVBQWUsQ0FDckIsTUFBNEMsRUFDNUMsWUFBb0I7UUFFcEIsSUFBSSxNQUFNLEtBQUssU0FBUyxFQUFFO1lBQ3hCLE9BQU8sU0FBUyxDQUFDO1NBQ2xCO1FBRUQsSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDOUIsTUFBTSxHQUFHLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUM5QixNQUFNLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxLQUFLLE1BQU0sQ0FBQyxDQUFDO1lBQ3RELElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ1gsTUFBTSxJQUFJLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUMvQjtTQUNGO1FBRUQsT0FBTyxNQUF5QixDQUFDO0lBQ25DLENBQUM7Q0FDRjtBQTlpQkQsa0JBOGlCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0ICogYXMgYWNtIGZyb20gXCJAYXdzLWNkay9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyXCI7XG5pbXBvcnQgKiBhcyBhcGlnIGZyb20gXCJAYXdzLWNkay9hd3MtYXBpZ2F0ZXdheXYyXCI7XG5pbXBvcnQgKiBhcyBhcGlnQXV0aG9yaXplcnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItYXV0aG9yaXplcnNcIjtcbmltcG9ydCAqIGFzIGFwaWdJbnRlZ3JhdGlvbnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1hcGlnYXRld2F5djItaW50ZWdyYXRpb25zXCI7XG5pbXBvcnQgKiBhcyBlbGIgZnJvbSBcIkBhd3MtY2RrL2F3cy1lbGFzdGljbG9hZGJhbGFuY2luZ3YyXCI7XG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gXCJAYXdzLWNkay9hd3MtbG9nc1wiO1xuXG5pbXBvcnQgeyBBcHAgfSBmcm9tIFwiLi9BcHBcIjtcbmltcG9ydCB7IFN0YWNrIH0gZnJvbSBcIi4vU3RhY2tcIjtcbmltcG9ydCB7IElTc3RDb25zdHJ1Y3QsIElTc3RDb25zdHJ1Y3RJbmZvIH0gZnJvbSBcIi4vQ29uc3RydWN0XCI7XG5pbXBvcnQgeyBGdW5jdGlvbiBhcyBGbiwgRnVuY3Rpb25Qcm9wcywgRnVuY3Rpb25EZWZpbml0aW9uIH0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zIH0gZnJvbSBcIi4vdXRpbC9wZXJtaXNzaW9uXCI7XG5pbXBvcnQgKiBhcyBhcGlnVjJEb21haW4gZnJvbSBcIi4vdXRpbC9hcGlHYXRld2F5VjJEb21haW5cIjtcbmltcG9ydCAqIGFzIGFwaWdWMkFjY2Vzc0xvZyBmcm9tIFwiLi91dGlsL2FwaUdhdGV3YXlWMkFjY2Vzc0xvZ1wiO1xuXG5jb25zdCBhbGxvd2VkTWV0aG9kcyA9IFtcbiAgYXBpZy5IdHRwTWV0aG9kLkFOWSxcbiAgYXBpZy5IdHRwTWV0aG9kLkdFVCxcbiAgYXBpZy5IdHRwTWV0aG9kLlBVVCxcbiAgYXBpZy5IdHRwTWV0aG9kLlBPU1QsXG4gIGFwaWcuSHR0cE1ldGhvZC5IRUFELFxuICBhcGlnLkh0dHBNZXRob2QuUEFUQ0gsXG4gIGFwaWcuSHR0cE1ldGhvZC5ERUxFVEUsXG4gIGFwaWcuSHR0cE1ldGhvZC5PUFRJT05TLFxuXTtcblxuZXhwb3J0IGVudW0gQXBpQXV0aG9yaXphdGlvblR5cGUge1xuICBKV1QgPSBcIkpXVFwiLFxuICBOT05FID0gXCJOT05FXCIsXG4gIENVU1RPTSA9IFwiQ1VTVE9NXCIsXG4gIEFXU19JQU0gPSBcIkFXU19JQU1cIixcbn1cblxuZXhwb3J0IGVudW0gQXBpUGF5bG9hZEZvcm1hdFZlcnNpb24ge1xuICBWMSA9IFwiMS4wXCIsXG4gIFYyID0gXCIyLjBcIixcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBBcGlQcm9wcyB7XG4gIHJlYWRvbmx5IGh0dHBBcGk/OiBhcGlnLklIdHRwQXBpIHwgYXBpZy5IdHRwQXBpUHJvcHM7XG4gIHJlYWRvbmx5IHJvdXRlcz86IHtcbiAgICBba2V5OiBzdHJpbmddOlxuICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgIHwgQXBpRnVuY3Rpb25Sb3V0ZVByb3BzXG4gICAgICB8IEFwaUh0dHBSb3V0ZVByb3BzXG4gICAgICB8IEFwaUFsYlJvdXRlUHJvcHM7XG4gIH07XG4gIHJlYWRvbmx5IGNvcnM/OiBib29sZWFuIHwgYXBpZy5Db3JzUHJlZmxpZ2h0T3B0aW9ucztcbiAgcmVhZG9ubHkgYWNjZXNzTG9nPzogYm9vbGVhbiB8IHN0cmluZyB8IEFwaUFjY2Vzc0xvZ1Byb3BzO1xuICByZWFkb25seSBjdXN0b21Eb21haW4/OiBzdHJpbmcgfCBBcGlDdXN0b21Eb21haW5Qcm9wcztcblxuICByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG4gIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uVHlwZT86IEFwaUF1dGhvcml6YXRpb25UeXBlO1xuICByZWFkb25seSBkZWZhdWx0QXV0aG9yaXplcj86XG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cEp3dEF1dGhvcml6ZXJcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwTGFtYmRhQXV0aG9yaXplclxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBVc2VyUG9vbEF1dGhvcml6ZXI7XG4gIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzPzogc3RyaW5nW107XG4gIHJlYWRvbmx5IGRlZmF1bHRQYXlsb2FkRm9ybWF0VmVyc2lvbj86IEFwaVBheWxvYWRGb3JtYXRWZXJzaW9uO1xuICByZWFkb25seSBkZWZhdWx0VGhyb3R0bGluZ0J1cnN0TGltaXQ/OiBudW1iZXI7XG4gIHJlYWRvbmx5IGRlZmF1bHRUaHJvdHRsaW5nUmF0ZUxpbWl0PzogbnVtYmVyO1xuICByZWFkb25seSBzdGFnZXM/OiBPbWl0PGFwaWcuSHR0cFN0YWdlUHJvcHMsIFwiaHR0cEFwaVwiPltdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwaUZ1bmN0aW9uUm91dGVQcm9wcyB7XG4gIHJlYWRvbmx5IGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHBheWxvYWRGb3JtYXRWZXJzaW9uPzogQXBpUGF5bG9hZEZvcm1hdFZlcnNpb247XG4gIHJlYWRvbmx5IGF1dGhvcml6YXRpb25UeXBlPzogQXBpQXV0aG9yaXphdGlvblR5cGU7XG4gIHJlYWRvbmx5IGF1dGhvcml6ZXI/OlxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBKd3RBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cExhbWJkYUF1dGhvcml6ZXJcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwVXNlclBvb2xBdXRob3JpemVyO1xuICByZWFkb25seSBhdXRob3JpemF0aW9uU2NvcGVzPzogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBpSHR0cFJvdXRlUHJvcHMge1xuICByZWFkb25seSB1cmw6IHN0cmluZztcbiAgcmVhZG9ubHkgbWV0aG9kPzogc3RyaW5nIHwgYXBpZy5IdHRwTWV0aG9kO1xuICByZWFkb25seSBhdXRob3JpemF0aW9uVHlwZT86IEFwaUF1dGhvcml6YXRpb25UeXBlO1xuICByZWFkb25seSBhdXRob3JpemVyPzpcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwSnd0QXV0aG9yaXplclxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBMYW1iZGFBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cFVzZXJQb29sQXV0aG9yaXplcjtcbiAgcmVhZG9ubHkgYXV0aG9yaXphdGlvblNjb3Blcz86IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwaUFsYlJvdXRlUHJvcHMge1xuICByZWFkb25seSBhbGJMaXN0ZW5lcjogZWxiLklBcHBsaWNhdGlvbkxpc3RlbmVyO1xuICByZWFkb25seSBtZXRob2Q/OiBzdHJpbmcgfCBhcGlnLkh0dHBNZXRob2Q7XG4gIHJlYWRvbmx5IHZwY0xpbms/OiBhcGlnLklWcGNMaW5rO1xuICByZWFkb25seSBhdXRob3JpemF0aW9uVHlwZT86IEFwaUF1dGhvcml6YXRpb25UeXBlO1xuICByZWFkb25seSBhdXRob3JpemVyPzpcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwSnd0QXV0aG9yaXplclxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBMYW1iZGFBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cFVzZXJQb29sQXV0aG9yaXplcjtcbiAgcmVhZG9ubHkgYXV0aG9yaXphdGlvblNjb3Blcz86IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgdHlwZSBBcGlDdXN0b21Eb21haW5Qcm9wcyA9IGFwaWdWMkRvbWFpbi5DdXN0b21Eb21haW5Qcm9wcztcbmV4cG9ydCB0eXBlIEFwaUFjY2Vzc0xvZ1Byb3BzID0gYXBpZ1YyQWNjZXNzTG9nLkFjY2Vzc0xvZ1Byb3BzO1xuXG5pbnRlcmZhY2UgQXBpQ29uc3RydWN0Um91dGVJbmZvIHtcbiAgcmVhZG9ubHkgbWV0aG9kOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHBhdGg6IHN0cmluZztcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb25zdHJ1Y3Rcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgY2xhc3MgQXBpIGV4dGVuZHMgY2RrLkNvbnN0cnVjdCBpbXBsZW1lbnRzIElTc3RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgaHR0cEFwaTogYXBpZy5IdHRwQXBpO1xuICBwdWJsaWMgcmVhZG9ubHkgYWNjZXNzTG9nR3JvdXA/OiBsb2dzLkxvZ0dyb3VwO1xuICBwdWJsaWMgcmVhZG9ubHkgYXBpR2F0ZXdheURvbWFpbj86IGFwaWcuRG9tYWluTmFtZTtcbiAgcHVibGljIHJlYWRvbmx5IGFjbUNlcnRpZmljYXRlPzogYWNtLkNlcnRpZmljYXRlO1xuICBwcml2YXRlIHJlYWRvbmx5IF9jdXN0b21Eb21haW5Vcmw/OiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgcm91dGVzRGF0YToge1xuICAgIFtrZXk6IHN0cmluZ106IEZuIHwgc3RyaW5nIHwgZWxiLklBcHBsaWNhdGlvbkxpc3RlbmVyO1xuICB9O1xuICBwcml2YXRlIHJlYWRvbmx5IHJvdXRlc0luZm86IHsgW2tleTogc3RyaW5nXTogQXBpQ29uc3RydWN0Um91dGVJbmZvIH07XG4gIHByaXZhdGUgcmVhZG9ubHkgcGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFJvdXRlczogUGVybWlzc2lvbnNbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEF1dGhvcml6ZXI/OlxuICAgIHwgYXBpZ0F1dGhvcml6ZXJzLkh0dHBKd3RBdXRob3JpemVyXG4gICAgfCBhcGlnQXV0aG9yaXplcnMuSHR0cExhbWJkYUF1dGhvcml6ZXJcbiAgICB8IGFwaWdBdXRob3JpemVycy5IdHRwVXNlclBvb2xBdXRob3JpemVyO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uVHlwZT86IEFwaUF1dGhvcml6YXRpb25UeXBlO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzPzogc3RyaW5nW107XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdFBheWxvYWRGb3JtYXRWZXJzaW9uPzogQXBpUGF5bG9hZEZvcm1hdFZlcnNpb247XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdFRocm90dGxpbmdCdXJzdExpbWl0PzogbnVtYmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRUaHJvdHRsaW5nUmF0ZUxpbWl0PzogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IEFwaVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIHByb3BzID0gcHJvcHMgfHwge307XG4gICAgY29uc3Qge1xuICAgICAgaHR0cEFwaSxcbiAgICAgIHJvdXRlcyxcbiAgICAgIGNvcnMsXG4gICAgICBhY2Nlc3NMb2csXG4gICAgICBjdXN0b21Eb21haW4sXG4gICAgICBkZWZhdWx0RnVuY3Rpb25Qcm9wcyxcbiAgICAgIGRlZmF1bHRBdXRob3JpemVyLFxuICAgICAgZGVmYXVsdEF1dGhvcml6YXRpb25UeXBlLFxuICAgICAgZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXMsXG4gICAgICBkZWZhdWx0UGF5bG9hZEZvcm1hdFZlcnNpb24sXG4gICAgICBkZWZhdWx0VGhyb3R0bGluZ0J1cnN0TGltaXQsXG4gICAgICBkZWZhdWx0VGhyb3R0bGluZ1JhdGVMaW1pdCxcbiAgICB9ID0gcHJvcHM7XG4gICAgdGhpcy5yb3V0ZXNEYXRhID0ge307XG4gICAgdGhpcy5yb3V0ZXNJbmZvID0ge307XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsUm91dGVzID0gW107XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyA9IGRlZmF1bHRGdW5jdGlvblByb3BzO1xuICAgIHRoaXMuZGVmYXVsdEF1dGhvcml6ZXIgPSBkZWZhdWx0QXV0aG9yaXplcjtcbiAgICB0aGlzLmRlZmF1bHRBdXRob3JpemF0aW9uVHlwZSA9IGRlZmF1bHRBdXRob3JpemF0aW9uVHlwZTtcbiAgICB0aGlzLmRlZmF1bHRBdXRob3JpemF0aW9uU2NvcGVzID0gZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXM7XG4gICAgdGhpcy5kZWZhdWx0UGF5bG9hZEZvcm1hdFZlcnNpb24gPSBkZWZhdWx0UGF5bG9hZEZvcm1hdFZlcnNpb247XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBBcGlcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKGNkay5Db25zdHJ1Y3QuaXNDb25zdHJ1Y3QoaHR0cEFwaSkpIHtcbiAgICAgIGlmIChjb3JzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDYW5ub3QgY29uZmlndXJlIHRoZSBcImNvcnNcIiB3aGVuIFwiaHR0cEFwaVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGFjY2Vzc0xvZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJhY2Nlc3NMb2dcIiB3aGVuIFwiaHR0cEFwaVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGN1c3RvbURvbWFpbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJjdXN0b21Eb21haW5cIiB3aGVuIFwiaHR0cEFwaVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKHByb3BzLnN0YWdlcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJzdGFnZXNcIiB3aGVuIFwiaHR0cEFwaVwiIGlzIGEgY29uc3RydWN0YFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhpcy5odHRwQXBpID0gaHR0cEFwaSBhcyBhcGlnLkh0dHBBcGk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGh0dHBBcGlQcm9wcyA9IChodHRwQXBpIHx8IHt9KSBhcyBhcGlnLkh0dHBBcGlQcm9wcztcblxuICAgICAgLy8gVmFsaWRhdGUgaW5wdXRcbiAgICAgIGlmIChodHRwQXBpUHJvcHMuY29yc1ByZWZsaWdodCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJodHRwQXBpLmNvcnNQcmVmbGlnaHRcIiBpbiB0aGUgQXBpYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKGh0dHBBcGlQcm9wcy5kZWZhdWx0RG9tYWluTWFwcGluZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJodHRwQXBpLmRlZmF1bHREb21haW5NYXBwaW5nXCIgaW4gdGhlIEFwaWBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gSGFuZGxlIENPUlNcbiAgICAgIGNvbnN0IGNvcnNQcmVmbGlnaHQgPSB0aGlzLmJ1aWxkQ29yc0NvbmZpZyhjb3JzKTtcblxuICAgICAgLy8gSGFuZGxlIEN1c3RvbSBEb21haW5cbiAgICAgIGNvbnN0IGN1c3RvbURvbWFpbkRhdGEgPSBhcGlnVjJEb21haW4uYnVpbGRDdXN0b21Eb21haW5EYXRhKFxuICAgICAgICB0aGlzLFxuICAgICAgICBjdXN0b21Eb21haW5cbiAgICAgICk7XG4gICAgICBsZXQgZGVmYXVsdERvbWFpbk1hcHBpbmc7XG4gICAgICBpZiAoY3VzdG9tRG9tYWluRGF0YSkge1xuICAgICAgICBpZiAoY3VzdG9tRG9tYWluRGF0YS5pc0FwaWdEb21haW5DcmVhdGVkKSB7XG4gICAgICAgICAgdGhpcy5hcGlHYXRld2F5RG9tYWluID1cbiAgICAgICAgICAgIGN1c3RvbURvbWFpbkRhdGEuYXBpZ0RvbWFpbiBhcyBhcGlnLkRvbWFpbk5hbWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGN1c3RvbURvbWFpbkRhdGEuaXNDZXJ0aWZpY2F0ZWRDcmVhdGVkKSB7XG4gICAgICAgICAgdGhpcy5hY21DZXJ0aWZpY2F0ZSA9IGN1c3RvbURvbWFpbkRhdGEuY2VydGlmaWNhdGUgYXMgYWNtLkNlcnRpZmljYXRlO1xuICAgICAgICB9XG4gICAgICAgIGRlZmF1bHREb21haW5NYXBwaW5nID0ge1xuICAgICAgICAgIGRvbWFpbk5hbWU6IGN1c3RvbURvbWFpbkRhdGEuYXBpZ0RvbWFpbixcbiAgICAgICAgICBtYXBwaW5nS2V5OiBjdXN0b21Eb21haW5EYXRhLm1hcHBpbmdLZXksXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuX2N1c3RvbURvbWFpblVybCA9IGBodHRwczovLyR7Y3VzdG9tRG9tYWluRGF0YS51cmx9YDtcbiAgICAgIH1cblxuICAgICAgdGhpcy5odHRwQXBpID0gbmV3IGFwaWcuSHR0cEFwaSh0aGlzLCBcIkFwaVwiLCB7XG4gICAgICAgIGFwaU5hbWU6IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShpZCksXG4gICAgICAgIGNvcnNQcmVmbGlnaHQsXG4gICAgICAgIGRlZmF1bHREb21haW5NYXBwaW5nLFxuICAgICAgICAuLi5odHRwQXBpUHJvcHMsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgaHR0cFN0YWdlID0gdGhpcy5odHRwQXBpLmRlZmF1bHRTdGFnZSBhcyBhcGlnLkh0dHBTdGFnZTtcblxuICAgICAgLy8gQ29uZmlndXJlIHRocm90dGxpbmdcbiAgICAgIGlmIChcbiAgICAgICAgZGVmYXVsdFRocm90dGxpbmdCdXJzdExpbWl0ICYmXG4gICAgICAgIGRlZmF1bHRUaHJvdHRsaW5nUmF0ZUxpbWl0ICYmXG4gICAgICAgIGh0dHBTdGFnZS5ub2RlLmRlZmF1bHRDaGlsZFxuICAgICAgKSB7XG4gICAgICAgIGNvbnN0IGNmblN0YWdlID0gaHR0cFN0YWdlLm5vZGUuZGVmYXVsdENoaWxkIGFzIGFwaWcuQ2ZuU3RhZ2U7XG4gICAgICAgIGNmblN0YWdlLmRlZmF1bHRSb3V0ZVNldHRpbmdzID0ge1xuICAgICAgICAgIC4uLihjZm5TdGFnZS5yb3V0ZVNldHRpbmdzIHx8IHt9KSxcbiAgICAgICAgICB0aHJvdHRsaW5nQnVyc3RMaW1pdDogZGVmYXVsdFRocm90dGxpbmdCdXJzdExpbWl0LFxuICAgICAgICAgIHRocm90dGxpbmdSYXRlTGltaXQ6IGRlZmF1bHRUaHJvdHRsaW5nUmF0ZUxpbWl0LFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmRlZmF1bHRUaHJvdHRsaW5nQnVyc3RMaW1pdCA9IGRlZmF1bHRUaHJvdHRsaW5nQnVyc3RMaW1pdDtcbiAgICAgICAgdGhpcy5kZWZhdWx0VGhyb3R0bGluZ1JhdGVMaW1pdCA9IGRlZmF1bHRUaHJvdHRsaW5nUmF0ZUxpbWl0O1xuICAgICAgfVxuXG4gICAgICAvLyBDb25maWd1cmUgYWNjZXNzIGxvZ1xuICAgICAgZm9yIChjb25zdCBkZWYgb2YgcHJvcHMuc3RhZ2VzIHx8IFtdKSB7XG4gICAgICAgIGNvbnN0IHN0YWdlID0gbmV3IGFwaWcuSHR0cFN0YWdlKHRoaXMsIFwiU3RhZ2VcIiArIGRlZi5zdGFnZU5hbWUsIHtcbiAgICAgICAgICAuLi5kZWYsXG4gICAgICAgICAgaHR0cEFwaTogdGhpcy5odHRwQXBpLFxuICAgICAgICB9KTtcbiAgICAgICAgYXBpZ1YyQWNjZXNzTG9nLmJ1aWxkQWNjZXNzTG9nRGF0YSh0aGlzLCBhY2Nlc3NMb2csIHN0YWdlLCBmYWxzZSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmh0dHBBcGkuZGVmYXVsdFN0YWdlKVxuICAgICAgICB0aGlzLmFjY2Vzc0xvZ0dyb3VwID0gYXBpZ1YyQWNjZXNzTG9nLmJ1aWxkQWNjZXNzTG9nRGF0YShcbiAgICAgICAgICB0aGlzLFxuICAgICAgICAgIGFjY2Vzc0xvZyxcbiAgICAgICAgICB0aGlzLmh0dHBBcGkuZGVmYXVsdFN0YWdlIGFzIGFwaWcuSHR0cFN0YWdlLFxuICAgICAgICAgIHRydWVcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDb25maWd1cmUgcm91dGVzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICB0aGlzLmFkZFJvdXRlcyh0aGlzLCByb3V0ZXMgfHwge30pO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIFJlZ2lzdGVyIENvbnN0cnVjdFxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICByb290LnJlZ2lzdGVyQ29uc3RydWN0KHRoaXMpO1xuICB9XG5cbiAgcHVibGljIGdldCB1cmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5odHRwQXBpLmFwaUVuZHBvaW50O1xuICB9XG5cbiAgcHVibGljIGdldCBjdXN0b21Eb21haW5VcmwoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5fY3VzdG9tRG9tYWluVXJsO1xuICB9XG5cbiAgcHVibGljIGdldCByb3V0ZXMoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnJvdXRlc0RhdGEpO1xuICB9XG5cbiAgcHVibGljIGdldCBodHRwQXBpQXJuKCk6IHN0cmluZyB7XG4gICAgY29uc3Qgc3RhY2sgPSBTdGFjay5vZih0aGlzKTtcbiAgICByZXR1cm4gYGFybjoke3N0YWNrLnBhcnRpdGlvbn06YXBpZ2F0ZXdheToke3N0YWNrLnJlZ2lvbn06Oi9hcGlzLyR7dGhpcy5odHRwQXBpLmFwaUlkfWA7XG4gIH1cblxuICBwdWJsaWMgYWRkUm91dGVzKFxuICAgIHNjb3BlOiBjZGsuQ29uc3RydWN0LFxuICAgIHJvdXRlczoge1xuICAgICAgW2tleTogc3RyaW5nXTpcbiAgICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgICAgfCBBcGlGdW5jdGlvblJvdXRlUHJvcHNcbiAgICAgICAgfCBBcGlIdHRwUm91dGVQcm9wc1xuICAgICAgICB8IEFwaUFsYlJvdXRlUHJvcHM7XG4gICAgfVxuICApOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyhyb3V0ZXMpLmZvckVhY2goKHJvdXRlS2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIHRoaXMuYWRkUm91dGUoc2NvcGUsIHJvdXRlS2V5LCByb3V0ZXNbcm91dGVLZXldKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRGdW5jdGlvbihyb3V0ZUtleTogc3RyaW5nKTogRm4gfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHJvdXRlID0gdGhpcy5yb3V0ZXNEYXRhW3RoaXMubm9ybWFsaXplUm91dGVLZXkocm91dGVLZXkpXTtcbiAgICByZXR1cm4gcm91dGUgaW5zdGFuY2VvZiBGbiA/IHJvdXRlIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIE9iamVjdC52YWx1ZXModGhpcy5yb3V0ZXNEYXRhKVxuICAgICAgLmZpbHRlcigocm91dGUpID0+IHJvdXRlIGluc3RhbmNlb2YgRm4pXG4gICAgICAuZm9yRWFjaCgocm91dGUpID0+IChyb3V0ZSBhcyBGbikuYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpKTtcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNUb1JvdXRlKFxuICAgIHJvdXRlS2V5OiBzdHJpbmcsXG4gICAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25zXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGZuID0gdGhpcy5nZXRGdW5jdGlvbihyb3V0ZUtleSk7XG4gICAgaWYgKCFmbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGF0dGFjaCBwZXJtaXNzaW9ucy4gUm91dGUgXCIke3JvdXRlS2V5fVwiIGRvZXMgbm90IGV4aXN0LmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgZm4uYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldENvbnN0cnVjdEluZm8oKTogSVNzdENvbnN0cnVjdEluZm8ge1xuICAgIC8vIGltcG9ydGVkXG4gICAgaWYgKCFjZGsuVG9rZW4uaXNVbnJlc29sdmVkKHRoaXMuaHR0cEFwaS5hcGlJZCkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGh0dHBBcGlJZDogdGhpcy5odHRwQXBpLmFwaUlkLFxuICAgICAgICByb3V0ZXM6IHRoaXMucm91dGVzSW5mbyxcbiAgICAgIH07XG4gICAgfVxuICAgIC8vIGNyZWF0ZWRcbiAgICBjb25zdCBjZm4gPSB0aGlzLmh0dHBBcGkubm9kZS5kZWZhdWx0Q2hpbGQgYXMgYXBpZy5DZm5BcGk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGh0dHBBcGlMb2dpY2FsSWQ6IFN0YWNrLm9mKHRoaXMpLmdldExvZ2ljYWxJZChjZm4pLFxuICAgICAgY3VzdG9tRG9tYWluVXJsOiB0aGlzLl9jdXN0b21Eb21haW5VcmwsXG4gICAgICByb3V0ZXM6IHRoaXMucm91dGVzSW5mbyxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZENvcnNDb25maWcoXG4gICAgY29yczogYm9vbGVhbiB8IGFwaWcuQ29yc1ByZWZsaWdodE9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogYXBpZy5Db3JzUHJlZmxpZ2h0T3B0aW9ucyB8IHVuZGVmaW5lZCB7XG4gICAgLy8gSGFuZGxlIGNvcnM6IGZhbHNlXG4gICAgaWYgKGNvcnMgPT09IGZhbHNlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIGNvcnM6IHRydWUgfCB1bmRlZmluZWRcbiAgICBlbHNlIGlmIChjb3JzID09PSB1bmRlZmluZWQgfHwgY29ycyA9PT0gdHJ1ZSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgYWxsb3dIZWFkZXJzOiBbXCIqXCJdLFxuICAgICAgICBhbGxvd01ldGhvZHM6IFthcGlnLkNvcnNIdHRwTWV0aG9kLkFOWV0sXG4gICAgICAgIGFsbG93T3JpZ2luczogW1wiKlwiXSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIGNvcnM6IGFwaWcuQ29yc1ByZWZsaWdodE9wdGlvbnNcbiAgICBlbHNlIHtcbiAgICAgIHJldHVybiBjb3JzO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkUm91dGUoXG4gICAgc2NvcGU6IGNkay5Db25zdHJ1Y3QsXG4gICAgcm91dGVLZXk6IHN0cmluZyxcbiAgICByb3V0ZVZhbHVlOlxuICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgIHwgQXBpRnVuY3Rpb25Sb3V0ZVByb3BzXG4gICAgICB8IEFwaUh0dHBSb3V0ZVByb3BzXG4gICAgICB8IEFwaUFsYlJvdXRlUHJvcHNcbiAgKTogdm9pZCB7XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIE5vcm1hbGl6ZSByb3V0ZVByb3BzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGxldCByb3V0ZVByb3BzO1xuICAgIGlmICgocm91dGVWYWx1ZSBhcyBBcGlBbGJSb3V0ZVByb3BzKS5hbGJMaXN0ZW5lcikge1xuICAgICAgcm91dGVQcm9wcyA9IHJvdXRlVmFsdWUgYXMgQXBpQWxiUm91dGVQcm9wcztcbiAgICB9IGVsc2UgaWYgKChyb3V0ZVZhbHVlIGFzIEFwaUh0dHBSb3V0ZVByb3BzKS51cmwpIHtcbiAgICAgIHJvdXRlUHJvcHMgPSByb3V0ZVZhbHVlIGFzIEFwaUh0dHBSb3V0ZVByb3BzO1xuICAgIH0gZWxzZSBpZiAoKHJvdXRlVmFsdWUgYXMgQXBpRnVuY3Rpb25Sb3V0ZVByb3BzKS5mdW5jdGlvbikge1xuICAgICAgcm91dGVQcm9wcyA9IHJvdXRlVmFsdWUgYXMgQXBpRnVuY3Rpb25Sb3V0ZVByb3BzO1xuICAgIH0gZWxzZSB7XG4gICAgICByb3V0ZVByb3BzID0ge1xuICAgICAgICBmdW5jdGlvbjogcm91dGVWYWx1ZSBhcyBGdW5jdGlvbkRlZmluaXRpb24sXG4gICAgICB9IGFzIEFwaUZ1bmN0aW9uUm91dGVQcm9wcztcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gTm9ybWFsaXplIHJvdXRlS2V5XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIHJvdXRlS2V5ID0gdGhpcy5ub3JtYWxpemVSb3V0ZUtleShyb3V0ZUtleSk7XG4gICAgaWYgKHRoaXMucm91dGVzRGF0YVtyb3V0ZUtleV0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQSByb3V0ZSBhbHJlYWR5IGV4aXN0cyBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgfVxuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIEdldCBwYXRoIGFuZCBtZXRob2RcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgbGV0IHBvc3RmaXhOYW1lO1xuICAgIGxldCBodHRwUm91dGVLZXk7XG4gICAgbGV0IG1ldGhvZFN0cjogc3RyaW5nO1xuICAgIGxldCBwYXRoO1xuICAgIGlmIChyb3V0ZUtleSA9PT0gXCIkZGVmYXVsdFwiKSB7XG4gICAgICBwb3N0Zml4TmFtZSA9IFwiZGVmYXVsdFwiO1xuICAgICAgaHR0cFJvdXRlS2V5ID0gYXBpZy5IdHRwUm91dGVLZXkuREVGQVVMVDtcbiAgICAgIG1ldGhvZFN0ciA9IFwiQU5ZXCI7XG4gICAgICBwYXRoID0gcm91dGVLZXk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJvdXRlS2V5UGFydHMgPSByb3V0ZUtleS5zcGxpdChcIiBcIik7XG4gICAgICBpZiAocm91dGVLZXlQYXJ0cy5sZW5ndGggIT09IDIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHJvdXRlICR7cm91dGVLZXl9YCk7XG4gICAgICB9XG4gICAgICBtZXRob2RTdHIgPSByb3V0ZUtleVBhcnRzWzBdLnRvVXBwZXJDYXNlKCk7XG4gICAgICBwYXRoID0gcm91dGVLZXlQYXJ0c1sxXTtcbiAgICAgIGNvbnN0IG1ldGhvZCA9IGFsbG93ZWRNZXRob2RzLmZpbmQoKHBlcikgPT4gcGVyID09PSBtZXRob2RTdHIpO1xuICAgICAgaWYgKCFtZXRob2QpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIG1ldGhvZCBkZWZpbmVkIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICAgIH1cbiAgICAgIGlmIChwYXRoLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcGF0aCBkZWZpbmVkIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICAgIH1cblxuICAgICAgcG9zdGZpeE5hbWUgPSBgJHttZXRob2RTdHJ9XyR7cGF0aH1gO1xuICAgICAgaHR0cFJvdXRlS2V5ID0gYXBpZy5IdHRwUm91dGVLZXkud2l0aChwYXRoLCBtZXRob2QpO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBHZXQgYXV0aG9yaXphdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICBjb25zdCB7IGF1dGhvcml6YXRpb25UeXBlLCBhdXRob3JpemVyLCBhdXRob3JpemF0aW9uU2NvcGVzIH0gPVxuICAgICAgdGhpcy5idWlsZFJvdXRlQXV0aChyb3V0ZUtleSwgcm91dGVQcm9wcyk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIHJvdXRlXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGxldCBpbnRlZ3JhdGlvbjtcbiAgICBpZiAoKHJvdXRlUHJvcHMgYXMgQXBpQWxiUm91dGVQcm9wcykuYWxiTGlzdGVuZXIpIHtcbiAgICAgIHJvdXRlUHJvcHMgPSByb3V0ZVByb3BzIGFzIEFwaUFsYlJvdXRlUHJvcHM7XG4gICAgICBpbnRlZ3JhdGlvbiA9IHRoaXMuY3JlYXRlQWxiSW50ZWdyYXRpb24oc2NvcGUsIHJvdXRlS2V5LCByb3V0ZVByb3BzKTtcbiAgICB9IGVsc2UgaWYgKChyb3V0ZVByb3BzIGFzIEFwaUh0dHBSb3V0ZVByb3BzKS51cmwpIHtcbiAgICAgIHJvdXRlUHJvcHMgPSByb3V0ZVByb3BzIGFzIEFwaUh0dHBSb3V0ZVByb3BzO1xuICAgICAgaW50ZWdyYXRpb24gPSB0aGlzLmNyZWF0ZUh0dHBJbnRlZ3JhdGlvbihzY29wZSwgcm91dGVLZXksIHJvdXRlUHJvcHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICByb3V0ZVByb3BzID0gcm91dGVQcm9wcyBhcyBBcGlGdW5jdGlvblJvdXRlUHJvcHM7XG4gICAgICBpbnRlZ3JhdGlvbiA9IHRoaXMuY3JlYXRlRnVuY3Rpb25JbnRlZ3JhdGlvbihcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIHJvdXRlS2V5LFxuICAgICAgICByb3V0ZVByb3BzLFxuICAgICAgICBwb3N0Zml4TmFtZVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCByb3V0ZSA9IG5ldyBhcGlnLkh0dHBSb3V0ZShzY29wZSwgYFJvdXRlXyR7cG9zdGZpeE5hbWV9YCwge1xuICAgICAgaHR0cEFwaTogdGhpcy5odHRwQXBpLFxuICAgICAgcm91dGVLZXk6IGh0dHBSb3V0ZUtleSxcbiAgICAgIGludGVncmF0aW9uLFxuICAgICAgYXV0aG9yaXplcixcbiAgICAgIGF1dGhvcml6YXRpb25TY29wZXMsXG4gICAgfSk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENvbmZpZ3VyZSByb3V0ZSBhdXRob3JpemF0aW9uIHR5cGVcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIE5vdGU6IHdlIG5lZWQgdG8gZXhwbGljaXRseSBzZXQgYGNmblJvdXRlLmF1dGhvcml6YXRpb25UeXBlYCB0byBgTk9ORWBcbiAgICAvLyAgICAgICBiZWNhdXNlIGlmIGl0IHdlcmUgc2V0IHRvIGBBV1NfSUFNYCwgYW5kIHRoZW4gaXQgaXMgcmVtb3ZlZCBmcm9tXG4gICAgLy8gICAgICAgdGhlIENsb3VkRm9ybWF0aW9uIHRlbXBsYXRlIChpZS4gc2V0IHRvIHVuZGVmaW5lZCksIENsb3VkRm9ybWF0aW9uXG4gICAgLy8gICAgICAgZG9lc24ndCB1cGRhdGVzIHRoZSByb3V0ZS4gVGhlIHJvdXRlJ3MgYXV0aG9yaXphdGlvblR5cGUgd291bGQgc3RpbGxcbiAgICAvLyAgICAgICBiZSBgQVdTX0lBTWAuXG4gICAgaWYgKFxuICAgICAgYXV0aG9yaXphdGlvblR5cGUgPT09IEFwaUF1dGhvcml6YXRpb25UeXBlLkFXU19JQU0gfHxcbiAgICAgIGF1dGhvcml6YXRpb25UeXBlID09PSBBcGlBdXRob3JpemF0aW9uVHlwZS5OT05FXG4gICAgKSB7XG4gICAgICBpZiAoIXJvdXRlLm5vZGUuZGVmYXVsdENoaWxkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGRlZmluZSB0aGUgZGVmYXVsdCByb3V0ZSBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgICB9XG4gICAgICBjb25zdCBjZm5Sb3V0ZSA9IHJvdXRlLm5vZGUuZGVmYXVsdENoaWxkIGFzIGFwaWcuQ2ZuUm91dGU7XG4gICAgICBjZm5Sb3V0ZS5hdXRob3JpemF0aW9uVHlwZSA9IGF1dGhvcml6YXRpb25UeXBlO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBTdG9yZSBmdW5jdGlvblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICB0aGlzLnJvdXRlc0luZm9bcm91dGVLZXldID0ge1xuICAgICAgbWV0aG9kOiBtZXRob2RTdHIsXG4gICAgICBwYXRoLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUh0dHBJbnRlZ3JhdGlvbihcbiAgICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgICByb3V0ZUtleTogc3RyaW5nLFxuICAgIHJvdXRlUHJvcHM6IEFwaUh0dHBSb3V0ZVByb3BzXG4gICk6IGFwaWcuSUh0dHBSb3V0ZUludGVncmF0aW9uIHtcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gQ3JlYXRlIGludGVncmF0aW9uXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBJbnZhbGlkIEhUVFAgaW50ZWdyYXRpb24gbWV0aG9kIGRlZmluZWQgZm9yIFwiJHtyb3V0ZUtleX1cImA7XG4gICAgY29uc3QgaW50ZWdyYXRpb24gPSBuZXcgYXBpZ0ludGVncmF0aW9ucy5IdHRwUHJveHlJbnRlZ3JhdGlvbih7XG4gICAgICB1cmw6IHJvdXRlUHJvcHMudXJsLFxuICAgICAgbWV0aG9kOiB0aGlzLmJ1aWxkSHR0cE1ldGhvZChyb3V0ZVByb3BzLm1ldGhvZCwgZXJyb3JNZXNzYWdlKSxcbiAgICB9KTtcblxuICAgIC8vIFN0b3JlIHJvdXRlXG4gICAgdGhpcy5yb3V0ZXNEYXRhW3JvdXRlS2V5XSA9IHJvdXRlUHJvcHMudXJsO1xuXG4gICAgcmV0dXJuIGludGVncmF0aW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVBbGJJbnRlZ3JhdGlvbihcbiAgICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgICByb3V0ZUtleTogc3RyaW5nLFxuICAgIHJvdXRlUHJvcHM6IEFwaUFsYlJvdXRlUHJvcHNcbiAgKTogYXBpZy5JSHR0cFJvdXRlSW50ZWdyYXRpb24ge1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgaW50ZWdyYXRpb25cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgY29uc3QgZXJyb3JNZXNzYWdlID0gYEludmFsaWQgQUxCIGludGVncmF0aW9uIG1ldGhvZCBkZWZpbmVkIGZvciBcIiR7cm91dGVLZXl9XCJgO1xuICAgIGNvbnN0IGludGVncmF0aW9uID0gbmV3IGFwaWdJbnRlZ3JhdGlvbnMuSHR0cEFsYkludGVncmF0aW9uKHtcbiAgICAgIGxpc3RlbmVyOiByb3V0ZVByb3BzLmFsYkxpc3RlbmVyLFxuICAgICAgbWV0aG9kOiB0aGlzLmJ1aWxkSHR0cE1ldGhvZChyb3V0ZVByb3BzLm1ldGhvZCwgZXJyb3JNZXNzYWdlKSxcbiAgICAgIHZwY0xpbms6IHJvdXRlUHJvcHMudnBjTGluayxcbiAgICB9KTtcblxuICAgIC8vIFN0b3JlIHJvdXRlXG4gICAgdGhpcy5yb3V0ZXNEYXRhW3JvdXRlS2V5XSA9IHJvdXRlUHJvcHMuYWxiTGlzdGVuZXI7XG5cbiAgICByZXR1cm4gaW50ZWdyYXRpb247XG4gIH1cblxuICBwcm90ZWN0ZWQgY3JlYXRlRnVuY3Rpb25JbnRlZ3JhdGlvbihcbiAgICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgICByb3V0ZUtleTogc3RyaW5nLFxuICAgIHJvdXRlUHJvcHM6IEFwaUZ1bmN0aW9uUm91dGVQcm9wcyxcbiAgICBwb3N0Zml4TmFtZTogc3RyaW5nXG4gICk6IGFwaWcuSUh0dHBSb3V0ZUludGVncmF0aW9uIHtcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gR2V0IHBheWxvYWQgZm9ybWF0XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIGNvbnN0IHBheWxvYWRGb3JtYXRWZXJzaW9uID1cbiAgICAgIHJvdXRlUHJvcHMucGF5bG9hZEZvcm1hdFZlcnNpb24gfHxcbiAgICAgIHRoaXMuZGVmYXVsdFBheWxvYWRGb3JtYXRWZXJzaW9uIHx8XG4gICAgICBBcGlQYXlsb2FkRm9ybWF0VmVyc2lvbi5WMjtcbiAgICBpZiAoXG4gICAgICAhT2JqZWN0LnZhbHVlcyhBcGlQYXlsb2FkRm9ybWF0VmVyc2lvbikuaW5jbHVkZXMocGF5bG9hZEZvcm1hdFZlcnNpb24pXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBzc3QuQXBpIGRvZXMgbm90IGN1cnJlbnRseSBzdXBwb3J0ICR7cGF5bG9hZEZvcm1hdFZlcnNpb259IHBheWxvYWQgZm9ybWF0IHZlcnNpb24uIE9ubHkgXCJWMVwiIGFuZCBcIlYyXCIgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQuYFxuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgaW50ZWdyYXRpb25QYXlsb2FkRm9ybWF0VmVyc2lvbiA9XG4gICAgICBwYXlsb2FkRm9ybWF0VmVyc2lvbiA9PT0gQXBpUGF5bG9hZEZvcm1hdFZlcnNpb24uVjFcbiAgICAgICAgPyBhcGlnLlBheWxvYWRGb3JtYXRWZXJzaW9uLlZFUlNJT05fMV8wXG4gICAgICAgIDogYXBpZy5QYXlsb2FkRm9ybWF0VmVyc2lvbi5WRVJTSU9OXzJfMDtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgRnVuY3Rpb25cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgY29uc3QgbGFtYmRhID0gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICBzY29wZSxcbiAgICAgIGBMYW1iZGFfJHtwb3N0Zml4TmFtZX1gLFxuICAgICAgcm91dGVQcm9wcy5mdW5jdGlvbixcbiAgICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMsXG4gICAgICBgVGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiBjYW5ub3QgYmUgYXBwbGllZCBpZiBhbiBpbnN0YW5jZSBvZiBhIEZ1bmN0aW9uIGNvbnN0cnVjdCBpcyBwYXNzZWQgaW4uIE1ha2Ugc3VyZSB0byBkZWZpbmUgYWxsIHRoZSByb3V0ZXMgdXNpbmcgRnVuY3Rpb25Qcm9wcywgc28gdGhlIEFwaSBjb25zdHJ1Y3QgY2FuIGFwcGx5IHRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgdG8gdGhlbS5gXG4gICAgKTtcbiAgICAvLyBBZGQgYW4gZW52aXJvbm1lbnQgdmFyaWFibGUgdG8gZGV0ZXJtaW5lIGlmIHRoZSBmdW5jdGlvbiBpcyBhbiBBcGkgcm91dGUuXG4gICAgLy8gSWYgaXQgaXMsIHdoZW4gXCJzc3Qgc3RhcnRcIiBpcyBub3QgY29ubmVjdGVkLCB3ZSB3YW50IHRvIHJldHVybiBhbiA1MDBcbiAgICAvLyBzdGF0dXMgY29kZSBhbmQgYSBkZXNjcmlwdGl2ZSBlcnJvciBtZXNzYWdlLlxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGlmIChyb290LmxvY2FsKSB7XG4gICAgICBsYW1iZGEuYWRkRW52aXJvbm1lbnQoXCJTU1RfREVCVUdfSVNfQVBJX1JPVVRFXCIsIFwiMVwiLCB7XG4gICAgICAgIHJlbW92ZUluRWRnZTogdHJ1ZSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgaW50ZWdyYXRpb25cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgY29uc3QgaW50ZWdyYXRpb24gPSBuZXcgYXBpZ0ludGVncmF0aW9ucy5MYW1iZGFQcm94eUludGVncmF0aW9uKHtcbiAgICAgIGhhbmRsZXI6IGxhbWJkYSxcbiAgICAgIHBheWxvYWRGb3JtYXRWZXJzaW9uOiBpbnRlZ3JhdGlvblBheWxvYWRGb3JtYXRWZXJzaW9uLFxuICAgIH0pO1xuXG4gICAgLy8gU3RvcmUgcm91dGVcbiAgICB0aGlzLnJvdXRlc0RhdGFbcm91dGVLZXldID0gbGFtYmRhO1xuXG4gICAgLy8gQXR0YWNoZWQgZXhpc3RpbmcgcGVybWlzc2lvbnNcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxSb3V0ZXMuZm9yRWFjaCgocGVybWlzc2lvbnMpID0+XG4gICAgICBsYW1iZGEuYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpXG4gICAgKTtcblxuICAgIHJldHVybiBpbnRlZ3JhdGlvbjtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRSb3V0ZUF1dGgoXG4gICAgcm91dGVLZXk6IHN0cmluZyxcbiAgICByb3V0ZVByb3BzOiBBcGlGdW5jdGlvblJvdXRlUHJvcHMgfCBBcGlIdHRwUm91dGVQcm9wcyB8IEFwaUFsYlJvdXRlUHJvcHNcbiAgKSB7XG4gICAgbGV0IGF1dGhvcml6ZXIsIGF1dGhvcml6YXRpb25TY29wZXM7XG4gICAgY29uc3QgYXV0aG9yaXphdGlvblR5cGUgPVxuICAgICAgcm91dGVQcm9wcy5hdXRob3JpemF0aW9uVHlwZSB8fFxuICAgICAgdGhpcy5kZWZhdWx0QXV0aG9yaXphdGlvblR5cGUgfHxcbiAgICAgIEFwaUF1dGhvcml6YXRpb25UeXBlLk5PTkU7XG5cbiAgICBpZiAoIU9iamVjdC52YWx1ZXMoQXBpQXV0aG9yaXphdGlvblR5cGUpLmluY2x1ZGVzKGF1dGhvcml6YXRpb25UeXBlKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgc3N0LkFwaSBkb2VzIG5vdCBjdXJyZW50bHkgc3VwcG9ydCAke2F1dGhvcml6YXRpb25UeXBlfS4gT25seSBcIkFXU19JQU1cIiwgXCJKV1RcIiBhbmQgXCJDVVNUT01cIiBhcmUgY3VycmVudGx5IHN1cHBvcnRlZC5gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSBKV1QgQXV0aFxuICAgIGlmIChhdXRob3JpemF0aW9uVHlwZSA9PT0gQXBpQXV0aG9yaXphdGlvblR5cGUuSldUKSB7XG4gICAgICBhdXRob3JpemVyID0gcm91dGVQcm9wcy5hdXRob3JpemVyIHx8IHRoaXMuZGVmYXVsdEF1dGhvcml6ZXI7XG4gICAgICBhdXRob3JpemF0aW9uU2NvcGVzID1cbiAgICAgICAgcm91dGVQcm9wcy5hdXRob3JpemF0aW9uU2NvcGVzIHx8IHRoaXMuZGVmYXVsdEF1dGhvcml6YXRpb25TY29wZXM7XG4gICAgICBpZiAoIWF1dGhvcml6ZXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIEpXVCBhdXRob3JpemVyIGZvciBcIiR7cm91dGVLZXl9XCJgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgQ1VTVE9NIEF1dGhcbiAgICBlbHNlIGlmIChhdXRob3JpemF0aW9uVHlwZSA9PT0gQXBpQXV0aG9yaXphdGlvblR5cGUuQ1VTVE9NKSB7XG4gICAgICBhdXRob3JpemVyID0gcm91dGVQcm9wcy5hdXRob3JpemVyIHx8IHRoaXMuZGVmYXVsdEF1dGhvcml6ZXI7XG4gICAgICBpZiAoIWF1dGhvcml6ZXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIGN1c3RvbSBMYW1iZGEgYXV0aG9yaXplciBmb3IgXCIke3JvdXRlS2V5fVwiYCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgYXV0aG9yaXphdGlvblR5cGUsIGF1dGhvcml6ZXIsIGF1dGhvcml6YXRpb25TY29wZXMgfTtcbiAgfVxuXG4gIHByaXZhdGUgbm9ybWFsaXplUm91dGVLZXkocm91dGVLZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHJvdXRlS2V5LnNwbGl0KC9cXHMrLykuam9pbihcIiBcIik7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkSHR0cE1ldGhvZChcbiAgICBtZXRob2Q6IHN0cmluZyB8IGFwaWcuSHR0cE1ldGhvZCB8IHVuZGVmaW5lZCxcbiAgICBlcnJvck1lc3NhZ2U6IHN0cmluZ1xuICApOiBhcGlnLkh0dHBNZXRob2QgfCB1bmRlZmluZWQge1xuICAgIGlmIChtZXRob2QgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIG1ldGhvZCA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgbWV0aG9kID0gbWV0aG9kLnRvVXBwZXJDYXNlKCk7XG4gICAgICBtZXRob2QgPSBhbGxvd2VkTWV0aG9kcy5maW5kKChwZXIpID0+IHBlciA9PT0gbWV0aG9kKTtcbiAgICAgIGlmICghbWV0aG9kKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBtZXRob2QgYXMgYXBpZy5IdHRwTWV0aG9kO1xuICB9XG59XG4iXX0=