"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Topic = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const sns = __importStar(require("@aws-cdk/aws-sns"));
const snsSubscriptions = __importStar(require("@aws-cdk/aws-sns-subscriptions"));
const Stack_1 = require("./Stack");
const Function_1 = require("./Function");
const Queue_1 = require("./Queue");
const construct_1 = require("./util/construct");
/////////////////////
// Construct
/////////////////////
class Topic extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { snsTopic, subscribers, defaultFunctionProps } = props || {};
        this.subscribers = [];
        this.permissionsAttachedForAllSubscribers = [];
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create Topic
        ////////////////////
        if (cdk.Construct.isConstruct(snsTopic)) {
            this.snsTopic = snsTopic;
        }
        else {
            const snsTopicProps = (snsTopic || {});
            this.snsTopic = new sns.Topic(this, "Topic", Object.assign({ topicName: root.logicalPrefixedName(id) }, snsTopicProps));
        }
        ///////////////////////////
        // Create Subscribers
        ///////////////////////////
        this.addSubscribers(this, subscribers || []);
        ///////////////////
        // Register Construct
        ///////////////////
        root.registerConstruct(this);
    }
    get topicArn() {
        return this.snsTopic.topicArn;
    }
    get topicName() {
        return this.snsTopic.topicName;
    }
    get subscriberFunctions() {
        return this.subscribers.filter((subscriber) => subscriber instanceof Function_1.Function);
    }
    get snsSubscriptions() {
        return this.subscribers.map((sub) => {
            let children;
            // look for sns.Subscription inside Queue.sqsQueue
            if (sub instanceof Queue_1.Queue) {
                children = sub.sqsQueue.node.children;
            }
            // look for sns.Subscription inside Function
            else {
                children = sub.node.children;
            }
            const child = children.find((child) => {
                return (0, construct_1.isConstructOf)(child, "aws-sns.Subscription");
            });
            return child;
        });
    }
    addSubscribers(scope, subscribers) {
        subscribers.forEach((subscriber) => this.addSubscriber(scope, subscriber));
    }
    attachPermissions(permissions) {
        this.subscribers
            .filter((subscriber) => subscriber instanceof Function_1.Function)
            .forEach((subscriber) => subscriber.attachPermissions(permissions));
        this.permissionsAttachedForAllSubscribers.push(permissions);
    }
    attachPermissionsToSubscriber(index, permissions) {
        const subscriber = this.subscribers[index];
        if (!(subscriber instanceof Function_1.Function)) {
            throw new Error(`Cannot attach permissions to the "${this.node.id}" Topic subscriber because it's not a Lambda function`);
        }
        subscriber.attachPermissions(permissions);
    }
    getConstructInfo() {
        // imported
        if (!cdk.Token.isUnresolved(this.snsTopic.topicArn)) {
            return {
                topicArn: this.snsTopic.topicArn,
            };
        }
        // created
        const cfn = this.snsTopic.node.defaultChild;
        return {
            topicLogicalId: Stack_1.Stack.of(this).getLogicalId(cfn),
        };
    }
    addSubscriber(scope, subscriber) {
        if (subscriber instanceof Queue_1.Queue ||
            subscriber.queue) {
            subscriber = subscriber;
            this.addQueueSubscriber(scope, subscriber);
        }
        else {
            subscriber = subscriber;
            this.addFunctionSubscriber(scope, subscriber);
        }
    }
    addQueueSubscriber(scope, subscriber) {
        // Parse subscriber props
        let subscriberProps;
        let queue;
        if (subscriber instanceof Queue_1.Queue) {
            subscriber = subscriber;
            queue = subscriber;
        }
        else {
            subscriber = subscriber;
            subscriberProps = subscriber.subscriberProps;
            queue = subscriber.queue;
        }
        this.subscribers.push(queue);
        // Create Subscription
        this.snsTopic.addSubscription(new snsSubscriptions.SqsSubscription(queue.sqsQueue, subscriberProps));
    }
    addFunctionSubscriber(scope, subscriber) {
        // Parse subscriber props
        let subscriberProps;
        let functionDefinition;
        if (subscriber.function) {
            subscriber = subscriber;
            subscriberProps = subscriber.subscriberProps;
            functionDefinition = subscriber.function;
        }
        else {
            subscriber = subscriber;
            functionDefinition = subscriber;
        }
        // Create function
        const i = this.subscribers.length;
        const fn = Function_1.Function.fromDefinition(scope, `Subscriber_${i}`, functionDefinition, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the subscribers using FunctionProps, so the Topic construct can apply the "defaultFunctionProps" to them.`);
        this.subscribers.push(fn);
        // Create Subscription
        this.snsTopic.addSubscription(new snsSubscriptions.LambdaSubscription(fn, subscriberProps));
        // Attach existing permissions
        this.permissionsAttachedForAllSubscribers.forEach((permissions) => fn.attachPermissions(permissions));
    }
}
exports.Topic = Topic;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVG9waWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvVG9waWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1EQUFxQztBQUNyQyxzREFBd0M7QUFDeEMsaUZBQW1FO0FBRW5FLG1DQUFnQztBQUVoQyx5Q0FBK0U7QUFDL0UsbUNBQWdDO0FBRWhDLGdEQUFpRDtBQTJCakQscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckIsTUFBYSxLQUFNLFNBQVEsR0FBRyxDQUFDLFNBQVM7SUFNdEMsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFrQjtRQUM5RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLE1BQU0sRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUNwRSxJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsb0NBQW9DLEdBQUcsRUFBRSxDQUFDO1FBQy9DLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxvQkFBb0IsQ0FBQztRQUVqRCxvQkFBb0I7UUFDcEIsZUFBZTtRQUNmLG9CQUFvQjtRQUVwQixJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBcUIsQ0FBQztTQUN2QzthQUFNO1lBQ0wsTUFBTSxhQUFhLEdBQUcsQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFtQixDQUFDO1lBQ3pELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxPQUFPLGtCQUN6QyxTQUFTLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEVB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RU8scUJBQXFCLENBQzNCLEtBQW9CLEVBQ3BCLFVBQTZEO1FBRTdELHlCQUF5QjtRQUN6QixJQUFJLGVBQWUsQ0FBQztRQUNwQixJQUFJLGtCQUFrQixDQUFDO1FBQ3ZCLElBQUssVUFBMkMsQ0FBQyxRQUFRLEVBQUU7WUFDekQsVUFBVSxHQUFHLFVBQTBDLENBQUM7WUFDeEQsZUFBZSxHQUFHLFVBQVUsQ0FBQyxlQUFlLENBQUM7WUFDN0Msa0JBQWtCLEdBQUcsVUFBVSxDQUFDLFFBQVEsQ0FBQztTQUMxQzthQUFNO1lBQ0wsVUFBVSxHQUFHLFVBQWdDLENBQUM7WUFDOUMsa0JBQWtCLEdBQUcsVUFBVSxDQUFDO1NBQ2pDO1FBRUQsa0JBQWtCO1FBQ2xCLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDO1FBQ2xDLE1BQU0sRUFBRSxHQUFHLG1CQUFFLENBQUMsY0FBYyxDQUMxQixLQUFLLEVBQ0wsY0FBYyxDQUFDLEVBQUUsRUFDakIsa0JBQWtCLEVBQ2xCLElBQUksQ0FBQyxvQkFBb0IsRUFDekIscU9BQXFPLENBQ3RPLENBQUM7UUFDRixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUUxQixzQkFBc0I7UUFDdEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQzNCLElBQUksZ0JBQWdCLENBQUMsa0JBQWtCLENBQUMsRUFBRSxFQUFFLGVBQWUsQ0FBQyxDQUM3RCxDQUFDO1FBRUYsOEJBQThCO1FBQzlCLElBQUksQ0FBQyxvQ0FBb0MsQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUNoRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQ2xDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUExTUQsc0JBME1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQgKiBhcyBzbnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1zbnNcIjtcbmltcG9ydCAqIGFzIHNuc1N1YnNjcmlwdGlvbnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1zbnMtc3Vic2NyaXB0aW9uc1wiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBTdGFjayB9IGZyb20gXCIuL1N0YWNrXCI7XG5pbXBvcnQgeyBJU3N0Q29uc3RydWN0LCBJU3N0Q29uc3RydWN0SW5mbyB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gYXMgRm4sIEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uRGVmaW5pdGlvbiB9IGZyb20gXCIuL0Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBRdWV1ZSB9IGZyb20gXCIuL1F1ZXVlXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucyB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuaW1wb3J0IHsgaXNDb25zdHJ1Y3RPZiB9IGZyb20gXCIuL3V0aWwvY29uc3RydWN0XCI7XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gSW50ZXJmYWNlc1xuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBpbnRlcmZhY2UgVG9waWNQcm9wcyB7XG4gIHJlYWRvbmx5IHNuc1RvcGljPzogc25zLklUb3BpYyB8IHNucy5Ub3BpY1Byb3BzO1xuICByZWFkb25seSBzdWJzY3JpYmVycz86IChcbiAgICB8IEZ1bmN0aW9uRGVmaW5pdGlvblxuICAgIHwgVG9waWNGdW5jdGlvblN1YnNjcmliZXJQcm9wc1xuICAgIHwgUXVldWVcbiAgICB8IFRvcGljUXVldWVTdWJzY3JpYmVyUHJvcHNcbiAgKVtdO1xuICByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVG9waWNGdW5jdGlvblN1YnNjcmliZXJQcm9wcyB7XG4gIHJlYWRvbmx5IGZ1bmN0aW9uOiBGdW5jdGlvbkRlZmluaXRpb247XG4gIHJlYWRvbmx5IHN1YnNjcmliZXJQcm9wcz86IHNuc1N1YnNjcmlwdGlvbnMuTGFtYmRhU3Vic2NyaXB0aW9uUHJvcHM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVG9waWNRdWV1ZVN1YnNjcmliZXJQcm9wcyB7XG4gIHJlYWRvbmx5IHF1ZXVlOiBRdWV1ZTtcbiAgcmVhZG9ubHkgc3Vic2NyaWJlclByb3BzPzogc25zU3Vic2NyaXB0aW9ucy5TcXNTdWJzY3JpcHRpb25Qcm9wcztcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBDb25zdHJ1Y3Rcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgY2xhc3MgVG9waWMgZXh0ZW5kcyBjZGsuQ29uc3RydWN0IGltcGxlbWVudHMgSVNzdENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBzbnNUb3BpYzogc25zLlRvcGljO1xuICBwcml2YXRlIHJlYWRvbmx5IHN1YnNjcmliZXJzOiAoRm4gfCBRdWV1ZSlbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsU3Vic2NyaWJlcnM6IFBlcm1pc3Npb25zW107XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IFRvcGljUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3Qgcm9vdCA9IHNjb3BlLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3QgeyBzbnNUb3BpYywgc3Vic2NyaWJlcnMsIGRlZmF1bHRGdW5jdGlvblByb3BzIH0gPSBwcm9wcyB8fCB7fTtcbiAgICB0aGlzLnN1YnNjcmliZXJzID0gW107XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsU3Vic2NyaWJlcnMgPSBbXTtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzID0gZGVmYXVsdEZ1bmN0aW9uUHJvcHM7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBUb3BpY1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoY2RrLkNvbnN0cnVjdC5pc0NvbnN0cnVjdChzbnNUb3BpYykpIHtcbiAgICAgIHRoaXMuc25zVG9waWMgPSBzbnNUb3BpYyBhcyBzbnMuVG9waWM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHNuc1RvcGljUHJvcHMgPSAoc25zVG9waWMgfHwge30pIGFzIHNucy5Ub3BpY1Byb3BzO1xuICAgICAgdGhpcy5zbnNUb3BpYyA9IG5ldyBzbnMuVG9waWModGhpcywgXCJUb3BpY1wiLCB7XG4gICAgICAgIHRvcGljTmFtZTogcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgLi4uc25zVG9waWNQcm9wcyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBTdWJzY3JpYmVyc1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgdGhpcy5hZGRTdWJzY3JpYmVycyh0aGlzLCBzdWJzY3JpYmVycyB8fCBbXSk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gUmVnaXN0ZXIgQ29uc3RydWN0XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIHJvb3QucmVnaXN0ZXJDb25zdHJ1Y3QodGhpcyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHRvcGljQXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuc25zVG9waWMudG9waWNBcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0IHRvcGljTmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnNuc1RvcGljLnRvcGljTmFtZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc3Vic2NyaWJlckZ1bmN0aW9ucygpOiBGbltdIHtcbiAgICByZXR1cm4gdGhpcy5zdWJzY3JpYmVycy5maWx0ZXIoXG4gICAgICAoc3Vic2NyaWJlcikgPT4gc3Vic2NyaWJlciBpbnN0YW5jZW9mIEZuXG4gICAgKSBhcyBGbltdO1xuICB9XG5cbiAgcHVibGljIGdldCBzbnNTdWJzY3JpcHRpb25zKCk6IHNucy5TdWJzY3JpcHRpb25bXSB7XG4gICAgcmV0dXJuIHRoaXMuc3Vic2NyaWJlcnMubWFwKChzdWIpID0+IHtcbiAgICAgIGxldCBjaGlsZHJlbjtcbiAgICAgIC8vIGxvb2sgZm9yIHNucy5TdWJzY3JpcHRpb24gaW5zaWRlIFF1ZXVlLnNxc1F1ZXVlXG4gICAgICBpZiAoc3ViIGluc3RhbmNlb2YgUXVldWUpIHtcbiAgICAgICAgY2hpbGRyZW4gPSBzdWIuc3FzUXVldWUubm9kZS5jaGlsZHJlbjtcbiAgICAgIH1cbiAgICAgIC8vIGxvb2sgZm9yIHNucy5TdWJzY3JpcHRpb24gaW5zaWRlIEZ1bmN0aW9uXG4gICAgICBlbHNlIHtcbiAgICAgICAgY2hpbGRyZW4gPSBzdWIubm9kZS5jaGlsZHJlbjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbi5maW5kKChjaGlsZCkgPT4ge1xuICAgICAgICByZXR1cm4gaXNDb25zdHJ1Y3RPZihjaGlsZCBhcyBjZGsuQ29uc3RydWN0LCBcImF3cy1zbnMuU3Vic2NyaXB0aW9uXCIpO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gY2hpbGQgYXMgc25zLlN1YnNjcmlwdGlvbjtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRTdWJzY3JpYmVycyhcbiAgICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgICBzdWJzY3JpYmVyczogKFxuICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgIHwgVG9waWNGdW5jdGlvblN1YnNjcmliZXJQcm9wc1xuICAgICAgfCBRdWV1ZVxuICAgICAgfCBUb3BpY1F1ZXVlU3Vic2NyaWJlclByb3BzXG4gICAgKVtdXG4gICk6IHZvaWQge1xuICAgIHN1YnNjcmliZXJzLmZvckVhY2goKHN1YnNjcmliZXIpID0+IHRoaXMuYWRkU3Vic2NyaWJlcihzY29wZSwgc3Vic2NyaWJlcikpO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9ucyk6IHZvaWQge1xuICAgIHRoaXMuc3Vic2NyaWJlcnNcbiAgICAgIC5maWx0ZXIoKHN1YnNjcmliZXIpID0+IHN1YnNjcmliZXIgaW5zdGFuY2VvZiBGbilcbiAgICAgIC5mb3JFYWNoKChzdWJzY3JpYmVyKSA9PiBzdWJzY3JpYmVyLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKSk7XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsU3Vic2NyaWJlcnMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNUb1N1YnNjcmliZXIoXG4gICAgaW5kZXg6IG51bWJlcixcbiAgICBwZXJtaXNzaW9uczogUGVybWlzc2lvbnNcbiAgKTogdm9pZCB7XG4gICAgY29uc3Qgc3Vic2NyaWJlciA9IHRoaXMuc3Vic2NyaWJlcnNbaW5kZXhdO1xuICAgIGlmICghKHN1YnNjcmliZXIgaW5zdGFuY2VvZiBGbikpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENhbm5vdCBhdHRhY2ggcGVybWlzc2lvbnMgdG8gdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgVG9waWMgc3Vic2NyaWJlciBiZWNhdXNlIGl0J3Mgbm90IGEgTGFtYmRhIGZ1bmN0aW9uYFxuICAgICAgKTtcbiAgICB9XG4gICAgc3Vic2NyaWJlci5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29uc3RydWN0SW5mbygpOiBJU3N0Q29uc3RydWN0SW5mbyB7XG4gICAgLy8gaW1wb3J0ZWRcbiAgICBpZiAoIWNkay5Ub2tlbi5pc1VucmVzb2x2ZWQodGhpcy5zbnNUb3BpYy50b3BpY0FybikpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRvcGljQXJuOiB0aGlzLnNuc1RvcGljLnRvcGljQXJuLFxuICAgICAgfTtcbiAgICB9XG4gICAgLy8gY3JlYXRlZFxuICAgIGNvbnN0IGNmbiA9IHRoaXMuc25zVG9waWMubm9kZS5kZWZhdWx0Q2hpbGQgYXMgc25zLkNmblRvcGljO1xuICAgIHJldHVybiB7XG4gICAgICB0b3BpY0xvZ2ljYWxJZDogU3RhY2sub2YodGhpcykuZ2V0TG9naWNhbElkKGNmbiksXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkU3Vic2NyaWJlcihcbiAgICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgICBzdWJzY3JpYmVyOlxuICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgIHwgVG9waWNGdW5jdGlvblN1YnNjcmliZXJQcm9wc1xuICAgICAgfCBRdWV1ZVxuICAgICAgfCBUb3BpY1F1ZXVlU3Vic2NyaWJlclByb3BzXG4gICk6IHZvaWQge1xuICAgIGlmIChcbiAgICAgIHN1YnNjcmliZXIgaW5zdGFuY2VvZiBRdWV1ZSB8fFxuICAgICAgKHN1YnNjcmliZXIgYXMgVG9waWNRdWV1ZVN1YnNjcmliZXJQcm9wcykucXVldWVcbiAgICApIHtcbiAgICAgIHN1YnNjcmliZXIgPSBzdWJzY3JpYmVyIGFzIFF1ZXVlIHwgVG9waWNRdWV1ZVN1YnNjcmliZXJQcm9wcztcbiAgICAgIHRoaXMuYWRkUXVldWVTdWJzY3JpYmVyKHNjb3BlLCBzdWJzY3JpYmVyKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3Vic2NyaWJlciA9IHN1YnNjcmliZXIgYXNcbiAgICAgICAgfCBGdW5jdGlvbkRlZmluaXRpb25cbiAgICAgICAgfCBUb3BpY0Z1bmN0aW9uU3Vic2NyaWJlclByb3BzO1xuICAgICAgdGhpcy5hZGRGdW5jdGlvblN1YnNjcmliZXIoc2NvcGUsIHN1YnNjcmliZXIpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkUXVldWVTdWJzY3JpYmVyKFxuICAgIHNjb3BlOiBjZGsuQ29uc3RydWN0LFxuICAgIHN1YnNjcmliZXI6IFF1ZXVlIHwgVG9waWNRdWV1ZVN1YnNjcmliZXJQcm9wc1xuICApOiB2b2lkIHtcbiAgICAvLyBQYXJzZSBzdWJzY3JpYmVyIHByb3BzXG4gICAgbGV0IHN1YnNjcmliZXJQcm9wcztcbiAgICBsZXQgcXVldWU7XG4gICAgaWYgKHN1YnNjcmliZXIgaW5zdGFuY2VvZiBRdWV1ZSkge1xuICAgICAgc3Vic2NyaWJlciA9IHN1YnNjcmliZXIgYXMgUXVldWU7XG4gICAgICBxdWV1ZSA9IHN1YnNjcmliZXI7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN1YnNjcmliZXIgPSBzdWJzY3JpYmVyIGFzIFRvcGljUXVldWVTdWJzY3JpYmVyUHJvcHM7XG4gICAgICBzdWJzY3JpYmVyUHJvcHMgPSBzdWJzY3JpYmVyLnN1YnNjcmliZXJQcm9wcztcbiAgICAgIHF1ZXVlID0gc3Vic2NyaWJlci5xdWV1ZTtcbiAgICB9XG4gICAgdGhpcy5zdWJzY3JpYmVycy5wdXNoKHF1ZXVlKTtcblxuICAgIC8vIENyZWF0ZSBTdWJzY3JpcHRpb25cbiAgICB0aGlzLnNuc1RvcGljLmFkZFN1YnNjcmlwdGlvbihcbiAgICAgIG5ldyBzbnNTdWJzY3JpcHRpb25zLlNxc1N1YnNjcmlwdGlvbihxdWV1ZS5zcXNRdWV1ZSwgc3Vic2NyaWJlclByb3BzKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFkZEZ1bmN0aW9uU3Vic2NyaWJlcihcbiAgICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgICBzdWJzY3JpYmVyOiBGdW5jdGlvbkRlZmluaXRpb24gfCBUb3BpY0Z1bmN0aW9uU3Vic2NyaWJlclByb3BzXG4gICk6IHZvaWQge1xuICAgIC8vIFBhcnNlIHN1YnNjcmliZXIgcHJvcHNcbiAgICBsZXQgc3Vic2NyaWJlclByb3BzO1xuICAgIGxldCBmdW5jdGlvbkRlZmluaXRpb247XG4gICAgaWYgKChzdWJzY3JpYmVyIGFzIFRvcGljRnVuY3Rpb25TdWJzY3JpYmVyUHJvcHMpLmZ1bmN0aW9uKSB7XG4gICAgICBzdWJzY3JpYmVyID0gc3Vic2NyaWJlciBhcyBUb3BpY0Z1bmN0aW9uU3Vic2NyaWJlclByb3BzO1xuICAgICAgc3Vic2NyaWJlclByb3BzID0gc3Vic2NyaWJlci5zdWJzY3JpYmVyUHJvcHM7XG4gICAgICBmdW5jdGlvbkRlZmluaXRpb24gPSBzdWJzY3JpYmVyLmZ1bmN0aW9uO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdWJzY3JpYmVyID0gc3Vic2NyaWJlciBhcyBGdW5jdGlvbkRlZmluaXRpb247XG4gICAgICBmdW5jdGlvbkRlZmluaXRpb24gPSBzdWJzY3JpYmVyO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvblxuICAgIGNvbnN0IGkgPSB0aGlzLnN1YnNjcmliZXJzLmxlbmd0aDtcbiAgICBjb25zdCBmbiA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICBgU3Vic2NyaWJlcl8ke2l9YCxcbiAgICAgIGZ1bmN0aW9uRGVmaW5pdGlvbixcbiAgICAgIHRoaXMuZGVmYXVsdEZ1bmN0aW9uUHJvcHMsXG4gICAgICBgVGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiBjYW5ub3QgYmUgYXBwbGllZCBpZiBhbiBpbnN0YW5jZSBvZiBhIEZ1bmN0aW9uIGNvbnN0cnVjdCBpcyBwYXNzZWQgaW4uIE1ha2Ugc3VyZSB0byBkZWZpbmUgYWxsIHRoZSBzdWJzY3JpYmVycyB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgVG9waWMgY29uc3RydWN0IGNhbiBhcHBseSB0aGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIHRvIHRoZW0uYFxuICAgICk7XG4gICAgdGhpcy5zdWJzY3JpYmVycy5wdXNoKGZuKTtcblxuICAgIC8vIENyZWF0ZSBTdWJzY3JpcHRpb25cbiAgICB0aGlzLnNuc1RvcGljLmFkZFN1YnNjcmlwdGlvbihcbiAgICAgIG5ldyBzbnNTdWJzY3JpcHRpb25zLkxhbWJkYVN1YnNjcmlwdGlvbihmbiwgc3Vic2NyaWJlclByb3BzKVxuICAgICk7XG5cbiAgICAvLyBBdHRhY2ggZXhpc3RpbmcgcGVybWlzc2lvbnNcbiAgICB0aGlzLnBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxTdWJzY3JpYmVycy5mb3JFYWNoKChwZXJtaXNzaW9ucykgPT5cbiAgICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==