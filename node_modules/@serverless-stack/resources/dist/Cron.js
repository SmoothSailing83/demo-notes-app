"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Cron = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const events = __importStar(require("@aws-cdk/aws-events"));
const eventsTargets = __importStar(require("@aws-cdk/aws-events-targets"));
const Stack_1 = require("./Stack");
const Function_1 = require("./Function");
class Cron extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { 
        // Topic props
        schedule, eventsRule, 
        // Function props
        job, } = props;
        ///////////////////////////
        // Create Rule
        ///////////////////////////
        const eventsRuleProps = (eventsRule || {});
        // Validate: cannot set eventsRule.schedule
        if (eventsRuleProps.schedule) {
            throw new Error(`Do not configure the "eventsRule.schedule". Use the "schedule" to configure the Cron schedule.`);
        }
        // Validate: schedule is set
        if (!schedule) {
            throw new Error(`No schedule defined for the "${id}" Cron`);
        }
        // Configure Schedule
        let propSchedule;
        if (typeof schedule === "string" &&
            (schedule.startsWith("rate(") || schedule.startsWith("cron("))) {
            propSchedule = events.Schedule.expression(schedule);
        }
        else if (schedule instanceof cdk.Duration) {
            propSchedule = events.Schedule.rate(schedule);
        }
        else {
            propSchedule = events.Schedule.cron(schedule);
        }
        this.eventsRule = new events.Rule(this, "Rule", Object.assign({ schedule: propSchedule }, eventsRuleProps));
        ///////////////////////////
        // Create Targets
        ///////////////////////////
        if (!job) {
            throw new Error(`No job defined for the "${id}" Cron`);
        }
        // normalize job
        let jobFunction, jobProps;
        if (job.function) {
            jobFunction = job.function;
            jobProps = job.jobProps;
        }
        else {
            jobFunction = job;
            jobProps = {};
        }
        // create function
        this.jobFunction = Function_1.Function.fromDefinition(this, "Job", jobFunction);
        this.eventsRule.addTarget(new eventsTargets.LambdaFunction(this.jobFunction, jobProps));
        ///////////////////
        // Register Construct
        ///////////////////
        root.registerConstruct(this);
    }
    attachPermissions(permissions) {
        this.jobFunction.attachPermissions(permissions);
    }
    getConstructInfo() {
        const cfnFunction = this.jobFunction.node.defaultChild;
        const cfnRule = this.eventsRule.node.defaultChild;
        return {
            functionLogicalId: Stack_1.Stack.of(this.jobFunction).getLogicalId(cfnFunction),
            functionStack: Stack_1.Stack.of(this.jobFunction).node.id,
            ruleLogicalId: Stack_1.Stack.of(this).getLogicalId(cfnRule),
            schedule: cfnRule.scheduleExpression,
        };
    }
}
exports.Cron = Cron;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ3Jvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9Dcm9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxtREFBcUM7QUFFckMsNERBQThDO0FBQzlDLDJFQUE2RDtBQUc3RCxtQ0FBZ0M7QUFFaEMseUNBQWtFO0FBY2xFLE1BQWEsSUFBSyxTQUFRLEdBQUcsQ0FBQyxTQUFTO0lBSXJDLFlBQVksS0FBb0IsRUFBRSxFQUFVLEVBQUUsS0FBZ0I7UUFDNUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQVcsQ0FBQztRQUNwQyxNQUFNO1FBQ0osY0FBYztRQUNkLFFBQVEsRUFDUixVQUFVO1FBQ1YsaUJBQWlCO1FBQ2pCLEdBQUcsR0FDSixHQUFHLEtBQUssQ0FBQztRQUVWLDJCQUEyQjtRQUMzQixjQUFjO1FBQ2QsMkJBQTJCO1FBRTNCLE1BQU0sZUFBZSxHQUFHLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBcUIsQ0FBQztRQUUvRCwyQ0FBMkM7UUFDM0MsSUFBSSxlQUFlLENBQUMsUUFBUSxFQUFFO1lBQzVCLE1BQU0sSUFBSSxLQUFLLENBQ2IsZ0dBQWdHLENBQ2pHLENBQUM7U0FDSDtRQUVELDRCQUE0QjtRQUM1QixJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2IsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUM3RDtRQUVELHFCQUFxQjtRQUNyQixJQUFJLFlBQTZCLENBQUM7UUFDbEMsSUFDRSxPQUFPLFFBQVEsS0FBSyxRQUFRO1lBQzVCLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxRQUFRLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQzlEO1lBQ0EsWUFBWSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3JEO2FBQU0sSUFBSSxRQUFRLFlBQVksR0FBRyxDQUFDLFFBQVEsRUFBRTtZQUMzQyxZQUFZLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDL0M7YUFBTTtZQUNMLFlBQVksR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUE4QixDQUFDLENBQUM7U0FDckU7UUFFRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsTUFBTSxrQkFDNUMsUUFBUSxFQUFFLFlBQVksSUFDbkIsZUFBZSxFQUNsQixDQUFDO1FBRUgsMkJBQTJCO1FBQzNCLGlCQUFpQjtRQUNqQiwyQkFBMkI7UUFFM0IsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNSLE1BQU0sSUFBSSxLQUFLLENBQUMsMkJBQTJCLEVBQUUsUUFBUSxDQUFDLENBQUM7U0FDeEQ7UUFFRCxnQkFBZ0I7UUFDaEIsSUFBSSxXQUFXLEVBQUUsUUFBUSxDQUFDO1FBQzFCLElBQUssR0FBb0IsQ0FBQyxRQUFRLEVBQUU7WUFDbEMsV0FBVyxHQUFJLEdBQW9CLENBQUMsUUFBUSxDQUFDO1lBQzdDLFFBQVEsR0FBSSxHQUFvQixDQUFDLFFBQVEsQ0FBQztTQUMzQzthQUFNO1lBQ0wsV0FBVyxHQUFHLEdBQXlCLENBQUM7WUFDeEMsUUFBUSxHQUFHLEVBQUUsQ0FBQztTQUNmO1FBRUQsa0JBQWtCO1FBQ2xCLElBQUksQ0FBQyxXQUFXLEdBQUcsbUJBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQztRQUNqRSxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FDdkIsSUFBSSxhQUFhLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQzdELENBQUM7UUFFRixtQkFBbUI7UUFDbkIscUJBQXFCO1FBQ3JCLG1CQUFtQjtRQUNuQixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVNLGlCQUFpQixDQUFDLFdBQXdCO1FBQy9DLElBQUksQ0FBQyxXQUFXLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVNLGdCQUFnQjtRQUNyQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxZQUFrQyxDQUFDO1FBQzdFLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFlBQThCLENBQUM7UUFDcEUsT0FBTztZQUNMLGlCQUFpQixFQUFFLGFBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUM7WUFDdkUsYUFBYSxFQUFFLGFBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ2pELGFBQWEsRUFBRSxhQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUM7WUFDbkQsUUFBUSxFQUFFLE9BQU8sQ0FBQyxrQkFBa0I7U0FDckMsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQWhHRCxvQkFnR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSBcIkBhd3MtY2RrL2NvcmVcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiQGF3cy1jZGsvYXdzLWxhbWJkYVwiO1xuaW1wb3J0ICogYXMgZXZlbnRzIGZyb20gXCJAYXdzLWNkay9hd3MtZXZlbnRzXCI7XG5pbXBvcnQgKiBhcyBldmVudHNUYXJnZXRzIGZyb20gXCJAYXdzLWNkay9hd3MtZXZlbnRzLXRhcmdldHNcIjtcblxuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBTdGFjayB9IGZyb20gXCIuL1N0YWNrXCI7XG5pbXBvcnQgeyBJU3N0Q29uc3RydWN0LCBJU3N0Q29uc3RydWN0SW5mbyB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gYXMgRnVuYywgRnVuY3Rpb25EZWZpbml0aW9uIH0gZnJvbSBcIi4vRnVuY3Rpb25cIjtcbmltcG9ydCB7IFBlcm1pc3Npb25zIH0gZnJvbSBcIi4vdXRpbC9wZXJtaXNzaW9uXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3JvblByb3BzIHtcbiAgcmVhZG9ubHkgam9iOiBGdW5jdGlvbkRlZmluaXRpb24gfCBDcm9uSm9iUHJvcHM7XG4gIHJlYWRvbmx5IHNjaGVkdWxlPzogc3RyaW5nIHwgY2RrLkR1cmF0aW9uIHwgZXZlbnRzLkNyb25PcHRpb25zO1xuICByZWFkb25seSBldmVudHNSdWxlPzogZXZlbnRzLlJ1bGVQcm9wcztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDcm9uSm9iUHJvcHMge1xuICByZWFkb25seSBmdW5jdGlvbjogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBqb2JQcm9wcz86IGV2ZW50c1RhcmdldHMuTGFtYmRhRnVuY3Rpb25Qcm9wcztcbn1cblxuZXhwb3J0IGNsYXNzIENyb24gZXh0ZW5kcyBjZGsuQ29uc3RydWN0IGltcGxlbWVudHMgSVNzdENvbnN0cnVjdCB7XG4gIHB1YmxpYyByZWFkb25seSBldmVudHNSdWxlOiBldmVudHMuUnVsZTtcbiAgcHVibGljIHJlYWRvbmx5IGpvYkZ1bmN0aW9uOiBGdW5jO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQ3JvblByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIGNvbnN0IHJvb3QgPSBzY29wZS5ub2RlLnJvb3QgYXMgQXBwO1xuICAgIGNvbnN0IHtcbiAgICAgIC8vIFRvcGljIHByb3BzXG4gICAgICBzY2hlZHVsZSxcbiAgICAgIGV2ZW50c1J1bGUsXG4gICAgICAvLyBGdW5jdGlvbiBwcm9wc1xuICAgICAgam9iLFxuICAgIH0gPSBwcm9wcztcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBSdWxlXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBjb25zdCBldmVudHNSdWxlUHJvcHMgPSAoZXZlbnRzUnVsZSB8fCB7fSkgYXMgZXZlbnRzLlJ1bGVQcm9wcztcblxuICAgIC8vIFZhbGlkYXRlOiBjYW5ub3Qgc2V0IGV2ZW50c1J1bGUuc2NoZWR1bGVcbiAgICBpZiAoZXZlbnRzUnVsZVByb3BzLnNjaGVkdWxlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBEbyBub3QgY29uZmlndXJlIHRoZSBcImV2ZW50c1J1bGUuc2NoZWR1bGVcIi4gVXNlIHRoZSBcInNjaGVkdWxlXCIgdG8gY29uZmlndXJlIHRoZSBDcm9uIHNjaGVkdWxlLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGU6IHNjaGVkdWxlIGlzIHNldFxuICAgIGlmICghc2NoZWR1bGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gc2NoZWR1bGUgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBDcm9uYCk7XG4gICAgfVxuXG4gICAgLy8gQ29uZmlndXJlIFNjaGVkdWxlXG4gICAgbGV0IHByb3BTY2hlZHVsZTogZXZlbnRzLlNjaGVkdWxlO1xuICAgIGlmIChcbiAgICAgIHR5cGVvZiBzY2hlZHVsZSA9PT0gXCJzdHJpbmdcIiAmJlxuICAgICAgKHNjaGVkdWxlLnN0YXJ0c1dpdGgoXCJyYXRlKFwiKSB8fCBzY2hlZHVsZS5zdGFydHNXaXRoKFwiY3JvbihcIikpXG4gICAgKSB7XG4gICAgICBwcm9wU2NoZWR1bGUgPSBldmVudHMuU2NoZWR1bGUuZXhwcmVzc2lvbihzY2hlZHVsZSk7XG4gICAgfSBlbHNlIGlmIChzY2hlZHVsZSBpbnN0YW5jZW9mIGNkay5EdXJhdGlvbikge1xuICAgICAgcHJvcFNjaGVkdWxlID0gZXZlbnRzLlNjaGVkdWxlLnJhdGUoc2NoZWR1bGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwcm9wU2NoZWR1bGUgPSBldmVudHMuU2NoZWR1bGUuY3JvbihzY2hlZHVsZSBhcyBldmVudHMuQ3Jvbk9wdGlvbnMpO1xuICAgIH1cblxuICAgIHRoaXMuZXZlbnRzUnVsZSA9IG5ldyBldmVudHMuUnVsZSh0aGlzLCBcIlJ1bGVcIiwge1xuICAgICAgc2NoZWR1bGU6IHByb3BTY2hlZHVsZSxcbiAgICAgIC4uLmV2ZW50c1J1bGVQcm9wcyxcbiAgICB9KTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBUYXJnZXRzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoIWpvYikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBqb2IgZGVmaW5lZCBmb3IgdGhlIFwiJHtpZH1cIiBDcm9uYCk7XG4gICAgfVxuXG4gICAgLy8gbm9ybWFsaXplIGpvYlxuICAgIGxldCBqb2JGdW5jdGlvbiwgam9iUHJvcHM7XG4gICAgaWYgKChqb2IgYXMgQ3JvbkpvYlByb3BzKS5mdW5jdGlvbikge1xuICAgICAgam9iRnVuY3Rpb24gPSAoam9iIGFzIENyb25Kb2JQcm9wcykuZnVuY3Rpb247XG4gICAgICBqb2JQcm9wcyA9IChqb2IgYXMgQ3JvbkpvYlByb3BzKS5qb2JQcm9wcztcbiAgICB9IGVsc2Uge1xuICAgICAgam9iRnVuY3Rpb24gPSBqb2IgYXMgRnVuY3Rpb25EZWZpbml0aW9uO1xuICAgICAgam9iUHJvcHMgPSB7fTtcbiAgICB9XG5cbiAgICAvLyBjcmVhdGUgZnVuY3Rpb25cbiAgICB0aGlzLmpvYkZ1bmN0aW9uID0gRnVuYy5mcm9tRGVmaW5pdGlvbih0aGlzLCBcIkpvYlwiLCBqb2JGdW5jdGlvbik7XG4gICAgdGhpcy5ldmVudHNSdWxlLmFkZFRhcmdldChcbiAgICAgIG5ldyBldmVudHNUYXJnZXRzLkxhbWJkYUZ1bmN0aW9uKHRoaXMuam9iRnVuY3Rpb24sIGpvYlByb3BzKVxuICAgICk7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gUmVnaXN0ZXIgQ29uc3RydWN0XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIHJvb3QucmVnaXN0ZXJDb25zdHJ1Y3QodGhpcyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25zKTogdm9pZCB7XG4gICAgdGhpcy5qb2JGdW5jdGlvbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29uc3RydWN0SW5mbygpOiBJU3N0Q29uc3RydWN0SW5mbyB7XG4gICAgY29uc3QgY2ZuRnVuY3Rpb24gPSB0aGlzLmpvYkZ1bmN0aW9uLm5vZGUuZGVmYXVsdENoaWxkIGFzIGxhbWJkYS5DZm5GdW5jdGlvbjtcbiAgICBjb25zdCBjZm5SdWxlID0gdGhpcy5ldmVudHNSdWxlLm5vZGUuZGVmYXVsdENoaWxkIGFzIGV2ZW50cy5DZm5SdWxlO1xuICAgIHJldHVybiB7XG4gICAgICBmdW5jdGlvbkxvZ2ljYWxJZDogU3RhY2sub2YodGhpcy5qb2JGdW5jdGlvbikuZ2V0TG9naWNhbElkKGNmbkZ1bmN0aW9uKSxcbiAgICAgIGZ1bmN0aW9uU3RhY2s6IFN0YWNrLm9mKHRoaXMuam9iRnVuY3Rpb24pLm5vZGUuaWQsXG4gICAgICBydWxlTG9naWNhbElkOiBTdGFjay5vZih0aGlzKS5nZXRMb2dpY2FsSWQoY2ZuUnVsZSksXG4gICAgICBzY2hlZHVsZTogY2ZuUnVsZS5zY2hlZHVsZUV4cHJlc3Npb24sXG4gICAgfTtcbiAgfVxufVxuIl19