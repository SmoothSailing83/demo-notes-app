"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const AWS = __importStar(require("aws-sdk"));
const cfnResponse = __importStar(require("./cfn-response"));
const util_1 = require("./util");
let lambda;
function handler(cfnRequest) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)("onEventHandler", cfnRequest);
        // Initialize Lambda client
        initLambdaClient();
        // Invoke user function on Create and on Update
        const params = cfnRequest.ResourceProperties.FunctionParams;
        let data;
        if (cfnRequest.RequestType === "Create") {
            data = yield handleCreate(params);
        }
        else if (cfnRequest.RequestType === "Update") {
            const oldParams = cfnRequest.OldResourceProperties.FunctionParams;
            data = yield handleUpdate(params, oldParams);
        }
        else if (cfnRequest.RequestType === "Delete") {
            yield handleDelete(params);
        }
        // Build response
        return cfnResponse.submitResponse("SUCCESS", Object.assign(Object.assign({}, cfnRequest), { PhysicalResourceId: defaultPhysicalResourceId(cfnRequest), Data: data }));
    });
}
function handleCreate(params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`handleCreate() called with params`, params);
        let resp;
        // Create function
        (0, util_1.log)(`created function`);
        resp = yield lambda.createFunction(params).promise();
        (0, util_1.log)(`response`, resp);
        // Publish version
        (0, util_1.log)(`publish version`);
        resp = yield lambda
            .publishVersion({
            FunctionName: params.FunctionName,
        })
            .promise();
        (0, util_1.log)(`response`, resp);
        return { FunctionArn: resp.FunctionArn, Version: resp.Version };
    });
}
function handleUpdate(params, oldParams) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`handleUpdate() called with params`, params, `oldParams`, oldParams);
        let resp;
        // Update function configuration
        (0, util_1.log)(`update function configuration`);
        if ([
            "Description",
            "Handler",
            "Runtime",
            "MemorySize",
            "Timeout",
            "Role",
        ].every((p) => params[p] === oldParams[p])) {
            (0, util_1.log)(`skipped`);
        }
        else {
            resp = yield lambda
                .updateFunctionConfiguration(Object.assign(Object.assign({}, params), { Code: undefined }))
                .promise();
            (0, util_1.log)(`response`, resp);
        }
        // Update function code
        (0, util_1.log)(`update function code`);
        if (params.Code.S3Bucket === oldParams.Code.S3Bucket &&
            params.Code.S3Key === oldParams.Code.S3Key &&
            params.Code.ZipFile === oldParams.Code.ZipFile) {
            (0, util_1.log)(`skipped`);
        }
        else {
            resp = yield lambda
                .updateFunctionCode(Object.assign({ FunctionName: params.FunctionName, Publish: false }, params.Code))
                .promise();
            (0, util_1.log)(`response`, resp);
        }
        // Publish version
        (0, util_1.log)(`publish version`);
        resp = yield lambda
            .publishVersion({
            FunctionName: params.FunctionName,
        })
            .promise();
        (0, util_1.log)(`response`, resp);
        return { FunctionArn: resp.FunctionArn, Version: resp.Version };
    });
}
function handleDelete(params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`handleDelete() called with params`, params);
        // Delete function
        (0, util_1.log)(`handleDelete(): delete function`);
        const resp = yield lambda.deleteFunction(params).promise();
        (0, util_1.log)(`response`, resp);
    });
}
function initLambdaClient() {
    // Create Lambda client
    if (!lambda) {
        lambda = new AWS.Lambda({
            region: "us-east-1",
        });
    }
}
function defaultPhysicalResourceId(req) {
    switch (req.RequestType) {
        case "Create":
            return req.RequestId;
        case "Update":
        case "Delete":
            return req.PhysicalResourceId;
        default:
            throw new Error(`Invalid "RequestType" in request "${JSON.stringify(req)}"`);
    }
}
module.exports = {
    handler: cfnResponse.safeHandler(handler),
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvTmV4dGpzU2l0ZS9FZGdlTGFtYmRhQ3VzdG9tUmVzb3VyY2UvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw2Q0FBK0I7QUFDL0IsNERBQThDO0FBQzlDLGlDQUE2QjtBQUU3QixJQUFJLE1BQWtCLENBQUM7QUFNdkIsU0FBZSxPQUFPLENBQ3BCLFVBQXVEOztRQUV2RCxJQUFBLFVBQUcsRUFBQyxnQkFBZ0IsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUVsQywyQkFBMkI7UUFDM0IsZ0JBQWdCLEVBQUUsQ0FBQztRQUVuQiwrQ0FBK0M7UUFDL0MsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLGtCQUFrQixDQUFDLGNBQWMsQ0FBQztRQUM1RCxJQUFJLElBQUksQ0FBQztRQUNULElBQUksVUFBVSxDQUFDLFdBQVcsS0FBSyxRQUFRLEVBQUU7WUFDdkMsSUFBSSxHQUFHLE1BQU0sWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ25DO2FBQU0sSUFBSSxVQUFVLENBQUMsV0FBVyxLQUFLLFFBQVEsRUFBRTtZQUM5QyxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMscUJBQXFCLENBQUMsY0FBYyxDQUFDO1lBQ2xFLElBQUksR0FBRyxNQUFNLFlBQVksQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUM7U0FDOUM7YUFBTSxJQUFJLFVBQVUsQ0FBQyxXQUFXLEtBQUssUUFBUSxFQUFFO1lBQzlDLE1BQU0sWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQzVCO1FBRUQsaUJBQWlCO1FBQ2pCLE9BQU8sV0FBVyxDQUFDLGNBQWMsQ0FBQyxTQUFTLGtDQUN0QyxVQUFVLEtBQ2Isa0JBQWtCLEVBQUUseUJBQXlCLENBQUMsVUFBVSxDQUFDLEVBQ3pELElBQUksRUFBRSxJQUFJLElBQ1YsQ0FBQztJQUNMLENBQUM7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UmVzcG9uc2UgZnJvbSBcIi4vY2ZuLXJlc3BvbnNlXCI7XG5pbXBvcnQgeyBsb2cgfSBmcm9tIFwiLi91dGlsXCI7XG5cbmxldCBsYW1iZGE6IEFXUy5MYW1iZGE7XG5cbmV4cG9ydCA9IHtcbiAgaGFuZGxlcjogY2ZuUmVzcG9uc2Uuc2FmZUhhbmRsZXIoaGFuZGxlciksXG59O1xuXG5hc3luYyBmdW5jdGlvbiBoYW5kbGVyKFxuICBjZm5SZXF1ZXN0OiBBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50XG4pIHtcbiAgbG9nKFwib25FdmVudEhhbmRsZXJcIiwgY2ZuUmVxdWVzdCk7XG5cbiAgLy8gSW5pdGlhbGl6ZSBMYW1iZGEgY2xpZW50XG4gIGluaXRMYW1iZGFDbGllbnQoKTtcblxuICAvLyBJbnZva2UgdXNlciBmdW5jdGlvbiBvbiBDcmVhdGUgYW5kIG9uIFVwZGF0ZVxuICBjb25zdCBwYXJhbXMgPSBjZm5SZXF1ZXN0LlJlc291cmNlUHJvcGVydGllcy5GdW5jdGlvblBhcmFtcztcbiAgbGV0IGRhdGE7XG4gIGlmIChjZm5SZXF1ZXN0LlJlcXVlc3RUeXBlID09PSBcIkNyZWF0ZVwiKSB7XG4gICAgZGF0YSA9IGF3YWl0IGhhbmRsZUNyZWF0ZShwYXJhbXMpO1xuICB9IGVsc2UgaWYgKGNmblJlcXVlc3QuUmVxdWVzdFR5cGUgPT09IFwiVXBkYXRlXCIpIHtcbiAgICBjb25zdCBvbGRQYXJhbXMgPSBjZm5SZXF1ZXN0Lk9sZFJlc291cmNlUHJvcGVydGllcy5GdW5jdGlvblBhcmFtcztcbiAgICBkYXRhID0gYXdhaXQgaGFuZGxlVXBkYXRlKHBhcmFtcywgb2xkUGFyYW1zKTtcbiAgfSBlbHNlIGlmIChjZm5SZXF1ZXN0LlJlcXVlc3RUeXBlID09PSBcIkRlbGV0ZVwiKSB7XG4gICAgYXdhaXQgaGFuZGxlRGVsZXRlKHBhcmFtcyk7XG4gIH1cblxuICAvLyBCdWlsZCByZXNwb25zZVxuICByZXR1cm4gY2ZuUmVzcG9uc2Uuc3VibWl0UmVzcG9uc2UoXCJTVUNDRVNTXCIsIHtcbiAgICAuLi5jZm5SZXF1ZXN0LFxuICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogZGVmYXVsdFBoeXNpY2FsUmVzb3VyY2VJZChjZm5SZXF1ZXN0KSxcbiAgICBEYXRhOiBkYXRhLFxuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaGFuZGxlQ3JlYXRlKHBhcmFtczogYW55KSB7XG4gIGxvZyhgaGFuZGxlQ3JlYXRlKCkgY2FsbGVkIHdpdGggcGFyYW1zYCwgcGFyYW1zKTtcblxuICBsZXQgcmVzcDtcblxuICAvLyBDcmVhdGUgZnVuY3Rpb25cbiAgbG9nKGBjcmVhdGVkIGZ1bmN0aW9uYCk7XG4gIHJlc3AgPSBhd2FpdCBsYW1iZGEuY3JlYXRlRnVuY3Rpb24ocGFyYW1zKS5wcm9taXNlKCk7XG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcblxuICAvLyBQdWJsaXNoIHZlcnNpb25cbiAgbG9nKGBwdWJsaXNoIHZlcnNpb25gKTtcbiAgcmVzcCA9IGF3YWl0IGxhbWJkYVxuICAgIC5wdWJsaXNoVmVyc2lvbih7XG4gICAgICBGdW5jdGlvbk5hbWU6IHBhcmFtcy5GdW5jdGlvbk5hbWUsXG4gICAgfSlcbiAgICAucHJvbWlzZSgpO1xuICBsb2coYHJlc3BvbnNlYCwgcmVzcCk7XG5cbiAgcmV0dXJuIHsgRnVuY3Rpb25Bcm46IHJlc3AuRnVuY3Rpb25Bcm4sIFZlcnNpb246IHJlc3AuVmVyc2lvbiB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBoYW5kbGVVcGRhdGUocGFyYW1zOiBhbnksIG9sZFBhcmFtczogYW55KSB7XG4gIGxvZyhgaGFuZGxlVXBkYXRlKCkgY2FsbGVkIHdpdGggcGFyYW1zYCwgcGFyYW1zLCBgb2xkUGFyYW1zYCwgb2xkUGFyYW1zKTtcblxuICBsZXQgcmVzcDtcblxuICAvLyBVcGRhdGUgZnVuY3Rpb24gY29uZmlndXJhdGlvblxuICBsb2coYHVwZGF0ZSBmdW5jdGlvbiBjb25maWd1cmF0aW9uYCk7XG4gIGlmIChcbiAgICBbXG4gICAgICBcIkRlc2NyaXB0aW9uXCIsXG4gICAgICBcIkhhbmRsZXJcIixcbiAgICAgIFwiUnVudGltZVwiLFxuICAgICAgXCJNZW1vcnlTaXplXCIsXG4gICAgICBcIlRpbWVvdXRcIixcbiAgICAgIFwiUm9sZVwiLFxuICAgIF0uZXZlcnkoKHApID0+IHBhcmFtc1twXSA9PT0gb2xkUGFyYW1zW3BdKVxuICApIHtcbiAgICBsb2coYHNraXBwZWRgKTtcbiAgfSBlbHNlIHtcbiAgICByZXNwID0gYXdhaXQgbGFtYmRhXG4gICAgICAudXBkYXRlRnVuY3Rpb25Db25maWd1cmF0aW9uKHtcbiAgICAgICAgLi4ucGFyYW1zLFxuICAgICAgICBDb2RlOiB1bmRlZmluZWQsXG4gICAgICB9KVxuICAgICAgLnByb21pc2UoKTtcbiAgICBsb2coYHJlc3BvbnNlYCwgcmVzcCk7XG4gIH1cblxuICAvLyBVcGRhdGUgZnVuY3Rpb24gY29kZVxuICBsb2coYHVwZGF0ZSBmdW5jdGlvbiBjb2RlYCk7XG4gIGlmIChcbiAgICBwYXJhbXMuQ29kZS5TM0J1Y2tldCA9PT0gb2xkUGFyYW1zLkNvZGUuUzNCdWNrZXQgJiZcbiAgICBwYXJhbXMuQ29kZS5TM0tleSA9PT0gb2xkUGFyYW1zLkNvZGUuUzNLZXkgJiZcbiAgICBwYXJhbXMuQ29kZS5aaXBGaWxlID09PSBvbGRQYXJhbXMuQ29kZS5aaXBGaWxlXG4gICkge1xuICAgIGxvZyhgc2tpcHBlZGApO1xuICB9IGVsc2Uge1xuICAgIHJlc3AgPSBhd2FpdCBsYW1iZGFcbiAgICAgIC51cGRhdGVGdW5jdGlvbkNvZGUoe1xuICAgICAgICBGdW5jdGlvbk5hbWU6IHBhcmFtcy5GdW5jdGlvbk5hbWUsXG4gICAgICAgIFB1Ymxpc2g6IGZhbHNlLFxuICAgICAgICAuLi5wYXJhbXMuQ29kZSxcbiAgICAgIH0pXG4gICAgICAucHJvbWlzZSgpO1xuICAgIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcbiAgfVxuXG4gIC8vIFB1Ymxpc2ggdmVyc2lvblxuICBsb2coYHB1Ymxpc2ggdmVyc2lvbmApO1xuICByZXNwID0gYXdhaXQgbGFtYmRhXG4gICAgLnB1Ymxpc2hWZXJzaW9uKHtcbiAgICAgIEZ1bmN0aW9uTmFtZTogcGFyYW1zLkZ1bmN0aW9uTmFtZSxcbiAgICB9KVxuICAgIC5wcm9taXNlKCk7XG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcblxuICByZXR1cm4geyBGdW5jdGlvbkFybjogcmVzcC5GdW5jdGlvbkFybiwgVmVyc2lvbjogcmVzcC5WZXJzaW9uIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGhhbmRsZURlbGV0ZShwYXJhbXM6IGFueSkge1xuICBsb2coYGhhbmRsZURlbGV0ZSgpIGNhbGxlZCB3aXRoIHBhcmFtc2AsIHBhcmFtcyk7XG5cbiAgLy8gRGVsZXRlIGZ1bmN0aW9uXG4gIGxvZyhgaGFuZGxlRGVsZXRlKCk6IGRlbGV0ZSBmdW5jdGlvbmApO1xuICBjb25zdCByZXNwID0gYXdhaXQgbGFtYmRhLmRlbGV0ZUZ1bmN0aW9uKHBhcmFtcykucHJvbWlzZSgpO1xuICBsb2coYHJlc3BvbnNlYCwgcmVzcCk7XG59XG5cbmZ1bmN0aW9uIGluaXRMYW1iZGFDbGllbnQoKSB7XG4gIC8vIENyZWF0ZSBMYW1iZGEgY2xpZW50XG4gIGlmICghbGFtYmRhKSB7XG4gICAgbGFtYmRhID0gbmV3IEFXUy5MYW1iZGEoe1xuICAgICAgcmVnaW9uOiBcInVzLWVhc3QtMVwiLFxuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIGRlZmF1bHRQaHlzaWNhbFJlc291cmNlSWQoXG4gIHJlcTogQVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudFxuKTogc3RyaW5nIHtcbiAgc3dpdGNoIChyZXEuUmVxdWVzdFR5cGUpIHtcbiAgICBjYXNlIFwiQ3JlYXRlXCI6XG4gICAgICByZXR1cm4gcmVxLlJlcXVlc3RJZDtcblxuICAgIGNhc2UgXCJVcGRhdGVcIjpcbiAgICBjYXNlIFwiRGVsZXRlXCI6XG4gICAgICByZXR1cm4gcmVxLlBoeXNpY2FsUmVzb3VyY2VJZDtcblxuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBJbnZhbGlkIFwiUmVxdWVzdFR5cGVcIiBpbiByZXF1ZXN0IFwiJHtKU09OLnN0cmluZ2lmeShyZXEpfVwiYFxuICAgICAgKTtcbiAgfVxufVxuIl19