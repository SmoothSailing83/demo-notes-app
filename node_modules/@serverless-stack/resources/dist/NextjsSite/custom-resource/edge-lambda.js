"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const AWS = __importStar(require("aws-sdk"));
AWS.config.logger = console;
const util_1 = require("./util");
const cfnResponse = __importStar(require("./cfn-response"));
const s3 = new AWS.S3({ region: "us-east-1" });
const lambda = new AWS.Lambda({ region: "us-east-1" });
function handler(cfnRequest) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)("onEventHandler", cfnRequest);
        // Get bucket name
        const functionName = cfnRequest.RequestType === "Create"
            ? generateFunctionName(cfnRequest.ResourceProperties.FunctionNamePrefix)
            : cfnRequest.PhysicalResourceId.split(":").pop();
        // Process request
        let PhysicalResourceId;
        let Data;
        const bucket = cfnRequest.ResourceProperties.FunctionBucket;
        const params = cfnRequest.ResourceProperties.FunctionParams;
        switch (cfnRequest.RequestType) {
            case 'Create':
                yield copyAsset(bucket, params);
                const ret = yield createFunction(functionName, params);
                PhysicalResourceId = ret.FunctionArn;
                Data = {
                    FunctionArn: ret.FunctionArn,
                };
                break;
            case 'Update':
                const oldParams = cfnRequest.OldResourceProperties.FunctionParams;
                if (isConfigurationChanged(params, oldParams)) {
                    yield updateFunctionConfiguration(functionName, params);
                }
                if (isCodeChanged(params, oldParams)) {
                    yield copyAsset(bucket, params);
                    yield updateFunctionCode(functionName, params);
                }
                PhysicalResourceId = cfnRequest.PhysicalResourceId;
                Data = {
                    FunctionArn: cfnRequest.PhysicalResourceId,
                };
                break;
            case 'Delete':
                yield deleteFunction(functionName);
                break;
            default:
                throw new Error("Unsupported request type");
        }
        // Build response
        return cfnResponse.submitResponse("SUCCESS", Object.assign(Object.assign({}, cfnRequest), { PhysicalResourceId,
            Data }));
    });
}
function generateFunctionName(prefix) {
    const MAX_NAME_LENGTH = 64;
    const length = 20;
    const characters = 'abcdefghijklmnopqrstuvwxyz';
    const charactersLength = characters.length;
    let result = `${prefix.toLowerCase().slice(0, MAX_NAME_LENGTH - length - 1)}-`;
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
}
function copyAsset(bucket, params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`copyAsset() called with params`, bucket, params);
        // Copy
        (0, util_1.log)(`copy`);
        const resp = yield s3.copyObject({
            Bucket: bucket,
            CopySource: `/${params.Code.S3Bucket}/${params.Code.S3Key}`,
            Key: params.Code.S3Key,
        }).promise();
        (0, util_1.log)(`response`, resp);
        // Update params
        params.Code.S3Bucket = bucket;
    });
}
function createFunction(functionName, params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`createFunction() called with params`, params);
        const resp = yield lambda
            .createFunction(Object.assign(Object.assign({}, params), { FunctionName: functionName }))
            .promise();
        (0, util_1.log)(`response`, resp);
        return { FunctionArn: resp.FunctionArn };
    });
}
function updateFunctionConfiguration(functionName, params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`updateFunctionConfiguration() called with params`, params);
        const resp = yield lambda
            .updateFunctionConfiguration(Object.assign(Object.assign({}, params), { Code: undefined }))
            .promise();
        (0, util_1.log)(`response`, resp);
    });
}
function updateFunctionCode(functionName, params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`updateFunctionCode() called with params`, params);
        const resp = yield lambda
            .updateFunctionCode(Object.assign({ FunctionName: functionName, Publish: false }, params.Code))
            .promise();
        (0, util_1.log)(`response`, resp);
    });
}
function deleteFunction(functionName) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`deleteFunction() called with functionName`, functionName);
        const resp = yield lambda.deleteFunction({
            FunctionName: functionName,
        }).promise();
        (0, util_1.log)(`response`, resp);
    });
}
function isConfigurationChanged(params, oldParams) {
    return Object.keys(params).length !== Object.keys(params).length
        || [
            "Description",
            "Handler",
            "Runtime",
            "MemorySize",
            "Timeout",
            "Role",
        ].some((p) => params[p] !== oldParams[p]);
}
function isCodeChanged(params, oldParams) {
    return params.Code.S3Bucket !== oldParams.Code.S3Bucket ||
        params.Code.S3Key !== oldParams.Code.S3Key;
}
module.exports = {
    handler: cfnResponse.safeHandler(handler),
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRnZS1sYW1iZGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvTmV4dGpzU2l0ZS9jdXN0b20tcmVzb3VyY2UvZWRnZS1sYW1iZGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw2Q0FBK0I7QUFDL0IsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDO0FBRTVCLGlDQUE2QjtBQUM3Qiw0REFBOEM7QUFDOUMsTUFBTSxFQUFFLEdBQUcsSUFBSSxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7QUFDL0MsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7QUFNdkQsU0FBZSxPQUFPLENBQ3BCLFVBQXVEOztRQUV2RCxJQUFBLFVBQUcsRUFBQyxnQkFBZ0IsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUVsQyxrQkFBa0I7UUFDbEIsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLFdBQVcsS0FBSyxRQUFRO1lBQ3RELENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsa0JBQWtCLENBQUM7WUFDeEUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFZLENBQUM7UUFFN0Qsa0JBQWtCO1FBQ2xCLElBQUksa0JBQWtCLENBQUM7UUFDdkIsSUFBSSxJQUFJLENBQUM7UUFDVCxNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDO1FBQzVELE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLENBQUM7UUFDNUQsUUFBUSxVQUFVLENBQUMsV0FBVyxFQUFFO1lBQzlCLEtBQUss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UUFDaEQsSUFBQSxVQUFHLEVBQUMsMkNBQTJDLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFFL0QsTUFBTSxJQUFJLEdBQUcsTUFBTSxNQUFNLENBQUMsY0FBYyxDQUFDO1lBQ3ZDLFlBQVksRUFBRSxZQUFZO1NBQzNCLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUViLElBQUEsVUFBRyxFQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN4QixDQUFDO0NBQUE7QUFFRCxTQUFTLHNCQUFzQixDQUFDLE1BQVcsRUFBRSxTQUFjO0lBQ3pELE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEtBQUssTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNO1dBQzNEO1lBQ0QsYUFBYTtZQUNiLFNBQVM7WUFDVCxTQUFTO1lBQ1QsWUFBWTtZQUNaLFNBQVM7WUFDVCxNQUFNO1NBQ1AsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUM3QyxDQUFDO0FBRUQsU0FBUyxhQUFhLENBQUMsTUFBVyxFQUFFLFNBQWM7SUFDaEQsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVE7UUFDckQsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEtBQUssU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUE7QUFDOUMsQ0FBQztBQXRKRCxpQkFBUztJQUNQLE9BQU8sRUFBRSxXQUFXLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztDQUMxQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgQVdTIGZyb20gXCJhd3Mtc2RrXCI7XG5BV1MuY29uZmlnLmxvZ2dlciA9IGNvbnNvbGU7XG5cbmltcG9ydCB7IGxvZyB9IGZyb20gXCIuL3V0aWxcIjtcbmltcG9ydCAqIGFzIGNmblJlc3BvbnNlIGZyb20gXCIuL2Nmbi1yZXNwb25zZVwiO1xuY29uc3QgczMgPSBuZXcgQVdTLlMzKHsgcmVnaW9uOiBcInVzLWVhc3QtMVwiIH0pO1xuY29uc3QgbGFtYmRhID0gbmV3IEFXUy5MYW1iZGEoeyByZWdpb246IFwidXMtZWFzdC0xXCIgfSk7XG5cbmV4cG9ydCA9IHtcbiAgaGFuZGxlcjogY2ZuUmVzcG9uc2Uuc2FmZUhhbmRsZXIoaGFuZGxlciksXG59O1xuXG5hc3luYyBmdW5jdGlvbiBoYW5kbGVyKFxuICBjZm5SZXF1ZXN0OiBBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50XG4pIHtcbiAgbG9nKFwib25FdmVudEhhbmRsZXJcIiwgY2ZuUmVxdWVzdCk7XG5cbiAgLy8gR2V0IGJ1Y2tldCBuYW1lXG4gIGNvbnN0IGZ1bmN0aW9uTmFtZSA9IGNmblJlcXVlc3QuUmVxdWVzdFR5cGUgPT09IFwiQ3JlYXRlXCJcbiAgICA/IGdlbmVyYXRlRnVuY3Rpb25OYW1lKGNmblJlcXVlc3QuUmVzb3VyY2VQcm9wZXJ0aWVzLkZ1bmN0aW9uTmFtZVByZWZpeClcbiAgICA6IGNmblJlcXVlc3QuUGh5c2ljYWxSZXNvdXJjZUlkLnNwbGl0KFwiOlwiKS5wb3AoKSBhcyBzdHJpbmc7XG5cbiAgLy8gUHJvY2VzcyByZXF1ZXN0XG4gIGxldCBQaHlzaWNhbFJlc291cmNlSWQ7XG4gIGxldCBEYXRhO1xuICBjb25zdCBidWNrZXQgPSBjZm5SZXF1ZXN0LlJlc291cmNlUHJvcGVydGllcy5GdW5jdGlvbkJ1Y2tldDtcbiAgY29uc3QgcGFyYW1zID0gY2ZuUmVxdWVzdC5SZXNvdXJjZVByb3BlcnRpZXMuRnVuY3Rpb25QYXJhbXM7XG4gIHN3aXRjaCAoY2ZuUmVxdWVzdC5SZXF1ZXN0VHlwZSkge1xuICAgIGNhc2UgJ0NyZWF0ZSc6XG4gICAgICBhd2FpdCBjb3B5QXNzZXQoYnVja2V0LCBwYXJhbXMpO1xuICAgICAgY29uc3QgcmV0ID0gYXdhaXQgY3JlYXRlRnVuY3Rpb24oZnVuY3Rpb25OYW1lLCBwYXJhbXMpO1xuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkID0gcmV0LkZ1bmN0aW9uQXJuO1xuICAgICAgRGF0YSA9IHtcbiAgICAgICAgRnVuY3Rpb25Bcm46IHJldC5GdW5jdGlvbkFybixcbiAgICAgIH07XG4gICAgICBicmVhaztcbiAgICBjYXNlICdVcGRhdGUnOlxuICAgICAgY29uc3Qgb2xkUGFyYW1zID0gY2ZuUmVxdWVzdC5PbGRSZXNvdXJjZVByb3BlcnRpZXMuRnVuY3Rpb25QYXJhbXM7XG4gICAgICBpZiAoaXNDb25maWd1cmF0aW9uQ2hhbmdlZChwYXJhbXMsIG9sZFBhcmFtcykpIHtcbiAgICAgICAgYXdhaXQgdXBkYXRlRnVuY3Rpb25Db25maWd1cmF0aW9uKGZ1bmN0aW9uTmFtZSwgcGFyYW1zKTtcbiAgICAgIH1cbiAgICAgIGlmIChpc0NvZGVDaGFuZ2VkKHBhcmFtcywgb2xkUGFyYW1zKSkge1xuICAgICAgICBhd2FpdCBjb3B5QXNzZXQoYnVja2V0LCBwYXJhbXMpO1xuICAgICAgICBhd2FpdCB1cGRhdGVGdW5jdGlvbkNvZGUoZnVuY3Rpb25OYW1lLCBwYXJhbXMpO1xuICAgICAgfVxuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkID0gY2ZuUmVxdWVzdC5QaHlzaWNhbFJlc291cmNlSWQ7XG4gICAgICBEYXRhID0ge1xuICAgICAgICBGdW5jdGlvbkFybjogY2ZuUmVxdWVzdC5QaHlzaWNhbFJlc291cmNlSWQsXG4gICAgICB9O1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnRGVsZXRlJzpcbiAgICAgIGF3YWl0IGRlbGV0ZUZ1bmN0aW9uKGZ1bmN0aW9uTmFtZSk7XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5zdXBwb3J0ZWQgcmVxdWVzdCB0eXBlXCIpO1xuICB9XG5cbiAgLy8gQnVpbGQgcmVzcG9uc2VcbiAgcmV0dXJuIGNmblJlc3BvbnNlLnN1Ym1pdFJlc3BvbnNlKFwiU1VDQ0VTU1wiLCB7XG4gICAgLi4uY2ZuUmVxdWVzdCxcbiAgICBQaHlzaWNhbFJlc291cmNlSWQsXG4gICAgRGF0YSxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlRnVuY3Rpb25OYW1lKHByZWZpeDogc3RyaW5nKSB7XG4gIGNvbnN0IE1BWF9OQU1FX0xFTkdUSCA9IDY0O1xuICBjb25zdCBsZW5ndGggPSAyMDtcbiAgY29uc3QgY2hhcmFjdGVycyA9ICdhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5eic7XG4gIGNvbnN0IGNoYXJhY3RlcnNMZW5ndGggPSBjaGFyYWN0ZXJzLmxlbmd0aDtcbiAgbGV0IHJlc3VsdCA9IGAke3ByZWZpeC50b0xvd2VyQ2FzZSgpLnNsaWNlKDAsIE1BWF9OQU1FX0xFTkdUSCAtIGxlbmd0aCAtIDEpfS1gO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgcmVzdWx0ICs9IGNoYXJhY3RlcnMuY2hhckF0KE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGNoYXJhY3RlcnNMZW5ndGgpKTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5hc3luYyBmdW5jdGlvbiBjb3B5QXNzZXQoYnVja2V0OiBzdHJpbmcsIHBhcmFtczogYW55KSB7XG4gIGxvZyhgY29weUFzc2V0KCkgY2FsbGVkIHdpdGggcGFyYW1zYCwgYnVja2V0LCBwYXJhbXMpO1xuXG4gIC8vIENvcHlcbiAgbG9nKGBjb3B5YCk7XG4gIGNvbnN0IHJlc3AgPSBhd2FpdCBzMy5jb3B5T2JqZWN0KHtcbiAgICBCdWNrZXQ6IGJ1Y2tldCxcbiAgICBDb3B5U291cmNlOiBgLyR7cGFyYW1zLkNvZGUuUzNCdWNrZXR9LyR7cGFyYW1zLkNvZGUuUzNLZXl9YCwgXG4gICAgS2V5OiBwYXJhbXMuQ29kZS5TM0tleSxcbiAgfSkucHJvbWlzZSgpO1xuICBsb2coYHJlc3BvbnNlYCwgcmVzcCk7XG5cbiAgLy8gVXBkYXRlIHBhcmFtc1xuICBwYXJhbXMuQ29kZS5TM0J1Y2tldCA9IGJ1Y2tldDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlRnVuY3Rpb24oZnVuY3Rpb25OYW1lOiBzdHJpbmcsIHBhcmFtczogYW55KSB7XG4gIGxvZyhgY3JlYXRlRnVuY3Rpb24oKSBjYWxsZWQgd2l0aCBwYXJhbXNgLCBwYXJhbXMpO1xuXG4gIGNvbnN0IHJlc3AgPSBhd2FpdCBsYW1iZGFcbiAgICAuY3JlYXRlRnVuY3Rpb24oe1xuICAgICAgLi4ucGFyYW1zLFxuICAgICAgRnVuY3Rpb25OYW1lOiBmdW5jdGlvbk5hbWUsXG4gICAgfSlcbiAgICAucHJvbWlzZSgpO1xuXG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcblxuICByZXR1cm4geyBGdW5jdGlvbkFybjogcmVzcC5GdW5jdGlvbkFybiB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVGdW5jdGlvbkNvbmZpZ3VyYXRpb24oZnVuY3Rpb25OYW1lOiBzdHJpbmcsIHBhcmFtczogYW55KSB7XG4gIGxvZyhgdXBkYXRlRnVuY3Rpb25Db25maWd1cmF0aW9uKCkgY2FsbGVkIHdpdGggcGFyYW1zYCwgcGFyYW1zKTtcblxuICBjb25zdCByZXNwID0gYXdhaXQgbGFtYmRhXG4gICAgLnVwZGF0ZUZ1bmN0aW9uQ29uZmlndXJhdGlvbih7XG4gICAgICAuLi5wYXJhbXMsXG4gICAgICBDb2RlOiB1bmRlZmluZWQsXG4gICAgfSlcbiAgICAucHJvbWlzZSgpO1xuICBsb2coYHJlc3BvbnNlYCwgcmVzcCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUZ1bmN0aW9uQ29kZShmdW5jdGlvbk5hbWU6IHN0cmluZywgcGFyYW1zOiBhbnkpIHtcbiAgbG9nKGB1cGRhdGVGdW5jdGlvbkNvZGUoKSBjYWxsZWQgd2l0aCBwYXJhbXNgLCBwYXJhbXMpO1xuXG4gIGNvbnN0IHJlc3AgPSBhd2FpdCBsYW1iZGFcbiAgICAudXBkYXRlRnVuY3Rpb25Db2RlKHtcbiAgICAgIEZ1bmN0aW9uTmFtZTogZnVuY3Rpb25OYW1lLFxuICAgICAgUHVibGlzaDogZmFsc2UsXG4gICAgICAuLi5wYXJhbXMuQ29kZSxcbiAgICB9KVxuICAgIC5wcm9taXNlKCk7XG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZGVsZXRlRnVuY3Rpb24oZnVuY3Rpb25OYW1lOiBzdHJpbmcpIHtcbiAgbG9nKGBkZWxldGVGdW5jdGlvbigpIGNhbGxlZCB3aXRoIGZ1bmN0aW9uTmFtZWAsIGZ1bmN0aW9uTmFtZSk7XG5cbiAgY29uc3QgcmVzcCA9IGF3YWl0IGxhbWJkYS5kZWxldGVGdW5jdGlvbih7XG4gICAgRnVuY3Rpb25OYW1lOiBmdW5jdGlvbk5hbWUsXG4gIH0pLnByb21pc2UoKTtcblxuICBsb2coYHJlc3BvbnNlYCwgcmVzcCk7XG59XG5cbmZ1bmN0aW9uIGlzQ29uZmlndXJhdGlvbkNoYW5nZWQocGFyYW1zOiBhbnksIG9sZFBhcmFtczogYW55KSB7XG4gIHJldHVybiBPYmplY3Qua2V5cyhwYXJhbXMpLmxlbmd0aCAhPT0gT2JqZWN0LmtleXMocGFyYW1zKS5sZW5ndGhcbiAgICB8fCBbXG4gICAgICBcIkRlc2NyaXB0aW9uXCIsXG4gICAgICBcIkhhbmRsZXJcIixcbiAgICAgIFwiUnVudGltZVwiLFxuICAgICAgXCJNZW1vcnlTaXplXCIsXG4gICAgICBcIlRpbWVvdXRcIixcbiAgICAgIFwiUm9sZVwiLFxuICAgIF0uc29tZSgocCkgPT4gcGFyYW1zW3BdICE9PSBvbGRQYXJhbXNbcF0pXG59XG5cbmZ1bmN0aW9uIGlzQ29kZUNoYW5nZWQocGFyYW1zOiBhbnksIG9sZFBhcmFtczogYW55KSB7XG4gIHJldHVybiBwYXJhbXMuQ29kZS5TM0J1Y2tldCAhPT0gb2xkUGFyYW1zLkNvZGUuUzNCdWNrZXQgfHxcbiAgICBwYXJhbXMuQ29kZS5TM0tleSAhPT0gb2xkUGFyYW1zLkNvZGUuUzNLZXlcbn1cbiJdfQ==