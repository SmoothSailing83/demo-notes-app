"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const AWS = __importStar(require("aws-sdk"));
AWS.config.logger = console;
const util_1 = require("./util");
const cfnResponse = __importStar(require("./cfn-response"));
const s3 = new AWS.S3({ region: "us-east-1" });
const lambda = new AWS.Lambda({ region: "us-east-1" });
function handler(cfnRequest) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)("onEventHandler", cfnRequest);
        // Get bucket name
        const functionName = cfnRequest.RequestType === "Create"
            ? generateFunctionName(cfnRequest.ResourceProperties.FunctionNamePrefix)
            : cfnRequest.PhysicalResourceId.split(":").pop();
        // Process request
        let PhysicalResourceId;
        let Data;
        const bucket = cfnRequest.ResourceProperties.FunctionBucket;
        const params = cfnRequest.ResourceProperties.FunctionParams;
        switch (cfnRequest.RequestType) {
            case 'Create':
                yield copyAsset(bucket, params);
                const ret = yield createFunction(functionName, params);
                PhysicalResourceId = ret.FunctionArn;
                Data = {
                    FunctionArn: ret.FunctionArn,
                };
                break;
            case 'Update':
                const oldParams = cfnRequest.OldResourceProperties.FunctionParams;
                if (isConfigurationChanged(params, oldParams)) {
                    yield updateFunctionConfiguration(functionName, params);
                }
                if (isCodeChanged(params, oldParams)) {
                    yield copyAsset(bucket, params);
                    yield updateFunctionCode(functionName, params);
                }
                PhysicalResourceId = cfnRequest.PhysicalResourceId;
                Data = {
                    FunctionArn: cfnRequest.PhysicalResourceId,
                };
                break;
            case 'Delete':
                yield deleteFunction(functionName);
                break;
            default:
                throw new Error("Unsupported request type");
        }
        // Build response
        return cfnResponse.submitResponse("SUCCESS", Object.assign(Object.assign({}, cfnRequest), { PhysicalResourceId,
            Data }));
    });
}
function generateFunctionName(prefix) {
    const MAX_NAME_LENGTH = 64;
    const length = 20;
    const characters = 'abcdefghijklmnopqrstuvwxyz';
    const charactersLength = characters.length;
    let result = `${prefix.toLowerCase().slice(0, MAX_NAME_LENGTH - length - 1)}-`;
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
}
function copyAsset(bucket, params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`copyAsset() called with params`, bucket, params);
        // Copy
        (0, util_1.log)(`copy`);
        const resp = yield s3.copyObject({
            Bucket: bucket,
            CopySource: `/${params.Code.S3Bucket}/${params.Code.S3Key}`,
            Key: params.Code.S3Key,
        }).promise();
        (0, util_1.log)(`response`, resp);
        // Update params
        params.Code.S3Bucket = bucket;
    });
}
function createFunction(functionName, params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`createFunction() called with params`, params);
        const resp = yield lambda
            .createFunction(Object.assign(Object.assign({}, params), { FunctionName: functionName }))
            .promise();
        (0, util_1.log)(`response`, resp);
        return { FunctionArn: resp.FunctionArn };
    });
}
function updateFunctionConfiguration(functionName, params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`updateFunctionConfiguration() called with params`, params);
        const resp = yield lambda
            .updateFunctionConfiguration(Object.assign(Object.assign({}, params), { Code: undefined }))
            .promise();
        (0, util_1.log)(`response`, resp);
    });
}
function updateFunctionCode(functionName, params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`updateFunctionCode() called with params`, params);
        const resp = yield lambda
            .updateFunctionCode(Object.assign({ FunctionName: functionName, Publish: false }, params.Code))
            .promise();
        (0, util_1.log)(`response`, resp);
    });
}
function deleteFunction(functionName) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`deleteFunction() called with functionName`, functionName);
        const resp = yield lambda.deleteFunction({
            FunctionName: functionName,
        }).promise();
        (0, util_1.log)(`response`, resp);
    });
}
function isConfigurationChanged(params, oldParams) {
    return Object.keys(params).length !== Object.keys(params).length
        || [
            "Description",
            "Handler",
            "Runtime",
            "MemorySize",
            "Timeout",
            "Role",
        ].some((p) => params[p] !== oldParams[p]);
}
function isCodeChanged(params, oldParams) {
    return params.Code.S3Bucket !== oldParams.Code.S3Bucket ||
        params.Code.S3Key !== oldParams.Code.S3Key;
}
module.exports = {
    handler: cfnResponse.safeHandler(handler),
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRnZS1sYW1iZGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvTmV4dGpzU2l0ZS9DdXN0b21SZXNvdXJjZS9lZGdlLWxhbWJkYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDZDQUErQjtBQUMvQixHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUM7QUFFNUIsaUNBQTZCO0FBQzdCLDREQUE4QztBQUM5QyxNQUFNLEVBQUUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztBQUMvQyxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztBQU12RCxTQUFlLE9BQU8sQ0FDcEIsVUFBdUQ7O1FBRXZELElBQUEsVUFBRyxFQUFDLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRWxDLGtCQUFrQjtRQUNsQixNQUFNLFlBQVksR0FBRyxVQUFVLENBQUMsV0FBVyxLQUFLLFFBQVE7WUFDdEQsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxrQkFBa0IsQ0FBQztZQUN4RSxDQUFDLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQVksQ0FBQztRQUU3RCxrQkFBa0I7UUFDbEIsSUFBSSxrQkFBa0IsQ0FBQztRQUN2QixJQUFJLElBQUksQ0FBQztRQUNULE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLENBQUM7UUFDNUQsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLGtCQUFrQixDQUFDLGNBQWMsQ0FBQztRQUM1RCxRQUFRLFVBQVUsQ0FBQyxXQUFXLEVBQUU7WUFDOUIsS0FBSyxR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QUNoRCxJQUFBLFVBQUcsRUFBQywyQ0FBMkMsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUUvRCxNQUFNLElBQUksR0FBRyxNQUFNLE1BQU0sQ0FBQyxjQUFjLENBQUM7WUFDdkMsWUFBWSxFQUFFLFlBQVk7U0FDM0IsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWIsSUFBQSxVQUFHLEVBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3hCLENBQUM7Q0FBQTtBQUVELFNBQVMsc0JBQXNCLENBQUMsTUFBVyxFQUFFLFNBQWM7SUFDekQsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU07V0FDM0Q7WUFDRCxhQUFhO1lBQ2IsU0FBUztZQUNULFNBQVM7WUFDVCxZQUFZO1lBQ1osU0FBUztZQUNULE1BQU07U0FDUCxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQzdDLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxNQUFXLEVBQUUsU0FBYztJQUNoRCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxLQUFLLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUTtRQUNyRCxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQTtBQUM5QyxDQUFDO0FBdEpELGlCQUFTO0lBQ1AsT0FBTyxFQUFFLFdBQVcsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDO0NBQzFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBBV1MgZnJvbSBcImF3cy1zZGtcIjtcbkFXUy5jb25maWcubG9nZ2VyID0gY29uc29sZTtcblxuaW1wb3J0IHsgbG9nIH0gZnJvbSBcIi4vdXRpbFwiO1xuaW1wb3J0ICogYXMgY2ZuUmVzcG9uc2UgZnJvbSBcIi4vY2ZuLXJlc3BvbnNlXCI7XG5jb25zdCBzMyA9IG5ldyBBV1MuUzMoeyByZWdpb246IFwidXMtZWFzdC0xXCIgfSk7XG5jb25zdCBsYW1iZGEgPSBuZXcgQVdTLkxhbWJkYSh7IHJlZ2lvbjogXCJ1cy1lYXN0LTFcIiB9KTtcblxuZXhwb3J0ID0ge1xuICBoYW5kbGVyOiBjZm5SZXNwb25zZS5zYWZlSGFuZGxlcihoYW5kbGVyKSxcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoXG4gIGNmblJlcXVlc3Q6IEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnRcbikge1xuICBsb2coXCJvbkV2ZW50SGFuZGxlclwiLCBjZm5SZXF1ZXN0KTtcblxuICAvLyBHZXQgYnVja2V0IG5hbWVcbiAgY29uc3QgZnVuY3Rpb25OYW1lID0gY2ZuUmVxdWVzdC5SZXF1ZXN0VHlwZSA9PT0gXCJDcmVhdGVcIlxuICAgID8gZ2VuZXJhdGVGdW5jdGlvbk5hbWUoY2ZuUmVxdWVzdC5SZXNvdXJjZVByb3BlcnRpZXMuRnVuY3Rpb25OYW1lUHJlZml4KVxuICAgIDogY2ZuUmVxdWVzdC5QaHlzaWNhbFJlc291cmNlSWQuc3BsaXQoXCI6XCIpLnBvcCgpIGFzIHN0cmluZztcblxuICAvLyBQcm9jZXNzIHJlcXVlc3RcbiAgbGV0IFBoeXNpY2FsUmVzb3VyY2VJZDtcbiAgbGV0IERhdGE7XG4gIGNvbnN0IGJ1Y2tldCA9IGNmblJlcXVlc3QuUmVzb3VyY2VQcm9wZXJ0aWVzLkZ1bmN0aW9uQnVja2V0O1xuICBjb25zdCBwYXJhbXMgPSBjZm5SZXF1ZXN0LlJlc291cmNlUHJvcGVydGllcy5GdW5jdGlvblBhcmFtcztcbiAgc3dpdGNoIChjZm5SZXF1ZXN0LlJlcXVlc3RUeXBlKSB7XG4gICAgY2FzZSAnQ3JlYXRlJzpcbiAgICAgIGF3YWl0IGNvcHlBc3NldChidWNrZXQsIHBhcmFtcyk7XG4gICAgICBjb25zdCByZXQgPSBhd2FpdCBjcmVhdGVGdW5jdGlvbihmdW5jdGlvbk5hbWUsIHBhcmFtcyk7XG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQgPSByZXQuRnVuY3Rpb25Bcm47XG4gICAgICBEYXRhID0ge1xuICAgICAgICBGdW5jdGlvbkFybjogcmV0LkZ1bmN0aW9uQXJuLFxuICAgICAgfTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1VwZGF0ZSc6XG4gICAgICBjb25zdCBvbGRQYXJhbXMgPSBjZm5SZXF1ZXN0Lk9sZFJlc291cmNlUHJvcGVydGllcy5GdW5jdGlvblBhcmFtcztcbiAgICAgIGlmIChpc0NvbmZpZ3VyYXRpb25DaGFuZ2VkKHBhcmFtcywgb2xkUGFyYW1zKSkge1xuICAgICAgICBhd2FpdCB1cGRhdGVGdW5jdGlvbkNvbmZpZ3VyYXRpb24oZnVuY3Rpb25OYW1lLCBwYXJhbXMpO1xuICAgICAgfVxuICAgICAgaWYgKGlzQ29kZUNoYW5nZWQocGFyYW1zLCBvbGRQYXJhbXMpKSB7XG4gICAgICAgIGF3YWl0IGNvcHlBc3NldChidWNrZXQsIHBhcmFtcyk7XG4gICAgICAgIGF3YWl0IHVwZGF0ZUZ1bmN0aW9uQ29kZShmdW5jdGlvbk5hbWUsIHBhcmFtcyk7XG4gICAgICB9XG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQgPSBjZm5SZXF1ZXN0LlBoeXNpY2FsUmVzb3VyY2VJZDtcbiAgICAgIERhdGEgPSB7XG4gICAgICAgIEZ1bmN0aW9uQXJuOiBjZm5SZXF1ZXN0LlBoeXNpY2FsUmVzb3VyY2VJZCxcbiAgICAgIH07XG4gICAgICBicmVhaztcbiAgICBjYXNlICdEZWxldGUnOlxuICAgICAgYXdhaXQgZGVsZXRlRnVuY3Rpb24oZnVuY3Rpb25OYW1lKTtcbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbnN1cHBvcnRlZCByZXF1ZXN0IHR5cGVcIik7XG4gIH1cblxuICAvLyBCdWlsZCByZXNwb25zZVxuICByZXR1cm4gY2ZuUmVzcG9uc2Uuc3VibWl0UmVzcG9uc2UoXCJTVUNDRVNTXCIsIHtcbiAgICAuLi5jZm5SZXF1ZXN0LFxuICAgIFBoeXNpY2FsUmVzb3VyY2VJZCxcbiAgICBEYXRhLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVGdW5jdGlvbk5hbWUocHJlZml4OiBzdHJpbmcpIHtcbiAgY29uc3QgTUFYX05BTUVfTEVOR1RIID0gNjQ7XG4gIGNvbnN0IGxlbmd0aCA9IDIwO1xuICBjb25zdCBjaGFyYWN0ZXJzID0gJ2FiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6JztcbiAgY29uc3QgY2hhcmFjdGVyc0xlbmd0aCA9IGNoYXJhY3RlcnMubGVuZ3RoO1xuICBsZXQgcmVzdWx0ID0gYCR7cHJlZml4LnRvTG93ZXJDYXNlKCkuc2xpY2UoMCwgTUFYX05BTUVfTEVOR1RIIC0gbGVuZ3RoIC0gMSl9LWA7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICByZXN1bHQgKz0gY2hhcmFjdGVycy5jaGFyQXQoTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogY2hhcmFjdGVyc0xlbmd0aCkpO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvcHlBc3NldChidWNrZXQ6IHN0cmluZywgcGFyYW1zOiBhbnkpIHtcbiAgbG9nKGBjb3B5QXNzZXQoKSBjYWxsZWQgd2l0aCBwYXJhbXNgLCBidWNrZXQsIHBhcmFtcyk7XG5cbiAgLy8gQ29weVxuICBsb2coYGNvcHlgKTtcbiAgY29uc3QgcmVzcCA9IGF3YWl0IHMzLmNvcHlPYmplY3Qoe1xuICAgIEJ1Y2tldDogYnVja2V0LFxuICAgIENvcHlTb3VyY2U6IGAvJHtwYXJhbXMuQ29kZS5TM0J1Y2tldH0vJHtwYXJhbXMuQ29kZS5TM0tleX1gLCBcbiAgICBLZXk6IHBhcmFtcy5Db2RlLlMzS2V5LFxuICB9KS5wcm9taXNlKCk7XG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcblxuICAvLyBVcGRhdGUgcGFyYW1zXG4gIHBhcmFtcy5Db2RlLlMzQnVja2V0ID0gYnVja2V0O1xufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVGdW5jdGlvbihmdW5jdGlvbk5hbWU6IHN0cmluZywgcGFyYW1zOiBhbnkpIHtcbiAgbG9nKGBjcmVhdGVGdW5jdGlvbigpIGNhbGxlZCB3aXRoIHBhcmFtc2AsIHBhcmFtcyk7XG5cbiAgY29uc3QgcmVzcCA9IGF3YWl0IGxhbWJkYVxuICAgIC5jcmVhdGVGdW5jdGlvbih7XG4gICAgICAuLi5wYXJhbXMsXG4gICAgICBGdW5jdGlvbk5hbWU6IGZ1bmN0aW9uTmFtZSxcbiAgICB9KVxuICAgIC5wcm9taXNlKCk7XG5cbiAgbG9nKGByZXNwb25zZWAsIHJlc3ApO1xuXG4gIHJldHVybiB7IEZ1bmN0aW9uQXJuOiByZXNwLkZ1bmN0aW9uQXJuIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUZ1bmN0aW9uQ29uZmlndXJhdGlvbihmdW5jdGlvbk5hbWU6IHN0cmluZywgcGFyYW1zOiBhbnkpIHtcbiAgbG9nKGB1cGRhdGVGdW5jdGlvbkNvbmZpZ3VyYXRpb24oKSBjYWxsZWQgd2l0aCBwYXJhbXNgLCBwYXJhbXMpO1xuXG4gIGNvbnN0IHJlc3AgPSBhd2FpdCBsYW1iZGFcbiAgICAudXBkYXRlRnVuY3Rpb25Db25maWd1cmF0aW9uKHtcbiAgICAgIC4uLnBhcmFtcyxcbiAgICAgIENvZGU6IHVuZGVmaW5lZCxcbiAgICB9KVxuICAgIC5wcm9taXNlKCk7XG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlRnVuY3Rpb25Db2RlKGZ1bmN0aW9uTmFtZTogc3RyaW5nLCBwYXJhbXM6IGFueSkge1xuICBsb2coYHVwZGF0ZUZ1bmN0aW9uQ29kZSgpIGNhbGxlZCB3aXRoIHBhcmFtc2AsIHBhcmFtcyk7XG5cbiAgY29uc3QgcmVzcCA9IGF3YWl0IGxhbWJkYVxuICAgIC51cGRhdGVGdW5jdGlvbkNvZGUoe1xuICAgICAgRnVuY3Rpb25OYW1lOiBmdW5jdGlvbk5hbWUsXG4gICAgICBQdWJsaXNoOiBmYWxzZSxcbiAgICAgIC4uLnBhcmFtcy5Db2RlLFxuICAgIH0pXG4gICAgLnByb21pc2UoKTtcbiAgbG9nKGByZXNwb25zZWAsIHJlc3ApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZWxldGVGdW5jdGlvbihmdW5jdGlvbk5hbWU6IHN0cmluZykge1xuICBsb2coYGRlbGV0ZUZ1bmN0aW9uKCkgY2FsbGVkIHdpdGggZnVuY3Rpb25OYW1lYCwgZnVuY3Rpb25OYW1lKTtcblxuICBjb25zdCByZXNwID0gYXdhaXQgbGFtYmRhLmRlbGV0ZUZ1bmN0aW9uKHtcbiAgICBGdW5jdGlvbk5hbWU6IGZ1bmN0aW9uTmFtZSxcbiAgfSkucHJvbWlzZSgpO1xuXG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcbn1cblxuZnVuY3Rpb24gaXNDb25maWd1cmF0aW9uQ2hhbmdlZChwYXJhbXM6IGFueSwgb2xkUGFyYW1zOiBhbnkpIHtcbiAgcmV0dXJuIE9iamVjdC5rZXlzKHBhcmFtcykubGVuZ3RoICE9PSBPYmplY3Qua2V5cyhwYXJhbXMpLmxlbmd0aFxuICAgIHx8IFtcbiAgICAgIFwiRGVzY3JpcHRpb25cIixcbiAgICAgIFwiSGFuZGxlclwiLFxuICAgICAgXCJSdW50aW1lXCIsXG4gICAgICBcIk1lbW9yeVNpemVcIixcbiAgICAgIFwiVGltZW91dFwiLFxuICAgICAgXCJSb2xlXCIsXG4gICAgXS5zb21lKChwKSA9PiBwYXJhbXNbcF0gIT09IG9sZFBhcmFtc1twXSlcbn1cblxuZnVuY3Rpb24gaXNDb2RlQ2hhbmdlZChwYXJhbXM6IGFueSwgb2xkUGFyYW1zOiBhbnkpIHtcbiAgcmV0dXJuIHBhcmFtcy5Db2RlLlMzQnVja2V0ICE9PSBvbGRQYXJhbXMuQ29kZS5TM0J1Y2tldCB8fFxuICAgIHBhcmFtcy5Db2RlLlMzS2V5ICE9PSBvbGRQYXJhbXMuQ29kZS5TM0tleVxufVxuIl19