"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const AWS = __importStar(require("aws-sdk"));
const cfnResponse = __importStar(require("./cfn-response"));
const util_1 = require("./util");
let lambda;
function handler(cfnRequest) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)("onEventHandler", cfnRequest);
        // Initialize Lambda client
        initLambdaClient();
        // Invoke user function on Create and on Update
        const params = cfnRequest.ResourceProperties.FunctionParams;
        let data;
        if (cfnRequest.RequestType === "Create") {
            data = yield handleCreate(params);
        }
        else if (cfnRequest.RequestType === "Update") {
            const oldParams = cfnRequest.OldResourceProperties.FunctionParams;
            data = yield handleUpdate(params, oldParams);
        }
        else if (cfnRequest.RequestType === "Delete") {
            yield handleDelete(params);
        }
        // Build response
        return cfnResponse.submitResponse("SUCCESS", Object.assign(Object.assign({}, cfnRequest), { PhysicalResourceId: defaultPhysicalResourceId(cfnRequest), Data: data }));
    });
}
function handleCreate(params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`handleCreate() called with params`, params);
        let resp;
        // Create function
        (0, util_1.log)(`created function`);
        resp = yield lambda.createFunction(params).promise();
        (0, util_1.log)(`response`, resp);
        // Publish version
        (0, util_1.log)(`publish version`);
        resp = yield lambda
            .publishVersion({
            FunctionName: params.FunctionName,
        })
            .promise();
        (0, util_1.log)(`response`, resp);
        return { FunctionArn: resp.FunctionArn, Version: resp.Version };
    });
}
function handleUpdate(params, oldParams) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`handleUpdate() called with params`, params, `oldParams`, oldParams);
        let resp;
        // Update function configuration
        (0, util_1.log)(`update function configuration`);
        if ([
            "Description",
            "Handler",
            "Runtime",
            "MemorySize",
            "Timeout",
            "Role",
        ].every((p) => params[p] === oldParams[p])) {
            (0, util_1.log)(`skipped`);
        }
        else {
            resp = yield lambda
                .updateFunctionConfiguration(Object.assign(Object.assign({}, params), { Code: undefined }))
                .promise();
            (0, util_1.log)(`response`, resp);
        }
        // Update function code
        (0, util_1.log)(`update function code`);
        if (params.Code.S3Bucket === oldParams.Code.S3Bucket &&
            params.Code.S3Key === oldParams.Code.S3Key &&
            params.Code.ZipFile === oldParams.Code.ZipFile) {
            (0, util_1.log)(`skipped`);
        }
        else {
            resp = yield lambda
                .updateFunctionCode(Object.assign({ FunctionName: params.FunctionName, Publish: false }, params.Code))
                .promise();
            (0, util_1.log)(`response`, resp);
        }
        // Publish version
        (0, util_1.log)(`publish version`);
        resp = yield lambda
            .publishVersion({
            FunctionName: params.FunctionName,
        })
            .promise();
        (0, util_1.log)(`response`, resp);
        return { FunctionArn: resp.FunctionArn, Version: resp.Version };
    });
}
function handleDelete(params) {
    return __awaiter(this, void 0, void 0, function* () {
        (0, util_1.log)(`handleDelete() called with params`, params);
        // Delete function
        (0, util_1.log)(`handleDelete(): delete function`);
        const resp = yield lambda.deleteFunction(params).promise();
        (0, util_1.log)(`response`, resp);
    });
}
function initLambdaClient() {
    // Create Lambda client
    if (!lambda) {
        lambda = new AWS.Lambda({
            region: "us-east-1",
        });
    }
}
function defaultPhysicalResourceId(req) {
    switch (req.RequestType) {
        case "Create":
            return req.RequestId;
        case "Update":
        case "Delete":
            return req.PhysicalResourceId;
        default:
            throw new Error(`Invalid "RequestType" in request "${JSON.stringify(req)}"`);
    }
}
module.exports = {
    handler: cfnResponse.safeHandler(handler),
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvTmV4dGpzU2l0ZS9DdXN0b21SZXNvdXJjZS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDZDQUErQjtBQUMvQiw0REFBOEM7QUFDOUMsaUNBQTZCO0FBRTdCLElBQUksTUFBa0IsQ0FBQztBQU12QixTQUFlLE9BQU8sQ0FDcEIsVUFBdUQ7O1FBRXZELElBQUEsVUFBRyxFQUFDLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRWxDLDJCQUEyQjtRQUMzQixnQkFBZ0IsRUFBRSxDQUFDO1FBRW5CLCtDQUErQztRQUMvQyxNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDO1FBQzVELElBQUksSUFBSSxDQUFDO1FBQ1QsSUFBSSxVQUFVLENBQUMsV0FBVyxLQUFLLFFBQVEsRUFBRTtZQUN2QyxJQUFJLEdBQUcsTUFBTSxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDbkM7YUFBTSxJQUFJLFVBQVUsQ0FBQyxXQUFXLEtBQUssUUFBUSxFQUFFO1lBQzlDLE1BQU0sU0FBUyxHQUFHLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxjQUFjLENBQUM7WUFDbEUsSUFBSSxHQUFHLE1BQU0sWUFBWSxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztTQUM5QzthQUFNLElBQUksVUFBVSxDQUFDLFdBQVcsS0FBSyxRQUFRLEVBQUU7WUFDOUMsTUFBTSxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDNUI7UUFFRCxpQkFBaUI7UUFDakIsT0FBTyxXQUFXLENBQUMsY0FBYyxDQUFDLFNBQVMsa0NBQ3RDLFVBQVUsS0FDYixrQkFBa0IsRUFBRSx5QkFBeUIsQ0FBQyxVQUFVLENBQUMsRUFDekQsSUFBSSxFQUFFLElBQUksSUFDVixDQUFDO0lBQ0wsQ0FBQztDQUFBO0FBRUQs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SSxDQUFDLFdBQVcsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2xFLENBQUM7Q0FBQTtBQUVELFNBQWUsWUFBWSxDQUFDLE1BQVc7O1FBQ3JDLElBQUEsVUFBRyxFQUFDLG1DQUFtQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRWpELGtCQUFrQjtRQUNsQixJQUFBLFVBQUcsRUFBQyxpQ0FBaUMsQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sSUFBSSxHQUFHLE1BQU0sTUFBTSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUMzRCxJQUFBLFVBQUcsRUFBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDeEIsQ0FBQztDQUFBO0FBRUQsU0FBUyxnQkFBZ0I7SUFDdkIsdUJBQXVCO0lBQ3ZCLElBQUksQ0FBQyxNQUFNLEVBQUU7UUFDWCxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDO1lBQ3RCLE1BQU0sRUFBRSxXQUFXO1NBQ3BCLENBQUMsQ0FBQztLQUNKO0FBQ0gsQ0FBQztBQUVELFNBQVMseUJBQXlCLENBQ2hDLEdBQWdEO0lBRWhELFFBQVEsR0FBRyxDQUFDLFdBQVcsRUFBRTtRQUN2QixLQUFLLFFBQVE7WUFDWCxPQUFPLEdBQUcsQ0FBQyxTQUFTLENBQUM7UUFFdkIsS0FBSyxRQUFRLENBQUM7UUFDZCxLQUFLLFFBQVE7WUFDWCxPQUFPLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQztRQUVoQztZQUNFLE1BQU0sSUFBSSxLQUFLLENBQ2IscUNBQXFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FDNUQsQ0FBQztLQUNMO0FBQ0gsQ0FBQztBQW5KRCxpQkFBUztJQUNQLE9BQU8sRUFBRSxXQUFXLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztDQUMxQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgQVdTIGZyb20gXCJhd3Mtc2RrXCI7XG5pbXBvcnQgKiBhcyBjZm5SZXNwb25zZSBmcm9tIFwiLi9jZm4tcmVzcG9uc2VcIjtcbmltcG9ydCB7IGxvZyB9IGZyb20gXCIuL3V0aWxcIjtcblxubGV0IGxhbWJkYTogQVdTLkxhbWJkYTtcblxuZXhwb3J0ID0ge1xuICBoYW5kbGVyOiBjZm5SZXNwb25zZS5zYWZlSGFuZGxlcihoYW5kbGVyKSxcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoXG4gIGNmblJlcXVlc3Q6IEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnRcbikge1xuICBsb2coXCJvbkV2ZW50SGFuZGxlclwiLCBjZm5SZXF1ZXN0KTtcblxuICAvLyBJbml0aWFsaXplIExhbWJkYSBjbGllbnRcbiAgaW5pdExhbWJkYUNsaWVudCgpO1xuXG4gIC8vIEludm9rZSB1c2VyIGZ1bmN0aW9uIG9uIENyZWF0ZSBhbmQgb24gVXBkYXRlXG4gIGNvbnN0IHBhcmFtcyA9IGNmblJlcXVlc3QuUmVzb3VyY2VQcm9wZXJ0aWVzLkZ1bmN0aW9uUGFyYW1zO1xuICBsZXQgZGF0YTtcbiAgaWYgKGNmblJlcXVlc3QuUmVxdWVzdFR5cGUgPT09IFwiQ3JlYXRlXCIpIHtcbiAgICBkYXRhID0gYXdhaXQgaGFuZGxlQ3JlYXRlKHBhcmFtcyk7XG4gIH0gZWxzZSBpZiAoY2ZuUmVxdWVzdC5SZXF1ZXN0VHlwZSA9PT0gXCJVcGRhdGVcIikge1xuICAgIGNvbnN0IG9sZFBhcmFtcyA9IGNmblJlcXVlc3QuT2xkUmVzb3VyY2VQcm9wZXJ0aWVzLkZ1bmN0aW9uUGFyYW1zO1xuICAgIGRhdGEgPSBhd2FpdCBoYW5kbGVVcGRhdGUocGFyYW1zLCBvbGRQYXJhbXMpO1xuICB9IGVsc2UgaWYgKGNmblJlcXVlc3QuUmVxdWVzdFR5cGUgPT09IFwiRGVsZXRlXCIpIHtcbiAgICBhd2FpdCBoYW5kbGVEZWxldGUocGFyYW1zKTtcbiAgfVxuXG4gIC8vIEJ1aWxkIHJlc3BvbnNlXG4gIHJldHVybiBjZm5SZXNwb25zZS5zdWJtaXRSZXNwb25zZShcIlNVQ0NFU1NcIiwge1xuICAgIC4uLmNmblJlcXVlc3QsXG4gICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBkZWZhdWx0UGh5c2ljYWxSZXNvdXJjZUlkKGNmblJlcXVlc3QpLFxuICAgIERhdGE6IGRhdGEsXG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBoYW5kbGVDcmVhdGUocGFyYW1zOiBhbnkpIHtcbiAgbG9nKGBoYW5kbGVDcmVhdGUoKSBjYWxsZWQgd2l0aCBwYXJhbXNgLCBwYXJhbXMpO1xuXG4gIGxldCByZXNwO1xuXG4gIC8vIENyZWF0ZSBmdW5jdGlvblxuICBsb2coYGNyZWF0ZWQgZnVuY3Rpb25gKTtcbiAgcmVzcCA9IGF3YWl0IGxhbWJkYS5jcmVhdGVGdW5jdGlvbihwYXJhbXMpLnByb21pc2UoKTtcbiAgbG9nKGByZXNwb25zZWAsIHJlc3ApO1xuXG4gIC8vIFB1Ymxpc2ggdmVyc2lvblxuICBsb2coYHB1Ymxpc2ggdmVyc2lvbmApO1xuICByZXNwID0gYXdhaXQgbGFtYmRhXG4gICAgLnB1Ymxpc2hWZXJzaW9uKHtcbiAgICAgIEZ1bmN0aW9uTmFtZTogcGFyYW1zLkZ1bmN0aW9uTmFtZSxcbiAgICB9KVxuICAgIC5wcm9taXNlKCk7XG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcblxuICByZXR1cm4geyBGdW5jdGlvbkFybjogcmVzcC5GdW5jdGlvbkFybiwgVmVyc2lvbjogcmVzcC5WZXJzaW9uIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGhhbmRsZVVwZGF0ZShwYXJhbXM6IGFueSwgb2xkUGFyYW1zOiBhbnkpIHtcbiAgbG9nKGBoYW5kbGVVcGRhdGUoKSBjYWxsZWQgd2l0aCBwYXJhbXNgLCBwYXJhbXMsIGBvbGRQYXJhbXNgLCBvbGRQYXJhbXMpO1xuXG4gIGxldCByZXNwO1xuXG4gIC8vIFVwZGF0ZSBmdW5jdGlvbiBjb25maWd1cmF0aW9uXG4gIGxvZyhgdXBkYXRlIGZ1bmN0aW9uIGNvbmZpZ3VyYXRpb25gKTtcbiAgaWYgKFxuICAgIFtcbiAgICAgIFwiRGVzY3JpcHRpb25cIixcbiAgICAgIFwiSGFuZGxlclwiLFxuICAgICAgXCJSdW50aW1lXCIsXG4gICAgICBcIk1lbW9yeVNpemVcIixcbiAgICAgIFwiVGltZW91dFwiLFxuICAgICAgXCJSb2xlXCIsXG4gICAgXS5ldmVyeSgocCkgPT4gcGFyYW1zW3BdID09PSBvbGRQYXJhbXNbcF0pXG4gICkge1xuICAgIGxvZyhgc2tpcHBlZGApO1xuICB9IGVsc2Uge1xuICAgIHJlc3AgPSBhd2FpdCBsYW1iZGFcbiAgICAgIC51cGRhdGVGdW5jdGlvbkNvbmZpZ3VyYXRpb24oe1xuICAgICAgICAuLi5wYXJhbXMsXG4gICAgICAgIENvZGU6IHVuZGVmaW5lZCxcbiAgICAgIH0pXG4gICAgICAucHJvbWlzZSgpO1xuICAgIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcbiAgfVxuXG4gIC8vIFVwZGF0ZSBmdW5jdGlvbiBjb2RlXG4gIGxvZyhgdXBkYXRlIGZ1bmN0aW9uIGNvZGVgKTtcbiAgaWYgKFxuICAgIHBhcmFtcy5Db2RlLlMzQnVja2V0ID09PSBvbGRQYXJhbXMuQ29kZS5TM0J1Y2tldCAmJlxuICAgIHBhcmFtcy5Db2RlLlMzS2V5ID09PSBvbGRQYXJhbXMuQ29kZS5TM0tleSAmJlxuICAgIHBhcmFtcy5Db2RlLlppcEZpbGUgPT09IG9sZFBhcmFtcy5Db2RlLlppcEZpbGVcbiAgKSB7XG4gICAgbG9nKGBza2lwcGVkYCk7XG4gIH0gZWxzZSB7XG4gICAgcmVzcCA9IGF3YWl0IGxhbWJkYVxuICAgICAgLnVwZGF0ZUZ1bmN0aW9uQ29kZSh7XG4gICAgICAgIEZ1bmN0aW9uTmFtZTogcGFyYW1zLkZ1bmN0aW9uTmFtZSxcbiAgICAgICAgUHVibGlzaDogZmFsc2UsXG4gICAgICAgIC4uLnBhcmFtcy5Db2RlLFxuICAgICAgfSlcbiAgICAgIC5wcm9taXNlKCk7XG4gICAgbG9nKGByZXNwb25zZWAsIHJlc3ApO1xuICB9XG5cbiAgLy8gUHVibGlzaCB2ZXJzaW9uXG4gIGxvZyhgcHVibGlzaCB2ZXJzaW9uYCk7XG4gIHJlc3AgPSBhd2FpdCBsYW1iZGFcbiAgICAucHVibGlzaFZlcnNpb24oe1xuICAgICAgRnVuY3Rpb25OYW1lOiBwYXJhbXMuRnVuY3Rpb25OYW1lLFxuICAgIH0pXG4gICAgLnByb21pc2UoKTtcbiAgbG9nKGByZXNwb25zZWAsIHJlc3ApO1xuXG4gIHJldHVybiB7IEZ1bmN0aW9uQXJuOiByZXNwLkZ1bmN0aW9uQXJuLCBWZXJzaW9uOiByZXNwLlZlcnNpb24gfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaGFuZGxlRGVsZXRlKHBhcmFtczogYW55KSB7XG4gIGxvZyhgaGFuZGxlRGVsZXRlKCkgY2FsbGVkIHdpdGggcGFyYW1zYCwgcGFyYW1zKTtcblxuICAvLyBEZWxldGUgZnVuY3Rpb25cbiAgbG9nKGBoYW5kbGVEZWxldGUoKTogZGVsZXRlIGZ1bmN0aW9uYCk7XG4gIGNvbnN0IHJlc3AgPSBhd2FpdCBsYW1iZGEuZGVsZXRlRnVuY3Rpb24ocGFyYW1zKS5wcm9taXNlKCk7XG4gIGxvZyhgcmVzcG9uc2VgLCByZXNwKTtcbn1cblxuZnVuY3Rpb24gaW5pdExhbWJkYUNsaWVudCgpIHtcbiAgLy8gQ3JlYXRlIExhbWJkYSBjbGllbnRcbiAgaWYgKCFsYW1iZGEpIHtcbiAgICBsYW1iZGEgPSBuZXcgQVdTLkxhbWJkYSh7XG4gICAgICByZWdpb246IFwidXMtZWFzdC0xXCIsXG4gICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZGVmYXVsdFBoeXNpY2FsUmVzb3VyY2VJZChcbiAgcmVxOiBBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50XG4pOiBzdHJpbmcge1xuICBzd2l0Y2ggKHJlcS5SZXF1ZXN0VHlwZSkge1xuICAgIGNhc2UgXCJDcmVhdGVcIjpcbiAgICAgIHJldHVybiByZXEuUmVxdWVzdElkO1xuXG4gICAgY2FzZSBcIlVwZGF0ZVwiOlxuICAgIGNhc2UgXCJEZWxldGVcIjpcbiAgICAgIHJldHVybiByZXEuUGh5c2ljYWxSZXNvdXJjZUlkO1xuXG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEludmFsaWQgXCJSZXF1ZXN0VHlwZVwiIGluIHJlcXVlc3QgXCIke0pTT04uc3RyaW5naWZ5KHJlcSl9XCJgXG4gICAgICApO1xuICB9XG59XG4iXX0=