"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.KinesisStream = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const kinesis = __importStar(require("@aws-cdk/aws-kinesis"));
const lambda = __importStar(require("@aws-cdk/aws-lambda"));
const lambdaEventSources = __importStar(require("@aws-cdk/aws-lambda-event-sources"));
const Stack_1 = require("./Stack");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
class KinesisStream extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { kinesisStream, consumers, defaultFunctionProps } = props || {};
        this.functions = {};
        this.permissionsAttachedForAllConsumers = [];
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create Stream
        ////////////////////
        if (cdk.Construct.isConstruct(kinesisStream)) {
            this.kinesisStream = kinesisStream;
        }
        else {
            const kinesisStreamProps = (kinesisStream || {});
            this.kinesisStream = new kinesis.Stream(this, "Stream", Object.assign({ streamName: root.logicalPrefixedName(id) }, kinesisStreamProps));
        }
        ///////////////////////////
        // Create Consumers
        ///////////////////////////
        if (consumers) {
            Object.keys(consumers).forEach((consumerName) => this.addConsumer(this, consumerName, consumers[consumerName]));
        }
        ///////////////////
        // Register Construct
        ///////////////////
        root.registerConstruct(this);
    }
    get streamArn() {
        return this.kinesisStream.streamArn;
    }
    get streamName() {
        return this.kinesisStream.streamName;
    }
    addConsumers(scope, consumers) {
        Object.keys(consumers).forEach((consumerName) => {
            this.addConsumer(scope, consumerName, consumers[consumerName]);
        });
    }
    attachPermissions(permissions) {
        Object.values(this.functions).forEach((fn) => fn.attachPermissions(permissions));
        this.permissionsAttachedForAllConsumers.push(permissions);
    }
    attachPermissionsToConsumer(consumerName, permissions) {
        if (!this.functions[consumerName]) {
            throw new Error(`The "${consumerName}" consumer was not found in the "${this.node.id}" KinesisStream.`);
        }
        this.functions[consumerName].attachPermissions(permissions);
    }
    getFunction(consumerName) {
        return this.functions[consumerName];
    }
    getConstructInfo() {
        // imported
        if (!cdk.Token.isUnresolved(this.kinesisStream.streamName)) {
            return {
                streamName: this.kinesisStream.streamName,
            };
        }
        // created
        const cfn = this.kinesisStream.node.defaultChild;
        return {
            streamLogicalId: Stack_1.Stack.of(this).getLogicalId(cfn),
        };
    }
    addConsumer(scope, consumerName, consumer) {
        // normalize consumer
        let consumerFunction, consumerProps;
        if (consumer.function) {
            consumer = consumer;
            consumerFunction = consumer.function;
            consumerProps = consumer.consumerProps;
        }
        else {
            consumerFunction = consumer;
        }
        consumerProps = Object.assign({ startingPosition: lambda.StartingPosition.LATEST }, (consumerProps || {}));
        // create function
        const fn = Function_1.Function.fromDefinition(scope, consumerName, consumerFunction, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the consumers using FunctionProps, so the KinesisStream construct can apply the "defaultFunctionProps" to them.`);
        this.functions[consumerName] = fn;
        // create event source
        const eventSource = new lambdaEventSources.KinesisEventSource(this.kinesisStream, consumerProps);
        fn.addEventSource(eventSource);
        // attach permissions
        this.permissionsAttachedForAllConsumers.forEach((permissions) => {
            fn.attachPermissions(permissions);
        });
        return fn;
    }
}
exports.KinesisStream = KinesisStream;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiS2luZXNpc1N0cmVhbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9LaW5lc2lzU3RyZWFtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxtREFBcUM7QUFDckMsOERBQWdEO0FBQ2hELDREQUE4QztBQUM5QyxzRkFBd0U7QUFFeEUsbUNBQWdDO0FBRWhDLHlDQUErRTtBQW9CL0UscUJBQXFCO0FBQ3JCLFlBQVk7QUFDWixxQkFBcUI7QUFFckIsTUFBYSxhQUFjLFNBQVEsR0FBRyxDQUFDLFNBQVM7SUFNOUMsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUEwQjtRQUN0RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ3BDLE1BQU0sRUFBRSxhQUFhLEVBQUUsU0FBUyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUN2RSxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsa0NBQWtDLEdBQUcsRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxvQkFBb0IsQ0FBQztRQUVqRCxvQkFBb0I7UUFDcEIsZ0JBQWdCO1FBQ2hCLG9CQUFvQjtRQUVwQixJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxFQUFFO1lBQzVDLElBQUksQ0FBQyxhQUFhLEdBQUcsYUFBZ0MsQ0FBQztTQUN2RDthQUFNO1lBQ0wsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLGFBQWEsSUFBSSxFQUFFLENBQXdCLENBQUM7WUFDeEUsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFFBQVEsa0JBQ3BELFVBQVUsRUFBRSxJQUFJLENBQUMsbUJBQW1CLENBQUMsRUFBRSxDQUFDLElBQ3JDLGtCQUFrQixFQUNyQixDQUFDO1NBQ0o7UUFFRCwyQkFBMkI7UUFDM0IsbUJBQW1CO1FBQ25CLDJCQUEyQjtRQUUzQixJQUFJLFNBQVMsRUFBRTtZQUNiLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsWUFBb0IsRUFBRSxFQUFFLENBQ3RELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRSxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FDOUQsQ0FBQztTQUNIO1FBRUQsbUJBQW1CO1FBQ25CLHFCQUFxQjtRQUNyQixtQkFBbUI7UUFDbkIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFRCxJQUFXLFNBQVM7UUFDbEIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQztJQUN0QyxDQUFDO0lBRUQsSUFBVyxVQUFVO1FBQ25CLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUM7SUFDdkMsQ0FBQztJQUVNLFlBQVksQ0FDakIsS0FBb0IsRUFDcEIsU0FFQztRQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsWUFBb0IsRUFBRSxFQUFFO1lBQ3RELElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLFlBQVksRUFBRSxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUNqRSxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSxpQkFBaUIsQ0FBQyxXQUF3QjtRQUMvQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUMzQyxFQUFFLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQ2xDLENBQUM7UUFDRixJQUFJLENBQUMsa0NBQWtDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFFTSwyQkFBMkIsQ0FDaEMsWUFBb0IsRUFDcEIsV0FBd0I7UUFFeEIsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDakMsTUFBTSxJQUFJLEtBQUssQ0FDYixRQUFRLFlBQVksb0NBQW9DLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxrQkFBa0IsQ0FDdkYsQ0FBQztTQUNIO1FBRUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRU0sV0FBVyxDQUFDLFlBQW9CO1FBQ3JDLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRU0sZ0JBQWdCO1FBQ3JCLFdBQVc7UUFDWCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUMxRCxPQUFPO2dCQUNMLFVBQVUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVU7YUFDMUMsQ0FBQztTQUNIO1FBQ0QsVUFBVTtRQUNWLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFlBQWlDLENBQUM7UUFDdEUsT0FBTztZQUNMLGVBQWUsRUFBRSxhQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUM7U0FDbEQsQ0FBQztJQUNKLENBQUM7SUFFTyxXQUFXLENBQ2pCLEtBQW9CLEVBQ3BCLFlBQW9CLEVBQ3BCLFFBQXlEO1FBRXpELHFCQUFxQjtRQUNyQixJQUFJLGdCQUFnQixFQUFFLGFBQWEsQ0FBQztRQUNwQyxJQUFLLFFBQXVDLENBQUMsUUFBUSxFQUFFO1lBQ3JELFFBQVEsR0FBRyxRQUFzQyxDQUFDO1lBQ2xELGdCQUFnQixHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUM7WUFDckMsYUFBYSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUM7U0FDeEM7YUFBTTtZQUNMLGdCQUFnQixHQUFHLFFBQThCLENBQUM7U0FDbkQ7UUFDRCxhQUFhLG1CQUNYLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLElBQzdDLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBQyxDQUN6QixDQUFDO1FBRUYsa0JBQWtCO1FBQ2xCLE1BQU0sRUFBRSxHQUFHLG1CQUFFLENBQUMsY0FBYyxDQUMxQixLQUFLLEVBQ0wsWUFBWSxFQUNaLGdCQUFnQixFQUNoQixJQUFJLENBQUMsb0JBQW9CLEVBQ3pCLDJPQUEyTyxDQUM1TyxDQUFDO1FBQ0YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFbEMsc0JBQXNCO1FBQ3RCLE1BQU0sV0FBVyxHQUFHLElBQUksa0JBQWtCLENBQUMsa0JBQWtCLENBQzNELElBQUksQ0FBQyxhQUFhLEVBQ2xCLGFBQWEsQ0FDZCxDQUFDO1FBQ0YsRUFBRSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUUvQixxQkFBcUI7UUFDckIsSUFBSSxDQUFDLGtDQUFrQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFO1lBQzlELEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNwQyxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztDQUNGO0FBakpELHNDQWlKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0ICogYXMga2luZXNpcyBmcm9tIFwiQGF3cy1jZGsvYXdzLWtpbmVzaXNcIjtcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tIFwiQGF3cy1jZGsvYXdzLWxhbWJkYVwiO1xuaW1wb3J0ICogYXMgbGFtYmRhRXZlbnRTb3VyY2VzIGZyb20gXCJAYXdzLWNkay9hd3MtbGFtYmRhLWV2ZW50LXNvdXJjZXNcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IHsgU3RhY2sgfSBmcm9tIFwiLi9TdGFja1wiO1xuaW1wb3J0IHsgSVNzdENvbnN0cnVjdCwgSVNzdENvbnN0cnVjdEluZm8gfSBmcm9tIFwiLi9Db25zdHJ1Y3RcIjtcbmltcG9ydCB7IEZ1bmN0aW9uIGFzIEZuLCBGdW5jdGlvblByb3BzLCBGdW5jdGlvbkRlZmluaXRpb24gfSBmcm9tIFwiLi9GdW5jdGlvblwiO1xuaW1wb3J0IHsgUGVybWlzc2lvbnMgfSBmcm9tIFwiLi91dGlsL3Blcm1pc3Npb25cIjtcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vLyBJbnRlcmZhY2VzXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBLaW5lc2lzU3RyZWFtUHJvcHMge1xuICByZWFkb25seSBraW5lc2lzU3RyZWFtPzoga2luZXNpcy5JU3RyZWFtIHwga2luZXNpcy5TdHJlYW1Qcm9wcztcbiAgcmVhZG9ubHkgY29uc3VtZXJzPzoge1xuICAgIFtjb25zdW1lck5hbWU6IHN0cmluZ106IEZ1bmN0aW9uRGVmaW5pdGlvbiB8IEtpbmVzaXNTdHJlYW1Db25zdW1lclByb3BzO1xuICB9O1xuICByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgS2luZXNpc1N0cmVhbUNvbnN1bWVyUHJvcHMge1xuICByZWFkb25seSBmdW5jdGlvbjogRnVuY3Rpb25EZWZpbml0aW9uO1xuICByZWFkb25seSBjb25zdW1lclByb3BzPzogbGFtYmRhRXZlbnRTb3VyY2VzLktpbmVzaXNFdmVudFNvdXJjZVByb3BzO1xufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBLaW5lc2lzU3RyZWFtIGV4dGVuZHMgY2RrLkNvbnN0cnVjdCBpbXBsZW1lbnRzIElTc3RDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkga2luZXNpc1N0cmVhbToga2luZXNpcy5JU3RyZWFtO1xuICBwcml2YXRlIGZ1bmN0aW9uczogeyBbY29uc3VtZXJOYW1lOiBzdHJpbmddOiBGbiB9O1xuICBwcml2YXRlIHJlYWRvbmx5IHBlcm1pc3Npb25zQXR0YWNoZWRGb3JBbGxDb25zdW1lcnM6IFBlcm1pc3Npb25zW107XG4gIHByaXZhdGUgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IEtpbmVzaXNTdHJlYW1Qcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICBjb25zdCB7IGtpbmVzaXNTdHJlYW0sIGNvbnN1bWVycywgZGVmYXVsdEZ1bmN0aW9uUHJvcHMgfSA9IHByb3BzIHx8IHt9O1xuICAgIHRoaXMuZnVuY3Rpb25zID0ge307XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsQ29uc3VtZXJzID0gW107XG4gICAgdGhpcy5kZWZhdWx0RnVuY3Rpb25Qcm9wcyA9IGRlZmF1bHRGdW5jdGlvblByb3BzO1xuXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgU3RyZWFtXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGlmIChjZGsuQ29uc3RydWN0LmlzQ29uc3RydWN0KGtpbmVzaXNTdHJlYW0pKSB7XG4gICAgICB0aGlzLmtpbmVzaXNTdHJlYW0gPSBraW5lc2lzU3RyZWFtIGFzIGtpbmVzaXMuSVN0cmVhbTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qga2luZXNpc1N0cmVhbVByb3BzID0gKGtpbmVzaXNTdHJlYW0gfHwge30pIGFzIGtpbmVzaXMuU3RyZWFtUHJvcHM7XG4gICAgICB0aGlzLmtpbmVzaXNTdHJlYW0gPSBuZXcga2luZXNpcy5TdHJlYW0odGhpcywgXCJTdHJlYW1cIiwge1xuICAgICAgICBzdHJlYW1OYW1lOiByb290LmxvZ2ljYWxQcmVmaXhlZE5hbWUoaWQpLFxuICAgICAgICAuLi5raW5lc2lzU3RyZWFtUHJvcHMsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBDcmVhdGUgQ29uc3VtZXJzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoY29uc3VtZXJzKSB7XG4gICAgICBPYmplY3Qua2V5cyhjb25zdW1lcnMpLmZvckVhY2goKGNvbnN1bWVyTmFtZTogc3RyaW5nKSA9PlxuICAgICAgICB0aGlzLmFkZENvbnN1bWVyKHRoaXMsIGNvbnN1bWVyTmFtZSwgY29uc3VtZXJzW2NvbnN1bWVyTmFtZV0pXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBSZWdpc3RlciBDb25zdHJ1Y3RcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgcm9vdC5yZWdpc3RlckNvbnN0cnVjdCh0aGlzKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgc3RyZWFtQXJuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMua2luZXNpc1N0cmVhbS5zdHJlYW1Bcm47XG4gIH1cblxuICBwdWJsaWMgZ2V0IHN0cmVhbU5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5raW5lc2lzU3RyZWFtLnN0cmVhbU5hbWU7XG4gIH1cblxuICBwdWJsaWMgYWRkQ29uc3VtZXJzKFxuICAgIHNjb3BlOiBjZGsuQ29uc3RydWN0LFxuICAgIGNvbnN1bWVyczoge1xuICAgICAgW2NvbnN1bWVyTmFtZTogc3RyaW5nXTogRnVuY3Rpb25EZWZpbml0aW9uIHwgS2luZXNpc1N0cmVhbUNvbnN1bWVyUHJvcHM7XG4gICAgfVxuICApOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyhjb25zdW1lcnMpLmZvckVhY2goKGNvbnN1bWVyTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICB0aGlzLmFkZENvbnN1bWVyKHNjb3BlLCBjb25zdW1lck5hbWUsIGNvbnN1bWVyc1tjb25zdW1lck5hbWVdKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBPYmplY3QudmFsdWVzKHRoaXMuZnVuY3Rpb25zKS5mb3JFYWNoKChmbikgPT5cbiAgICAgIGZuLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKVxuICAgICk7XG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsQ29uc3VtZXJzLnB1c2gocGVybWlzc2lvbnMpO1xuICB9XG5cbiAgcHVibGljIGF0dGFjaFBlcm1pc3Npb25zVG9Db25zdW1lcihcbiAgICBjb25zdW1lck5hbWU6IHN0cmluZyxcbiAgICBwZXJtaXNzaW9uczogUGVybWlzc2lvbnNcbiAgKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmZ1bmN0aW9uc1tjb25zdW1lck5hbWVdKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGUgXCIke2NvbnN1bWVyTmFtZX1cIiBjb25zdW1lciB3YXMgbm90IGZvdW5kIGluIHRoZSBcIiR7dGhpcy5ub2RlLmlkfVwiIEtpbmVzaXNTdHJlYW0uYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmZ1bmN0aW9uc1tjb25zdW1lck5hbWVdLmF0dGFjaFBlcm1pc3Npb25zKHBlcm1pc3Npb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRGdW5jdGlvbihjb25zdW1lck5hbWU6IHN0cmluZyk6IEZuIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5mdW5jdGlvbnNbY29uc3VtZXJOYW1lXTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25zdHJ1Y3RJbmZvKCk6IElTc3RDb25zdHJ1Y3RJbmZvIHtcbiAgICAvLyBpbXBvcnRlZFxuICAgIGlmICghY2RrLlRva2VuLmlzVW5yZXNvbHZlZCh0aGlzLmtpbmVzaXNTdHJlYW0uc3RyZWFtTmFtZSkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0cmVhbU5hbWU6IHRoaXMua2luZXNpc1N0cmVhbS5zdHJlYW1OYW1lLFxuICAgICAgfTtcbiAgICB9XG4gICAgLy8gY3JlYXRlZFxuICAgIGNvbnN0IGNmbiA9IHRoaXMua2luZXNpc1N0cmVhbS5ub2RlLmRlZmF1bHRDaGlsZCBhcyBraW5lc2lzLkNmblN0cmVhbTtcbiAgICByZXR1cm4ge1xuICAgICAgc3RyZWFtTG9naWNhbElkOiBTdGFjay5vZih0aGlzKS5nZXRMb2dpY2FsSWQoY2ZuKSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRDb25zdW1lcihcbiAgICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgICBjb25zdW1lck5hbWU6IHN0cmluZyxcbiAgICBjb25zdW1lcjogRnVuY3Rpb25EZWZpbml0aW9uIHwgS2luZXNpc1N0cmVhbUNvbnN1bWVyUHJvcHNcbiAgKTogRm4ge1xuICAgIC8vIG5vcm1hbGl6ZSBjb25zdW1lclxuICAgIGxldCBjb25zdW1lckZ1bmN0aW9uLCBjb25zdW1lclByb3BzO1xuICAgIGlmICgoY29uc3VtZXIgYXMgS2luZXNpc1N0cmVhbUNvbnN1bWVyUHJvcHMpLmZ1bmN0aW9uKSB7XG4gICAgICBjb25zdW1lciA9IGNvbnN1bWVyIGFzIEtpbmVzaXNTdHJlYW1Db25zdW1lclByb3BzO1xuICAgICAgY29uc3VtZXJGdW5jdGlvbiA9IGNvbnN1bWVyLmZ1bmN0aW9uO1xuICAgICAgY29uc3VtZXJQcm9wcyA9IGNvbnN1bWVyLmNvbnN1bWVyUHJvcHM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN1bWVyRnVuY3Rpb24gPSBjb25zdW1lciBhcyBGdW5jdGlvbkRlZmluaXRpb247XG4gICAgfVxuICAgIGNvbnN1bWVyUHJvcHMgPSB7XG4gICAgICBzdGFydGluZ1Bvc2l0aW9uOiBsYW1iZGEuU3RhcnRpbmdQb3NpdGlvbi5MQVRFU1QsXG4gICAgICAuLi4oY29uc3VtZXJQcm9wcyB8fCB7fSksXG4gICAgfTtcblxuICAgIC8vIGNyZWF0ZSBmdW5jdGlvblxuICAgIGNvbnN0IGZuID0gRm4uZnJvbURlZmluaXRpb24oXG4gICAgICBzY29wZSxcbiAgICAgIGNvbnN1bWVyTmFtZSxcbiAgICAgIGNvbnN1bWVyRnVuY3Rpb24sXG4gICAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgYFRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgY2Fubm90IGJlIGFwcGxpZWQgaWYgYW4gaW5zdGFuY2Ugb2YgYSBGdW5jdGlvbiBjb25zdHJ1Y3QgaXMgcGFzc2VkIGluLiBNYWtlIHN1cmUgdG8gZGVmaW5lIGFsbCB0aGUgY29uc3VtZXJzIHVzaW5nIEZ1bmN0aW9uUHJvcHMsIHNvIHRoZSBLaW5lc2lzU3RyZWFtIGNvbnN0cnVjdCBjYW4gYXBwbHkgdGhlIFwiZGVmYXVsdEZ1bmN0aW9uUHJvcHNcIiB0byB0aGVtLmBcbiAgICApO1xuICAgIHRoaXMuZnVuY3Rpb25zW2NvbnN1bWVyTmFtZV0gPSBmbjtcblxuICAgIC8vIGNyZWF0ZSBldmVudCBzb3VyY2VcbiAgICBjb25zdCBldmVudFNvdXJjZSA9IG5ldyBsYW1iZGFFdmVudFNvdXJjZXMuS2luZXNpc0V2ZW50U291cmNlKFxuICAgICAgdGhpcy5raW5lc2lzU3RyZWFtLFxuICAgICAgY29uc3VtZXJQcm9wc1xuICAgICk7XG4gICAgZm4uYWRkRXZlbnRTb3VyY2UoZXZlbnRTb3VyY2UpO1xuXG4gICAgLy8gYXR0YWNoIHBlcm1pc3Npb25zXG4gICAgdGhpcy5wZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsQ29uc3VtZXJzLmZvckVhY2goKHBlcm1pc3Npb25zKSA9PiB7XG4gICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gZm47XG4gIH1cbn1cbiJdfQ==