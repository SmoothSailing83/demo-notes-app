"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.EventBus = void 0;
const cdk = __importStar(require("@aws-cdk/core"));
const events = __importStar(require("@aws-cdk/aws-events"));
const eventsTargets = __importStar(require("@aws-cdk/aws-events-targets"));
const Stack_1 = require("./Stack");
const Queue_1 = require("./Queue");
const Function_1 = require("./Function");
/////////////////////
// Construct
/////////////////////
class EventBus extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const root = scope.node.root;
        const { eventBridgeEventBus, rules, defaultFunctionProps } = props || {};
        this.targetsData = {};
        this.permissionsAttachedForAllTargets = [];
        this.defaultFunctionProps = defaultFunctionProps;
        ////////////////////
        // Create EventBus
        ////////////////////
        if (cdk.Construct.isConstruct(eventBridgeEventBus)) {
            this.eventBridgeEventBus = eventBridgeEventBus;
        }
        else {
            const ebProps = (eventBridgeEventBus || {});
            this.eventBridgeEventBus = new events.EventBus(this, "EventBus", Object.assign({ 
                // Note: Set default eventBusName only if eventSourceName is not configured.
                //       This is because both cannot be configured at the same time.
                eventBusName: ebProps.eventSourceName
                    ? undefined
                    : root.logicalPrefixedName(id) }, ebProps));
        }
        ///////////////////////////
        // Create Targets
        ///////////////////////////
        this.addRules(this, rules || {});
        ///////////////////
        // Register Construct
        ///////////////////
        root.registerConstruct(this);
    }
    get eventBusArn() {
        return this.eventBridgeEventBus.eventBusArn;
    }
    get eventBusName() {
        return this.eventBridgeEventBus.eventBusName;
    }
    addRules(scope, rules) {
        Object.entries(rules).forEach(([ruleKey, rule]) => this.addRule(scope, ruleKey, rule));
    }
    attachPermissions(permissions) {
        Object.keys(this.targetsData).forEach((routeKey) => {
            this.targetsData[routeKey]
                .filter((target) => target instanceof Function_1.Function)
                .forEach((target) => target.attachPermissions(permissions));
        });
        this.permissionsAttachedForAllTargets.push(permissions);
    }
    attachPermissionsToTarget(ruleKey, targetIndex, permissions) {
        const rule = this.targetsData[ruleKey];
        if (!rule) {
            throw new Error(`Cannot find the rule "${ruleKey}" in the "${this.node.id}" EventBus.`);
        }
        const target = rule[targetIndex];
        if (!(target instanceof Function_1.Function)) {
            throw new Error(`Cannot attach permissions to the "${this.node.id}" EventBus target because it's not a Lambda function`);
        }
        target.attachPermissions(permissions);
    }
    getConstructInfo() {
        // imported
        // note: check "eventBusName" b/c "eventBusArn" is unresolved if imported
        //       using "EventBus.fromEventBusName()"
        //       arn:${Token[AWS.Partition.12]}:events:us-east-1:123:event-bus/default
        if (!cdk.Token.isUnresolved(this.eventBridgeEventBus.eventBusName)) {
            return {
                eventBusName: this.eventBridgeEventBus.eventBusName,
            };
        }
        // created
        const cfn = this.eventBridgeEventBus.node
            .defaultChild;
        return {
            eventBusLogicalId: Stack_1.Stack.of(this).getLogicalId(cfn),
        };
    }
    addRule(scope, ruleKey, rule) {
        // Validate input
        // @ts-expect-error "eventBus" is not a prop
        if (rule.eventBus) {
            throw new Error(`Cannot configure the "rule.eventBus" in the "${this.node.id}" EventBus`);
        }
        // Validate rule not redefined
        if (this.targetsData[ruleKey]) {
            throw new Error(`A rule already exists for "${ruleKey}"`);
        }
        // Create Rule
        const root = this.node.root;
        const eventsRule = new events.Rule(scope, ruleKey, Object.assign(Object.assign({ ruleName: root.logicalPrefixedName(ruleKey) }, rule), { eventBus: this.eventBridgeEventBus, targets: [] }));
        // Create Targets
        (rule.targets || []).forEach((target) => this.addTarget(scope, ruleKey, eventsRule, target));
    }
    addTarget(scope, ruleKey, eventsRule, target) {
        if (target instanceof Queue_1.Queue || target.queue) {
            target = target;
            this.addQueueTarget(scope, ruleKey, eventsRule, target);
        }
        else {
            target = target;
            this.addFunctionTarget(scope, ruleKey, eventsRule, target);
        }
    }
    addQueueTarget(scope, ruleKey, eventsRule, target) {
        // Parse target props
        let targetProps;
        let queue;
        if (target instanceof Queue_1.Queue) {
            target = target;
            queue = target;
        }
        else {
            target = target;
            targetProps = target.targetProps;
            queue = target.queue;
        }
        this.targetsData[ruleKey] = this.targetsData[ruleKey] || [];
        this.targetsData[ruleKey].push(queue);
        // Create target
        eventsRule.addTarget(new eventsTargets.SqsQueue(queue.sqsQueue, targetProps));
    }
    addFunctionTarget(scope, ruleKey, eventsRule, target) {
        // Parse target props
        let targetProps;
        let functionDefinition;
        if (target.function) {
            target = target;
            targetProps = target.targetProps;
            functionDefinition = target.function;
        }
        else {
            target = target;
            functionDefinition = target;
        }
        // Create function
        this.targetsData[ruleKey] = this.targetsData[ruleKey] || [];
        const i = this.targetsData[ruleKey].length;
        const fn = Function_1.Function.fromDefinition(scope, `${ruleKey}_target_${i}`, functionDefinition, this.defaultFunctionProps, `The "defaultFunctionProps" cannot be applied if an instance of a Function construct is passed in. Make sure to define all the targets using FunctionProps, so the EventBus construct can apply the "defaultFunctionProps" to them.`);
        this.targetsData[ruleKey].push(fn);
        // Create target
        eventsRule.addTarget(new eventsTargets.LambdaFunction(fn, targetProps));
        // Attach existing permissions
        this.permissionsAttachedForAllTargets.forEach((permissions) => fn.attachPermissions(permissions));
    }
}
exports.EventBus = EventBus;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXZlbnRCdXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvRXZlbnRCdXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1EQUFxQztBQUNyQyw0REFBOEM7QUFDOUMsMkVBQTZEO0FBRTdELG1DQUFnQztBQUNoQyxtQ0FBZ0M7QUFFaEMseUNBQStFO0FBbUMvRSxxQkFBcUI7QUFDckIsWUFBWTtBQUNaLHFCQUFxQjtBQUVyQixNQUFhLFFBQVMsU0FBUSxHQUFHLENBQUMsU0FBUztJQU16QyxZQUFZLEtBQW9CLEVBQUUsRUFBVSxFQUFFLEtBQXFCO1FBQ2pFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFXLENBQUM7UUFDcEMsTUFBTSxFQUFFLG1CQUFtQixFQUFFLEtBQUssRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDekUsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDdEIsSUFBSSxDQUFDLGdDQUFnQyxHQUFHLEVBQUUsQ0FBQztRQUMzQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsb0JBQW9CLENBQUM7UUFFakQsb0JBQW9CO1FBQ3BCLGtCQUFrQjtRQUNsQixvQkFBb0I7UUFFcEIsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO1lBQ2xELElBQUksQ0FBQyxtQkFBbUIsR0FBRyxtQkFBc0MsQ0FBQztTQUNuRTthQUFNO1lBQ0wsTUFBTSxPQUFPLEdBQUcsQ0FBQyxtQkFBbUIsSUFBSSxFQUFFLENBQXlCLENBQUM7WUFDcEUsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsVUFBVTtnQkFDN0QsNEVBQTRFO2dCQUM1RSxvRUFBb0U7Z0JBQ3BFLFlBQVksRUFBRSxPQUFPLENBQUMsZUFBZTtvQkFDbkMsQ0FBQyxDQUFDLFNBQVM7b0JBQ1gsQ0FBQyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUMsSUFDN0IsT0FBTyxFQUNWLENBQUM7U0FDSjtRQUVELDJCQUEyQjtRQUMzQixpQkFBaUI7UUFDakIsMkJBQTJCO1FBRTNCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBQztRQUVqQyxtQkFBbUI7UUFDbkIscUJBQXFCO1FBQ3JCLG1CQUFtQjtRQUNuQixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVELElBQVcsV0FBVztRQUNwQixPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLENBQUM7SUFDOUMsQ0FBQztJQUVELElBQVcsWUFBWTtRQUNyQixPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxZQUFZLENBQUM7SUFDL0MsQ0FBQztJQUVNLFFBQVEsQ0FDYixLQUFvQixFQUNwQixLQUE4QztRQUU5QyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FDaEQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUNuQyxDQUFDO0lBQ0osQ0FBQztJQUVNLGlCQUFpQixDQUFDLFdBQXdCO1FBQy9DLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQWdCLEVBQUUsRUFBRTtZQUN6RCxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQztpQkFDdkIsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxNQUFNLFlBQVksbUJBQUUsQ0FBQztpQkFDeEMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztRQUNoRSxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxnQ0FBZ0MsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUVNLHlCQUF5QixDQUM5QixPQUFlLEVBQ2YsV0FBbUIsRUFDbkIsV0FBd0I7UUFFeEIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1QsTUFBTSxJQUFJLEtBQUssQ0FDYix5QkFBeUIsT0FBTyxhQUFhLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxhQUFhLENBQ3ZFLENBQUM7U0FDSDtRQUVELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNqQyxJQUFJLENBQUMsQ0FBQyxNQUFNLFlBQVksbUJBQUUsQ0FBQyxFQUFFO1lBQzNCLE1BQU0sSUFBSSxLQUFLLENBQ2IscUNBQXFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxzREFBc0QsQ0FDeEcsQ0FBQztTQUNIO1FBQ0QsTUFBTSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFTSxnQkFBZ0I7UUFDckIsV0FBVztRQUNYLHlFQUF5RTtRQUN6RSw0Q0FBNEM7UUFDNUMsOEVBQThFO1FBQzlFLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDbEUsT0FBTztnQkFDTCxZQUFZLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFlBQVk7YUFDcEQsQ0FBQztTQUNIO1FBQ0QsVUFBVTtRQUNWLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJO2FBQ3RDLFlBQWtDLENBQUM7UUFDdEMsT0FBTztZQUNMLGlCQUFpQixFQUFFLGFBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQztTQUNwRCxDQUFDO0lBQ0osQ0FBQztJQUVPLE9BQU8sQ0FDYixLQUFvQixFQUNwQixPQUFlLEVBQ2YsSUFBMEI7UUFFMUIsaUJBQWlCO1FBQ2pCLDRDQUE0QztRQUM1QyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDakIsTUFBTSxJQUFJLEtBQUssQ0FDYixnREFBZ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLFlBQVksQ0FDekUsQ0FBQztTQUNIO1FBRUQsOEJBQThCO1FBQzlCLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUM3QixNQUFNLElBQUksS0FBSyxDQUFDLDhCQUE4QixPQUFPLEdBQUcsQ0FBQyxDQUFDO1NBQzNEO1FBRUQsY0FBYztRQUNkLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBVyxDQUFDO1FBQ25DLE1BQU0sVUFBVSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsT0FBTyxnQ0FDL0MsUUFBUSxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsSUFDeEMsSUFBSSxLQUNQLFFBQVEsRUFBRSxJQUFJLENBQUMsbUJBQW1CLEVBQ2xDLE9BQU8sRUFBRSxFQUFFLElBQ1gsQ0FBQztRQUVILGlCQUFpQjtRQUNqQixDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FDdEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FDbkQsQ0FBQztJQUNKLENBQUM7SUFFTyxTQUFTLENBQ2YsS0FBb0IsRUFDcEIsT0FBZSxFQUNmLFVBQXVCLEVBQ3ZCLE1BSTRCO1FBRTVCLElBQUksTUFBTSxZQUFZLGFBQUssSUFBSyxNQUFtQyxDQUFDLEtBQUssRUFBRTtZQUN6RSxNQUFNLEdBQUcsTUFBMEMsQ0FBQztZQUNwRCxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQ3pEO2FBQU07WUFDTCxNQUFNLEdBQUcsTUFBMEQsQ0FBQztZQUNwRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUM7U0FDNUQ7SUFDSCxDQUFDO0lBRU8sY0FBYyxDQUNwQixLQUFvQixFQUNwQixPQUFlLEVBQ2YsVUFBdUIsRUFDdkIsTUFBd0M7UUFFeEMscUJBQXFCO1FBQ3JCLElBQUksV0FBVyxDQUFDO1FBQ2hCLElBQUksS0FBSyxDQUFDO1FBQ1YsSUFBSSxNQUFNLFlBQVksYUFBSyxFQUFFO1lBQzNCLE1BQU0sR0FBRyxNQUFlLENBQUM7WUFDekIsS0FBSyxHQUFHLE1BQU0sQ0FBQztTQUNoQjthQUFNO1lBQ0wsTUFBTSxHQUFHLE1BQWtDLENBQUM7WUFDNUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUM7WUFDakMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUM7U0FDdEI7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzVELElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXRDLGdCQUFnQjtRQUNoQixVQUFVLENBQUMsU0FBUyxDQUNsQixJQUFJLGFBQWEsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FDeEQsQ0FBQztJQUNKLENBQUM7SUFFTyxpQkFBaUIsQ0FDdkIsS0FBb0IsRUFDcEIsT0FBZSxFQUNmLFVBQXVCLEVBQ3ZCLE1BQXdEO1FBRXhELHFCQUFxQjtRQUNyQixJQUFJLFdBQVcsQ0FBQztRQUNoQixJQUFJLGtCQUFrQixDQUFDO1FBQ3ZCLElBQUssTUFBc0MsQ0FBQyxRQUFRLEVBQUU7WUFDcEQsTUFBTSxHQUFHLE1BQXFDLENBQUM7WUFDL0MsV0FBVyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUM7WUFDakMsa0JBQWtCLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztTQUN0QzthQUFNO1lBQ0wsTUFBTSxHQUFHLE1BQTRCLENBQUM7WUFDdEMsa0JBQWtCLEdBQUcsTUFBTSxDQUFDO1NBQzdCO1FBRUQsa0JBQWtCO1FBQ2xCLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDNUQsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDM0MsTUFBTSxFQUFFLEdBQUcsbUJBQUUsQ0FBQyxjQUFjLENBQzFCLEtBQUssRUFDTCxHQUFHLE9BQU8sV0FBVyxDQUFDLEVBQUUsRUFDeEIsa0JBQWtCLEVBQ2xCLElBQUksQ0FBQyxvQkFBb0IsRUFDekIsb09BQW9PLENBQ3JPLENBQUM7UUFDRixJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVuQyxnQkFBZ0I7UUFDaEIsVUFBVSxDQUFDLFNBQVMsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxjQUFjLENBQUMsRUFBRSxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUM7UUFFeEUsOEJBQThCO1FBQzlCLElBQUksQ0FBQyxnQ0FBZ0MsQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUM1RCxFQUFFLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQ2xDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUFuT0QsNEJBbU9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQgKiBhcyBldmVudHMgZnJvbSBcIkBhd3MtY2RrL2F3cy1ldmVudHNcIjtcbmltcG9ydCAqIGFzIGV2ZW50c1RhcmdldHMgZnJvbSBcIkBhd3MtY2RrL2F3cy1ldmVudHMtdGFyZ2V0c1wiO1xuaW1wb3J0IHsgQXBwIH0gZnJvbSBcIi4vQXBwXCI7XG5pbXBvcnQgeyBTdGFjayB9IGZyb20gXCIuL1N0YWNrXCI7XG5pbXBvcnQgeyBRdWV1ZSB9IGZyb20gXCIuL1F1ZXVlXCI7XG5pbXBvcnQgeyBJU3N0Q29uc3RydWN0LCBJU3N0Q29uc3RydWN0SW5mbyB9IGZyb20gXCIuL0NvbnN0cnVjdFwiO1xuaW1wb3J0IHsgRnVuY3Rpb24gYXMgRm4sIEZ1bmN0aW9uUHJvcHMsIEZ1bmN0aW9uRGVmaW5pdGlvbiB9IGZyb20gXCIuL0Z1bmN0aW9uXCI7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucyB9IGZyb20gXCIuL3V0aWwvcGVybWlzc2lvblwiO1xuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIEludGVyZmFjZXNcbi8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5leHBvcnQgdHlwZSBFdmVudEJ1c1Byb3BzID0ge1xuICByZWFkb25seSBldmVudEJyaWRnZUV2ZW50QnVzPzogZXZlbnRzLklFdmVudEJ1cyB8IGV2ZW50cy5FdmVudEJ1c1Byb3BzO1xuICByZWFkb25seSBydWxlcz86IHsgW2tleTogc3RyaW5nXTogRXZlbnRCdXNDZGtSdWxlUHJvcHMgfTtcbiAgcmVhZG9ubHkgZGVmYXVsdEZ1bmN0aW9uUHJvcHM/OiBGdW5jdGlvblByb3BzO1xufTtcblxuZXhwb3J0IHR5cGUgRXZlbnRCdXNDZGtSdWxlUHJvcHMgPSBPbWl0PFxuICBldmVudHMuUnVsZVByb3BzLFxuICBcImV2ZW50QnVzXCIgfCBcInRhcmdldHNcIlxuPiAmIHtcbiAgcmVhZG9ubHkgdGFyZ2V0cz86IChcbiAgICB8IEZ1bmN0aW9uRGVmaW5pdGlvblxuICAgIHwgRXZlbnRCdXNGdW5jdGlvblRhcmdldFByb3BzXG4gICAgfCBRdWV1ZVxuICAgIHwgRXZlbnRCdXNRdWV1ZVRhcmdldFByb3BzXG4gIClbXTtcbn07XG5cbmV4cG9ydCB0eXBlIEV2ZW50QnVzRnVuY3Rpb25UYXJnZXRQcm9wcyA9IHtcbiAgcmVhZG9ubHkgZnVuY3Rpb246IEZ1bmN0aW9uRGVmaW5pdGlvbjtcbiAgcmVhZG9ubHkgdGFyZ2V0UHJvcHM/OiBldmVudHNUYXJnZXRzLkxhbWJkYUZ1bmN0aW9uUHJvcHM7XG59O1xuXG5leHBvcnQgdHlwZSBFdmVudEJ1c1F1ZXVlVGFyZ2V0UHJvcHMgPSB7XG4gIHJlYWRvbmx5IHF1ZXVlOiBRdWV1ZTtcbiAgcmVhZG9ubHkgdGFyZ2V0UHJvcHM/OiBldmVudHNUYXJnZXRzLlNxc1F1ZXVlUHJvcHM7XG59O1xuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIENvbnN0cnVjdFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBFdmVudEJ1cyBleHRlbmRzIGNkay5Db25zdHJ1Y3QgaW1wbGVtZW50cyBJU3N0Q29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IGV2ZW50QnJpZGdlRXZlbnRCdXM6IGV2ZW50cy5JRXZlbnRCdXM7XG4gIHByaXZhdGUgcmVhZG9ubHkgdGFyZ2V0c0RhdGE6IHsgW2tleTogc3RyaW5nXTogKEZuIHwgUXVldWUpW10gfTtcbiAgcHJpdmF0ZSByZWFkb25seSBwZXJtaXNzaW9uc0F0dGFjaGVkRm9yQWxsVGFyZ2V0czogUGVybWlzc2lvbnNbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0RnVuY3Rpb25Qcm9wcz86IEZ1bmN0aW9uUHJvcHM7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogRXZlbnRCdXNQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCByb290ID0gc2NvcGUubm9kZS5yb290IGFzIEFwcDtcbiAgICBjb25zdCB7IGV2ZW50QnJpZGdlRXZlbnRCdXMsIHJ1bGVzLCBkZWZhdWx0RnVuY3Rpb25Qcm9wcyB9ID0gcHJvcHMgfHwge307XG4gICAgdGhpcy50YXJnZXRzRGF0YSA9IHt9O1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFRhcmdldHMgPSBbXTtcbiAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzID0gZGVmYXVsdEZ1bmN0aW9uUHJvcHM7XG5cbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBFdmVudEJ1c1xuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBpZiAoY2RrLkNvbnN0cnVjdC5pc0NvbnN0cnVjdChldmVudEJyaWRnZUV2ZW50QnVzKSkge1xuICAgICAgdGhpcy5ldmVudEJyaWRnZUV2ZW50QnVzID0gZXZlbnRCcmlkZ2VFdmVudEJ1cyBhcyBldmVudHMuRXZlbnRCdXM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGViUHJvcHMgPSAoZXZlbnRCcmlkZ2VFdmVudEJ1cyB8fCB7fSkgYXMgZXZlbnRzLkV2ZW50QnVzUHJvcHM7XG4gICAgICB0aGlzLmV2ZW50QnJpZGdlRXZlbnRCdXMgPSBuZXcgZXZlbnRzLkV2ZW50QnVzKHRoaXMsIFwiRXZlbnRCdXNcIiwge1xuICAgICAgICAvLyBOb3RlOiBTZXQgZGVmYXVsdCBldmVudEJ1c05hbWUgb25seSBpZiBldmVudFNvdXJjZU5hbWUgaXMgbm90IGNvbmZpZ3VyZWQuXG4gICAgICAgIC8vICAgICAgIFRoaXMgaXMgYmVjYXVzZSBib3RoIGNhbm5vdCBiZSBjb25maWd1cmVkIGF0IHRoZSBzYW1lIHRpbWUuXG4gICAgICAgIGV2ZW50QnVzTmFtZTogZWJQcm9wcy5ldmVudFNvdXJjZU5hbWVcbiAgICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICAgIDogcm9vdC5sb2dpY2FsUHJlZml4ZWROYW1lKGlkKSxcbiAgICAgICAgLi4uZWJQcm9wcyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIENyZWF0ZSBUYXJnZXRzXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICB0aGlzLmFkZFJ1bGVzKHRoaXMsIHJ1bGVzIHx8IHt9KTtcblxuICAgIC8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBSZWdpc3RlciBDb25zdHJ1Y3RcbiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgcm9vdC5yZWdpc3RlckNvbnN0cnVjdCh0aGlzKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZXZlbnRCdXNBcm4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5ldmVudEJyaWRnZUV2ZW50QnVzLmV2ZW50QnVzQXJuO1xuICB9XG5cbiAgcHVibGljIGdldCBldmVudEJ1c05hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5ldmVudEJyaWRnZUV2ZW50QnVzLmV2ZW50QnVzTmFtZTtcbiAgfVxuXG4gIHB1YmxpYyBhZGRSdWxlcyhcbiAgICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgICBydWxlczogeyBba2V5OiBzdHJpbmddOiBFdmVudEJ1c0Nka1J1bGVQcm9wcyB9XG4gICk6IHZvaWQge1xuICAgIE9iamVjdC5lbnRyaWVzKHJ1bGVzKS5mb3JFYWNoKChbcnVsZUtleSwgcnVsZV0pID0+XG4gICAgICB0aGlzLmFkZFJ1bGUoc2NvcGUsIHJ1bGVLZXksIHJ1bGUpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBhdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9uczogUGVybWlzc2lvbnMpOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyh0aGlzLnRhcmdldHNEYXRhKS5mb3JFYWNoKChyb3V0ZUtleTogc3RyaW5nKSA9PiB7XG4gICAgICB0aGlzLnRhcmdldHNEYXRhW3JvdXRlS2V5XVxuICAgICAgICAuZmlsdGVyKCh0YXJnZXQpID0+IHRhcmdldCBpbnN0YW5jZW9mIEZuKVxuICAgICAgICAuZm9yRWFjaCgodGFyZ2V0KSA9PiB0YXJnZXQuYXR0YWNoUGVybWlzc2lvbnMocGVybWlzc2lvbnMpKTtcbiAgICB9KTtcblxuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFRhcmdldHMucHVzaChwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgYXR0YWNoUGVybWlzc2lvbnNUb1RhcmdldChcbiAgICBydWxlS2V5OiBzdHJpbmcsXG4gICAgdGFyZ2V0SW5kZXg6IG51bWJlcixcbiAgICBwZXJtaXNzaW9uczogUGVybWlzc2lvbnNcbiAgKTogdm9pZCB7XG4gICAgY29uc3QgcnVsZSA9IHRoaXMudGFyZ2V0c0RhdGFbcnVsZUtleV07XG4gICAgaWYgKCFydWxlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDYW5ub3QgZmluZCB0aGUgcnVsZSBcIiR7cnVsZUtleX1cIiBpbiB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBFdmVudEJ1cy5gXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHRhcmdldCA9IHJ1bGVbdGFyZ2V0SW5kZXhdO1xuICAgIGlmICghKHRhcmdldCBpbnN0YW5jZW9mIEZuKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ2Fubm90IGF0dGFjaCBwZXJtaXNzaW9ucyB0byB0aGUgXCIke3RoaXMubm9kZS5pZH1cIiBFdmVudEJ1cyB0YXJnZXQgYmVjYXVzZSBpdCdzIG5vdCBhIExhbWJkYSBmdW5jdGlvbmBcbiAgICAgICk7XG4gICAgfVxuICAgIHRhcmdldC5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29uc3RydWN0SW5mbygpOiBJU3N0Q29uc3RydWN0SW5mbyB7XG4gICAgLy8gaW1wb3J0ZWRcbiAgICAvLyBub3RlOiBjaGVjayBcImV2ZW50QnVzTmFtZVwiIGIvYyBcImV2ZW50QnVzQXJuXCIgaXMgdW5yZXNvbHZlZCBpZiBpbXBvcnRlZFxuICAgIC8vICAgICAgIHVzaW5nIFwiRXZlbnRCdXMuZnJvbUV2ZW50QnVzTmFtZSgpXCJcbiAgICAvLyAgICAgICBhcm46JHtUb2tlbltBV1MuUGFydGl0aW9uLjEyXX06ZXZlbnRzOnVzLWVhc3QtMToxMjM6ZXZlbnQtYnVzL2RlZmF1bHRcbiAgICBpZiAoIWNkay5Ub2tlbi5pc1VucmVzb2x2ZWQodGhpcy5ldmVudEJyaWRnZUV2ZW50QnVzLmV2ZW50QnVzTmFtZSkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGV2ZW50QnVzTmFtZTogdGhpcy5ldmVudEJyaWRnZUV2ZW50QnVzLmV2ZW50QnVzTmFtZSxcbiAgICAgIH07XG4gICAgfVxuICAgIC8vIGNyZWF0ZWRcbiAgICBjb25zdCBjZm4gPSB0aGlzLmV2ZW50QnJpZGdlRXZlbnRCdXMubm9kZVxuICAgICAgLmRlZmF1bHRDaGlsZCBhcyBldmVudHMuQ2ZuRXZlbnRCdXM7XG4gICAgcmV0dXJuIHtcbiAgICAgIGV2ZW50QnVzTG9naWNhbElkOiBTdGFjay5vZih0aGlzKS5nZXRMb2dpY2FsSWQoY2ZuKSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRSdWxlKFxuICAgIHNjb3BlOiBjZGsuQ29uc3RydWN0LFxuICAgIHJ1bGVLZXk6IHN0cmluZyxcbiAgICBydWxlOiBFdmVudEJ1c0Nka1J1bGVQcm9wc1xuICApOiB2b2lkIHtcbiAgICAvLyBWYWxpZGF0ZSBpbnB1dFxuICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgXCJldmVudEJ1c1wiIGlzIG5vdCBhIHByb3BcbiAgICBpZiAocnVsZS5ldmVudEJ1cykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ2Fubm90IGNvbmZpZ3VyZSB0aGUgXCJydWxlLmV2ZW50QnVzXCIgaW4gdGhlIFwiJHt0aGlzLm5vZGUuaWR9XCIgRXZlbnRCdXNgXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIHJ1bGUgbm90IHJlZGVmaW5lZFxuICAgIGlmICh0aGlzLnRhcmdldHNEYXRhW3J1bGVLZXldKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEEgcnVsZSBhbHJlYWR5IGV4aXN0cyBmb3IgXCIke3J1bGVLZXl9XCJgKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgUnVsZVxuICAgIGNvbnN0IHJvb3QgPSB0aGlzLm5vZGUucm9vdCBhcyBBcHA7XG4gICAgY29uc3QgZXZlbnRzUnVsZSA9IG5ldyBldmVudHMuUnVsZShzY29wZSwgcnVsZUtleSwge1xuICAgICAgcnVsZU5hbWU6IHJvb3QubG9naWNhbFByZWZpeGVkTmFtZShydWxlS2V5KSxcbiAgICAgIC4uLnJ1bGUsXG4gICAgICBldmVudEJ1czogdGhpcy5ldmVudEJyaWRnZUV2ZW50QnVzLFxuICAgICAgdGFyZ2V0czogW10sXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgVGFyZ2V0c1xuICAgIChydWxlLnRhcmdldHMgfHwgW10pLmZvckVhY2goKHRhcmdldCkgPT5cbiAgICAgIHRoaXMuYWRkVGFyZ2V0KHNjb3BlLCBydWxlS2V5LCBldmVudHNSdWxlLCB0YXJnZXQpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVGFyZ2V0KFxuICAgIHNjb3BlOiBjZGsuQ29uc3RydWN0LFxuICAgIHJ1bGVLZXk6IHN0cmluZyxcbiAgICBldmVudHNSdWxlOiBldmVudHMuUnVsZSxcbiAgICB0YXJnZXQ6XG4gICAgICB8IEZ1bmN0aW9uRGVmaW5pdGlvblxuICAgICAgfCBFdmVudEJ1c0Z1bmN0aW9uVGFyZ2V0UHJvcHNcbiAgICAgIHwgUXVldWVcbiAgICAgIHwgRXZlbnRCdXNRdWV1ZVRhcmdldFByb3BzXG4gICk6IHZvaWQge1xuICAgIGlmICh0YXJnZXQgaW5zdGFuY2VvZiBRdWV1ZSB8fCAodGFyZ2V0IGFzIEV2ZW50QnVzUXVldWVUYXJnZXRQcm9wcykucXVldWUpIHtcbiAgICAgIHRhcmdldCA9IHRhcmdldCBhcyBRdWV1ZSB8IEV2ZW50QnVzUXVldWVUYXJnZXRQcm9wcztcbiAgICAgIHRoaXMuYWRkUXVldWVUYXJnZXQoc2NvcGUsIHJ1bGVLZXksIGV2ZW50c1J1bGUsIHRhcmdldCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRhcmdldCA9IHRhcmdldCBhcyBGdW5jdGlvbkRlZmluaXRpb24gfCBFdmVudEJ1c0Z1bmN0aW9uVGFyZ2V0UHJvcHM7XG4gICAgICB0aGlzLmFkZEZ1bmN0aW9uVGFyZ2V0KHNjb3BlLCBydWxlS2V5LCBldmVudHNSdWxlLCB0YXJnZXQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkUXVldWVUYXJnZXQoXG4gICAgc2NvcGU6IGNkay5Db25zdHJ1Y3QsXG4gICAgcnVsZUtleTogc3RyaW5nLFxuICAgIGV2ZW50c1J1bGU6IGV2ZW50cy5SdWxlLFxuICAgIHRhcmdldDogUXVldWUgfCBFdmVudEJ1c1F1ZXVlVGFyZ2V0UHJvcHNcbiAgKTogdm9pZCB7XG4gICAgLy8gUGFyc2UgdGFyZ2V0IHByb3BzXG4gICAgbGV0IHRhcmdldFByb3BzO1xuICAgIGxldCBxdWV1ZTtcbiAgICBpZiAodGFyZ2V0IGluc3RhbmNlb2YgUXVldWUpIHtcbiAgICAgIHRhcmdldCA9IHRhcmdldCBhcyBRdWV1ZTtcbiAgICAgIHF1ZXVlID0gdGFyZ2V0O1xuICAgIH0gZWxzZSB7XG4gICAgICB0YXJnZXQgPSB0YXJnZXQgYXMgRXZlbnRCdXNRdWV1ZVRhcmdldFByb3BzO1xuICAgICAgdGFyZ2V0UHJvcHMgPSB0YXJnZXQudGFyZ2V0UHJvcHM7XG4gICAgICBxdWV1ZSA9IHRhcmdldC5xdWV1ZTtcbiAgICB9XG4gICAgdGhpcy50YXJnZXRzRGF0YVtydWxlS2V5XSA9IHRoaXMudGFyZ2V0c0RhdGFbcnVsZUtleV0gfHwgW107XG4gICAgdGhpcy50YXJnZXRzRGF0YVtydWxlS2V5XS5wdXNoKHF1ZXVlKTtcblxuICAgIC8vIENyZWF0ZSB0YXJnZXRcbiAgICBldmVudHNSdWxlLmFkZFRhcmdldChcbiAgICAgIG5ldyBldmVudHNUYXJnZXRzLlNxc1F1ZXVlKHF1ZXVlLnNxc1F1ZXVlLCB0YXJnZXRQcm9wcylcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRGdW5jdGlvblRhcmdldChcbiAgICBzY29wZTogY2RrLkNvbnN0cnVjdCxcbiAgICBydWxlS2V5OiBzdHJpbmcsXG4gICAgZXZlbnRzUnVsZTogZXZlbnRzLlJ1bGUsXG4gICAgdGFyZ2V0OiBGdW5jdGlvbkRlZmluaXRpb24gfCBFdmVudEJ1c0Z1bmN0aW9uVGFyZ2V0UHJvcHNcbiAgKTogdm9pZCB7XG4gICAgLy8gUGFyc2UgdGFyZ2V0IHByb3BzXG4gICAgbGV0IHRhcmdldFByb3BzO1xuICAgIGxldCBmdW5jdGlvbkRlZmluaXRpb247XG4gICAgaWYgKCh0YXJnZXQgYXMgRXZlbnRCdXNGdW5jdGlvblRhcmdldFByb3BzKS5mdW5jdGlvbikge1xuICAgICAgdGFyZ2V0ID0gdGFyZ2V0IGFzIEV2ZW50QnVzRnVuY3Rpb25UYXJnZXRQcm9wcztcbiAgICAgIHRhcmdldFByb3BzID0gdGFyZ2V0LnRhcmdldFByb3BzO1xuICAgICAgZnVuY3Rpb25EZWZpbml0aW9uID0gdGFyZ2V0LmZ1bmN0aW9uO1xuICAgIH0gZWxzZSB7XG4gICAgICB0YXJnZXQgPSB0YXJnZXQgYXMgRnVuY3Rpb25EZWZpbml0aW9uO1xuICAgICAgZnVuY3Rpb25EZWZpbml0aW9uID0gdGFyZ2V0O1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBmdW5jdGlvblxuICAgIHRoaXMudGFyZ2V0c0RhdGFbcnVsZUtleV0gPSB0aGlzLnRhcmdldHNEYXRhW3J1bGVLZXldIHx8IFtdO1xuICAgIGNvbnN0IGkgPSB0aGlzLnRhcmdldHNEYXRhW3J1bGVLZXldLmxlbmd0aDtcbiAgICBjb25zdCBmbiA9IEZuLmZyb21EZWZpbml0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICBgJHtydWxlS2V5fV90YXJnZXRfJHtpfWAsXG4gICAgICBmdW5jdGlvbkRlZmluaXRpb24sXG4gICAgICB0aGlzLmRlZmF1bHRGdW5jdGlvblByb3BzLFxuICAgICAgYFRoZSBcImRlZmF1bHRGdW5jdGlvblByb3BzXCIgY2Fubm90IGJlIGFwcGxpZWQgaWYgYW4gaW5zdGFuY2Ugb2YgYSBGdW5jdGlvbiBjb25zdHJ1Y3QgaXMgcGFzc2VkIGluLiBNYWtlIHN1cmUgdG8gZGVmaW5lIGFsbCB0aGUgdGFyZ2V0cyB1c2luZyBGdW5jdGlvblByb3BzLCBzbyB0aGUgRXZlbnRCdXMgY29uc3RydWN0IGNhbiBhcHBseSB0aGUgXCJkZWZhdWx0RnVuY3Rpb25Qcm9wc1wiIHRvIHRoZW0uYFxuICAgICk7XG4gICAgdGhpcy50YXJnZXRzRGF0YVtydWxlS2V5XS5wdXNoKGZuKTtcblxuICAgIC8vIENyZWF0ZSB0YXJnZXRcbiAgICBldmVudHNSdWxlLmFkZFRhcmdldChuZXcgZXZlbnRzVGFyZ2V0cy5MYW1iZGFGdW5jdGlvbihmbiwgdGFyZ2V0UHJvcHMpKTtcblxuICAgIC8vIEF0dGFjaCBleGlzdGluZyBwZXJtaXNzaW9uc1xuICAgIHRoaXMucGVybWlzc2lvbnNBdHRhY2hlZEZvckFsbFRhcmdldHMuZm9yRWFjaCgocGVybWlzc2lvbnMpID0+XG4gICAgICBmbi5hdHRhY2hQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucylcbiAgICApO1xuICB9XG59XG4iXX0=